########################################################################################################################
PHASE 1
########################################################################################################################
========================================================================================================================
AGENT:
I will start by viewing the workspace to understand its structure and contents. This will help me identify key files and locations that may be relevant to the task.
========================================================================================================================
USER PROMPT:
Resolve the following problem statement:

<problem_statement>
[Bug] The channel map was not cleared properly in proxy
### Before Creating the Bug Report

- [X] I found a bug, not just asking a question, which should be created in [GitHub Discussions](https://github.com/apache/rocketmq/discussions).

- [X] I have searched the [GitHub Issues](https://github.com/apache/rocketmq/issues) and [GitHub Discussions](https://github.com/apache/rocketmq/discussions)  of this repository and believe that this is not a duplicate.

- [X] I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.


### Runtime platform environment

CentOS

### RocketMQ version

develop

### JDK Version

_No response_

### Describe the Bug

The remoteChannelMap of HeartbeatSyncer was not cleared properly.

### Steps to Reproduce

Start two proxies in cluster mode, start a consumer and then shut down the consumer.

### What Did You Expect to See?

The remoteChannelMap of HeartbeatSyncer was cleared properly.

### What Did You See Instead?

The remoteChannelMap of HeartbeatSyncer was not cleared properly.

### Additional Context

_No response_

</problem_statement>

Do not stop until you have made code changes that resolve the problem statement. Do not ask for clarifications.

NEVER attempt to find the solution to the problem statement by searching future commits or branches in the repository.
========================================================================================================================
AGENT:
Starting to analyze the bug report about the remoteChannelMap of HeartbeatSyncer not being cleared properly in the proxy module. I need to explore the HeartbeatSyncer class and understand how the remoteChannelMap is managed.
========================================================================================================================
AGENT:
STEP 1: EXPLORE THE WORKSPACE

<thinking>
The bug report mentions that the `remoteChannelMap` of `HeartbeatSyncer` was not cleared properly. Let me first find and examine the `HeartbeatSyncer` class to understand its structure and how the `remoteChannelMap` is managed.

Based on the workspace structure, I can see that the HeartbeatSyncer is located at:
- `proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java`

Let me open this file to understand the issue.
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java

========================================================================================================================
TOOL RETURN (open_files)
```
['Successfully opened proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java:\n\n````java\n   0 /*\n...\n  48 public class HeartbeatSyncer extends AbstractSystemMessageSyncer {\n  49 \n  50     protected ThreadPoolExecutor threadPoolExecutor;\n...\n  55     public HeartbeatSyncer(TopicRouteService topicRouteService, AdminService adminService,\n...\n  63     protected void init() {\n...\n  74             @Override\n  75             public void handle(ConsumerGroupEv...
```
========================================================================================================================
AGENT:
<thinking>
I can see the HeartbeatSyncer class, but I need to expand more of the code to understand the `remoteChannelMap` and how it's managed. Let me expand the full file to see all the relevant code.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
line_ranges:
- - 0
  - -1

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java:

````java
   0 /*
   1  * Licensed to the Apache Software Foundation (ASF) under one or more
   2  * contributor license agreements.  See the NOTICE file distributed with
   3  * this work for additional information regarding copyright ownership.
   4  * The ASF licenses this file to You under the Apache License, Version 2.0
   5  * (the "License"); you may not use this fil...
```
========================================================================================================================
AGENT:
<thinking>
Now I understand the issue. Looking at the code:

1. The `remoteChannelMap` is a `ConcurrentHashMap` that stores `RemoteChannel` objects with keys in the format `group @ channelId as longText`.

2. When a consumer registers (line 191), the key is built as: `data.getGroup() + "@" + decodedChannel.id().asLongText()`

3. When a consumer unregisters (in the `ConsumerIdsChangeListener` at line 82), the key used to remove is: `clientChannelInfo.getChannel().id().asLongText()`

The problem is clear: 
- When adding to the map, the key is `group + "@" + channelId`
- When removing from the map, the key is just `channelId`

This mismatch means the entries are never properly removed from the `remoteChannelMap`.

Let me also check the comment at line 52 to confirm:
```java
protected final Map<String /* group @ channelId as longText */, RemoteChannel> remoteChannelMap = new ConcurrentHashMap<>();
```

The comment says the key format is `group @ channelId as longText`, but the removal code at line 82 only uses `channelId`.

The fix should be to update the removal code to use the correct key format. However, there's a complication: when `CLIENT_UNREGISTER` event is triggered, we have the `ClientChannelInfo` but we also need the `consumerGroup` to build the correct key.

Looking at the `ConsumerGroupEvent.CLIENT_UNREGISTER` event, I need to check what arguments are passed. Let me look at how this event is triggered in the ConsumerManager.
</thinking>
========================================================================================================================
TOOL CALL (grep)
content_pattern: CLIENT_UNREGISTER
path_glob: '**/broker/**/*.java'

========================================================================================================================
TOOL RETURN (grep)
```
broker/src/main/java/org/apache/rocketmq/broker/client/ProducerGroupEvent.java:27:    CLIENT_UNREGISTER
broker/src/main/java/org/apache/rocketmq/broker/client/DefaultConsumerIdsChangeListener.java:92:            case CLIENT_UNREGISTER:
broker/src/main/java/org/apache/rocketmq/broker/client/ConsumerManager.java:139:                callConsumerIdsChangeListener(ConsumerGroupEvent.CLIENT_UNREGISTER, next.getKey(), clientChannelInfo, info.getSubscribeTopics());
broker/src/main/java/org/apache/rocket...
```
========================================================================================================================
AGENT:
<thinking>
Let me look at the ConsumerManager to see how the `CLIENT_UNREGISTER` event is called and what arguments are passed. I can see from the grep results that the event is called with the group name as the second argument (`s` in the listener).
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- broker/src/main/java/org/apache/rocketmq/broker/client/ConsumerManager.java

========================================================================================================================
TOOL RETURN (open_files)
```
['Successfully opened broker/src/main/java/org/apache/rocketmq/broker/client/ConsumerManager.java:\n\n````java\n   0 /*\n...\n  40 public class ConsumerManager {\n  41     private static final Logger LOGGER = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);\n  42     private final ConcurrentMap<String, ConsumerGroupInfo> consumerTable =\n  43         new ConcurrentHashMap<>(1024);\n  44     private final ConcurrentMap<String, ConsumerGroupInfo> consumerCompensationTable =\n  45         ne...
```
========================================================================================================================
AGENT:
<thinking>
Now I can see the issue clearly. Looking at the `callConsumerIdsChangeListener` method calls:

1. At line 138: `callConsumerIdsChangeListener(ConsumerGroupEvent.CLIENT_UNREGISTER, next.getKey(), clientChannelInfo, info.getSubscribeTopics());`
2. At line 234: `callConsumerIdsChangeListener(ConsumerGroupEvent.CLIENT_UNREGISTER, group, clientChannelInfo, consumerGroupInfo.getSubscribeTopics());`
3. At line 291: `callConsumerIdsChangeListener(ConsumerGroupEvent.CLIENT_UNREGISTER, group, clientChannelInfo, consumerGroupInfo.getSubscribeTopics());`

The signature is: `callConsumerIdsChangeListener(ConsumerGroupEvent event, String group, Object... args)`

So when `CLIENT_UNREGISTER` is called:
- `event` = `ConsumerGroupEvent.CLIENT_UNREGISTER`
- `s` (the second parameter in the listener) = `group` (the consumer group name)
- `args[0]` = `clientChannelInfo`
- `args[1]` = `subscribeTopics`

Now looking back at the HeartbeatSyncer code at line 75-84:

```java
public void handle(ConsumerGroupEvent event, String s, Object... args) {
    if (event == ConsumerGroupEvent.CLIENT_UNREGISTER) {
        if (args == null || args.length < 1) {
            return;
        }
        if (args[0] instanceof ClientChannelInfo) {
            ClientChannelInfo clientChannelInfo = (ClientChannelInfo) args[0];
            remoteChannelMap.remove(clientChannelInfo.getChannel().id().asLongText());
        }
    }
}
```

The issue is:
1. The `s` parameter contains the `group` name
2. The key in `remoteChannelMap` is `group + "@" + channelId`
3. But the removal code only uses `channelId`

The fix should be to use the correct key format when removing from the map:

```java
remoteChannelMap.remove(s + "@" + clientChannelInfo.getChannel().id().asLongText());
```

Where `s` is the group name.

Let me make this fix.
</thinking>
========================================================================================================================
AGENT:
I've identified the bug. The remoteChannelMap uses keys in the format "group@channelId", but when removing entries, only "channelId" is used. I need to fix the removal code to use the correct key format.
========================================================================================================================
AGENT:
STEP 2: MAKE THE FIX

<thinking>
Now I need to fix the code in HeartbeatSyncer.java. The fix is straightforward - I need to change line 82 from:

```java
remoteChannelMap.remove(clientChannelInfo.getChannel().id().asLongText());
```

to:

```java
remoteChannelMap.remove(s + "@" + clientChannelInfo.getChannel().id().asLongText());
```

Where `s` is the group name passed to the `handle` method.
</thinking>
========================================================================================================================
TOOL CALL (find_and_replace_code)
file_path: proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
find: "                if (args[0] instanceof ClientChannelInfo) {\n             \
  \       ClientChannelInfo clientChannelInfo = (ClientChannelInfo) args[0];\n   \
  \                 remoteChannelMap.remove(clientChannelInfo.getChannel().id().asLongText());\n\
  \                }"
replace: "                if (args[0] instanceof ClientChannelInfo) {\n          \
  \          ClientChannelInfo clientChannelInfo = (ClientChannelInfo) args[0];\n\
  \                    remoteChannelMap.remove(s + \"@\" + clientChannelInfo.getChannel().id().asLongText());\n\
  \                }"

========================================================================================================================
TOOL RETURN (find_and_replace_code)
```
Successfully replaced code in proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java:

--- proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
+++ proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
@@ -80,7 +80,7 @@
                     }
                     if (args[0] instanceof ClientChannelInfo) {
                         ClientChannelInfo clientChannelInfo = (ClientChannelInfo) args[0];
-   ...
```
========================================================================================================================
AGENT:
STEP 3: VERIFY THE FIX

<thinking>
The fix has been applied. Now let me verify the change by opening the file again to ensure the fix is correct and consistent with how the key is built when adding to the map.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
line_ranges:
- - 50
  - 100
- - 185
  - 220

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java:

````java
   0 /*
   1  * Licensed to the Apache Software Foundation (ASF) under one or more
   2  * contributor license agreements.  See the NOTICE file distributed with
   3  * this work for additional information regarding copyright ownership.
   4  * The ASF licenses this file to You under the Apache License, Version 2.0
   5  * (the "License"); you may not use this fil...
```
========================================================================================================================
AGENT:
<thinking>
The fix looks correct. Let me verify:

1. **Adding to the map (line 191)**: `remoteChannelMap.computeIfAbsent(data.getGroup() + "@" + decodedChannel.id().asLongText(), key -> decodedChannel)`
   - Key format: `group + "@" + channelId`

2. **Removing from the map (line 82, after fix)**: `remoteChannelMap.remove(s + "@" + clientChannelInfo.getChannel().id().asLongText())`
   - Key format: `s + "@" + channelId` where `s` is the group name
   - This now matches the key format used when adding to the map

The fix is correct. Now let me check if there are any tests for this class that I should run to verify the fix doesn't break anything.
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- proxy/src/test/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncerTest.java

========================================================================================================================
TOOL RETURN (open_files)
```
['Successfully opened proxy/src/test/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncerTest.java:\n\n````java\n   0 /*\n...\n  92 @RunWith(MockitoJUnitRunner.class)\n  93 public class HeartbeatSyncerTest extends InitConfigTest {\n  94     @Mock\n  95     private TopicRouteService topicRouteService;\n  96     @Mock\n  97     private AdminService adminService;\n  98     @Mock\n  99     private ConsumerManager consumerManager;\n 100     @Mock\n 101     private MQClientAPIFactory mqCl...
```
========================================================================================================================
AGENT:
<thinking>
Let me expand the test file to see if there are any tests that specifically test the removal from remoteChannelMap. I should also run the tests to make sure the fix doesn't break anything.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: proxy/src/test/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncerTest.java
line_ranges:
- - 0
  - -1

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in proxy/src/test/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncerTest.java:

````java
   0 /*
   1  * Licensed to the Apache Software Foundation (ASF) under one or more
   2  * contributor license agreements.  See the NOTICE file distributed with
   3  * this work for additional information regarding copyright ownership.
   4  * The ASF licenses this file to You under the Apache License, Version 2.0
   5  * (the "License"); you may not use this...
```
========================================================================================================================
AGENT:
<thinking>
The test file looks comprehensive. It tests both registration and unregistration of consumers. The tests don't directly test the `remoteChannelMap` cleanup via the `ConsumerIdsChangeListener`, but they do test the overall flow.

Let me try to run the tests to make sure the fix doesn't break anything. First, let me check if Maven is available and try to run the tests.
</thinking>
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && mvn test -pl proxy -Dtest=HeartbeatSyncerTest -DfailIfNoTests=false
  -q 2>&1 | tail -50
timeout: 300

========================================================================================================================
TOOL RETURN (bash)
```
tmp_code_dba2ef507466035bc14aa47064ff329794bd94e8de2429166228e4d42385be3b.bash: line 1: mvn: command not found...
```
========================================================================================================================
AGENT:
<thinking>
Maven is not available. Let me try using the bazel build system which is mentioned in the workspace.
</thinking>
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && which bazel bazelisk

========================================================================================================================
TOOL RETURN (bash)
```
/usr/local/bin/bazel
/usr/local/bin/bazelisk...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && bazel test //proxy:HeartbeatSyncerTest --test_output=errors
  2>&1 | tail -100
timeout: 300

========================================================================================================================
TOOL RETURN (bash)
```
2025/12/11 18:19:17 Downloading https://releases.bazel.build/5.2.0/release/bazel-5.2.0-linux-arm64...
Extracting Bazel installation...
Starting local Bazel server and connecting to it...
[32mLoading:[0m 
[32mLoading:[0m 0 packages loaded
[32mLoading:[0m 0 packages loaded
[32mLoading:[0m 0 packages loaded
[32mLoading:[0m 0 packages loaded
[32mLoading:[0m 0 packages loaded
[32mLoading:[0m 0 packages loaded
[32mLoading:[0m 0 packages loaded
[32mINFO: [0mRepository rules_jvm_extern...
```
========================================================================================================================
AGENT:
<thinking>
The bazel build is failing due to network issues. Let me try to compile the Java file directly to verify the syntax is correct.
</thinking>
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && cat proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
  | head -100

========================================================================================================================
TOOL RETURN (bash)
```
/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by a...
```
========================================================================================================================
AGENT:
<thinking>
The fix looks correct. Let me verify the fix by reviewing the code one more time:

1. **Key format when adding to the map (line 191 in the original file)**:
   ```java
   remoteChannelMap.computeIfAbsent(data.getGroup() + "@" + decodedChannel.id().asLongText(), key -> decodedChannel);
   ```
   Key format: `group + "@" + channelId`

2. **Key format when removing from the map (line 82 after fix)**:
   ```java
   remoteChannelMap.remove(s + "@" + clientChannelInfo.getChannel().id().asLongText());
   ```
   Key format: `s + "@" + channelId` where `s` is the group name

The fix is correct. The key format now matches between adding and removing entries from the `remoteChannelMap`.

Let me also verify that the `s` parameter in the `handle` method is indeed the group name by looking at the `ConsumerIdsChangeListener` interface and how it's called.
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- broker/src/main/java/org/apache/rocketmq/broker/client/ConsumerIdsChangeListener.java

========================================================================================================================
TOOL RETURN (open_files)
```
['Successfully opened broker/src/main/java/org/apache/rocketmq/broker/client/ConsumerIdsChangeListener.java:\n\n````java\n   0 /*\n   1  * Licensed to the Apache Software Foundation (ASF) under one or more\n   2  * contributor license agreements.  See the NOTICE file distributed with\n   3  * this work for additional information regarding copyright ownership.\n   4  * The ASF licenses this file to You under the Apache License, Version 2.0\n   5  * (the "License"); you may not use this file excep...
```
========================================================================================================================
AGENT:
<thinking>
The `ConsumerIdsChangeListener` interface confirms that the second parameter is named `group`, which is the consumer group name. This confirms that my fix is correct.

Let me also verify the `callConsumerIdsChangeListener` method in `ConsumerManager` to ensure the group is passed correctly.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: broker/src/main/java/org/apache/rocketmq/broker/client/ConsumerManager.java
patterns:
- callConsumerIdsChangeListener

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in broker/src/main/java/org/apache/rocketmq/broker/client/ConsumerManager.java:

````java
   0 /*
...
  40 public class ConsumerManager {
  41     private static final Logger LOGGER = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);
  42     private final ConcurrentMap<String, ConsumerGroupInfo> consumerTable =
  43         new ConcurrentHashMap<>(1024);
  44     private final ConcurrentMap<String, ConsumerGroupInfo> consumerCompensationTable =
  45      ...
```
========================================================================================================================
AGENT:
<thinking>
The code confirms that:

1. The `callConsumerIdsChangeListener` method at line 325-333 calls `listener.handle(event, group, args)` where `group` is the consumer group name.

2. When `CLIENT_UNREGISTER` is called (lines 138, 234, 291), the second argument is always the group name (e.g., `next.getKey()`, `group`).

3. The `ConsumerIdsChangeListener` interface at line 20 defines `void handle(ConsumerGroupEvent event, String group, Object... args)` where the second parameter is explicitly named `group`.

My fix is correct. The `s` parameter in the `handle` method of the `ConsumerIdsChangeListener` is the consumer group name, and the key format for removal now correctly matches the key format used when adding to the map.

Let me also verify that there are no other places in the codebase that might be affected by this change or that might have similar issues.
</thinking>
========================================================================================================================
TOOL CALL (grep)
content_pattern: remoteChannelMap
path_glob: '**/*.java'

========================================================================================================================
TOOL RETURN (grep)
```
proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java:53:    protected final Map<String /* group @ channelId as longText */, RemoteChannel> remoteChannelMap = new ConcurrentHashMap<>();
proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java:83:                        remoteChannelMap.remove(s + "@" + clientChannelInfo.getChannel().id().asLongText());
proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.jav...
```
========================================================================================================================
AGENT:
<thinking>
The grep results show that `remoteChannelMap` is only used in three places:
1. Line 53: Declaration of the map
2. Line 83: Removal (my fix)
3. Line 192: Adding to the map

The fix is complete and correct. The key format now matches between adding and removing entries from the `remoteChannelMap`.

Let me do a final review of the change to ensure everything is correct.
</thinking>
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && git diff proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java

========================================================================================================================
TOOL RETURN (bash)
```
diff --git a/proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java b/proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
index f70c06b8f..5d13b5256 100644
--- a/proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
+++ b/proxy/src/main/java/org/apache/rocketmq/proxy/service/sysmessage/HeartbeatSyncer.java
@@ -80,7 +80,7 @@ public class HeartbeatSyncer extends AbstractSystemMessageSyncer {
          ...
```
========================================================================================================================
AGENT:
STEP 4: FINAL VERIFICATION

<thinking>
The fix is complete. Let me summarize what was done:

**Problem:**
The `remoteChannelMap` in `HeartbeatSyncer` was not being cleared properly when a consumer unregisters. This was because:
- When adding to the map, the key format was `group + "@" + channelId`
- When removing from the map, the key format was just `channelId`

**Solution:**
Changed the removal code to use the correct key format: `s + "@" + channelId` where `s` is the consumer group name passed to the `ConsumerIdsChangeListener.handle()` method.

**Verification:**
1. The `ConsumerIdsChangeListener` interface confirms that the second parameter is the `group` name
2. The `ConsumerManager.callConsumerIdsChangeListener()` method confirms that the group name is passed as the second argument
3. The key format now matches between adding and removing entries from the `remoteChannelMap`

The fix is minimal and targeted, addressing the root cause of the bug without introducing any side effects.
</thinking>
========================================================================================================================
AGENT:
Fixed the bug where the remoteChannelMap of HeartbeatSyncer was not cleared properly.

**Problem:**
The `remoteChannelMap` in `HeartbeatSyncer` was not being cleared properly when a consumer unregisters. The map uses keys in the format `group@channelId`, but when removing entries, only `channelId` was used as the key, causing the removal to fail.

**Solution:**
Changed line 82 in `HeartbeatSyncer.java` from:
```java
remoteChannelMap.remove(clientChannelInfo.getChannel().id().asLongText());
```
to:
```java
remoteChannelMap.remove(s + "@" + clientChannelInfo.getChannel().id().asLongText());
```

Where `s` is the consumer group name passed to the `ConsumerIdsChangeListener.handle()` method. This ensures the key format matches between adding (at line 192: `data.getGroup() + "@" + decodedChannel.id().asLongText()`) and removing entries from the map.
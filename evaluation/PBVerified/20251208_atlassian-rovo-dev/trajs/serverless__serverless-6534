########################################################################################################################
PHASE 1
########################################################################################################################
========================================================================================================================
AGENT:
I will start by viewing the workspace to understand its structure and contents. This will help me identify key files and locations that may be relevant to the task.
========================================================================================================================
USER PROMPT:
Resolve the following problem statement:

<problem_statement>
Wider `logs:CreateLogStream`/`logs:PutLogEvents` permissions in policy for Lambda functions with manual names (v1.45.1)
<!--
1. If you have a question and not a bug report please ask first at http://forum.serverless.com
2. Please check if an issue already exists. This bug may have already been documented
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

## Description

* What went wrong?

   When a service contains only custom named functions, the policies for `logs:CreateLogStream` and `logs:PutLogEvents` created using v1.45.1 have a wider set of permissions than they previously did with v1.44.1.

   ### Resource access allowed when using v1.44.1

   * `logs:CreateLogStream`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*`
   * `logs:PutLogEvents`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*:*`


   ### Resource access allowed when using v1.45.1

   * `logs:CreateLogStream`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-dev*:*`
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*`
   * `logs:PutLogEvents`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-dev*:*:*`
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*:*`

* What did you expect should have happened?

   Based on the principle of least privilege, the additional permissions for `/aws/lambda/log-group-policy-dev*` should not have been added to the IAM policy.

* What was the config you used?

   Full source: [log-group-policy.zip](https://github.com/serverless/serverless/files/3296986/log-group-policy.zip)

   ```yaml
   service: log-group-policy

   provider:
      name: aws
      runtime: nodejs8.10

   functions:
      testFunction:
         name: ${self:service}-custom-named-fn
         handler: index.handler
   ```

   #### To compare output between v1.44.1 and v1.45.1

   ```
   unzip log-group-policy.zip
   cd log-group-policy
   echo '{}' > package.json
   npm i serverless@1.44.1
   ./node_modules/.bin/sls package
   cp .serverless/cloudformation-template-update-stack.json cf-update-stack-v1.44.1.json
   npm i serverless@1.45.1
   ./node_modules/.bin/sls package
   cp .serverless/cloudformation-template-update-stack.json cf-update-stack-v1.45.1.json
   diff cf-update-stack-v1.44.1.json cf-update-stack-v1.45.1.json
   ```

Similar or dependent issues:
* #6236 (PR #6240)
* #6212

## Additional Data

* ***Serverless Framework Version you're using***: 1.45.1
* ***Operating System***: macOS 10.14
* ***Stack Trace***: n/a
* ***Provider Error messages***: none


</problem_statement>

Do not stop until you have made code changes that resolve the problem statement. Do not ask for clarifications.
========================================================================================================================
AGENT:
Starting to analyze the problem statement. The issue is about wider `logs:CreateLogStream`/`logs:PutLogEvents` permissions being added to IAM policies for Lambda functions with manual/custom names. I need to explore the codebase to understand how IAM policies are generated and find where the issue was introduced.
========================================================================================================================
AGENT:
STEP 1: EXPLORE THE CODEBASE

<thinking>
The problem statement indicates that:
1. When a service contains only custom-named functions (using `name:` property in the function config), the IAM policies for `logs:CreateLogStream` and `logs:PutLogEvents` are getting wider permissions than expected.
2. In v1.44.1, only the specific log group for the custom-named function was included.
3. In v1.45.1, an additional wildcard permission for `/aws/lambda/log-group-policy-dev*` was added.

The issue is related to IAM policy generation for Lambda functions. I need to look at:
1. The IAM template merging code - likely in `lib/plugins/aws/package/lib/mergeIamTemplates.js`
2. The naming conventions - likely in `lib/plugins/aws/lib/naming.js`

Let me start by exploring these files to understand how the IAM policies are generated.
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- lib/plugins/aws/package/lib/mergeIamTemplates.js
- lib/plugins/aws/lib/naming.js

========================================================================================================================
TOOL RETURN (open_files)
```
["Successfully opened lib/plugins/aws/package/lib/mergeIamTemplates.js:\n\n````javascript\n   0 'use strict';\n   1 \n   2 const _ = require('lodash');\n...\n   7   mergeIamTemplates() {\n...\n  13   merge() {\n...\n 174   mergeManagedPolicies(managedPolicies) {\n...\n 184   validateStatements(statements) {\n...\n 218   validateManagedPolicies(iamManagedPolicies) {\n...\n 228 \n````", "Successfully opened lib/plugins/aws/lib/naming.js:\n\n````javascript\n   0 'use strict';\n   1 \n   2 const _ =...
```
========================================================================================================================
AGENT:
<thinking>
I need to expand the relevant code chunks in these files to understand how the IAM policies are generated. Let me look at the `mergeIamTemplates.js` file more closely, particularly the `merge` function which likely handles the IAM policy generation.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.js
line_ranges:
- - 0
  - -1

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.js:

````javascript
   0 'use strict';
   1 
   2 const _ = require('lodash');
   3 const BbPromise = require('bluebird');
   4 const path = require('path');
   5 
   6 module.exports = {
   7   mergeIamTemplates() {
   8     this.validateStatements(this.serverless.service.provider.iamRoleStatements);
   9     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);
  10     return this.m...
```
========================================================================================================================
AGENT:
<thinking>
Now I understand the issue. Looking at the code in `mergeIamTemplates.js`:

1. Lines 83-103: The code always adds a general policy for functions with default name resolution using the `canonicalFunctionNamePrefix` (which is `${service}-${stage}`). This creates a wildcard permission like `/aws/lambda/log-group-policy-dev*`.

2. Lines 105-127: For functions with custom names, it adds additional specific policies for those custom-named functions.

The problem is that the general policy (lines 92-103) is always added, even when ALL functions have custom names. According to the issue, when all functions have custom names, the general wildcard policy shouldn't be added because it's unnecessary and violates the principle of least privilege.

The fix should be:
- Only add the general wildcard policy (lines 92-103) if there are functions that use the default naming convention (i.e., functions that don't have a custom `name` property or whose name starts with the `canonicalFunctionNamePrefix`).

Let me look at the test file to understand the expected behavior better.
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- lib/plugins/aws/package/lib/mergeIamTemplates.test.js

========================================================================================================================
TOOL RETURN (open_files)
```
["Successfully opened lib/plugins/aws/package/lib/mergeIamTemplates.test.js:\n\n````javascript\n   0 'use strict';\n   1 \n   2 const expect = require('chai').expect;\n...\n   9   let awsPackage;\n...\n  18     const options = {\n...\n  42       const resources =\n...\n  51       const canonicalFunctionsPrefix = `${\n...\n 130     const customFunctionName = 'foo-bar';\n...\n 141       const canonicalFunctionsPrefix = `${\n...\n 268     const iamManagedPolicies = [\n...\n 274     const expectedMa...
```
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
line_ranges:
- - 0
  - 200

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

````javascript
   0 'use strict';
   1 
   2 const expect = require('chai').expect;
   3 
   4 const Serverless = require('../../../../Serverless');
   5 const AwsProvider = require('../../provider/awsProvider');
   6 const AwsPackage = require('../index');
   7 
   8 describe('#mergeIamTemplates()', () => {
   9   let awsPackage;
  10   let serverless;
  11   const serviceName = 'new-service';
  12   co...
```
========================================================================================================================
AGENT:
<thinking>
Now I can see the issue more clearly. Looking at the test case "should ensure IAM policies for custom named functions" (lines 129-200), the expected behavior in the test is that BOTH the canonical prefix wildcard AND the custom function name are included in the policy. However, according to the bug report, when ALL functions have custom names, the canonical prefix wildcard should NOT be included.

The test case at line 129 shows that when a function has a custom name, it expects both:
1. The canonical prefix wildcard: `log-group:/aws/lambda/${canonicalFunctionsPrefix}*:*`
2. The custom function name: `log-group:/aws/lambda/${customFunctionName}:*`

But according to the bug report, this is incorrect behavior. When ALL functions have custom names (that don't start with the canonical prefix), the wildcard should not be added.

Let me check the test file more to see if there are more relevant tests, and then I'll implement the fix.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
line_ranges:
- - 200
  - 270

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

````javascript
   0 'use strict';
   1 
   2 const expect = require('chai').expect;
   3 
   4 const Serverless = require('../../../../Serverless');
   5 const AwsProvider = require('../../provider/awsProvider');
   6 const AwsPackage = require('../index');
   7 
   8 describe('#mergeIamTemplates()', () => {
   9   let awsPackage;
  10   let serverless;
  11   const serviceName = 'new-service';
  12   co...
```
========================================================================================================================
AGENT:
<thinking>
Now I understand the issue completely. The test at line 129 ("should ensure IAM policies for custom named functions") shows the current (buggy) behavior where both the canonical prefix wildcard AND the custom function name are included. According to the bug report, when ALL functions have custom names, only the custom function name should be included, not the wildcard.

The fix should be:
1. First, check if there are any functions that use the default naming convention (i.e., functions without a custom `name` property or whose name starts with the `canonicalFunctionNamePrefix`).
2. Only add the general wildcard policy if there are such functions.
3. For functions with custom names that don't start with the canonical prefix, add specific policies.

Let me now implement the fix in `mergeIamTemplates.js`.

The current code structure is:
1. Lines 92-103: Always add the general wildcard policy
2. Lines 105-127: Add specific policies for custom-named functions

The fix should be:
1. First, determine if there are any functions that use the default naming convention
2. Only add the general wildcard policy if there are such functions
3. Add specific policies for custom-named functions

Let me implement this fix.
</thinking>

STEP 2: IMPLEMENT THE FIX
========================================================================================================================
AGENT:
I've identified the issue in lib/plugins/aws/package/lib/mergeIamTemplates.js. The code always adds a general wildcard policy for the canonical function prefix, even when all functions have custom names. I will now implement the fix to only add the wildcard policy when there are functions using the default naming convention.
========================================================================================================================
TOOL CALL (find_and_replace_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.js
find: "    const canonicalFunctionNamePrefix = `${\n      this.provider.serverless.service.service\n\
  \    }-${this.provider.getStage()}`;\n    const logGroupsPrefix = this.provider.naming.getLogGroupName(canonicalFunctionNamePrefix);\n\
  \n    const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n\
  \      .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n\
  \      .Statement;\n\n    // Ensure general polices for functions with default name\
  \ resolution\n    policyDocumentStatements[0].Resource.push({\n      'Fn::Sub':\n\
  \        'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n     \
  \   `:log-group:${logGroupsPrefix}*:*`,\n    });\n\n    policyDocumentStatements[1].Resource.push({\n\
  \      'Fn::Sub':\n        'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n        `:log-group:${logGroupsPrefix}*:*:*`,\n    });\n\n    // Ensure policies\
  \ for functions with custom name resolution\n    this.serverless.service.getAllFunctions().forEach(functionName\
  \ => {\n      const { name: resolvedFunctionName } = this.serverless.service.getFunction(functionName);\n\
  \      if (!resolvedFunctionName || resolvedFunctionName.startsWith(canonicalFunctionNamePrefix))\
  \ {\n        return;\n      }\n\n      const customFunctionNamelogGroupsPrefix =\
  \ this.provider.naming.getLogGroupName(\n        resolvedFunctionName\n      );\n\
  \n      policyDocumentStatements[0].Resource.push({\n        'Fn::Sub':\n      \
  \    'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n         \
  \ `:log-group:${customFunctionNamelogGroupsPrefix}:*`,\n      });\n\n      policyDocumentStatements[1].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${customFunctionNamelogGroupsPrefix}:*:*`,\n      });\n\
  \    });"
replace: "    const canonicalFunctionNamePrefix = `${\n      this.provider.serverless.service.service\n\
  \    }-${this.provider.getStage()}`;\n    const logGroupsPrefix = this.provider.naming.getLogGroupName(canonicalFunctionNamePrefix);\n\
  \n    const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n\
  \      .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n\
  \      .Statement;\n\n    let hasOneOrMoreCanonicallyNamedFunctions = false;\n \
  \   // Ensure policies for functions with custom name resolution\n    this.serverless.service.getAllFunctions().forEach(functionName\
  \ => {\n      const { name: resolvedFunctionName } = this.serverless.service.getFunction(functionName);\n\
  \      if (!resolvedFunctionName || resolvedFunctionName.startsWith(canonicalFunctionNamePrefix))\
  \ {\n        hasOneOrMoreCanonicallyNamedFunctions = true;\n        return;\n  \
  \    }\n\n      const customFunctionNamelogGroupsPrefix = this.provider.naming.getLogGroupName(\n\
  \        resolvedFunctionName\n      );\n\n      policyDocumentStatements[0].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${customFunctionNamelogGroupsPrefix}:*`,\n      });\n\
  \n      policyDocumentStatements[1].Resource.push({\n        'Fn::Sub':\n      \
  \    'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n         \
  \ `:log-group:${customFunctionNamelogGroupsPrefix}:*:*`,\n      });\n    });\n\n\
  \    // Ensure general policies for functions with default name resolution\n   \
  \ if (hasOneOrMoreCanonicallyNamedFunctions) {\n      policyDocumentStatements[0].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${logGroupsPrefix}*:*`,\n      });\n\n      policyDocumentStatements[1].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${logGroupsPrefix}*:*:*`,\n      });\n    }"

========================================================================================================================
TOOL RETURN (find_and_replace_code)
```
Successfully replaced code in lib/plugins/aws/package/lib/mergeIamTemplates.js:

--- lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -90,23 +90,12 @@
       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument
       .Statement;
 
-    // Ensure general polices for functions with default name resolution
-    policyDocumentStatements[0].Resource.push({
-      'Fn::Sub':
-        'arn:${AWS::Partition}:lo...
```
========================================================================================================================
AGENT:
STEP 3: UPDATE THE TEST FILE

<thinking>
Now I need to update the test file to reflect the correct expected behavior. The test "should ensure IAM policies for custom named functions" should expect that when all functions have custom names, only the custom function name policies are included, not the wildcard.

Let me update the test.
</thinking>
========================================================================================================================
TOOL CALL (find_and_replace_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
find: "  it('should ensure IAM policies for custom named functions', () => {\n   \
  \ const customFunctionName = 'foo-bar';\n    awsPackage.serverless.service.functions\
  \ = {\n      [functionName]: {\n        name: customFunctionName,\n        artifact:\
  \ 'test.zip',\n        handler: 'handler.hello',\n      },\n    };\n    serverless.service.setFunctionNames();\
  \ // Ensure to resolve function names\n\n    return awsPackage.mergeIamTemplates().then(()\
  \ => {\n      const canonicalFunctionsPrefix = `${\n        awsPackage.serverless.service.service\n\
  \      }-${awsPackage.provider.getStage()}`;\n\n      expect(\n        awsPackage.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n\
  \          awsPackage.provider.naming.getRoleLogicalId()\n        ]\n      ).to.deep.equal({\n\
  \        Type: 'AWS::IAM::Role',\n        Properties: {\n          AssumeRolePolicyDocument:\
  \ {\n            Version: '2012-10-17',\n            Statement: [\n            \
  \  {\n                Effect: 'Allow',\n                Principal: {\n         \
  \         Service: ['lambda.amazonaws.com'],\n                },\n             \
  \   Action: ['sts:AssumeRole'],\n              },\n            ],\n          },\n\
  \          Path: '/',\n          Policies: [\n            {\n              PolicyName:\
  \ {\n                'Fn::Join': [\n                  '-',\n                  [awsPackage.provider.getStage(),\
  \ awsPackage.serverless.service.service, 'lambda'],\n                ],\n      \
  \        },\n              PolicyDocument: {\n                Version: '2012-10-17',\n\
  \                Statement: [\n                  {\n                    Effect:\
  \ 'Allow',\n                    Action: ['logs:CreateLogStream'],\n            \
  \        Resource: [\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${canonicalFunctionsPrefix}*:*`,\n\
  \                      },\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \            {\n                    Effect: 'Allow',\n                    Action:\
  \ ['logs:PutLogEvents'],\n                    Resource: [\n                    \
  \  {\n                        'Fn::Sub':\n                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${canonicalFunctionsPrefix}*:*:*`,\n\
  \                      },\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \          ],\n              },\n            },\n          ],\n          RoleName:\
  \ {\n            'Fn::Join': [\n              '-',\n              [\n          \
  \      awsPackage.serverless.service.service,\n                awsPackage.provider.getStage(),\n\
  \                {\n                  Ref: 'AWS::Region',\n                },\n\
  \                'lambdaRole',\n              ],\n            ],\n          },\n\
  \        },\n      });\n    });\n  });"
replace: "  it('should ensure IAM policies for custom named functions', () => {\n\
  \    const customFunctionName = 'foo-bar';\n    awsPackage.serverless.service.functions\
  \ = {\n      [functionName]: {\n        name: customFunctionName,\n        artifact:\
  \ 'test.zip',\n        handler: 'handler.hello',\n      },\n    };\n    serverless.service.setFunctionNames();\
  \ // Ensure to resolve function names\n\n    return awsPackage.mergeIamTemplates().then(()\
  \ => {\n      expect(\n        awsPackage.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n\
  \          awsPackage.provider.naming.getRoleLogicalId()\n        ]\n      ).to.deep.equal({\n\
  \        Type: 'AWS::IAM::Role',\n        Properties: {\n          AssumeRolePolicyDocument:\
  \ {\n            Version: '2012-10-17',\n            Statement: [\n            \
  \  {\n                Effect: 'Allow',\n                Principal: {\n         \
  \         Service: ['lambda.amazonaws.com'],\n                },\n             \
  \   Action: ['sts:AssumeRole'],\n              },\n            ],\n          },\n\
  \          Path: '/',\n          Policies: [\n            {\n              PolicyName:\
  \ {\n                'Fn::Join': [\n                  '-',\n                  [awsPackage.provider.getStage(),\
  \ awsPackage.serverless.service.service, 'lambda'],\n                ],\n      \
  \        },\n              PolicyDocument: {\n                Version: '2012-10-17',\n\
  \                Statement: [\n                  {\n                    Effect:\
  \ 'Allow',\n                    Action: ['logs:CreateLogStream'],\n            \
  \        Resource: [\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \            {\n                    Effect: 'Allow',\n                    Action:\
  \ ['logs:PutLogEvents'],\n                    Resource: [\n                    \
  \  {\n                        'Fn::Sub':\n                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \          ],\n              },\n            },\n          ],\n          RoleName:\
  \ {\n            'Fn::Join': [\n              '-',\n              [\n          \
  \      awsPackage.serverless.service.service,\n                awsPackage.provider.getStage(),\n\
  \                {\n                  Ref: 'AWS::Region',\n                },\n\
  \                'lambdaRole',\n              ],\n            ],\n          },\n\
  \        },\n      });\n    });\n  });"

========================================================================================================================
TOOL RETURN (find_and_replace_code)
```
Successfully replaced code in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

--- lib/plugins/aws/package/lib/mergeIamTemplates.test.js
+++ lib/plugins/aws/package/lib/mergeIamTemplates.test.js
@@ -139,10 +139,6 @@
     serverless.service.setFunctionNames(); // Ensure to resolve function names
 
     return awsPackage.mergeIamTemplates().then(() => {
-      const canonicalFunctionsPrefix = `${
-        awsPackage.serverless.service.service
-      }-${awsPackage.provider.getStage()}`;
-
 ...
```
========================================================================================================================
AGENT:
STEP 4: RUN TESTS TO VERIFY THE FIX

<thinking>
Now I need to run the tests to verify that the fix works correctly. Let me first install the dependencies and then run the specific test file.
</thinking>
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm install 2>&1 | tail -20
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

added 903 packages, and audited 904 packages in 35s

117 packages are looking for funding
  run `npm fund` for details

36 vulnerabilities (7 low, 10 moderate, 12 high, 7 critical)

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
npm notice
npm notice New major version of npm available! 10.9.3 -> 11.6.4
npm notice Changelog: https://github.com/npm/cl...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "mergeIamTemplates" 2>&1 | tail -100
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep mergeIamTemplates



  #mergeIamTemplates()
(node:614) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    ✓ should not merge if the...
```
========================================================================================================================
AGENT:
All tests pass. Now let me create a minimal reproduction script to verify the fix works as expected for the scenario described in the bug report.
========================================================================================================================
TOOL CALL (bash)
command: "mkdir -p /tmp/test-fix && cd /tmp/test-fix && cat > serverless.yml << 'EOF'\n\
  service: log-group-policy\n\nprovider:\n  name: aws\n  runtime: nodejs8.10\n\nfunctions:\n\
  \  testFunction:\n    name: ${self:service}-custom-named-fn\n    handler: index.handler\n\
  EOF\n\ncat > index.js << 'EOF'\nmodule.exports.handler = async (event) => {\n  return\
  \ { statusCode: 200, body: 'Hello' };\n};\nEOF\n\necho \"Created test files\""

========================================================================================================================
TOOL RETURN (bash)
```
Created test files...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /tmp/test-fix && /workspace/bin/serverless package 2>&1 | tail -20
timeout: 60

========================================================================================================================
TOOL RETURN (bash)
```
(node:1146) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
Serverless: Packaging service...
Serverless: Excluding development dependencies......
```
========================================================================================================================
TOOL CALL (bash)
command: "cd /tmp/test-fix && cat .serverless/cloudformation-template-update-stack.json\
  \ | python3 -c \"\nimport json\nimport sys\n\ndata = json.load(sys.stdin)\nrole\
  \ = data['Resources']['IamRoleLambdaExecution']\nstatements = role['Properties']['Policies'][0]['PolicyDocument']['Statement']\n\
  \nprint('=== IAM Policy Statements ===')\nfor stmt in statements:\n    print(f\\\
  \"Action: {stmt['Action']}\\\")\n    print(f\\\"Resources:\\\")\n    for res in\
  \ stmt['Resource']:\n        if isinstance(res, dict) and 'Fn::Sub' in res:\n  \
  \          print(f\\\"  - {res['Fn::Sub']}\\\")\n        else:\n            print(f\\\
  \"  - {res}\\\")\n    print()\n\""

========================================================================================================================
TOOL RETURN (bash)
```
=== IAM Policy Statements ===
Action: ['logs:CreateLogStream']
Resources:
  - arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*

Action: ['logs:PutLogEvents']
Resources:
  - arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*:*...
```
========================================================================================================================
AGENT:
The fix is working correctly. Now the IAM policy only includes the specific log group for the custom-named function (`log-group-policy-custom-named-fn`), and does NOT include the wildcard permission for `log-group-policy-dev*`.

Let me also verify that the fix still works correctly when there's a mix of custom-named and default-named functions:
========================================================================================================================
TOOL CALL (bash)
command: "mkdir -p /tmp/test-fix-mixed && cd /tmp/test-fix-mixed && cat > serverless.yml\
  \ << 'EOF'\nservice: log-group-policy\n\nprovider:\n  name: aws\n  runtime: nodejs8.10\n\
  \nfunctions:\n  testFunction:\n    name: ${self:service}-custom-named-fn\n    handler:\
  \ index.handler\n  defaultFunction:\n    handler: index.handler\nEOF\n\ncat > index.js\
  \ << 'EOF'\nmodule.exports.handler = async (event) => {\n  return { statusCode:\
  \ 200, body: 'Hello' };\n};\nEOF\n\necho \"Created test files for mixed scenario\""

========================================================================================================================
TOOL RETURN (bash)
```
Created test files for mixed scenario...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /tmp/test-fix-mixed && /workspace/bin/serverless package 2>&1 | tail -10
timeout: 60

========================================================================================================================
TOOL RETURN (bash)
```
(node:1975) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
Serverless: Packaging service...
Serverless: Excluding development dependencies......
```
========================================================================================================================
TOOL CALL (bash)
command: "cd /tmp/test-fix-mixed && cat .serverless/cloudformation-template-update-stack.json\
  \ | python3 -c \"\nimport json\nimport sys\n\ndata = json.load(sys.stdin)\nrole\
  \ = data['Resources']['IamRoleLambdaExecution']\nstatements = role['Properties']['Policies'][0]['PolicyDocument']['Statement']\n\
  \nprint('=== IAM Policy Statements (Mixed Scenario) ===')\nfor stmt in statements:\n\
  \    print(f\\\"Action: {stmt['Action']}\\\")\n    print(f\\\"Resources:\\\")\n\
  \    for res in stmt['Resource']:\n        if isinstance(res, dict) and 'Fn::Sub'\
  \ in res:\n            print(f\\\"  - {res['Fn::Sub']}\\\")\n        else:\n   \
  \         print(f\\\"  - {res}\\\")\n    print()\n\""

========================================================================================================================
TOOL RETURN (bash)
```
=== IAM Policy Statements (Mixed Scenario) ===
Action: ['logs:CreateLogStream']
Resources:
  - arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*
  - arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-dev*:*

Action: ['logs:PutLogEvents']
Resources:
  - arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*:*
  - arn:${AWS...
```
========================================================================================================================
AGENT:
The mixed scenario also works correctly. When there's a mix of custom-named and default-named functions:
1. The custom-named function gets its specific log group permission
2. The default-named function gets the wildcard permission for the canonical prefix

Let me also test the scenario where all functions use the default naming convention:
========================================================================================================================
TOOL CALL (bash)
command: "mkdir -p /tmp/test-fix-default && cd /tmp/test-fix-default && cat > serverless.yml\
  \ << 'EOF'\nservice: log-group-policy\n\nprovider:\n  name: aws\n  runtime: nodejs8.10\n\
  \nfunctions:\n  testFunction:\n    handler: index.handler\n  anotherFunction:\n\
  \    handler: index.handler\nEOF\n\ncat > index.js << 'EOF'\nmodule.exports.handler\
  \ = async (event) => {\n  return { statusCode: 200, body: 'Hello' };\n};\nEOF\n\n\
  echo \"Created test files for default naming scenario\""

========================================================================================================================
TOOL RETURN (bash)
```
Created test files for default naming scenario...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /tmp/test-fix-default && /workspace/bin/serverless package 2>&1 | tail
  -10
timeout: 60

========================================================================================================================
TOOL RETURN (bash)
```
(node:2804) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
Serverless: Packaging service...
Serverless: Excluding development dependencies......
```
========================================================================================================================
TOOL CALL (bash)
command: "cd /tmp/test-fix-default && cat .serverless/cloudformation-template-update-stack.json\
  \ | python3 -c \"\nimport json\nimport sys\n\ndata = json.load(sys.stdin)\nrole\
  \ = data['Resources']['IamRoleLambdaExecution']\nstatements = role['Properties']['Policies'][0]['PolicyDocument']['Statement']\n\
  \nprint('=== IAM Policy Statements (Default Naming Scenario) ===')\nfor stmt in\
  \ statements:\n    print(f\\\"Action: {stmt['Action']}\\\")\n    print(f\\\"Resources:\\\
  \")\n    for res in stmt['Resource']:\n        if isinstance(res, dict) and 'Fn::Sub'\
  \ in res:\n            print(f\\\"  - {res['Fn::Sub']}\\\")\n        else:\n   \
  \         print(f\\\"  - {res}\\\")\n    print()\n\""

========================================================================================================================
TOOL RETURN (bash)
```
=== IAM Policy Statements (Default Naming Scenario) ===
Action: ['logs:CreateLogStream']
Resources:
  - arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-dev*:*

Action: ['logs:PutLogEvents']
Resources:
  - arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-dev*:*:*...
```
========================================================================================================================
AGENT:
All three scenarios work correctly:

1. **Custom-named functions only**: Only specific log group permissions for the custom-named function (no wildcard)
2. **Mixed (custom + default)**: Both specific permissions for custom-named functions AND wildcard for default-named functions
3. **Default-named functions only**: Only wildcard permission for the canonical prefix

Let me run the full test suite for the mergeIamTemplates module one more time to make sure everything passes:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "mergeIamTemplates" 2>&1
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep mergeIamTemplates



  #mergeIamTemplates()
(node:3381) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    ✓ should not merge if th...
```
========================================================================================================================
AGENT:
All 23 tests pass. Let me also verify the changes I made by reviewing the modified files:
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.js
line_ranges:
- - 80
  - 140

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.js:

````javascript
   0 'use strict';
   1 
   2 const _ = require('lodash');
   3 const BbPromise = require('bluebird');
   4 const path = require('path');
   5 
   6 module.exports = {
   7   mergeIamTemplates() {
   8     this.validateStatements(this.serverless.service.provider.iamRoleStatements);
   9     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);
  10     return this.m...
```
========================================================================================================================
AGENT:
The code looks correct. Let me also run a broader set of tests to ensure the fix doesn't break anything else:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "package" 2>&1 | tail -50
timeout: 180

========================================================================================================================
TOOL RETURN (bash)
```
Serverless: Excluding development dependencies...
      ✓ should call zipService with settings

  zipService
    #excludeDevDependencies()
      when dealing with Node.js runtimes
Serverless: Excluding development dependencies...
        ✓ should do nothing if no packages are used
Serverless: Excluding development dependencies...
        ✓ should not include packages if in both dependencies and devDependencies

  Package
    hooks
      ✓ should implement the package:createDeploymentArtifacts ev...
```
========================================================================================================================
AGENT:
All tests pass. Let me also run the AWS-specific tests to ensure nothing is broken:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "AwsPackage" 2>&1 | tail -50
timeout: 180

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep AwsPackage



  AwsPackage
    #constructor()
      ✓ should set the serverless instance
      ✓ should set options
      ✓ should set the service path if provided
      ✓ should default to an empty service path if not provided
      ✓ should use the options package path if provided
      ✓ should use the services package path if provided
      ✓ should default to the .serverless directory as the package path
      ✓ should ...
```
========================================================================================================================
AGENT:
All tests pass. Let me also verify the test file changes are correct:
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
line_ranges:
- - 129
  - 230

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

````javascript
   0 'use strict';
   1 
   2 const expect = require('chai').expect;
   3 
   4 const Serverless = require('../../../../Serverless');
   5 const AwsProvider = require('../../provider/awsProvider');
   6 const AwsPackage = require('../index');
   7 
   8 describe('#mergeIamTemplates()', () => {
   9   let awsPackage;
  10   let serverless;
  11   const serviceName = 'new-service';
  12   co...
```
========================================================================================================================
AGENT:
The test file looks correct. The test "should ensure IAM policies for custom named functions" now expects only the custom function name in the policy, without the wildcard for the canonical prefix.

Let me clean up the temporary test directories:
========================================================================================================================
TOOL CALL (bash)
command: rm -rf /tmp/test-fix /tmp/test-fix-mixed /tmp/test-fix-default

========================================================================================================================
TOOL RETURN (bash)
```
...
```
========================================================================================================================
AGENT:
Successfully resolved the issue with wider `logs:CreateLogStream`/`logs:PutLogEvents` permissions in IAM policies for Lambda functions with manual names.

## Summary of Changes

### Problem
When a service contained only custom-named functions (using the `name:` property), the IAM policies for `logs:CreateLogStream` and `logs:PutLogEvents` were getting wider permissions than necessary. Specifically, a wildcard permission for the canonical prefix (e.g., `/aws/lambda/service-dev*`) was being added even when no functions used the default naming convention.

### Solution
Modified `lib/plugins/aws/package/lib/mergeIamTemplates.js` to:
1. Track whether any functions use the canonical (default) naming convention
2. Only add the wildcard policy for the canonical prefix if at least one function uses the default naming
3. Continue to add specific policies for custom-named functions

### Files Modified
1. **lib/plugins/aws/package/lib/mergeIamTemplates.js**: Changed the logic to conditionally add the wildcard policy based on whether there are any canonically-named functions
2. **lib/plugins/aws/package/lib/mergeIamTemplates.test.js**: Updated the test "should ensure IAM policies for custom named functions" to expect only the custom function name in the policy (without the wildcard)

### Verification
- All 23 tests in the mergeIamTemplates test suite pass
- Tested three scenarios:
  1. **Custom-named functions only**: Only specific log group permissions (no wildcard) ✓
  2. **Mixed (custom + default)**: Both specific and wildcard permissions ✓
  3. **Default-named functions only**: Only wildcard permission ✓

This fix ensures the principle of least privilege is followed by not adding unnecessary wildcard permissions when all functions have custom names.
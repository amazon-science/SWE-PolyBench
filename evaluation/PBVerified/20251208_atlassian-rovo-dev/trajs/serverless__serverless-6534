########################################################################################################################
PHASE 1
########################################################################################################################
========================================================================================================================
AGENT:
I will start by viewing the workspace to understand its structure and contents. This will help me identify key files and locations that may be relevant to the task.
========================================================================================================================
USER PROMPT:
Resolve the following problem statement:

<problem_statement>
Wider `logs:CreateLogStream`/`logs:PutLogEvents` permissions in policy for Lambda functions with manual names (v1.45.1)
<!--
1. If you have a question and not a bug report please ask first at http://forum.serverless.com
2. Please check if an issue already exists. This bug may have already been documented
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

## Description

* What went wrong?

   When a service contains only custom named functions, the policies for `logs:CreateLogStream` and `logs:PutLogEvents` created using v1.45.1 have a wider set of permissions than they previously did with v1.44.1.

   ### Resource access allowed when using v1.44.1

   * `logs:CreateLogStream`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*`
   * `logs:PutLogEvents`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*:*`


   ### Resource access allowed when using v1.45.1

   * `logs:CreateLogStream`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-dev*:*`
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*`
   * `logs:PutLogEvents`:
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-dev*:*:*`
      * `arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*:*`

* What did you expect should have happened?

   Based on the principle of least privilege, the additional permissions for `/aws/lambda/log-group-policy-dev*` should not have been added to the IAM policy.

* What was the config you used?

   Full source: [log-group-policy.zip](https://github.com/serverless/serverless/files/3296986/log-group-policy.zip)

   ```yaml
   service: log-group-policy

   provider:
      name: aws
      runtime: nodejs8.10

   functions:
      testFunction:
         name: ${self:service}-custom-named-fn
         handler: index.handler
   ```

   #### To compare output between v1.44.1 and v1.45.1

   ```
   unzip log-group-policy.zip
   cd log-group-policy
   echo '{}' > package.json
   npm i serverless@1.44.1
   ./node_modules/.bin/sls package
   cp .serverless/cloudformation-template-update-stack.json cf-update-stack-v1.44.1.json
   npm i serverless@1.45.1
   ./node_modules/.bin/sls package
   cp .serverless/cloudformation-template-update-stack.json cf-update-stack-v1.45.1.json
   diff cf-update-stack-v1.44.1.json cf-update-stack-v1.45.1.json
   ```

Similar or dependent issues:
* #6236 (PR #6240)
* #6212

## Additional Data

* ***Serverless Framework Version you're using***: 1.45.1
* ***Operating System***: macOS 10.14
* ***Stack Trace***: n/a
* ***Provider Error messages***: none


</problem_statement>

Do not stop until you have made code changes that resolve the problem statement. Do not ask for clarifications.

NEVER attempt to find the solution to the problem statement by searching future commits or branches in the repository.
========================================================================================================================
AGENT:
Starting to analyze the problem statement. The issue is about wider permissions being added for `logs:CreateLogStream` and `logs:PutLogEvents` in IAM policies for Lambda functions with custom names. I need to explore the codebase to understand how these policies are generated and find the root cause of the regression between v1.44.1 and v1.45.1.
========================================================================================================================
AGENT:
EXPLORE WORKSPACE: Understanding the issue and finding relevant files

<thinking>
The problem statement indicates that:
1. When a service contains only custom named functions (functions with explicit `name` property), the policies for `logs:CreateLogStream` and `logs:PutLogEvents` now include an additional wildcard permission for `/aws/lambda/log-group-policy-dev*` that wasn't there before.
2. This is a regression introduced in v1.45.1 compared to v1.44.1.
3. The issue references PR #6240 and issue #6236 and #6212 as related.

I need to:
1. Find where IAM policies are generated for Lambda functions
2. Understand how the log group permissions are constructed
3. Identify why the additional wildcard permission is being added when all functions have custom names

Let me start by searching for files related to IAM policy generation and log group permissions.
</thinking>
========================================================================================================================
TOOL CALL (grep)
content_pattern: logs:CreateLogStream

========================================================================================================================
TOOL RETURN (grep)
```
docs/providers/aws/guide/iam.md:124:                    - logs:CreateLogStream
docs/providers/aws/guide/iam.md:184:                    - logs:CreateLogStream
docs/providers/aws/guide/iam.md:222:                    - logs:CreateLogStream
docs/providers/aws/guide/iam.md:281:                    - logs:CreateLogStream
docs/providers/aws/guide/iam.md:320:                    - logs:CreateLogStream
lib/plugins/aws/package/lib/mergeIamTemplates.test.js:89:                    Action: ['logs:CreateLogStre...
```
========================================================================================================================
AGENT:
<thinking>
The key files seem to be:
1. `lib/plugins/aws/package/lib/mergeIamTemplates.js` - This is likely where IAM templates are merged
2. `lib/plugins/aws/package/lib/iam-role-lambda-execution-template.json` - The base IAM template

Let me open these files to understand the structure.
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- lib/plugins/aws/package/lib/mergeIamTemplates.js
- lib/plugins/aws/package/lib/iam-role-lambda-execution-template.json

========================================================================================================================
TOOL RETURN (open_files)
```
["Successfully opened lib/plugins/aws/package/lib/mergeIamTemplates.js:\n\n````javascript\n   0 'use strict';\n   1 \n   2 const _ = require('lodash');\n...\n   7   mergeIamTemplates() {\n...\n  13   merge() {\n...\n 174   mergeManagedPolicies(managedPolicies) {\n...\n 184   validateStatements(statements) {\n...\n 218   validateManagedPolicies(iamManagedPolicies) {\n...\n 228 \n````", 'Successfully opened lib/plugins/aws/package/lib/iam-role-lambda-execution-template.json:\n\n````json\n   0 {\n ...
```
========================================================================================================================
AGENT:
<thinking>
I can see the IAM template has empty `Resource` arrays for `logs:CreateLogStream` and `logs:PutLogEvents`. The `mergeIamTemplates.js` file is collapsed, so I need to expand it to see the full implementation. Let me expand the entire file to understand how the resources are populated.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.js
line_ranges:
- - 0
  - -1

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.js:

````javascript
   0 'use strict';
   1 
   2 const _ = require('lodash');
   3 const BbPromise = require('bluebird');
   4 const path = require('path');
   5 
   6 module.exports = {
   7   mergeIamTemplates() {
   8     this.validateStatements(this.serverless.service.provider.iamRoleStatements);
   9     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);
  10     return this.m...
```
========================================================================================================================
AGENT:
<thinking>
Now I understand the issue. Looking at lines 83-127:

1. Lines 83-86: A `canonicalFunctionNamePrefix` is created from `service-stage` (e.g., `log-group-policy-dev`)
2. Lines 92-103: The code **always** adds a wildcard permission for `${logGroupsPrefix}*` (e.g., `/aws/lambda/log-group-policy-dev*`)
3. Lines 105-127: For functions with custom names that don't start with the canonical prefix, it adds specific permissions for those custom names

The problem is that lines 92-103 **unconditionally** add the wildcard permission for the default naming pattern, even when ALL functions have custom names that don't follow the default pattern.

According to the principle of least privilege, if all functions have custom names that don't follow the default pattern, the wildcard permission for the default pattern should NOT be added.

The fix should be:
1. Check if there are any functions that use the default naming pattern (i.e., functions without a custom name or with a custom name that starts with the canonical prefix)
2. Only add the wildcard permission for the default pattern if there are such functions

Let me also look at the test file to understand the expected behavior better.
</thinking>
========================================================================================================================
TOOL CALL (open_files)
file_paths:
- lib/plugins/aws/package/lib/mergeIamTemplates.test.js

========================================================================================================================
TOOL RETURN (open_files)
```
["Successfully opened lib/plugins/aws/package/lib/mergeIamTemplates.test.js:\n\n````javascript\n   0 'use strict';\n   1 \n   2 const expect = require('chai').expect;\n...\n  18     const options = {\n...\n  42       const resources =\n...\n  51       const canonicalFunctionsPrefix = `${\n...\n  88                     Action: ['logs:CreateLogStream'],\n...\n 130     const customFunctionName = 'foo-bar';\n...\n 141       const canonicalFunctionsPrefix = `${\n...\n 178                     Action: ...
```
========================================================================================================================
AGENT:
<thinking>
Let me expand the test file to see the test cases for custom function names and understand the expected behavior better.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
line_ranges:
- - 120
  - 250

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

````javascript
   0 'use strict';
   1 
   2 const expect = require('chai').expect;
...
  18     const options = {
...
  42       const resources =
...
  51       const canonicalFunctionsPrefix = `${
...
  88                     Action: ['logs:CreateLogStream'],
...
 120                 },
 121                 'lambdaRole',
 122               ],
 123             ],
 124           },
 125         },
 126 ...
```
========================================================================================================================
AGENT:
<thinking>
I can see from the test at line 129-228 that the current expected behavior includes BOTH:
1. The wildcard permission for the canonical prefix (lines 181-184 and 196-199)
2. The specific permission for the custom function name (lines 185-189 and 200-205)

This test confirms the bug - when a function has a custom name that doesn't start with the canonical prefix, the test expects both permissions to be added. But according to the principle of least privilege, if ALL functions have custom names, the wildcard permission for the canonical prefix should NOT be added.

Now I need to fix the code in `mergeIamTemplates.js`. The fix should:
1. First check if there are any functions that use the default naming pattern (no custom name, or custom name starting with the canonical prefix)
2. Only add the wildcard permission for the default pattern if there are such functions

Let me implement the fix:
</thinking>
========================================================================================================================
AGENT:
I've identified the issue. In `mergeIamTemplates.js`, lines 92-103 unconditionally add a wildcard permission for the default naming pattern (e.g., `/aws/lambda/log-group-policy-dev*`), even when ALL functions have custom names that don't follow this pattern. I need to modify the code to only add this wildcard permission if there are functions that use the default naming pattern.
========================================================================================================================
AGENT:
MODIFY CODE: Fixing the IAM policy generation

<thinking>
Now I'll modify the code to:
1. First check if there are any functions that use the default naming pattern
2. Only add the wildcard permission for the default pattern if there are such functions

The logic should be:
- A function uses the default naming pattern if:
  - It doesn't have a custom `name` property, OR
  - Its custom `name` starts with the canonical prefix (`service-stage`)

Let me implement this fix:
</thinking>
========================================================================================================================
TOOL CALL (find_and_replace_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.js
find: "    const canonicalFunctionNamePrefix = `${\n      this.provider.serverless.service.service\n\
  \    }-${this.provider.getStage()}`;\n    const logGroupsPrefix = this.provider.naming.getLogGroupName(canonicalFunctionNamePrefix);\n\
  \n    const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n\
  \      .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n\
  \      .Statement;\n\n    // Ensure general polices for functions with default name\
  \ resolution\n    policyDocumentStatements[0].Resource.push({\n      'Fn::Sub':\n\
  \        'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n     \
  \   `:log-group:${logGroupsPrefix}*:*`,\n    });\n\n    policyDocumentStatements[1].Resource.push({\n\
  \      'Fn::Sub':\n        'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n        `:log-group:${logGroupsPrefix}*:*:*`,\n    });\n\n    // Ensure policies\
  \ for functions with custom name resolution\n    this.serverless.service.getAllFunctions().forEach(functionName\
  \ => {\n      const { name: resolvedFunctionName } = this.serverless.service.getFunction(functionName);\n\
  \      if (!resolvedFunctionName || resolvedFunctionName.startsWith(canonicalFunctionNamePrefix))\
  \ {\n        return;\n      }\n\n      const customFunctionNamelogGroupsPrefix =\
  \ this.provider.naming.getLogGroupName(\n        resolvedFunctionName\n      );\n\
  \n      policyDocumentStatements[0].Resource.push({\n        'Fn::Sub':\n      \
  \    'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n         \
  \ `:log-group:${customFunctionNamelogGroupsPrefix}:*`,\n      });\n\n      policyDocumentStatements[1].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${customFunctionNamelogGroupsPrefix}:*:*`,\n      });\n\
  \    });"
replace: "    const canonicalFunctionNamePrefix = `${\n      this.provider.serverless.service.service\n\
  \    }-${this.provider.getStage()}`;\n    const logGroupsPrefix = this.provider.naming.getLogGroupName(canonicalFunctionNamePrefix);\n\
  \n    const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n\
  \      .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n\
  \      .Statement;\n\n    // Ensure general policies for functions with default\
  \ name resolution\n    // but only if there are functions that use the default naming\
  \ scheme\n    let shouldAddDefaultLogGroupPolicy = false;\n    this.serverless.service.getAllFunctions().forEach(functionName\
  \ => {\n      const { name: resolvedFunctionName } = this.serverless.service.getFunction(functionName);\n\
  \      if (!resolvedFunctionName || resolvedFunctionName.startsWith(canonicalFunctionNamePrefix))\
  \ {\n        shouldAddDefaultLogGroupPolicy = true;\n      }\n    });\n\n    if\
  \ (shouldAddDefaultLogGroupPolicy) {\n      policyDocumentStatements[0].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${logGroupsPrefix}*:*`,\n      });\n\n      policyDocumentStatements[1].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${logGroupsPrefix}*:*:*`,\n      });\n    }\n\n    //\
  \ Ensure policies for functions with custom name resolution\n    this.serverless.service.getAllFunctions().forEach(functionName\
  \ => {\n      const { name: resolvedFunctionName } = this.serverless.service.getFunction(functionName);\n\
  \      if (!resolvedFunctionName || resolvedFunctionName.startsWith(canonicalFunctionNamePrefix))\
  \ {\n        return;\n      }\n\n      const customFunctionNamelogGroupsPrefix =\
  \ this.provider.naming.getLogGroupName(\n        resolvedFunctionName\n      );\n\
  \n      policyDocumentStatements[0].Resource.push({\n        'Fn::Sub':\n      \
  \    'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n         \
  \ `:log-group:${customFunctionNamelogGroupsPrefix}:*`,\n      });\n\n      policyDocumentStatements[1].Resource.push({\n\
  \        'Fn::Sub':\n          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}'\
  \ +\n          `:log-group:${customFunctionNamelogGroupsPrefix}:*:*`,\n      });\n\
  \    });"

========================================================================================================================
TOOL RETURN (find_and_replace_code)
```
Successfully replaced code in lib/plugins/aws/package/lib/mergeIamTemplates.js:

--- lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -90,18 +90,29 @@
       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument
       .Statement;
 
-    // Ensure general polices for functions with default name resolution
-    policyDocumentStatements[0].Resource.push({
-      'Fn::Sub':
-        'arn:${AWS::Partition}:lo...
```
========================================================================================================================
AGENT:
UPDATE TESTS: Now I need to update the test file to reflect the new expected behavior

<thinking>
Now I need to update the test file. The test at line 129-228 expects both the wildcard permission and the custom function permission. But with my fix, when ALL functions have custom names that don't start with the canonical prefix, only the custom function permission should be added.

Let me update the test to reflect the correct expected behavior.
</thinking>
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
line_ranges:
- - 0
  - 130

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

````javascript
   0 'use strict';
   1 
   2 const expect = require('chai').expect;
   3 
   4 const Serverless = require('../../../../Serverless');
   5 const AwsProvider = require('../../provider/awsProvider');
   6 const AwsPackage = require('../index');
   7 
   8 describe('#mergeIamTemplates()', () => {
   9   let awsPackage;
  10   let serverless;
  11   const serviceName = 'new-service';
  12   co...
```
========================================================================================================================
AGENT:
<thinking>
Now I need to update the test at line 129-228. The test currently expects both the wildcard permission for the canonical prefix AND the custom function permission. But with my fix, when ALL functions have custom names that don't start with the canonical prefix, only the custom function permission should be added.

Let me update this test to reflect the correct expected behavior:
</thinking>
========================================================================================================================
TOOL CALL (find_and_replace_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
find: "  it('should ensure IAM policies for custom named functions', () => {\n   \
  \ const customFunctionName = 'foo-bar';\n    awsPackage.serverless.service.functions\
  \ = {\n      [functionName]: {\n        name: customFunctionName,\n        artifact:\
  \ 'test.zip',\n        handler: 'handler.hello',\n      },\n    };\n    serverless.service.setFunctionNames();\
  \ // Ensure to resolve function names\n\n    return awsPackage.mergeIamTemplates().then(()\
  \ => {\n      const canonicalFunctionsPrefix = `${\n        awsPackage.serverless.service.service\n\
  \      }-${awsPackage.provider.getStage()}`;\n\n      expect(\n        awsPackage.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n\
  \          awsPackage.provider.naming.getRoleLogicalId()\n        ]\n      ).to.deep.equal({\n\
  \        Type: 'AWS::IAM::Role',\n        Properties: {\n          AssumeRolePolicyDocument:\
  \ {\n            Version: '2012-10-17',\n            Statement: [\n            \
  \  {\n                Effect: 'Allow',\n                Principal: {\n         \
  \         Service: ['lambda.amazonaws.com'],\n                },\n             \
  \   Action: ['sts:AssumeRole'],\n              },\n            ],\n          },\n\
  \          Path: '/',\n          Policies: [\n            {\n              PolicyName:\
  \ {\n                'Fn::Join': [\n                  '-',\n                  [awsPackage.provider.getStage(),\
  \ awsPackage.serverless.service.service, 'lambda'],\n                ],\n      \
  \        },\n              PolicyDocument: {\n                Version: '2012-10-17',\n\
  \                Statement: [\n                  {\n                    Effect:\
  \ 'Allow',\n                    Action: ['logs:CreateLogStream'],\n            \
  \        Resource: [\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${canonicalFunctionsPrefix}*:*`,\n\
  \                      },\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \            {\n                    Effect: 'Allow',\n                    Action:\
  \ ['logs:PutLogEvents'],\n                    Resource: [\n                    \
  \  {\n                        'Fn::Sub':\n                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${canonicalFunctionsPrefix}*:*:*`,\n\
  \                      },\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \          ],\n              },\n            },\n          ],\n          RoleName:\
  \ {\n            'Fn::Join': [\n              '-',\n              [\n          \
  \      awsPackage.serverless.service.service,\n                awsPackage.provider.getStage(),\n\
  \                {\n                  Ref: 'AWS::Region',\n                },\n\
  \                'lambdaRole',\n              ],\n            ],\n          },\n\
  \        },\n      });\n    });\n  });"
replace: "  it('should ensure IAM policies for custom named functions', () => {\n\
  \    const customFunctionName = 'foo-bar';\n    awsPackage.serverless.service.functions\
  \ = {\n      [functionName]: {\n        name: customFunctionName,\n        artifact:\
  \ 'test.zip',\n        handler: 'handler.hello',\n      },\n    };\n    serverless.service.setFunctionNames();\
  \ // Ensure to resolve function names\n\n    return awsPackage.mergeIamTemplates().then(()\
  \ => {\n      expect(\n        awsPackage.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n\
  \          awsPackage.provider.naming.getRoleLogicalId()\n        ]\n      ).to.deep.equal({\n\
  \        Type: 'AWS::IAM::Role',\n        Properties: {\n          AssumeRolePolicyDocument:\
  \ {\n            Version: '2012-10-17',\n            Statement: [\n            \
  \  {\n                Effect: 'Allow',\n                Principal: {\n         \
  \         Service: ['lambda.amazonaws.com'],\n                },\n             \
  \   Action: ['sts:AssumeRole'],\n              },\n            ],\n          },\n\
  \          Path: '/',\n          Policies: [\n            {\n              PolicyName:\
  \ {\n                'Fn::Join': [\n                  '-',\n                  [awsPackage.provider.getStage(),\
  \ awsPackage.serverless.service.service, 'lambda'],\n                ],\n      \
  \        },\n              PolicyDocument: {\n                Version: '2012-10-17',\n\
  \                Statement: [\n                  {\n                    Effect:\
  \ 'Allow',\n                    Action: ['logs:CreateLogStream'],\n            \
  \        Resource: [\n                      {\n                        'Fn::Sub':\n\
  \                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \            {\n                    Effect: 'Allow',\n                    Action:\
  \ ['logs:PutLogEvents'],\n                    Resource: [\n                    \
  \  {\n                        'Fn::Sub':\n                          'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n                          `log-group:/aws/lambda/${customFunctionName}:*:*`,\n\
  \                      },\n                    ],\n                  },\n      \
  \          ],\n              },\n            },\n          ],\n          RoleName:\
  \ {\n            'Fn::Join': [\n              '-',\n              [\n          \
  \      awsPackage.serverless.service.service,\n                awsPackage.provider.getStage(),\n\
  \                {\n                  Ref: 'AWS::Region',\n                },\n\
  \                'lambdaRole',\n              ],\n            ],\n          },\n\
  \        },\n      });\n    });\n  });"

========================================================================================================================
TOOL RETURN (find_and_replace_code)
```
Successfully replaced code in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

--- lib/plugins/aws/package/lib/mergeIamTemplates.test.js
+++ lib/plugins/aws/package/lib/mergeIamTemplates.test.js
@@ -139,10 +139,6 @@
     serverless.service.setFunctionNames(); // Ensure to resolve function names
 
     return awsPackage.mergeIamTemplates().then(() => {
-      const canonicalFunctionsPrefix = `${
-        awsPackage.serverless.service.service
-      }-${awsPackage.provider.getStage()}`;
-
 ...
```
========================================================================================================================
AGENT:
RUN TESTS: Now let me run the tests to verify the changes work correctly

<thinking>
Let me run the tests for the mergeIamTemplates module to verify the changes work correctly.
</thinking>
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm install 2>&1 | tail -20
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

added 903 packages, and audited 904 packages in 41s

117 packages are looking for funding
  run `npm fund` for details

36 vulnerabilities (7 low, 10 moderate, 12 high, 7 critical)

To address all issues possible (including breaking changes), run:
  npm audit fix --force

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
npm notice
npm notice New major version of npm available! 10.9.3 -> 11.7.0
npm notice Changelog: https://github.com/npm/cl...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "mergeIamTemplates" 2>&1 | tail -100
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep mergeIamTemplates



  #mergeIamTemplates()
(node:614) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    ✓ should not merge if there are no functions
    ✓ shoul...
```
========================================================================================================================
AGENT:
All tests pass. Now let me also add a test case for the scenario where there's a mix of functions - some with default names and some with custom names - to ensure the wildcard permission is added in that case.
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
line_ranges:
- - 200
  - 250

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

````javascript
   0 'use strict';
   1 
   2 const expect = require('chai').expect;
   3 
   4 const Serverless = require('../../../../Serverless');
   5 const AwsProvider = require('../../provider/awsProvider');
   6 const AwsPackage = require('../index');
   7 
   8 describe('#mergeIamTemplates()', () => {
   9   let awsPackage;
  10   let serverless;
  11   const serviceName = 'new-service';
  12   co...
```
========================================================================================================================
AGENT:
<thinking>
Let me add a new test case for the scenario where there's a mix of functions - some with default names and some with custom names. This will ensure the wildcard permission is added in that case. I'll add it right after the existing test for custom named functions.
</thinking>
========================================================================================================================
TOOL CALL (find_and_replace_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
find: "  it('should add custom IAM policy statements', () => {\n    awsPackage.serverless.service.provider.iamRoleStatements\
  \ = [\n      {\n        Effect: 'Allow',\n        Action: ['something:SomethingElse'],\n\
  \        Resource: 'some:aws:arn:xxx:*:*',\n      },\n    ];\n\n    return awsPackage.mergeIamTemplates().then(()\
  \ => {\n      expect(\n        awsPackage.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n\
  \          awsPackage.provider.naming.getRoleLogicalId()\n        ].Properties.Policies[0].PolicyDocument.Statement[2]\n\
  \      ).to.deep.equal(awsPackage.serverless.service.provider.iamRoleStatements[0]);\n\
  \    });\n  });"
replace: "  it('should ensure IAM policies for functions with custom names and default\
  \ names', () => {\n    const customFunctionName = 'foo-bar';\n    awsPackage.serverless.service.functions\
  \ = {\n      [functionName]: {\n        artifact: 'test.zip',\n        handler:\
  \ 'handler.hello',\n      },\n      customFunc: {\n        name: customFunctionName,\n\
  \        artifact: 'test.zip',\n        handler: 'handler.hello',\n      },\n  \
  \  };\n    serverless.service.setFunctionNames(); // Ensure to resolve function\
  \ names\n\n    return awsPackage.mergeIamTemplates().then(() => {\n      const canonicalFunctionsPrefix\
  \ = `${\n        awsPackage.serverless.service.service\n      }-${awsPackage.provider.getStage()}`;\n\
  \n      const statements =\n        awsPackage.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n\
  \          awsPackage.provider.naming.getRoleLogicalId()\n        ].Properties.Policies[0].PolicyDocument.Statement;\n\
  \n      expect(statements[0].Resource).to.deep.equal([\n        {\n          'Fn::Sub':\n\
  \            'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:' +\n\
  \            `log-group:/aws/lambda/${canonicalFunctionsPrefix}*:*`,\n        },\n\
  \        {\n          'Fn::Sub':\n            'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n            `log-group:/aws/lambda/${customFunctionName}:*`,\n        },\n\
  \      ]);\n\n      expect(statements[1].Resource).to.deep.equal([\n        {\n\
  \          'Fn::Sub':\n            'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n            `log-group:/aws/lambda/${canonicalFunctionsPrefix}*:*:*`,\n   \
  \     },\n        {\n          'Fn::Sub':\n            'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:'\
  \ +\n            `log-group:/aws/lambda/${customFunctionName}:*:*`,\n        },\n\
  \      ]);\n    });\n  });\n\n  it('should add custom IAM policy statements', ()\
  \ => {\n    awsPackage.serverless.service.provider.iamRoleStatements = [\n     \
  \ {\n        Effect: 'Allow',\n        Action: ['something:SomethingElse'],\n  \
  \      Resource: 'some:aws:arn:xxx:*:*',\n      },\n    ];\n\n    return awsPackage.mergeIamTemplates().then(()\
  \ => {\n      expect(\n        awsPackage.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n\
  \          awsPackage.provider.naming.getRoleLogicalId()\n        ].Properties.Policies[0].PolicyDocument.Statement[2]\n\
  \      ).to.deep.equal(awsPackage.serverless.service.provider.iamRoleStatements[0]);\n\
  \    });\n  });"

========================================================================================================================
TOOL RETURN (find_and_replace_code)
```
Successfully replaced code in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

--- lib/plugins/aws/package/lib/mergeIamTemplates.test.js
+++ lib/plugins/aws/package/lib/mergeIamTemplates.test.js
@@ -214,6 +214,59 @@
     });
   });
 
+  it('should ensure IAM policies for functions with custom names and default names', () => {
+    const customFunctionName = 'foo-bar';
+    awsPackage.serverless.service.functions = {
+      [functionName]: {
+        artifact: 'test.zip',
+        handler:...
```
========================================================================================================================
AGENT:
Now let me run the tests again to make sure all tests pass:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "mergeIamTemplates" 2>&1 | tail -50
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep mergeIamTemplates



  #mergeIamTemplates()
(node:895) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    ✓ should not merge if there are no functions
    ✓ shoul...
```
========================================================================================================================
AGENT:
All 24 tests pass. Now let me create a minimal reproduction script to verify the fix works as expected for the scenario described in the problem statement:
========================================================================================================================
TOOL CALL (bash)
command: "mkdir -p /tmp/test-log-group-policy && cd /tmp/test-log-group-policy &&\
  \ cat > serverless.yml << 'EOF'\nservice: log-group-policy\n\nprovider:\n  name:\
  \ aws\n  runtime: nodejs8.10\n\nfunctions:\n  testFunction:\n    name: ${self:service}-custom-named-fn\n\
  \    handler: index.handler\nEOF\ncat > index.js << 'EOF'\nmodule.exports.handler\
  \ = async (event) => {\n  return { statusCode: 200, body: 'Hello' };\n};\nEOF\n"

========================================================================================================================
TOOL RETURN (bash)
```
...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /tmp/test-log-group-policy && /workspace/bin/serverless package 2>&1
timeout: 60

========================================================================================================================
TOOL RETURN (bash)
```
(node:1427) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
Serverless: Packaging service...
Serverless: Excluding development dependencies......
```
========================================================================================================================
TOOL CALL (bash)
command: "cd /tmp/test-log-group-policy && cat .serverless/cloudformation-template-update-stack.json\
  \ | python3 -c \"\nimport json\nimport sys\n\ndata = json.load(sys.stdin)\nrole\
  \ = data['Resources']['IamRoleLambdaExecution']\npolicies = role['Properties']['Policies'][0]['PolicyDocument']['Statement']\n\
  \nprint('=== logs:CreateLogStream Resources ===')\nfor r in policies[0]['Resource']:\n\
  \    print(json.dumps(r, indent=2))\n\nprint()\nprint('=== logs:PutLogEvents Resources\
  \ ===')\nfor r in policies[1]['Resource']:\n    print(json.dumps(r, indent=2))\n\
  \""

========================================================================================================================
TOOL RETURN (bash)
```
=== logs:CreateLogStream Resources ===
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*"
}

=== logs:PutLogEvents Resources ===
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/log-group-policy-custom-named-fn:*:*"
}...
```
========================================================================================================================
AGENT:
The fix works correctly. Now the IAM policy only includes the specific permission for the custom-named function (`log-group-policy-custom-named-fn`) and does NOT include the wildcard permission for the default naming pattern (`log-group-policy-dev*`).

Let me also test the scenario where there's a mix of functions (one with default name and one with custom name):
========================================================================================================================
TOOL CALL (bash)
command: "mkdir -p /tmp/test-mixed-functions && cd /tmp/test-mixed-functions && cat\
  \ > serverless.yml << 'EOF'\nservice: mixed-service\n\nprovider:\n  name: aws\n\
  \  runtime: nodejs8.10\n\nfunctions:\n  defaultNamedFunction:\n    handler: index.handler\n\
  \  customNamedFunction:\n    name: my-custom-function\n    handler: index.handler\n\
  EOF\ncat > index.js << 'EOF'\nmodule.exports.handler = async (event) => {\n  return\
  \ { statusCode: 200, body: 'Hello' };\n};\nEOF\n"

========================================================================================================================
TOOL RETURN (bash)
```
...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /tmp/test-mixed-functions && /workspace/bin/serverless package 2>&1
timeout: 60

========================================================================================================================
TOOL RETURN (bash)
```
(node:2255) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
Serverless: Packaging service...
Serverless: Excluding development dependencies......
```
========================================================================================================================
TOOL CALL (bash)
command: "cd /tmp/test-mixed-functions && cat .serverless/cloudformation-template-update-stack.json\
  \ | python3 -c \"\nimport json\nimport sys\n\ndata = json.load(sys.stdin)\nrole\
  \ = data['Resources']['IamRoleLambdaExecution']\npolicies = role['Properties']['Policies'][0]['PolicyDocument']['Statement']\n\
  \nprint('=== logs:CreateLogStream Resources ===')\nfor r in policies[0]['Resource']:\n\
  \    print(json.dumps(r, indent=2))\n\nprint()\nprint('=== logs:PutLogEvents Resources\
  \ ===')\nfor r in policies[1]['Resource']:\n    print(json.dumps(r, indent=2))\n\
  \""

========================================================================================================================
TOOL RETURN (bash)
```
=== logs:CreateLogStream Resources ===
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/mixed-service-dev*:*"
}
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/my-custom-function:*"
}

=== logs:PutLogEvents Resources ===
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/mixed-service-dev*:*:*"
}
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region...
```
========================================================================================================================
AGENT:
Excellent! The mixed scenario also works correctly:
- The wildcard permission for the default naming pattern (`mixed-service-dev*`) is included because there's a function with the default name
- The specific permission for the custom-named function (`my-custom-function`) is also included

Let me also verify the scenario where all functions have default names:
========================================================================================================================
TOOL CALL (bash)
command: "mkdir -p /tmp/test-default-functions && cd /tmp/test-default-functions &&\
  \ cat > serverless.yml << 'EOF'\nservice: default-service\n\nprovider:\n  name:\
  \ aws\n  runtime: nodejs8.10\n\nfunctions:\n  function1:\n    handler: index.handler\n\
  \  function2:\n    handler: index.handler\nEOF\ncat > index.js << 'EOF'\nmodule.exports.handler\
  \ = async (event) => {\n  return { statusCode: 200, body: 'Hello' };\n};\nEOF\n"

========================================================================================================================
TOOL RETURN (bash)
```
...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /tmp/test-default-functions && /workspace/bin/serverless package 2>&1
timeout: 60

========================================================================================================================
TOOL RETURN (bash)
```
(node:3083) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
Serverless: Packaging service...
Serverless: Excluding development dependencies......
```
========================================================================================================================
TOOL CALL (bash)
command: "cd /tmp/test-default-functions && cat .serverless/cloudformation-template-update-stack.json\
  \ | python3 -c \"\nimport json\nimport sys\n\ndata = json.load(sys.stdin)\nrole\
  \ = data['Resources']['IamRoleLambdaExecution']\npolicies = role['Properties']['Policies'][0]['PolicyDocument']['Statement']\n\
  \nprint('=== logs:CreateLogStream Resources ===')\nfor r in policies[0]['Resource']:\n\
  \    print(json.dumps(r, indent=2))\n\nprint()\nprint('=== logs:PutLogEvents Resources\
  \ ===')\nfor r in policies[1]['Resource']:\n    print(json.dumps(r, indent=2))\n\
  \""

========================================================================================================================
TOOL RETURN (bash)
```
=== logs:CreateLogStream Resources ===
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/default-service-dev*:*"
}

=== logs:PutLogEvents Resources ===
{
  "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/default-service-dev*:*:*"
}...
```
========================================================================================================================
AGENT:
All three scenarios work correctly:

1. **All functions with custom names** (the bug scenario): Only the specific permissions for custom-named functions are added, no wildcard permission for the default naming pattern.

2. **Mixed functions** (some with default names, some with custom names): Both the wildcard permission for the default naming pattern AND the specific permissions for custom-named functions are added.

3. **All functions with default names**: Only the wildcard permission for the default naming pattern is added.

Let me also run a broader set of tests to make sure I haven't broken anything else:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "package" 2>&1 | tail -100
timeout: 300

========================================================================================================================
TOOL RETURN (bash)
```
      ✓ should run "package:finalize" hook
      ✓ should run "aws:package:finalize:mergeCustomProviderResources" hook
      ✓ should run "aws:package:finalize:saveServiceState" hook

  Deploy
    "before:deploy:deploy" hook
      ✓ should resolve if the package option is set
      ✓ should resolve if the service package path is set

  #packageService()
    #getIncludes()
      ✓ should return an empty array if no includes are provided
      ✓ should merge package includes
      ✓ should merge p...
```
========================================================================================================================
AGENT:
All tests pass. Let me also verify the modified code one more time:
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.js
line_ranges:
- - 80
  - 145

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.js:

````javascript
   0 'use strict';
   1 
   2 const _ = require('lodash');
   3 const BbPromise = require('bluebird');
   4 const path = require('path');
   5 
   6 module.exports = {
   7   mergeIamTemplates() {
   8     this.validateStatements(this.serverless.service.provider.iamRoleStatements);
   9     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);
  10     return this.m...
```
========================================================================================================================
AGENT:
The code looks correct. Let me also run a broader test to ensure I haven't broken anything else in the codebase:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "IAM" 2>&1 | tail -50
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```
      ✓ should create a IAM Role resource

  #validate()
    ✓ should accept AWS_IAM as authorizer

  AwsCompileSQSEvents
    #compileSQSEvents()
      ✓ should not throw error if custom IAM role is set in function
      ✓ should not throw error if custom IAM role name reference is set in function
      ✓ should not throw error if custom IAM role reference is set in function
      ✓ should not throw error if custom IAM role is set in provider
      ✓ should not throw error if IAM role is importe...
```
========================================================================================================================
AGENT:
All IAM-related tests pass. Let me now verify the changes one more time by reviewing the test file:
========================================================================================================================
TOOL CALL (inspect_code)
file_path: lib/plugins/aws/package/lib/mergeIamTemplates.test.js
line_ranges:
- - 129
  - 275

========================================================================================================================
TOOL RETURN (inspect_code)
```
Successfully expanded code chunks in lib/plugins/aws/package/lib/mergeIamTemplates.test.js:

````javascript
   0 'use strict';
   1 
   2 const expect = require('chai').expect;
   3 
   4 const Serverless = require('../../../../Serverless');
   5 const AwsProvider = require('../../provider/awsProvider');
   6 const AwsPackage = require('../index');
   7 
   8 describe('#mergeIamTemplates()', () => {
   9   let awsPackage;
  10   let serverless;
  11   const serviceName = 'new-service';
  12   co...
```
========================================================================================================================
AGENT:
The changes look correct. Let me run the full test suite for the mergeIamTemplates module one more time to confirm everything is working:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "mergeIamTemplates" 2>&1
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep mergeIamTemplates



  #mergeIamTemplates()
(node:4229) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    ✓ should not merge if there are no functions
    ✓ shou...
```
========================================================================================================================
AGENT:
All 24 tests pass. Let me also clean up the temporary test directories:
========================================================================================================================
TOOL CALL (bash)
command: rm -rf /tmp/test-log-group-policy /tmp/test-mixed-functions /tmp/test-default-functions

========================================================================================================================
TOOL RETURN (bash)
```
...
```
========================================================================================================================
AGENT:
I have made the necessary changes to fix the issue. Let me verify the changes one more time by reviewing the modified files and running a final test.
========================================================================================================================
AGENT:
REVIEW CHANGES: Final verification of the fix

<thinking>
Let me summarize the changes I made:

1. **Modified `lib/plugins/aws/package/lib/mergeIamTemplates.js`**:
   - Added a check to determine if any functions use the default naming scheme (no custom name, or custom name starting with the canonical prefix)
   - Only add the wildcard permission for the default naming pattern if there are functions that use the default naming scheme
   - This ensures that when ALL functions have custom names that don't follow the default pattern, the wildcard permission is not added

2. **Modified `lib/plugins/aws/package/lib/mergeIamTemplates.test.js`**:
   - Updated the test "should ensure IAM policies for custom named functions" to expect only the custom function permission (not the wildcard permission)
   - Added a new test "should ensure IAM policies for functions with custom names and default names" to verify that when there's a mix of functions, both permissions are added

Let me run a broader test to ensure nothing else is broken:
</thinking>
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "AwsPackage" 2>&1 | tail -100
timeout: 300

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep AwsPackage



  AwsPackage
    #constructor()
      ✓ should set the serverless instance
      ✓ should set options
      ✓ should set the service path if provided
      ✓ should default to an empty service path if not provided
      ✓ should use the options package path if provided
      ✓ should use the services package path if provided
      ✓ should default to the .serverless directory as the package path
      ✓ should ...
```
========================================================================================================================
AGENT:
All tests pass. Let me also verify the changes by looking at the diff of the modified files:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && git diff lib/plugins/aws/package/lib/mergeIamTemplates.js

========================================================================================================================
TOOL RETURN (bash)
```
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js
index 945312b69..fb467d443 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -90,18 +90,29 @@ module.exports = {
       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument
       .Statement;
 
-    // Ensure general polices for functions with default name resolution
-    policyD...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && git diff lib/plugins/aws/package/lib/mergeIamTemplates.test.js

========================================================================================================================
TOOL RETURN (bash)
```
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.test.js b/lib/plugins/aws/package/lib/mergeIamTemplates.test.js
index 09447f641..fe7fd51a7 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.test.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.test.js
@@ -139,10 +139,6 @@ describe('#mergeIamTemplates()', () => {
     serverless.service.setFunctionNames(); // Ensure to resolve function names
 
     return awsPackage.mergeIamTemplates().then(() => {
-      const canonicalF...
```
========================================================================================================================
AGENT:
The changes look correct. Let me run one final comprehensive test to make sure everything is working:
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "mergeIamTemplates\|AwsPackage" 2>&1
  | tail -60
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```

> serverless@1.49.0 test
> mocha "!(node_modules)/**/*.test.js" --grep mergeIamTemplates\|AwsPackage



  0 passing (2ms)

(node:5581) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)...
```
========================================================================================================================
TOOL CALL (bash)
command: cd /workspace && npm test -- --grep "mergeIamTemplates" 2>&1 | tail -40
timeout: 120

========================================================================================================================
TOOL RETURN (bash)
```
> mocha "!(node_modules)/**/*.test.js" --grep mergeIamTemplates



  #mergeIamTemplates()
(node:5862) NOTE: The AWS SDK for JavaScript (v2) has reached end-of-support.
It will no longer receive updates or releases.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    ✓ should not merge if there are no functions
    ✓ should merge the IamRoleLambda...
```
========================================================================================================================
AGENT:
All 24 tests pass. Let me now mark the task as complete.
========================================================================================================================
AGENT:
Successfully fixed the issue with wider `logs:CreateLogStream`/`logs:PutLogEvents` permissions in IAM policy for Lambda functions with manual names.

## Summary of Changes

### Problem
When a service contains only custom-named functions (functions with explicit `name` property that doesn't follow the default `service-stage-functionName` pattern), the IAM policies for `logs:CreateLogStream` and `logs:PutLogEvents` were incorrectly including a wildcard permission for the default naming pattern (e.g., `/aws/lambda/log-group-policy-dev*`) in addition to the specific permissions for the custom-named functions. This violated the principle of least privilege.

### Solution
Modified `lib/plugins/aws/package/lib/mergeIamTemplates.js` to:
1. First check if any functions use the default naming scheme (no custom name, or custom name starting with the canonical prefix `service-stage`)
2. Only add the wildcard permission for the default naming pattern if there are functions that use the default naming scheme

### Files Modified
1. **`lib/plugins/aws/package/lib/mergeIamTemplates.js`**: Added conditional logic to only add the default log group policy when there are functions using the default naming scheme.

2. **`lib/plugins/aws/package/lib/mergeIamTemplates.test.js`**: 
   - Updated the test "should ensure IAM policies for custom named functions" to expect only the custom function permission (not the wildcard permission)
   - Added a new test "should ensure IAM policies for functions with custom names and default names" to verify that when there's a mix of functions, both permissions are added

### Verification
- All 24 tests in the mergeIamTemplates test suite pass
- Manual testing confirmed:
  - When all functions have custom names: Only specific permissions for custom-named functions are added
  - When there's a mix of functions: Both wildcard and specific permissions are added
  - When all functions have default names: Only wildcard permission is added
2025-11-13 20:55:45,201 - thread-135845298308800.prometheus.docker.base_container - INFO - Created temporary project directory: /tmp/tmpenbeop3a/serverless
2025-11-13 20:55:45,201 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Using workdir: /testbed
2025-11-13 20:55:45,575 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_build: False
2025-11-13 20:55:45,575 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-13 20:55:45,575 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-13 20:55:45,575 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_reproduce_test: True
2025-11-13 20:55:45,575 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 5
2025-11-13 20:55:45,575 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - Enter IssueClassificationSubgraphNode
2025-11-13 20:55:45,576 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classification_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

2025-11-13 20:55:45,576 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 20:55:45,577 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:56:04,597 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The issue concerns IAM role statements in the AWS provider. To classify it accurately, we need to confirm whether the current code intentionally rejects NotAction/NotResource or lacks support. The provided file tree does not include the actual implementations for IAM policy generation and validation. Documentation about iamRoleStatements may clarify intended support. Tests may show current behavior. Therefore, additional context is essential.' query='Please provide the full implementations that process provider.iamRoleStatements (validation and IAM policy generation), including lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, any IAM-related files under lib/plugins/aws/package/compile, and docs/providers/aws/guide/iam.md, with line numbers.' extra_requirements="If exact files differ, please share grep results for 'iamRoleStatements', 'NotAction', and 'NotResource' with matching file paths and surrounding code." purpose='To verify current behavior and intent regarding NotAction/NotResource so we can classify the issue correctly.'
2025-11-13 20:56:04,599 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full implementations that process provider.iamRoleStatements (validation and IAM policy generation), including lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, any IAM-related files under lib/plugins/aws/package/compile, and docs/providers/aws/guide/iam.md, with line numbers.
2025-11-13 20:56:04,906 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 20:56:04,906 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 20:56:04,906 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 20:56:04,906 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 20:56:04,907 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 20:56:04,908 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 20:56:04,908 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full implementations that process provider.iamRoleStatements (validation and IAM policy generation), including lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, any IAM-related files under lib/plugins/aws/package/compile, and docs/providers/aws/guide/iam.md, with line numbers.
Extra requirements: If exact files differ, please share grep results for 'iamRoleStatements', 'NotAction', and 'NotResource' with matching file paths and surrounding code.
Purpose: To verify current behavior and intent regarding NotAction/NotResource so we can classify the issue correctly.
2025-11-13 20:56:17,705 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VpWmqHzLye89cG75ieT9z3lI', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/validate.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1379, 'prompt_tokens': 2292, 'total_tokens': 3671, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1344, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--72c8c601-5e95-4e70-a022-f8ab9be11c3f-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/lib/validate.js'}, 'id': 'call_VpWmqHzLye89cG75ieT9z3lI', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2292, 'output_tokens': 1379, 'total_tokens': 3671, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1344}}
2025-11-13 20:56:18,661 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pSLxPUPeY0dqTlDBKvUj8s9K', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/validate.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 2370, 'total_tokens': 2400, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e4454cfc-a8d6-4b83-b56f-78f916ae9771-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/validate.js'}, 'id': 'call_pSLxPUPeY0dqTlDBKvUj8s9K', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2370, 'output_tokens': 30, 'total_tokens': 2400, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:56:20,513 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ohLHXCCqS9MqUGx7IHl2rsVx', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 99, 'prompt_tokens': 3147, 'total_tokens': 3246, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2304}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--841c676d-e202-42b2-a5ad-fae4f73aa9bf-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js'}, 'id': 'call_ohLHXCCqS9MqUGx7IHl2rsVx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3147, 'output_tokens': 99, 'total_tokens': 3246, 'input_token_details': {'audio': 0, 'cache_read': 2304}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:56:21,927 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_aAGVuEeSqR4WtQ33GyaT5uF5', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 3226, 'total_tokens': 3256, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--001cbe88-a875-40d9-ad48-a1930de85b83-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js'}, 'id': 'call_aAGVuEeSqR4WtQ33GyaT5uF5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3226, 'output_tokens': 30, 'total_tokens': 3256, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:56:24,533 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ZZebggeDHRTfF6Q9qqEvEx0G', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js","start_line":500,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 8845, 'total_tokens': 8884, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ef37044c-f434-444b-99fe-13a511bd3bd0-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js', 'start_line': 500, 'end_line': 1000}, 'id': 'call_ZZebggeDHRTfF6Q9qqEvEx0G', 'type': 'tool_call'}] usage_metadata={'input_tokens': 8845, 'output_tokens': 39, 'total_tokens': 8884, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:56:34,043 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_sS05ttC8W6Qwfqcpn7dKybHM', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 484, 'prompt_tokens': 10222, 'total_tokens': 10706, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f9db8c3e-ccfd-4945-b09d-699ffd25b091-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_sS05ttC8W6Qwfqcpn7dKybHM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10222, 'output_tokens': 484, 'total_tokens': 10706, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:56:36,383 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3kGr6wAEdjRFka12zbrxXqeL', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 10302, 'total_tokens': 10333, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d2743cac-5e1d-4661-81c8-d10c733ccc9b-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_3kGr6wAEdjRFka12zbrxXqeL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10302, 'output_tokens': 31, 'total_tokens': 10333, 'input_token_details': {'audio': 0, 'cache_read': 3200}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:56:41,465 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7Wu2vXeIWJkDna1p5rc78c3b', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/roles/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 486, 'prompt_tokens': 14105, 'total_tokens': 14591, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3072}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0d75a1a3-92f2-43db-a8af-468cc2528966-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/roles/index.js'}, 'id': 'call_7Wu2vXeIWJkDna1p5rc78c3b', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14105, 'output_tokens': 486, 'total_tokens': 14591, 'input_token_details': {'audio': 0, 'cache_read': 3072}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:56:46,771 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_GeUzxKhbERBMu7IM5zgBLxZ1', 'function': {'arguments': '{"basename":"compile"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 412, 'prompt_tokens': 14163, 'total_tokens': 14575, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1bccc8da-36e0-41f3-bf79-e223c9cdc0af-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'compile'}, 'id': 'call_GeUzxKhbERBMu7IM5zgBLxZ1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14163, 'output_tokens': 412, 'total_tokens': 14575, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 20:56:48,204 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ebtDU42hLU1KOt2gAdUDl85x', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 14232, 'total_tokens': 14260, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--62ed89ed-4f83-4461-b822-c07bb42f8db5-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile'}, 'id': 'call_ebtDU42hLU1KOt2gAdUDl85x', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14232, 'output_tokens': 28, 'total_tokens': 14260, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:56:49,716 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_mlGDnFxHPruIs2ssfpWNr2X4', 'function': {'arguments': '{"basename":"iam"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 14307, 'total_tokens': 14329, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d1ee0eef-d575-4938-8ad8-03ed07cbca39-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam'}, 'id': 'call_mlGDnFxHPruIs2ssfpWNr2X4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14307, 'output_tokens': 22, 'total_tokens': 14329, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:56:54,804 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CSmU3vr9ofG1AfVNHaHyCg7l', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/roles.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 421, 'prompt_tokens': 14355, 'total_tokens': 14776, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14208}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6a374c59-d091-48c1-b94a-509a20a11d98-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/roles.js'}, 'id': 'call_CSmU3vr9ofG1AfVNHaHyCg7l', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14355, 'output_tokens': 421, 'total_tokens': 14776, 'input_token_details': {'audio': 0, 'cache_read': 14208}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 20:57:00,012 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_2Fsn4F3P4TbiPGt6rrZ8bQAw', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 292, 'prompt_tokens': 14412, 'total_tokens': 14704, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14208}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7c9f6d0b-de08-41ed-8a03-452db43b7c86-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/index.js'}, 'id': 'call_2Fsn4F3P4TbiPGt6rrZ8bQAw', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14412, 'output_tokens': 292, 'total_tokens': 14704, 'input_token_details': {'audio': 0, 'cache_read': 14208}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:57:05,171 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JSqUn4q6JCCC0stHP16UwxaG', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/roles/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 295, 'prompt_tokens': 14468, 'total_tokens': 14763, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 8832}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c8e949c2-5b84-4223-a19a-ee7319b1d1e6-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/roles/index.js'}, 'id': 'call_JSqUn4q6JCCC0stHP16UwxaG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14468, 'output_tokens': 295, 'total_tokens': 14763, 'input_token_details': {'audio': 0, 'cache_read': 8832}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:57:11,998 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_n2jcroMN14Bq5VoPhmOioL3O', 'function': {'arguments': '{"basename":"roles.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 605, 'prompt_tokens': 14527, 'total_tokens': 15132, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14336}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--94daf4fc-908a-4c88-ab9a-e68f1d2190d6-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'roles.js'}, 'id': 'call_n2jcroMN14Bq5VoPhmOioL3O', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14527, 'output_tokens': 605, 'total_tokens': 15132, 'input_token_details': {'audio': 0, 'cache_read': 14336}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 20:57:21,079 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_KY6ubnhzpu0vUNmkd8NG9Bep', 'function': {'arguments': '{"basename":"index.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 605, 'prompt_tokens': 14576, 'total_tokens': 15181, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--785fdec8-941d-4a28-9bf9-524a81d32f66-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'index.js'}, 'id': 'call_KY6ubnhzpu0vUNmkd8NG9Bep', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14576, 'output_tokens': 605, 'total_tokens': 15181, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 20:57:30,455 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_C0zHZ4OULrRzTAkjMi3bbgWJ', 'function': {'arguments': '{"text":"NotAction"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 732, 'prompt_tokens': 14786, 'total_tokens': 15518, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fccc21a0-6fb5-422a-b471-0a9119912d55-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'NotAction'}, 'id': 'call_C0zHZ4OULrRzTAkjMi3bbgWJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14786, 'output_tokens': 732, 'total_tokens': 15518, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 20:57:31,821 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_a4iGOBGVjVN4Bzomqch9RaOr', 'function': {'arguments': '{"text":"iamRoleStatements"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 23, 'prompt_tokens': 14833, 'total_tokens': 14856, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14080}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fc843af5-f158-44cd-8215-de4f79267c9d-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'iamRoleStatements'}, 'id': 'call_a4iGOBGVjVN4Bzomqch9RaOr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14833, 'output_tokens': 23, 'total_tokens': 14856, 'input_token_details': {'audio': 0, 'cache_read': 14080}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:57:36,645 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_s3t9SpUcTSvJAQbna3YSWb1s', 'function': {'arguments': '{"basename":"iam.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 349, 'prompt_tokens': 19784, 'total_tokens': 20133, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14464}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7eb02302-7948-439f-8eae-9ea17f9304ec-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam.js'}, 'id': 'call_s3t9SpUcTSvJAQbna3YSWb1s', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19784, 'output_tokens': 349, 'total_tokens': 20133, 'input_token_details': {'audio': 0, 'cache_read': 14464}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:57:47,028 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_R2rbUdt1dvfPDC5Zcr6L7UQ7', 'function': {'arguments': '{"basename":"iamRole.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 990, 'prompt_tokens': 19833, 'total_tokens': 20823, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b4915906-65db-47cc-9d5d-f4d9e2ee262e-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iamRole.js'}, 'id': 'call_R2rbUdt1dvfPDC5Zcr6L7UQ7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19833, 'output_tokens': 990, 'total_tokens': 20823, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 20:57:54,157 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PlR7SaWdHAFB0Ga0ZDCRr05g', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/iam/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 743, 'prompt_tokens': 19883, 'total_tokens': 20626, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2d536c7e-b62e-44a8-804f-5bb14a729231-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/iam/index.js'}, 'id': 'call_PlR7SaWdHAFB0Ga0ZDCRr05g', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19883, 'output_tokens': 743, 'total_tokens': 20626, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 20:58:05,732 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_cfVTmxBAh6Bu0yGPQGf9T429', 'function': {'arguments': '{"text":"iamRoleStatements","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 935, 'prompt_tokens': 19942, 'total_tokens': 20877, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14720}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3152348e-a88a-4b11-ba1a-6f3af284d3cf-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'iamRoleStatements', 'basename': 'index.js'}, 'id': 'call_cfVTmxBAh6Bu0yGPQGf9T429', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19942, 'output_tokens': 935, 'total_tokens': 20877, 'input_token_details': {'audio': 0, 'cache_read': 14720}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 20:58:17,436 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0saG5gz8ioTAiuxu1LjusjCM', 'function': {'arguments': '{"text":"AWS::IAM::Role","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 937, 'prompt_tokens': 29621, 'total_tokens': 30558, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19840}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--16457d04-fc7c-4898-abf2-40070a9366d5-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'AWS::IAM::Role', 'basename': 'index.js'}, 'id': 'call_0saG5gz8ioTAiuxu1LjusjCM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29621, 'output_tokens': 937, 'total_tokens': 30558, 'input_token_details': {'audio': 0, 'cache_read': 19840}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 20:58:28,494 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_szAvHuD77rtsRtlOnBc2qwd4', 'function': {'arguments': '{"text":"AWS::IAM::Policy","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 745, 'prompt_tokens': 33767, 'total_tokens': 34512, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f78062ba-aa9c-401a-af31-db31d2f6ad23-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'AWS::IAM::Policy', 'basename': 'index.js'}, 'id': 'call_szAvHuD77rtsRtlOnBc2qwd4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33767, 'output_tokens': 745, 'total_tokens': 34512, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 20:58:36,894 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gL1KNIkwb71M5GRrKRP3UTCl', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/functions/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 677, 'prompt_tokens': 33832, 'total_tokens': 34509, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14080}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6fc4e573-7587-41e6-84e6-1e54a5f67fa9-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/functions/index.js'}, 'id': 'call_gL1KNIkwb71M5GRrKRP3UTCl', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33832, 'output_tokens': 677, 'total_tokens': 34509, 'input_token_details': {'audio': 0, 'cache_read': 14080}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:58:38,807 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xFyhy4CulHetKIfdxkqsw4Xj', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/functions/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 33914, 'total_tokens': 33946, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14848}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--74d51b76-6053-45a4-a4f9-a6ff547352ea-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/functions/index.js'}, 'id': 'call_xFyhy4CulHetKIfdxkqsw4Xj', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33914, 'output_tokens': 32, 'total_tokens': 33946, 'input_token_details': {'audio': 0, 'cache_read': 14848}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:58:40,669 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_AxemkEaDM80sTu36846KCoE1', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/functions/index.js","start_line":500,"end_line":1050}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 39619, 'total_tokens': 39660, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 33664}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--caba193d-7141-43ab-848b-a6b5376616d3-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/functions/index.js', 'start_line': 500, 'end_line': 1050}, 'id': 'call_AxemkEaDM80sTu36846KCoE1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 39619, 'output_tokens': 41, 'total_tokens': 39660, 'input_token_details': {'audio': 0, 'cache_read': 33664}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:58:46,075 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Uh8Dj7kX9z1S0ySmRf59wFLh', 'function': {'arguments': '{"text":"IamRoleLambdaExecution","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 360, 'prompt_tokens': 40514, 'total_tokens': 40874, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b5d5e8d5-e85e-474d-b9e0-0f127e9e0454-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'IamRoleLambdaExecution', 'basename': 'index.js'}, 'id': 'call_Uh8Dj7kX9z1S0ySmRf59wFLh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 40514, 'output_tokens': 360, 'total_tokens': 40874, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:59:00,016 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_MivG37g44ShP7N6hYHqLO0r2', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/iam/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 805, 'prompt_tokens': 52508, 'total_tokens': 53313, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f502f779-35fa-4660-9d46-89a4c4e7d1d1-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib/iam/index.js'}, 'id': 'call_MivG37g44ShP7N6hYHqLO0r2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 52508, 'output_tokens': 805, 'total_tokens': 53313, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 20:59:02,723 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_uu0bwerRwWPgpT5QGqmLJq5t', 'function': {'arguments': '{"basename":"policy.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 23, 'prompt_tokens': 52565, 'total_tokens': 52588, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14464}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--546b76ce-4e22-455e-a5be-64ee01a21ba4-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'policy.js'}, 'id': 'call_uu0bwerRwWPgpT5QGqmLJq5t', 'type': 'tool_call'}] usage_metadata={'input_tokens': 52565, 'output_tokens': 23, 'total_tokens': 52588, 'input_token_details': {'audio': 0, 'cache_read': 14464}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:59:14,831 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Hl17uMnDueq2YvNPgG3xHrLr', 'function': {'arguments': '{"text":"logs:CreateLogGroup","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 745, 'prompt_tokens': 52614, 'total_tokens': 53359, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fe28643c-1bb6-46bc-8243-1b3a50e568a4-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'logs:CreateLogGroup', 'basename': 'index.js'}, 'id': 'call_Hl17uMnDueq2YvNPgG3xHrLr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 52614, 'output_tokens': 745, 'total_tokens': 53359, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 20:59:25,605 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yTnPBmAw04t2ShG8LK48D4tq', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/permissions/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 678, 'prompt_tokens': 55495, 'total_tokens': 56173, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14464}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--00d6d6ba-f140-456d-8326-46686efa61c7-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/permissions/index.js'}, 'id': 'call_yTnPBmAw04t2ShG8LK48D4tq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 55495, 'output_tokens': 678, 'total_tokens': 56173, 'input_token_details': {'audio': 0, 'cache_read': 14464}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:59:36,832 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nPet7xWFB3I28jCRccyk8TAm', 'function': {'arguments': '{"text":"IamRoleLambdaExecution","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 808, 'prompt_tokens': 55553, 'total_tokens': 56361, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 29568}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f69a7347-3bec-42e6-9160-abc95e197ef0-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'IamRoleLambdaExecution', 'basename': 'index.js'}, 'id': 'call_nPet7xWFB3I28jCRccyk8TAm', 'type': 'tool_call'}] usage_metadata={'input_tokens': 55553, 'output_tokens': 808, 'total_tokens': 56361, 'input_token_details': {'audio': 0, 'cache_read': 29568}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 20:59:46,755 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Zw2W0wRzySih6slNpWzSzuVo', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/role/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 871, 'prompt_tokens': 67547, 'total_tokens': 68418, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 52480}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--920fa2c6-6b59-4e1a-9c34-e108a5a751d8-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/role/index.js'}, 'id': 'call_Zw2W0wRzySih6slNpWzSzuVo', 'type': 'tool_call'}] usage_metadata={'input_tokens': 67547, 'output_tokens': 871, 'total_tokens': 68418, 'input_token_details': {'audio': 0, 'cache_read': 52480}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 20:59:57,381 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_h67cp3AI4aokWtYUprQXu8Kj', 'function': {'arguments': '{"basename":"role.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 669, 'prompt_tokens': 67606, 'total_tokens': 68275, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 52480}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--78776cfe-c222-4c50-909f-a5390d839a83-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'role.js'}, 'id': 'call_h67cp3AI4aokWtYUprQXu8Kj', 'type': 'tool_call'}] usage_metadata={'input_tokens': 67606, 'output_tokens': 669, 'total_tokens': 68275, 'input_token_details': {'audio': 0, 'cache_read': 52480}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:00:07,742 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NRONMxMxmHWynONFFYAsjYen', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 610, 'prompt_tokens': 67655, 'total_tokens': 68265, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 33920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b8ff9423-2369-4482-8bde-8c37fe83c316-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/index.js'}, 'id': 'call_NRONMxMxmHWynONFFYAsjYen', 'type': 'tool_call'}] usage_metadata={'input_tokens': 67655, 'output_tokens': 610, 'total_tokens': 68265, 'input_token_details': {'audio': 0, 'cache_read': 33920}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 21:00:11,507 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gEQwP66KM9zNfnSi0qWtRTZn', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 67731, 'total_tokens': 67760, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2181878e-af55-4d5f-8586-fc811716e66a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/index.js'}, 'id': 'call_gEQwP66KM9zNfnSi0qWtRTZn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 67731, 'output_tokens': 29, 'total_tokens': 67760, 'input_token_details': {'audio': 0, 'cache_read': 19712}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:00:14,490 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_bzBDhQpfqDxOwCFix90wXBr0', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 68748, 'total_tokens': 68780, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 67584}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--acd6262d-8cb9-46bf-a5f2-f1d2c9ce4f6f-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_bzBDhQpfqDxOwCFix90wXBr0', 'type': 'tool_call'}] usage_metadata={'input_tokens': 68748, 'output_tokens': 32, 'total_tokens': 68780, 'input_token_details': {'audio': 0, 'cache_read': 67584}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:00:19,399 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CdOWKVVqFrVakRIXx8UqqgY8', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 68834, 'total_tokens': 68867, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--96b5b62c-3bdb-4499-bc3c-79abcc6ed7a1-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_CdOWKVVqFrVakRIXx8UqqgY8', 'type': 'tool_call'}] usage_metadata={'input_tokens': 68834, 'output_tokens': 33, 'total_tokens': 68867, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:00:25,365 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_YltlT1EXpDExg53vOUwaepeZ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/iam-role-lambda-execution-template.json"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 298, 'prompt_tokens': 71452, 'total_tokens': 71750, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b7e44134-1319-4e4a-a53b-4ed8678127d1-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib/iam-role-lambda-execution-template.json'}, 'id': 'call_YltlT1EXpDExg53vOUwaepeZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 71452, 'output_tokens': 298, 'total_tokens': 71750, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 21:00:29,292 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_cOWhrUq3IBqSNZL7cGwkIkWE', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/iam-role-lambda-execution-template.json"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 36, 'prompt_tokens': 71514, 'total_tokens': 71550, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 55424}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--00d40c24-96d1-46e2-b23d-1fe1f63aab60-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib/iam-role-lambda-execution-template.json'}, 'id': 'call_cOWhrUq3IBqSNZL7cGwkIkWE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 71514, 'output_tokens': 36, 'total_tokens': 71550, 'input_token_details': {'audio': 0, 'cache_read': 55424}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:00:32,017 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7tzuyPZl6zXzR26TgLbY63jf', 'function': {'arguments': '{"basename":"iam-role-lambda-execution-template.json"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 71576, 'total_tokens': 71605, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 68736}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--81158b3f-f427-49a9-8173-47e2d02e1070-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam-role-lambda-execution-template.json'}, 'id': 'call_7tzuyPZl6zXzR26TgLbY63jf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 71576, 'output_tokens': 29, 'total_tokens': 71605, 'input_token_details': {'audio': 0, 'cache_read': 68736}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:00:35,760 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_wCuvwyzb6ngepeJ17KcSrcFs', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 71631, 'total_tokens': 71661, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f95e1152-dd37-47d8-b984-1f4477051c8a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_wCuvwyzb6ngepeJ17KcSrcFs', 'type': 'tool_call'}] usage_metadata={'input_tokens': 71631, 'output_tokens': 30, 'total_tokens': 71661, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:00:54,672 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VLAZRxE1xJhLb4Vr0h2J5E70', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/eventBridge/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1896, 'prompt_tokens': 74126, 'total_tokens': 76022, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1856, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 33792}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--afd04d0a-85a4-48e8-9f9a-a98131cda3ab-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/eventBridge/index.js'}, 'id': 'call_VLAZRxE1xJhLb4Vr0h2J5E70', 'type': 'tool_call'}] usage_metadata={'input_tokens': 74126, 'output_tokens': 1896, 'total_tokens': 76022, 'input_token_details': {'audio': 0, 'cache_read': 33792}, 'output_token_details': {'audio': 0, 'reasoning': 1856}}
2025-11-13 21:00:56,673 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_mpo0uejRMlHU330iFyt1E1fI', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/generateCoreTemplate.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 76260, 'total_tokens': 76292, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 74112}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d535d493-fe14-438d-82ac-60f00a4ac71b-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib/generateCoreTemplate.js'}, 'id': 'call_mpo0uejRMlHU330iFyt1E1fI', 'type': 'tool_call'}] usage_metadata={'input_tokens': 76260, 'output_tokens': 32, 'total_tokens': 76292, 'input_token_details': {'audio': 0, 'cache_read': 74112}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:01:00,158 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CkR8l8d93batfzrPvO7KKdBD', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/generateCoreTemplate.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 76346, 'total_tokens': 76379, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4154b3d4-feb2-417a-9378-9934c78ed84b-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/lib/generateCoreTemplate.js'}, 'id': 'call_CkR8l8d93batfzrPvO7KKdBD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 76346, 'output_tokens': 33, 'total_tokens': 76379, 'input_token_details': {'audio': 0, 'cache_read': 19712}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:01:02,388 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yF56XkdTTaqlpZ2L1ds5sgQ8', 'function': {'arguments': '{"text":"NotResource"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 77889, 'total_tokens': 77911, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 67456}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1747fc66-b2e0-41c4-afa2-a203511379a8-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'NotResource'}, 'id': 'call_yF56XkdTTaqlpZ2L1ds5sgQ8', 'type': 'tool_call'}] usage_metadata={'input_tokens': 77889, 'output_tokens': 22, 'total_tokens': 77911, 'input_token_details': {'audio': 0, 'cache_read': 67456}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:01:20,816 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I located and read the requested files with line numbers: lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and docs/providers/aws/guide/iam.md. I found the core implementation that processes provider.iamRoleStatements in lib/plugins/aws/package/lib/mergeIamTemplates.js (including validation and merging into the default IAM role) and provided its full content; I also gathered IAM-related logic under lib/plugins/aws/package/compile (functions and several event compilers) where statements are added or adjusted. I searched for occurrences of iamRoleStatements (found in mergeIamTemplates.js and docs) and checked for NotAction/NotResource (no matches anywhere), which aligns with validateStatements enforcing Effect, Action, and Resource only. Overall, this context shows how custom statements are validated/merged and how additional IAM statements are generated during packaging for events and function features.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1723, 'prompt_tokens': 77936, 'total_tokens': 79659, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1536, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 71424}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--0067fc68-70fe-458e-aa7a-bb6d4dbb4dbd-0' usage_metadata={'input_tokens': 77936, 'output_tokens': 1723, 'total_tokens': 79659, 'input_token_details': {'audio': 0, 'cache_read': 71424}, 'output_token_details': {'audio': 0, 'reasoning': 1536}}
2025-11-13 21:01:20,823 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full implementations that process provider.iamRoleStatements (validation and IAM policy generation), including lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, any IAM-related files under lib/plugins/aws/package/compile, and docs/providers/aws/guide/iam.md, with line numbers.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If exact files differ, please share grep results for 'iamRoleStatements', 'NotAction', and 'NotResource' with matching file paths and surrounding code.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
To verify current behavior and intent regarding NotAction/NotResource so we can classify the issue correctly.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: docs/providers/aws/cli-reference/invoke-local.md
Line number range: 123 - 143
Content:
**Note:** In order to get correct output when using Java runtime, your Response class must implement `toString()` method.

**Environment variables:** The `IS_LOCAL` environment variable, as well as
any environment variables provided via command line arguments,
will only be set once the invoked function begins its execution.
They _will not_ be set during the parsing of the `serverless.yml` file.

## Resource permissions

Lambda functions assume an _IAM role_ during execution: the framework creates this role, and set all the permission provided in the `iamRoleStatements` section of `serverless.yml`.

Unless you explicitly state otherwise, every call to the AWS SDK inside the lambda function is made using this role (a temporary pair of key / secret is generated and set by AWS as environment variables, `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`).

When you use `serverless invoke local`, the situation is quite different: the role isn't available (the function is executed on your local machine), so unless you set a different user directly in the code (or via a key pair of environment variables), the AWS SDK will use the default profile specified inside your AWS credential configuration file.

Take a look to the official AWS documentation (in this particular instance, for the javascript SDK, but should be similar for all SDKs):

- [http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-shared.html](http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-shared.html)
- [http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-lambda.html](http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-lambda.html)

Whatever approach you decide to implement, **be aware**: the set of permissions might be (and probably is) different, so you won't have an exact simulation of the _real_ IAM policy in place.


File: docs/providers/aws/cli-reference/invoke.md
Line number range: 112 - 141
Content:
```bash
serverless invoke local --function functionName --context "hello world"
```

### Local function invocation with context passing

```bash
serverless invoke local --function functionName --contextPath lib/context.json
```

This example will pass the json context in the `lib/context.json` file (relative to the root of the service) while invoking the specified/deployed function.

### Limitations

Currently, `invoke local` only supports the NodeJs and Python runtimes.

## Resource permissions

Lambda functions assume an _IAM role_ during execution: the framework creates this role, and set all the permission provided in the `iamRoleStatements` section of `serverless.yml`.

Unless you explicitly state otherwise, every call to the AWS SDK inside the lambda function is made using this role (a temporary pair of key / secret is generated and set by AWS as environment variables, `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`).

When you use `serverless invoke local`, the situation is quite different: the role isn't available (the function is executed on your local machine), so unless you set a different user directly in the code (or via a key pair of environment variables), the AWS SDK will use the default profile specified inside you AWS credential configuration file.

Take a look to the official AWS documentation (in this particular instance, for the javascript SDK, but should be similar for all SDKs):

- [http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-shared.html](http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-shared.html)
- [http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-lambda.html](http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-lambda.html)

Whatever approach you decide to implement, **be aware**: the set of permissions might be (and probably is) different, so you won't have an exact simulation of the _real_ IAM policy in place.


File: docs/providers/aws/guide/functions.md
Line number range: 1 - 193
Content:
<!--
title: Serverless Framework - AWS Lambda Guide - Functions
menuText: Functions
menuOrder: 5
description: How to configure AWS Lambda functions in the Serverless Framework
layout: Doc
-->

<!-- DOCS-SITE-LINK:START automatically generated  -->

### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/guide/functions)

<!-- DOCS-SITE-LINK:END -->

# AWS - Functions

If you are using AWS as a provider, all _functions_ inside the service are AWS Lambda functions.

## Configuration

All of the Lambda functions in your serverless service can be found in `serverless.yml` under the `functions` property.

```yml
# serverless.yml
service: myService

provider:
  name: aws
  runtime: nodejs10.x
  memorySize: 512 # optional, in MB, default is 1024
  timeout: 10 # optional, in seconds, default is 6
  versionFunctions: false # optional, default is true
  tracing:
    lambda: true # optional, enables tracing for all functions (can be true (true equals 'Active') 'Active' or 'PassThrough')

functions:
  hello:
    handler: handler.hello # required, handler set in AWS Lambda
    name: ${self:provider.stage}-lambdaName # optional, Deployed Lambda name
    description: Description of what the lambda function does # optional, Description to publish to AWS
    runtime: python2.7 # optional overwrite, default is provider runtime
    memorySize: 512 # optional, in MB, default is 1024
    timeout: 10 # optional, in seconds, default is 6
    reservedConcurrency: 5 # optional, reserved concurrency limit for this function. By default, AWS uses account concurrency limit
    tracing: PassThrough # optional, overwrite, can be 'Active' or 'PassThrough'
```

The `handler` property points to the file and module containing the code you want to run in your function.

```javascript
// handler.js
module.exports.functionOne = function(event, context, callback) {};
```

You can add as many functions as you want within this property.

```yml
# serverless.yml

service: myService

provider:
  name: aws
  runtime: nodejs10.x

functions:
  functionOne:
    handler: handler.functionOne
    description: optional description for your Lambda
  functionTwo:
    handler: handler.functionTwo
  functionThree:
    handler: handler.functionThree
```

Your functions can either inherit their settings from the `provider` property.

```yml
# serverless.yml
service: myService

provider:
  name: aws
  runtime: nodejs10.x
  memorySize: 512 # will be inherited by all functions

functions:
  functionOne:
    handler: handler.functionOne
```

Or you can specify properties at the function level.

```yml
# serverless.yml
service: myService

provider:
  name: aws
  runtime: nodejs10.x

functions:
  functionOne:
    handler: handler.functionOne
    memorySize: 512 # function specific
```

You can specify an array of functions, which is useful if you separate your functions in to different files:

```yml
# serverless.yml
---
functions:
  - ${file(./foo-functions.yml)}
  - ${file(./bar-functions.yml)}
```

```yml
# foo-functions.yml
getFoo:
  handler: handler.foo
deleteFoo:
  handler: handler.foo
```

## Permissions

Every AWS Lambda function needs permission to interact with other AWS infrastructure resources within your account. These permissions are set via an AWS IAM Role. You can set permission policy statements within this role via the `provider.iamRoleStatements` property.

```yml
# serverless.yml
service: myService

provider:
  name: aws
  runtime: nodejs10.x
  iamRoleStatements: # permissions for all of your functions can be set here
    - Effect: Allow
      Action: # Gives permission to DynamoDB tables in a specific region
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: 'arn:aws:dynamodb:us-east-1:*:*'

functions:
  functionOne:
    handler: handler.functionOne
    memorySize: 512
```

Another example:

```yml
# serverless.yml
service: myService
provider:
  name: aws
  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 's3:ListBucket'
      # You can put CloudFormation syntax in here.  No one will judge you.
      # Remember, this all gets translated to CloudFormation.
      Resource: { 'Fn::Join': ['', ['arn:aws:s3:::', { 'Ref': 'ServerlessDeploymentBucket' }]] }
    - Effect: 'Allow'
      Action:
        - 's3:PutObject'
      Resource:
        Fn::Join:
          - ''
          - - 'arn:aws:s3:::'
            - 'Ref': 'ServerlessDeploymentBucket'
            - '/*'

functions:
  functionOne:
    handler: handler.functionOne
    memorySize: 512
```

You can also use an existing IAM role by adding your IAM Role ARN in the `role` property. For example:

```yml
# serverless.yml
service: new-service
provider:
  name: aws
  role: arn:aws:iam::YourAccountNumber:role/YourIamRole
```


File: docs/providers/aws/guide/iam.md
Line number range: 1 - 338
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Guide - IAM
3. description: How to manage your AWS Lambda functions and their AWS infrastructure resources easily with the Serverless Framework.
4. menuText: IAM
5. menuOrder: 13
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/guide/iam)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # IAM
16. 
17. Every AWS Lambda function needs permission to interact with other AWS infrastructure resources within your account. These permissions are set via an AWS IAM Role which the Serverless Framework automatically creates for each Serverless Service, and is shared by all of your Functions. The Framework allows you to modify this Role or create Function-specific Roles, easily.
18. 
19. ## The Default IAM Role
20. 
21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
22. 
23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
24. 
25. ```yml
26. service: new-service
27. 
28. provider:
29.   name: aws
30.   iamRoleStatements:
31.     - Effect: 'Allow'
32.       Action:
33.         - 's3:ListBucket'
34.       Resource:
35.         Fn::Join:
36.           - ''
37.           - - 'arn:aws:s3:::'
38.             - Ref: ServerlessDeploymentBucket
39.     - Effect: 'Allow'
40.       Action:
41.         - 's3:PutObject'
42.       Resource:
43.         Fn::Join:
44.           - ''
45.           - - 'arn:aws:s3:::'
46.             - Ref: ServerlessDeploymentBucket
47.             - '/*'
48. ```
49. 
50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
51. 
52. ```yml
53. service: new-service
54. 
55. provider:
56.   name: aws
57.   iamManagedPolicies:
58.     - 'some:aws:arn:xxx:*:*'
59.     - 'someOther:aws:arn:xxx:*:*'
60.     - { 'Fn::Join': [':', ['arn:aws:iam:', { Ref: 'AWSAccountId' }, 'some/path']] }
61. ```
62. 
63. ## Custom IAM Roles
64. 
65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.
66. 
67. That means that `iamRoleStatements` you've defined on the `provider` level won't be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.
68. 
69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.
70. 
71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.
72. 
73. The `role` attribute can have a value of the logical name of the role, the ARN of the role, or an object that will resolve in the ARN of the role. The declaration `{ function: { role: 'myRole' } }` will result in `{ 'Fn::GetAtt': ['myRole', 'Arn'] }`. You can of course just declare an ARN like so `{ function: { role: 'an:aws:arn:xxx:*:*' } }`. This use case is primarily for those who must create their roles and / or policies via a means outside of Serverless.
74. 
75. Here are some examples of using these capabilities to specify Lambda roles.
76. 
77. ### One Custom IAM Role For All Functions
78. 
79. ```yml
80. service: new-service
81. 
82. provider:
83.   name: aws
84.   # declare one of the following...
85.   role: myDefaultRole                                                  # must validly reference a role defined in the service
86.   role: arn:aws:iam::0123456789:role//my/default/path/roleInMyAccount  # must validly reference a role defined in your account
87.   role:                                                                # must validly resolve to the ARN of a role you have the rights to use
88.     Fn::GetAtt:
89.       - myRole
90.       - Arn
91. 
92. functions:
93.   func0: # will assume 'myDefaultRole'
94.     ... # does not define role
95.   func1: # will assume 'myDefaultRole'
96.     ... # does not define role
97. 
98. resources:
99.   Resources:
100.     myDefaultRole:
101.       Type: AWS::IAM::Role
102.       Properties:
103.         Path: /my/default/path/
104.         RoleName: MyDefaultRole # required if you want to use 'serverless deploy --function' later on
105.         AssumeRolePolicyDocument:
106.           Version: '2012-10-17'
107.           Statement:
108.             - Effect: Allow
109.               Principal:
110.                 Service:
111.                   - lambda.amazonaws.com
112.               Action: sts:AssumeRole
113.         # note that these rights are needed if you want your function to be able to communicate with resources within your vpc
114.         ManagedPolicyArns:
115.           - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
116.         Policies:
117.           - PolicyName: myPolicyName
118.             PolicyDocument:
119.               Version: '2012-10-17'
120.               Statement:
121.                 - Effect: Allow # note that these rights are given in the default policy and are required if you want logs out of your lambda(s)
122.                   Action:
123.                     - logs:CreateLogGroup
124.                     - logs:CreateLogStream
125.                     - logs:PutLogEvents
126.                   Resource:
127.                     - 'Fn::Join':
128.                       - ':'
129.                       -
130.                         - 'arn:aws:logs'
131.                         - Ref: 'AWS::Region'
132.                         - Ref: 'AWS::AccountId'
133.                         - 'log-group:/aws/lambda/*:*:*'
134.                 -  Effect: "Allow"
135.                    Action:
136.                      - "s3:PutObject"
137.                    Resource:
138.                      Fn::Join:
139.                        - ""
140.                        - - "arn:aws:s3:::"
141.                          - "Ref" : "ServerlessDeploymentBucket"
142. ```
143. 
144. ### Custom IAM Roles For Each Function
145. 
146. ```yml
147. service: new-service
148. 
149. provider:
150.   name: aws
151.   ... # does not define role
152. 
153. functions:
154.   func0:
155.     role: myCustRole0
156.     ...
157.   func1:
158.     role: myCustRole1
159.     ...
160. 
161. resources:
162.   Resources:
163.     myCustRole0:
164.       Type: AWS::IAM::Role
165.       Properties:
166.         Path: /my/cust/path/
167.         RoleName: MyCustRole0
168.         AssumeRolePolicyDocument:
169.           Version: '2012-10-17'
170.           Statement:
171.             - Effect: Allow
172.               Principal:
173.                 Service:
174.                   - lambda.amazonaws.com
175.               Action: sts:AssumeRole
176.         Policies:
177.           - PolicyName: myPolicyName
178.             PolicyDocument:
179.               Version: '2012-10-17'
180.               Statement:
181.                 - Effect: Allow
182.                   Action:
183.                     - logs:CreateLogGroup
184.                     - logs:CreateLogStream
185.                     - logs:PutLogEvents
186.                   Resource:
187.                     - 'Fn::Join':
188.                       - ':'
189.                       -
190.                         - 'arn:aws:logs'
191.                         - Ref: 'AWS::Region'
192.                         - Ref: 'AWS::AccountId'
193.                         - 'log-group:/aws/lambda/*:*:*'
194.                 - Effect: Allow
195.                   Action:
196.                     - ec2:CreateNetworkInterface
197.                     - ec2:DescribeNetworkInterfaces
198.                     - ec2:DetachNetworkInterface
199.                     - ec2:DeleteNetworkInterface
200.                   Resource: "*"
201.     myCustRole1:
202.       Type: AWS::IAM::Role
203.       Properties:
204.         Path: /my/cust/path/
205.         RoleName: MyCustRole1
206.         AssumeRolePolicyDocument:
207.           Version: '2012-10-17'
208.           Statement:
209.             - Effect: Allow
210.               Principal:
211.                 Service:
212.                   - lambda.amazonaws.com
213.               Action: sts:AssumeRole
214.         Policies:
215.           - PolicyName: myPolicyName
216.             PolicyDocument:
217.               Version: '2012-10-17'
218.               Statement:
219.                 - Effect: Allow # note that these rights are given in the default policy and are required if you want logs out of your lambda(s)
220.                   Action:
221.                     - logs:CreateLogGroup
222.                     - logs:CreateLogStream
223.                     - logs:PutLogEvents
224.                   Resource:
225.                     - 'Fn::Join':
226.                       - ':'
227.                       -
228.                         - 'arn:aws:logs'
229.                         - Ref: 'AWS::Region'
230.                         - Ref: 'AWS::AccountId'
231.                         - 'log-group:/aws/lambda/*:*:*'
232.                 -  Effect: "Allow"
233.                    Action:
234.                      - "s3:PutObject"
235.                    Resource:
236.                      Fn::Join:
237.                        - ""
238.                        - - "arn:aws:s3:::"
239.                          - "Ref" : "ServerlessDeploymentBucket"
240. ```
241. 
242. ### A Custom Default Role & Custom Function Roles
243. 
244. ```yml
245. service: new-service
246. 
247. provider:
248.   name: aws
249.   role: myDefaultRole
250. 
251. functions:
252.   func0:
253.     role: myCustRole0
254.     ...
255.   func1:
256.     ... # does not define role
257. 
258. resources:
259.   Resources:
260.     myDefaultRole:
261.       Type: AWS::IAM::Role
262.       Properties:
263.         Path: /my/default/path/
264.         RoleName: MyDefaultRole
265.         AssumeRolePolicyDocument:
266.           Version: '2012-10-17'
267.           Statement:
268.             - Effect: Allow
269.               Principal:
270.                 Service:
271.                   - lambda.amazonaws.com
272.               Action: sts:AssumeRole
273.         Policies:
274.           - PolicyName: myPolicyName
275.             PolicyDocument:
276.               Version: '2012-10-17'
277.               Statement:
278.                 - Effect: Allow # note that these rights are given in the default policy and are required if you want logs out of your lambda(s)
279.                   Action:
280.                     - logs:CreateLogGroup
281.                     - logs:CreateLogStream
282.                     - logs:PutLogEvents
283.                   Resource:
284.                     - 'Fn::Join':
285.                       - ':'
286.                       -
287.                         - 'arn:aws:logs'
288.                         - Ref: 'AWS::Region'
289.                         - Ref: 'AWS::AccountId'
290.                         - 'log-group:/aws/lambda/*:*:*'
291.                 -  Effect: "Allow"
292.                    Action:
293.                      - "s3:PutObject"
294.                    Resource:
295.                      Fn::Join:
296.                        - ""
297.                        - - "arn:aws:s3:::"
298.                          - "Ref" : "ServerlessDeploymentBucket"
299.     myCustRole0:
300.       Type: AWS::IAM::Role
301.       Properties:
302.         Path: /my/cust/path/
303.         RoleName: MyCustRole0
304.         AssumeRolePolicyDocument:
305.           Version: '2012-10-17'
306.           Statement:
307.             - Effect: Allow
308.               Principal:
309.                 Service:
310.                   - lambda.amazonaws.com
311.               Action: sts:AssumeRole
312.         Policies:
313.           - PolicyName: myPolicyName
314.             PolicyDocument:
315.               Version: '2012-10-17'
316.               Statement:
317.                 - Effect: Allow
318.                   Action:
319.                     - logs:CreateLogGroup
320.                     - logs:CreateLogStream
321.                     - logs:PutLogEvents
322.                   Resource:
323.                     - 'Fn::Join':
324.                       - ':'
325.                       -
326.                         - 'arn:aws:logs'
327.                         - Ref: 'AWS::Region'
328.                         - Ref: 'AWS::AccountId'
329.                         - 'log-group:/aws/lambda/*:*:*'
330.                 - Effect: Allow
331.                   Action:
332.                     - ec2:CreateNetworkInterface
333.                     - ec2:DescribeNetworkInterfaces
334.                     - ec2:DetachNetworkInterface
335.                     - ec2:DeleteNetworkInterface
336.                   Resource: "*"
337. 
338. ```


File: docs/providers/aws/guide/serverless.yml.md
Line number range: 51 - 146
Content:
tags: # Tags that will be added to each of the deployment resources
      key1: value1
      key2: value2
  deploymentPrefix: serverless # The S3 prefix under which deployed artifacts should be stored. Default is serverless
  role: arn:aws:iam::XXXXXX:role/role # Overwrite the default IAM role which is used for all functions
  cfnRole: arn:aws:iam::XXXXXX:role/role # ARN of an IAM role for CloudFormation service. If specified, CloudFormation uses the role's credentials
  versionFunctions: false # Optional function versioning
  environment: # Service wide environment variables
    serviceEnvVar: 123456789
  endpointType: regional # Optional endpoint configuration for API Gateway REST API. Default is Edge.
  apiKeys: # List of API keys to be used by your service API Gateway REST API
    - myFirstKey
    - ${opt:stage}-myFirstKey
    - ${env:MY_API_KEY} # you can hide it in a serverless variable
  apiGateway: # Optional API Gateway global config
    restApiId: xxxxxxxxxx # REST API resource ID. Default is generated by the framework
    restApiRootResourceId: xxxxxxxxxx # Root resource ID, represent as / path
    restApiResources: # List of existing resources that were created in the REST API. This is required or the stack will be conflicted
      '/users': xxxxxxxxxx
      '/users/create': xxxxxxxxxx
    websocketApiId: # Websocket API resource ID. Default is generated by the framewok
    apiKeySourceType: HEADER # Source of API key for usage plan. HEADER or AUTHORIZER.
    minimumCompressionSize: 1024 # Compress response when larger than specified size in bytes (must be between 0 and 10485760)
    description: Some Description # Optional description for the API Gateway stage deployment
    binaryMediaTypes: # Optional binary media types the API might return
      - '*/*'
  usagePlan: # Optional usage plan configuration
    quota:
      limit: 5000
      offset: 2
      period: MONTH
    throttle:
      burstLimit: 200
      rateLimit: 100
  stackTags: # Optional CF stack tags
    key: value
  iamManagedPolicies: # Optional IAM Managed Policies, which allows to include the policies into IAM Role
    - arn:aws:iam:*****:policy/some-managed-policy
  iamRoleStatements: # IAM role statements so that services can be accessed in the AWS account
    - Effect: 'Allow'
      Action:
        - 's3:ListBucket'
      Resource:
        Fn::Join:
          - ''
          - - 'arn:aws:s3:::'
            - Ref: ServerlessDeploymentBucket
  stackPolicy: # Optional CF stack policy. The example below allows updates to all resources except deleting/replacing EC2 instances (use with caution!)
    - Effect: Allow
      Principal: '*'
      Action: 'Update:*'
      Resource: '*'
    - Effect: Deny
      Principal: '*'
      Resource: '*'
      Action:
        - Update:Replace
        - Update:Delete
      Condition:
        StringEquals:
          ResourceType:
            - AWS::EC2::Instance
  vpc: # Optional VPC. But if you use VPC then both subproperties (securityGroupIds and subnetIds) are required
    securityGroupIds:
      - securityGroupId1
      - securityGroupId2
    subnetIds:
      - subnetId1
      - subnetId2
  notificationArns: # List of existing Amazon SNS topics in the same region where notifications about stack events are sent.
    - 'arn:aws:sns:us-east-1:XXXXXX:mytopic'
  resourcePolicy:
    - Effect: Allow
      Principal: '*'
      Action: execute-api:Invoke
      Resource:
        - execute-api:/*/*/*
      Condition:
        IpAddress:
          aws:SourceIp:
            - '123.123.123.123'
  tags: # Optional service wide function tags
    foo: bar
    baz: qux
  tracing:
    apiGateway: true
    lambda: true # Optional, can be true (true equals 'Active'), 'Active' or 'PassThrough'
  logs:
    restApi: # Optional configuration which specifies if API Gateway logs are used. This can either be set to true to use defaults, or configured via subproperties.
      accessLogging: true # Optional configuration which enables or disables access logging. Defaults to true.
      format: 'requestId: $context.requestId' # Optional configuration which specifies the log format to use for access logging.
      executionLogging: true # Optional configuration which enables or disables execution logging. Defaults to true.
      level: INFO # Optional configuration which specifies the log level to use for execution logging. May be set to either INFO or ERROR.
      fullExecutionData: true # Optional configuration which specifies whether or not to log full requests/responses for execution logging. Defaults to true.
    websocket: true # Optional configuration which specifies if Websockets logs are used
    frameworkLambda: true # Optional, whether to write CloudWatch logs for custom resource lambdas as added by the framework


File: lib/plugins/aws/customResources/index.js
Line number range: 1 - 205
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const crypto = require('crypto');
5. const BbPromise = require('bluebird');
6. const fse = BbPromise.promisifyAll(require('fs-extra'));
7. const childProcess = BbPromise.promisifyAll(require('child_process'));
8. const getTmpDirPath = require('../../../utils/fs/getTmpDirPath');
9. const createZipFile = require('../../../utils/fs/createZipFile');
10. 
11. function copyCustomResources(srcDirPath, destDirPath) {
12.   return fse.ensureDirAsync(destDirPath).then(() => fse.copyAsync(srcDirPath, destDirPath));
13. }
14. 
15. function installDependencies(dirPath) {
16.   return childProcess.execAsync('npm install', { cwd: dirPath });
17. }
18. 
19. function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements) {
20.   let functionName;
21.   let absoluteFunctionName;
22.   let Handler;
23.   let customResourceFunctionLogicalId;
24. 
25.   const { serverless } = awsProvider;
26.   const { cliOptions } = serverless.pluginManager;
27.   const providerConfig = serverless.service.provider;
28.   const shouldWriteLogs = providerConfig.logs && providerConfig.logs.frameworkLambda;
29.   const { Resources } = providerConfig.compiledCloudFormationTemplate;
30.   const customResourcesRoleLogicalId = awsProvider.naming.getCustomResourcesRoleLogicalId();
31.   const srcDirPath = path.join(__dirname, 'resources');
32.   const destDirPath = path.join(
33.     serverless.config.servicePath,
34.     '.serverless',
35.     awsProvider.naming.getCustomResourcesArtifactDirectoryName()
36.   );
37.   const tmpDirPath = path.join(getTmpDirPath(), 'resources');
38.   const funcPrefix = `${serverless.service.service}-${cliOptions.stage}`;
39.   const zipFilePath = `${destDirPath}.zip`;
40.   serverless.utils.writeFileDir(zipFilePath);
41. 
42.   // check which custom resource should be used
43.   if (resourceName === 's3') {
44.     functionName = awsProvider.naming.getCustomResourceS3HandlerFunctionName();
45.     Handler = 's3/handler.handler';
46.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceS3HandlerFunctionLogicalId();
47.   } else if (resourceName === 'cognitoUserPool') {
48.     functionName = awsProvider.naming.getCustomResourceCognitoUserPoolHandlerFunctionName();
49.     Handler = 'cognitoUserPool/handler.handler';
50.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();
51.   } else if (resourceName === 'eventBridge') {
52.     functionName = awsProvider.naming.getCustomResourceEventBridgeHandlerFunctionName();
53.     Handler = 'eventBridge/handler.handler';
54.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId();
55.   } else if (resourceName === 'apiGatewayCloudWatchRole') {
56.     functionName = awsProvider.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName();
57.     Handler = 'apiGatewayCloudWatchRole/handler.handler';
58.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId();
59.   } else {
60.     return BbPromise.reject(`No implementation found for Custom Resource "${resourceName}"`);
61.   }
62.   absoluteFunctionName = `${funcPrefix}-${functionName}`;
63.   if (absoluteFunctionName.length > 64) {
64.     // Function names cannot be longer than 64.
65.     // Temporary solution until we have https://github.com/serverless/serverless/issues/6598
66.     // (which doesn't change names of already deployed functions)
67.     absoluteFunctionName = `${absoluteFunctionName.slice(0, 32)}${crypto
68.       .createHash('md5')
69.       .update(absoluteFunctionName)
70.       .digest('hex')}`;
71.   }
72. 
73.   // TODO: check every once in a while if external packages are still necessary
74.   serverless.cli.log('Installing dependencies for custom CloudFormation resources...');
75.   return copyCustomResources(srcDirPath, tmpDirPath)
76.     .then(() => installDependencies(tmpDirPath))
77.     .then(() => createZipFile(tmpDirPath, zipFilePath))
78.     .then(outputFilePath => {
79.       let S3Bucket = {
80.         Ref: awsProvider.naming.getDeploymentBucketLogicalId(),
81.       };
82.       if (serverless.service.package.deploymentBucket) {
83.         S3Bucket = serverless.service.package.deploymentBucket;
84.       }
85.       const s3Folder = serverless.service.package.artifactDirectoryName;
86.       const s3FileName = outputFilePath.split(path.sep).pop();
87.       const S3Key = `${s3Folder}/${s3FileName}`;
88. 
89.       let customResourceRole = Resources[customResourcesRoleLogicalId];
90.       if (!customResourceRole) {
91.         customResourceRole = {
92.           Type: 'AWS::IAM::Role',
93.           Properties: {
94.             AssumeRolePolicyDocument: {
95.               Version: '2012-10-17',
96.               Statement: [
97.                 {
98.                   Effect: 'Allow',
99.                   Principal: {
100.                     Service: ['lambda.amazonaws.com'],
101.                   },
102.                   Action: ['sts:AssumeRole'],
103.                 },
104.               ],
105.             },
106.             Policies: [
107.               {
108.                 PolicyName: {
109.                   'Fn::Join': [
110.                     '-',
111.                     [
112.                       awsProvider.getStage(),
113.                       awsProvider.serverless.service.service,
114.                       'custom-resources-lambda',
115.                     ],
116.                   ],
117.                 },
118.                 PolicyDocument: {
119.                   Version: '2012-10-17',
120.                   Statement: [],
121.                 },
122.               },
123.             ],
124.           },
125.         };
126. 
127.         if (shouldWriteLogs) {
128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);
129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(
130.             {
131.               Effect: 'Allow',
132.               Action: ['logs:CreateLogStream'],
133.               Resource: [
134.                 {
135.                   'Fn::Sub':
136.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
137.                     `:log-group:${logGroupsPrefix}*:*`,
138.                 },
139.               ],
140.             },
141.             {
142.               Effect: 'Allow',
143.               Action: ['logs:PutLogEvents'],
144.               Resource: [
145.                 {
146.                   'Fn::Sub':
147.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
148.                     `:log-group:${logGroupsPrefix}*:*:*`,
149.                 },
150.               ],
151.             }
152.           );
153.         }
154.       }
155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
156.       iamRoleStatements.forEach(newStmt => {
157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
158.           Statement.push(newStmt);
159.         }
160.       });
161. 
162.       const customResourceFunction = {
163.         Type: 'AWS::Lambda::Function',
164.         Properties: {
165.           Code: {
166.             S3Bucket,
167.             S3Key,
168.           },
169.           FunctionName: absoluteFunctionName,
170.           Handler,
171.           MemorySize: 1024,
172.           Role: {
173.             'Fn::GetAtt': [customResourcesRoleLogicalId, 'Arn'],
174.           },
175.           Runtime: 'nodejs10.x',
176.           Timeout: 180,
177.         },
178.         DependsOn: [customResourcesRoleLogicalId],
179.       };
180. 
181.       Object.assign(Resources, {
182.         [customResourceFunctionLogicalId]: customResourceFunction,
183.         [customResourcesRoleLogicalId]: customResourceRole,
184.       });
185. 
186.       if (shouldWriteLogs) {
187.         const customResourceLogGroupLogicalId = awsProvider.naming.getLogGroupLogicalId(
188.           functionName
189.         );
190.         customResourceFunction.DependsOn.push(customResourceLogGroupLogicalId);
191.         Object.assign(Resources, {
192.           [customResourceLogGroupLogicalId]: {
193.             Type: 'AWS::Logs::LogGroup',
194.             Properties: {
195.               LogGroupName: awsProvider.naming.getLogGroupName(absoluteFunctionName),
196.             },
197.           },
198.         });
199.       }
200.     });
201. }
202. 
203. module.exports = {
204.   addCustomResourceToService,
205. };


File: lib/plugins/aws/deployFunction/index.js
Line number range: 11 - 259
Content:
class AwsDeployFunction {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options || {};
    this.packagePath =
      this.options.package ||
      this.serverless.service.package.path ||
      path.join(this.serverless.config.servicePath || '.', '.serverless');
    this.provider = this.serverless.getProvider('aws');

    // used to store data received via AWS SDK
    this.serverless.service.provider.remoteFunctionData = null;

    Object.assign(this, validate);

    this.hooks = {
      'deploy:function:initialize': () =>
        BbPromise.bind(this)
          .then(this.validate)
          .then(this.checkIfFunctionExists),

      'deploy:function:packageFunction': () =>
        this.serverless.pluginManager.spawn('package:function'),

      'deploy:function:deploy': () =>
        BbPromise.bind(this)
          .then(() => {
            if (!this.options['update-config']) {
              return this.deployFunction();
            }

            return BbPromise.resolve();
          })
          .then(this.updateFunctionConfiguration)
          .then(() => this.serverless.pluginManager.spawn('aws:common:cleanupTempDir')),
    };
  }

  checkIfFunctionExists() {
    // check if the function exists in the service
    this.options.functionObj = this.serverless.service.getFunction(this.options.function);

    // check if function exists on AWS
    const params = {
      FunctionName: this.options.functionObj.name,
    };

    return this.provider
      .request('Lambda', 'getFunction', params)
      .then(result => {
        this.serverless.service.provider.remoteFunctionData = result;
        return result;
      })
      .catch(() => {
        const errorMessage = [
          `The function "${this.options.function}" you want to update is not yet deployed.`,
          ' Please run "serverless deploy" to deploy your service.',
          ' After that you can redeploy your services functions with the',
          ' "serverless deploy function" command.',
        ].join('');
        throw new this.serverless.classes.Error(errorMessage);
      });
  }

  normalizeArnRole(role) {
    if (typeof role === 'string') {
      if (role.indexOf(':') === -1) {
        const roleResource = this.serverless.service.resources.Resources[role];

        if (roleResource.Type !== 'AWS::IAM::Role') {
          throw new Error('Provided resource is not IAM Role.');
        }

        const roleProperties = roleResource.Properties;
        const compiledFullRoleName = `${roleProperties.Path || '/'}${roleProperties.RoleName}`;

        return this.provider
          .getAccountInfo()
          .then(
            result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`
          );
      }

      return BbPromise.resolve(role);
    }

    return this.provider
      .request('IAM', 'getRole', {
        RoleName: role['Fn::GetAtt'][0],
      })
      .then(data => data.Arn);
  }

  callUpdateFunctionConfiguration(params) {
    return this.provider.request('Lambda', 'updateFunctionConfiguration', params).then(() => {
      this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);
    });
  }

  updateFunctionConfiguration() {
    const functionObj = this.options.functionObj;
    const serviceObj = this.serverless.service.serviceObject;
    const providerObj = this.serverless.service.provider;
    const params = {
      FunctionName: functionObj.name,
    };

    if ('awsKmsKeyArn' in functionObj && !_.isObject(functionObj.awsKmsKeyArn)) {
      params.KMSKeyArn = functionObj.awsKmsKeyArn;
    } else if (serviceObj && 'awsKmsKeyArn' in serviceObj && !_.isObject(serviceObj.awsKmsKeyArn)) {
      params.KMSKeyArn = serviceObj.awsKmsKeyArn;
    }

    if ('description' in functionObj && !_.isObject(functionObj.description)) {
      params.Description = functionObj.description;
    }

    if ('handler' in functionObj && !_.isObject(functionObj.handler)) {
      params.Handler = functionObj.handler;
    }

    if ('memorySize' in functionObj && !_.isObject(functionObj.memorySize)) {
      params.MemorySize = functionObj.memorySize;
    } else if ('memorySize' in providerObj && !_.isObject(providerObj.memorySize)) {
      params.MemorySize = providerObj.memorySize;
    }

    if ('timeout' in functionObj && !_.isObject(functionObj.timeout)) {
      params.Timeout = functionObj.timeout;
    } else if ('timeout' in providerObj && !_.isObject(providerObj.timeout)) {
      params.Timeout = providerObj.timeout;
    }

    if (
      'layers' in functionObj &&
      _.isArray(functionObj.layers) &&
      !_.some(functionObj.layers, _.isObject)
    ) {
      params.Layers = functionObj.layers;
    }

    if (functionObj.onError && !_.isObject(functionObj.onError)) {
      params.DeadLetterConfig = {
        TargetArn: functionObj.onError,
      };
    }

    if (functionObj.environment || providerObj.environment) {
      params.Environment = {};
      params.Environment.Variables = Object.assign(
        {},
        providerObj.environment,
        functionObj.environment
      );

      if (_.some(params.Environment.Variables, value => _.isObject(value))) {
        delete params.Environment;
      } else {
        Object.keys(params.Environment.Variables).forEach(key => {
          // taken from the bash man pages
          if (!key.match(/^[A-Za-z_][a-zA-Z0-9_]*$/)) {
            const errorMessage = 'Invalid characters in environment variable';
            throw new this.serverless.classes.Error(errorMessage);
          }

          if (!_.isString(params.Environment.Variables[key])) {
            params.Environment.Variables[key] = _.toString(params.Environment.Variables[key]);
          }
        });
      }
    }

    if (functionObj.vpc || providerObj.vpc) {
      const vpc = functionObj.vpc || providerObj.vpc;
      params.VpcConfig = {};

      if (_.isArray(vpc.securityGroupIds) && !_.some(vpc.securityGroupIds, _.isObject)) {
        params.VpcConfig.SecurityGroupIds = vpc.securityGroupIds;
      }

      if (_.isArray(vpc.subnetIds) && !_.some(vpc.subnetIds, _.isObject)) {
        params.VpcConfig.SubnetIds = vpc.subnetIds;
      }

      if (_.isEmpty(params.VpcConfig)) {
        delete params.VpcConfig;
      }
    }

    if ('role' in functionObj && !_.isObject(functionObj.role)) {
      return this.normalizeArnRole(functionObj.role).then(roleArn => {
        params.Role = roleArn;

        return this.callUpdateFunctionConfiguration(params);
      });
    } else if ('role' in providerObj && !_.isObject(providerObj.role)) {
      return this.normalizeArnRole(providerObj.role).then(roleArn => {
        params.Role = roleArn;

        return this.callUpdateFunctionConfiguration(params);
      });
    }

    if (_.isEmpty(_.omit(params, 'FunctionName'))) {
      return BbPromise.resolve();
    }

    return this.callUpdateFunctionConfiguration(params);
  }

  deployFunction() {
    const artifactFileName = this.provider.naming.getFunctionArtifactName(this.options.function);
    let artifactFilePath =
      this.serverless.service.package.artifact || path.join(this.packagePath, artifactFileName);

    // check if an artifact is used in function package level
    const functionObject = this.serverless.service.getFunction(this.options.function);
    if (_.has(functionObject, ['package', 'artifact'])) {
      artifactFilePath = functionObject.package.artifact;
    }

    const data = fs.readFileSync(artifactFilePath);

    const remoteHash = this.serverless.service.provider.remoteFunctionData.Configuration.CodeSha256;
    const localHash = crypto
      .createHash('sha256')
      .update(data)
      .digest('base64');

    if (remoteHash === localHash && !this.options.force) {
      this.serverless.cli.log('Code not changed. Skipping function deployment.');
      return BbPromise.resolve();
    }

    const params = {
      FunctionName: this.options.functionObj.name,
      ZipFile: data,
    };

    const stats = fs.statSync(artifactFilePath);
    this.serverless.cli.log(
      `Uploading function: ${this.options.function} (${filesize(stats.size)})...`
    );

    return this.provider.request('Lambda', 'updateFunctionCode', params).then(() => {
      this.serverless.cli.log(`Successfully deployed function: ${this.options.function}`);
    });
  }
}


File: lib/plugins/aws/lib/validate.js
Line number range: 1 - 62
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const chalk = require('chalk');
5. const userStats = require('../../../utils/userStats');
6. 
7. module.exports = {
8.   validate() {
9.     if (!this.serverless.config.servicePath) {
10.       const error = new this.serverless.classes.Error(
11.         'This command can only be run inside a service directory'
12.       );
13.       return BbPromise.reject(error);
14.     }
15. 
16.     this.options.stage = this.provider.getStage();
17.     this.options.region = this.provider.getRegion();
18. 
19.     if (
20.       !['logs', 'info', 'deploy', 'remove', 'rollback', 'metrics', 'invoke'].includes(
21.         this.serverless.processedInput.commands[0]
22.       ) ||
23.       this.serverless.processedInput.commands[1] === 'local'
24.     ) {
25.       return BbPromise.resolve();
26.     }
27.     const creds = Object.assign({}, this.provider.getCredentials());
28.     delete creds.region;
29.     delete creds.signatureVersion;
30. 
31.     if (
32.       Object.keys(creds).length === 0 &&
33.       !process.env.ECS_CONTAINER_METADATA_FILE &&
34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&
35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI
36.     ) {
37.       // first check if the EC2 Metadata Service has creds before throwing error
38.       const metadataService = new this.provider.sdk.MetadataService({
39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout
40.         maxRetries: 0, // retry 0 times
41.       });
42.       return new BbPromise((resolve, reject) =>
43.         metadataService.request('/', (err, data) => {
44.           return err ? reject(err) : resolve(data);
45.         })
46.       )
47.         .catch(() => null)
48.         .then(identity => {
49.           if (!identity) {
50.             const message = [
51.               'AWS provider credentials not found.',
52.               ' Learn how to set up AWS provider credentials',
53.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
54.             ].join('');
55.             userStats.track('user_awsCredentialsNotFound');
56.             throw new this.serverless.classes.Error(message);
57.           }
58.         });
59.     }
60.     return BbPromise.resolve();
61.   },
62. };


File: lib/plugins/aws/package/compile/events/cloudFront/index.js
Line number range: 8 - 335
Content:
class AwsCompileCloudFrontEvents {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options;
    this.provider = this.serverless.getProvider('aws');
    this.hooks = {
      'package:initialize': this.validate.bind(this),
      'before:package:compileFunctions': this.prepareFunctions.bind(this),
      'package:compileEvents': this.compileCloudFrontEvents.bind(this),
      'before:remove:remove': this.logRemoveReminder.bind(this),
    };
  }

  logRemoveReminder() {
    if (this.serverless.processedInput.commands[0] === 'remove') {
      let isEventUsed = false;
      const funcKeys = this.serverless.service.getAllFunctions();
      if (funcKeys.length) {
        isEventUsed = funcKeys.some(funcKey => {
          const func = this.serverless.service.getFunction(funcKey);
          return func.events && func.events.find(e => Object.keys(e)[0] === 'cloudFront');
        });
      }
      if (isEventUsed) {
        const message = [
          "Don't forget to manually remove your Lambda@Edge functions ",
          'once the CloudFront distribution removal is successfully propagated!',
        ].join('');
        this.serverless.cli.log(message, 'Serverless', { color: 'orange' });
      }
    }
  }

  validate() {
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);
      if (functionObj.events.find(event => event.cloudFront)) {
        if (functionObj.memorySize && functionObj.memorySize > 128) {
          throw new Error(
            `"${functionName}" memorySize is greater than 128 which is not supported by Lambda@Edge functions`
          );
        }
        if (functionObj.timeout && functionObj.timeout > 5) {
          throw new Error(
            `"${functionName}" timeout is greater than 5 which is not supported by Lambda@Edge functions`
          );
        }
      }
    });
  }

  prepareFunctions() {
    // Lambda@Edge functions need to be versioned
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);
      if (functionObj.events.find(event => event.cloudFront)) {
        // ensure that functions are versioned
        Object.assign(functionObj, { versionFunction: true });
        // set the maximum memory size if not explicitly configured
        if (!functionObj.memorySize) {
          Object.assign(functionObj, { memorySize: 128 });
        }
        // set the maximum timeout if not explicitly configured
        if (!functionObj.timeout) {
          Object.assign(functionObj, { timeout: 5 });
        }
      }
    });
  }

  compileCloudFrontEvents() {
    this.cloudFrontDistributionLogicalId = this.provider.naming.getCloudFrontDistributionLogicalId();

    this.cloudFrontDistributionDomainNameLogicalId = this.provider.naming.getCloudFrontDistributionDomainNameLogicalId();

    const lambdaAtEdgeFunctions = [];

    const origins = [];
    const behaviors = [];

    const Resources = this.serverless.service.provider.compiledCloudFormationTemplate.Resources;
    const Outputs = this.serverless.service.provider.compiledCloudFormationTemplate.Outputs;

    // helper function for joining origins and behaviors
    function extendDeep(object, source) {
      return _.assignWith(object, source, (a, b) => {
        if (Array.isArray(a)) {
          return _.uniq(a.concat(b));
        }
        if (_.isObject(a)) {
          extendDeep(a, b);
        }
        return a;
      });
    }

    function createOrigin(functionName, origin, naming) {
      const originObj = {};
      if (typeof origin === 'string') {
        const originUrl = url.parse(origin);
        Object.assign(originObj, {
          DomainName: originUrl.hostname,
        });

        if (originUrl.pathname && originUrl.pathname.length > 1) {
          Object.assign(originObj, { OriginPath: originUrl.pathname });
        }

        if (originUrl.protocol === 's3:') {
          Object.assign(originObj, { S3OriginConfig: {} });
        } else {
          Object.assign(originObj, {
            CustomOriginConfig: {
              OriginProtocolPolicy: 'match-viewer',
            },
          });
        }
      } else {
        Object.assign(originObj, origin);
      }

      Object.assign(originObj, {
        Id: naming.getCloudFrontOriginId(functionName, originObj.OriginPath),
      });
      return originObj;
    }

    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);
      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.cloudFront) {
            if (!_.isObject(event.cloudFront)) {
              throw new Error('cloudFront event has to be an object');
            }

            const lambdaFunctionLogicalId = Object.keys(Resources).find(
              key =>
                Resources[key].Type === 'AWS::Lambda::Function' &&
                Resources[key].Properties.FunctionName === functionObj.name
            );

            // Retain Lambda@Edge functions to avoid issues when removing the CloudFormation stack
            Object.assign(Resources[lambdaFunctionLogicalId], { DeletionPolicy: 'Retain' });

            const lambdaVersionLogicalId = _.findKey(Resources, {
              Type: 'AWS::Lambda::Version',
              Properties: {
                FunctionName: {
                  Ref: this.provider.naming.getLambdaLogicalId(functionName),
                },
              },
            });

            const pathPattern =
              typeof event.cloudFront.pathPattern === 'string'
                ? event.cloudFront.pathPattern
                : undefined;

            let origin = createOrigin(functionName, event.cloudFront.origin, this.provider.naming);

            const existingOrigin = _.find(origins, o => o.OriginPath === origin.OriginPath);

            if (!existingOrigin) {
              origins.push(origin);
            } else {
              origin = extendDeep(existingOrigin, origin);
            }

            let behavior = {
              ViewerProtocolPolicy: 'allow-all',
              TargetOriginId: origin.Id,
              ForwardedValues: {
                QueryString: false,
              },
              LambdaFunctionAssociations: [
                {
                  EventType: event.cloudFront.eventType,
                  LambdaFunctionARN: {
                    Ref: lambdaVersionLogicalId,
                  },
                },
              ],
            };

            if (pathPattern) {
              Object.assign(behavior, { PathPattern: pathPattern });
            }

            const existingBehaviour = behaviors.find(
              o =>
                o.PathPattern === behavior.PathPattern &&
                o.TargetOriginId === behavior.TargetOriginId
            );

            if (!existingBehaviour) {
              behaviors.push(behavior);
            } else {
              behavior = extendDeep(existingBehaviour, behavior);
            }

            lambdaAtEdgeFunctions.push(
              Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })
            );
          }
        });
      }
    });

    // sort that first is without PathPattern if available
    behaviors.sort((a, b) => {
      if (b.PathPattern) {
        return -1;
      }
      return 0;
    });

    if (lambdaAtEdgeFunctions.length) {
      if (this.provider.getRegion() !== 'us-east-1') {
        throw new ServerlessError(
          'CloudFront associated functions have to be deployed to the us-east-1 region.'
        );
      }

      const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(
        (permissions, lambdaAtEdgeFunction) => {
          const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(
            lambdaAtEdgeFunction.functionName
          );
          const invokePermission = {
            Type: 'AWS::Lambda::Permission',
            Properties: {
              FunctionName: {
                Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,
              },
              Action: 'lambda:InvokeFunction',
              Principal: 'edgelambda.amazonaws.com',
              SourceArn: {
                'Fn::Join': [
                  '',
                  [
                    '',
                    'arn:aws:cloudfront::',
                    { Ref: 'AWS::AccountId' },
                    ':distribution/',
                    { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },
                  ],
                ],
              },
            },
          };
          return Object.assign(permissions, {
            [invokePermissionName]: invokePermission,
          });
        },
        {}
      );

      Object.assign(Resources, lambdaInvokePermissions);

      if (!Resources.IamRoleLambdaExecution) {
        this.serverless.cli.log(
          chalk.magenta('Remember to add required lambda@edge permissions to your execution role.')
        );
        this.serverless.cli.log(
          chalk.magenta(
            'https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-edge-permissions.html'
          )
        );
      } else {
        const lambdaAssumeStatement = Resources.IamRoleLambdaExecution.Properties.AssumeRolePolicyDocument.Statement.find(
          statement => statement.Principal.Service.includes('lambda.amazonaws.com')
        );
        if (lambdaAssumeStatement) {
          lambdaAssumeStatement.Principal.Service.push('edgelambda.amazonaws.com');
        }

        // Lambda creates CloudWatch Logs log streams
        // in the CloudWatch Logs regions closest
        // to the locations where the function is executed.
        // The format of the name for each log stream is
        // /aws/lambda/us-east-1.function-name where
        // function-name is the name that you gave
        // to the function when you created it.
        Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push({
          Effect: 'Allow',
          Action: ['logs:CreateLogGroup', 'logs:CreateLogStream', 'logs:PutLogEvents'],
          Resource: ['arn:aws:logs:*:*:*'],
        });
      }

      const CacheBehaviors = behaviors.slice(1);

      const CloudFrontDistribution = {
        Type: 'AWS::CloudFront::Distribution',
        Properties: {
          DistributionConfig: {
            Comment: `${this.serverless.service.service} ${this.serverless.service.provider.stage}`,
            Enabled: true,
            DefaultCacheBehavior: behaviors[0],
            Origins: origins,
          },
        },
      };

      if (CacheBehaviors.length > 0) {
        Object.assign(CloudFrontDistribution.Properties.DistributionConfig, { CacheBehaviors });
      }

      Object.assign(Resources, { [this.cloudFrontDistributionLogicalId]: CloudFrontDistribution });

      _.merge(Outputs, {
        [this.cloudFrontDistributionLogicalId]: {
          Description: 'CloudFront Distribution Id',
          Value: {
            Ref: this.provider.naming.getCloudFrontDistributionLogicalId(),
          },
        },
        [this.cloudFrontDistributionDomainNameLogicalId]: {
          Description: 'CloudFront Distribution Domain Name',
          Value: {
            'Fn::GetAtt': [this.provider.naming.getCloudFrontDistributionLogicalId(), 'DomainName'],
          },
        },
      });
    }
  }
}


File: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js
Line number range: 20 - 364
Content:
class AwsCompileCognitoUserPoolEvents {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options;
    this.provider = this.serverless.getProvider('aws');

    this.hooks = {
      'package:compileEvents': () => {
        return BbPromise.bind(this)
          .then(this.newCognitoUserPools)
          .then(this.existingCognitoUserPools);
      },
      'after:package:finalize': this.mergeWithCustomResources.bind(this),
    };
  }

  newCognitoUserPools() {
    const { service } = this.serverless;
    service.getAllFunctions().forEach(functionName => {
      const functionObj = service.getFunction(functionName);
      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.cognitoUserPool) {
            // return immediately if it's an existing Cognito User Pool event since we treat them differently
            if (event.cognitoUserPool.existing) return null;

            const result = this.findUserPoolsAndFunctions();
            const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
            const userPools = result.userPools;

            // Generate CloudFormation templates for Cognito User Pool changes
            _.forEach(userPools, poolName => {
              const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {
                poolName,
              });
              const userPoolCFResource = this.generateTemplateForPool(
                poolName,
                currentPoolTriggerFunctions
              );

              _.merge(
                this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
                userPoolCFResource
              );
            });

            // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda
            _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {
              const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(
                cognitoUserPoolTriggerFunction.poolName
              );
              const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(
                cognitoUserPoolTriggerFunction.functionName
              );

              const permissionTemplate = {
                Type: 'AWS::Lambda::Permission',
                Properties: {
                  FunctionName: {
                    'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
                  },
                  Action: 'lambda:InvokeFunction',
                  Principal: 'cognito-idp.amazonaws.com',
                  SourceArn: {
                    'Fn::GetAtt': [userPoolLogicalId, 'Arn'],
                  },
                },
              };
              const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(
                cognitoUserPoolTriggerFunction.functionName,
                cognitoUserPoolTriggerFunction.poolName,
                cognitoUserPoolTriggerFunction.triggerSource
              );
              const permissionCFResource = {
                [lambdaPermissionLogicalId]: permissionTemplate,
              };
              _.merge(
                this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
                permissionCFResource
              );
            });
          }
          return null;
        });
      }
      return null;
    });
  }

  existingCognitoUserPools() {
    const { service } = this.serverless;
    const { provider } = service;
    const { compiledCloudFormationTemplate } = provider;
    const { Resources } = compiledCloudFormationTemplate;
    const iamRoleStatements = [];

    // used to keep track of the custom resources created for each Cognito User Pool
    const poolResources = {};

    service.getAllFunctions().forEach(functionName => {
      let numEventsForFunc = 0;
      let currentPoolName = null;
      let funcUsesExistingCognitoUserPool = false;
      const functionObj = service.getFunction(functionName);
      const FunctionName = functionObj.name;

      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.cognitoUserPool && event.cognitoUserPool.existing) {
            numEventsForFunc++;
            const { pool, trigger } = event.cognitoUserPool;
            funcUsesExistingCognitoUserPool = true;

            if (!currentPoolName) {
              currentPoolName = pool;
            }
            if (pool !== currentPoolName) {
              const errorMessage = [
                'Only one Cognito User Pool can be configured per function.',
                ` In "${FunctionName}" you're attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
            const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();
            const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(
              functionName
            );

            // store how often the custom Cognito User Pool resource is used
            if (poolResources[pool]) {
              poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);
            } else {
              Object.assign(poolResources, {
                [pool]: [customPoolResourceLogicalId],
              });
            }

            let customCognitoUserPoolResource;
            if (numEventsForFunc === 1) {
              customCognitoUserPoolResource = {
                [customPoolResourceLogicalId]: {
                  Type: 'Custom::CognitoUserPool',
                  Version: 1.0,
                  DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
                  Properties: {
                    ServiceToken: {
                      'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
                    },
                    FunctionName,
                    UserPoolName: pool,
                    UserPoolConfigs: [
                      {
                        Trigger: trigger,
                      },
                    ],
                  },
                },
              };

              iamRoleStatements.push({
                Effect: 'Allow',
                Resource: '*',
                Action: [
                  'cognito-idp:ListUserPools',
                  'cognito-idp:DescribeUserPool',
                  'cognito-idp:UpdateUserPool',
                ],
              });
            } else {
              Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({
                Trigger: trigger,
              });
            }

            _.merge(Resources, customCognitoUserPoolResource);
          }
        });
      }

      if (funcUsesExistingCognitoUserPool) {
        iamRoleStatements.push({
          Effect: 'Allow',
          Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,
          Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
        });
      }
    });

    // check if we need to add DependsOn clauses in case more than 1
    // custom resources are created for one Cognito User Pool (to avoid race conditions)
    if (Object.keys(poolResources).length > 0) {
      Object.keys(poolResources).forEach(pool => {
        const resources = poolResources[pool];
        if (resources.length > 1) {
          resources.forEach((currResourceLogicalId, idx) => {
            if (idx > 0) {
              const prevResourceLogicalId = resources[idx - 1];
              Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);
            }
          });
        }
      });
    }

    if (iamRoleStatements.length) {
      return addCustomResourceToService(this.provider, 'cognitoUserPool', iamRoleStatements);
    }

    return null;
  }

  findUserPoolsAndFunctions() {
    const userPools = [];
    const cognitoUserPoolTriggerFunctions = [];

    // Iterate through all functions declared in `serverless.yml`
    _.forEach(this.serverless.service.getAllFunctions(), functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);

      if (functionObj.events) {
        _.forEach(functionObj.events, event => {
          if (event.cognitoUserPool) {
            // Check event definition for `cognitoUserPool` object
            if (typeof event.cognitoUserPool === 'object') {
              // Check `cognitoUserPool` object has required properties
              if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {
                throw new this.serverless.classes.Error(
                  [
                    `Cognito User Pool event of function "${functionName}" is not an object.`,
                    'The correct syntax is an object with the "pool" and "trigger" properties.',
                    'Please check the docs for more info.',
                  ].join(' ')
                );
              }

              // Check `cognitoUserPool` trigger is valid
              if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {
                throw new this.serverless.classes.Error(
                  [
                    'Cognito User Pool trigger source is invalid, must be one of:',
                    `${validTriggerSources.join(', ')}.`,
                    'Please check the docs for more info.',
                  ].join(' ')
                );
              }

              // Save trigger functions so we can use them to generate
              // IAM permissions later
              cognitoUserPoolTriggerFunctions.push({
                functionName,
                poolName: event.cognitoUserPool.pool,
                triggerSource: event.cognitoUserPool.trigger,
              });

              // Save user pools so we can use them to generate
              // CloudFormation resources later
              userPools.push(event.cognitoUserPool.pool);
            } else {
              throw new this.serverless.classes.Error(
                [
                  `Cognito User Pool event of function "${functionName}" is not an object.`,
                  'The correct syntax is an object with the "pool" and "trigger" properties.',
                  'Please check the docs for more info.',
                ].join(' ')
              );
            }
          }
        });
      }
    });

    return { cognitoUserPoolTriggerFunctions, userPools };
  }

  generateTemplateForPool(poolName, currentPoolTriggerFunctions) {
    const lambdaConfig = _.reduce(
      currentPoolTriggerFunctions,
      (result, value) => {
        const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);

        // Return a new object to avoid lint errors
        return Object.assign({}, result, {
          [value.triggerSource]: {
            'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
          },
        });
      },
      {}
    );

    const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);

    // Attach `DependsOn` for any relevant Lambdas
    const DependsOn = _.map(currentPoolTriggerFunctions, value =>
      this.provider.naming.getLambdaLogicalId(value.functionName)
    );

    return {
      [userPoolLogicalId]: {
        Type: 'AWS::Cognito::UserPool',
        Properties: {
          UserPoolName: poolName,
          LambdaConfig: lambdaConfig,
        },
        DependsOn,
      },
    };
  }

  mergeWithCustomResources() {
    const result = this.findUserPoolsAndFunctions();
    const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
    const userPools = result.userPools;

    _.forEach(userPools, poolName => {
      const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });
      const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);

      // If overrides exist in `Resources`, merge them in
      if (_.has(this.serverless.service.resources, userPoolLogicalId)) {
        const customUserPool = this.serverless.service.resources[userPoolLogicalId];
        const generatedUserPool = this.generateTemplateForPool(
          poolName,
          currentPoolTriggerFunctions
        )[userPoolLogicalId];

        // Merge `DependsOn` clauses
        const customUserPoolDependsOn = _.get(customUserPool, 'DependsOn', []);
        const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);

        // Merge default and custom resources, and `DependsOn` clause
        const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {
          DependsOn,
        });

        // Merge resource back into `Resources`
        _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
          [userPoolLogicalId]: mergedTemplate,
        });
      }
    });
  }
}


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 1 - 202
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const { addCustomResourceToService } = require('../../../../customResources');
5. 
6. class AwsCompileEventBridgeEvents {
7.   constructor(serverless, options) {
8.     this.serverless = serverless;
9.     this.options = options;
10.     this.provider = this.serverless.getProvider('aws');
11. 
12.     this.hooks = {
13.       'package:compileEvents': this.compileEventBridgeEvents.bind(this),
14.     };
15.   }
16. 
17.   compileEventBridgeEvents() {
18.     const { service } = this.serverless;
19.     const { provider } = service;
20.     const { compiledCloudFormationTemplate } = provider;
21.     const iamRoleStatements = [];
22. 
23.     service.getAllFunctions().forEach(functionName => {
24.       let funcUsesEventBridge = false;
25.       const functionObj = service.getFunction(functionName);
26.       const FunctionName = functionObj.name;
27. 
28.       if (functionObj.events) {
29.         functionObj.events.forEach((event, idx) => {
30.           if (event.eventBridge) {
31.             if (typeof event.eventBridge === 'object') {
32.               idx++;
33.               funcUsesEventBridge = true;
34. 
35.               const EventBus = event.eventBridge.eventBus;
36.               const Schedule = event.eventBridge.schedule;
37.               const Pattern = event.eventBridge.pattern;
38.               const Input = event.eventBridge.input;
39.               const InputPath = event.eventBridge.inputPath;
40.               let InputTransformer = event.eventBridge.inputTransformer;
41.               const RuleName = `${FunctionName}-rule-${idx}`;
42. 
43.               const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
44.               const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId();
45.               const customEventBridgeResourceLogicalId = this.provider.naming.getCustomResourceEventBridgeResourceLogicalId(
46.                 functionName,
47.                 idx
48.               );
49. 
50.               if (!Pattern && !Schedule) {
51.                 const errorMessage = [
52.                   'You need to configure the pattern or schedule property (or both) ',
53.                   'for eventBridge events.',
54.                 ].join('');
55.                 throw new this.serverless.classes.Error(errorMessage);
56.               }
57. 
58.               const inputOptions = [Input, InputPath, InputTransformer].filter(i => i);
59.               if (inputOptions.length > 1) {
60.                 const errorMessage = [
61.                   'You can only set one of input, inputPath, or inputTransformer ',
62.                   'properties for eventBridge events.',
63.                 ].join('');
64.                 throw new this.serverless.classes.Error(errorMessage);
65.               }
66. 
67.               if (InputTransformer) {
68.                 const config = Object.assign({}, InputTransformer);
69.                 InputTransformer = {};
70.                 if (!config.inputTemplate) {
71.                   throw new this.serverless.classes.Error(
72.                     'The inputTemplate key is required when specifying an ' +
73.                       'inputTransformer for an eventBridge event'
74.                   );
75.                 }
76.                 InputTransformer.InputTemplate = config.inputTemplate;
77.                 if (config.inputPathsMap) {
78.                   InputTransformer.InputPathsMap = config.inputPathsMap;
79.                 }
80.               }
81. 
82.               const customEventBridge = {
83.                 [customEventBridgeResourceLogicalId]: {
84.                   Type: 'Custom::EventBridge',
85.                   Version: 1.0,
86.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
87.                   Properties: {
88.                     ServiceToken: {
89.                       'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
90.                     },
91.                     FunctionName,
92.                     EventBridgeConfig: {
93.                       RuleName,
94.                       EventBus,
95.                       Schedule,
96.                       Pattern,
97.                       Input,
98.                       InputPath,
99.                       InputTransformer,
100.                     },
101.                   },
102.                 },
103.               };
104. 
105.               _.merge(compiledCloudFormationTemplate.Resources, customEventBridge);
106. 
107.               let eventBusResource;
108.               let ruleResource = {
109.                 'Fn::Join': [
110.                   ':',
111.                   [
112.                     'arn:aws:events',
113.                     { Ref: 'AWS::Region' },
114.                     { Ref: 'AWS::AccountId' },
115.                     `rule/${RuleName}`,
116.                   ],
117.                 ],
118.               };
119.               if (EventBus) {
120.                 let eventBusName = EventBus;
121.                 if (EventBus.startsWith('arn')) {
122.                   eventBusName = EventBus.slice(EventBus.indexOf('/') + 1);
123.                 }
124.                 eventBusResource = {
125.                   'Fn::Join': [
126.                     ':',
127.                     [
128.                       'arn:aws:events',
129.                       { Ref: 'AWS::Region' },
130.                       { Ref: 'AWS::AccountId' },
131.                       `event-bus/${eventBusName}`,
132.                     ],
133.                   ],
134.                 };
135.                 ruleResource = {
136.                   'Fn::Join': [
137.                     ':',
138.                     [
139.                       'arn:aws:events',
140.                       { Ref: 'AWS::Region' },
141.                       { Ref: 'AWS::AccountId' },
142.                       `rule/${eventBusName}/${RuleName}`,
143.                     ],
144.                   ],
145.                 };
146.                 iamRoleStatements.push({
147.                   Effect: 'Allow',
148.                   Resource: eventBusResource,
149.                   Action: ['events:CreateEventBus', 'events:DeleteEventBus'],
150.                 });
151.               }
152. 
153.               iamRoleStatements.push({
154.                 Effect: 'Allow',
155.                 Resource: ruleResource,
156.                 Action: [
157.                   'events:PutRule',
158.                   'events:RemoveTargets',
159.                   'events:PutTargets',
160.                   'events:DeleteRule',
161.                 ],
162.               });
163.             } else {
164.               const errorMessage = [
165.                 `Event Bridge event of function "${functionName}" is not an object`,
166.                 ' Please check the docs for more info.',
167.               ].join('');
168.               throw new this.serverless.classes.Error(errorMessage);
169.             }
170.           }
171.         });
172.       }
173. 
174.       if (funcUsesEventBridge) {
175.         iamRoleStatements.push({
176.           Effect: 'Allow',
177.           Resource: {
178.             'Fn::Join': [
179.               ':',
180.               [
181.                 'arn:aws:lambda',
182.                 { Ref: 'AWS::Region' },
183.                 { Ref: 'AWS::AccountId' },
184.                 'function',
185.                 FunctionName,
186.               ],
187.             ],
188.           },
189.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
190.         });
191.       }
192.     });
193. 
194.     if (iamRoleStatements.length) {
195.       return addCustomResourceToService(this.provider, 'eventBridge', iamRoleStatements);
196.     }
197. 
198.     return null;
199.   }
200. }
201. 
202. module.exports = AwsCompileEventBridgeEvents;


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 7 - 347
Content:
class AwsCompileS3Events {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options;
    this.provider = this.serverless.getProvider('aws');

    this.hooks = {
      'package:compileEvents': () => {
        return BbPromise.bind(this)
          .then(this.newS3Buckets)
          .then(this.existingS3Buckets);
      },
    };
  }

  newS3Buckets() {
    const bucketsLambdaConfigurations = {};
    const s3EnabledFunctions = [];
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);

      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.s3) {
            // return immediately if it's an existing S3 event since we treat them differently
            if (event.s3.existing) return null;

            let bucketName;
            let notificationEvent = 's3:ObjectCreated:*';
            let filter = {};

            if (typeof event.s3 === 'object') {
              if (!event.s3.bucket) {
                const errorMessage = [
                  `Missing "bucket" property for s3 event in function ${functionName}.`,
                  ' The correct syntax is: s3: bucketName OR an object with "bucket" property.',
                  ' Please check the docs for more info.',
                ].join('');
                throw new this.serverless.classes.Error(errorMessage);
              }
              bucketName = event.s3.bucket;
              if (event.s3.event) {
                notificationEvent = event.s3.event;
              }
              if (event.s3.rules) {
                if (!_.isArray(event.s3.rules)) {
                  const errorMessage = [
                    `S3 filter rules of function ${functionName} is not an array`,
                    ' The correct syntax is: rules: [{ Name: Value }]',
                    ' Please check the docs for more info.',
                  ].join('');
                  throw new this.serverless.classes.Error(errorMessage);
                }
                const rules = [];
                event.s3.rules.forEach(rule => {
                  if (!_.isPlainObject(rule)) {
                    const errorMessage = [
                      `S3 filter rule ${rule} of function ${functionName} is not an object`,
                      ' The correct syntax is: { Name: Value }',
                      ' Please check the docs for more info.',
                    ].join('');
                    throw new this.serverless.classes.Error(errorMessage);
                  }
                  const name = Object.keys(rule)[0];
                  const value = rule[name];
                  rules.push({ Name: name, Value: value });
                });
                filter = { Filter: { S3Key: { Rules: rules } } };
              }
            } else if (typeof event.s3 === 'string') {
              bucketName = event.s3;
            } else {
              const errorMessage = [
                `S3 event of function ${functionName} is not an object nor a string.`,
                ' The correct syntax is: s3: bucketName OR an object with "bucket" property.',
                ' Please check the docs for more info.',
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);

            // check if the bucket already defined
            // in another S3 event in the service
            if (bucketsLambdaConfigurations[bucketName]) {
              let newLambdaConfiguration = {
                Event: notificationEvent,
                Function: {
                  'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
                },
              };

              // Assign 'filter' if not empty
              newLambdaConfiguration = _.assign(newLambdaConfiguration, filter);
              bucketsLambdaConfigurations[bucketName].push(newLambdaConfiguration);
            } else {
              bucketsLambdaConfigurations[bucketName] = [
                {
                  Event: notificationEvent,
                  Function: {
                    'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
                  },
                },
              ];
              // Assign 'filter' if not empty
              bucketsLambdaConfigurations[bucketName][0] = _.assign(
                bucketsLambdaConfigurations[bucketName][0],
                filter
              );
            }
            const s3EnabledFunction = { functionName, bucketName };
            s3EnabledFunctions.push(s3EnabledFunction);
          }

          return null;
        });
      }
    });

    // iterate over all buckets to be created
    // and compile them to CF resources
    _.forEach(bucketsLambdaConfigurations, (bucketLambdaConfiguration, bucketName) => {
      const bucketTemplate = {
        Type: 'AWS::S3::Bucket',
        Properties: {
          BucketName: bucketName,
          NotificationConfiguration: {
            LambdaConfigurations: bucketLambdaConfiguration,
          },
        },
        DependsOn: [],
      };

      // create the DependsOn properties for the buckets permissions (which are created later on)
      const dependsOnToCreate = s3EnabledFunctions.filter(func => func.bucketName === bucketName);

      _.forEach(dependsOnToCreate, item => {
        const lambdaPermissionLogicalId = this.provider.naming.getLambdaS3PermissionLogicalId(
          item.functionName,
          item.bucketName
        );

        bucketTemplate.DependsOn.push(lambdaPermissionLogicalId);
      });

      const bucketLogicalId = this.provider.naming.getBucketLogicalId(bucketName);
      const bucketCFResource = {
        [bucketLogicalId]: bucketTemplate,
      };
      _.merge(
        this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
        bucketCFResource
      );
    });

    // iterate over all functions with S3 events
    // and give S3 permission to invoke them all
    // by adding Lambda::Permission resource for each
    s3EnabledFunctions.forEach(s3EnabledFunction => {
      const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(
        s3EnabledFunction.functionName
      );
      const permissionTemplate = {
        Type: 'AWS::Lambda::Permission',
        Properties: {
          FunctionName: {
            'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
          },
          Action: 'lambda:InvokeFunction',
          Principal: 's3.amazonaws.com',
          SourceArn: {
            'Fn::Join': [
              '',
              ['arn:', { Ref: 'AWS::Partition' }, `:s3:::${s3EnabledFunction.bucketName}`],
            ],
          },
        },
      };
      const lambdaPermissionLogicalId = this.provider.naming.getLambdaS3PermissionLogicalId(
        s3EnabledFunction.functionName,
        s3EnabledFunction.bucketName
      );
      const permissionCFResource = {
        [lambdaPermissionLogicalId]: permissionTemplate,
      };
      _.merge(
        this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
        permissionCFResource
      );
    });
  }

  existingS3Buckets() {
    const { service } = this.serverless;
    const { provider } = service;
    const { compiledCloudFormationTemplate } = provider;
    const { Resources } = compiledCloudFormationTemplate;
    const iamRoleStatements = [];

    // used to keep track of the custom resources created for each bucket
    const bucketResources = {};

    service.getAllFunctions().forEach(functionName => {
      let numEventsForFunc = 0;
      let currentBucketName = null;
      let funcUsesExistingS3Bucket = false;
      const functionObj = service.getFunction(functionName);
      const FunctionName = functionObj.name;

      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.s3 && _.isObject(event.s3) && event.s3.existing) {
            numEventsForFunc++;
            let rules = null;
            const bucket = event.s3.bucket;
            const notificationEvent = event.s3.event || 's3:ObjectCreated:*';
            funcUsesExistingS3Bucket = true;

            if (!currentBucketName) {
              currentBucketName = bucket;
            }
            if (bucket !== currentBucketName) {
              const errorMessage = [
                'Only one S3 Bucket can be configured per function.',
                ` In "${FunctionName}" you're attempting to configure "${currentBucketName}" and "${bucket}" at the same time.`,
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            rules = _.map(event.s3.rules, rule => {
              const key = Object.keys(rule)[0];
              const value = rule[key];
              return {
                [_.startCase(key)]: value,
              };
            });

            const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
            const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceS3HandlerFunctionLogicalId();
            const customS3ResourceLogicalId = this.provider.naming.getCustomResourceS3ResourceLogicalId(
              functionName
            );

            // store how often the custom S3 resource is used
            if (bucketResources[bucket]) {
              bucketResources[bucket] = _.union(bucketResources[bucket], [
                customS3ResourceLogicalId,
              ]);
            } else {
              Object.assign(bucketResources, {
                [bucket]: [customS3ResourceLogicalId],
              });
            }

            let customS3Resource;
            if (numEventsForFunc === 1) {
              customS3Resource = {
                [customS3ResourceLogicalId]: {
                  Type: 'Custom::S3',
                  Version: 1.0,
                  DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
                  Properties: {
                    ServiceToken: {
                      'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
                    },
                    FunctionName,
                    BucketName: bucket,
                    BucketConfigs: [
                      {
                        Event: notificationEvent,
                        Rules: rules,
                      },
                    ],
                  },
                },
              };

              iamRoleStatements.push({
                Effect: 'Allow',
                Resource: {
                  'Fn::Join': [':', ['arn', { Ref: 'AWS::Partition' }, 's3', '', '', bucket]],
                },
                Action: ['s3:PutBucketNotification', 's3:GetBucketNotification'],
              });
            } else {
              Resources[customS3ResourceLogicalId].Properties.BucketConfigs.push({
                Event: notificationEvent,
                Rules: rules,
              });
            }

            _.merge(Resources, customS3Resource);
          }
        });
      }

      if (funcUsesExistingS3Bucket) {
        iamRoleStatements.push({
          Effect: 'Allow',
          Resource: {
            'Fn::Join': [
              ':',
              [
                'arn',
                { Ref: 'AWS::Partition' },
                'lambda',
                { Ref: 'AWS::Region' },
                { Ref: 'AWS::AccountId' },
                'function',
                FunctionName,
              ],
            ],
          },
          Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
        });
      }
    });

    // check if we need to add DependsOn clauses in case more than 1
    // custom resources are created for one bucket (to avoid race conditions)
    if (Object.keys(bucketResources).length > 0) {
      Object.keys(bucketResources).forEach(bucket => {
        const resources = bucketResources[bucket];
        if (resources.length > 1) {
          resources.forEach((currResourceLogicalId, idx) => {
            if (idx > 0) {
              const prevResourceLogicalId = resources[idx - 1];
              Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);
            }
          });
        }
      });
    }

    if (iamRoleStatements.length) {
      return addCustomResourceToService(this.provider, 's3', iamRoleStatements);
    }

    return null;
  }
}


File: lib/plugins/aws/package/compile/events/sqs/index.js
Line number range: 5 - 170
Content:
class AwsCompileSQSEvents {
  constructor(serverless) {
    this.serverless = serverless;
    this.provider = this.serverless.getProvider('aws');

    this.hooks = {
      'package:compileEvents': this.compileSQSEvents.bind(this),
    };
  }

  compileSQSEvents() {
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);

      if (functionObj.events) {
        const sqsStatement = {
          Effect: 'Allow',
          Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
          Resource: [],
        };

        functionObj.events.forEach(event => {
          if (event.sqs) {
            let EventSourceArn;
            let BatchSize = 10;
            let Enabled = 'True';

            // TODO validate arn syntax
            if (typeof event.sqs === 'object') {
              if (!event.sqs.arn) {
                const errorMessage = [
                  `Missing "arn" property for sqs event in function "${functionName}"`,
                  ' The correct syntax is: sqs: <QueueArn>',
                  ' OR an object with an "arn" property.',
                  ' Please check the docs for more info.',
                ].join('');
                throw new this.serverless.classes.Error(errorMessage);
              }
              if (typeof event.sqs.arn !== 'string') {
                // for dynamic arns (GetAtt/ImportValue)
                if (
                  Object.keys(event.sqs.arn).length !== 1 ||
                  !(
                    _.has(event.sqs.arn, 'Fn::ImportValue') ||
                    _.has(event.sqs.arn, 'Fn::GetAtt') ||
                    _.has(event.sqs.arn, 'Fn::Join')
                  )
                ) {
                  const errorMessage = [
                    `Bad dynamic ARN property on sqs event in function "${functionName}"`,
                    ' If you use a dynamic "arn" (such as with Fn::GetAtt or Fn::ImportValue)',
                    ' there must only be one key (either Fn::GetAtt or Fn::ImportValue) in the arn',
                    ' object. Please check the docs for more info.',
                  ].join('');
                  throw new this.serverless.classes.Error(errorMessage);
                }
              }
              EventSourceArn = event.sqs.arn;
              BatchSize = event.sqs.batchSize || BatchSize;
              if (typeof event.sqs.enabled !== 'undefined') {
                Enabled = event.sqs.enabled ? 'True' : 'False';
              }
            } else if (typeof event.sqs === 'string') {
              EventSourceArn = event.sqs;
            } else {
              const errorMessage = [
                `SQS event of function "${functionName}" is not an object nor a string`,
                ' The correct syntax is: sqs: <QueueArn>',
                ' OR an object with an "arn" property.',
                ' Please check the docs for more info.',
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            const queueName = (function() {
              if (EventSourceArn['Fn::GetAtt']) {
                return EventSourceArn['Fn::GetAtt'][0];
              } else if (EventSourceArn['Fn::ImportValue']) {
                return EventSourceArn['Fn::ImportValue'];
              } else if (EventSourceArn['Fn::Join']) {
                // [0] is the used delimiter, [1] is the array with values
                return EventSourceArn['Fn::Join'][1].slice(-1).pop();
              }
              return EventSourceArn.split(':').pop();
            })();

            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
            const queueLogicalId = this.provider.naming.getQueueLogicalId(functionName, queueName);

            const funcRole = functionObj.role || this.serverless.service.provider.role;
            let dependsOn = '"IamRoleLambdaExecution"';
            if (funcRole) {
              if (
                // check whether the custom role is an ARN
                typeof funcRole === 'string' &&
                funcRole.indexOf(':') !== -1
              ) {
                dependsOn = '[]';
              } else if (
                // otherwise, check if we have an in-service reference to a role ARN
                typeof funcRole === 'object' &&
                'Fn::GetAtt' in funcRole &&
                Array.isArray(funcRole['Fn::GetAtt']) &&
                funcRole['Fn::GetAtt'].length === 2 &&
                typeof funcRole['Fn::GetAtt'][0] === 'string' &&
                typeof funcRole['Fn::GetAtt'][1] === 'string' &&
                funcRole['Fn::GetAtt'][1] === 'Arn'
              ) {
                dependsOn = `"${funcRole['Fn::GetAtt'][0]}"`;
              } else if (
                // otherwise, check if we have an import
                typeof funcRole === 'object' &&
                'Fn::ImportValue' in funcRole
              ) {
                dependsOn = '[]';
              } else if (typeof funcRole === 'string') {
                dependsOn = `"${funcRole}"`;
              }
            }
            const sqsTemplate = `
              {
                "Type": "AWS::Lambda::EventSourceMapping",
                "DependsOn": ${dependsOn},
                "Properties": {
                  "BatchSize": ${BatchSize},
                  "EventSourceArn": ${JSON.stringify(EventSourceArn)},
                  "FunctionName": {
                    "Fn::GetAtt": [
                      "${lambdaLogicalId}",
                      "Arn"
                    ]
                  },
                  "Enabled": "${Enabled}"
                }
              }
            `;

            // add event source ARNs to PolicyDocument statements
            sqsStatement.Resource.push(EventSourceArn);

            const newSQSObject = {
              [queueLogicalId]: JSON.parse(sqsTemplate),
            };

            _.merge(
              this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
              newSQSObject
            );
          }
        });

        // update the PolicyDocument statements (if default policy is used)
        if (
          this.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .IamRoleLambdaExecution
        ) {
          const statement = this.serverless.service.provider.compiledCloudFormationTemplate
            .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
          if (sqsStatement.Resource.length) {
            statement.push(sqsStatement);
          }
        }
      }
    });
  }
}


File: lib/plugins/aws/package/compile/events/stream/index.js
Line number range: 5 - 228
Content:
class AwsCompileStreamEvents {
  constructor(serverless) {
    this.serverless = serverless;
    this.provider = this.serverless.getProvider('aws');

    this.hooks = {
      'package:compileEvents': this.compileStreamEvents.bind(this),
    };
  }

  compileStreamEvents() {
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);

      if (functionObj.events) {
        const dynamodbStreamStatement = {
          Effect: 'Allow',
          Action: [
            'dynamodb:GetRecords',
            'dynamodb:GetShardIterator',
            'dynamodb:DescribeStream',
            'dynamodb:ListStreams',
          ],
          Resource: [],
        };
        const kinesisStreamStatement = {
          Effect: 'Allow',
          Action: [
            'kinesis:GetRecords',
            'kinesis:GetShardIterator',
            'kinesis:DescribeStream',
            'kinesis:ListStreams',
          ],
          Resource: [],
        };

        functionObj.events.forEach(event => {
          if (event.stream) {
            let EventSourceArn;
            let BatchSize = 10;
            let StartingPosition = 'TRIM_HORIZON';
            let Enabled = 'True';

            // TODO validate arn syntax
            if (typeof event.stream === 'object') {
              if (!event.stream.arn) {
                const errorMessage = [
                  `Missing "arn" property for stream event in function "${functionName}"`,
                  ' The correct syntax is: stream: <StreamArn>',
                  ' OR an object with an "arn" property.',
                  ' Please check the docs for more info.',
                ].join('');
                throw new this.serverless.classes.Error(errorMessage);
              }
              if (typeof event.stream.arn !== 'string') {
                // for dynamic arns (GetAtt/ImportValue)
                if (!event.stream.type) {
                  const errorMessage = [
                    `Missing "type" property for stream event in function "${functionName}"`,
                    ' If the "arn" property on a stream is a complex type (such as Fn::GetAtt)',
                    ' then a "type" must be provided for the stream, either "kinesis" or,',
                    ' "dynamodb". Please check the docs for more info.',
                  ].join('');
                  throw new this.serverless.classes.Error(errorMessage);
                }
                if (
                  Object.keys(event.stream.arn).length !== 1 ||
                  !(
                    _.has(event.stream.arn, 'Fn::ImportValue') ||
                    _.has(event.stream.arn, 'Fn::GetAtt') ||
                    _.has(event.stream.arn, 'Fn::Join')
                  )
                ) {
                  const errorMessage = [
                    `Bad dynamic ARN property on stream event in function "${functionName}"`,
                    ' If you use a dynamic "arn" (such as with Fn::GetAtt, Fn::Join',
                    ' or Fn::ImportValue) there must only be one key (either Fn::GetAtt, Fn::Join',
                    ' or Fn::ImportValue) in the arn object. Please check the docs for more info.',
                  ].join('');
                  throw new this.serverless.classes.Error(errorMessage);
                }
              }
              EventSourceArn = event.stream.arn;
              BatchSize = event.stream.batchSize || BatchSize;
              StartingPosition = event.stream.startingPosition || StartingPosition;
              if (typeof event.stream.enabled !== 'undefined') {
                Enabled = event.stream.enabled ? 'True' : 'False';
              }
            } else if (typeof event.stream === 'string') {
              EventSourceArn = event.stream;
            } else {
              const errorMessage = [
                `Stream event of function "${functionName}" is not an object nor a string`,
                ' The correct syntax is: stream: <StreamArn>',
                ' OR an object with an "arn" property.',
                ' Please check the docs for more info.',
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            const streamType = event.stream.type || EventSourceArn.split(':')[2];
            const streamName = (function() {
              if (EventSourceArn['Fn::GetAtt']) {
                return EventSourceArn['Fn::GetAtt'][0];
              } else if (EventSourceArn['Fn::ImportValue']) {
                return EventSourceArn['Fn::ImportValue'];
              } else if (EventSourceArn['Fn::Join']) {
                // [0] is the used delimiter, [1] is the array with values
                const name = EventSourceArn['Fn::Join'][1].slice(-1).pop();
                if (name.split('/').length) {
                  return name.split('/').pop();
                }
                return name;
              }
              return EventSourceArn.split('/')[1];
            })();

            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
            const streamLogicalId = this.provider.naming.getStreamLogicalId(
              functionName,
              streamType,
              streamName
            );

            const funcRole = functionObj.role || this.serverless.service.provider.role;
            let dependsOn = '"IamRoleLambdaExecution"';
            if (funcRole) {
              if (
                // check whether the custom role is an ARN
                typeof funcRole === 'string' &&
                funcRole.indexOf(':') !== -1
              ) {
                dependsOn = '[]';
              } else if (
                // otherwise, check if we have an in-service reference to a role ARN
                typeof funcRole === 'object' &&
                'Fn::GetAtt' in funcRole &&
                Array.isArray(funcRole['Fn::GetAtt']) &&
                funcRole['Fn::GetAtt'].length === 2 &&
                typeof funcRole['Fn::GetAtt'][0] === 'string' &&
                typeof funcRole['Fn::GetAtt'][1] === 'string' &&
                funcRole['Fn::GetAtt'][1] === 'Arn'
              ) {
                dependsOn = `"${funcRole['Fn::GetAtt'][0]}"`;
              } else if (
                // otherwise, check if we have an import
                typeof funcRole === 'object' &&
                'Fn::ImportValue' in funcRole
              ) {
                dependsOn = '[]';
              } else if (typeof funcRole === 'string') {
                dependsOn = `"${funcRole}"`;
              }
            }
            const streamTemplate = `
              {
                "Type": "AWS::Lambda::EventSourceMapping",
                "DependsOn": ${dependsOn},
                "Properties": {
                  "BatchSize": ${BatchSize},
                  "EventSourceArn": ${JSON.stringify(EventSourceArn)},
                  "FunctionName": {
                    "Fn::GetAtt": [
                      "${lambdaLogicalId}",
                      "Arn"
                    ]
                  },
                  "StartingPosition": "${StartingPosition}",
                  "Enabled": "${Enabled}"
                }
              }
            `;

            // add event source ARNs to PolicyDocument statements
            if (streamType === 'dynamodb') {
              dynamodbStreamStatement.Resource.push(EventSourceArn);
            } else if (streamType === 'kinesis') {
              kinesisStreamStatement.Resource.push(EventSourceArn);
            } else {
              const errorMessage = [
                `Stream event of function '${functionName}' had unsupported stream type of`,
                ` '${streamType}'. Valid stream event source types include 'dynamodb' and`,
                " 'kinesis'. Please check the docs for more info.",
              ].join('');
              throw new this.serverless.classes.Properties.Policies[0].PolicyDocument.Error(
                errorMessage
              );
            }

            const streamResource = JSON.parse(streamTemplate);

            if (event.stream.batchWindow) {
              streamResource.Properties.MaximumBatchingWindowInSeconds = event.stream.batchWindow;
            }

            const newStreamObject = {
              [streamLogicalId]: streamResource,
            };

            _.merge(
              this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
              newStreamObject
            );
          }
        });

        // update the PolicyDocument statements (if default policy is used)
        if (
          this.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .IamRoleLambdaExecution
        ) {
          const statement = this.serverless.service.provider.compiledCloudFormationTemplate
            .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
          if (dynamodbStreamStatement.Resource.length) {
            statement.push(dynamodbStreamStatement);
          }
          if (kinesisStreamStatement.Resource.length) {
            statement.push(kinesisStreamStatement);
          }
        }
      }
    });
  }
}


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const AWS = require('aws-sdk');
4. const BbPromise = require('bluebird');
5. const crypto = require('crypto');
6. const fs = require('fs');
7. const _ = require('lodash');
8. const path = require('path');
9. 
10. class AwsCompileFunctions {
11.   constructor(serverless, options) {
12.     this.serverless = serverless;
13.     this.options = options;
14.     const servicePath = this.serverless.config.servicePath || '';
15.     this.packagePath =
16.       this.serverless.service.package.path || path.join(servicePath || '.', '.serverless');
17. 
18.     this.provider = this.serverless.getProvider('aws');
19. 
20.     if (
21.       this.serverless.service.provider.versionFunctions === undefined ||
22.       this.serverless.service.provider.versionFunctions === null
23.     ) {
24.       this.serverless.service.provider.versionFunctions = true;
25.     }
26. 
27.     this.hooks = {
28.       'package:compileFunctions': () =>
29.         BbPromise.bind(this)
30.           .then(this.downloadPackageArtifacts)
31.           .then(this.compileFunctions),
32.     };
33.   }
34. 
35.   compileRole(newFunction, role) {
36.     const compiledFunction = newFunction;
37.     const unnsupportedRoleError = new this.serverless.classes.Error(
38.       `Unsupported role provided: "${JSON.stringify(role)}"`
39.     );
40. 
41.     switch (typeof role) {
42.       case 'object':
43.         if ('Fn::GetAtt' in role) {
44.           // role is an "Fn::GetAtt" object
45.           compiledFunction.Properties.Role = role;
46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
47.             role['Fn::GetAtt'][0]
48.           );
49.         } else if ('Fn::ImportValue' in role) {
50.           // role is an "Fn::ImportValue" object
51.           compiledFunction.Properties.Role = role;
52.         } else {
53.           throw unnsupportedRoleError;
54.         }
55.         break;
56.       case 'string':
57.         if (role.startsWith('arn:aws')) {
58.           // role is a statically definied iam arn
59.           compiledFunction.Properties.Role = role;
60.         } else if (role === 'IamRoleLambdaExecution') {
61.           // role is the default role generated by the framework
62.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
64.             'IamRoleLambdaExecution'
65.           );
66.         } else {
67.           // role is a Logical Role Name
68.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);
70.         }
71.         break;
72.       default:
73.         throw unnsupportedRoleError;
74.     }
75.   }
76. 
77.   downloadPackageArtifact(functionName) {
78.     const { region } = this.options;
79.     const S3 = new AWS.S3({ region });
80. 
81.     const functionObject = this.serverless.service.getFunction(functionName);
82.     const artifactFilePath =
83.       _.get(functionObject, 'package.artifact') ||
84.       _.get(this, 'serverless.service.package.artifact');
85. 
86.     const regex = new RegExp('s3\\.amazonaws\\.com/(.+)/(.+)');
87.     const match = artifactFilePath.match(regex);
88. 
89.     if (match) {
90.       return new BbPromise((resolve, reject) => {
91.         const tmpDir = this.serverless.utils.getTmpDirPath();
92.         const filePath = path.join(tmpDir, match[2]);
93. 
94.         const readStream = S3.getObject({
95.           Bucket: match[1],
96.           Key: match[2],
97.         }).createReadStream();
98. 
99.         const writeStream = fs.createWriteStream(filePath);
100. 
101.         readStream.on('error', error => reject(error));
102.         readStream
103.           .pipe(writeStream)
104.           .on('error', reject)
105.           .on('close', () => {
106.             if (functionObject.package.artifact) {
107.               functionObject.package.artifact = filePath;
108.             } else {
109.               this.serverless.service.package.artifact = filePath;
110.             }
111.             return resolve(filePath);
112.           });
113.       });
114.     }
115. 
116.     return BbPromise.resolve();
117.   }
118. 
119.   compileFunction(functionName) {
120.     const newFunction = this.cfLambdaFunctionTemplate();
121.     const functionObject = this.serverless.service.getFunction(functionName);
122.     functionObject.package = functionObject.package || {};
123. 
124.     const serviceArtifactFileName = this.provider.naming.getServiceArtifactName();
125.     const functionArtifactFileName = this.provider.naming.getFunctionArtifactName(functionName);
126. 
127.     let artifactFilePath =
128.       functionObject.package.artifact || this.serverless.service.package.artifact;
129. 
130.     if (
131.       !artifactFilePath ||
132.       (this.serverless.service.artifact && !functionObject.package.artifact)
133.     ) {
134.       let artifactFileName = serviceArtifactFileName;
135.       if (this.serverless.service.package.individually || functionObject.package.individually) {
136.         artifactFileName = functionArtifactFileName;
137.       }
138. 
139.       artifactFilePath = path.join(
140.         this.serverless.config.servicePath,
141.         '.serverless',
142.         artifactFileName
143.       );
144.     }
145. 
146.     if (this.serverless.service.package.deploymentBucket) {
147.       newFunction.Properties.Code.S3Bucket = this.serverless.service.package.deploymentBucket;
148.     }
149. 
150.     const s3Folder = this.serverless.service.package.artifactDirectoryName;
151.     const s3FileName = artifactFilePath.split(path.sep).pop();
152.     newFunction.Properties.Code.S3Key = `${s3Folder}/${s3FileName}`;
153. 
154.     if (!functionObject.handler) {
155.       const errorMessage = [
156.         `Missing "handler" property in function "${functionName}".`,
157.         ' Please make sure you point to the correct lambda handler.',
158.         ' For example: handler.hello.',
159.         ' Please check the docs for more info',
160.       ].join('');
161.       return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
162.     }
163. 
164.     const Handler = functionObject.handler;
165.     const FunctionName = functionObject.name;
166.     const MemorySize =
167.       Number(functionObject.memorySize) ||
168.       Number(this.serverless.service.provider.memorySize) ||
169.       1024;
170.     const Timeout =
171.       Number(functionObject.timeout) || Number(this.serverless.service.provider.timeout) || 6;
172.     const Runtime =
173.       functionObject.runtime || this.serverless.service.provider.runtime || 'nodejs10.x';
174. 
175.     newFunction.Properties.Handler = Handler;
176.     newFunction.Properties.FunctionName = FunctionName;
177.     newFunction.Properties.MemorySize = MemorySize;
178.     newFunction.Properties.Timeout = Timeout;
179.     newFunction.Properties.Runtime = Runtime;
180. 
181.     // publish these properties to the platform
182.     this.serverless.service.functions[functionName].memory = MemorySize;
183.     this.serverless.service.functions[functionName].timeout = Timeout;
184.     this.serverless.service.functions[functionName].runtime = Runtime;
185. 
186.     if (functionObject.description) {
187.       newFunction.Properties.Description = functionObject.description;
188.     }
189. 
190.     if (functionObject.condition) {
191.       newFunction.Condition = functionObject.condition;
192.     }
193. 
194.     if (functionObject.dependsOn) {
195.       newFunction.DependsOn = (newFunction.DependsOn || []).concat(functionObject.dependsOn);
196.     }
197. 
198.     if (functionObject.tags || this.serverless.service.provider.tags) {
199.       const tags = Object.assign({}, this.serverless.service.provider.tags, functionObject.tags);
200.       newFunction.Properties.Tags = [];
201.       _.forEach(tags, (Value, Key) => {
202.         newFunction.Properties.Tags.push({ Key, Value });
203.       });
204.     }
205. 
206.     if (functionObject.onError) {
207.       const arn = functionObject.onError;
208. 
209.       if (typeof arn === 'string') {
210.         const splittedArn = arn.split(':');
211.         if (splittedArn[0] === 'arn' && (splittedArn[2] === 'sns' || splittedArn[2] === 'sqs')) {
212.           const dlqType = splittedArn[2];
213.           const iamRoleLambdaExecution = this.serverless.service.provider
214.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
215.           let stmt;
216. 
217.           newFunction.Properties.DeadLetterConfig = {
218.             TargetArn: arn,
219.           };
220. 
221.           if (dlqType === 'sns') {
222.             stmt = {
223.               Effect: 'Allow',
224.               Action: ['sns:Publish'],
225.               Resource: [arn],
226.             };
227.           } else if (dlqType === 'sqs') {
228.             const errorMessage = [
229.               'onError currently only supports SNS topic arns due to a',
230.               ' race condition when using SQS queue arns and updating the IAM role.',
231.               ' Please check the docs for more info.',
232.             ].join('');
233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
234.           }
235. 
236.           // update the PolicyDocument statements (if default policy is used)
237.           if (iamRoleLambdaExecution) {
238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);
239.           }
240.         } else {
241.           const errorMessage = 'onError config must be a SNS topic arn or SQS queue arn';
242.           return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
243.         }
244.       } else if (this.isArnRefGetAttOrImportValue(arn)) {
245.         newFunction.Properties.DeadLetterConfig = {
246.           TargetArn: arn,
247.         };
248.       } else {
249.         const errorMessage = [
250.           'onError config must be provided as an arn string,',
251.           ' Ref, Fn::GetAtt or Fn::ImportValue',
252.         ].join('');
253.         return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
254.       }
255.     }
256. 
257.     let kmsKeyArn;
258.     const serviceObj = this.serverless.service.serviceObject;
259.     if ('awsKmsKeyArn' in functionObject) {
260.       kmsKeyArn = functionObject.awsKmsKeyArn;
261.     } else if (serviceObj && 'awsKmsKeyArn' in serviceObj) {
262.       kmsKeyArn = serviceObj.awsKmsKeyArn;
263.     }
264. 
265.     if (kmsKeyArn) {
266.       const arn = kmsKeyArn;
267. 
268.       if (typeof arn === 'string') {
269.         const splittedArn = arn.split(':');
270.         if (splittedArn[0] === 'arn' && splittedArn[2] === 'kms') {
271.           const iamRoleLambdaExecution = this.serverless.service.provider
272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
273. 
274.           newFunction.Properties.KmsKeyArn = arn;
275. 
276.           const stmt = {
277.             Effect: 'Allow',
278.             Action: ['kms:Decrypt'],
279.             Resource: [arn],
280.           };
281. 
282.           // update the PolicyDocument statements (if default policy is used)
283.           if (iamRoleLambdaExecution) {
284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
286.               [stmt],
287.               _.isEqual
288.             );
289.           }
290.         } else {
291.           const errorMessage = 'awsKmsKeyArn config must be a KMS key arn';
292.           return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
293.         }
294.       } else {
295.         const errorMessage = 'awsKmsKeyArn config must be provided as a string';
296.         return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
297.       }
298.     }
299. 
300.     const tracing =
301.       functionObject.tracing ||
302.       (this.serverless.service.provider.tracing && this.serverless.service.provider.tracing.lambda);
303. 
304.     if (tracing) {
305.       if (typeof tracing === 'boolean' || typeof tracing === 'string') {
306.         let mode = tracing;
307. 
308.         if (typeof tracing === 'boolean') {
309.           mode = 'Active';
310.         }
311. 
312.         const iamRoleLambdaExecution = this.serverless.service.provider
313.           .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
314. 
315.         newFunction.Properties.TracingConfig = {
316.           Mode: mode,
317.         };
318. 
319.         const stmt = {
320.           Effect: 'Allow',
321.           Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],
322.           Resource: ['*'],
323.         };
324. 
325.         // update the PolicyDocument statements (if default policy is used)
326.         if (iamRoleLambdaExecution) {
327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
329.             [stmt],
330.             _.isEqual
331.           );
332.         }
333.       } else {
334.         const errorMessage = 'tracing requires a boolean value or the "mode" provided as a string';
335.         throw new this.serverless.classes.Error(errorMessage);
336.       }
337.     }
338. 
339.     if (functionObject.environment || this.serverless.service.provider.environment) {
340.       newFunction.Properties.Environment = {};
341.       newFunction.Properties.Environment.Variables = Object.assign(
342.         {},
343.         this.serverless.service.provider.environment,
344.         functionObject.environment
345.       );
346. 
347.       let invalidEnvVar = null;
348.       _.forEach(_.keys(newFunction.Properties.Environment.Variables), key => {
349.         // taken from the bash man pages
350.         if (!key.match(/^[A-Za-z_][a-zA-Z0-9_]*$/)) {
351.           invalidEnvVar = `Invalid characters in environment variable ${key}`;
352.           return false; // break loop with lodash
353.         }
354.         const value = newFunction.Properties.Environment.Variables[key];
355.         if (_.isObject(value)) {
356.           const isCFRef =
357.             _.isObject(value) && !_.some(value, (v, k) => k !== 'Ref' && !_.startsWith(k, 'Fn::'));
358.           if (!isCFRef) {
359.             invalidEnvVar = `Environment variable ${key} must contain string`;
360.             return false;
361.           }
362.         }
363.         return true;
364.       });
365. 
366.       if (invalidEnvVar) {
367.         return BbPromise.reject(new this.serverless.classes.Error(invalidEnvVar));
368.       }
369.     }
370. 
371.     if ('role' in functionObject) {
372.       this.compileRole(newFunction, functionObject.role);
373.     } else if ('role' in this.serverless.service.provider) {
374.       this.compileRole(newFunction, this.serverless.service.provider.role);
375.     } else {
376.       this.compileRole(newFunction, 'IamRoleLambdaExecution');
377.     }
378. 
379.     if (!functionObject.vpc) functionObject.vpc = {};
380.     if (!this.serverless.service.provider.vpc) this.serverless.service.provider.vpc = {};
381. 
382.     newFunction.Properties.VpcConfig = {
383.       SecurityGroupIds:
384.         functionObject.vpc.securityGroupIds ||
385.         this.serverless.service.provider.vpc.securityGroupIds,
386.       SubnetIds: functionObject.vpc.subnetIds || this.serverless.service.provider.vpc.subnetIds,
387.     };
388. 
389.     if (
390.       !newFunction.Properties.VpcConfig.SecurityGroupIds ||
391.       !newFunction.Properties.VpcConfig.SubnetIds
392.     ) {
393.       delete newFunction.Properties.VpcConfig;
394.     }
395. 
396.     if (functionObject.reservedConcurrency || functionObject.reservedConcurrency === 0) {
397.       // Try convert reservedConcurrency to integer
398.       const reservedConcurrency = _.parseInt(functionObject.reservedConcurrency);
399. 
400.       if (_.isInteger(reservedConcurrency)) {
401.         newFunction.Properties.ReservedConcurrentExecutions = reservedConcurrency;
402.       } else {
403.         const errorMessage = [
404.           'You should use integer as reservedConcurrency value on function: ',
405.           `${newFunction.Properties.FunctionName}`,
406.         ].join('');
407. 
408.         return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
409.       }
410.     }
411. 
412.     newFunction.DependsOn = [this.provider.naming.getLogGroupLogicalId(functionName)].concat(
413.       newFunction.DependsOn || []
414.     );
415. 
416.     if (functionObject.layers && _.isArray(functionObject.layers)) {
417.       newFunction.Properties.Layers = functionObject.layers;
418.     } else if (
419.       this.serverless.service.provider.layers &&
420.       _.isArray(this.serverless.service.provider.layers)
421.     ) {
422.       newFunction.Properties.Layers = this.serverless.service.provider.layers;
423.     }
424. 
425.     const functionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
426.     const newFunctionObject = {
427.       [functionLogicalId]: newFunction,
428.     };
429. 
430.     _.merge(
431.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
432.       newFunctionObject
433.     );
434. 
435.     const newVersion = this.cfLambdaVersionTemplate();
436. 
437.     // Create hashes for the artifact and the logical id of the version resource
438.     // The one for the version resource must include the function configuration
439.     // to make sure that a new version is created on configuration changes and
440.     // not only on source changes.
441.     const fileHash = crypto.createHash('sha256');
442.     const versionHash = crypto.createHash('sha256');
443.     fileHash.setEncoding('base64');
444.     versionHash.setEncoding('base64');
445. 
446.     // Read the file in chunks and add them to the hash (saves memory and performance)
447.     return BbPromise.fromCallback(cb => {
448.       const readStream = fs.createReadStream(artifactFilePath);
449. 
450.       readStream
451.         .on('data', chunk => {
452.           fileHash.write(chunk);
453.           versionHash.write(chunk);
454.         })
455.         .on('close', () => {
456.           cb();
457.         })
458.         .on('error', error => {
459.           cb(error);
460.         });
461.     }).then(() => {
462.       // Include function configuration in version id hash (without the Code part)
463.       const properties = _.omit(_.get(newFunction, 'Properties', {}), 'Code');
464.       _.forOwn(properties, value => {
465.         const hashedValue = _.isObject(value) ? JSON.stringify(value) : _.toString(value);
466.         versionHash.write(hashedValue);
467.       });
468. 
469.       // Finalize hashes
470.       fileHash.end();
471.       versionHash.end();
472. 
473.       const fileDigest = fileHash.read();
474.       const versionDigest = versionHash.read();
475. 
476.       newVersion.Properties.CodeSha256 = fileDigest;
477.       newVersion.Properties.FunctionName = { Ref: functionLogicalId };
478.       if (functionObject.description) {
479.         newVersion.Properties.Description = functionObject.description;
480.       }
481. 
482.       // use the version SHA in the logical resource ID of the version because
483.       // AWS::Lambda::Version resource will not support updates
484.       const versionLogicalId = this.provider.naming.getLambdaVersionLogicalId(
485.         functionName,
486.         versionDigest
487.       );
488.       const newVersionObject = {
489.         [versionLogicalId]: newVersion,
490.       };
491. 
492.       const versionFunction =
493.         functionObject.versionFunction != null
494.           ? functionObject.versionFunction
495.           : this.serverless.service.provider.versionFunctions;
496. 
497.       if (versionFunction) {
498.         _.merge(
499.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
500.           newVersionObject


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 10 - 580
Content:
class AwsCompileFunctions {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options;
    const servicePath = this.serverless.config.servicePath || '';
    this.packagePath =
      this.serverless.service.package.path || path.join(servicePath || '.', '.serverless');

    this.provider = this.serverless.getProvider('aws');

    if (
      this.serverless.service.provider.versionFunctions === undefined ||
      this.serverless.service.provider.versionFunctions === null
    ) {
      this.serverless.service.provider.versionFunctions = true;
    }

    this.hooks = {
      'package:compileFunctions': () =>
        BbPromise.bind(this)
          .then(this.downloadPackageArtifacts)
          .then(this.compileFunctions),
    };
  }

  compileRole(newFunction, role) {
    const compiledFunction = newFunction;
    const unnsupportedRoleError = new this.serverless.classes.Error(
      `Unsupported role provided: "${JSON.stringify(role)}"`
    );

    switch (typeof role) {
      case 'object':
        if ('Fn::GetAtt' in role) {
          // role is an "Fn::GetAtt" object
          compiledFunction.Properties.Role = role;
          compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
            role['Fn::GetAtt'][0]
          );
        } else if ('Fn::ImportValue' in role) {
          // role is an "Fn::ImportValue" object
          compiledFunction.Properties.Role = role;
        } else {
          throw unnsupportedRoleError;
        }
        break;
      case 'string':
        if (role.startsWith('arn:aws')) {
          // role is a statically definied iam arn
          compiledFunction.Properties.Role = role;
        } else if (role === 'IamRoleLambdaExecution') {
          // role is the default role generated by the framework
          compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
          compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
            'IamRoleLambdaExecution'
          );
        } else {
          // role is a Logical Role Name
          compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
          compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);
        }
        break;
      default:
        throw unnsupportedRoleError;
    }
  }

  downloadPackageArtifact(functionName) {
    const { region } = this.options;
    const S3 = new AWS.S3({ region });

    const functionObject = this.serverless.service.getFunction(functionName);
    const artifactFilePath =
      _.get(functionObject, 'package.artifact') ||
      _.get(this, 'serverless.service.package.artifact');

    const regex = new RegExp('s3\\.amazonaws\\.com/(.+)/(.+)');
    const match = artifactFilePath.match(regex);

    if (match) {
      return new BbPromise((resolve, reject) => {
        const tmpDir = this.serverless.utils.getTmpDirPath();
        const filePath = path.join(tmpDir, match[2]);

        const readStream = S3.getObject({
          Bucket: match[1],
          Key: match[2],
        }).createReadStream();

        const writeStream = fs.createWriteStream(filePath);

        readStream.on('error', error => reject(error));
        readStream
          .pipe(writeStream)
          .on('error', reject)
          .on('close', () => {
            if (functionObject.package.artifact) {
              functionObject.package.artifact = filePath;
            } else {
              this.serverless.service.package.artifact = filePath;
            }
            return resolve(filePath);
          });
      });
    }

    return BbPromise.resolve();
  }

  compileFunction(functionName) {
    const newFunction = this.cfLambdaFunctionTemplate();
    const functionObject = this.serverless.service.getFunction(functionName);
    functionObject.package = functionObject.package || {};

    const serviceArtifactFileName = this.provider.naming.getServiceArtifactName();
    const functionArtifactFileName = this.provider.naming.getFunctionArtifactName(functionName);

    let artifactFilePath =
      functionObject.package.artifact || this.serverless.service.package.artifact;

    if (
      !artifactFilePath ||
      (this.serverless.service.artifact && !functionObject.package.artifact)
    ) {
      let artifactFileName = serviceArtifactFileName;
      if (this.serverless.service.package.individually || functionObject.package.individually) {
        artifactFileName = functionArtifactFileName;
      }

      artifactFilePath = path.join(
        this.serverless.config.servicePath,
        '.serverless',
        artifactFileName
      );
    }

    if (this.serverless.service.package.deploymentBucket) {
      newFunction.Properties.Code.S3Bucket = this.serverless.service.package.deploymentBucket;
    }

    const s3Folder = this.serverless.service.package.artifactDirectoryName;
    const s3FileName = artifactFilePath.split(path.sep).pop();
    newFunction.Properties.Code.S3Key = `${s3Folder}/${s3FileName}`;

    if (!functionObject.handler) {
      const errorMessage = [
        `Missing "handler" property in function "${functionName}".`,
        ' Please make sure you point to the correct lambda handler.',
        ' For example: handler.hello.',
        ' Please check the docs for more info',
      ].join('');
      return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
    }

    const Handler = functionObject.handler;
    const FunctionName = functionObject.name;
    const MemorySize =
      Number(functionObject.memorySize) ||
      Number(this.serverless.service.provider.memorySize) ||
      1024;
    const Timeout =
      Number(functionObject.timeout) || Number(this.serverless.service.provider.timeout) || 6;
    const Runtime =
      functionObject.runtime || this.serverless.service.provider.runtime || 'nodejs10.x';

    newFunction.Properties.Handler = Handler;
    newFunction.Properties.FunctionName = FunctionName;
    newFunction.Properties.MemorySize = MemorySize;
    newFunction.Properties.Timeout = Timeout;
    newFunction.Properties.Runtime = Runtime;

    // publish these properties to the platform
    this.serverless.service.functions[functionName].memory = MemorySize;
    this.serverless.service.functions[functionName].timeout = Timeout;
    this.serverless.service.functions[functionName].runtime = Runtime;

    if (functionObject.description) {
      newFunction.Properties.Description = functionObject.description;
    }

    if (functionObject.condition) {
      newFunction.Condition = functionObject.condition;
    }

    if (functionObject.dependsOn) {
      newFunction.DependsOn = (newFunction.DependsOn || []).concat(functionObject.dependsOn);
    }

    if (functionObject.tags || this.serverless.service.provider.tags) {
      const tags = Object.assign({}, this.serverless.service.provider.tags, functionObject.tags);
      newFunction.Properties.Tags = [];
      _.forEach(tags, (Value, Key) => {
        newFunction.Properties.Tags.push({ Key, Value });
      });
    }

    if (functionObject.onError) {
      const arn = functionObject.onError;

      if (typeof arn === 'string') {
        const splittedArn = arn.split(':');
        if (splittedArn[0] === 'arn' && (splittedArn[2] === 'sns' || splittedArn[2] === 'sqs')) {
          const dlqType = splittedArn[2];
          const iamRoleLambdaExecution = this.serverless.service.provider
            .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
          let stmt;

          newFunction.Properties.DeadLetterConfig = {
            TargetArn: arn,
          };

          if (dlqType === 'sns') {
            stmt = {
              Effect: 'Allow',
              Action: ['sns:Publish'],
              Resource: [arn],
            };
          } else if (dlqType === 'sqs') {
            const errorMessage = [
              'onError currently only supports SNS topic arns due to a',
              ' race condition when using SQS queue arns and updating the IAM role.',
              ' Please check the docs for more info.',
            ].join('');
            return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
          }

          // update the PolicyDocument statements (if default policy is used)
          if (iamRoleLambdaExecution) {
            iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);
          }
        } else {
          const errorMessage = 'onError config must be a SNS topic arn or SQS queue arn';
          return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
        }
      } else if (this.isArnRefGetAttOrImportValue(arn)) {
        newFunction.Properties.DeadLetterConfig = {
          TargetArn: arn,
        };
      } else {
        const errorMessage = [
          'onError config must be provided as an arn string,',
          ' Ref, Fn::GetAtt or Fn::ImportValue',
        ].join('');
        return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
      }
    }

    let kmsKeyArn;
    const serviceObj = this.serverless.service.serviceObject;
    if ('awsKmsKeyArn' in functionObject) {
      kmsKeyArn = functionObject.awsKmsKeyArn;
    } else if (serviceObj && 'awsKmsKeyArn' in serviceObj) {
      kmsKeyArn = serviceObj.awsKmsKeyArn;
    }

    if (kmsKeyArn) {
      const arn = kmsKeyArn;

      if (typeof arn === 'string') {
        const splittedArn = arn.split(':');
        if (splittedArn[0] === 'arn' && splittedArn[2] === 'kms') {
          const iamRoleLambdaExecution = this.serverless.service.provider
            .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;

          newFunction.Properties.KmsKeyArn = arn;

          const stmt = {
            Effect: 'Allow',
            Action: ['kms:Decrypt'],
            Resource: [arn],
          };

          // update the PolicyDocument statements (if default policy is used)
          if (iamRoleLambdaExecution) {
            iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
              iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
              [stmt],
              _.isEqual
            );
          }
        } else {
          const errorMessage = 'awsKmsKeyArn config must be a KMS key arn';
          return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
        }
      } else {
        const errorMessage = 'awsKmsKeyArn config must be provided as a string';
        return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
      }
    }

    const tracing =
      functionObject.tracing ||
      (this.serverless.service.provider.tracing && this.serverless.service.provider.tracing.lambda);

    if (tracing) {
      if (typeof tracing === 'boolean' || typeof tracing === 'string') {
        let mode = tracing;

        if (typeof tracing === 'boolean') {
          mode = 'Active';
        }

        const iamRoleLambdaExecution = this.serverless.service.provider
          .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;

        newFunction.Properties.TracingConfig = {
          Mode: mode,
        };

        const stmt = {
          Effect: 'Allow',
          Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],
          Resource: ['*'],
        };

        // update the PolicyDocument statements (if default policy is used)
        if (iamRoleLambdaExecution) {
          iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
            iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
            [stmt],
            _.isEqual
          );
        }
      } else {
        const errorMessage = 'tracing requires a boolean value or the "mode" provided as a string';
        throw new this.serverless.classes.Error(errorMessage);
      }
    }

    if (functionObject.environment || this.serverless.service.provider.environment) {
      newFunction.Properties.Environment = {};
      newFunction.Properties.Environment.Variables = Object.assign(
        {},
        this.serverless.service.provider.environment,
        functionObject.environment
      );

      let invalidEnvVar = null;
      _.forEach(_.keys(newFunction.Properties.Environment.Variables), key => {
        // taken from the bash man pages
        if (!key.match(/^[A-Za-z_][a-zA-Z0-9_]*$/)) {
          invalidEnvVar = `Invalid characters in environment variable ${key}`;
          return false; // break loop with lodash
        }
        const value = newFunction.Properties.Environment.Variables[key];
        if (_.isObject(value)) {
          const isCFRef =
            _.isObject(value) && !_.some(value, (v, k) => k !== 'Ref' && !_.startsWith(k, 'Fn::'));
          if (!isCFRef) {
            invalidEnvVar = `Environment variable ${key} must contain string`;
            return false;
          }
        }
        return true;
      });

      if (invalidEnvVar) {
        return BbPromise.reject(new this.serverless.classes.Error(invalidEnvVar));
      }
    }

    if ('role' in functionObject) {
      this.compileRole(newFunction, functionObject.role);
    } else if ('role' in this.serverless.service.provider) {
      this.compileRole(newFunction, this.serverless.service.provider.role);
    } else {
      this.compileRole(newFunction, 'IamRoleLambdaExecution');
    }

    if (!functionObject.vpc) functionObject.vpc = {};
    if (!this.serverless.service.provider.vpc) this.serverless.service.provider.vpc = {};

    newFunction.Properties.VpcConfig = {
      SecurityGroupIds:
        functionObject.vpc.securityGroupIds ||
        this.serverless.service.provider.vpc.securityGroupIds,
      SubnetIds: functionObject.vpc.subnetIds || this.serverless.service.provider.vpc.subnetIds,
    };

    if (
      !newFunction.Properties.VpcConfig.SecurityGroupIds ||
      !newFunction.Properties.VpcConfig.SubnetIds
    ) {
      delete newFunction.Properties.VpcConfig;
    }

    if (functionObject.reservedConcurrency || functionObject.reservedConcurrency === 0) {
      // Try convert reservedConcurrency to integer
      const reservedConcurrency = _.parseInt(functionObject.reservedConcurrency);

      if (_.isInteger(reservedConcurrency)) {
        newFunction.Properties.ReservedConcurrentExecutions = reservedConcurrency;
      } else {
        const errorMessage = [
          'You should use integer as reservedConcurrency value on function: ',
          `${newFunction.Properties.FunctionName}`,
        ].join('');

        return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
      }
    }

    newFunction.DependsOn = [this.provider.naming.getLogGroupLogicalId(functionName)].concat(
      newFunction.DependsOn || []
    );

    if (functionObject.layers && _.isArray(functionObject.layers)) {
      newFunction.Properties.Layers = functionObject.layers;
    } else if (
      this.serverless.service.provider.layers &&
      _.isArray(this.serverless.service.provider.layers)
    ) {
      newFunction.Properties.Layers = this.serverless.service.provider.layers;
    }

    const functionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
    const newFunctionObject = {
      [functionLogicalId]: newFunction,
    };

    _.merge(
      this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
      newFunctionObject
    );

    const newVersion = this.cfLambdaVersionTemplate();

    // Create hashes for the artifact and the logical id of the version resource
    // The one for the version resource must include the function configuration
    // to make sure that a new version is created on configuration changes and
    // not only on source changes.
    const fileHash = crypto.createHash('sha256');
    const versionHash = crypto.createHash('sha256');
    fileHash.setEncoding('base64');
    versionHash.setEncoding('base64');

    // Read the file in chunks and add them to the hash (saves memory and performance)
    return BbPromise.fromCallback(cb => {
      const readStream = fs.createReadStream(artifactFilePath);

      readStream
        .on('data', chunk => {
          fileHash.write(chunk);
          versionHash.write(chunk);
        })
        .on('close', () => {
          cb();
        })
        .on('error', error => {
          cb(error);
        });
    }).then(() => {
      // Include function configuration in version id hash (without the Code part)
      const properties = _.omit(_.get(newFunction, 'Properties', {}), 'Code');
      _.forOwn(properties, value => {
        const hashedValue = _.isObject(value) ? JSON.stringify(value) : _.toString(value);
        versionHash.write(hashedValue);
      });

      // Finalize hashes
      fileHash.end();
      versionHash.end();

      const fileDigest = fileHash.read();
      const versionDigest = versionHash.read();

      newVersion.Properties.CodeSha256 = fileDigest;
      newVersion.Properties.FunctionName = { Ref: functionLogicalId };
      if (functionObject.description) {
        newVersion.Properties.Description = functionObject.description;
      }

      // use the version SHA in the logical resource ID of the version because
      // AWS::Lambda::Version resource will not support updates
      const versionLogicalId = this.provider.naming.getLambdaVersionLogicalId(
        functionName,
        versionDigest
      );
      const newVersionObject = {
        [versionLogicalId]: newVersion,
      };

      const versionFunction =
        functionObject.versionFunction != null
          ? functionObject.versionFunction
          : this.serverless.service.provider.versionFunctions;

      if (versionFunction) {
        _.merge(
          this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
          newVersionObject
        );
      }

      // Add function versions to Outputs section
      const functionVersionOutputLogicalId = this.provider.naming.getLambdaVersionOutputLogicalId(
        functionName
      );
      const newVersionOutput = this.cfOutputLatestVersionTemplate();

      newVersionOutput.Value = { Ref: versionLogicalId };

      if (versionFunction) {
        _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Outputs, {
          [functionVersionOutputLogicalId]: newVersionOutput,
        });
      }

      return BbPromise.resolve();
    });
  }

  downloadPackageArtifacts() {
    const allFunctions = this.serverless.service.getAllFunctions();
    return BbPromise.each(allFunctions, functionName => this.downloadPackageArtifact(functionName));
  }

  compileFunctions() {
    const allFunctions = this.serverless.service.getAllFunctions();
    return BbPromise.each(allFunctions, functionName => this.compileFunction(functionName));
  }

  // helper functions
  isArnRefGetAttOrImportValue(arn) {
    return (
      typeof arn === 'object' &&
      _.some(_.keys(arn), k => _.includes(['Ref', 'Fn::GetAtt', 'Fn::ImportValue'], k))
    );
  }

  cfLambdaFunctionTemplate() {
    return {
      Type: 'AWS::Lambda::Function',
      Properties: {
        Code: {
          S3Bucket: {
            Ref: 'ServerlessDeploymentBucket',
          },
          S3Key: 'S3Key',
        },
        FunctionName: 'FunctionName',
        Handler: 'Handler',
        MemorySize: 'MemorySize',
        Role: 'Role',
        Runtime: 'Runtime',
        Timeout: 'Timeout',
      },
    };
  }

  cfLambdaVersionTemplate() {
    return {
      Type: 'AWS::Lambda::Version',
      // Retain old versions even though they will not be in future
      // CloudFormation stacks. On stack delete, these will be removed when
      // their associated function is removed.
      DeletionPolicy: 'Retain',
      Properties: {
        FunctionName: 'FunctionName',
        CodeSha256: 'CodeSha256',
      },
    };
  }

  cfOutputLatestVersionTemplate() {
    return {
      Description: 'Current Lambda function version',
      Value: 'Value',
    };
  }
}


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 500 - 1050
Content:
500.           newVersionObject
501.         );
502.       }
503. 
504.       // Add function versions to Outputs section
505.       const functionVersionOutputLogicalId = this.provider.naming.getLambdaVersionOutputLogicalId(
506.         functionName
507.       );
508.       const newVersionOutput = this.cfOutputLatestVersionTemplate();
509. 
510.       newVersionOutput.Value = { Ref: versionLogicalId };
511. 
512.       if (versionFunction) {
513.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Outputs, {
514.           [functionVersionOutputLogicalId]: newVersionOutput,
515.         });
516.       }
517. 
518.       return BbPromise.resolve();
519.     });
520.   }
521. 
522.   downloadPackageArtifacts() {
523.     const allFunctions = this.serverless.service.getAllFunctions();
524.     return BbPromise.each(allFunctions, functionName => this.downloadPackageArtifact(functionName));
525.   }
526. 
527.   compileFunctions() {
528.     const allFunctions = this.serverless.service.getAllFunctions();
529.     return BbPromise.each(allFunctions, functionName => this.compileFunction(functionName));
530.   }
531. 
532.   // helper functions
533.   isArnRefGetAttOrImportValue(arn) {
534.     return (
535.       typeof arn === 'object' &&
536.       _.some(_.keys(arn), k => _.includes(['Ref', 'Fn::GetAtt', 'Fn::ImportValue'], k))
537.     );
538.   }
539. 
540.   cfLambdaFunctionTemplate() {
541.     return {
542.       Type: 'AWS::Lambda::Function',
543.       Properties: {
544.         Code: {
545.           S3Bucket: {
546.             Ref: 'ServerlessDeploymentBucket',
547.           },
548.           S3Key: 'S3Key',
549.         },
550.         FunctionName: 'FunctionName',
551.         Handler: 'Handler',
552.         MemorySize: 'MemorySize',
553.         Role: 'Role',
554.         Runtime: 'Runtime',
555.         Timeout: 'Timeout',
556.       },
557.     };
558.   }
559. 
560.   cfLambdaVersionTemplate() {
561.     return {
562.       Type: 'AWS::Lambda::Version',
563.       // Retain old versions even though they will not be in future
564.       // CloudFormation stacks. On stack delete, these will be removed when
565.       // their associated function is removed.
566.       DeletionPolicy: 'Retain',
567.       Properties: {
568.         FunctionName: 'FunctionName',
569.         CodeSha256: 'CodeSha256',
570.       },
571.     };
572.   }
573. 
574.   cfOutputLatestVersionTemplate() {
575.     return {
576.       Description: 'Current Lambda function version',
577.       Value: 'Value',
578.     };
579.   }
580. }
581. 
582. module.exports = AwsCompileFunctions;


File: lib/plugins/aws/package/index.js
Line number range: 1 - 90
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const path = require('path');
5. const mergeCustomProviderResources = require('./lib/mergeCustomProviderResources');
6. const generateArtifactDirectoryName = require('./lib/generateArtifactDirectoryName');
7. const generateCoreTemplate = require('./lib/generateCoreTemplate');
8. const saveServiceState = require('./lib/saveServiceState');
9. const saveCompiledTemplate = require('./lib/saveCompiledTemplate');
10. const mergeIamTemplates = require('./lib/mergeIamTemplates');
11. 
12. class AwsPackage {
13.   constructor(serverless, options) {
14.     this.serverless = serverless;
15.     this.options = options;
16.     this.servicePath = this.serverless.config.servicePath || '';
17.     this.packagePath =
18.       this.options.package ||
19.       this.serverless.service.package.path ||
20.       path.join(this.servicePath || '.', '.serverless');
21.     this.provider = this.serverless.getProvider('aws');
22. 
23.     Object.assign(
24.       this,
25.       generateCoreTemplate,
26.       mergeIamTemplates,
27.       generateArtifactDirectoryName,
28.       mergeCustomProviderResources,
29.       saveServiceState,
30.       saveCompiledTemplate
31.     );
32. 
33.     // Define inner lifecycles
34.     this.commands = {
35.       aws: {
36.         type: 'entrypoint',
37.         commands: {
38.           package: {
39.             commands: {
40.               finalize: {
41.                 lifecycleEvents: ['mergeCustomProviderResources', 'saveServiceState'],
42.               },
43.             },
44.           },
45.         },
46.       },
47.     };
48. 
49.     this.hooks = {
50.       /**
51.        * Outer lifecycle hooks
52.        */
53.       'package:cleanup': () =>
54.         BbPromise.bind(this)
55.           .then(() => this.serverless.pluginManager.spawn('aws:common:validate'))
56.           .then(() => this.serverless.pluginManager.spawn('aws:common:cleanupTempDir')),
57. 
58.       'package:initialize': () => BbPromise.bind(this).then(this.generateCoreTemplate),
59. 
60.       'package:setupProviderConfiguration': () => BbPromise.bind(this).then(this.mergeIamTemplates),
61. 
62.       'before:package:compileFunctions': () =>
63.         BbPromise.bind(this).then(this.generateArtifactDirectoryName),
64. 
65.       'before:package:compileLayers': () =>
66.         BbPromise.bind(this).then(this.generateArtifactDirectoryName),
67. 
68.       'package:finalize': () =>
69.         BbPromise.bind(this).then(() =>
70.           this.serverless.pluginManager.spawn('aws:package:finalize')
71.         ),
72. 
73.       /**
74.        * Inner lifecycle hooks
75.        */
76. 
77.       // Package finalize inner lifecycle
78.       'aws:package:finalize:mergeCustomProviderResources': () =>
79.         BbPromise.bind(this).then(this.mergeCustomProviderResources),
80. 
81.       'aws:package:finalize:saveServiceState': () =>
82.         BbPromise.bind(this)
83.           .then(this.saveCompiledTemplate)
84.           .then(this.saveServiceState)
85.           .then(() => this.serverless.pluginManager.spawn('aws:common:moveArtifactsToPackage')),
86.     };
87.   }
88. }
89. 
90. module.exports = AwsPackage;


File: lib/plugins/aws/package/lib/generateCoreTemplate.js
Line number range: 1 - 143
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const path = require('path');
5. const _ = require('lodash');
6. 
7. const validateS3BucketName = require('../../lib/validateS3BucketName');
8. 
9. module.exports = {
10.   generateCoreTemplate() {
11.     _.assign(this, validateS3BucketName);
12. 
13.     this.serverless.service.provider.compiledCloudFormationTemplate = this.serverless.utils.readFileSync(
14.       path.join(
15.         this.serverless.config.serverlessPath,
16.         'plugins',
17.         'aws',
18.         'package',
19.         'lib',
20.         'core-cloudformation-template.json'
21.       )
22.     );
23. 
24.     const bucketName = this.serverless.service.provider.deploymentBucket;
25. 
26.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;
27.     if (!_.isEmpty(deploymentBucketObject)) {
28.       const deploymentBucketLogicalId = this.provider.naming.getDeploymentBucketLogicalId();
29. 
30.       // resource tags support for deployment bucket
31.       if (!_.isEmpty(deploymentBucketObject.tags)) {
32.         const tags = deploymentBucketObject.tags;
33. 
34.         const bucketTags = _.map(_.keys(tags), key => ({
35.           Key: key,
36.           Value: tags[key],
37.         }));
38. 
39.         Object.assign(
40.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
41.             deploymentBucketLogicalId
42.           ].Properties,
43.           {
44.             Tags: bucketTags,
45.           }
46.         );
47.       }
48. 
49.       // enable S3 block public access for deployment bucket
50.       if (deploymentBucketObject.blockPublicAccess === true) {
51.         Object.assign(
52.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
53.             deploymentBucketLogicalId
54.           ].Properties,
55.           {
56.             PublicAccessBlockConfiguration: {
57.               BlockPublicAcls: true,
58.               BlockPublicPolicy: true,
59.               IgnorePublicAcls: true,
60.               RestrictPublicBuckets: true,
61.             },
62.           }
63.         );
64.       }
65.     }
66. 
67.     const isS3TransferAccelerationSupported = this.provider.isS3TransferAccelerationSupported();
68.     const isS3TransferAccelerationEnabled = this.provider.isS3TransferAccelerationEnabled();
69.     const isS3TransferAccelerationDisabled = this.provider.isS3TransferAccelerationDisabled();
70. 
71.     if (isS3TransferAccelerationEnabled && isS3TransferAccelerationDisabled) {
72.       const errorMessage = [
73.         'You cannot enable and disable S3 Transfer Acceleration at the same time',
74.       ].join('');
75.       return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
76.     }
77. 
78.     if (bucketName) {
79.       return BbPromise.bind(this)
80.         .then(() => this.validateS3BucketName(bucketName))
81.         .then(() => {
82.           if (isS3TransferAccelerationEnabled) {
83.             const warningMessage =
84.               'Warning: S3 Transfer Acceleration will not be enabled on deploymentBucket.';
85.             this.serverless.cli.log(warningMessage);
86.           }
87.           this.bucketName = bucketName;
88.           this.serverless.service.package.deploymentBucket = bucketName;
89.           this.serverless.service.provider.compiledCloudFormationTemplate.Outputs.ServerlessDeploymentBucketName.Value = bucketName;
90. 
91.           delete this.serverless.service.provider.compiledCloudFormationTemplate.Resources
92.             .ServerlessDeploymentBucket;
93.         });
94.     }
95. 
96.     if (isS3TransferAccelerationEnabled && isS3TransferAccelerationSupported) {
97.       // enable acceleration via CloudFormation
98.       Object.assign(
99.         this.serverless.service.provider.compiledCloudFormationTemplate.Resources
100.           .ServerlessDeploymentBucket.Properties,
101.         {
102.           AccelerateConfiguration: {
103.             AccelerationStatus: 'Enabled',
104.           },
105.         }
106.       );
107.       // keep track of acceleration status via CloudFormation Output
108.       this.serverless.service.provider.compiledCloudFormationTemplate.Outputs.ServerlessDeploymentBucketAccelerated = {
109.         Value: true,
110.       };
111.     } else if (isS3TransferAccelerationDisabled && isS3TransferAccelerationSupported) {
112.       // explicitly disable acceleration via CloudFormation
113.       Object.assign(
114.         this.serverless.service.provider.compiledCloudFormationTemplate.Resources
115.           .ServerlessDeploymentBucket.Properties,
116.         {
117.           AccelerateConfiguration: {
118.             AccelerationStatus: 'Suspended',
119.           },
120.         }
121.       );
122.     }
123. 
124.     const coreTemplateFileName = this.provider.naming.getCoreTemplateFileName();
125. 
126.     const coreTemplateFilePath = path.join(
127.       this.serverless.config.servicePath,
128.       '.serverless',
129.       coreTemplateFileName
130.     );
131. 
132.     this.serverless.utils.writeFileSync(
133.       coreTemplateFilePath,
134.       this.serverless.service.provider.compiledCloudFormationTemplate
135.     );
136. 
137.     this.serverless.service.provider.coreCloudFormationTemplate = _.cloneDeep(
138.       this.serverless.service.provider.compiledCloudFormationTemplate
139.     );
140. 
141.     return BbPromise.resolve();
142.   },
143. };


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 1 - 227
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const BbPromise = require('bluebird');
5. const path = require('path');
6. 
7. module.exports = {
8.   mergeIamTemplates() {
9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);
10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);
11.     return this.merge();
12.   },
13. 
14.   merge() {
15.     // resolve early if no functions are provided
16.     if (!this.serverless.service.getAllFunctions().length) {
17.       return BbPromise.resolve();
18.     }
19. 
20.     // create log group resources
21.     this.serverless.service.getAllFunctions().forEach(functionName => {
22.       const functionObject = this.serverless.service.getFunction(functionName);
23.       const logGroupLogicalId = this.provider.naming.getLogGroupLogicalId(functionName);
24.       const newLogGroup = {
25.         [logGroupLogicalId]: {
26.           Type: 'AWS::Logs::LogGroup',
27.           Properties: {
28.             LogGroupName: this.provider.naming.getLogGroupName(functionObject.name),
29.           },
30.         },
31.       };
32. 
33.       const logRetentionInDays = this.provider.getLogRetentionInDays();
34.       if (logRetentionInDays) {
35.         newLogGroup[logGroupLogicalId].Properties.RetentionInDays = logRetentionInDays;
36.       }
37. 
38.       _.merge(
39.         this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
40.         newLogGroup
41.       );
42.     });
43. 
44.     // resolve early if provider level role is provided
45.     if ('role' in this.serverless.service.provider) {
46.       return BbPromise.resolve();
47.     }
48. 
49.     // resolve early if all functions contain a custom role
50.     const customRolesProvided = [];
51.     this.serverless.service.getAllFunctions().forEach(functionName => {
52.       const functionObject = this.serverless.service.getFunction(functionName);
53.       customRolesProvided.push('role' in functionObject);
54.     });
55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {
56.       return BbPromise.resolve();
57.     }
58. 
59.     // merge in the iamRoleLambdaTemplate
60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(
61.       path.join(
62.         this.serverless.config.serverlessPath,
63.         'plugins',
64.         'aws',
65.         'package',
66.         'lib',
67.         'iam-role-lambda-execution-template.json'
68.       )
69.     );
70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();
71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();
72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();
73. 
74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,
76.     });
77. 
78.     const canonicalFunctionNamePrefix = `${
79.       this.provider.serverless.service.service
80.     }-${this.provider.getStage()}`;
81.     const logGroupsPrefix = this.provider.naming.getLogGroupName(canonicalFunctionNamePrefix);
82. 
83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate
84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument
85.       .Statement;
86. 
87.     let hasOneOrMoreCanonicallyNamedFunctions = false;
88. 
89.     // Ensure policies for functions with custom name resolution
90.     this.serverless.service.getAllFunctions().forEach(functionName => {
91.       const { name: resolvedFunctionName } = this.serverless.service.getFunction(functionName);
92.       if (!resolvedFunctionName || resolvedFunctionName.startsWith(canonicalFunctionNamePrefix)) {
93.         hasOneOrMoreCanonicallyNamedFunctions = true;
94.         return;
95.       }
96. 
97.       const customFunctionNamelogGroupsPrefix = this.provider.naming.getLogGroupName(
98.         resolvedFunctionName
99.       );
100. 
101.       policyDocumentStatements[0].Resource.push({
102.         'Fn::Sub':
103.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
104.           `:log-group:${customFunctionNamelogGroupsPrefix}:*`,
105.       });
106. 
107.       policyDocumentStatements[1].Resource.push({
108.         'Fn::Sub':
109.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
110.           `:log-group:${customFunctionNamelogGroupsPrefix}:*:*`,
111.       });
112.     });
113. 
114.     if (hasOneOrMoreCanonicallyNamedFunctions) {
115.       // Ensure general policies for functions with default name resolution
116.       policyDocumentStatements[0].Resource.push({
117.         'Fn::Sub':
118.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
119.           `:log-group:${logGroupsPrefix}*:*`,
120.       });
121. 
122.       policyDocumentStatements[1].Resource.push({
123.         'Fn::Sub':
124.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
125.           `:log-group:${logGroupsPrefix}*:*:*`,
126.       });
127.     }
128. 
129.     if (this.serverless.service.provider.iamRoleStatements) {
130.       // add custom iam role statements
131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
132.         this.provider.naming.getRoleLogicalId()
133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(
134.         this.serverless.service.provider.iamRoleStatements
135.       );
136.     }
137. 
138.     if (this.serverless.service.provider.iamManagedPolicies) {
139.       // add iam managed policies
140.       const iamManagedPolicies = this.serverless.service.provider.iamManagedPolicies;
141.       if (iamManagedPolicies.length > 0) {
142.         this.mergeManagedPolicies(iamManagedPolicies);
143.       }
144.     }
145. 
146.     // check if one of the functions contains vpc configuration
147.     const vpcConfigProvided = [];
148.     this.serverless.service.getAllFunctions().forEach(functionName => {
149.       const functionObject = this.serverless.service.getFunction(functionName);
150.       if ('vpc' in functionObject) {
151.         vpcConfigProvided.push(true);
152.       }
153.     });
154. 
155.     if (_.includes(vpcConfigProvided, true) || this.serverless.service.provider.vpc) {
156.       // add managed iam policy to allow ENI management
157.       this.mergeManagedPolicies([
158.         {
159.           'Fn::Join': [
160.             '',
161.             [
162.               'arn:',
163.               { Ref: 'AWS::Partition' },
164.               ':iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole',
165.             ],
166.           ],
167.         },
168.       ]);
169.     }
170. 
171.     return BbPromise.resolve();
172.   },
173. 
174.   mergeManagedPolicies(managedPolicies) {
175.     const resource = this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
176.       this.provider.naming.getRoleLogicalId()
177.     ].Properties;
178.     if (!_.has(resource, 'ManagedPolicyArns') || _.isEmpty(resource.ManagedPolicyArns)) {
179.       resource.ManagedPolicyArns = [];
180.     }
181.     resource.ManagedPolicyArns = resource.ManagedPolicyArns.concat(managedPolicies);
182.   },
183. 
184.   validateStatements(statements) {
185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
186.     // Action: ..., Resource: ... } objects.
187.     if (!statements) {
188.       return;
189.     }
190.     let violationsFound;
191.     if (!(statements instanceof Array)) {
192.       violationsFound = 'it is not an array';
193.     } else {
194.       const descriptions = statements.map((statement, i) => {
195.         const missing = ['Effect', 'Action', 'Resource'].filter(
196.           prop => statement[prop] === undefined
197.         );
198.         return missing.length === 0
199.           ? null
200.           : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
201.       });
202.       const flawed = descriptions.filter(curr => curr);
203.       if (flawed.length) {
204.         violationsFound = flawed.join('; ');
205.       }
206.     }
207. 
208.     if (violationsFound) {
209.       const errorMessage = [
210.         'iamRoleStatements should be an array of objects,',
211.         ' where each object has Effect, Action, Resource fields.',
212.         ` Specifically, ${violationsFound}`,
213.       ].join('');
214.       throw new this.serverless.classes.Error(errorMessage);
215.     }
216.   },
217. 
218.   validateManagedPolicies(iamManagedPolicies) {
219.     // Verify that iamManagedPolicies (if present) is an array
220.     if (!iamManagedPolicies) {
221.       return;
222.     }
223.     if (!_.isArray(iamManagedPolicies)) {
224.       throw new this.serverless.classes.Error('iamManagedPolicies should be an array of arns');
225.     }
226.   },
227. };


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const AWS = require('aws-sdk');
4. const BbPromise = require('bluebird');
5. const HttpsProxyAgent = require('https-proxy-agent');
6. const url = require('url');
7. const chalk = require('chalk');
8. const _ = require('lodash');
9. const userStats = require('../../../utils/userStats');
10. const naming = require('../lib/naming.js');
11. const https = require('https');
12. const fs = require('fs');
13. const objectHash = require('object-hash');
14. const PromiseQueue = require('promise-queue');
15. const getS3EndpointForRegion = require('../utils/getS3EndpointForRegion');
16. const readline = require('readline');
17. 
18. const constants = {
19.   providerName: 'aws',
20. };
21. 
22. PromiseQueue.configure(BbPromise.Promise);
23. 
24. const impl = {
25.   /**
26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid
27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for
28.    * whak-a-mole!
29.    * @param credentials The credentials to test for validity
30.    * @return {boolean} Whether the given credentials were valid
31.    */
32.   validCredentials: credentials => {
33.     let result = false;
34.     if (credentials) {
35.       if (
36.         // valid credentials loaded
37.         (credentials.accessKeyId &&
38.           credentials.accessKeyId !== 'undefined' &&
39.           credentials.secretAccessKey &&
40.           credentials.secretAccessKey !== 'undefined') ||
41.         // a role to assume has been successfully loaded, the associated STS request has been
42.         // sent, and the temporary credentials will be asynchronously delivered.
43.         credentials.roleArn
44.       ) {
45.         result = true;
46.       }
47.     }
48.     return result;
49.   },
50.   /**
51.    * Add credentials, if present, to the given results
52.    * @param results The results to add the given credentials to if they are valid
53.    * @param credentials The credentials to validate and add to the results if valid
54.    */
55.   addCredentials: (results, credentials) => {
56.     if (impl.validCredentials(credentials)) {
57.       results.credentials = credentials; // eslint-disable-line no-param-reassign
58.     }
59.   },
60.   /**
61.    * Add credentials, if present, from the environment
62.    * @param results The results to add environment credentials to
63.    * @param prefix The environment variable prefix to use in extracting credentials
64.    */
65.   addEnvironmentCredentials: (results, prefix) => {
66.     if (prefix) {
67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);
68.       impl.addCredentials(results, environmentCredentials);
69.     }
70.   },
71.   /**
72.    * Add credentials from a profile, if the profile and credentials for it exists
73.    * @param results The results to add profile credentials to
74.    * @param profile The profile to load credentials from
75.    */
76.   addProfileCredentials: (results, profile) => {
77.     if (profile) {
78.       const params = { profile };
79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {
80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;
81.       }
82. 
83.       // Setup a MFA callback for asking the code from the user.
84.       params.tokenCodeFn = (mfaSerial, callback) => {
85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {
87.           rl.close();
88.           callback(null, answer);
89.         });
90.       };
91. 
92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);
93.       if (
94.         !(
95.           profileCredentials.accessKeyId ||
96.           profileCredentials.sessionToken ||
97.           profileCredentials.roleArn
98.         )
99.       ) {
100.         throw new Error(`Profile ${profile} does not exist`);
101.       }
102. 
103.       impl.addCredentials(results, profileCredentials);
104.     }
105.   },
106.   /**
107.    * Add credentials, if present, from a profile that is specified within the environment
108.    * @param results The prefix of the profile's declaration in the environment
109.    * @param prefix The prefix for the environment variable
110.    */
111.   addEnvironmentProfile: (results, prefix) => {
112.     if (prefix) {
113.       const profile = process.env[`${prefix}_PROFILE`];
114.       impl.addProfileCredentials(results, profile);
115.     }
116.   },
117. };
118. 
119. class AwsProvider {
120.   static getProviderName() {
121.     return constants.providerName;
122.   }
123. 
124.   constructor(serverless, options) {
125.     this.naming = { provider: this };
126.     this.options = options;
127.     this.provider = this; // only load plugin in an AWS service context
128.     this.serverless = serverless;
129.     this.sdk = AWS;
130.     this.serverless.setProvider(constants.providerName, this);
131.     if (this.serverless.service.provider.name === 'aws') {
132.       this.serverless.service.provider.region = this.getRegion();
133.     }
134.     this.requestCache = {};
135.     this.requestQueue = new PromiseQueue(2, Infinity);
136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).
137.     this.cachedCredentials = null;
138. 
139.     Object.assign(this.naming, naming);
140. 
141.     // Activate AWS SDK loggin
142.     if (process.env.SLS_DEBUG) {
143.       AWS.config.logger = this.serverless.cli;
144.     }
145. 
146.     // Use HTTPS Proxy (Optional)
147.     const proxy =
148.       process.env.proxy ||
149.       process.env.HTTP_PROXY ||
150.       process.env.http_proxy ||
151.       process.env.HTTPS_PROXY ||
152.       process.env.https_proxy;
153. 
154.     const proxyOptions = {};
155.     if (proxy) {
156.       Object.assign(proxyOptions, url.parse(proxy));
157.     }
158. 
159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;
160. 
161.     let caCerts = [];
162. 
163.     if (ca) {
164.       // Can be a single certificate or multiple, comma separated.
165.       const caArr = ca.split(',');
166.       // Replace the newline -- https://stackoverflow.com/questions/30400341
167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\n/g, '\n')));
168.     }
169. 
170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;
171. 
172.     if (cafile) {
173.       // Can be a single certificate file path or multiple paths, comma separated.
174.       const caPathArr = cafile.split(',');
175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));
176.     }
177. 
178.     if (caCerts.length > 0) {
179.       Object.assign(proxyOptions, {
180.         rejectUnauthorized: true,
181.         ca: caCerts,
182.       });
183.     }
184. 
185.     // Passes also certifications
186.     if (proxy) {
187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);
188.     } else if (proxyOptions.ca) {
189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html
190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);
191.     }
192. 
193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)
194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;
195.     if (timeout) {
196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);
197.     }
198. 
199.     // Support deploymentBucket configuration as an object
200.     const provider = this.serverless.service.provider;
201.     if (provider && provider.deploymentBucket) {
202.       if (_.isObject(provider.deploymentBucket)) {
203.         // store the object in a new variable so that it can be reused later on
204.         provider.deploymentBucketObject = provider.deploymentBucket;
205.         if (provider.deploymentBucket.name) {
206.           // (re)set the value of the deploymentBucket property to the name (which is a string)
207.           provider.deploymentBucket = provider.deploymentBucket.name;
208.         } else {
209.           provider.deploymentBucket = null;
210.         }
211.       }
212.     }
213.   }
214. 
215.   /**
216.    * Execute an AWS request by calling the AWS SDK
217.    * @param {string} service - Service name
218.    * @param {string} method - Method name
219.    * @param {Object} params - Parameters
220.    * @param {Object} [options] - Options to modify the request behavior
221.    * @prop [options.useCache] - Utilize cache to retrieve results
222.    * @prop [options.region] - Specify when to request to different region
223.    */
224.   request(service, method, params, options) {
225.     const that = this;
226.     const credentials = Object.assign({}, that.getCredentials());
227.     // Make sure options is an object (honors wrong calls of request)
228.     const requestOptions = _.isObject(options) ? options : {};
229.     const shouldCache = _.get(requestOptions, 'useCache', false);
230.     const paramsWithRegion = _.merge({}, params, {
231.       region: _.get(options, 'region'),
232.     });
233.     const paramsHash = objectHash.sha1(paramsWithRegion);
234.     const MAX_TRIES = 4;
235.     const persistentRequest = f =>
236.       new BbPromise((resolve, reject) => {
237.         const doCall = numTry => {
238.           f()
239.             // We're resembling if/else logic, therefore single `then` instead of `then`/`catch` pair
240.             .then(resolve, e => {
241.               if (
242.                 numTry < MAX_TRIES &&
243.                 e.statusCode !== 403 && // Invalid credentials
244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)
245.               ) {
246.                 that.serverless.cli.log(
247.                   _.join(
248.                     [
249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,
250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,
251.                     ],
252.                     ' '
253.                   )
254.                 );
255.                 setTimeout(doCall, 5000, numTry + 1);
256.               } else {
257.                 reject(e);
258.               }
259.             });
260.         };
261.         return doCall(0);
262.       });
263. 
264.     // Emit a warning for misuses of the old signature including stage and region
265.     // TODO: Determine calling module and log that
266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {
267.       this.serverless.cli.log('WARNING: Inappropriate call of provider.request()');
268.     }
269. 
270.     // Support S3 Transfer Acceleration
271.     if (this.canUseS3TransferAcceleration(service, method)) {
272.       this.enableS3TransferAcceleration(credentials);
273.     }
274. 
275.     if (shouldCache) {
276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);
277.       if (cachedRequest) {
278.         return BbPromise.resolve(cachedRequest);
279.       }
280.     }
281. 
282.     const request = this.requestQueue.add(() =>
283.       persistentRequest(() => {
284.         if (options && !_.isUndefined(options.region)) {
285.           credentials.region = options.region;
286.         }
287.         const awsService = new that.sdk[service](credentials);
288.         const req = awsService[method](params);
289. 
290.         // TODO: Add listeners, put Debug statments here...
291.         // req.on('send', function (r) {console.log(r)});
292. 
293.         const promise = req.promise
294.           ? req.promise()
295.           : BbPromise.fromCallback(cb => {
296.               req.send(cb);
297.             });
298.         return promise.catch(err => {
299.           let message = err.message !== null ? err.message : err.code;
300.           if (err.message === 'Missing credentials in config') {
301.             const errorMessage = [
302.               'AWS provider credentials not found.',
303.               ' Learn how to set up AWS provider credentials',
304.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
305.             ].join('');
306.             message = errorMessage;
307.             userStats.track('user_awsCredentialsNotFound');
308.             // We do not want to trigger the retry mechanism for credential errors
309.             return BbPromise.reject(
310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
311.                 providerError: _.assign({}, err, { retryable: false }),
312.               })
313.             );
314.           }
315. 
316.           return BbPromise.reject(
317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
318.               providerError: err,
319.             })
320.           );
321.         });
322.       }).then(data => {
323.         const result = BbPromise.resolve(data);
324.         if (shouldCache) {
325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);
326.         }
327.         return result;
328.       })
329.     );
330. 
331.     if (shouldCache) {
332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);
333.     }
334. 
335.     return request;
336.   }
337. 
338.   /**
339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the
340.    * well known environment variables
341.    * @returns {{region: *}}
342.    */
343.   getCredentials() {
344.     if (this.cachedCredentials) {
345.       // We have already created the credentials object once, so return it.
346.       return this.cachedCredentials;
347.     }
348.     const result = {};
349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;
350. 
351.     // add specified credentials, overriding with more specific declarations
352.     try {
353.       impl.addProfileCredentials(result, 'default');
354.     } catch (err) {
355.       if (err.message !== 'Profile default does not exist') {
356.         throw err;
357.       }
358.     }
359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds
360.     if (this.serverless.service.provider.profile && !this.options['aws-profile']) {
361.       // config profile
362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);
363.     }
364.     impl.addEnvironmentCredentials(result, 'AWS'); // creds for all stages
365.     impl.addEnvironmentProfile(result, 'AWS');
366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds
367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);
368.     if (this.options['aws-profile']) {
369.       impl.addProfileCredentials(result, this.options['aws-profile']); // CLI option profile
370.     }
371.     result.region = this.getRegion();
372. 
373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;
374.     if (
375.       deploymentBucketObject &&
376.       deploymentBucketObject.serverSideEncryption &&
377.       deploymentBucketObject.serverSideEncryption === 'aws:kms'
378.     ) {
379.       result.signatureVersion = 'v4';
380.     }
381. 
382.     // Store the credentials to avoid creating them again (messes up MFA).
383.     this.cachedCredentials = result;
384.     return result;
385.   }
386. 
387.   canUseS3TransferAcceleration(service, method) {
388.     // TODO enable more S3 APIs?
389.     return (
390.       service === 'S3' &&
391.       ['upload', 'putObject'].indexOf(method) !== -1 &&
392.       this.isS3TransferAccelerationEnabled()
393.     );
394.   }
395. 
396.   // This function will be used to block the addition of transfer acceleration options
397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)
398.   isS3TransferAccelerationSupported() {
399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)
400.     // since those regions do not yet support it
401.     const endpoint = getS3EndpointForRegion(this.getRegion());
402.     return endpoint === 's3.amazonaws.com';
403.   }
404. 
405.   isS3TransferAccelerationEnabled() {
406.     return !!this.options['aws-s3-accelerate'];
407.   }
408. 
409.   isS3TransferAccelerationDisabled() {
410.     return !!this.options['no-aws-s3-accelerate'];
411.   }
412. 
413.   disableTransferAccelerationForCurrentDeploy() {
414.     delete this.options['aws-s3-accelerate'];
415.   }
416. 
417.   enableS3TransferAcceleration(credentials) {
418.     this.serverless.cli.log('Using S3 Transfer Acceleration Endpoint...');
419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign
420.   }
421. 
422.   getValues(source, paths) {
423.     return paths.map(path => ({
424.       path,
425.       value: _.get(source, path.join('.')),
426.     }));
427.   }
428.   firstValue(values) {
429.     return values.reduce((result, current) => {
430.       return result.value ? result : current;
431.     }, {});
432.   }
433. 
434.   getRegionSourceValue() {
435.     const values = this.getValues(this, [
436.       ['options', 'region'],
437.       ['serverless', 'config', 'region'],
438.       ['serverless', 'service', 'provider', 'region'],
439.     ]);
440.     return this.firstValue(values);
441.   }
442.   getRegion() {
443.     const defaultRegion = 'us-east-1';
444.     const regionSourceValue = this.getRegionSourceValue();
445.     return regionSourceValue.value || defaultRegion;
446.   }
447. 
448.   getProfileSourceValue() {
449.     const values = this.getValues(this, [
450.       ['options', 'aws-profile'],
451.       ['options', 'profile'],
452.       ['serverless', 'config', 'profile'],
453.       ['serverless', 'service', 'provider', 'profile'],
454.     ]);
455.     const firstVal = this.firstValue(values);
456.     return firstVal ? firstVal.value : null;
457.   }
458.   getProfile() {
459.     return this.getProfileSourceValue();
460.   }
461. 
462.   getServerlessDeploymentBucketName() {
463.     if (this.serverless.service.provider.deploymentBucket) {
464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);
465.     }
466.     return this.request('CloudFormation', 'describeStackResource', {
467.       StackName: this.naming.getStackName(),
468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),
469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);
470.   }
471. 
472.   getDeploymentPrefix() {
473.     return this.serverless.service.provider.deploymentPrefix || 'serverless';
474.   }
475. 
476.   getLogRetentionInDays() {
477.     if (!_.has(this.serverless.service.provider, 'logRetentionInDays')) {
478.       return null;
479.     }
480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;
481.     const retentionInDays = parseInt(rawRetentionInDays, 10);
482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {
483.       return retentionInDays;
484.     }
485. 
486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;
487.     throw new this.serverless.classes.Error(errorMessage);
488.   }
489. 
490.   getStageSourceValue() {
491.     const values = this.getValues(this, [
492.       ['options', 'stage'],
493.       ['serverless', 'config', 'stage'],
494.       ['serverless', 'service', 'provider', 'stage'],
495.     ]);
496.     return this.firstValue(values);
497.   }
498.   getStage() {
499.     const defaultStage = 'dev';
500.     const stageSourceValue = this.getStageSourceValue();


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 500 - 1000
Content:
500.     const stageSourceValue = this.getStageSourceValue();
501.     return stageSourceValue.value || defaultStage;
502.   }
503. 
504.   getAccountId() {
505.     return this.getAccountInfo().then(result => result.accountId);
506.   }
507. 
508.   getAccountInfo() {
509.     return this.request('STS', 'getCallerIdentity', {}).then(result => {
510.       const arn = result.Arn;
511.       const accountId = result.Account;
512.       const partition = _.nth(_.split(arn, ':'), 1); // ex: arn:aws:iam:acctId:user/xyz
513.       return {
514.         accountId,
515.         partition,
516.         arn: result.Arn,
517.         userId: result.UserId,
518.       };
519.     });
520.   }
521. 
522.   /**
523.    * Get API Gateway Rest API ID from serverless config
524.    */
525.   getApiGatewayRestApiId() {
526.     if (
527.       this.serverless.service.provider.apiGateway &&
528.       this.serverless.service.provider.apiGateway.restApiId
529.     ) {
530.       return this.serverless.service.provider.apiGateway.restApiId;
531.     }
532. 
533.     return { Ref: this.naming.getRestApiLogicalId() };
534.   }
535. 
536.   getApiGatewayDescription() {
537.     if (
538.       this.serverless.service.provider.apiGateway &&
539.       this.serverless.service.provider.apiGateway.description
540.     ) {
541.       return this.serverless.service.provider.apiGateway.description;
542.     }
543.     return undefined;
544.   }
545. 
546.   getMethodArn(accountId, apiId, method, pathParam) {
547.     const region = this.getRegion();
548.     let path = pathParam;
549.     if (pathParam.startsWith('/')) {
550.       path = pathParam.replace(/^\/+/g, '');
551.     }
552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;
553.   }
554. 
555.   /**
556.    * Get Rest API Root Resource ID from serverless config
557.    */
558.   getApiGatewayRestApiRootResourceId() {
559.     if (
560.       this.serverless.service.provider.apiGateway &&
561.       this.serverless.service.provider.apiGateway.restApiRootResourceId
562.     ) {
563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;
564.     }
565.     return { 'Fn::GetAtt': [this.naming.getRestApiLogicalId(), 'RootResourceId'] };
566.   }
567. 
568.   /**
569.    * Get Rest API Predefined Resources from serverless config
570.    */
571.   getApiGatewayPredefinedResources() {
572.     if (
573.       !this.serverless.service.provider.apiGateway ||
574.       !this.serverless.service.provider.apiGateway.restApiResources
575.     ) {
576.       return [];
577.     }
578. 
579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {
580.       return this.serverless.service.provider.apiGateway.restApiResources;
581.     }
582. 
583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== 'object') {
584.       throw new Error('REST API resource must be an array of object');
585.     }
586. 
587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({
588.       path: key,
589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],
590.     }));
591.   }
592. 
593.   /**
594.    * Get API Gateway websocket API ID from serverless config
595.    */
596.   getApiGatewayWebsocketApiId() {
597.     if (
598.       this.serverless.service.provider.apiGateway &&
599.       this.serverless.service.provider.apiGateway.websocketApiId
600.     ) {
601.       return this.serverless.service.provider.apiGateway.websocketApiId;
602.     }
603. 
604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };
605.   }
606. 
607.   getStackResources(next, resourcesParam) {
608.     let resources = resourcesParam;
609.     const params = {
610.       StackName: this.naming.getStackName(),
611.     };
612.     if (!resources) resources = [];
613.     if (next) params.NextToken = next;
614. 
615.     return this.request('CloudFormation', 'listStackResources', params).then(res => {
616.       const allResources = resources.concat(res.StackResourceSummaries);
617.       if (!res.NextToken) {
618.         return allResources;
619.       }
620.       return this.getStackResources(res.NextToken, allResources);
621.     });
622.   }
623. }
624. 
625. module.exports = AwsProvider;

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 21:02:09,796 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='This function validates provider.iamRoleStatements by enforcing presence of Effect, Action, and Resource properties. It directly answers the query about validation and demonstrates lack of support for NotAction/NotResource.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=184, end_line=216), ContextOutput(reasoning='This part retrieves the base PolicyDocument statements from the default IAM role, as a prerequisite to merging provider.iamRoleStatements.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=83, end_line=87), ContextOutput(reasoning='This is where provider.iamRoleStatements are merged into the default IAM role PolicyDocument, showing how IAM policy generation incorporates user-provided statements.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=129, end_line=136), ContextOutput(reasoning='Documentation describing provider.iamRoleStatements and how they are merged into the generated IAM policy, essential for understanding intended configuration.', relative_path='docs/providers/aws/guide/iam.md', start_line=23, end_line=48), ContextOutput(reasoning='Example serverless.yml demonstrating provider.iamRoleStatements usage, clarifying expected schema and merging behavior.', relative_path='docs/providers/aws/guide/serverless.yml.md', start_line=79, end_line=106), ContextOutput(reasoning='Functions guide includes a Permissions section referencing provider.iamRoleStatements, reinforcing that statements apply to the default execution role.', relative_path='docs/providers/aws/guide/functions.md', start_line=117, end_line=172), ContextOutput(reasoning='Custom resource role template shows PolicyDocument.Statement array initialization, needed to understand where IAM statements are added for custom resources.', relative_path='lib/plugins/aws/customResources/index.js', start_line=106, end_line=124), ContextOutput(reasoning='This segment pushes iamRoleStatements into the custom resource role PolicyDocument, showing IAM policy generation for custom resources.', relative_path='lib/plugins/aws/customResources/index.js', start_line=155, end_line=160), ContextOutput(reasoning='SQS event compiler defines an IAM statement to allow SQS receive/delete and lists Resource ARNs. It contributes to IAM policy generation.', relative_path='lib/plugins/aws/package/compile/events/sqs/index.js', start_line=17, end_line=23), ContextOutput(reasoning='SQS event compiler merges the generated SQS statement into the default IAM role PolicyDocument if used, demonstrating IAM policy augmentation.', relative_path='lib/plugins/aws/package/compile/events/sqs/index.js', start_line=124, end_line=170), ContextOutput(reasoning='Stream event compiler defines IAM statements for DynamoDB and Kinesis streams, showing their Action/Resource structure used in IAM generation.', relative_path='lib/plugins/aws/package/compile/events/stream/index.js', start_line=12, end_line=33), ContextOutput(reasoning='Stream event compiler merges stream statements into the default IAM role PolicyDocument, showing IAM policy generation mechanics.', relative_path='lib/plugins/aws/package/compile/events/stream/index.js', start_line=198, end_line=215), ContextOutput(reasoning='CloudFront event compiler augments the default IAM role with additional principals and log permissions, showing IAM-related modifications during compile.', relative_path='lib/plugins/aws/package/compile/events/cloudFront/index.js', start_line=186, end_line=214), ContextOutput(reasoning='Function compiler adds onError SNS publish permission to the IAM role when configured, showing IAM policy generation from function-level settings.', relative_path='lib/plugins/aws/package/compile/functions/index.js', start_line=206, end_line=240), ContextOutput(reasoning='Function compiler adds KMS decrypt permission to the IAM role when awsKmsKeyArn is set, illustrating IAM policy generation.', relative_path='lib/plugins/aws/package/compile/functions/index.js', start_line=271, end_line=289), ContextOutput(reasoning='Function compiler adds X-Ray permissions to the IAM role when tracing is enabled, further showing IAM policy generation.', relative_path='lib/plugins/aws/package/compile/functions/index.js', start_line=313, end_line=333), ContextOutput(reasoning='EventBridge compiler creates iamRoleStatements for custom resource operations (create/delete event bus, put/remove targets), used to build custom resource role policies.', relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', start_line=146, end_line=162), ContextOutput(reasoning='EventBridge compiler triggers adding the custom resource role with the collected iamRoleStatements.', relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', start_line=194, end_line=196), ContextOutput(reasoning='S3 compiler creates iamRoleStatements for bucket notification configuration and lambda permission management when using existing buckets.', relative_path='lib/plugins/aws/package/compile/events/s3/index.js', start_line=236, end_line=247), ContextOutput(reasoning='S3 compiler triggers adding the custom resource role with the collected iamRoleStatements.', relative_path='lib/plugins/aws/package/compile/events/s3/index.js', start_line=335, end_line=347), ContextOutput(reasoning='Cognito User Pool compiler triggers adding the custom resource role with the collected iamRoleStatements for existing user pool triggers.', relative_path='lib/plugins/aws/package/compile/events/cognitoUserPool/index.js', start_line=324, end_line=350)]
2025-11-13 21:02:09,804 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 21 contexts to memory for query: Please provide the full implementations that process provider.iamRoleStatements (validation and IAM policy generation), including lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, any IAM-related files under lib/plugins/aws/package/compile, and docs/providers/aws/guide/iam.md, with line numbers.
2025-11-13 21:02:10,122 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 21:02:10,123 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 21 new contexts to 0 existing contexts
2025-11-13 21:02:10,123 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 21 total contexts (removed 0 duplicates)
2025-11-13 21:02:10,125 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full implementations that process provider.iamRoleStatements (validation and IAM policy generation), including lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, any IAM-related files under lib/plugins/aws/package/compile, and docs/providers/aws/guide/iam.md, with line numbers.
Extra Requirements: If exact files differ, please share grep results for 'iamRoleStatements', 'NotAction', and 'NotResource' with matching file paths and surrounding code.
Purpose: To verify current behavior and intent regarding NotAction/NotResource so we can classify the issue correctly.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/guide/functions.md
Line number range: 117 - 172
Content:
117. 
118. ```yml
119. # foo-functions.yml
120. getFoo:
121.   handler: handler.foo
122. deleteFoo:
123.   handler: handler.foo
124. ```
125. 
126. ## Permissions
127. 
128. Every AWS Lambda function needs permission to interact with other AWS infrastructure resources within your account. These permissions are set via an AWS IAM Role. You can set permission policy statements within this role via the `provider.iamRoleStatements` property.
129. 
130. ```yml
131. # serverless.yml
132. service: myService
133. 
134. provider:
135.   name: aws
136.   runtime: nodejs10.x
137.   iamRoleStatements: # permissions for all of your functions can be set here
138.     - Effect: Allow
139.       Action: # Gives permission to DynamoDB tables in a specific region
140.         - dynamodb:DescribeTable
141.         - dynamodb:Query
142.         - dynamodb:Scan
143.         - dynamodb:GetItem
144.         - dynamodb:PutItem
145.         - dynamodb:UpdateItem
146.         - dynamodb:DeleteItem
147.       Resource: 'arn:aws:dynamodb:us-east-1:*:*'
148. 
149. functions:
150.   functionOne:
151.     handler: handler.functionOne
152.     memorySize: 512
153. ```
154. 
155. Another example:
156. 
157. ```yml
158. # serverless.yml
159. service: myService
160. provider:
161.   name: aws
162.   iamRoleStatements:
163.     - Effect: 'Allow'
164.       Action:
165.         - 's3:ListBucket'
166.       # You can put CloudFormation syntax in here.  No one will judge you.
167.       # Remember, this all gets translated to CloudFormation.
168.       Resource: { 'Fn::Join': ['', ['arn:aws:s3:::', { 'Ref': 'ServerlessDeploymentBucket' }]] }
169.     - Effect: 'Allow'
170.       Action:
171.         - 's3:PutObject'
172.       Resource:


File: docs/providers/aws/guide/iam.md
Line number range: 23 - 48
Content:
23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
24. 
25. ```yml
26. service: new-service
27. 
28. provider:
29.   name: aws
30.   iamRoleStatements:
31.     - Effect: 'Allow'
32.       Action:
33.         - 's3:ListBucket'
34.       Resource:
35.         Fn::Join:
36.           - ''
37.           - - 'arn:aws:s3:::'
38.             - Ref: ServerlessDeploymentBucket
39.     - Effect: 'Allow'
40.       Action:
41.         - 's3:PutObject'
42.       Resource:
43.         Fn::Join:
44.           - ''
45.           - - 'arn:aws:s3:::'
46.             - Ref: ServerlessDeploymentBucket
47.             - '/*'
48. ```


File: docs/providers/aws/guide/serverless.yml.md
Line number range: 79 - 106
Content:
79.       limit: 5000
80.       offset: 2
81.       period: MONTH
82.     throttle:
83.       burstLimit: 200
84.       rateLimit: 100
85.   stackTags: # Optional CF stack tags
86.     key: value
87.   iamManagedPolicies: # Optional IAM Managed Policies, which allows to include the policies into IAM Role
88.     - arn:aws:iam:*****:policy/some-managed-policy
89.   iamRoleStatements: # IAM role statements so that services can be accessed in the AWS account
90.     - Effect: 'Allow'
91.       Action:
92.         - 's3:ListBucket'
93.       Resource:
94.         Fn::Join:
95.           - ''
96.           - - 'arn:aws:s3:::'
97.             - Ref: ServerlessDeploymentBucket
98.   stackPolicy: # Optional CF stack policy. The example below allows updates to all resources except deleting/replacing EC2 instances (use with caution!)
99.     - Effect: Allow
100.       Principal: '*'
101.       Action: 'Update:*'
102.       Resource: '*'
103.     - Effect: Deny
104.       Principal: '*'
105.       Resource: '*'
106.       Action:


File: lib/plugins/aws/customResources/index.js
Line number range: 106 - 124
Content:
106.             Policies: [
107.               {
108.                 PolicyName: {
109.                   'Fn::Join': [
110.                     '-',
111.                     [
112.                       awsProvider.getStage(),
113.                       awsProvider.serverless.service.service,
114.                       'custom-resources-lambda',
115.                     ],
116.                   ],
117.                 },
118.                 PolicyDocument: {
119.                   Version: '2012-10-17',
120.                   Statement: [],
121.                 },
122.               },
123.             ],
124.           },


File: lib/plugins/aws/customResources/index.js
Line number range: 155 - 160
Content:
155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
156.       iamRoleStatements.forEach(newStmt => {
157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
158.           Statement.push(newStmt);
159.         }
160.       });


File: lib/plugins/aws/package/compile/events/cloudFront/index.js
Line number range: 186 - 214
Content:
186.                   LambdaFunctionARN: {
187.                     Ref: lambdaVersionLogicalId,
188.                   },
189.                 },
190.               ],
191.             };
192. 
193.             if (pathPattern) {
194.               Object.assign(behavior, { PathPattern: pathPattern });
195.             }
196. 
197.             const existingBehaviour = behaviors.find(
198.               o =>
199.                 o.PathPattern === behavior.PathPattern &&
200.                 o.TargetOriginId === behavior.TargetOriginId
201.             );
202. 
203.             if (!existingBehaviour) {
204.               behaviors.push(behavior);
205.             } else {
206.               behavior = extendDeep(existingBehaviour, behavior);
207.             }
208. 
209.             lambdaAtEdgeFunctions.push(
210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })
211.             );
212.           }
213.         });
214.       }


File: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js
Line number range: 324 - 350
Content:
324.           LambdaConfig: lambdaConfig,
325.         },
326.         DependsOn,
327.       },
328.     };
329.   }
330. 
331.   mergeWithCustomResources() {
332.     const result = this.findUserPoolsAndFunctions();
333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
334.     const userPools = result.userPools;
335. 
336.     _.forEach(userPools, poolName => {
337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });
338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);
339. 
340.       // If overrides exist in `Resources`, merge them in
341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {
342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];
343.         const generatedUserPool = this.generateTemplateForPool(
344.           poolName,
345.           currentPoolTriggerFunctions
346.         )[userPoolLogicalId];
347. 
348.         // Merge `DependsOn` clauses
349.         const customUserPoolDependsOn = _.get(customUserPool, 'DependsOn', []);
350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 146 - 162
Content:
146.                 iamRoleStatements.push({
147.                   Effect: 'Allow',
148.                   Resource: eventBusResource,
149.                   Action: ['events:CreateEventBus', 'events:DeleteEventBus'],
150.                 });
151.               }
152. 
153.               iamRoleStatements.push({
154.                 Effect: 'Allow',
155.                 Resource: ruleResource,
156.                 Action: [
157.                   'events:PutRule',
158.                   'events:RemoveTargets',
159.                   'events:PutTargets',
160.                   'events:DeleteRule',
161.                 ],
162.               });


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 194 - 196
Content:
194.     if (iamRoleStatements.length) {
195.       return addCustomResourceToService(this.provider, 'eventBridge', iamRoleStatements);
196.     }


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 236 - 247
Content:
236.             rules = _.map(event.s3.rules, rule => {
237.               const key = Object.keys(rule)[0];
238.               const value = rule[key];
239.               return {
240.                 [_.startCase(key)]: value,
241.               };
242.             });
243. 
244.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
245.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceS3HandlerFunctionLogicalId();
246.             const customS3ResourceLogicalId = this.provider.naming.getCustomResourceS3ResourceLogicalId(
247.               functionName


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 335 - 347
Content:
335.             }
336.           });
337.         }
338.       });
339.     }
340. 
341.     if (iamRoleStatements.length) {
342.       return addCustomResourceToService(this.provider, 's3', iamRoleStatements);
343.     }
344. 
345.     return null;
346.   }
347. }


File: lib/plugins/aws/package/compile/events/sqs/index.js
Line number range: 17 - 23
Content:
17.       const functionObj = this.serverless.service.getFunction(functionName);
18. 
19.       if (functionObj.events) {
20.         const sqsStatement = {
21.           Effect: 'Allow',
22.           Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
23.           Resource: [],


File: lib/plugins/aws/package/compile/events/sqs/index.js
Line number range: 124 - 170
Content:
124.             const sqsTemplate = `
125.               {
126.                 "Type": "AWS::Lambda::EventSourceMapping",
127.                 "DependsOn": ${dependsOn},
128.                 "Properties": {
129.                   "BatchSize": ${BatchSize},
130.                   "EventSourceArn": ${JSON.stringify(EventSourceArn)},
131.                   "FunctionName": {
132.                     "Fn::GetAtt": [
133.                       "${lambdaLogicalId}",
134.                       "Arn"
135.                     ]
136.                   },
137.                   "Enabled": "${Enabled}"
138.                 }
139.               }
140.             `;
141. 
142.             // add event source ARNs to PolicyDocument statements
143.             sqsStatement.Resource.push(EventSourceArn);
144. 
145.             const newSQSObject = {
146.               [queueLogicalId]: JSON.parse(sqsTemplate),
147.             };
148. 
149.             _.merge(
150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
151.               newSQSObject
152.             );
153.           }
154.         });
155. 
156.         // update the PolicyDocument statements (if default policy is used)
157.         if (
158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources
159.             .IamRoleLambdaExecution
160.         ) {
161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate
162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
163.           if (sqsStatement.Resource.length) {
164.             statement.push(sqsStatement);
165.           }
166.         }
167.       }
168.     });
169.   }
170. }


File: lib/plugins/aws/package/compile/events/stream/index.js
Line number range: 12 - 33
Content:
12.     };
13.   }
14. 
15.   compileStreamEvents() {
16.     this.serverless.service.getAllFunctions().forEach(functionName => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18. 
19.       if (functionObj.events) {
20.         const dynamodbStreamStatement = {
21.           Effect: 'Allow',
22.           Action: [
23.             'dynamodb:GetRecords',
24.             'dynamodb:GetShardIterator',
25.             'dynamodb:DescribeStream',
26.             'dynamodb:ListStreams',
27.           ],
28.           Resource: [],
29.         };
30.         const kinesisStreamStatement = {
31.           Effect: 'Allow',
32.           Action: [
33.             'kinesis:GetRecords',


File: lib/plugins/aws/package/compile/events/stream/index.js
Line number range: 198 - 215
Content:
198.             }
199. 
200.             const newStreamObject = {
201.               [streamLogicalId]: streamResource,
202.             };
203. 
204.             _.merge(
205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
206.               newStreamObject
207.             );
208.           }
209.         });
210. 
211.         // update the PolicyDocument statements (if default policy is used)
212.         if (
213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.             .IamRoleLambdaExecution
215.         ) {


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 206 - 240
Content:
206.     if (functionObject.onError) {
207.       const arn = functionObject.onError;
208. 
209.       if (typeof arn === 'string') {
210.         const splittedArn = arn.split(':');
211.         if (splittedArn[0] === 'arn' && (splittedArn[2] === 'sns' || splittedArn[2] === 'sqs')) {
212.           const dlqType = splittedArn[2];
213.           const iamRoleLambdaExecution = this.serverless.service.provider
214.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
215.           let stmt;
216. 
217.           newFunction.Properties.DeadLetterConfig = {
218.             TargetArn: arn,
219.           };
220. 
221.           if (dlqType === 'sns') {
222.             stmt = {
223.               Effect: 'Allow',
224.               Action: ['sns:Publish'],
225.               Resource: [arn],
226.             };
227.           } else if (dlqType === 'sqs') {
228.             const errorMessage = [
229.               'onError currently only supports SNS topic arns due to a',
230.               ' race condition when using SQS queue arns and updating the IAM role.',
231.               ' Please check the docs for more info.',
232.             ].join('');
233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
234.           }
235. 
236.           // update the PolicyDocument statements (if default policy is used)
237.           if (iamRoleLambdaExecution) {
238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);
239.           }
240.         } else {


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 271 - 289
Content:
271.           const iamRoleLambdaExecution = this.serverless.service.provider
272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
273. 
274.           newFunction.Properties.KmsKeyArn = arn;
275. 
276.           const stmt = {
277.             Effect: 'Allow',
278.             Action: ['kms:Decrypt'],
279.             Resource: [arn],
280.           };
281. 
282.           // update the PolicyDocument statements (if default policy is used)
283.           if (iamRoleLambdaExecution) {
284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
286.               [stmt],
287.               _.isEqual
288.             );
289.           }


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 313 - 333
Content:
313.           .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
314. 
315.         newFunction.Properties.TracingConfig = {
316.           Mode: mode,
317.         };
318. 
319.         const stmt = {
320.           Effect: 'Allow',
321.           Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],
322.           Resource: ['*'],
323.         };
324. 
325.         // update the PolicyDocument statements (if default policy is used)
326.         if (iamRoleLambdaExecution) {
327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
329.             [stmt],
330.             _.isEqual
331.           );
332.         }
333.       } else {


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 83 - 87
Content:
83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate
84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument
85.       .Statement;
86. 
87.     let hasOneOrMoreCanonicallyNamedFunctions = false;


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 129 - 136
Content:
129.     if (this.serverless.service.provider.iamRoleStatements) {
130.       // add custom iam role statements
131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
132.         this.provider.naming.getRoleLogicalId()
133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(
134.         this.serverless.service.provider.iamRoleStatements
135.       );
136.     }


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 184 - 216
Content:
184.   validateStatements(statements) {
185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
186.     // Action: ..., Resource: ... } objects.
187.     if (!statements) {
188.       return;
189.     }
190.     let violationsFound;
191.     if (!(statements instanceof Array)) {
192.       violationsFound = 'it is not an array';
193.     } else {
194.       const descriptions = statements.map((statement, i) => {
195.         const missing = ['Effect', 'Action', 'Resource'].filter(
196.           prop => statement[prop] === undefined
197.         );
198.         return missing.length === 0
199.           ? null
200.           : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
201.       });
202.       const flawed = descriptions.filter(curr => curr);
203.       if (flawed.length) {
204.         violationsFound = flawed.join('; ');
205.       }
206.     }
207. 
208.     if (violationsFound) {
209.       const errorMessage = [
210.         'iamRoleStatements should be an array of objects,',
211.         ' where each object has Effect, Action, Resource fields.',
212.         ` Specifically, ${violationsFound}`,
213.       ].join('');
214.       throw new this.serverless.classes.Error(errorMessage);
215.     }
216.   },

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 21:02:22,639 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The aggregated context includes the key implementation that validates provider.iamRoleStatements (mergeIamTemplates.validateStatements) which explicitly requires Effect, Action, and Resource, thereby rejecting NotAction/NotResource. It also shows where iamRoleStatements are merged into the policy and provides AWS docs examples that only use Action/Resource. This is sufficient to conclude the issue is a feature request to support NotAction/NotResource rather than a bug. No additional files or docs are essential for accurate classification.' query='' extra_requirements='' purpose='Sufficient context is available to classify the issue without requesting more.'
2025-11-13 21:02:22,643 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/guide/functions.md', content="117. \n118. ```yml\n119. # foo-functions.yml\n120. getFoo:\n121.   handler: handler.foo\n122. deleteFoo:\n123.   handler: handler.foo\n124. ```\n125. \n126. ## Permissions\n127. \n128. Every AWS Lambda function needs permission to interact with other AWS infrastructure resources within your account. These permissions are set via an AWS IAM Role. You can set permission policy statements within this role via the `provider.iamRoleStatements` property.\n129. \n130. ```yml\n131. # serverless.yml\n132. service: myService\n133. \n134. provider:\n135.   name: aws\n136.   runtime: nodejs10.x\n137.   iamRoleStatements: # permissions for all of your functions can be set here\n138.     - Effect: Allow\n139.       Action: # Gives permission to DynamoDB tables in a specific region\n140.         - dynamodb:DescribeTable\n141.         - dynamodb:Query\n142.         - dynamodb:Scan\n143.         - dynamodb:GetItem\n144.         - dynamodb:PutItem\n145.         - dynamodb:UpdateItem\n146.         - dynamodb:DeleteItem\n147.       Resource: 'arn:aws:dynamodb:us-east-1:*:*'\n148. \n149. functions:\n150.   functionOne:\n151.     handler: handler.functionOne\n152.     memorySize: 512\n153. ```\n154. \n155. Another example:\n156. \n157. ```yml\n158. # serverless.yml\n159. service: myService\n160. provider:\n161.   name: aws\n162.   iamRoleStatements:\n163.     - Effect: 'Allow'\n164.       Action:\n165.         - 's3:ListBucket'\n166.       # You can put CloudFormation syntax in here.  No one will judge you.\n167.       # Remember, this all gets translated to CloudFormation.\n168.       Resource: { 'Fn::Join': ['', ['arn:aws:s3:::', { 'Ref': 'ServerlessDeploymentBucket' }]] }\n169.     - Effect: 'Allow'\n170.       Action:\n171.         - 's3:PutObject'\n172.       Resource:", start_line_number=117, end_line_number=172), Context(relative_path='docs/providers/aws/guide/iam.md', content="23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: 'Allow'\n32.       Action:\n33.         - 's3:ListBucket'\n34.       Resource:\n35.         Fn::Join:\n36.           - ''\n37.           - - 'arn:aws:s3:::'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: 'Allow'\n40.       Action:\n41.         - 's3:PutObject'\n42.       Resource:\n43.         Fn::Join:\n44.           - ''\n45.           - - 'arn:aws:s3:::'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - '/*'\n48. ```", start_line_number=23, end_line_number=48), Context(relative_path='docs/providers/aws/guide/serverless.yml.md', content="79.       limit: 5000\n80.       offset: 2\n81.       period: MONTH\n82.     throttle:\n83.       burstLimit: 200\n84.       rateLimit: 100\n85.   stackTags: # Optional CF stack tags\n86.     key: value\n87.   iamManagedPolicies: # Optional IAM Managed Policies, which allows to include the policies into IAM Role\n88.     - arn:aws:iam:*****:policy/some-managed-policy\n89.   iamRoleStatements: # IAM role statements so that services can be accessed in the AWS account\n90.     - Effect: 'Allow'\n91.       Action:\n92.         - 's3:ListBucket'\n93.       Resource:\n94.         Fn::Join:\n95.           - ''\n96.           - - 'arn:aws:s3:::'\n97.             - Ref: ServerlessDeploymentBucket\n98.   stackPolicy: # Optional CF stack policy. The example below allows updates to all resources except deleting/replacing EC2 instances (use with caution!)\n99.     - Effect: Allow\n100.       Principal: '*'\n101.       Action: 'Update:*'\n102.       Resource: '*'\n103.     - Effect: Deny\n104.       Principal: '*'\n105.       Resource: '*'\n106.       Action:", start_line_number=79, end_line_number=106), Context(relative_path='lib/plugins/aws/customResources/index.js', content="106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   'Fn::Join': [\n110.                     '-',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       'custom-resources-lambda',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: '2012-10-17',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },", start_line_number=106, end_line_number=124), Context(relative_path='lib/plugins/aws/customResources/index.js', content='155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });', start_line_number=155, end_line_number=160), Context(relative_path='lib/plugins/aws/package/compile/events/cloudFront/index.js', content='186.                   LambdaFunctionARN: {\n187.                     Ref: lambdaVersionLogicalId,\n188.                   },\n189.                 },\n190.               ],\n191.             };\n192. \n193.             if (pathPattern) {\n194.               Object.assign(behavior, { PathPattern: pathPattern });\n195.             }\n196. \n197.             const existingBehaviour = behaviors.find(\n198.               o =>\n199.                 o.PathPattern === behavior.PathPattern &&\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }', start_line_number=186, end_line_number=214), Context(relative_path='lib/plugins/aws/package/compile/events/cognitoUserPool/index.js', content="324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, 'DependsOn', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);", start_line_number=324, end_line_number=350), Context(relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', content="146.                 iamRoleStatements.push({\n147.                   Effect: 'Allow',\n148.                   Resource: eventBusResource,\n149.                   Action: ['events:CreateEventBus', 'events:DeleteEventBus'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: 'Allow',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   'events:PutRule',\n158.                   'events:RemoveTargets',\n159.                   'events:PutTargets',\n160.                   'events:DeleteRule',\n161.                 ],\n162.               });", start_line_number=146, end_line_number=162), Context(relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', content="194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, 'eventBridge', iamRoleStatements);\n196.     }", start_line_number=194, end_line_number=196), Context(relative_path='lib/plugins/aws/package/compile/events/s3/index.js', content='236.             rules = _.map(event.s3.rules, rule => {\n237.               const key = Object.keys(rule)[0];\n238.               const value = rule[key];\n239.               return {\n240.                 [_.startCase(key)]: value,\n241.               };\n242.             });\n243. \n244.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n245.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceS3HandlerFunctionLogicalId();\n246.             const customS3ResourceLogicalId = this.provider.naming.getCustomResourceS3ResourceLogicalId(\n247.               functionName', start_line_number=236, end_line_number=247), Context(relative_path='lib/plugins/aws/package/compile/events/s3/index.js', content="335.             }\n336.           });\n337.         }\n338.       });\n339.     }\n340. \n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, 's3', iamRoleStatements);\n343.     }\n344. \n345.     return null;\n346.   }\n347. }", start_line_number=335, end_line_number=347), Context(relative_path='lib/plugins/aws/package/compile/events/sqs/index.js', content="17.       const functionObj = this.serverless.service.getFunction(functionName);\n18. \n19.       if (functionObj.events) {\n20.         const sqsStatement = {\n21.           Effect: 'Allow',\n22.           Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],\n23.           Resource: [],", start_line_number=17, end_line_number=23), Context(relative_path='lib/plugins/aws/package/compile/events/sqs/index.js', content='124.             const sqsTemplate = `\n125.               {\n126.                 "Type": "AWS::Lambda::EventSourceMapping",\n127.                 "DependsOn": ${dependsOn},\n128.                 "Properties": {\n129.                   "BatchSize": ${BatchSize},\n130.                   "EventSourceArn": ${JSON.stringify(EventSourceArn)},\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }', start_line_number=124, end_line_number=170), Context(relative_path='lib/plugins/aws/package/compile/events/stream/index.js', content="12.     };\n13.   }\n14. \n15.   compileStreamEvents() {\n16.     this.serverless.service.getAllFunctions().forEach(functionName => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18. \n19.       if (functionObj.events) {\n20.         const dynamodbStreamStatement = {\n21.           Effect: 'Allow',\n22.           Action: [\n23.             'dynamodb:GetRecords',\n24.             'dynamodb:GetShardIterator',\n25.             'dynamodb:DescribeStream',\n26.             'dynamodb:ListStreams',\n27.           ],\n28.           Resource: [],\n29.         };\n30.         const kinesisStreamStatement = {\n31.           Effect: 'Allow',\n32.           Action: [\n33.             'kinesis:GetRecords',", start_line_number=12, end_line_number=33), Context(relative_path='lib/plugins/aws/package/compile/events/stream/index.js', content='198.             }\n199. \n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {', start_line_number=198, end_line_number=215), Context(relative_path='lib/plugins/aws/package/compile/functions/index.js', content="206.     if (functionObject.onError) {\n207.       const arn = functionObject.onError;\n208. \n209.       if (typeof arn === 'string') {\n210.         const splittedArn = arn.split(':');\n211.         if (splittedArn[0] === 'arn' && (splittedArn[2] === 'sns' || splittedArn[2] === 'sqs')) {\n212.           const dlqType = splittedArn[2];\n213.           const iamRoleLambdaExecution = this.serverless.service.provider\n214.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n215.           let stmt;\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === 'sns') {\n222.             stmt = {\n223.               Effect: 'Allow',\n224.               Action: ['sns:Publish'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === 'sqs') {\n228.             const errorMessage = [\n229.               'onError currently only supports SNS topic arns due to a',\n230.               ' race condition when using SQS queue arns and updating the IAM role.',\n231.               ' Please check the docs for more info.',\n232.             ].join('');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {", start_line_number=206, end_line_number=240), Context(relative_path='lib/plugins/aws/package/compile/functions/index.js', content="271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: 'Allow',\n278.             Action: ['kms:Decrypt'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }", start_line_number=271, end_line_number=289), Context(relative_path='lib/plugins/aws/package/compile/functions/index.js', content="313.           .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n314. \n315.         newFunction.Properties.TracingConfig = {\n316.           Mode: mode,\n317.         };\n318. \n319.         const stmt = {\n320.           Effect: 'Allow',\n321.           Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],\n322.           Resource: ['*'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {", start_line_number=313, end_line_number=333), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content='83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n87.     let hasOneOrMoreCanonicallyNamedFunctions = false;', start_line_number=83, end_line_number=87), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content='129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }', start_line_number=129, end_line_number=136), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content="184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = 'it is not an array';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = ['Effect', 'Action', 'Resource'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join('; ');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         'iamRoleStatements should be an array of objects,',\n211.         ' where each object has Effect, Action, Resource fields.',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join('');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },", start_line_number=184, end_line_number=216)]
2025-11-13 21:02:31,409 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classifier_node - INFO - IssueClassifierNode classified the issue as: feature
2025-11-13 21:02:31,410 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - issue_type: feature
2025-11-13 21:02:31,412 - thread-135845298308800.prometheus.docker.base_container - INFO - Pulling docker image: ghcr.io/timesler/swe-polybench.eval.x86_64.serverless__serverless-6842:latest
2025-11-13 21:03:09,600 - thread-135845298308800.prometheus.docker.base_container - INFO - Tagging pulled image as: prometheus_user_defined_container_c0a369cf92
2025-11-13 21:03:09,610 - thread-135845298308800.prometheus.docker.base_container - INFO - Starting container from image prometheus_user_defined_container_c0a369cf92
2025-11-13 21:03:10,166 - thread-135845298308800.prometheus.docker.base_container - INFO - Starting persistent shell for interactive mode...
2025-11-13 21:03:10,524 - thread-135845298308800.prometheus.docker.base_container - INFO - Persistent shell is ready
2025-11-13 21:03:10,524 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_subgraph_node - INFO - Enter IssueFeatureSubgraphNode
2025-11-13 21:03:10,526 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - INFO - Enter bug_get_regression_tests_subgraph_node
2025-11-13 21:03:10,528 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_context_message_node - DEBUG - Sending query to context provider subgraph:
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

2025-11-13 21:03:10,528 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 21:03:10,529 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 21:03:26,693 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The file tree alone is insufficient to extract 8 concrete test cases with exact content and line numbers. The issue concerns AWS IAM role statements validation/packaging, likely covered by AWS plugin validation and packaging tests. To provide self-contained tests with imports, setup, and assertions, I need the actual content of the most relevant test files.' query='Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.' extra_requirements='If sending all files is too large, include at minimum all test blocks that reference iamRoleStatements or IAM policy elements (Action/Resource) with their imports and exact line numbers.' purpose='I need these test contents to identify 8 existing test cases related to IAM role statement validation/packaging and return them with exact imports and line numbers as regression tests.'
2025-11-13 21:03:26,695 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.
2025-11-13 21:03:27,256 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 21:03:27,256 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 21:03:27,256 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 21:03:27,256 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 21:03:27,257 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 21:03:27,258 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 21:03:27,258 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.
Extra requirements: If sending all files is too large, include at minimum all test blocks that reference iamRoleStatements or IAM policy elements (Action/Resource) with their imports and exact line numbers.
Purpose: I need these test contents to identify 8 existing test cases related to IAM role statement validation/packaging and return them with exact imports and line numbers as regression tests.
2025-11-13 21:03:30,117 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_DIDpt5bk8q2c5vdJBrvL1UZD', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/validate.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 165, 'prompt_tokens': 2281, 'total_tokens': 2446, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 128, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--41ac2c5a-09f5-4831-a348-b7ebcdb63160-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/validate.test.js'}, 'id': 'call_DIDpt5bk8q2c5vdJBrvL1UZD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2281, 'output_tokens': 165, 'total_tokens': 2446, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 128}}
2025-11-13 21:03:31,756 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7oKWgfwSbLJ2nbqm0ChTAeMo', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 36, 'prompt_tokens': 3612, 'total_tokens': 3648, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9bff6e78-aa34-41d2-b389-c03d7b4b5482-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/index.test.js'}, 'id': 'call_7oKWgfwSbLJ2nbqm0ChTAeMo', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3612, 'output_tokens': 36, 'total_tokens': 3648, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:03:35,092 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9PNqmTAQHDGTSOGZfivsHYp9', 'function': {'arguments': '{"relative_path":"tests/integration-package/cloudformation.tests.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 229, 'prompt_tokens': 5736, 'total_tokens': 5965, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6ce7cb40-207c-462d-b1b4-a35ba9d09054-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/integration-package/cloudformation.tests.js'}, 'id': 'call_9PNqmTAQHDGTSOGZfivsHYp9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5736, 'output_tokens': 229, 'total_tokens': 5965, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 21:03:47,740 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I retrieved the full contents (with exact line numbers) of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js. The integration test file includes IAM-related references to the Lambda execution role: Role with Fn::GetAtt at lines 44–46, 75–77, and 109–111, and DependsOn including IamRoleLambdaExecution at lines 50, 81, and 115–116. The other two files focus on validation and packaging hooks (including mergeIamTemplates), but do not include direct iamRoleStatements or IAM Action/Resource checks. You can use the displayed imports and line numbers from these outputs to identify and extract the relevant regression tests.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1314, 'prompt_tokens': 7397, 'total_tokens': 8711, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--03c962ba-4c7f-4978-89c5-02dae11376ab-0' usage_metadata={'input_tokens': 7397, 'output_tokens': 1314, 'total_tokens': 8711, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-13 21:03:47,744 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If sending all files is too large, include at minimum all test blocks that reference iamRoleStatements or IAM policy elements (Action/Resource) with their imports and exact line numbers.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need these test contents to identify 8 existing test cases related to IAM role statement validation/packaging and return them with exact imports and line numbers as regression tests.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/plugins/aws/lib/validate.test.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const chai = require('chai');
4. const AwsProvider = require('../provider/awsProvider');
5. const validate = require('../lib/validate');
6. const Serverless = require('../../../Serverless');
7. 
8. chai.use(require('chai-as-promised'));
9. 
10. const expect = chai.expect;
11. 
12. class MetadataService {
13.   request(error) {
14.     error('error');
15.   }
16. }
17. 
18. describe('#validate', () => {
19.   const serverless = new Serverless();
20.   let provider;
21.   const awsPlugin = {};
22. 
23.   beforeEach(() => {
24.     awsPlugin.options = {
25.       stage: 'dev',
26.       region: 'us-east-1',
27.     };
28.     provider = new AwsProvider(serverless, awsPlugin.options);
29.     provider.cachedCredentials = { accessKeyId: 'foo', secretAccessKey: 'bar' };
30.     awsPlugin.provider = provider;
31.     awsPlugin.provider.sdk = { MetadataService };
32.     awsPlugin.serverless = serverless;
33.     awsPlugin.serverless.setProvider('aws', provider);
34. 
35.     awsPlugin.serverless.config.servicePath = true;
36.     serverless.processedInput = { commands: ['deploy'] };
37. 
38.     Object.assign(awsPlugin, validate);
39.   });
40. 
41.   describe('#validate()', () => {
42.     it('should succeed if inside service (servicePath defined)', () =>
43.       expect(awsPlugin.validate()).to.be.fulfilled);
44. 
45.     it('should throw error if not inside service (servicePath not defined)', () => {
46.       awsPlugin.serverless.config.servicePath = false;
47.       return expect(awsPlugin.validate()).to.be.rejected;
48.     });
49. 
50.     // NOTE: starting here, test order is important
51. 
52.     it('should default to "dev" if stage is not provided', () => {
53.       awsPlugin.options.stage = false;
54.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
55.         expect(awsPlugin.provider.getStage()).to.equal('dev');
56.       });
57.     });
58. 
59.     it('should use the service.provider stage if present', () => {
60.       awsPlugin.options.stage = false;
61.       awsPlugin.serverless.service.provider = {
62.         stage: 'some-stage',
63.       };
64. 
65.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
66.         expect(awsPlugin.provider.getStage()).to.equal('some-stage');
67.       });
68.     });
69. 
70.     it('should default to "us-east-1" region if region is not provided', () => {
71.       awsPlugin.options.region = false;
72.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
73.         expect(awsPlugin.options.region).to.equal('us-east-1');
74.       });
75.     });
76. 
77.     it('should use the service.provider region if present', () => {
78.       awsPlugin.options.region = false;
79.       awsPlugin.serverless.service.provider = {
80.         region: 'some-region',
81.       };
82. 
83.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
84.         expect(awsPlugin.options.region).to.equal('some-region');
85.       });
86.     });
87. 
88.     it('should check the metadata service and throw an error if no creds and no metadata response', () => {
89.       awsPlugin.options.region = false;
90.       awsPlugin.serverless.service.provider = {
91.         region: 'some-region',
92.       };
93.       provider.cachedCredentials = {};
94. 
95.       return expect(awsPlugin.validate()).to.be.rejected.then(() => {
96.         expect(awsPlugin.options.region).to.equal('some-region');
97.       });
98.     });
99. 
100.     it('should not check the metadata service if not using a command that needs creds', () => {
101.       awsPlugin.options.region = false;
102.       awsPlugin.serverless.service.provider = {
103.         region: 'some-region',
104.       };
105.       provider.cachedCredentials = {};
106.       serverless.processedInput = { commands: ['print'] };
107. 
108.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
109.         expect(awsPlugin.options.region).to.equal('some-region');
110.       });
111.     });
112.   });
113. });


File: lib/plugins/aws/package/index.test.js
Line number range: 1 - 167
Content:
1. 'use strict';
2. 
3. const AwsProvider = require('../provider/awsProvider');
4. const AwsPackage = require('./index');
5. const Serverless = require('../../../Serverless');
6. const CLI = require('../../../classes/CLI');
7. const expect = require('chai').expect;
8. const sinon = require('sinon');
9. const path = require('path');
10. 
11. describe('AwsPackage', () => {
12.   let awsPackage;
13.   let serverless;
14.   let options;
15. 
16.   beforeEach(() => {
17.     serverless = new Serverless();
18.     options = {
19.       stage: 'dev',
20.       region: 'us-east-1',
21.     };
22.     serverless.setProvider('aws', new AwsProvider(serverless, options));
23.     serverless.config.servicePath = 'foo';
24.     serverless.cli = new CLI(serverless);
25.     awsPackage = new AwsPackage(serverless, options);
26.   });
27. 
28.   describe('#constructor()', () => {
29.     it('should set the serverless instance', () => {
30.       expect(awsPackage.serverless).to.equal(serverless);
31.     });
32. 
33.     it('should set options', () => {
34.       expect(awsPackage.options).to.equal(options);
35.     });
36. 
37.     it('should set the service path if provided', () => {
38.       expect(awsPackage.servicePath).to.equal('foo');
39.     });
40. 
41.     it('should default to an empty service path if not provided', () => {
42.       serverless.config.servicePath = false;
43.       awsPackage = new AwsPackage(serverless, options);
44. 
45.       expect(awsPackage.servicePath).to.equal('');
46.     });
47. 
48.     it('should use the options package path if provided', () => {
49.       options.package = 'package-options';
50.       awsPackage = new AwsPackage(serverless, options);
51. 
52.       expect(awsPackage.packagePath).to.equal('package-options');
53.     });
54. 
55.     it('should use the services package path if provided', () => {
56.       serverless.service = {
57.         package: {
58.           path: 'package-service',
59.         },
60.       };
61.       awsPackage = new AwsPackage(serverless, options);
62. 
63.       expect(awsPackage.packagePath).to.equal('package-service');
64.     });
65. 
66.     it('should default to the .serverless directory as the package path', () => {
67.       expect(awsPackage.packagePath).to.equal(path.join('foo', '.serverless'));
68.     });
69. 
70.     it('should set the provider variable to an instance of AwsProvider', () =>
71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));
72. 
73.     it('should have commands', () => expect(awsPackage.commands).to.be.not.empty);
74. 
75.     it('should have hooks', () => expect(awsPackage.hooks).to.be.not.empty);
76.   });
77. 
78.   describe('hooks', () => {
79.     let spawnStub;
80.     let generateCoreTemplateStub;
81.     let mergeIamTemplatesStub;
82.     let generateArtifactDirectoryNameStub;
83.     let mergeCustomProviderResourcesStub;
84.     let saveCompiledTemplateStub;
85.     let saveServiceStateStub;
86. 
87.     beforeEach(() => {
88.       spawnStub = sinon.stub(serverless.pluginManager, 'spawn');
89.       generateCoreTemplateStub = sinon.stub(awsPackage, 'generateCoreTemplate').resolves();
90.       mergeIamTemplatesStub = sinon.stub(awsPackage, 'mergeIamTemplates').resolves();
91.       generateArtifactDirectoryNameStub = sinon
92.         .stub(awsPackage, 'generateArtifactDirectoryName')
93.         .resolves();
94.       mergeCustomProviderResourcesStub = sinon
95.         .stub(awsPackage, 'mergeCustomProviderResources')
96.         .resolves();
97.       saveCompiledTemplateStub = sinon.stub(awsPackage, 'saveCompiledTemplate').resolves();
98.       saveServiceStateStub = sinon.stub(awsPackage, 'saveServiceState').resolves();
99.     });
100. 
101.     afterEach(() => {
102.       serverless.pluginManager.spawn.restore();
103.       awsPackage.generateCoreTemplate.restore();
104.       awsPackage.mergeIamTemplates.restore();
105.       awsPackage.generateArtifactDirectoryName.restore();
106.       awsPackage.mergeCustomProviderResources.restore();
107.       awsPackage.saveCompiledTemplate.restore();
108.       awsPackage.saveServiceState.restore();
109.     });
110. 
111.     it('should run "package:cleanup" hook', () => {
112.       const spawnAwsCommonValidateStub = spawnStub.withArgs('aws:common:validate').resolves();
113.       const spawnAwsCommonCleanupTempDirStub = spawnStub
114.         .withArgs('aws:common:cleanupTempDir')
115.         .resolves();
116. 
117.       return awsPackage.hooks['package:cleanup']().then(() => {
118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);
119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(
120.           true
121.         );
122.       });
123.     });
124. 
125.     it('should run "package:initialize" hook', () =>
126.       awsPackage.hooks['package:initialize']().then(() => {
127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);
128.       }));
129. 
130.     it('should run "package:setupProviderConfiguration" hook', () =>
131.       awsPackage.hooks['package:setupProviderConfiguration']().then(() => {
132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);
133.       }));
134. 
135.     it('should run "before:package:compileFunctions" hook', () =>
136.       awsPackage.hooks['before:package:compileFunctions']().then(() => {
137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);
138.       }));
139. 
140.     it('should run "package:finalize" hook', () => {
141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs('aws:package:finalize').resolves();
142. 
143.       return awsPackage.hooks['package:finalize']().then(() => {
144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);
145.       });
146.     });
147. 
148.     it('should run "aws:package:finalize:mergeCustomProviderResources" hook', () =>
149.       awsPackage.hooks['aws:package:finalize:mergeCustomProviderResources']().then(() => {
150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);
151.       }));
152. 
153.     it('should run "aws:package:finalize:saveServiceState" hook', () => {
154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub
155.         .withArgs('aws:common:moveArtifactsToPackage')
156.         .resolves();
157. 
158.       return awsPackage.hooks['aws:package:finalize:saveServiceState']().then(() => {
159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);
160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);
161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(
162.           true
163.         );
164.       });
165.     });
166.   });
167. });


File: tests/integration-package/cloudformation.tests.js
Line number range: 1 - 129
Content:
1. 'use strict';
2. 
3. const fs = require('fs');
4. const path = require('path');
5. const { expect } = require('chai');
6. const fse = require('fs-extra');
7. const { execSync } = require('../utils/child-process');
8. const { serverlessExec } = require('../utils/misc');
9. const { getTmpDirPath } = require('../utils/fs');
10. 
11. const fixturePaths = {
12.   regular: path.join(__dirname, 'fixtures/regular'),
13.   individually: path.join(__dirname, 'fixtures/individually'),
14.   artifact: path.join(__dirname, 'fixtures/artifact'),
15. };
16. 
17. describe('Integration test - Packaging', () => {
18.   let cwd;
19.   beforeEach(() => {
20.     cwd = getTmpDirPath();
21.   });
22. 
23.   it('package artifact directive works', () => {
24.     fse.copySync(fixturePaths.artifact, cwd);
25.     execSync(`${serverlessExec} package`, { cwd });
26.     const cfnTemplate = JSON.parse(
27.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
28.     );
29.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
30.       /serverless\/aws-nodejs\/dev\/[^]*\/artifact.zip/
31.     );
32.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
33.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
34.       Type: 'AWS::Lambda::Function',
35.       Properties: {
36.         Code: {
37.           S3Bucket: {
38.             Ref: 'ServerlessDeploymentBucket',
39.           },
40.         },
41.         FunctionName: 'aws-nodejs-dev-hello',
42.         Handler: 'handler.hello',
43.         MemorySize: 1024,
44.         Role: {
45.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
46.         },
47.         Runtime: 'nodejs10.x',
48.         Timeout: 6,
49.       },
50.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
51.     });
52.   });
53. 
54.   it('creates the correct default function resource in cfn template', () => {
55.     fse.copySync(fixturePaths.regular, cwd);
56.     execSync(`${serverlessExec} package`, { cwd });
57.     const cfnTemplate = JSON.parse(
58.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
59.     );
60.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
61.       /serverless\/aws-nodejs\/dev\/[^]*\/aws-nodejs.zip/
62.     );
63.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
64.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
65.       Type: 'AWS::Lambda::Function',
66.       Properties: {
67.         Code: {
68.           S3Bucket: {
69.             Ref: 'ServerlessDeploymentBucket',
70.           },
71.         },
72.         FunctionName: 'aws-nodejs-dev-hello',
73.         Handler: 'handler.hello',
74.         MemorySize: 1024,
75.         Role: {
76.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
77.         },
78.         Runtime: 'nodejs10.x',
79.         Timeout: 6,
80.       },
81.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
82.     });
83.   });
84. 
85.   it('handles package individually with include/excludes correctly', () => {
86.     fse.copySync(fixturePaths.individually, cwd);
87.     execSync(`${serverlessExec} package`, { cwd });
88.     const cfnTemplate = JSON.parse(
89.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
90.     );
91.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
92.       /serverless\/aws-nodejs\/dev\/[^]*\/hello.zip/
93.     );
94.     expect(cfnTemplate.Resources.Hello2LambdaFunction.Properties.Code.S3Key).to.match(
95.       /serverless\/aws-nodejs\/dev\/[^]*\/hello2.zip/
96.     );
97.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
98.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
99.       Type: 'AWS::Lambda::Function',
100.       Properties: {
101.         Code: {
102.           S3Bucket: {
103.             Ref: 'ServerlessDeploymentBucket',
104.           },
105.         },
106.         FunctionName: 'aws-nodejs-dev-hello',
107.         Handler: 'handler.hello',
108.         MemorySize: 1024,
109.         Role: {
110.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
111.         },
112.         Runtime: 'nodejs10.x',
113.         Timeout: 6,
114.       },
115.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
116.     });
117.   });
118. 
119.   it('resolves self.provider.region', () => {
120.     fse.copySync(fixturePaths.regular, cwd);
121.     execSync(`${serverlessExec} package`, { cwd });
122.     const cfnTemplate = JSON.parse(
123.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
124.     );
125.     expect(cfnTemplate.Resources.CustomDashnameLambdaFunction.Properties.FunctionName).to.equal(
126.       'aws-nodejs-us-east-1-custom-name'
127.     );
128.   });
129. });

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 21:04:37,725 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requires full content of this file. 2. Extended relevance: While this file is about AWS validate flow (not IAM-specific), it is explicitly one of the requested files, so entire content is relevant.', relative_path='lib/plugins/aws/lib/validate.test.js', start_line=1, end_line=113), ContextOutput(reasoning='1. Query requires full content of this file. 2. Extended relevance: Contains hook tests including mergeIamTemplates, which is directly related to IAM packaging, useful for identifying IAM-related regression tests.', relative_path='lib/plugins/aws/package/index.test.js', start_line=1, end_line=167), ContextOutput(reasoning='1. Query requires full content of this file. 2. Extended relevance: Integration tests verify generated CloudFormation, including Role property referencing IamRoleLambdaExecution, which is related to IAM resources in packaging; helpful for IAM-related regression context even if not testing Action/Resource directly.', relative_path='tests/integration-package/cloudformation.tests.js', start_line=1, end_line=129)]
2025-11-13 21:04:37,728 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.
2025-11-13 21:04:38,039 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 21:04:38,040 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 0 existing contexts
2025-11-13 21:04:38,040 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 3 total contexts (removed 0 duplicates)
2025-11-13 21:04:38,040 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.
Extra Requirements: If sending all files is too large, include at minimum all test blocks that reference iamRoleStatements or IAM policy elements (Action/Resource) with their imports and exact line numbers.
Purpose: I need these test contents to identify 8 existing test cases related to IAM role statement validation/packaging and return them with exact imports and line numbers as regression tests.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/lib/validate.test.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const chai = require('chai');
4. const AwsProvider = require('../provider/awsProvider');
5. const validate = require('../lib/validate');
6. const Serverless = require('../../../Serverless');
7. 
8. chai.use(require('chai-as-promised'));
9. 
10. const expect = chai.expect;
11. 
12. class MetadataService {
13.   request(error) {
14.     error('error');
15.   }
16. }
17. 
18. describe('#validate', () => {
19.   const serverless = new Serverless();
20.   let provider;
21.   const awsPlugin = {};
22. 
23.   beforeEach(() => {
24.     awsPlugin.options = {
25.       stage: 'dev',
26.       region: 'us-east-1',
27.     };
28.     provider = new AwsProvider(serverless, awsPlugin.options);
29.     provider.cachedCredentials = { accessKeyId: 'foo', secretAccessKey: 'bar' };
30.     awsPlugin.provider = provider;
31.     awsPlugin.provider.sdk = { MetadataService };
32.     awsPlugin.serverless = serverless;
33.     awsPlugin.serverless.setProvider('aws', provider);
34. 
35.     awsPlugin.serverless.config.servicePath = true;
36.     serverless.processedInput = { commands: ['deploy'] };
37. 
38.     Object.assign(awsPlugin, validate);
39.   });
40. 
41.   describe('#validate()', () => {
42.     it('should succeed if inside service (servicePath defined)', () =>
43.       expect(awsPlugin.validate()).to.be.fulfilled);
44. 
45.     it('should throw error if not inside service (servicePath not defined)', () => {
46.       awsPlugin.serverless.config.servicePath = false;
47.       return expect(awsPlugin.validate()).to.be.rejected;
48.     });
49. 
50.     // NOTE: starting here, test order is important
51. 
52.     it('should default to "dev" if stage is not provided', () => {
53.       awsPlugin.options.stage = false;
54.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
55.         expect(awsPlugin.provider.getStage()).to.equal('dev');
56.       });
57.     });
58. 
59.     it('should use the service.provider stage if present', () => {
60.       awsPlugin.options.stage = false;
61.       awsPlugin.serverless.service.provider = {
62.         stage: 'some-stage',
63.       };
64. 
65.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
66.         expect(awsPlugin.provider.getStage()).to.equal('some-stage');
67.       });
68.     });
69. 
70.     it('should default to "us-east-1" region if region is not provided', () => {
71.       awsPlugin.options.region = false;
72.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
73.         expect(awsPlugin.options.region).to.equal('us-east-1');
74.       });
75.     });
76. 
77.     it('should use the service.provider region if present', () => {
78.       awsPlugin.options.region = false;
79.       awsPlugin.serverless.service.provider = {
80.         region: 'some-region',
81.       };
82. 
83.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
84.         expect(awsPlugin.options.region).to.equal('some-region');
85.       });
86.     });
87. 
88.     it('should check the metadata service and throw an error if no creds and no metadata response', () => {
89.       awsPlugin.options.region = false;
90.       awsPlugin.serverless.service.provider = {
91.         region: 'some-region',
92.       };
93.       provider.cachedCredentials = {};
94. 
95.       return expect(awsPlugin.validate()).to.be.rejected.then(() => {
96.         expect(awsPlugin.options.region).to.equal('some-region');
97.       });
98.     });
99. 
100.     it('should not check the metadata service if not using a command that needs creds', () => {
101.       awsPlugin.options.region = false;
102.       awsPlugin.serverless.service.provider = {
103.         region: 'some-region',
104.       };
105.       provider.cachedCredentials = {};
106.       serverless.processedInput = { commands: ['print'] };
107. 
108.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
109.         expect(awsPlugin.options.region).to.equal('some-region');
110.       });
111.     });
112.   });
113. });


File: lib/plugins/aws/package/index.test.js
Line number range: 1 - 167
Content:
1. 'use strict';
2. 
3. const AwsProvider = require('../provider/awsProvider');
4. const AwsPackage = require('./index');
5. const Serverless = require('../../../Serverless');
6. const CLI = require('../../../classes/CLI');
7. const expect = require('chai').expect;
8. const sinon = require('sinon');
9. const path = require('path');
10. 
11. describe('AwsPackage', () => {
12.   let awsPackage;
13.   let serverless;
14.   let options;
15. 
16.   beforeEach(() => {
17.     serverless = new Serverless();
18.     options = {
19.       stage: 'dev',
20.       region: 'us-east-1',
21.     };
22.     serverless.setProvider('aws', new AwsProvider(serverless, options));
23.     serverless.config.servicePath = 'foo';
24.     serverless.cli = new CLI(serverless);
25.     awsPackage = new AwsPackage(serverless, options);
26.   });
27. 
28.   describe('#constructor()', () => {
29.     it('should set the serverless instance', () => {
30.       expect(awsPackage.serverless).to.equal(serverless);
31.     });
32. 
33.     it('should set options', () => {
34.       expect(awsPackage.options).to.equal(options);
35.     });
36. 
37.     it('should set the service path if provided', () => {
38.       expect(awsPackage.servicePath).to.equal('foo');
39.     });
40. 
41.     it('should default to an empty service path if not provided', () => {
42.       serverless.config.servicePath = false;
43.       awsPackage = new AwsPackage(serverless, options);
44. 
45.       expect(awsPackage.servicePath).to.equal('');
46.     });
47. 
48.     it('should use the options package path if provided', () => {
49.       options.package = 'package-options';
50.       awsPackage = new AwsPackage(serverless, options);
51. 
52.       expect(awsPackage.packagePath).to.equal('package-options');
53.     });
54. 
55.     it('should use the services package path if provided', () => {
56.       serverless.service = {
57.         package: {
58.           path: 'package-service',
59.         },
60.       };
61.       awsPackage = new AwsPackage(serverless, options);
62. 
63.       expect(awsPackage.packagePath).to.equal('package-service');
64.     });
65. 
66.     it('should default to the .serverless directory as the package path', () => {
67.       expect(awsPackage.packagePath).to.equal(path.join('foo', '.serverless'));
68.     });
69. 
70.     it('should set the provider variable to an instance of AwsProvider', () =>
71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));
72. 
73.     it('should have commands', () => expect(awsPackage.commands).to.be.not.empty);
74. 
75.     it('should have hooks', () => expect(awsPackage.hooks).to.be.not.empty);
76.   });
77. 
78.   describe('hooks', () => {
79.     let spawnStub;
80.     let generateCoreTemplateStub;
81.     let mergeIamTemplatesStub;
82.     let generateArtifactDirectoryNameStub;
83.     let mergeCustomProviderResourcesStub;
84.     let saveCompiledTemplateStub;
85.     let saveServiceStateStub;
86. 
87.     beforeEach(() => {
88.       spawnStub = sinon.stub(serverless.pluginManager, 'spawn');
89.       generateCoreTemplateStub = sinon.stub(awsPackage, 'generateCoreTemplate').resolves();
90.       mergeIamTemplatesStub = sinon.stub(awsPackage, 'mergeIamTemplates').resolves();
91.       generateArtifactDirectoryNameStub = sinon
92.         .stub(awsPackage, 'generateArtifactDirectoryName')
93.         .resolves();
94.       mergeCustomProviderResourcesStub = sinon
95.         .stub(awsPackage, 'mergeCustomProviderResources')
96.         .resolves();
97.       saveCompiledTemplateStub = sinon.stub(awsPackage, 'saveCompiledTemplate').resolves();
98.       saveServiceStateStub = sinon.stub(awsPackage, 'saveServiceState').resolves();
99.     });
100. 
101.     afterEach(() => {
102.       serverless.pluginManager.spawn.restore();
103.       awsPackage.generateCoreTemplate.restore();
104.       awsPackage.mergeIamTemplates.restore();
105.       awsPackage.generateArtifactDirectoryName.restore();
106.       awsPackage.mergeCustomProviderResources.restore();
107.       awsPackage.saveCompiledTemplate.restore();
108.       awsPackage.saveServiceState.restore();
109.     });
110. 
111.     it('should run "package:cleanup" hook', () => {
112.       const spawnAwsCommonValidateStub = spawnStub.withArgs('aws:common:validate').resolves();
113.       const spawnAwsCommonCleanupTempDirStub = spawnStub
114.         .withArgs('aws:common:cleanupTempDir')
115.         .resolves();
116. 
117.       return awsPackage.hooks['package:cleanup']().then(() => {
118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);
119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(
120.           true
121.         );
122.       });
123.     });
124. 
125.     it('should run "package:initialize" hook', () =>
126.       awsPackage.hooks['package:initialize']().then(() => {
127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);
128.       }));
129. 
130.     it('should run "package:setupProviderConfiguration" hook', () =>
131.       awsPackage.hooks['package:setupProviderConfiguration']().then(() => {
132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);
133.       }));
134. 
135.     it('should run "before:package:compileFunctions" hook', () =>
136.       awsPackage.hooks['before:package:compileFunctions']().then(() => {
137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);
138.       }));
139. 
140.     it('should run "package:finalize" hook', () => {
141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs('aws:package:finalize').resolves();
142. 
143.       return awsPackage.hooks['package:finalize']().then(() => {
144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);
145.       });
146.     });
147. 
148.     it('should run "aws:package:finalize:mergeCustomProviderResources" hook', () =>
149.       awsPackage.hooks['aws:package:finalize:mergeCustomProviderResources']().then(() => {
150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);
151.       }));
152. 
153.     it('should run "aws:package:finalize:saveServiceState" hook', () => {
154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub
155.         .withArgs('aws:common:moveArtifactsToPackage')
156.         .resolves();
157. 
158.       return awsPackage.hooks['aws:package:finalize:saveServiceState']().then(() => {
159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);
160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);
161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(
162.           true
163.         );
164.       });
165.     });
166.   });
167. });


File: tests/integration-package/cloudformation.tests.js
Line number range: 1 - 129
Content:
1. 'use strict';
2. 
3. const fs = require('fs');
4. const path = require('path');
5. const { expect } = require('chai');
6. const fse = require('fs-extra');
7. const { execSync } = require('../utils/child-process');
8. const { serverlessExec } = require('../utils/misc');
9. const { getTmpDirPath } = require('../utils/fs');
10. 
11. const fixturePaths = {
12.   regular: path.join(__dirname, 'fixtures/regular'),
13.   individually: path.join(__dirname, 'fixtures/individually'),
14.   artifact: path.join(__dirname, 'fixtures/artifact'),
15. };
16. 
17. describe('Integration test - Packaging', () => {
18.   let cwd;
19.   beforeEach(() => {
20.     cwd = getTmpDirPath();
21.   });
22. 
23.   it('package artifact directive works', () => {
24.     fse.copySync(fixturePaths.artifact, cwd);
25.     execSync(`${serverlessExec} package`, { cwd });
26.     const cfnTemplate = JSON.parse(
27.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
28.     );
29.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
30.       /serverless\/aws-nodejs\/dev\/[^]*\/artifact.zip/
31.     );
32.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
33.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
34.       Type: 'AWS::Lambda::Function',
35.       Properties: {
36.         Code: {
37.           S3Bucket: {
38.             Ref: 'ServerlessDeploymentBucket',
39.           },
40.         },
41.         FunctionName: 'aws-nodejs-dev-hello',
42.         Handler: 'handler.hello',
43.         MemorySize: 1024,
44.         Role: {
45.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
46.         },
47.         Runtime: 'nodejs10.x',
48.         Timeout: 6,
49.       },
50.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
51.     });
52.   });
53. 
54.   it('creates the correct default function resource in cfn template', () => {
55.     fse.copySync(fixturePaths.regular, cwd);
56.     execSync(`${serverlessExec} package`, { cwd });
57.     const cfnTemplate = JSON.parse(
58.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
59.     );
60.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
61.       /serverless\/aws-nodejs\/dev\/[^]*\/aws-nodejs.zip/
62.     );
63.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
64.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
65.       Type: 'AWS::Lambda::Function',
66.       Properties: {
67.         Code: {
68.           S3Bucket: {
69.             Ref: 'ServerlessDeploymentBucket',
70.           },
71.         },
72.         FunctionName: 'aws-nodejs-dev-hello',
73.         Handler: 'handler.hello',
74.         MemorySize: 1024,
75.         Role: {
76.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
77.         },
78.         Runtime: 'nodejs10.x',
79.         Timeout: 6,
80.       },
81.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
82.     });
83.   });
84. 
85.   it('handles package individually with include/excludes correctly', () => {
86.     fse.copySync(fixturePaths.individually, cwd);
87.     execSync(`${serverlessExec} package`, { cwd });
88.     const cfnTemplate = JSON.parse(
89.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
90.     );
91.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
92.       /serverless\/aws-nodejs\/dev\/[^]*\/hello.zip/
93.     );
94.     expect(cfnTemplate.Resources.Hello2LambdaFunction.Properties.Code.S3Key).to.match(
95.       /serverless\/aws-nodejs\/dev\/[^]*\/hello2.zip/
96.     );
97.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
98.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
99.       Type: 'AWS::Lambda::Function',
100.       Properties: {
101.         Code: {
102.           S3Bucket: {
103.             Ref: 'ServerlessDeploymentBucket',
104.           },
105.         },
106.         FunctionName: 'aws-nodejs-dev-hello',
107.         Handler: 'handler.hello',
108.         MemorySize: 1024,
109.         Role: {
110.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
111.         },
112.         Runtime: 'nodejs10.x',
113.         Timeout: 6,
114.       },
115.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
116.     });
117.   });
118. 
119.   it('resolves self.provider.region', () => {
120.     fse.copySync(fixturePaths.regular, cwd);
121.     execSync(`${serverlessExec} package`, { cwd });
122.     const cfnTemplate = JSON.parse(
123.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
124.     );
125.     expect(cfnTemplate.Resources.CustomDashnameLambdaFunction.Properties.FunctionName).to.equal(
126.       'aws-nodejs-us-east-1-custom-name'
127.     );
128.   });
129. });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 21:05:04,314 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We need 8 existing tests most relevant to supporting NotAction/NotResource in IAM role statements. Current context only shows general packaging/validation tests and an integration packaging test, none of which assert IAM policy statement schema or iamRoleStatements handling. The likely relevant tests are in the AWS CloudFormation schema tests, AWS provider tests, and package compile tests that generate/merge IAM templates. Without these, we cannot identify or extract 8 precise tests with imports and line numbers.' query="Please provide the full content of lib/plugins/aws/lib/cloudformationSchema.test.js, lib/plugins/aws/provider/awsProvider.test.js, and any test files under lib/plugins/aws/package/compile that reference IAM roles/policies or iamRoleStatements (e.g., files with 'iam', 'role', or 'policy' in the name), with their paths." extra_requirements='If sending all is too large, include at minimum all test blocks that assert allowed keys in iamRoleStatements or validate IAM policy statement shapes, with their imports and exact line numbers.' purpose='To select 8 existing tests around IAM policy generation/validation that would be affected by adding NotAction and NotResource support.'
2025-11-13 21:05:04,315 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of lib/plugins/aws/lib/cloudformationSchema.test.js, lib/plugins/aws/provider/awsProvider.test.js, and any test files under lib/plugins/aws/package/compile that reference IAM roles/policies or iamRoleStatements (e.g., files with 'iam', 'role', or 'policy' in the name), with their paths.
2025-11-13 21:05:05,311 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.', 'query_extra_requirements': 'If sending all files is too large, include at minimum all test blocks that reference iamRoleStatements or IAM policy elements (Action/Resource) with their imports and exact line numbers.', 'query_purpose': 'I need these test contents to identify 8 existing test cases related to IAM role statement validation/packaging and return them with exact imports and line numbers as regression tests.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/lib/validate.test.js', 'content': '1. \'use strict\';\n2. \n3. const chai = require(\'chai\');\n4. const AwsProvider = require(\'../provider/awsProvider\');\n5. const validate = require(\'../lib/validate\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. chai.use(require(\'chai-as-promised\'));\n9. \n10. const expect = chai.expect;\n11. \n12. class MetadataService {\n13.   request(error) {\n14.     error(\'error\');\n15.   }\n16. }\n17. \n18. describe(\'#validate\', () => {\n19.   const serverless = new Serverless();\n20.   let provider;\n21.   const awsPlugin = {};\n22. \n23.   beforeEach(() => {\n24.     awsPlugin.options = {\n25.       stage: \'dev\',\n26.       region: \'us-east-1\',\n27.     };\n28.     provider = new AwsProvider(serverless, awsPlugin.options);\n29.     provider.cachedCredentials = { accessKeyId: \'foo\', secretAccessKey: \'bar\' };\n30.     awsPlugin.provider = provider;\n31.     awsPlugin.provider.sdk = { MetadataService };\n32.     awsPlugin.serverless = serverless;\n33.     awsPlugin.serverless.setProvider(\'aws\', provider);\n34. \n35.     awsPlugin.serverless.config.servicePath = true;\n36.     serverless.processedInput = { commands: [\'deploy\'] };\n37. \n38.     Object.assign(awsPlugin, validate);\n39.   });\n40. \n41.   describe(\'#validate()\', () => {\n42.     it(\'should succeed if inside service (servicePath defined)\', () =>\n43.       expect(awsPlugin.validate()).to.be.fulfilled);\n44. \n45.     it(\'should throw error if not inside service (servicePath not defined)\', () => {\n46.       awsPlugin.serverless.config.servicePath = false;\n47.       return expect(awsPlugin.validate()).to.be.rejected;\n48.     });\n49. \n50.     // NOTE: starting here, test order is important\n51. \n52.     it(\'should default to "dev" if stage is not provided\', () => {\n53.       awsPlugin.options.stage = false;\n54.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {\n55.         expect(awsPlugin.provider.getStage()).to.equal(\'dev\');\n56.       });\n57.     });\n58. \n59.     it(\'should use the service.provider stage if present\', () => {\n60.       awsPlugin.options.stage = false;\n61.       awsPlugin.serverless.service.provider = {\n62.         stage: \'some-stage\',\n63.       };\n64. \n65.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {\n66.         expect(awsPlugin.provider.getStage()).to.equal(\'some-stage\');\n67.       });\n68.     });\n69. \n70.     it(\'should default to "us-east-1" region if region is not provided\', () => {\n71.       awsPlugin.options.region = false;\n72.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {\n73.         expect(awsPlugin.options.region).to.equal(\'us-east-1\');\n74.       });\n75.     });\n76. \n77.     it(\'should use the service.provider region if present\', () => {\n78.       awsPlugin.options.region = false;\n79.       awsPlugin.serverless.service.provider = {\n80.         region: \'some-region\',\n81.       };\n82. \n83.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {\n84.         expect(awsPlugin.options.region).to.equal(\'some-region\');\n85.       });\n86.     });\n87. \n88.     it(\'should check the metadata service and throw an error if no creds and no metadata response\', () => {\n89.       awsPlugin.options.region = false;\n90.       awsPlugin.serverless.service.provider = {\n91.         region: \'some-region\',\n92.       };\n93.       provider.cachedCredentials = {};\n94. \n95.       return expect(awsPlugin.validate()).to.be.rejected.then(() => {\n96.         expect(awsPlugin.options.region).to.equal(\'some-region\');\n97.       });\n98.     });\n99. \n100.     it(\'should not check the metadata service if not using a command that needs creds\', () => {\n101.       awsPlugin.options.region = false;\n102.       awsPlugin.serverless.service.provider = {\n103.         region: \'some-region\',\n104.       };\n105.       provider.cachedCredentials = {};\n106.       serverless.processedInput = { commands: [\'print\'] };\n107. \n108.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {\n109.         expect(awsPlugin.options.region).to.equal(\'some-region\');\n110.       });\n111.     });\n112.   });\n113. });', 'start_line_number': 1, 'end_line_number': 113}, {'relative_path': 'lib/plugins/aws/package/index.test.js', 'content': '1. \'use strict\';\n2. \n3. const AwsProvider = require(\'../provider/awsProvider\');\n4. const AwsPackage = require(\'./index\');\n5. const Serverless = require(\'../../../Serverless\');\n6. const CLI = require(\'../../../classes/CLI\');\n7. const expect = require(\'chai\').expect;\n8. const sinon = require(\'sinon\');\n9. const path = require(\'path\');\n10. \n11. describe(\'AwsPackage\', () => {\n12.   let awsPackage;\n13.   let serverless;\n14.   let options;\n15. \n16.   beforeEach(() => {\n17.     serverless = new Serverless();\n18.     options = {\n19.       stage: \'dev\',\n20.       region: \'us-east-1\',\n21.     };\n22.     serverless.setProvider(\'aws\', new AwsProvider(serverless, options));\n23.     serverless.config.servicePath = \'foo\';\n24.     serverless.cli = new CLI(serverless);\n25.     awsPackage = new AwsPackage(serverless, options);\n26.   });\n27. \n28.   describe(\'#constructor()\', () => {\n29.     it(\'should set the serverless instance\', () => {\n30.       expect(awsPackage.serverless).to.equal(serverless);\n31.     });\n32. \n33.     it(\'should set options\', () => {\n34.       expect(awsPackage.options).to.equal(options);\n35.     });\n36. \n37.     it(\'should set the service path if provided\', () => {\n38.       expect(awsPackage.servicePath).to.equal(\'foo\');\n39.     });\n40. \n41.     it(\'should default to an empty service path if not provided\', () => {\n42.       serverless.config.servicePath = false;\n43.       awsPackage = new AwsPackage(serverless, options);\n44. \n45.       expect(awsPackage.servicePath).to.equal(\'\');\n46.     });\n47. \n48.     it(\'should use the options package path if provided\', () => {\n49.       options.package = \'package-options\';\n50.       awsPackage = new AwsPackage(serverless, options);\n51. \n52.       expect(awsPackage.packagePath).to.equal(\'package-options\');\n53.     });\n54. \n55.     it(\'should use the services package path if provided\', () => {\n56.       serverless.service = {\n57.         package: {\n58.           path: \'package-service\',\n59.         },\n60.       };\n61.       awsPackage = new AwsPackage(serverless, options);\n62. \n63.       expect(awsPackage.packagePath).to.equal(\'package-service\');\n64.     });\n65. \n66.     it(\'should default to the .serverless directory as the package path\', () => {\n67.       expect(awsPackage.packagePath).to.equal(path.join(\'foo\', \'.serverless\'));\n68.     });\n69. \n70.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));\n72. \n73.     it(\'should have commands\', () => expect(awsPackage.commands).to.be.not.empty);\n74. \n75.     it(\'should have hooks\', () => expect(awsPackage.hooks).to.be.not.empty);\n76.   });\n77. \n78.   describe(\'hooks\', () => {\n79.     let spawnStub;\n80.     let generateCoreTemplateStub;\n81.     let mergeIamTemplatesStub;\n82.     let generateArtifactDirectoryNameStub;\n83.     let mergeCustomProviderResourcesStub;\n84.     let saveCompiledTemplateStub;\n85.     let saveServiceStateStub;\n86. \n87.     beforeEach(() => {\n88.       spawnStub = sinon.stub(serverless.pluginManager, \'spawn\');\n89.       generateCoreTemplateStub = sinon.stub(awsPackage, \'generateCoreTemplate\').resolves();\n90.       mergeIamTemplatesStub = sinon.stub(awsPackage, \'mergeIamTemplates\').resolves();\n91.       generateArtifactDirectoryNameStub = sinon\n92.         .stub(awsPackage, \'generateArtifactDirectoryName\')\n93.         .resolves();\n94.       mergeCustomProviderResourcesStub = sinon\n95.         .stub(awsPackage, \'mergeCustomProviderResources\')\n96.         .resolves();\n97.       saveCompiledTemplateStub = sinon.stub(awsPackage, \'saveCompiledTemplate\').resolves();\n98.       saveServiceStateStub = sinon.stub(awsPackage, \'saveServiceState\').resolves();\n99.     });\n100. \n101.     afterEach(() => {\n102.       serverless.pluginManager.spawn.restore();\n103.       awsPackage.generateCoreTemplate.restore();\n104.       awsPackage.mergeIamTemplates.restore();\n105.       awsPackage.generateArtifactDirectoryName.restore();\n106.       awsPackage.mergeCustomProviderResources.restore();\n107.       awsPackage.saveCompiledTemplate.restore();\n108.       awsPackage.saveServiceState.restore();\n109.     });\n110. \n111.     it(\'should run "package:cleanup" hook\', () => {\n112.       const spawnAwsCommonValidateStub = spawnStub.withArgs(\'aws:common:validate\').resolves();\n113.       const spawnAwsCommonCleanupTempDirStub = spawnStub\n114.         .withArgs(\'aws:common:cleanupTempDir\')\n115.         .resolves();\n116. \n117.       return awsPackage.hooks[\'package:cleanup\']().then(() => {\n118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);\n119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(\n120.           true\n121.         );\n122.       });\n123.     });\n124. \n125.     it(\'should run "package:initialize" hook\', () =>\n126.       awsPackage.hooks[\'package:initialize\']().then(() => {\n127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);\n128.       }));\n129. \n130.     it(\'should run "package:setupProviderConfiguration" hook\', () =>\n131.       awsPackage.hooks[\'package:setupProviderConfiguration\']().then(() => {\n132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);\n133.       }));\n134. \n135.     it(\'should run "before:package:compileFunctions" hook\', () =>\n136.       awsPackage.hooks[\'before:package:compileFunctions\']().then(() => {\n137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);\n138.       }));\n139. \n140.     it(\'should run "package:finalize" hook\', () => {\n141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs(\'aws:package:finalize\').resolves();\n142. \n143.       return awsPackage.hooks[\'package:finalize\']().then(() => {\n144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);\n145.       });\n146.     });\n147. \n148.     it(\'should run "aws:package:finalize:mergeCustomProviderResources" hook\', () =>\n149.       awsPackage.hooks[\'aws:package:finalize:mergeCustomProviderResources\']().then(() => {\n150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);\n151.       }));\n152. \n153.     it(\'should run "aws:package:finalize:saveServiceState" hook\', () => {\n154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub\n155.         .withArgs(\'aws:common:moveArtifactsToPackage\')\n156.         .resolves();\n157. \n158.       return awsPackage.hooks[\'aws:package:finalize:saveServiceState\']().then(() => {\n159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);\n160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);\n161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(\n162.           true\n163.         );\n164.       });\n165.     });\n166.   });\n167. });', 'start_line_number': 1, 'end_line_number': 167}, {'relative_path': 'tests/integration-package/cloudformation.tests.js', 'content': "1. 'use strict';\n2. \n3. const fs = require('fs');\n4. const path = require('path');\n5. const { expect } = require('chai');\n6. const fse = require('fs-extra');\n7. const { execSync } = require('../utils/child-process');\n8. const { serverlessExec } = require('../utils/misc');\n9. const { getTmpDirPath } = require('../utils/fs');\n10. \n11. const fixturePaths = {\n12.   regular: path.join(__dirname, 'fixtures/regular'),\n13.   individually: path.join(__dirname, 'fixtures/individually'),\n14.   artifact: path.join(__dirname, 'fixtures/artifact'),\n15. };\n16. \n17. describe('Integration test - Packaging', () => {\n18.   let cwd;\n19.   beforeEach(() => {\n20.     cwd = getTmpDirPath();\n21.   });\n22. \n23.   it('package artifact directive works', () => {\n24.     fse.copySync(fixturePaths.artifact, cwd);\n25.     execSync(`${serverlessExec} package`, { cwd });\n26.     const cfnTemplate = JSON.parse(\n27.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))\n28.     );\n29.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(\n30.       /serverless\\/aws-nodejs\\/dev\\/[^]*\\/artifact.zip/\n31.     );\n32.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;\n33.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({\n34.       Type: 'AWS::Lambda::Function',\n35.       Properties: {\n36.         Code: {\n37.           S3Bucket: {\n38.             Ref: 'ServerlessDeploymentBucket',\n39.           },\n40.         },\n41.         FunctionName: 'aws-nodejs-dev-hello',\n42.         Handler: 'handler.hello',\n43.         MemorySize: 1024,\n44.         Role: {\n45.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],\n46.         },\n47.         Runtime: 'nodejs10.x',\n48.         Timeout: 6,\n49.       },\n50.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],\n51.     });\n52.   });\n53. \n54.   it('creates the correct default function resource in cfn template', () => {\n55.     fse.copySync(fixturePaths.regular, cwd);\n56.     execSync(`${serverlessExec} package`, { cwd });\n57.     const cfnTemplate = JSON.parse(\n58.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))\n59.     );\n60.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(\n61.       /serverless\\/aws-nodejs\\/dev\\/[^]*\\/aws-nodejs.zip/\n62.     );\n63.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;\n64.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({\n65.       Type: 'AWS::Lambda::Function',\n66.       Properties: {\n67.         Code: {\n68.           S3Bucket: {\n69.             Ref: 'ServerlessDeploymentBucket',\n70.           },\n71.         },\n72.         FunctionName: 'aws-nodejs-dev-hello',\n73.         Handler: 'handler.hello',\n74.         MemorySize: 1024,\n75.         Role: {\n76.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],\n77.         },\n78.         Runtime: 'nodejs10.x',\n79.         Timeout: 6,\n80.       },\n81.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],\n82.     });\n83.   });\n84. \n85.   it('handles package individually with include/excludes correctly', () => {\n86.     fse.copySync(fixturePaths.individually, cwd);\n87.     execSync(`${serverlessExec} package`, { cwd });\n88.     const cfnTemplate = JSON.parse(\n89.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))\n90.     );\n91.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(\n92.       /serverless\\/aws-nodejs\\/dev\\/[^]*\\/hello.zip/\n93.     );\n94.     expect(cfnTemplate.Resources.Hello2LambdaFunction.Properties.Code.S3Key).to.match(\n95.       /serverless\\/aws-nodejs\\/dev\\/[^]*\\/hello2.zip/\n96.     );\n97.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;\n98.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({\n99.       Type: 'AWS::Lambda::Function',\n100.       Properties: {\n101.         Code: {\n102.           S3Bucket: {\n103.             Ref: 'ServerlessDeploymentBucket',\n104.           },\n105.         },\n106.         FunctionName: 'aws-nodejs-dev-hello',\n107.         Handler: 'handler.hello',\n108.         MemorySize: 1024,\n109.         Role: {\n110.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],\n111.         },\n112.         Runtime: 'nodejs10.x',\n113.         Timeout: 6,\n114.       },\n115.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],\n116.     });\n117.   });\n118. \n119.   it('resolves self.provider.region', () => {\n120.     fse.copySync(fixturePaths.regular, cwd);\n121.     execSync(`${serverlessExec} package`, { cwd });\n122.     const cfnTemplate = JSON.parse(\n123.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))\n124.     );\n125.     expect(cfnTemplate.Resources.CustomDashnameLambdaFunction.Properties.FunctionName).to.equal(\n126.       'aws-nodejs-us-east-1-custom-name'\n127.     );\n128.   });\n129. });", 'start_line_number': 1, 'end_line_number': 129}]}]
2025-11-13 21:05:05,312 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 1 memories from memory
2025-11-13 21:05:05,312 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 3 contexts from memory
2025-11-13 21:05:05,312 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 3 contexts from memory
2025-11-13 21:05:05,313 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 3 existing contexts
2025-11-13 21:05:05,314 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 3 total contexts (removed 3 duplicates)
2025-11-13 21:05:05,315 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/lib/validate.test.js, lib/plugins/aws/package/index.test.js, and tests/integration-package/cloudformation.tests.js.
Extra Requirements: If sending all files is too large, include at minimum all test blocks that reference iamRoleStatements or IAM policy elements (Action/Resource) with their imports and exact line numbers.
Purpose: I need these test contents to identify 8 existing test cases related to IAM role statement validation/packaging and return them with exact imports and line numbers as regression tests.

Previous refined query 2:
Essential Query: Please provide the full content of lib/plugins/aws/lib/cloudformationSchema.test.js, lib/plugins/aws/provider/awsProvider.test.js, and any test files under lib/plugins/aws/package/compile that reference IAM roles/policies or iamRoleStatements (e.g., files with 'iam', 'role', or 'policy' in the name), with their paths.
Extra Requirements: If sending all is too large, include at minimum all test blocks that assert allowed keys in iamRoleStatements or validate IAM policy statement shapes, with their imports and exact line numbers.
Purpose: To select 8 existing tests around IAM policy generation/validation that would be affected by adding NotAction and NotResource support.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/lib/validate.test.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const chai = require('chai');
4. const AwsProvider = require('../provider/awsProvider');
5. const validate = require('../lib/validate');
6. const Serverless = require('../../../Serverless');
7. 
8. chai.use(require('chai-as-promised'));
9. 
10. const expect = chai.expect;
11. 
12. class MetadataService {
13.   request(error) {
14.     error('error');
15.   }
16. }
17. 
18. describe('#validate', () => {
19.   const serverless = new Serverless();
20.   let provider;
21.   const awsPlugin = {};
22. 
23.   beforeEach(() => {
24.     awsPlugin.options = {
25.       stage: 'dev',
26.       region: 'us-east-1',
27.     };
28.     provider = new AwsProvider(serverless, awsPlugin.options);
29.     provider.cachedCredentials = { accessKeyId: 'foo', secretAccessKey: 'bar' };
30.     awsPlugin.provider = provider;
31.     awsPlugin.provider.sdk = { MetadataService };
32.     awsPlugin.serverless = serverless;
33.     awsPlugin.serverless.setProvider('aws', provider);
34. 
35.     awsPlugin.serverless.config.servicePath = true;
36.     serverless.processedInput = { commands: ['deploy'] };
37. 
38.     Object.assign(awsPlugin, validate);
39.   });
40. 
41.   describe('#validate()', () => {
42.     it('should succeed if inside service (servicePath defined)', () =>
43.       expect(awsPlugin.validate()).to.be.fulfilled);
44. 
45.     it('should throw error if not inside service (servicePath not defined)', () => {
46.       awsPlugin.serverless.config.servicePath = false;
47.       return expect(awsPlugin.validate()).to.be.rejected;
48.     });
49. 
50.     // NOTE: starting here, test order is important
51. 
52.     it('should default to "dev" if stage is not provided', () => {
53.       awsPlugin.options.stage = false;
54.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
55.         expect(awsPlugin.provider.getStage()).to.equal('dev');
56.       });
57.     });
58. 
59.     it('should use the service.provider stage if present', () => {
60.       awsPlugin.options.stage = false;
61.       awsPlugin.serverless.service.provider = {
62.         stage: 'some-stage',
63.       };
64. 
65.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
66.         expect(awsPlugin.provider.getStage()).to.equal('some-stage');
67.       });
68.     });
69. 
70.     it('should default to "us-east-1" region if region is not provided', () => {
71.       awsPlugin.options.region = false;
72.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
73.         expect(awsPlugin.options.region).to.equal('us-east-1');
74.       });
75.     });
76. 
77.     it('should use the service.provider region if present', () => {
78.       awsPlugin.options.region = false;
79.       awsPlugin.serverless.service.provider = {
80.         region: 'some-region',
81.       };
82. 
83.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
84.         expect(awsPlugin.options.region).to.equal('some-region');
85.       });
86.     });
87. 
88.     it('should check the metadata service and throw an error if no creds and no metadata response', () => {
89.       awsPlugin.options.region = false;
90.       awsPlugin.serverless.service.provider = {
91.         region: 'some-region',
92.       };
93.       provider.cachedCredentials = {};
94. 
95.       return expect(awsPlugin.validate()).to.be.rejected.then(() => {
96.         expect(awsPlugin.options.region).to.equal('some-region');
97.       });
98.     });
99. 
100.     it('should not check the metadata service if not using a command that needs creds', () => {
101.       awsPlugin.options.region = false;
102.       awsPlugin.serverless.service.provider = {
103.         region: 'some-region',
104.       };
105.       provider.cachedCredentials = {};
106.       serverless.processedInput = { commands: ['print'] };
107. 
108.       return expect(awsPlugin.validate()).to.be.fulfilled.then(() => {
109.         expect(awsPlugin.options.region).to.equal('some-region');
110.       });
111.     });
112.   });
113. });


File: lib/plugins/aws/package/index.test.js
Line number range: 1 - 167
Content:
1. 'use strict';
2. 
3. const AwsProvider = require('../provider/awsProvider');
4. const AwsPackage = require('./index');
5. const Serverless = require('../../../Serverless');
6. const CLI = require('../../../classes/CLI');
7. const expect = require('chai').expect;
8. const sinon = require('sinon');
9. const path = require('path');
10. 
11. describe('AwsPackage', () => {
12.   let awsPackage;
13.   let serverless;
14.   let options;
15. 
16.   beforeEach(() => {
17.     serverless = new Serverless();
18.     options = {
19.       stage: 'dev',
20.       region: 'us-east-1',
21.     };
22.     serverless.setProvider('aws', new AwsProvider(serverless, options));
23.     serverless.config.servicePath = 'foo';
24.     serverless.cli = new CLI(serverless);
25.     awsPackage = new AwsPackage(serverless, options);
26.   });
27. 
28.   describe('#constructor()', () => {
29.     it('should set the serverless instance', () => {
30.       expect(awsPackage.serverless).to.equal(serverless);
31.     });
32. 
33.     it('should set options', () => {
34.       expect(awsPackage.options).to.equal(options);
35.     });
36. 
37.     it('should set the service path if provided', () => {
38.       expect(awsPackage.servicePath).to.equal('foo');
39.     });
40. 
41.     it('should default to an empty service path if not provided', () => {
42.       serverless.config.servicePath = false;
43.       awsPackage = new AwsPackage(serverless, options);
44. 
45.       expect(awsPackage.servicePath).to.equal('');
46.     });
47. 
48.     it('should use the options package path if provided', () => {
49.       options.package = 'package-options';
50.       awsPackage = new AwsPackage(serverless, options);
51. 
52.       expect(awsPackage.packagePath).to.equal('package-options');
53.     });
54. 
55.     it('should use the services package path if provided', () => {
56.       serverless.service = {
57.         package: {
58.           path: 'package-service',
59.         },
60.       };
61.       awsPackage = new AwsPackage(serverless, options);
62. 
63.       expect(awsPackage.packagePath).to.equal('package-service');
64.     });
65. 
66.     it('should default to the .serverless directory as the package path', () => {
67.       expect(awsPackage.packagePath).to.equal(path.join('foo', '.serverless'));
68.     });
69. 
70.     it('should set the provider variable to an instance of AwsProvider', () =>
71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));
72. 
73.     it('should have commands', () => expect(awsPackage.commands).to.be.not.empty);
74. 
75.     it('should have hooks', () => expect(awsPackage.hooks).to.be.not.empty);
76.   });
77. 
78.   describe('hooks', () => {
79.     let spawnStub;
80.     let generateCoreTemplateStub;
81.     let mergeIamTemplatesStub;
82.     let generateArtifactDirectoryNameStub;
83.     let mergeCustomProviderResourcesStub;
84.     let saveCompiledTemplateStub;
85.     let saveServiceStateStub;
86. 
87.     beforeEach(() => {
88.       spawnStub = sinon.stub(serverless.pluginManager, 'spawn');
89.       generateCoreTemplateStub = sinon.stub(awsPackage, 'generateCoreTemplate').resolves();
90.       mergeIamTemplatesStub = sinon.stub(awsPackage, 'mergeIamTemplates').resolves();
91.       generateArtifactDirectoryNameStub = sinon
92.         .stub(awsPackage, 'generateArtifactDirectoryName')
93.         .resolves();
94.       mergeCustomProviderResourcesStub = sinon
95.         .stub(awsPackage, 'mergeCustomProviderResources')
96.         .resolves();
97.       saveCompiledTemplateStub = sinon.stub(awsPackage, 'saveCompiledTemplate').resolves();
98.       saveServiceStateStub = sinon.stub(awsPackage, 'saveServiceState').resolves();
99.     });
100. 
101.     afterEach(() => {
102.       serverless.pluginManager.spawn.restore();
103.       awsPackage.generateCoreTemplate.restore();
104.       awsPackage.mergeIamTemplates.restore();
105.       awsPackage.generateArtifactDirectoryName.restore();
106.       awsPackage.mergeCustomProviderResources.restore();
107.       awsPackage.saveCompiledTemplate.restore();
108.       awsPackage.saveServiceState.restore();
109.     });
110. 
111.     it('should run "package:cleanup" hook', () => {
112.       const spawnAwsCommonValidateStub = spawnStub.withArgs('aws:common:validate').resolves();
113.       const spawnAwsCommonCleanupTempDirStub = spawnStub
114.         .withArgs('aws:common:cleanupTempDir')
115.         .resolves();
116. 
117.       return awsPackage.hooks['package:cleanup']().then(() => {
118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);
119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(
120.           true
121.         );
122.       });
123.     });
124. 
125.     it('should run "package:initialize" hook', () =>
126.       awsPackage.hooks['package:initialize']().then(() => {
127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);
128.       }));
129. 
130.     it('should run "package:setupProviderConfiguration" hook', () =>
131.       awsPackage.hooks['package:setupProviderConfiguration']().then(() => {
132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);
133.       }));
134. 
135.     it('should run "before:package:compileFunctions" hook', () =>
136.       awsPackage.hooks['before:package:compileFunctions']().then(() => {
137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);
138.       }));
139. 
140.     it('should run "package:finalize" hook', () => {
141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs('aws:package:finalize').resolves();
142. 
143.       return awsPackage.hooks['package:finalize']().then(() => {
144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);
145.       });
146.     });
147. 
148.     it('should run "aws:package:finalize:mergeCustomProviderResources" hook', () =>
149.       awsPackage.hooks['aws:package:finalize:mergeCustomProviderResources']().then(() => {
150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);
151.       }));
152. 
153.     it('should run "aws:package:finalize:saveServiceState" hook', () => {
154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub
155.         .withArgs('aws:common:moveArtifactsToPackage')
156.         .resolves();
157. 
158.       return awsPackage.hooks['aws:package:finalize:saveServiceState']().then(() => {
159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);
160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);
161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(
162.           true
163.         );
164.       });
165.     });
166.   });
167. });


File: tests/integration-package/cloudformation.tests.js
Line number range: 1 - 129
Content:
1. 'use strict';
2. 
3. const fs = require('fs');
4. const path = require('path');
5. const { expect } = require('chai');
6. const fse = require('fs-extra');
7. const { execSync } = require('../utils/child-process');
8. const { serverlessExec } = require('../utils/misc');
9. const { getTmpDirPath } = require('../utils/fs');
10. 
11. const fixturePaths = {
12.   regular: path.join(__dirname, 'fixtures/regular'),
13.   individually: path.join(__dirname, 'fixtures/individually'),
14.   artifact: path.join(__dirname, 'fixtures/artifact'),
15. };
16. 
17. describe('Integration test - Packaging', () => {
18.   let cwd;
19.   beforeEach(() => {
20.     cwd = getTmpDirPath();
21.   });
22. 
23.   it('package artifact directive works', () => {
24.     fse.copySync(fixturePaths.artifact, cwd);
25.     execSync(`${serverlessExec} package`, { cwd });
26.     const cfnTemplate = JSON.parse(
27.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
28.     );
29.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
30.       /serverless\/aws-nodejs\/dev\/[^]*\/artifact.zip/
31.     );
32.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
33.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
34.       Type: 'AWS::Lambda::Function',
35.       Properties: {
36.         Code: {
37.           S3Bucket: {
38.             Ref: 'ServerlessDeploymentBucket',
39.           },
40.         },
41.         FunctionName: 'aws-nodejs-dev-hello',
42.         Handler: 'handler.hello',
43.         MemorySize: 1024,
44.         Role: {
45.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
46.         },
47.         Runtime: 'nodejs10.x',
48.         Timeout: 6,
49.       },
50.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
51.     });
52.   });
53. 
54.   it('creates the correct default function resource in cfn template', () => {
55.     fse.copySync(fixturePaths.regular, cwd);
56.     execSync(`${serverlessExec} package`, { cwd });
57.     const cfnTemplate = JSON.parse(
58.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
59.     );
60.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
61.       /serverless\/aws-nodejs\/dev\/[^]*\/aws-nodejs.zip/
62.     );
63.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
64.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
65.       Type: 'AWS::Lambda::Function',
66.       Properties: {
67.         Code: {
68.           S3Bucket: {
69.             Ref: 'ServerlessDeploymentBucket',
70.           },
71.         },
72.         FunctionName: 'aws-nodejs-dev-hello',
73.         Handler: 'handler.hello',
74.         MemorySize: 1024,
75.         Role: {
76.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
77.         },
78.         Runtime: 'nodejs10.x',
79.         Timeout: 6,
80.       },
81.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
82.     });
83.   });
84. 
85.   it('handles package individually with include/excludes correctly', () => {
86.     fse.copySync(fixturePaths.individually, cwd);
87.     execSync(`${serverlessExec} package`, { cwd });
88.     const cfnTemplate = JSON.parse(
89.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
90.     );
91.     expect(cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key).to.match(
92.       /serverless\/aws-nodejs\/dev\/[^]*\/hello.zip/
93.     );
94.     expect(cfnTemplate.Resources.Hello2LambdaFunction.Properties.Code.S3Key).to.match(
95.       /serverless\/aws-nodejs\/dev\/[^]*\/hello2.zip/
96.     );
97.     delete cfnTemplate.Resources.HelloLambdaFunction.Properties.Code.S3Key;
98.     expect(cfnTemplate.Resources.HelloLambdaFunction).to.deep.equal({
99.       Type: 'AWS::Lambda::Function',
100.       Properties: {
101.         Code: {
102.           S3Bucket: {
103.             Ref: 'ServerlessDeploymentBucket',
104.           },
105.         },
106.         FunctionName: 'aws-nodejs-dev-hello',
107.         Handler: 'handler.hello',
108.         MemorySize: 1024,
109.         Role: {
110.           'Fn::GetAtt': ['IamRoleLambdaExecution', 'Arn'],
111.         },
112.         Runtime: 'nodejs10.x',
113.         Timeout: 6,
114.       },
115.       DependsOn: ['HelloLogGroup', 'IamRoleLambdaExecution'],
116.     });
117.   });
118. 
119.   it('resolves self.provider.region', () => {
120.     fse.copySync(fixturePaths.regular, cwd);
121.     execSync(`${serverlessExec} package`, { cwd });
122.     const cfnTemplate = JSON.parse(
123.       fs.readFileSync(path.join(cwd, '.serverless/cloudformation-template-update-stack.json'))
124.     );
125.     expect(cfnTemplate.Resources.CustomDashnameLambdaFunction.Properties.FunctionName).to.equal(
126.       'aws-nodejs-us-east-1-custom-name'
127.     );
128.   });
129. });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 21:05:20,962 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The goal is to extract 8 existing tests that would be impacted by supporting NotAction/NotResource in iamRoleStatements. The currently provided test files focus on general AWS provider validation and packaging hooks, without any assertions around IAM role/policy statement keys or iamRoleStatements. The likely relevant tests reside in areas that compile/validate IAM policies (e.g., provider or package compile code) or any tests explicitly referencing iamRoleStatements. Previous queries requested some of these files but did not return them, and none of the aggregated content includes IAM statement validation. Therefore, more context is essential to identify and quote the exact tests with imports and line numbers.' query='Please provide all test cases in the repository that reference iamRoleStatements or IAM policy statement keys (Action, Resource, NotAction, NotResource), including their file paths and full content with line numbers.' extra_requirements='If a full search is hard, at minimum share tests under lib/plugins/aws/package/compile and lib/plugins/aws/provider that build or validate IAM roles/policies and any integration tests that assert IamRoleLambdaExecution policies.' purpose='I need to select 8 precise, self-contained tests around IAM policy generation/validation that would be affected by adding NotAction and NotResource support.'
2025-11-13 21:05:20,963 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide all test cases in the repository that reference iamRoleStatements or IAM policy statement keys (Action, Resource, NotAction, NotResource), including their file paths and full content with line numbers.
2025-11-13 21:05:25,996 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 21:05:25,996 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 21:05:25,996 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 21:05:25,996 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 21:05:25,998 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 21:05:25,999 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 21:05:25,999 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide all test cases in the repository that reference iamRoleStatements or IAM policy statement keys (Action, Resource, NotAction, NotResource), including their file paths and full content with line numbers.
Extra requirements: If a full search is hard, at minimum share tests under lib/plugins/aws/package/compile and lib/plugins/aws/provider that build or validate IAM roles/policies and any integration tests that assert IamRoleLambdaExecution policies.
Purpose: I need to select 8 precise, self-contained tests around IAM policy generation/validation that would be affected by adding NotAction and NotResource support.
2025-11-13 21:05:40,240 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_vY5Eqdwt0nZsjTnOhTYVOLgP', 'function': {'arguments': '{"basename":"provider.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1246, 'prompt_tokens': 2292, 'total_tokens': 3538, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1216, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d79ad84d-ebda-4e73-b2b0-2bd7bb4702eb-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'provider.test.js'}, 'id': 'call_vY5Eqdwt0nZsjTnOhTYVOLgP', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2292, 'output_tokens': 1246, 'total_tokens': 3538, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 1216}}
2025-11-13 21:05:46,821 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_M77KkBUlQM2VStq0yow1iox4', 'function': {'arguments': '{"basename":"iam-role.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 479, 'prompt_tokens': 2342, 'total_tokens': 2821, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4ee81172-d5f7-4854-8129-f4a7b77a8818-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam-role.test.js'}, 'id': 'call_M77KkBUlQM2VStq0yow1iox4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2342, 'output_tokens': 479, 'total_tokens': 2821, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:05:54,103 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_UcXhYCrlq8UY9f0ea1Sh5pzR', 'function': {'arguments': '{"basename":"lib"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 732, 'prompt_tokens': 2393, 'total_tokens': 3125, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0ce5a1bd-5ef2-47e4-8b83-388481b20244-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'lib'}, 'id': 'call_UcXhYCrlq8UY9f0ea1Sh5pzR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2393, 'output_tokens': 732, 'total_tokens': 3125, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 21:05:58,499 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_QW3v7aNs1PTe0uuNdZgGCUZd', 'function': {'arguments': '{"basename":"test"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 348, 'prompt_tokens': 2586, 'total_tokens': 2934, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--301b1f9c-9bec-4c90-a56c-124511d98545-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'test'}, 'id': 'call_QW3v7aNs1PTe0uuNdZgGCUZd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2586, 'output_tokens': 348, 'total_tokens': 2934, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 21:06:02,419 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Lt7BZEJ46NNCiMTAqmiK2d3k', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 354, 'prompt_tokens': 2818, 'total_tokens': 3172, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2304}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--88b87057-5f19-4055-9529-69669c416572-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile'}, 'id': 'call_Lt7BZEJ46NNCiMTAqmiK2d3k', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2818, 'output_tokens': 354, 'total_tokens': 3172, 'input_token_details': {'audio': 0, 'cache_read': 2304}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 21:06:03,581 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_V3HJDa6OfS7TWEwRdbNDVsqZ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 2893, 'total_tokens': 2919, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9831d08e-52df-48dc-b7ed-9b760c51af96-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider'}, 'id': 'call_V3HJDa6OfS7TWEwRdbNDVsqZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2893, 'output_tokens': 26, 'total_tokens': 2919, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:04,827 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_b4zoTESxzu167oq4SfQRXXLk', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 2964, 'total_tokens': 2993, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8217d39f-3a1b-4b68-8446-d68a60a25fe5-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile'}, 'id': 'call_b4zoTESxzu167oq4SfQRXXLk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2964, 'output_tokens': 29, 'total_tokens': 2993, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:11,960 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gHZGudW3AbSmbOXcBwnxsEBN', 'function': {'arguments': '{"relative_path":"test/unit/plugins/aws"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 480, 'prompt_tokens': 3027, 'total_tokens': 3507, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2944}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1a32067f-a0d1-45fe-b8b1-263f73a43b3a-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'test/unit/plugins/aws'}, 'id': 'call_gHZGudW3AbSmbOXcBwnxsEBN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3027, 'output_tokens': 480, 'total_tokens': 3507, 'input_token_details': {'audio': 0, 'cache_read': 2944}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:06:18,887 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JJ3sTbEG0EaY0dJWFsoKHPiQ', 'function': {'arguments': '{"basename":"tests"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 540, 'prompt_tokens': 3079, 'total_tokens': 3619, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b6789e60-d3b2-492d-81b3-c78f80e0f4ff-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'tests'}, 'id': 'call_JJ3sTbEG0EaY0dJWFsoKHPiQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3079, 'output_tokens': 540, 'total_tokens': 3619, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 21:06:20,187 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dlfbNCoEEWPcD43VQhiPvsa7', 'function': {'arguments': '{"relative_path":"tests"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 23, 'prompt_tokens': 3143, 'total_tokens': 3166, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8353ab03-1c4a-43a2-be2f-1f4df9fbf768-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'tests'}, 'id': 'call_dlfbNCoEEWPcD43VQhiPvsa7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3143, 'output_tokens': 23, 'total_tokens': 3166, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:21,102 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Fq5z9jnocSJShZn0MSDIwRBQ', 'function': {'arguments': '{"relative_path":"tests"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 24, 'prompt_tokens': 3208, 'total_tokens': 3232, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2560}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--796ce09c-6769-4dd8-b789-fdff2571bdf5-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests'}, 'id': 'call_Fq5z9jnocSJShZn0MSDIwRBQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3208, 'output_tokens': 24, 'total_tokens': 3232, 'input_token_details': {'audio': 0, 'cache_read': 2560}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:28,724 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pLafLb3ttMZuszZCINhisENL', 'function': {'arguments': '{"relative_path":"tests/unit"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 670, 'prompt_tokens': 3266, 'total_tokens': 3936, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2816}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d1832d6e-2dbe-4b2b-bb6a-e06dcc30eca5-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'tests/unit'}, 'id': 'call_pLafLb3ttMZuszZCINhisENL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3266, 'output_tokens': 670, 'total_tokens': 3936, 'input_token_details': {'audio': 0, 'cache_read': 2816}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:06:30,197 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_zPid5y3snnPv4riS1ZyD0OFn', 'function': {'arguments': '{"basename":"package"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 3316, 'total_tokens': 3338, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2816}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0bd17dd0-db38-4198-9584-4cb643376a22-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'package'}, 'id': 'call_zPid5y3snnPv4riS1ZyD0OFn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3316, 'output_tokens': 22, 'total_tokens': 3338, 'input_token_details': {'audio': 0, 'cache_read': 2816}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:31,245 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_FDpNGF2Aic2po9dmDTLJOg7t', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 3414, 'total_tokens': 3440, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a457170c-2420-4337-a396-87856d319fed-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package'}, 'id': 'call_FDpNGF2Aic2po9dmDTLJOg7t', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3414, 'output_tokens': 26, 'total_tokens': 3440, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:32,820 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_2z9hKGVglEZUrYNlCafHe5pG', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/iamRoleStatements.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 3485, 'total_tokens': 3519, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d4d016ed-b349-4486-a8a1-949417b408bc-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/iamRoleStatements.test.js'}, 'id': 'call_2z9hKGVglEZUrYNlCafHe5pG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3485, 'output_tokens': 34, 'total_tokens': 3519, 'input_token_details': {'audio': 0, 'cache_read': 3200}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:34,592 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_O6qilHUMWm8VRt1ZWXwJ9Hv1', 'function': {'arguments': '{"basename":"compile"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 3545, 'total_tokens': 3567, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8040608f-e45f-473d-8b8a-f8441db01df0-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'compile'}, 'id': 'call_O6qilHUMWm8VRt1ZWXwJ9Hv1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3545, 'output_tokens': 22, 'total_tokens': 3567, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:35,612 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_WV4V1Ts7nGRLrwm6Yzw1u1AV', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 3614, 'total_tokens': 3645, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--17a78a9d-90b5-4f9f-aa07-448ffb3ba5cc-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events.test.js'}, 'id': 'call_WV4V1Ts7nGRLrwm6Yzw1u1AV', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3614, 'output_tokens': 31, 'total_tokens': 3645, 'input_token_details': {'audio': 0, 'cache_read': 3200}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:42,922 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_MlcfcNuxs1LlLZfMTaKZZF1y', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/test"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 609, 'prompt_tokens': 3671, 'total_tokens': 4280, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3584}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6c2af7de-9863-4f96-a975-2108a39390d1-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/test'}, 'id': 'call_MlcfcNuxs1LlLZfMTaKZZF1y', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3671, 'output_tokens': 609, 'total_tokens': 4280, 'input_token_details': {'audio': 0, 'cache_read': 3584}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 21:06:44,336 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_iPknf57DN1wYewM8RUdrWuru', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/test"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 27, 'prompt_tokens': 3724, 'total_tokens': 3751, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2304}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c205d602-cbfd-4080-8e63-81588c1d21d4-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider/test'}, 'id': 'call_iPknf57DN1wYewM8RUdrWuru', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3724, 'output_tokens': 27, 'total_tokens': 3751, 'input_token_details': {'audio': 0, 'cache_read': 2304}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:06:52,187 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_c3IhxxM8iNALKVLiAeRthpMJ', 'function': {'arguments': '{"basename":"provider.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 733, 'prompt_tokens': 3777, 'total_tokens': 4510, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0421a5f0-4955-4aad-9228-1fce5e083ca8-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'provider.js'}, 'id': 'call_c3IhxxM8iNALKVLiAeRthpMJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3777, 'output_tokens': 733, 'total_tokens': 4510, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 21:07:00,835 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HxKyz1YBbvqTYKO38aJNdJpA', 'function': {'arguments': '{"basename":"naming.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 734, 'prompt_tokens': 3826, 'total_tokens': 4560, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3328}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8f771071-948e-46a4-878d-1dadc3206868-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'naming.js'}, 'id': 'call_HxKyz1YBbvqTYKO38aJNdJpA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3826, 'output_tokens': 734, 'total_tokens': 4560, 'input_token_details': {'audio': 0, 'cache_read': 3328}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 21:07:01,961 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OEsdG7sAZhNPfpXk4BYBsgIf', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 3900, 'total_tokens': 3930, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2944}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fbfb58c3-2867-403a-9e68-326e16e8c7c6-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.js'}, 'id': 'call_OEsdG7sAZhNPfpXk4BYBsgIf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3900, 'output_tokens': 30, 'total_tokens': 3930, 'input_token_details': {'audio': 0, 'cache_read': 2944}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:07:09,920 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_AORRo9hxRAox1d4v6voH9Btx', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 673, 'prompt_tokens': 9615, 'total_tokens': 10288, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b43eb22d-3dc5-4a00-8db1-2cc182b45d39-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider.js'}, 'id': 'call_AORRo9hxRAox1d4v6voH9Btx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9615, 'output_tokens': 673, 'total_tokens': 10288, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:07:15,492 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XMvKezVSU29wLOxkr3tFmFcz', 'function': {'arguments': '{"basename":"iamRoleStatements.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 479, 'prompt_tokens': 9668, 'total_tokens': 10147, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8a3e0dbc-9c59-43c9-9eb6-0ab8cf14866e-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iamRoleStatements.js'}, 'id': 'call_XMvKezVSU29wLOxkr3tFmFcz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9668, 'output_tokens': 479, 'total_tokens': 10147, 'input_token_details': {'audio': 0, 'cache_read': 3712}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:07:22,657 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5g7ucpuTtWfKmQ9IfwOHZndJ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/functions.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 676, 'prompt_tokens': 9719, 'total_tokens': 10395, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7a2ba707-2777-4272-bdf9-4ce802c3f203-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/functions.js'}, 'id': 'call_5g7ucpuTtWfKmQ9IfwOHZndJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9719, 'output_tokens': 676, 'total_tokens': 10395, 'input_token_details': {'audio': 0, 'cache_read': 3712}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:07:30,444 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_IYubDBEWTALhFziIehwwYwYS', 'function': {'arguments': '{"relative_path":"tests/unit/lib/plugins/aws/package/compile"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 804, 'prompt_tokens': 9775, 'total_tokens': 10579, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9600}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--914b0d92-2b37-4c98-bdbb-b154f7b0e61c-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'tests/unit/lib/plugins/aws/package/compile'}, 'id': 'call_IYubDBEWTALhFziIehwwYwYS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9775, 'output_tokens': 804, 'total_tokens': 10579, 'input_token_details': {'audio': 0, 'cache_read': 9600}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 21:07:40,010 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pwdzogJhsAlmyKOizU421No9', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/iamRole.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 870, 'prompt_tokens': 9831, 'total_tokens': 10701, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ce330c6f-b3de-443e-9a57-0996b78210cb-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/iamRole.js'}, 'id': 'call_pwdzogJhsAlmyKOizU421No9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9831, 'output_tokens': 870, 'total_tokens': 10701, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 21:07:49,615 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_BfBqEzVluy9vfmSdjZO8aLGd', 'function': {'arguments': '{"text":"IamRoleLambdaExecution","relative_path":"tests"}', 'name': 'find_ast_node_with_text_in_file_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 680, 'prompt_tokens': 9889, 'total_tokens': 10569, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3456}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ed5a6ae6-0547-470e-89dc-f251069c436e-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'IamRoleLambdaExecution', 'relative_path': 'tests'}, 'id': 'call_BfBqEzVluy9vfmSdjZO8aLGd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9889, 'output_tokens': 680, 'total_tokens': 10569, 'input_token_details': {'audio': 0, 'cache_read': 3456}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:07:54,098 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0thJNnhdpscBta4zzbZkqmbI', 'function': {'arguments': '{"basename":"aws"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 284, 'prompt_tokens': 9954, 'total_tokens': 10238, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d800a19b-d102-4603-9ff4-625469d29719-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'aws'}, 'id': 'call_0thJNnhdpscBta4zzbZkqmbI', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9954, 'output_tokens': 284, 'total_tokens': 10238, 'input_token_details': {'audio': 0, 'cache_read': 3712}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 21:07:56,753 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4y9kieUEvf7cBOPoBlldKpjg', 'function': {'arguments': '{"relative_path":"lib/plugins/aws"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 10051, 'total_tokens': 10077, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9856}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e32c41ff-3f5c-4a65-be35-627802aad880-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws'}, 'id': 'call_4y9kieUEvf7cBOPoBlldKpjg', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10051, 'output_tokens': 26, 'total_tokens': 10077, 'input_token_details': {'audio': 0, 'cache_read': 9856}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:08:06,970 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_68P3KlDgRiktcvdmV0vs65OB', 'function': {'arguments': '{"basename":"iam-policy.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 799, 'prompt_tokens': 10111, 'total_tokens': 10910, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3328}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--17ca1632-5789-44c7-bbec-7e1df88c0064-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam-policy.test.js'}, 'id': 'call_68P3KlDgRiktcvdmV0vs65OB', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10111, 'output_tokens': 799, 'total_tokens': 10910, 'input_token_details': {'audio': 0, 'cache_read': 3328}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 21:08:13,950 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_n69v9nX0rE3m6AtPRJ51uPcW', 'function': {'arguments': '{"basename":"integration"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 476, 'prompt_tokens': 10162, 'total_tokens': 10638, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3840}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fe700741-d258-4524-85b3-ae8de33def12-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'integration'}, 'id': 'call_n69v9nX0rE3m6AtPRJ51uPcW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10162, 'output_tokens': 476, 'total_tokens': 10638, 'input_token_details': {'audio': 0, 'cache_read': 3840}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:08:24,868 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_YWjeClsefK8yQdqKGAPFBvhg', 'function': {'arguments': '{"basename":"unit"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 860, 'prompt_tokens': 10210, 'total_tokens': 11070, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9856}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--92530b24-2f54-4a30-98ba-ecf6e6142362-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'unit'}, 'id': 'call_YWjeClsefK8yQdqKGAPFBvhg', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10210, 'output_tokens': 860, 'total_tokens': 11070, 'input_token_details': {'audio': 0, 'cache_read': 9856}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 21:08:36,630 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_QJ3h8ZHtlnfMoQzGxj1YkUCZ', 'function': {'arguments': '{"basename":"iam.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 861, 'prompt_tokens': 10258, 'total_tokens': 11119, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10112}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--97f553f2-ad18-4b5d-bc62-c131e06db8bc-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam.js'}, 'id': 'call_QJ3h8ZHtlnfMoQzGxj1YkUCZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10258, 'output_tokens': 861, 'total_tokens': 11119, 'input_token_details': {'audio': 0, 'cache_read': 10112}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 21:08:48,144 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OsYIXirCEWvojDWDrPH6E4cT', 'function': {'arguments': '{"basename":"iam"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 668, 'prompt_tokens': 10307, 'total_tokens': 10975, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--062ed5c3-eec8-4b45-973f-62b9552c6faf-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam'}, 'id': 'call_OsYIXirCEWvojDWDrPH6E4cT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10307, 'output_tokens': 668, 'total_tokens': 10975, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:08:53,554 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_bLYq89suopF6VhZb1zoNFM3h', 'function': {'arguments': '{"basename":"naming.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 415, 'prompt_tokens': 10355, 'total_tokens': 10770, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9728}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fcf9f3d8-1690-4150-b2ae-f3d9c52e8861-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'naming.test.js'}, 'id': 'call_bLYq89suopF6VhZb1zoNFM3h', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10355, 'output_tokens': 415, 'total_tokens': 10770, 'input_token_details': {'audio': 0, 'cache_read': 9728}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 21:08:54,838 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ndfGtop8XC4aJcCIUrlbx4fQ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 10432, 'total_tokens': 10463, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9600}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--873b589e-53d7-4482-8553-181105381503-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.test.js'}, 'id': 'call_ndfGtop8XC4aJcCIUrlbx4fQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10432, 'output_tokens': 31, 'total_tokens': 10463, 'input_token_details': {'audio': 0, 'cache_read': 9600}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:09:01,974 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xqSvRjWdeMmCTaOTFo6yAfzn', 'function': {'arguments': '{"basename":"test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 477, 'prompt_tokens': 16870, 'total_tokens': 17347, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10240}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dd78893b-123c-43d8-9bd3-b6ac57d99536-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'test.js'}, 'id': 'call_xqSvRjWdeMmCTaOTFo6yAfzn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16870, 'output_tokens': 477, 'total_tokens': 17347, 'input_token_details': {'audio': 0, 'cache_read': 10240}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:09:09,666 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_WPiIPPXjJaRY2AezzS2Pt7ZM', 'function': {'arguments': '{"basename":"iamRole.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 607, 'prompt_tokens': 16919, 'total_tokens': 17526, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--20bfbf90-bafd-400d-8a26-e16f445b2db1-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iamRole.test.js'}, 'id': 'call_WPiIPPXjJaRY2AezzS2Pt7ZM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16919, 'output_tokens': 607, 'total_tokens': 17526, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 21:09:16,090 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xGSVNEMwd0tUvZVxHUnaneZ0', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 611, 'prompt_tokens': 16970, 'total_tokens': 17581, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3456}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3e9114cb-ac09-4478-8987-38b3534674e2-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js'}, 'id': 'call_xGSVNEMwd0tUvZVxHUnaneZ0', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16970, 'output_tokens': 611, 'total_tokens': 17581, 'input_token_details': {'audio': 0, 'cache_read': 3456}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 21:09:19,140 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_cxxYUE0MTjnU0Btk9SoCvTEj', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 17049, 'total_tokens': 17079, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3072}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2e0b1d55-2482-4429-838f-564e36f1869a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js'}, 'id': 'call_cxxYUE0MTjnU0Btk9SoCvTEj', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17049, 'output_tokens': 30, 'total_tokens': 17079, 'input_token_details': {'audio': 0, 'cache_read': 3072}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:09:25,254 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_zjhz9tIdl8HtRJX1ObrY4aya', 'function': {'arguments': '{"text":"iamRoleStatements","basename":"lib"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 486, 'prompt_tokens': 22668, 'total_tokens': 23154, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 16768}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7b5050b6-6014-4276-bf34-e860f38489c8-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'iamRoleStatements', 'basename': 'lib'}, 'id': 'call_zjhz9tIdl8HtRJX1ObrY4aya', 'type': 'tool_call'}] usage_metadata={'input_tokens': 22668, 'output_tokens': 486, 'total_tokens': 23154, 'input_token_details': {'audio': 0, 'cache_read': 16768}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:09:37,426 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HhwFzTM4qiCI22AEqvFrPDD1', 'function': {'arguments': '{"basename":"awsProvider.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 799, 'prompt_tokens': 22731, 'total_tokens': 23530, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10112}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--613a2c2d-1ce6-4e5f-a36f-db505216f64b-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'awsProvider.test.js'}, 'id': 'call_HhwFzTM4qiCI22AEqvFrPDD1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 22731, 'output_tokens': 799, 'total_tokens': 23530, 'input_token_details': {'audio': 0, 'cache_read': 10112}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 21:09:39,171 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_wuBzhWRf31qdLB4odfA7YNKc', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 22808, 'total_tokens': 22839, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2e4fe26d-6ad0-4baa-bf7c-89670ef78572-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.test.js'}, 'id': 'call_wuBzhWRf31qdLB4odfA7YNKc', 'type': 'tool_call'}] usage_metadata={'input_tokens': 22808, 'output_tokens': 31, 'total_tokens': 22839, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:09:50,414 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_FKdKcgXPwmLYXEdxcAtKuhC7', 'function': {'arguments': '{"basename":"policy.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 734, 'prompt_tokens': 27906, 'total_tokens': 28640, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 22656}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--33a54bc4-9649-4ba5-a408-0eeaebcf3edf-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'policy.test.js'}, 'id': 'call_FKdKcgXPwmLYXEdxcAtKuhC7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27906, 'output_tokens': 734, 'total_tokens': 28640, 'input_token_details': {'audio': 0, 'cache_read': 22656}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 21:10:03,397 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_32TbGIvUXKu5G7OOxQW0ntls', 'function': {'arguments': '{"basename":"index.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 925, 'prompt_tokens': 27956, 'total_tokens': 28881, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27904}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d809a872-f472-4134-bf40-c2845fe21e53-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'index.js'}, 'id': 'call_32TbGIvUXKu5G7OOxQW0ntls', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27956, 'output_tokens': 925, 'total_tokens': 28881, 'input_token_details': {'audio': 0, 'cache_read': 27904}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 21:10:05,233 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ADYUkDi6Ia2cyxCXkK5wuCZo', 'function': {'arguments': '{"basename":"naming.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 24, 'prompt_tokens': 28166, 'total_tokens': 28190, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9728}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--671cab14-a4ab-44fc-a986-5ed2c31776d7-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'naming.js'}, 'id': 'call_ADYUkDi6Ia2cyxCXkK5wuCZo', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28166, 'output_tokens': 24, 'total_tokens': 28190, 'input_token_details': {'audio': 0, 'cache_read': 9728}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:10:18,537 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_jKMmONnwf7tHY3sqHo1WdhPu', 'function': {'arguments': '{"basename":"iam"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1052, 'prompt_tokens': 28240, 'total_tokens': 29292, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1024, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27904}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2c4abac1-1596-466e-83a0-e30ef964c8aa-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam'}, 'id': 'call_jKMmONnwf7tHY3sqHo1WdhPu', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28240, 'output_tokens': 1052, 'total_tokens': 29292, 'input_token_details': {'audio': 0, 'cache_read': 27904}, 'output_token_details': {'audio': 0, 'reasoning': 1024}}
2025-11-13 21:10:27,433 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nuvV3bEEwfb0fZj7wfSoZZSj', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/compileIam.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 871, 'prompt_tokens': 28288, 'total_tokens': 29159, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 16896}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dfafaaad-cd15-4fa3-a4a3-14ddb1aba505-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/compileIam.test.js'}, 'id': 'call_nuvV3bEEwfb0fZj7wfSoZZSj', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28288, 'output_tokens': 871, 'total_tokens': 29159, 'input_token_details': {'audio': 0, 'cache_read': 16896}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 21:10:27,440 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - DEBUG - Graph recursion limit reached, returning empty context
2025-11-13 21:10:27,440 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - INFO - Recursion limit reached, returning empty regression tests
2025-11-13 21:10:27,441 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

2025-11-13 21:10:27,443 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 21:10:27,446 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 21:10:46,574 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The task is to locate production code and docs relevant to IAM role statements so we can support NotAction and NotResource. The file tree does not show the contents of key AWS packaging and validation files where iamRoleStatements are processed, nor the doc pages describing IAM usage in Serverless. To identify where NotAction/NotResource are currently rejected and what patterns to follow, we need the implementations that (a) validate service configuration, (b) compile IAM policies/roles into CloudFormation, and (c) provider-level handling of iamRoleStatements. Therefore, additional context is essential.' query='Please provide the contents of lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and any files under lib/plugins/aws/package/lib and lib/plugins/aws/package/compile that handle IAM roles/policies and iamRoleStatements.' extra_requirements='If the exact files are unclear, include a directory listing and code snippets (with paths) for any modules referencing iamRoleStatements, IAM, Role, Policy, NotAction, or NotResource.' purpose='I need to pinpoint where NotAction/NotResource are rejected and understand the architectural patterns to integrate support consistently.'
2025-11-13 21:10:46,575 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the contents of lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and any files under lib/plugins/aws/package/lib and lib/plugins/aws/package/compile that handle IAM roles/policies and iamRoleStatements.
2025-11-13 21:10:50,547 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 21:10:50,547 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 21:10:50,547 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 21:10:50,547 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 21:10:50,549 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 21:10:50,550 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 21:10:50,550 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the contents of lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and any files under lib/plugins/aws/package/lib and lib/plugins/aws/package/compile that handle IAM roles/policies and iamRoleStatements.
Extra requirements: If the exact files are unclear, include a directory listing and code snippets (with paths) for any modules referencing iamRoleStatements, IAM, Role, Policy, NotAction, or NotResource.
Purpose: I need to pinpoint where NotAction/NotResource are rejected and understand the architectural patterns to integrate support consistently.
2025-11-13 21:11:01,486 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_WdmtumemoP2IM3XceoKeGbG6', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/validate.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 995, 'prompt_tokens': 2287, 'total_tokens': 3282, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dbef2ea1-6a51-4f6c-b6a6-d6f0d8d3721a-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/lib/validate.js'}, 'id': 'call_WdmtumemoP2IM3XceoKeGbG6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2287, 'output_tokens': 995, 'total_tokens': 3282, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 21:11:03,227 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_bpntXbUvh1buHzY7yyKQbxxx', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/validate.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 2365, 'total_tokens': 2395, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2a4d7c6d-8780-41d1-a3ae-ddd91249ee9f-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/validate.js'}, 'id': 'call_bpntXbUvh1buHzY7yyKQbxxx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2365, 'output_tokens': 30, 'total_tokens': 2395, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:05,693 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9BldxAVJZ1aS1sDAk1IYwMx1', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 3142, 'total_tokens': 3177, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0ee00ef7-65cb-40a1-ba2c-0e3e8c56889b-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js'}, 'id': 'call_9BldxAVJZ1aS1sDAk1IYwMx1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3142, 'output_tokens': 35, 'total_tokens': 3177, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:07,155 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_knqAMSLiouIXlSVyHprHWN1w', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 3221, 'total_tokens': 3251, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2304}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e21fa268-947e-4e0a-b720-7027c6ba3328-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js'}, 'id': 'call_knqAMSLiouIXlSVyHprHWN1w', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3221, 'output_tokens': 30, 'total_tokens': 3251, 'input_token_details': {'audio': 0, 'cache_read': 2304}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:08,409 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Dx02fEzty7XPb21xZsQ50aKd', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js","start_line":500,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 8840, 'total_tokens': 8879, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fd389db2-bc20-4274-8790-f11b7f40e480-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js', 'start_line': 500, 'end_line': 1000}, 'id': 'call_Dx02fEzty7XPb21xZsQ50aKd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 8840, 'output_tokens': 39, 'total_tokens': 8879, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:22,351 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4OAD9XJpceUtMBSFlcOJddJ8', 'function': {'arguments': '{"text":"iamRoleStatements","relative_path":"lib/plugins/aws"}', 'name': 'find_ast_node_with_text_in_file_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1129, 'prompt_tokens': 10217, 'total_tokens': 11346, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1088, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9ee1b3d8-cfa4-433f-9725-b9b444570864-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'iamRoleStatements', 'relative_path': 'lib/plugins/aws'}, 'id': 'call_4OAD9XJpceUtMBSFlcOJddJ8', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10217, 'output_tokens': 1129, 'total_tokens': 11346, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 1088}}
2025-11-13 21:11:30,492 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4IV7G5u0YIDb39OdXf0V2SEq', 'function': {'arguments': '{"basename":"iamRoleStatements.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 799, 'prompt_tokens': 10283, 'total_tokens': 11082, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7fb3e5f9-5966-407b-b074-9b20bfe90c53-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iamRoleStatements.js'}, 'id': 'call_4IV7G5u0YIDb39OdXf0V2SEq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10283, 'output_tokens': 799, 'total_tokens': 11082, 'input_token_details': {'audio': 0, 'cache_read': 3200}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 21:11:38,367 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_DdugkrzxfXCVdxkLSiY35kM6', 'function': {'arguments': '{"text":"iamRoleStatements","basename":"aws"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 742, 'prompt_tokens': 10334, 'total_tokens': 11076, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10240}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ee60fc85-125d-42e8-afac-8f162e835b1d-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'iamRoleStatements', 'basename': 'aws'}, 'id': 'call_DdugkrzxfXCVdxkLSiY35kM6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10334, 'output_tokens': 742, 'total_tokens': 11076, 'input_token_details': {'audio': 0, 'cache_read': 10240}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 21:11:41,503 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ZZCMPuoxCNh0ZDKipjZg8p1C', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 225, 'prompt_tokens': 10397, 'total_tokens': 10622, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10112}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4b9882cc-4f3a-4906-8968-20535082f38e-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib'}, 'id': 'call_ZZCMPuoxCNh0ZDKipjZg8p1C', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10397, 'output_tokens': 225, 'total_tokens': 10622, 'input_token_details': {'audio': 0, 'cache_read': 10112}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 21:11:43,386 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_M9oPhBkvyzkgkBJDTtHtjd2R', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 10470, 'total_tokens': 10498, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10368}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2db185db-b86a-404b-8161-9b6cbcba76cb-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile'}, 'id': 'call_M9oPhBkvyzkgkBJDTtHtjd2R', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10470, 'output_tokens': 28, 'total_tokens': 10498, 'input_token_details': {'audio': 0, 'cache_read': 10368}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:44,633 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_BRbxEPX8sEZzssAJaNhysDqE', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 10545, 'total_tokens': 10573, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10368}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--63242aa1-29eb-410a-bf23-849fc6aa84ae-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/lib'}, 'id': 'call_BRbxEPX8sEZzssAJaNhysDqE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10545, 'output_tokens': 28, 'total_tokens': 10573, 'input_token_details': {'audio': 0, 'cache_read': 10368}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:45,994 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kDpwEHXWFxMaJVME2KfIiXgD', 'function': {'arguments': '{"basename":"package"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 10607, 'total_tokens': 10629, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--660ad403-ef73-4797-91b9-4940f75e1d36-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'package'}, 'id': 'call_kDpwEHXWFxMaJVME2KfIiXgD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10607, 'output_tokens': 22, 'total_tokens': 10629, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:48,671 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_K1uHJSRv8KJW4ZSc2dhhhO9O', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 10705, 'total_tokens': 10731, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6f95ad48-3c47-4e96-8655-48f06321972c-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package'}, 'id': 'call_K1uHJSRv8KJW4ZSc2dhhhO9O', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10705, 'output_tokens': 26, 'total_tokens': 10731, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:50,248 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_afLsbRoS0ubuo8SdlUAAB9KZ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 27, 'prompt_tokens': 10776, 'total_tokens': 10803, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e6cc9dd3-75f6-44c9-8e03-363d3b655e99-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package'}, 'id': 'call_afLsbRoS0ubuo8SdlUAAB9KZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10776, 'output_tokens': 27, 'total_tokens': 10803, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:11:58,261 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_zi1nTcuVZrakRriMdkC5Lfsu', 'function': {'arguments': '{"text":"iamRoleStatements","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 551, 'prompt_tokens': 10837, 'total_tokens': 11388, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10240}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b5cc5651-bd5b-4490-87f5-42f562da358e-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'iamRoleStatements', 'basename': 'index.js'}, 'id': 'call_zi1nTcuVZrakRriMdkC5Lfsu', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10837, 'output_tokens': 551, 'total_tokens': 11388, 'input_token_details': {'audio': 0, 'cache_read': 10240}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 21:12:12,853 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7Gy3Yta9j8edY3d4dxbFClKA', 'function': {'arguments': '{"text":"AWS::IAM::Role","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1001, 'prompt_tokens': 20516, 'total_tokens': 21517, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10624}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--430a2f5f-7ed0-4460-818f-96dcfd650adc-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'AWS::IAM::Role', 'basename': 'index.js'}, 'id': 'call_7Gy3Yta9j8edY3d4dxbFClKA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 20516, 'output_tokens': 1001, 'total_tokens': 21517, 'input_token_details': {'audio': 0, 'cache_read': 10624}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 21:12:18,115 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hzdPNNBJ55AGIAc66NCaa8ot', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/functions/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 357, 'prompt_tokens': 24662, 'total_tokens': 25019, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 20480}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--de8a0785-4536-466b-96f1-0693b0e1d560-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/functions/index.js'}, 'id': 'call_hzdPNNBJ55AGIAc66NCaa8ot', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24662, 'output_tokens': 357, 'total_tokens': 25019, 'input_token_details': {'audio': 0, 'cache_read': 20480}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 21:12:19,872 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_a4iFgfjNjYXofwkb0MB0OYRQ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/functions/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 24744, 'total_tokens': 24776, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10752}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6e9b1939-3b52-41c2-8462-67ceeab670a6-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/functions/index.js'}, 'id': 'call_a4iFgfjNjYXofwkb0MB0OYRQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24744, 'output_tokens': 32, 'total_tokens': 24776, 'input_token_details': {'audio': 0, 'cache_read': 10752}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:22,028 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_j7CPU7C7T9SyvUQb2aR8wFbo', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/functions/index.js","start_line":500,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 30449, 'total_tokens': 30490, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5fb3d8f8-97dc-4f53-82a0-166a02815797-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/functions/index.js', 'start_line': 500, 'end_line': 1000}, 'id': 'call_j7CPU7C7T9SyvUQb2aR8wFbo', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30449, 'output_tokens': 41, 'total_tokens': 30490, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:23,909 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_qOnnavMhtsP0sePYxNUGbA2z', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/eventBridge/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 31344, 'total_tokens': 31377, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30464}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1e48b790-c1f3-4e43-9f4a-cb88143d8e7d-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/eventBridge/index.js'}, 'id': 'call_qOnnavMhtsP0sePYxNUGbA2z', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31344, 'output_tokens': 33, 'total_tokens': 31377, 'input_token_details': {'audio': 0, 'cache_read': 30464}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:25,524 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_fGaboUnx6JOkDw2mNsLkZsbm', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/eventBridge/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 31430, 'total_tokens': 31464, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24704}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bc26201d-6a54-4997-b562-b2317bed34b2-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/eventBridge/index.js'}, 'id': 'call_fGaboUnx6JOkDw2mNsLkZsbm', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31430, 'output_tokens': 34, 'total_tokens': 31464, 'input_token_details': {'audio': 0, 'cache_read': 24704}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:28,530 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NbyKt9mJn3AjUtX2iKrslCTK', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/s3/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 33564, 'total_tokens': 33597, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--000e9217-6c27-4fb6-8615-ea891192cafd-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/s3/index.js'}, 'id': 'call_NbyKt9mJn3AjUtX2iKrslCTK', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33564, 'output_tokens': 33, 'total_tokens': 33597, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:30,557 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_uUjqX8aPTgpXlm6WjmeSNaJY', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/s3/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 33650, 'total_tokens': 33684, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--41a790d0-be14-42e7-959b-0568d9711e6d-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/s3/index.js'}, 'id': 'call_uUjqX8aPTgpXlm6WjmeSNaJY', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33650, 'output_tokens': 34, 'total_tokens': 33684, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:34,735 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xeSzX7TTZS5LrYAhwYFiNoeG', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 37512, 'total_tokens': 37538, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4dfd818e-aba5-44f5-988d-2d949ad38440-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package'}, 'id': 'call_xeSzX7TTZS5LrYAhwYFiNoeG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37512, 'output_tokens': 26, 'total_tokens': 37538, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:37,149 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Qmbz32ClUYCxHjwGtBVjye0F', 'function': {'arguments': '{"relative_path":"lib/plugins/aws"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 37583, 'total_tokens': 37608, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10624}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7efc9217-6a5a-4e6a-8f25-828ea48a52bf-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws'}, 'id': 'call_Qmbz32ClUYCxHjwGtBVjye0F', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37583, 'output_tokens': 25, 'total_tokens': 37608, 'input_token_details': {'audio': 0, 'cache_read': 10624}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:40,727 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3maassgTwqRN5NxNwOzMc5Ak', 'function': {'arguments': '{"relative_path":"lib/plugins/aws"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 37652, 'total_tokens': 37678, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d94a56a6-00cc-4d1b-97ba-780e0f917bc0-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws'}, 'id': 'call_3maassgTwqRN5NxNwOzMc5Ak', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37652, 'output_tokens': 26, 'total_tokens': 37678, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:42,341 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_oQtdsslxFMCsgGLEtX1zgMIl', 'function': {'arguments': '{"text":"iamRoleStatements","basename":"customResources/index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 37712, 'total_tokens': 37747, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 31360}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--37016b8c-b281-4df9-a543-1d052b4c76b9-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'iamRoleStatements', 'basename': 'customResources/index.js'}, 'id': 'call_oQtdsslxFMCsgGLEtX1zgMIl', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37712, 'output_tokens': 35, 'total_tokens': 37747, 'input_token_details': {'audio': 0, 'cache_read': 31360}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:44,149 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VE3G2XKSNZnEeqN4iRXdHkTt', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 37777, 'total_tokens': 37806, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 31360}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--80a100d2-59f0-412c-bcc6-6d9fc6d5f436-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_VE3G2XKSNZnEeqN4iRXdHkTt', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37777, 'output_tokens': 29, 'total_tokens': 37806, 'input_token_details': {'audio': 0, 'cache_read': 31360}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:45,946 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_RFSmUzkd4iZYLKKEyQFJ8Cdd', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 37855, 'total_tokens': 37885, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 37504}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f1785852-4286-4567-b243-61768229ce7e-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_RFSmUzkd4iZYLKKEyQFJ8Cdd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37855, 'output_tokens': 30, 'total_tokens': 37885, 'input_token_details': {'audio': 0, 'cache_read': 37504}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:47,908 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_tKVkr6hDs95GlBqoHHBaYmcR', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/layers/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 40350, 'total_tokens': 40382, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 37504}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--60ea9b72-de7e-4df1-aec0-f2a55399917a-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/layers/index.js'}, 'id': 'call_tKVkr6hDs95GlBqoHHBaYmcR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 40350, 'output_tokens': 32, 'total_tokens': 40382, 'input_token_details': {'audio': 0, 'cache_read': 37504}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:50,050 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_SNPh1LioVgNmzDiJLDXpQJdj', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/layers/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 40434, 'total_tokens': 40467, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 33536}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7d2827f8-3e9a-4848-bf68-a1d8d822793e-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/layers/index.js'}, 'id': 'call_SNPh1LioVgNmzDiJLDXpQJdj', 'type': 'tool_call'}] usage_metadata={'input_tokens': 40434, 'output_tokens': 33, 'total_tokens': 40467, 'input_token_details': {'audio': 0, 'cache_read': 33536}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:52,004 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OVPGIP3YzrgV9ywWzyGAQm2J', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/iam/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 42005, 'total_tokens': 42037, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 37760}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e43b4ae7-c595-4465-94be-4cfc2894f6cd-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/iam/index.js'}, 'id': 'call_OVPGIP3YzrgV9ywWzyGAQm2J', 'type': 'tool_call'}] usage_metadata={'input_tokens': 42005, 'output_tokens': 32, 'total_tokens': 42037, 'input_token_details': {'audio': 0, 'cache_read': 37760}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:53,948 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_a2ZhADoNUOtmgTIUtHT5QI3f', 'function': {'arguments': '{"basename":"iam"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 42063, 'total_tokens': 42085, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24576}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--66141c39-6b10-41e2-bddb-b1ad2ef89c07-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam'}, 'id': 'call_a2ZhADoNUOtmgTIUtHT5QI3f', 'type': 'tool_call'}] usage_metadata={'input_tokens': 42063, 'output_tokens': 22, 'total_tokens': 42085, 'input_token_details': {'audio': 0, 'cache_read': 24576}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:56,329 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CO8FvzUEDA9YnhqEszWxyMdl', 'function': {'arguments': '{"text":"IamRoleLambdaExecution","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 42111, 'total_tokens': 42145, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 40320}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3902af8c-3551-4696-a574-d48fd374f194-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'IamRoleLambdaExecution', 'basename': 'index.js'}, 'id': 'call_CO8FvzUEDA9YnhqEszWxyMdl', 'type': 'tool_call'}] usage_metadata={'input_tokens': 42111, 'output_tokens': 34, 'total_tokens': 42145, 'input_token_details': {'audio': 0, 'cache_read': 40320}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:12:58,542 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_UdXckq5lggBEejk8VMf5ddk9', 'function': {'arguments': '{"text":"IAM::Policy","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 54105, 'total_tokens': 54138, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 33664}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--19c9cc18-a67e-48eb-8692-649fd3ca15ce-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'IAM::Policy', 'basename': 'index.js'}, 'id': 'call_UdXckq5lggBEejk8VMf5ddk9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 54105, 'output_tokens': 33, 'total_tokens': 54138, 'input_token_details': {'audio': 0, 'cache_read': 33664}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:07,956 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HeYloXX3qECSCJuaXmd4GaWn', 'function': {'arguments': '{"text":"NotAction","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 678, 'prompt_tokens': 54168, 'total_tokens': 54846, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 40448}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1129830b-685b-435e-848f-96d89992bf99-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'NotAction', 'basename': 'index.js'}, 'id': 'call_HeYloXX3qECSCJuaXmd4GaWn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 54168, 'output_tokens': 678, 'total_tokens': 54846, 'input_token_details': {'audio': 0, 'cache_read': 40448}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:13:11,275 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0EMnmr14KCtejGI5DIxshXg2', 'function': {'arguments': '{"text":"NotAction","basename":"awsProvider.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 54230, 'total_tokens': 54263, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 37632}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ae51a895-4beb-4e00-91d9-74ef0c9ea117-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'NotAction', 'basename': 'awsProvider.js'}, 'id': 'call_0EMnmr14KCtejGI5DIxshXg2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 54230, 'output_tokens': 33, 'total_tokens': 54263, 'input_token_details': {'audio': 0, 'cache_read': 37632}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:15,367 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HzQxDuUhPlNFcGdYkH2FSJew', 'function': {'arguments': '{"text":"NotAction"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 54293, 'total_tokens': 54315, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10752}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--876d7c30-4759-4621-a205-5ce268a54879-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'NotAction'}, 'id': 'call_HzQxDuUhPlNFcGdYkH2FSJew', 'type': 'tool_call'}] usage_metadata={'input_tokens': 54293, 'output_tokens': 22, 'total_tokens': 54315, 'input_token_details': {'audio': 0, 'cache_read': 10752}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:18,560 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ksRHLbcmo3z1LV9i0BQZf00m', 'function': {'arguments': '{"text":"AWS::IAM::Role","basename":"policy"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 54340, 'total_tokens': 54374, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10496}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--235900a5-861e-48e3-a4ee-da606dadf4cc-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'AWS::IAM::Role', 'basename': 'policy'}, 'id': 'call_ksRHLbcmo3z1LV9i0BQZf00m', 'type': 'tool_call'}] usage_metadata={'input_tokens': 54340, 'output_tokens': 34, 'total_tokens': 54374, 'input_token_details': {'audio': 0, 'cache_read': 10496}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:20,959 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PifuyQb3IH9xZi7Odl6NZDnl', 'function': {'arguments': '{"basename":"naming.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 24, 'prompt_tokens': 54404, 'total_tokens': 54428, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 54272}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0197dbc5-c1cb-4687-893f-135d736464af-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'naming.js'}, 'id': 'call_PifuyQb3IH9xZi7Odl6NZDnl', 'type': 'tool_call'}] usage_metadata={'input_tokens': 54404, 'output_tokens': 24, 'total_tokens': 54428, 'input_token_details': {'audio': 0, 'cache_read': 54272}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:24,129 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Gu2waCLG1SMtQsqjxoI8Fd9M', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 54478, 'total_tokens': 54508, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 54144}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--36f00e5a-5714-4934-b2cc-86d677617658-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.js'}, 'id': 'call_Gu2waCLG1SMtQsqjxoI8Fd9M', 'type': 'tool_call'}] usage_metadata={'input_tokens': 54478, 'output_tokens': 30, 'total_tokens': 54508, 'input_token_details': {'audio': 0, 'cache_read': 54144}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:26,464 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4guzbQrwqYdZDjVRtKzH5xXr', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.js","start_line":500,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 60193, 'total_tokens': 60232, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 37632}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ab164cd3-60a4-4deb-868d-91fce7da6986-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.js', 'start_line': 500, 'end_line': 1000}, 'id': 'call_4guzbQrwqYdZDjVRtKzH5xXr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 60193, 'output_tokens': 39, 'total_tokens': 60232, 'input_token_details': {'audio': 0, 'cache_read': 37632}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:29,587 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xB3ylBuuZvsxAXc2b5xB8dJs', 'function': {'arguments': '{"text":"IamRoleLambdaExecution","basename":"validate.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 60661, 'total_tokens': 60695, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 41984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7105d612-e513-4a19-89ab-087cc043c63a-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'IamRoleLambdaExecution', 'basename': 'validate.js'}, 'id': 'call_xB3ylBuuZvsxAXc2b5xB8dJs', 'type': 'tool_call'}] usage_metadata={'input_tokens': 60661, 'output_tokens': 34, 'total_tokens': 60695, 'input_token_details': {'audio': 0, 'cache_read': 41984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:32,152 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_mGLJbLBL2vOVgQrzTYT9rc8A', 'function': {'arguments': '{"text":"NotResource","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 60725, 'total_tokens': 60757, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 37760}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a77224af-b31c-4738-a5ae-e393a3215c97-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'NotResource', 'basename': 'index.js'}, 'id': 'call_mGLJbLBL2vOVgQrzTYT9rc8A', 'type': 'tool_call'}] usage_metadata={'input_tokens': 60725, 'output_tokens': 32, 'total_tokens': 60757, 'input_token_details': {'audio': 0, 'cache_read': 37760}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:41,539 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_v6fi5kwK4EbCKW2T8ekB7ZLk', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 739, 'prompt_tokens': 60787, 'total_tokens': 61526, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 54272}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2bbb1b0c-5639-4a89-a8c2-a1913065c727-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib/index.js'}, 'id': 'call_v6fi5kwK4EbCKW2T8ekB7ZLk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 60787, 'output_tokens': 739, 'total_tokens': 61526, 'input_token_details': {'audio': 0, 'cache_read': 54272}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 21:13:43,440 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_GBe0lyCtuOaGgPEzR02qtxkk', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 27, 'prompt_tokens': 60842, 'total_tokens': 60869, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 54016}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e112f5f8-4f0d-4598-bf2f-8c60a5cf33f2-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/lib'}, 'id': 'call_GBe0lyCtuOaGgPEzR02qtxkk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 60842, 'output_tokens': 27, 'total_tokens': 60869, 'input_token_details': {'audio': 0, 'cache_read': 54016}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:45,911 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Uaf8G97mAmJXNpTDSsbZku6y', 'function': {'arguments': '{"basename":"lib"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 22, 'prompt_tokens': 60915, 'total_tokens': 60937, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 41984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f8d74858-3961-4629-bbb2-00b964eeab2e-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'lib'}, 'id': 'call_Uaf8G97mAmJXNpTDSsbZku6y', 'type': 'tool_call'}] usage_metadata={'input_tokens': 60915, 'output_tokens': 22, 'total_tokens': 60937, 'input_token_details': {'audio': 0, 'cache_read': 41984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:49,168 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3UUPiU2MoFR2lbUtyZvPasF4', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/remove/lib"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 27, 'prompt_tokens': 61108, 'total_tokens': 61135, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1bef73da-7f85-4342-98d9-5f904fe5f849-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/remove/lib'}, 'id': 'call_3UUPiU2MoFR2lbUtyZvPasF4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 61108, 'output_tokens': 27, 'total_tokens': 61135, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:51,051 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CDRAAqphP5GVGWbCYwZkEUx2', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/remove/lib/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 61181, 'total_tokens': 61210, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 60160}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c9dea4f0-db2e-4b2d-a1cb-b9d85ef5460c-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/remove/lib/index.js'}, 'id': 'call_CDRAAqphP5GVGWbCYwZkEUx2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 61181, 'output_tokens': 29, 'total_tokens': 61210, 'input_token_details': {'audio': 0, 'cache_read': 60160}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:53,108 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_olSkyNrFgr7bvtgjc82VpPlb', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 61236, 'total_tokens': 61265, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 61056}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--47f57501-ae26-4bf8-a1cc-9fefcc53bb20-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events'}, 'id': 'call_olSkyNrFgr7bvtgjc82VpPlb', 'type': 'tool_call'}] usage_metadata={'input_tokens': 61236, 'output_tokens': 29, 'total_tokens': 61265, 'input_token_details': {'audio': 0, 'cache_read': 61056}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:56,240 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_DvQITBeFw8qZiAt45YI3RJr4', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/cognitoUserPool/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 61313, 'total_tokens': 61348, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 54144}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--05345e98-37b9-4df0-a778-5cb3449a7b30-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/cognitoUserPool/index.js'}, 'id': 'call_DvQITBeFw8qZiAt45YI3RJr4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 61313, 'output_tokens': 35, 'total_tokens': 61348, 'input_token_details': {'audio': 0, 'cache_read': 54144}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:13:58,198 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_m6JoQxJMJmCik6hT8RMTCocR', 'function': {'arguments': '{"text":"PolicyDocument","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 61403, 'total_tokens': 61435, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 60672}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d677512c-3444-4460-989e-1d10e7a549aa-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'PolicyDocument', 'basename': 'index.js'}, 'id': 'call_m6JoQxJMJmCik6hT8RMTCocR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 61403, 'output_tokens': 32, 'total_tokens': 61435, 'input_token_details': {'audio': 0, 'cache_read': 60672}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:14:24,851 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_exm4vItZRmplTFM5sY8z8OgA', 'function': {'arguments': '{"basename":"iam.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2141, 'prompt_tokens': 75237, 'total_tokens': 77378, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2112, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 61184}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--58d952f3-0d28-4a73-82a1-95ac742dbb6e-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iam.js'}, 'id': 'call_exm4vItZRmplTFM5sY8z8OgA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 75237, 'output_tokens': 2141, 'total_tokens': 77378, 'input_token_details': {'audio': 0, 'cache_read': 61184}, 'output_token_details': {'audio': 0, 'reasoning': 2112}}
2025-11-13 21:14:26,989 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3Tu1UMG9sABRJiSZB6C05mm6', 'function': {'arguments': '{"text":"AWS::IAM","basename":"index.js"}', 'name': 'find_ast_node_with_text_in_file_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 75286, 'total_tokens': 75319, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 60800}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6a383728-b0de-4879-811e-016958a36ff6-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_basename', 'args': {'text': 'AWS::IAM', 'basename': 'index.js'}, 'id': 'call_3Tu1UMG9sABRJiSZB6C05mm6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 75286, 'output_tokens': 33, 'total_tokens': 75319, 'input_token_details': {'audio': 0, 'cache_read': 60800}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:14:40,482 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_oCBxq1rjv1zrcieSGfNkqy0S', 'function': {'arguments': '{"basename":"role.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 797, 'prompt_tokens': 79430, 'total_tokens': 80227, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 54400}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3fe63312-ce31-496e-927e-30ef4f71d972-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'role.js'}, 'id': 'call_oCBxq1rjv1zrcieSGfNkqy0S', 'type': 'tool_call'}] usage_metadata={'input_tokens': 79430, 'output_tokens': 797, 'total_tokens': 80227, 'input_token_details': {'audio': 0, 'cache_read': 54400}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 21:15:02,301 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I located and provided the contents of lib/plugins/aws/lib/validate.js and lib/plugins/aws/provider/awsProvider.js. I then explored lib/plugins/aws/package/compile modules that touch IAM roles/policies and iamRoleStatements, including functions (compileRole handling Role), events (S3, EventBridge, CognitoUserPool) that build iamRoleStatements, and Stream/SQS/CloudFront compilers that update IamRoleLambdaExecution policies or add permissions. I also surfaced lib/plugins/aws/customResources/index.js where iamRoleStatements are merged into an AWS::IAM::Role PolicyDocument and highlighted how they’re deduplicated. Finally, I looked for occurrences of NotAction/NotResource and did not find any references, indicating those are not explicitly handled or rejected in these modules.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1895, 'prompt_tokens': 79479, 'total_tokens': 81374, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1728, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 60928}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--48786efa-bcf3-4406-8aa9-de8570ef657f-0' usage_metadata={'input_tokens': 79479, 'output_tokens': 1895, 'total_tokens': 81374, 'input_token_details': {'audio': 0, 'cache_read': 60928}, 'output_token_details': {'audio': 0, 'reasoning': 1728}}
2025-11-13 21:15:02,306 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the contents of lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and any files under lib/plugins/aws/package/lib and lib/plugins/aws/package/compile that handle IAM roles/policies and iamRoleStatements.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If the exact files are unclear, include a directory listing and code snippets (with paths) for any modules referencing iamRoleStatements, IAM, Role, Policy, NotAction, or NotResource.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need to pinpoint where NotAction/NotResource are rejected and understand the architectural patterns to integrate support consistently.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/plugins/aws/customResources/index.js
Line number range: 1 - 205
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const crypto = require('crypto');
5. const BbPromise = require('bluebird');
6. const fse = BbPromise.promisifyAll(require('fs-extra'));
7. const childProcess = BbPromise.promisifyAll(require('child_process'));
8. const getTmpDirPath = require('../../../utils/fs/getTmpDirPath');
9. const createZipFile = require('../../../utils/fs/createZipFile');
10. 
11. function copyCustomResources(srcDirPath, destDirPath) {
12.   return fse.ensureDirAsync(destDirPath).then(() => fse.copyAsync(srcDirPath, destDirPath));
13. }
14. 
15. function installDependencies(dirPath) {
16.   return childProcess.execAsync('npm install', { cwd: dirPath });
17. }
18. 
19. function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements) {
20.   let functionName;
21.   let absoluteFunctionName;
22.   let Handler;
23.   let customResourceFunctionLogicalId;
24. 
25.   const { serverless } = awsProvider;
26.   const { cliOptions } = serverless.pluginManager;
27.   const providerConfig = serverless.service.provider;
28.   const shouldWriteLogs = providerConfig.logs && providerConfig.logs.frameworkLambda;
29.   const { Resources } = providerConfig.compiledCloudFormationTemplate;
30.   const customResourcesRoleLogicalId = awsProvider.naming.getCustomResourcesRoleLogicalId();
31.   const srcDirPath = path.join(__dirname, 'resources');
32.   const destDirPath = path.join(
33.     serverless.config.servicePath,
34.     '.serverless',
35.     awsProvider.naming.getCustomResourcesArtifactDirectoryName()
36.   );
37.   const tmpDirPath = path.join(getTmpDirPath(), 'resources');
38.   const funcPrefix = `${serverless.service.service}-${cliOptions.stage}`;
39.   const zipFilePath = `${destDirPath}.zip`;
40.   serverless.utils.writeFileDir(zipFilePath);
41. 
42.   // check which custom resource should be used
43.   if (resourceName === 's3') {
44.     functionName = awsProvider.naming.getCustomResourceS3HandlerFunctionName();
45.     Handler = 's3/handler.handler';
46.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceS3HandlerFunctionLogicalId();
47.   } else if (resourceName === 'cognitoUserPool') {
48.     functionName = awsProvider.naming.getCustomResourceCognitoUserPoolHandlerFunctionName();
49.     Handler = 'cognitoUserPool/handler.handler';
50.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();
51.   } else if (resourceName === 'eventBridge') {
52.     functionName = awsProvider.naming.getCustomResourceEventBridgeHandlerFunctionName();
53.     Handler = 'eventBridge/handler.handler';
54.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId();
55.   } else if (resourceName === 'apiGatewayCloudWatchRole') {
56.     functionName = awsProvider.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName();
57.     Handler = 'apiGatewayCloudWatchRole/handler.handler';
58.     customResourceFunctionLogicalId = awsProvider.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId();
59.   } else {
60.     return BbPromise.reject(`No implementation found for Custom Resource "${resourceName}"`);
61.   }
62.   absoluteFunctionName = `${funcPrefix}-${functionName}`;
63.   if (absoluteFunctionName.length > 64) {
64.     // Function names cannot be longer than 64.
65.     // Temporary solution until we have https://github.com/serverless/serverless/issues/6598
66.     // (which doesn't change names of already deployed functions)
67.     absoluteFunctionName = `${absoluteFunctionName.slice(0, 32)}${crypto
68.       .createHash('md5')
69.       .update(absoluteFunctionName)
70.       .digest('hex')}`;
71.   }
72. 
73.   // TODO: check every once in a while if external packages are still necessary
74.   serverless.cli.log('Installing dependencies for custom CloudFormation resources...');
75.   return copyCustomResources(srcDirPath, tmpDirPath)
76.     .then(() => installDependencies(tmpDirPath))
77.     .then(() => createZipFile(tmpDirPath, zipFilePath))
78.     .then(outputFilePath => {
79.       let S3Bucket = {
80.         Ref: awsProvider.naming.getDeploymentBucketLogicalId(),
81.       };
82.       if (serverless.service.package.deploymentBucket) {
83.         S3Bucket = serverless.service.package.deploymentBucket;
84.       }
85.       const s3Folder = serverless.service.package.artifactDirectoryName;
86.       const s3FileName = outputFilePath.split(path.sep).pop();
87.       const S3Key = `${s3Folder}/${s3FileName}`;
88. 
89.       let customResourceRole = Resources[customResourcesRoleLogicalId];
90.       if (!customResourceRole) {
91.         customResourceRole = {
92.           Type: 'AWS::IAM::Role',
93.           Properties: {
94.             AssumeRolePolicyDocument: {
95.               Version: '2012-10-17',
96.               Statement: [
97.                 {
98.                   Effect: 'Allow',
99.                   Principal: {
100.                     Service: ['lambda.amazonaws.com'],
101.                   },
102.                   Action: ['sts:AssumeRole'],
103.                 },
104.               ],
105.             },
106.             Policies: [
107.               {
108.                 PolicyName: {
109.                   'Fn::Join': [
110.                     '-',
111.                     [
112.                       awsProvider.getStage(),
113.                       awsProvider.serverless.service.service,
114.                       'custom-resources-lambda',
115.                     ],
116.                   ],
117.                 },
118.                 PolicyDocument: {
119.                   Version: '2012-10-17',
120.                   Statement: [],
121.                 },
122.               },
123.             ],
124.           },
125.         };
126. 
127.         if (shouldWriteLogs) {
128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);
129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(
130.             {
131.               Effect: 'Allow',
132.               Action: ['logs:CreateLogStream'],
133.               Resource: [
134.                 {
135.                   'Fn::Sub':
136.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
137.                     `:log-group:${logGroupsPrefix}*:*`,
138.                 },
139.               ],
140.             },
141.             {
142.               Effect: 'Allow',
143.               Action: ['logs:PutLogEvents'],
144.               Resource: [
145.                 {
146.                   'Fn::Sub':
147.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
148.                     `:log-group:${logGroupsPrefix}*:*:*`,
149.                 },
150.               ],
151.             }
152.           );
153.         }
154.       }
155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
156.       iamRoleStatements.forEach(newStmt => {
157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
158.           Statement.push(newStmt);
159.         }
160.       });
161. 
162.       const customResourceFunction = {
163.         Type: 'AWS::Lambda::Function',
164.         Properties: {
165.           Code: {
166.             S3Bucket,
167.             S3Key,
168.           },
169.           FunctionName: absoluteFunctionName,
170.           Handler,
171.           MemorySize: 1024,
172.           Role: {
173.             'Fn::GetAtt': [customResourcesRoleLogicalId, 'Arn'],
174.           },
175.           Runtime: 'nodejs10.x',
176.           Timeout: 180,
177.         },
178.         DependsOn: [customResourcesRoleLogicalId],
179.       };
180. 
181.       Object.assign(Resources, {
182.         [customResourceFunctionLogicalId]: customResourceFunction,
183.         [customResourcesRoleLogicalId]: customResourceRole,
184.       });
185. 
186.       if (shouldWriteLogs) {
187.         const customResourceLogGroupLogicalId = awsProvider.naming.getLogGroupLogicalId(
188.           functionName
189.         );
190.         customResourceFunction.DependsOn.push(customResourceLogGroupLogicalId);
191.         Object.assign(Resources, {
192.           [customResourceLogGroupLogicalId]: {
193.             Type: 'AWS::Logs::LogGroup',
194.             Properties: {
195.               LogGroupName: awsProvider.naming.getLogGroupName(absoluteFunctionName),
196.             },
197.           },
198.         });
199.       }
200.     });
201. }
202. 
203. module.exports = {
204.   addCustomResourceToService,
205. };


File: lib/plugins/aws/deployFunction/index.js
Line number range: 11 - 259
Content:
class AwsDeployFunction {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options || {};
    this.packagePath =
      this.options.package ||
      this.serverless.service.package.path ||
      path.join(this.serverless.config.servicePath || '.', '.serverless');
    this.provider = this.serverless.getProvider('aws');

    // used to store data received via AWS SDK
    this.serverless.service.provider.remoteFunctionData = null;

    Object.assign(this, validate);

    this.hooks = {
      'deploy:function:initialize': () =>
        BbPromise.bind(this)
          .then(this.validate)
          .then(this.checkIfFunctionExists),

      'deploy:function:packageFunction': () =>
        this.serverless.pluginManager.spawn('package:function'),

      'deploy:function:deploy': () =>
        BbPromise.bind(this)
          .then(() => {
            if (!this.options['update-config']) {
              return this.deployFunction();
            }

            return BbPromise.resolve();
          })
          .then(this.updateFunctionConfiguration)
          .then(() => this.serverless.pluginManager.spawn('aws:common:cleanupTempDir')),
    };
  }

  checkIfFunctionExists() {
    // check if the function exists in the service
    this.options.functionObj = this.serverless.service.getFunction(this.options.function);

    // check if function exists on AWS
    const params = {
      FunctionName: this.options.functionObj.name,
    };

    return this.provider
      .request('Lambda', 'getFunction', params)
      .then(result => {
        this.serverless.service.provider.remoteFunctionData = result;
        return result;
      })
      .catch(() => {
        const errorMessage = [
          `The function "${this.options.function}" you want to update is not yet deployed.`,
          ' Please run "serverless deploy" to deploy your service.',
          ' After that you can redeploy your services functions with the',
          ' "serverless deploy function" command.',
        ].join('');
        throw new this.serverless.classes.Error(errorMessage);
      });
  }

  normalizeArnRole(role) {
    if (typeof role === 'string') {
      if (role.indexOf(':') === -1) {
        const roleResource = this.serverless.service.resources.Resources[role];

        if (roleResource.Type !== 'AWS::IAM::Role') {
          throw new Error('Provided resource is not IAM Role.');
        }

        const roleProperties = roleResource.Properties;
        const compiledFullRoleName = `${roleProperties.Path || '/'}${roleProperties.RoleName}`;

        return this.provider
          .getAccountInfo()
          .then(
            result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`
          );
      }

      return BbPromise.resolve(role);
    }

    return this.provider
      .request('IAM', 'getRole', {
        RoleName: role['Fn::GetAtt'][0],
      })
      .then(data => data.Arn);
  }

  callUpdateFunctionConfiguration(params) {
    return this.provider.request('Lambda', 'updateFunctionConfiguration', params).then(() => {
      this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);
    });
  }

  updateFunctionConfiguration() {
    const functionObj = this.options.functionObj;
    const serviceObj = this.serverless.service.serviceObject;
    const providerObj = this.serverless.service.provider;
    const params = {
      FunctionName: functionObj.name,
    };

    if ('awsKmsKeyArn' in functionObj && !_.isObject(functionObj.awsKmsKeyArn)) {
      params.KMSKeyArn = functionObj.awsKmsKeyArn;
    } else if (serviceObj && 'awsKmsKeyArn' in serviceObj && !_.isObject(serviceObj.awsKmsKeyArn)) {
      params.KMSKeyArn = serviceObj.awsKmsKeyArn;
    }

    if ('description' in functionObj && !_.isObject(functionObj.description)) {
      params.Description = functionObj.description;
    }

    if ('handler' in functionObj && !_.isObject(functionObj.handler)) {
      params.Handler = functionObj.handler;
    }

    if ('memorySize' in functionObj && !_.isObject(functionObj.memorySize)) {
      params.MemorySize = functionObj.memorySize;
    } else if ('memorySize' in providerObj && !_.isObject(providerObj.memorySize)) {
      params.MemorySize = providerObj.memorySize;
    }

    if ('timeout' in functionObj && !_.isObject(functionObj.timeout)) {
      params.Timeout = functionObj.timeout;
    } else if ('timeout' in providerObj && !_.isObject(providerObj.timeout)) {
      params.Timeout = providerObj.timeout;
    }

    if (
      'layers' in functionObj &&
      _.isArray(functionObj.layers) &&
      !_.some(functionObj.layers, _.isObject)
    ) {
      params.Layers = functionObj.layers;
    }

    if (functionObj.onError && !_.isObject(functionObj.onError)) {
      params.DeadLetterConfig = {
        TargetArn: functionObj.onError,
      };
    }

    if (functionObj.environment || providerObj.environment) {
      params.Environment = {};
      params.Environment.Variables = Object.assign(
        {},
        providerObj.environment,
        functionObj.environment
      );

      if (_.some(params.Environment.Variables, value => _.isObject(value))) {
        delete params.Environment;
      } else {
        Object.keys(params.Environment.Variables).forEach(key => {
          // taken from the bash man pages
          if (!key.match(/^[A-Za-z_][a-zA-Z0-9_]*$/)) {
            const errorMessage = 'Invalid characters in environment variable';
            throw new this.serverless.classes.Error(errorMessage);
          }

          if (!_.isString(params.Environment.Variables[key])) {
            params.Environment.Variables[key] = _.toString(params.Environment.Variables[key]);
          }
        });
      }
    }

    if (functionObj.vpc || providerObj.vpc) {
      const vpc = functionObj.vpc || providerObj.vpc;
      params.VpcConfig = {};

      if (_.isArray(vpc.securityGroupIds) && !_.some(vpc.securityGroupIds, _.isObject)) {
        params.VpcConfig.SecurityGroupIds = vpc.securityGroupIds;
      }

      if (_.isArray(vpc.subnetIds) && !_.some(vpc.subnetIds, _.isObject)) {
        params.VpcConfig.SubnetIds = vpc.subnetIds;
      }

      if (_.isEmpty(params.VpcConfig)) {
        delete params.VpcConfig;
      }
    }

    if ('role' in functionObj && !_.isObject(functionObj.role)) {
      return this.normalizeArnRole(functionObj.role).then(roleArn => {
        params.Role = roleArn;

        return this.callUpdateFunctionConfiguration(params);
      });
    } else if ('role' in providerObj && !_.isObject(providerObj.role)) {
      return this.normalizeArnRole(providerObj.role).then(roleArn => {
        params.Role = roleArn;

        return this.callUpdateFunctionConfiguration(params);
      });
    }

    if (_.isEmpty(_.omit(params, 'FunctionName'))) {
      return BbPromise.resolve();
    }

    return this.callUpdateFunctionConfiguration(params);
  }

  deployFunction() {
    const artifactFileName = this.provider.naming.getFunctionArtifactName(this.options.function);
    let artifactFilePath =
      this.serverless.service.package.artifact || path.join(this.packagePath, artifactFileName);

    // check if an artifact is used in function package level
    const functionObject = this.serverless.service.getFunction(this.options.function);
    if (_.has(functionObject, ['package', 'artifact'])) {
      artifactFilePath = functionObject.package.artifact;
    }

    const data = fs.readFileSync(artifactFilePath);

    const remoteHash = this.serverless.service.provider.remoteFunctionData.Configuration.CodeSha256;
    const localHash = crypto
      .createHash('sha256')
      .update(data)
      .digest('base64');

    if (remoteHash === localHash && !this.options.force) {
      this.serverless.cli.log('Code not changed. Skipping function deployment.');
      return BbPromise.resolve();
    }

    const params = {
      FunctionName: this.options.functionObj.name,
      ZipFile: data,
    };

    const stats = fs.statSync(artifactFilePath);
    this.serverless.cli.log(
      `Uploading function: ${this.options.function} (${filesize(stats.size)})...`
    );

    return this.provider.request('Lambda', 'updateFunctionCode', params).then(() => {
      this.serverless.cli.log(`Successfully deployed function: ${this.options.function}`);
    });
  }
}


File: lib/plugins/aws/lib/naming.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const crypto = require('crypto');
5. 
6. /**
7.  * A centralized naming object that provides naming standards for the AWS provider plugin.  The
8.  * intent is for this to enable naming standards to be configured using a custom naming plugin or
9.  * a naming configuration feature, based on which of those is determined to in the best approach.
10.  *
11.  * There are two main concepts:
12.  * 1. normalization - normalization of a name comprises removing any unacceptable characters and
13.  * changing the name to comply with capitalization expectations.
14.  * 2. logicalization - logicalization of a name comprises preparing it for use as an attribute name
15.  * for a resource within the Service's CloudFormation Template.  Notably, a suffix or prefix should
16.  * be added to the name of resources.  These help to disambiguate attributes identifying or
17.  * declaring different aspects or data about the same resource.  (e.g. MyFuncLambdaFunction vs.
18.  * MyFuncLambdaFunctionArn)  Generally, normalization of the name also occurs.
19.  *
20.  * Sometimes, it is important to deconstruct the names that are created via this centralized
21.  * utility.  As a result, the regular expressions used for identifying specific resource types using
22.  * their names or the logic to extract a name components from a logical name are things that must
23.  * also be centralized so that they co-occur and are more correlated spatially within the code base.
24.  * That is to say that they are easier to change together.
25.  */
26. module.exports = {
27.   // General
28.   normalizeName(name) {
29.     return `${_.upperFirst(name)}`;
30.   },
31.   normalizeNameToAlphaNumericOnly(name) {
32.     return this.normalizeName(name.replace(/[^0-9A-Za-z]/g, ''));
33.   },
34.   normalizePathPart(path) {
35.     return _.upperFirst(
36.       _.capitalize(path)
37.         .replace(/-/g, 'Dash')
38.         .replace(/\{(.*)\}/g, '$1Var')
39.         .replace(/[^0-9A-Za-z]/g, '')
40.     );
41.   },
42. 
43.   getServiceEndpointRegex() {
44.     return /^ServiceEndpoint/;
45.   },
46. 
47.   // Stack
48.   getStackName() {
49.     if (
50.       this.provider.serverless.service.provider.stackName &&
51.       _.isString(this.provider.serverless.service.provider.stackName)
52.     ) {
53.       return `${this.provider.serverless.service.provider.stackName}`;
54.     }
55.     return `${this.provider.serverless.service.service}-${this.provider.getStage()}`;
56.   },
57. 
58.   getServiceArtifactName() {
59.     return `${this.provider.serverless.service.service}.zip`;
60.   },
61. 
62.   getFunctionArtifactName(functionName) {
63.     return `${functionName}.zip`;
64.   },
65. 
66.   getLayerArtifactName(layerName) {
67.     return `${layerName}.zip`;
68.   },
69. 
70.   getServiceStateFileName() {
71.     return 'serverless-state.json';
72.   },
73. 
74.   getCompiledTemplateFileName() {
75.     return 'cloudformation-template-update-stack.json';
76.   },
77. 
78.   getCompiledTemplateS3Suffix() {
79.     return 'compiled-cloudformation-template.json';
80.   },
81. 
82.   getCoreTemplateFileName() {
83.     return 'cloudformation-template-create-stack.json';
84.   },
85. 
86.   // Role
87.   getRolePath() {
88.     return '/';
89.   },
90.   getRoleName() {
91.     return {
92.       'Fn::Join': [
93.         '-',
94.         [
95.           this.provider.serverless.service.service,
96.           this.provider.getStage(),
97.           { Ref: 'AWS::Region' },
98.           'lambdaRole',
99.         ],
100.       ],
101.     };
102.   },
103.   getRoleLogicalId() {
104.     return 'IamRoleLambdaExecution';
105.   },
106. 
107.   // Policy
108.   getPolicyName() {
109.     return {
110.       // TODO should probably have name ordered and altered as above - see AWS docs
111.       'Fn::Join': [
112.         '-',
113.         [
114.           this.provider.getStage(),
115.           // TODO is it a bug here in that the role is not specific to the region?
116.           this.provider.serverless.service.service,
117.           'lambda',
118.         ],
119.       ],
120.     };
121.   },
122. 
123.   // Log Group
124.   getLogGroupLogicalId(functionName) {
125.     return `${this.getNormalizedFunctionName(functionName)}LogGroup`;
126.   },
127.   getLogGroupName(functionName) {
128.     return `/aws/lambda/${functionName}`;
129.   },
130. 
131.   // Lambda
132.   getNormalizedFunctionName(functionName) {
133.     return this.normalizeName(functionName.replace(/-/g, 'Dash').replace(/_/g, 'Underscore'));
134.   },
135.   extractLambdaNameFromArn(functionArn) {
136.     return functionArn.substring(functionArn.lastIndexOf(':') + 1);
137.   },
138.   extractAuthorizerNameFromArn(functionArn) {
139.     const splitArn = functionArn.split(':');
140.     // TODO the following two lines assumes default function naming?  Is there a better way?
141.     // TODO (see ~/lib/classes/Service.js:~155)
142.     const splitName = splitArn[splitArn.length - 1].split('-');
143.     return splitName[splitName.length - 1];
144.   },
145.   getLambdaLogicalId(functionName) {
146.     return `${this.getNormalizedFunctionName(functionName)}LambdaFunction`;
147.   },
148.   getLambdaLayerLogicalId(layerName) {
149.     return `${this.getNormalizedFunctionName(layerName)}LambdaLayer`;
150.   },
151.   getLambdaLayerPermissionLogicalId(layerName, account) {
152.     return `${this.getNormalizedFunctionName(layerName)}${account.replace(
153.       '*',
154.       'Wild'
155.     )}LambdaLayerPermission`;
156.   },
157.   getLambdaLogicalIdRegex() {
158.     return /LambdaFunction$/;
159.   },
160.   getLambdaVersionLogicalId(functionName, sha) {
161.     return `${this.getNormalizedFunctionName(functionName)}LambdaVersion${sha.replace(
162.       /[^0-9a-z]/gi,
163.       ''
164.     )}`;
165.   },
166.   getLambdaVersionOutputLogicalId(functionName) {
167.     return `${this.getLambdaLogicalId(functionName)}QualifiedArn`;
168.   },
169.   getLambdaLayerOutputLogicalId(layerName) {
170.     return `${this.getLambdaLayerLogicalId(layerName)}QualifiedArn`;
171.   },
172. 
173.   // Websockets API
174.   getWebsocketsApiName() {
175.     if (
176.       this.provider.serverless.service.provider.websocketsApiName &&
177.       _.isString(this.provider.serverless.service.provider.websocketsApiName)
178.     ) {
179.       return `${this.provider.serverless.service.provider.websocketsApiName}`;
180.     }
181.     return `${this.provider.getStage()}-${this.provider.serverless.service.service}-websockets`;
182.   },
183.   getWebsocketsApiLogicalId() {
184.     return 'WebsocketsApi';
185.   },
186.   getWebsocketsIntegrationLogicalId(functionName) {
187.     return `${this.getNormalizedFunctionName(functionName)}WebsocketsIntegration`;
188.   },
189. 
190.   getLambdaWebsocketsPermissionLogicalId(functionName) {
191.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionWebsockets`;
192.   },
193. 
194.   getNormalizedWebsocketsRouteKey(route) {
195.     return route
196.       .replace('$', 'S') // dollar sign
197.       .replace('/', 'Slash')
198.       .replace('-', 'Dash')
199.       .replace('_', 'Underscore')
200.       .replace('.', 'Period');
201.   },
202. 
203.   getWebsocketsRouteLogicalId(route) {
204.     return `${this.getNormalizedWebsocketsRouteKey(route)}WebsocketsRoute`;
205.   },
206. 
207.   getWebsocketsDeploymentLogicalId(id) {
208.     return `WebsocketsDeployment${id}`;
209.   },
210. 
211.   getWebsocketsStageLogicalId() {
212.     return 'WebsocketsDeploymentStage';
213.   },
214. 
215.   getWebsocketsAuthorizerLogicalId(functionName) {
216.     return `${this.getNormalizedAuthorizerName(functionName)}WebsocketsAuthorizer`;
217.   },
218.   getWebsocketsLogGroupLogicalId() {
219.     return 'WebsocketsLogGroup';
220.   },
221. 
222.   // API Gateway
223.   getApiGatewayName() {
224.     if (
225.       this.provider.serverless.service.provider.apiName &&
226.       _.isString(this.provider.serverless.service.provider.apiName)
227.     ) {
228.       return `${this.provider.serverless.service.provider.apiName}`;
229.     }
230.     return `${this.provider.getStage()}-${this.provider.serverless.service.service}`;
231.   },
232.   generateApiGatewayDeploymentLogicalId(id) {
233.     return `ApiGatewayDeployment${id}`;
234.   },
235.   getRestApiLogicalId() {
236.     return 'ApiGatewayRestApi';
237.   },
238.   getNormalizedAuthorizerName(functionName) {
239.     return this.getNormalizedFunctionName(functionName);
240.   },
241.   getAuthorizerLogicalId(functionName) {
242.     return `${this.getNormalizedAuthorizerName(functionName)}ApiGatewayAuthorizer`;
243.   },
244.   normalizePath(resourcePath) {
245.     return resourcePath
246.       .split('/')
247.       .map(this.normalizePathPart.bind(this))
248.       .join('');
249.   },
250.   getResourceLogicalId(resourcePath) {
251.     return `ApiGatewayResource${this.normalizePath(resourcePath)}`;
252.   },
253.   extractResourceId(resourceLogicalId) {
254.     return resourceLogicalId.match(/ApiGatewayResource(.*)/)[1];
255.   },
256.   normalizeMethodName(methodName) {
257.     return this.normalizeName(methodName.toLowerCase());
258.   },
259.   getMethodLogicalId(resourceId, methodName) {
260.     return `ApiGatewayMethod${resourceId}${this.normalizeMethodName(methodName)}`;
261.   },
262.   getValidatorLogicalId(resourceId, methodName) {
263.     return `${this.getMethodLogicalId(resourceId, methodName)}Validator`;
264.   },
265.   getModelLogicalId(resourceId, methodName, contentType) {
266.     return `${this.getMethodLogicalId(resourceId, methodName)}${_.startCase(contentType).replace(
267.       ' ',
268.       ''
269.     )}Model`;
270.   },
271.   getApiKeyLogicalId(apiKeyNumber, apiKeyName) {
272.     if (apiKeyName) {
273.       return `ApiGatewayApiKey${this.normalizeName(apiKeyName)}${apiKeyNumber}`;
274.     }
275.     return `ApiGatewayApiKey${apiKeyNumber}`;
276.   },
277.   getApiKeyLogicalIdRegex() {
278.     return /^ApiGatewayApiKey/;
279.   },
280.   getUsagePlanLogicalId(name) {
281.     if (name) {
282.       return `ApiGatewayUsagePlan${this.normalizeName(name)}`;
283.     }
284.     return 'ApiGatewayUsagePlan';
285.   },
286.   getUsagePlanKeyLogicalId(usagePlanKeyNumber, usagePlanKeyName) {
287.     if (usagePlanKeyName) {
288.       return `ApiGatewayUsagePlanKey${this.normalizeName(usagePlanKeyName)}${usagePlanKeyNumber}`;
289.     }
290.     return `ApiGatewayUsagePlanKey${usagePlanKeyNumber}`;
291.   },
292.   getStageLogicalId() {
293.     return 'ApiGatewayStage';
294.   },
295.   getApiGatewayLogGroupLogicalId() {
296.     return 'ApiGatewayLogGroup';
297.   },
298. 
299.   // S3
300.   getDeploymentBucketLogicalId() {
301.     return 'ServerlessDeploymentBucket';
302.   },
303.   getDeploymentBucketOutputLogicalId() {
304.     return 'ServerlessDeploymentBucketName';
305.   },
306.   normalizeBucketName(bucketName) {
307.     return this.normalizeNameToAlphaNumericOnly(bucketName);
308.   },
309.   getBucketLogicalId(bucketName) {
310.     return `S3Bucket${this.normalizeBucketName(bucketName)}`;
311.   },
312. 
313.   // SNS
314.   normalizeTopicName(topicName) {
315.     return this.normalizeNameToAlphaNumericOnly(topicName);
316.   },
317.   getTopicLogicalId(topicName) {
318.     return `SNSTopic${this.normalizeTopicName(topicName)}`;
319.   },
320. 
321.   // Schedule
322.   getScheduleId(functionName) {
323.     return `${functionName}Schedule`;
324.   },
325.   getScheduleLogicalId(functionName, scheduleIndex) {
326.     return `${this.getNormalizedFunctionName(functionName)}EventsRuleSchedule${scheduleIndex}`;
327.   },
328. 
329.   // Stream
330.   getStreamLogicalId(functionName, streamType, streamName) {
331.     return `${this.getNormalizedFunctionName(functionName)}EventSourceMapping${this.normalizeName(
332.       streamType
333.     )}${this.normalizeNameToAlphaNumericOnly(streamName)}`;
334.   },
335. 
336.   // IoT
337.   getIotLogicalId(functionName, iotIndex) {
338.     return `${this.getNormalizedFunctionName(functionName)}IotTopicRule${iotIndex}`;
339.   },
340.   getLambdaIotPermissionLogicalId(functionName, iotIndex) {
341.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionIotTopicRule${iotIndex}`;
342.   },
343. 
344.   // CloudWatch Event
345.   getCloudWatchEventId(functionName) {
346.     return `${functionName}CloudWatchEvent`;
347.   },
348.   getCloudWatchEventLogicalId(functionName, cloudWatchIndex) {
349.     return `${this.getNormalizedFunctionName(
350.       functionName
351.     )}EventsRuleCloudWatchEvent${cloudWatchIndex}`;
352.   },
353. 
354.   // CloudWatch Log
355.   getCloudWatchLogLogicalId(functionName, logsIndex) {
356.     return `${this.getNormalizedFunctionName(
357.       functionName
358.     )}LogsSubscriptionFilterCloudWatchLog${logsIndex}`;
359.   },
360. 
361.   // Cognito User Pool
362.   getCognitoUserPoolLogicalId(poolId) {
363.     return `CognitoUserPool${this.normalizeNameToAlphaNumericOnly(poolId)}`;
364.   },
365. 
366.   // SQS
367.   getQueueLogicalId(functionName, queueName) {
368.     return `${this.getNormalizedFunctionName(
369.       functionName
370.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;
371.   },
372. 
373.   // ALB
374.   getAlbTargetGroupLogicalId(functionName) {
375.     return `${this.getNormalizedFunctionName(functionName)}AlbTargetGroup`;
376.   },
377.   getAlbTargetGroupNameTagValue(functionName) {
378.     return `${
379.       this.provider.serverless.service.service
380.     }-${functionName}-${this.provider.getStage()}`;
381.   },
382.   getAlbTargetGroupName(functionName) {
383.     return crypto
384.       .createHash('md5')
385.       .update(this.getAlbTargetGroupNameTagValue(functionName))
386.       .digest('hex');
387.   },
388.   getAlbListenerRuleLogicalId(functionName, idx) {
389.     return `${this.getNormalizedFunctionName(functionName)}AlbListenerRule${idx}`;
390.   },
391. 
392.   // Permissions
393.   getLambdaS3PermissionLogicalId(functionName, bucketName) {
394.     return `${this.getNormalizedFunctionName(
395.       functionName
396.     )}LambdaPermission${this.normalizeBucketName(bucketName)}S3`;
397.   },
398.   getLambdaSnsPermissionLogicalId(functionName, topicName) {
399.     return `${this.getNormalizedFunctionName(
400.       functionName
401.     )}LambdaPermission${this.normalizeTopicName(topicName)}SNS`;
402.   },
403.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {
404.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(
405.       topicName
406.     )}`;
407.   },
408.   getLambdaSchedulePermissionLogicalId(functionName, scheduleIndex) {
409.     return `${this.getNormalizedFunctionName(
410.       functionName
411.     )}LambdaPermissionEventsRuleSchedule${scheduleIndex}`;
412.   },
413.   getLambdaCloudWatchEventPermissionLogicalId(functionName, cloudWatchIndex) {
414.     return `${this.getNormalizedFunctionName(
415.       functionName
416.     )}LambdaPermissionEventsRuleCloudWatchEvent${cloudWatchIndex}`;
417.   },
418.   getLambdaApiGatewayPermissionLogicalId(functionName) {
419.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionApiGateway`;
420.   },
421.   getLambdaAlexaSkillPermissionLogicalId(functionName, alexaSkillIndex) {
422.     return `${this.getNormalizedFunctionName(
423.       functionName
424.     )}LambdaPermissionAlexaSkill${alexaSkillIndex || '0'}`;
425.   },
426.   getLambdaAlexaSmartHomePermissionLogicalId(functionName, alexaSmartHomeIndex) {
427.     return `${this.getNormalizedFunctionName(
428.       functionName
429.     )}LambdaPermissionAlexaSmartHome${alexaSmartHomeIndex}`;
430.   },
431.   getLambdaCloudWatchLogPermissionLogicalId(functionName) {
432.     return `${this.getNormalizedFunctionName(
433.       functionName
434.     )}LambdaPermissionLogsSubscriptionFilterCloudWatchLog`;
435.   },
436.   getLambdaCognitoUserPoolPermissionLogicalId(functionName, poolId, triggerSource) {
437.     return `${this.getNormalizedFunctionName(
438.       functionName
439.     )}LambdaPermissionCognitoUserPool${this.normalizeNameToAlphaNumericOnly(
440.       poolId
441.     )}TriggerSource${triggerSource}`;
442.   },
443.   getLambdaAlbPermissionLogicalId(functionName) {
444.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionAlb`;
445.   },
446. 
447.   // Custom Resources
448.   getCustomResourcesArtifactDirectoryName() {
449.     return 'custom-resources';
450.   },
451.   getCustomResourcesRoleLogicalId() {
452.     return 'IamRoleCustomResourcesLambdaExecution';
453.   },
454.   // S3
455.   getCustomResourceS3HandlerFunctionName() {
456.     return 'custom-resource-existing-s3';
457.   },
458.   getCustomResourceS3HandlerFunctionLogicalId() {
459.     return this.getLambdaLogicalId(
460.       `${this.getNormalizedFunctionName(this.getCustomResourceS3HandlerFunctionName())}`
461.     );
462.   },
463.   getCustomResourceS3ResourceLogicalId(functionName) {
464.     // NOTE: we have to keep the 1 at the end to ensure backwards compatibility
465.     // previously we've used an index to allow the creation of multiple custom S3 resources
466.     // we're now using one resource to handle multiple S3 event definitions
467.     return `${this.getNormalizedFunctionName(functionName)}CustomS31`;
468.   },
469.   // Cognito User Pool
470.   getCustomResourceCognitoUserPoolHandlerFunctionName() {
471.     return 'custom-resource-existing-cup';
472.   },
473.   getCustomResourceCognitoUserPoolHandlerFunctionLogicalId() {
474.     return this.getLambdaLogicalId(
475.       `${this.getNormalizedFunctionName(
476.         this.getCustomResourceCognitoUserPoolHandlerFunctionName()
477.       )}`
478.     );
479.   },
480.   getCustomResourceCognitoUserPoolResourceLogicalId(functionName) {
481.     // NOTE: we have to keep the 1 at the end to ensure backwards compatibility
482.     // previously we've used an index to allow the creation of multiple custom
483.     // Cognito User Pool resources
484.     // we're now using one resource to handle multiple Cognito User Pool event definitions
485.     return `${this.getNormalizedFunctionName(functionName)}CustomCognitoUserPool1`;
486.   },
487.   // Event Bridge
488.   getCustomResourceEventBridgeHandlerFunctionName() {
489.     return 'custom-resource-event-bridge';
490.   },
491.   getCustomResourceEventBridgeHandlerFunctionLogicalId() {
492.     return this.getLambdaLogicalId(
493.       `${this.getNormalizedFunctionName(this.getCustomResourceEventBridgeHandlerFunctionName())}`
494.     );
495.   },
496.   getCustomResourceEventBridgeResourceLogicalId(functionName, idx) {
497.     return `${this.getNormalizedFunctionName(functionName)}CustomEventBridge${idx}`;
498.   },
499. 
500.   // API Gateway Account Logs Write Role


File: lib/plugins/aws/lib/naming.js
Line number range: 500 - 1000
Content:
500.   // API Gateway Account Logs Write Role
501.   getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName() {
502.     return 'custom-resource-apigw-cw-role';
503.   },
504.   getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId() {
505.     return this.getLambdaLogicalId(
506.       `${this.getNormalizedFunctionName(
507.         this.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()
508.       )}`
509.     );
510.   },
511.   getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId() {
512.     return 'CustomApiGatewayAccountCloudWatchRole';
513.   },
514. 
515.   // CloudFront
516.   getCloudFrontDistributionLogicalId() {
517.     return 'CloudFrontDistribution';
518.   },
519.   getCloudFrontDistributionDomainNameLogicalId() {
520.     return 'CloudFrontDistributionDomainName';
521.   },
522.   getLambdaAtEdgeInvokePermissionLogicalId(functionName) {
523.     return `${this.getLambdaLogicalId(functionName)}InvokePermission`;
524.   },
525.   getCloudFrontOriginId(functionName, path) {
526.     let originId = this.getNormalizedFunctionName(functionName);
527.     if (path) {
528.       originId = `${originId}${path}`;
529.     }
530.     return originId;
531.   },
532. };


File: lib/plugins/aws/lib/validate.js
Line number range: 1 - 62
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const chalk = require('chalk');
5. const userStats = require('../../../utils/userStats');
6. 
7. module.exports = {
8.   validate() {
9.     if (!this.serverless.config.servicePath) {
10.       const error = new this.serverless.classes.Error(
11.         'This command can only be run inside a service directory'
12.       );
13.       return BbPromise.reject(error);
14.     }
15. 
16.     this.options.stage = this.provider.getStage();
17.     this.options.region = this.provider.getRegion();
18. 
19.     if (
20.       !['logs', 'info', 'deploy', 'remove', 'rollback', 'metrics', 'invoke'].includes(
21.         this.serverless.processedInput.commands[0]
22.       ) ||
23.       this.serverless.processedInput.commands[1] === 'local'
24.     ) {
25.       return BbPromise.resolve();
26.     }
27.     const creds = Object.assign({}, this.provider.getCredentials());
28.     delete creds.region;
29.     delete creds.signatureVersion;
30. 
31.     if (
32.       Object.keys(creds).length === 0 &&
33.       !process.env.ECS_CONTAINER_METADATA_FILE &&
34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&
35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI
36.     ) {
37.       // first check if the EC2 Metadata Service has creds before throwing error
38.       const metadataService = new this.provider.sdk.MetadataService({
39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout
40.         maxRetries: 0, // retry 0 times
41.       });
42.       return new BbPromise((resolve, reject) =>
43.         metadataService.request('/', (err, data) => {
44.           return err ? reject(err) : resolve(data);
45.         })
46.       )
47.         .catch(() => null)
48.         .then(identity => {
49.           if (!identity) {
50.             const message = [
51.               'AWS provider credentials not found.',
52.               ' Learn how to set up AWS provider credentials',
53.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
54.             ].join('');
55.             userStats.track('user_awsCredentialsNotFound');
56.             throw new this.serverless.classes.Error(message);
57.           }
58.         });
59.     }
60.     return BbPromise.resolve();
61.   },
62. };


File: lib/plugins/aws/package/compile/events/cloudFront/index.js
Line number range: 8 - 335
Content:
class AwsCompileCloudFrontEvents {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options;
    this.provider = this.serverless.getProvider('aws');
    this.hooks = {
      'package:initialize': this.validate.bind(this),
      'before:package:compileFunctions': this.prepareFunctions.bind(this),
      'package:compileEvents': this.compileCloudFrontEvents.bind(this),
      'before:remove:remove': this.logRemoveReminder.bind(this),
    };
  }

  logRemoveReminder() {
    if (this.serverless.processedInput.commands[0] === 'remove') {
      let isEventUsed = false;
      const funcKeys = this.serverless.service.getAllFunctions();
      if (funcKeys.length) {
        isEventUsed = funcKeys.some(funcKey => {
          const func = this.serverless.service.getFunction(funcKey);
          return func.events && func.events.find(e => Object.keys(e)[0] === 'cloudFront');
        });
      }
      if (isEventUsed) {
        const message = [
          "Don't forget to manually remove your Lambda@Edge functions ",
          'once the CloudFront distribution removal is successfully propagated!',
        ].join('');
        this.serverless.cli.log(message, 'Serverless', { color: 'orange' });
      }
    }
  }

  validate() {
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);
      if (functionObj.events.find(event => event.cloudFront)) {
        if (functionObj.memorySize && functionObj.memorySize > 128) {
          throw new Error(
            `"${functionName}" memorySize is greater than 128 which is not supported by Lambda@Edge functions`
          );
        }
        if (functionObj.timeout && functionObj.timeout > 5) {
          throw new Error(
            `"${functionName}" timeout is greater than 5 which is not supported by Lambda@Edge functions`
          );
        }
      }
    });
  }

  prepareFunctions() {
    // Lambda@Edge functions need to be versioned
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);
      if (functionObj.events.find(event => event.cloudFront)) {
        // ensure that functions are versioned
        Object.assign(functionObj, { versionFunction: true });
        // set the maximum memory size if not explicitly configured
        if (!functionObj.memorySize) {
          Object.assign(functionObj, { memorySize: 128 });
        }
        // set the maximum timeout if not explicitly configured
        if (!functionObj.timeout) {
          Object.assign(functionObj, { timeout: 5 });
        }
      }
    });
  }

  compileCloudFrontEvents() {
    this.cloudFrontDistributionLogicalId = this.provider.naming.getCloudFrontDistributionLogicalId();

    this.cloudFrontDistributionDomainNameLogicalId = this.provider.naming.getCloudFrontDistributionDomainNameLogicalId();

    const lambdaAtEdgeFunctions = [];

    const origins = [];
    const behaviors = [];

    const Resources = this.serverless.service.provider.compiledCloudFormationTemplate.Resources;
    const Outputs = this.serverless.service.provider.compiledCloudFormationTemplate.Outputs;

    // helper function for joining origins and behaviors
    function extendDeep(object, source) {
      return _.assignWith(object, source, (a, b) => {
        if (Array.isArray(a)) {
          return _.uniq(a.concat(b));
        }
        if (_.isObject(a)) {
          extendDeep(a, b);
        }
        return a;
      });
    }

    function createOrigin(functionName, origin, naming) {
      const originObj = {};
      if (typeof origin === 'string') {
        const originUrl = url.parse(origin);
        Object.assign(originObj, {
          DomainName: originUrl.hostname,
        });

        if (originUrl.pathname && originUrl.pathname.length > 1) {
          Object.assign(originObj, { OriginPath: originUrl.pathname });
        }

        if (originUrl.protocol === 's3:') {
          Object.assign(originObj, { S3OriginConfig: {} });
        } else {
          Object.assign(originObj, {
            CustomOriginConfig: {
              OriginProtocolPolicy: 'match-viewer',
            },
          });
        }
      } else {
        Object.assign(originObj, origin);
      }

      Object.assign(originObj, {
        Id: naming.getCloudFrontOriginId(functionName, originObj.OriginPath),
      });
      return originObj;
    }

    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);
      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.cloudFront) {
            if (!_.isObject(event.cloudFront)) {
              throw new Error('cloudFront event has to be an object');
            }

            const lambdaFunctionLogicalId = Object.keys(Resources).find(
              key =>
                Resources[key].Type === 'AWS::Lambda::Function' &&
                Resources[key].Properties.FunctionName === functionObj.name
            );

            // Retain Lambda@Edge functions to avoid issues when removing the CloudFormation stack
            Object.assign(Resources[lambdaFunctionLogicalId], { DeletionPolicy: 'Retain' });

            const lambdaVersionLogicalId = _.findKey(Resources, {
              Type: 'AWS::Lambda::Version',
              Properties: {
                FunctionName: {
                  Ref: this.provider.naming.getLambdaLogicalId(functionName),
                },
              },
            });

            const pathPattern =
              typeof event.cloudFront.pathPattern === 'string'
                ? event.cloudFront.pathPattern
                : undefined;

            let origin = createOrigin(functionName, event.cloudFront.origin, this.provider.naming);

            const existingOrigin = _.find(origins, o => o.OriginPath === origin.OriginPath);

            if (!existingOrigin) {
              origins.push(origin);
            } else {
              origin = extendDeep(existingOrigin, origin);
            }

            let behavior = {
              ViewerProtocolPolicy: 'allow-all',
              TargetOriginId: origin.Id,
              ForwardedValues: {
                QueryString: false,
              },
              LambdaFunctionAssociations: [
                {
                  EventType: event.cloudFront.eventType,
                  LambdaFunctionARN: {
                    Ref: lambdaVersionLogicalId,
                  },
                },
              ],
            };

            if (pathPattern) {
              Object.assign(behavior, { PathPattern: pathPattern });
            }

            const existingBehaviour = behaviors.find(
              o =>
                o.PathPattern === behavior.PathPattern &&
                o.TargetOriginId === behavior.TargetOriginId
            );

            if (!existingBehaviour) {
              behaviors.push(behavior);
            } else {
              behavior = extendDeep(existingBehaviour, behavior);
            }

            lambdaAtEdgeFunctions.push(
              Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })
            );
          }
        });
      }
    });

    // sort that first is without PathPattern if available
    behaviors.sort((a, b) => {
      if (b.PathPattern) {
        return -1;
      }
      return 0;
    });

    if (lambdaAtEdgeFunctions.length) {
      if (this.provider.getRegion() !== 'us-east-1') {
        throw new ServerlessError(
          'CloudFront associated functions have to be deployed to the us-east-1 region.'
        );
      }

      const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(
        (permissions, lambdaAtEdgeFunction) => {
          const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(
            lambdaAtEdgeFunction.functionName
          );
          const invokePermission = {
            Type: 'AWS::Lambda::Permission',
            Properties: {
              FunctionName: {
                Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,
              },
              Action: 'lambda:InvokeFunction',
              Principal: 'edgelambda.amazonaws.com',
              SourceArn: {
                'Fn::Join': [
                  '',
                  [
                    '',
                    'arn:aws:cloudfront::',
                    { Ref: 'AWS::AccountId' },
                    ':distribution/',
                    { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },
                  ],
                ],
              },
            },
          };
          return Object.assign(permissions, {
            [invokePermissionName]: invokePermission,
          });
        },
        {}
      );

      Object.assign(Resources, lambdaInvokePermissions);

      if (!Resources.IamRoleLambdaExecution) {
        this.serverless.cli.log(
          chalk.magenta('Remember to add required lambda@edge permissions to your execution role.')
        );
        this.serverless.cli.log(
          chalk.magenta(
            'https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-edge-permissions.html'
          )
        );
      } else {
        const lambdaAssumeStatement = Resources.IamRoleLambdaExecution.Properties.AssumeRolePolicyDocument.Statement.find(
          statement => statement.Principal.Service.includes('lambda.amazonaws.com')
        );
        if (lambdaAssumeStatement) {
          lambdaAssumeStatement.Principal.Service.push('edgelambda.amazonaws.com');
        }

        // Lambda creates CloudWatch Logs log streams
        // in the CloudWatch Logs regions closest
        // to the locations where the function is executed.
        // The format of the name for each log stream is
        // /aws/lambda/us-east-1.function-name where
        // function-name is the name that you gave
        // to the function when you created it.
        Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push({
          Effect: 'Allow',
          Action: ['logs:CreateLogGroup', 'logs:CreateLogStream', 'logs:PutLogEvents'],
          Resource: ['arn:aws:logs:*:*:*'],
        });
      }

      const CacheBehaviors = behaviors.slice(1);

      const CloudFrontDistribution = {
        Type: 'AWS::CloudFront::Distribution',
        Properties: {
          DistributionConfig: {
            Comment: `${this.serverless.service.service} ${this.serverless.service.provider.stage}`,
            Enabled: true,
            DefaultCacheBehavior: behaviors[0],
            Origins: origins,
          },
        },
      };

      if (CacheBehaviors.length > 0) {
        Object.assign(CloudFrontDistribution.Properties.DistributionConfig, { CacheBehaviors });
      }

      Object.assign(Resources, { [this.cloudFrontDistributionLogicalId]: CloudFrontDistribution });

      _.merge(Outputs, {
        [this.cloudFrontDistributionLogicalId]: {
          Description: 'CloudFront Distribution Id',
          Value: {
            Ref: this.provider.naming.getCloudFrontDistributionLogicalId(),
          },
        },
        [this.cloudFrontDistributionDomainNameLogicalId]: {
          Description: 'CloudFront Distribution Domain Name',
          Value: {
            'Fn::GetAtt': [this.provider.naming.getCloudFrontDistributionLogicalId(), 'DomainName'],
          },
        },
      });
    }
  }
}


File: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js
Line number range: 20 - 364
Content:
class AwsCompileCognitoUserPoolEvents {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options;
    this.provider = this.serverless.getProvider('aws');

    this.hooks = {
      'package:compileEvents': () => {
        return BbPromise.bind(this)
          .then(this.newCognitoUserPools)
          .then(this.existingCognitoUserPools);
      },
      'after:package:finalize': this.mergeWithCustomResources.bind(this),
    };
  }

  newCognitoUserPools() {
    const { service } = this.serverless;
    service.getAllFunctions().forEach(functionName => {
      const functionObj = service.getFunction(functionName);
      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.cognitoUserPool) {
            // return immediately if it's an existing Cognito User Pool event since we treat them differently
            if (event.cognitoUserPool.existing) return null;

            const result = this.findUserPoolsAndFunctions();
            const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
            const userPools = result.userPools;

            // Generate CloudFormation templates for Cognito User Pool changes
            _.forEach(userPools, poolName => {
              const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {
                poolName,
              });
              const userPoolCFResource = this.generateTemplateForPool(
                poolName,
                currentPoolTriggerFunctions
              );

              _.merge(
                this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
                userPoolCFResource
              );
            });

            // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda
            _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {
              const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(
                cognitoUserPoolTriggerFunction.poolName
              );
              const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(
                cognitoUserPoolTriggerFunction.functionName
              );

              const permissionTemplate = {
                Type: 'AWS::Lambda::Permission',
                Properties: {
                  FunctionName: {
                    'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
                  },
                  Action: 'lambda:InvokeFunction',
                  Principal: 'cognito-idp.amazonaws.com',
                  SourceArn: {
                    'Fn::GetAtt': [userPoolLogicalId, 'Arn'],
                  },
                },
              };
              const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(
                cognitoUserPoolTriggerFunction.functionName,
                cognitoUserPoolTriggerFunction.poolName,
                cognitoUserPoolTriggerFunction.triggerSource
              );
              const permissionCFResource = {
                [lambdaPermissionLogicalId]: permissionTemplate,
              };
              _.merge(
                this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
                permissionCFResource
              );
            });
          }
          return null;
        });
      }
      return null;
    });
  }

  existingCognitoUserPools() {
    const { service } = this.serverless;
    const { provider } = service;
    const { compiledCloudFormationTemplate } = provider;
    const { Resources } = compiledCloudFormationTemplate;
    const iamRoleStatements = [];

    // used to keep track of the custom resources created for each Cognito User Pool
    const poolResources = {};

    service.getAllFunctions().forEach(functionName => {
      let numEventsForFunc = 0;
      let currentPoolName = null;
      let funcUsesExistingCognitoUserPool = false;
      const functionObj = service.getFunction(functionName);
      const FunctionName = functionObj.name;

      if (functionObj.events) {
        functionObj.events.forEach(event => {
          if (event.cognitoUserPool && event.cognitoUserPool.existing) {
            numEventsForFunc++;
            const { pool, trigger } = event.cognitoUserPool;
            funcUsesExistingCognitoUserPool = true;

            if (!currentPoolName) {
              currentPoolName = pool;
            }
            if (pool !== currentPoolName) {
              const errorMessage = [
                'Only one Cognito User Pool can be configured per function.',
                ` In "${FunctionName}" you're attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
            const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();
            const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(
              functionName
            );

            // store how often the custom Cognito User Pool resource is used
            if (poolResources[pool]) {
              poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);
            } else {
              Object.assign(poolResources, {
                [pool]: [customPoolResourceLogicalId],
              });
            }

            let customCognitoUserPoolResource;
            if (numEventsForFunc === 1) {
              customCognitoUserPoolResource = {
                [customPoolResourceLogicalId]: {
                  Type: 'Custom::CognitoUserPool',
                  Version: 1.0,
                  DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
                  Properties: {
                    ServiceToken: {
                      'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
                    },
                    FunctionName,
                    UserPoolName: pool,
                    UserPoolConfigs: [
                      {
                        Trigger: trigger,
                      },
                    ],
                  },
                },
              };

              iamRoleStatements.push({
                Effect: 'Allow',
                Resource: '*',
                Action: [
                  'cognito-idp:ListUserPools',
                  'cognito-idp:DescribeUserPool',
                  'cognito-idp:UpdateUserPool',
                ],
              });
            } else {
              Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({
                Trigger: trigger,
              });
            }

            _.merge(Resources, customCognitoUserPoolResource);
          }
        });
      }

      if (funcUsesExistingCognitoUserPool) {
        iamRoleStatements.push({
          Effect: 'Allow',
          Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,
          Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
        });
      }
    });

    // check if we need to add DependsOn clauses in case more than 1
    // custom resources are created for one Cognito User Pool (to avoid race conditions)
    if (Object.keys(poolResources).length > 0) {
      Object.keys(poolResources).forEach(pool => {
        const resources = poolResources[pool];
        if (resources.length > 1) {
          resources.forEach((currResourceLogicalId, idx) => {
            if (idx > 0) {
              const prevResourceLogicalId = resources[idx - 1];
              Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);
            }
          });
        }
      });
    }

    if (iamRoleStatements.length) {
      return addCustomResourceToService(this.provider, 'cognitoUserPool', iamRoleStatements);
    }

    return null;
  }

  findUserPoolsAndFunctions() {
    const userPools = [];
    const cognitoUserPoolTriggerFunctions = [];

    // Iterate through all functions declared in `serverless.yml`
    _.forEach(this.serverless.service.getAllFunctions(), functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);

      if (functionObj.events) {
        _.forEach(functionObj.events, event => {
          if (event.cognitoUserPool) {
            // Check event definition for `cognitoUserPool` object
            if (typeof event.cognitoUserPool === 'object') {
              // Check `cognitoUserPool` object has required properties
              if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {
                throw new this.serverless.classes.Error(
                  [
                    `Cognito User Pool event of function "${functionName}" is not an object.`,
                    'The correct syntax is an object with the "pool" and "trigger" properties.',
                    'Please check the docs for more info.',
                  ].join(' ')
                );
              }

              // Check `cognitoUserPool` trigger is valid
              if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {
                throw new this.serverless.classes.Error(
                  [
                    'Cognito User Pool trigger source is invalid, must be one of:',
                    `${validTriggerSources.join(', ')}.`,
                    'Please check the docs for more info.',
                  ].join(' ')
                );
              }

              // Save trigger functions so we can use them to generate
              // IAM permissions later
              cognitoUserPoolTriggerFunctions.push({
                functionName,
                poolName: event.cognitoUserPool.pool,
                triggerSource: event.cognitoUserPool.trigger,
              });

              // Save user pools so we can use them to generate
              // CloudFormation resources later
              userPools.push(event.cognitoUserPool.pool);
            } else {
              throw new this.serverless.classes.Error(
                [
                  `Cognito User Pool event of function "${functionName}" is not an object.`,
                  'The correct syntax is an object with the "pool" and "trigger" properties.',
                  'Please check the docs for more info.',
                ].join(' ')
              );
            }
          }
        });
      }
    });

    return { cognitoUserPoolTriggerFunctions, userPools };
  }

  generateTemplateForPool(poolName, currentPoolTriggerFunctions) {
    const lambdaConfig = _.reduce(
      currentPoolTriggerFunctions,
      (result, value) => {
        const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);

        // Return a new object to avoid lint errors
        return Object.assign({}, result, {
          [value.triggerSource]: {
            'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
          },
        });
      },
      {}
    );

    const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);

    // Attach `DependsOn` for any relevant Lambdas
    const DependsOn = _.map(currentPoolTriggerFunctions, value =>
      this.provider.naming.getLambdaLogicalId(value.functionName)
    );

    return {
      [userPoolLogicalId]: {
        Type: 'AWS::Cognito::UserPool',
        Properties: {
          UserPoolName: poolName,
          LambdaConfig: lambdaConfig,
        },
        DependsOn,
      },
    };
  }

  mergeWithCustomResources() {
    const result = this.findUserPoolsAndFunctions();
    const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
    const userPools = result.userPools;

    _.forEach(userPools, poolName => {
      const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });
      const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);

      // If overrides exist in `Resources`, merge them in
      if (_.has(this.serverless.service.resources, userPoolLogicalId)) {
        const customUserPool = this.serverless.service.resources[userPoolLogicalId];
        const generatedUserPool = this.generateTemplateForPool(
          poolName,
          currentPoolTriggerFunctions
        )[userPoolLogicalId];

        // Merge `DependsOn` clauses
        const customUserPoolDependsOn = _.get(customUserPool, 'DependsOn', []);
        const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);

        // Merge default and custom resources, and `DependsOn` clause
        const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {
          DependsOn,
        });

        // Merge resource back into `Resources`
        _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
          [userPoolLogicalId]: mergedTemplate,
        });
      }
    });
  }
}


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 1 - 202
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const { addCustomResourceToService } = require('../../../../customResources');
5. 
6. class AwsCompileEventBridgeEvents {
7.   constructor(serverless, options) {
8.     this.serverless = serverless;
9.     this.options = options;
10.     this.provider = this.serverless.getProvider('aws');
11. 
12.     this.hooks = {
13.       'package:compileEvents': this.compileEventBridgeEvents.bind(this),
14.     };
15.   }
16. 
17.   compileEventBridgeEvents() {
18.     const { service } = this.serverless;
19.     const { provider } = service;
20.     const { compiledCloudFormationTemplate } = provider;
21.     const iamRoleStatements = [];
22. 
23.     service.getAllFunctions().forEach(functionName => {
24.       let funcUsesEventBridge = false;
25.       const functionObj = service.getFunction(functionName);
26.       const FunctionName = functionObj.name;
27. 
28.       if (functionObj.events) {
29.         functionObj.events.forEach((event, idx) => {
30.           if (event.eventBridge) {
31.             if (typeof event.eventBridge === 'object') {
32.               idx++;
33.               funcUsesEventBridge = true;
34. 
35.               const EventBus = event.eventBridge.eventBus;
36.               const Schedule = event.eventBridge.schedule;
37.               const Pattern = event.eventBridge.pattern;
38.               const Input = event.eventBridge.input;
39.               const InputPath = event.eventBridge.inputPath;
40.               let InputTransformer = event.eventBridge.inputTransformer;
41.               const RuleName = `${FunctionName}-rule-${idx}`;
42. 
43.               const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
44.               const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId();
45.               const customEventBridgeResourceLogicalId = this.provider.naming.getCustomResourceEventBridgeResourceLogicalId(
46.                 functionName,
47.                 idx
48.               );
49. 
50.               if (!Pattern && !Schedule) {
51.                 const errorMessage = [
52.                   'You need to configure the pattern or schedule property (or both) ',
53.                   'for eventBridge events.',
54.                 ].join('');
55.                 throw new this.serverless.classes.Error(errorMessage);
56.               }
57. 
58.               const inputOptions = [Input, InputPath, InputTransformer].filter(i => i);
59.               if (inputOptions.length > 1) {
60.                 const errorMessage = [
61.                   'You can only set one of input, inputPath, or inputTransformer ',
62.                   'properties for eventBridge events.',
63.                 ].join('');
64.                 throw new this.serverless.classes.Error(errorMessage);
65.               }
66. 
67.               if (InputTransformer) {
68.                 const config = Object.assign({}, InputTransformer);
69.                 InputTransformer = {};
70.                 if (!config.inputTemplate) {
71.                   throw new this.serverless.classes.Error(
72.                     'The inputTemplate key is required when specifying an ' +
73.                       'inputTransformer for an eventBridge event'
74.                   );
75.                 }
76.                 InputTransformer.InputTemplate = config.inputTemplate;
77.                 if (config.inputPathsMap) {
78.                   InputTransformer.InputPathsMap = config.inputPathsMap;
79.                 }
80.               }
81. 
82.               const customEventBridge = {
83.                 [customEventBridgeResourceLogicalId]: {
84.                   Type: 'Custom::EventBridge',
85.                   Version: 1.0,
86.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
87.                   Properties: {
88.                     ServiceToken: {
89.                       'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
90.                     },
91.                     FunctionName,
92.                     EventBridgeConfig: {
93.                       RuleName,
94.                       EventBus,
95.                       Schedule,
96.                       Pattern,
97.                       Input,
98.                       InputPath,
99.                       InputTransformer,
100.                     },
101.                   },
102.                 },
103.               };
104. 
105.               _.merge(compiledCloudFormationTemplate.Resources, customEventBridge);
106. 
107.               let eventBusResource;
108.               let ruleResource = {
109.                 'Fn::Join': [
110.                   ':',
111.                   [
112.                     'arn:aws:events',
113.                     { Ref: 'AWS::Region' },
114.                     { Ref: 'AWS::AccountId' },
115.                     `rule/${RuleName}`,
116.                   ],
117.                 ],
118.               };
119.               if (EventBus) {
120.                 let eventBusName = EventBus;
121.                 if (EventBus.startsWith('arn')) {
122.                   eventBusName = EventBus.slice(EventBus.indexOf('/') + 1);
123.                 }
124.                 eventBusResource = {
125.                   'Fn::Join': [
126.                     ':',
127.                     [
128.                       'arn:aws:events',
129.                       { Ref: 'AWS::Region' },
130.                       { Ref: 'AWS::AccountId' },
131.                       `event-bus/${eventBusName}`,
132.                     ],
133.                   ],
134.                 };
135.                 ruleResource = {
136.                   'Fn::Join': [
137.                     ':',
138.                     [
139.                       'arn:aws:events',
140.                       { Ref: 'AWS::Region' },
141.                       { Ref: 'AWS::AccountId' },
142.                       `rule/${eventBusName}/${RuleName}`,
143.                     ],
144.                   ],
145.                 };
146.                 iamRoleStatements.push({
147.                   Effect: 'Allow',
148.                   Resource: eventBusResource,
149.                   Action: ['events:CreateEventBus', 'events:DeleteEventBus'],
150.                 });
151.               }
152. 
153.               iamRoleStatements.push({
154.                 Effect: 'Allow',
155.                 Resource: ruleResource,
156.                 Action: [
157.                   'events:PutRule',
158.                   'events:RemoveTargets',
159.                   'events:PutTargets',
160.                   'events:DeleteRule',
161.                 ],
162.               });
163.             } else {
164.               const errorMessage = [
165.                 `Event Bridge event of function "${functionName}" is not an object`,
166.                 ' Please check the docs for more info.',
167.               ].join('');
168.               throw new this.serverless.classes.Error(errorMessage);
169.             }
170.           }
171.         });
172.       }
173. 
174.       if (funcUsesEventBridge) {
175.         iamRoleStatements.push({
176.           Effect: 'Allow',
177.           Resource: {
178.             'Fn::Join': [
179.               ':',
180.               [
181.                 'arn:aws:lambda',
182.                 { Ref: 'AWS::Region' },
183.                 { Ref: 'AWS::AccountId' },
184.                 'function',
185.                 FunctionName,
186.               ],
187.             ],
188.           },
189.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
190.         });
191.       }
192.     });
193. 
194.     if (iamRoleStatements.length) {
195.       return addCustomResourceToService(this.provider, 'eventBridge', iamRoleStatements);
196.     }
197. 
198.     return null;
199.   }
200. }
201. 
202. module.exports = AwsCompileEventBridgeEvents;


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 1 - 349
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const BbPromise = require('bluebird');
5. const { addCustomResourceToService } = require('../../../../customResources');
6. 
7. class AwsCompileS3Events {
8.   constructor(serverless, options) {
9.     this.serverless = serverless;
10.     this.options = options;
11.     this.provider = this.serverless.getProvider('aws');
12. 
13.     this.hooks = {
14.       'package:compileEvents': () => {
15.         return BbPromise.bind(this)
16.           .then(this.newS3Buckets)
17.           .then(this.existingS3Buckets);
18.       },
19.     };
20.   }
21. 
22.   newS3Buckets() {
23.     const bucketsLambdaConfigurations = {};
24.     const s3EnabledFunctions = [];
25.     this.serverless.service.getAllFunctions().forEach(functionName => {
26.       const functionObj = this.serverless.service.getFunction(functionName);
27. 
28.       if (functionObj.events) {
29.         functionObj.events.forEach(event => {
30.           if (event.s3) {
31.             // return immediately if it's an existing S3 event since we treat them differently
32.             if (event.s3.existing) return null;
33. 
34.             let bucketName;
35.             let notificationEvent = 's3:ObjectCreated:*';
36.             let filter = {};
37. 
38.             if (typeof event.s3 === 'object') {
39.               if (!event.s3.bucket) {
40.                 const errorMessage = [
41.                   `Missing "bucket" property for s3 event in function ${functionName}.`,
42.                   ' The correct syntax is: s3: bucketName OR an object with "bucket" property.',
43.                   ' Please check the docs for more info.',
44.                 ].join('');
45.                 throw new this.serverless.classes.Error(errorMessage);
46.               }
47.               bucketName = event.s3.bucket;
48.               if (event.s3.event) {
49.                 notificationEvent = event.s3.event;
50.               }
51.               if (event.s3.rules) {
52.                 if (!_.isArray(event.s3.rules)) {
53.                   const errorMessage = [
54.                     `S3 filter rules of function ${functionName} is not an array`,
55.                     ' The correct syntax is: rules: [{ Name: Value }]',
56.                     ' Please check the docs for more info.',
57.                   ].join('');
58.                   throw new this.serverless.classes.Error(errorMessage);
59.                 }
60.                 const rules = [];
61.                 event.s3.rules.forEach(rule => {
62.                   if (!_.isPlainObject(rule)) {
63.                     const errorMessage = [
64.                       `S3 filter rule ${rule} of function ${functionName} is not an object`,
65.                       ' The correct syntax is: { Name: Value }',
66.                       ' Please check the docs for more info.',
67.                     ].join('');
68.                     throw new this.serverless.classes.Error(errorMessage);
69.                   }
70.                   const name = Object.keys(rule)[0];
71.                   const value = rule[name];
72.                   rules.push({ Name: name, Value: value });
73.                 });
74.                 filter = { Filter: { S3Key: { Rules: rules } } };
75.               }
76.             } else if (typeof event.s3 === 'string') {
77.               bucketName = event.s3;
78.             } else {
79.               const errorMessage = [
80.                 `S3 event of function ${functionName} is not an object nor a string.`,
81.                 ' The correct syntax is: s3: bucketName OR an object with "bucket" property.',
82.                 ' Please check the docs for more info.',
83.               ].join('');
84.               throw new this.serverless.classes.Error(errorMessage);
85.             }
86. 
87.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
88. 
89.             // check if the bucket already defined
90.             // in another S3 event in the service
91.             if (bucketsLambdaConfigurations[bucketName]) {
92.               let newLambdaConfiguration = {
93.                 Event: notificationEvent,
94.                 Function: {
95.                   'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
96.                 },
97.               };
98. 
99.               // Assign 'filter' if not empty
100.               newLambdaConfiguration = _.assign(newLambdaConfiguration, filter);
101.               bucketsLambdaConfigurations[bucketName].push(newLambdaConfiguration);
102.             } else {
103.               bucketsLambdaConfigurations[bucketName] = [
104.                 {
105.                   Event: notificationEvent,
106.                   Function: {
107.                     'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
108.                   },
109.                 },
110.               ];
111.               // Assign 'filter' if not empty
112.               bucketsLambdaConfigurations[bucketName][0] = _.assign(
113.                 bucketsLambdaConfigurations[bucketName][0],
114.                 filter
115.               );
116.             }
117.             const s3EnabledFunction = { functionName, bucketName };
118.             s3EnabledFunctions.push(s3EnabledFunction);
119.           }
120. 
121.           return null;
122.         });
123.       }
124.     });
125. 
126.     // iterate over all buckets to be created
127.     // and compile them to CF resources
128.     _.forEach(bucketsLambdaConfigurations, (bucketLambdaConfiguration, bucketName) => {
129.       const bucketTemplate = {
130.         Type: 'AWS::S3::Bucket',
131.         Properties: {
132.           BucketName: bucketName,
133.           NotificationConfiguration: {
134.             LambdaConfigurations: bucketLambdaConfiguration,
135.           },
136.         },
137.         DependsOn: [],
138.       };
139. 
140.       // create the DependsOn properties for the buckets permissions (which are created later on)
141.       const dependsOnToCreate = s3EnabledFunctions.filter(func => func.bucketName === bucketName);
142. 
143.       _.forEach(dependsOnToCreate, item => {
144.         const lambdaPermissionLogicalId = this.provider.naming.getLambdaS3PermissionLogicalId(
145.           item.functionName,
146.           item.bucketName
147.         );
148. 
149.         bucketTemplate.DependsOn.push(lambdaPermissionLogicalId);
150.       });
151. 
152.       const bucketLogicalId = this.provider.naming.getBucketLogicalId(bucketName);
153.       const bucketCFResource = {
154.         [bucketLogicalId]: bucketTemplate,
155.       };
156.       _.merge(
157.         this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
158.         bucketCFResource
159.       );
160.     });
161. 
162.     // iterate over all functions with S3 events
163.     // and give S3 permission to invoke them all
164.     // by adding Lambda::Permission resource for each
165.     s3EnabledFunctions.forEach(s3EnabledFunction => {
166.       const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(
167.         s3EnabledFunction.functionName
168.       );
169.       const permissionTemplate = {
170.         Type: 'AWS::Lambda::Permission',
171.         Properties: {
172.           FunctionName: {
173.             'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
174.           },
175.           Action: 'lambda:InvokeFunction',
176.           Principal: 's3.amazonaws.com',
177.           SourceArn: {
178.             'Fn::Join': [
179.               '',
180.               ['arn:', { Ref: 'AWS::Partition' }, `:s3:::${s3EnabledFunction.bucketName}`],
181.             ],
182.           },
183.         },
184.       };
185.       const lambdaPermissionLogicalId = this.provider.naming.getLambdaS3PermissionLogicalId(
186.         s3EnabledFunction.functionName,
187.         s3EnabledFunction.bucketName
188.       );
189.       const permissionCFResource = {
190.         [lambdaPermissionLogicalId]: permissionTemplate,
191.       };
192.       _.merge(
193.         this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
194.         permissionCFResource
195.       );
196.     });
197.   }
198. 
199.   existingS3Buckets() {
200.     const { service } = this.serverless;
201.     const { provider } = service;
202.     const { compiledCloudFormationTemplate } = provider;
203.     const { Resources } = compiledCloudFormationTemplate;
204.     const iamRoleStatements = [];
205. 
206.     // used to keep track of the custom resources created for each bucket
207.     const bucketResources = {};
208. 
209.     service.getAllFunctions().forEach(functionName => {
210.       let numEventsForFunc = 0;
211.       let currentBucketName = null;
212.       let funcUsesExistingS3Bucket = false;
213.       const functionObj = service.getFunction(functionName);
214.       const FunctionName = functionObj.name;
215. 
216.       if (functionObj.events) {
217.         functionObj.events.forEach(event => {
218.           if (event.s3 && _.isObject(event.s3) && event.s3.existing) {
219.             numEventsForFunc++;
220.             let rules = null;
221.             const bucket = event.s3.bucket;
222.             const notificationEvent = event.s3.event || 's3:ObjectCreated:*';
223.             funcUsesExistingS3Bucket = true;
224. 
225.             if (!currentBucketName) {
226.               currentBucketName = bucket;
227.             }
228.             if (bucket !== currentBucketName) {
229.               const errorMessage = [
230.                 'Only one S3 Bucket can be configured per function.',
231.                 ` In "${FunctionName}" you're attempting to configure "${currentBucketName}" and "${bucket}" at the same time.`,
232.               ].join('');
233.               throw new this.serverless.classes.Error(errorMessage);
234.             }
235. 
236.             rules = _.map(event.s3.rules, rule => {
237.               const key = Object.keys(rule)[0];
238.               const value = rule[key];
239.               return {
240.                 [_.startCase(key)]: value,
241.               };
242.             });
243. 
244.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
245.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceS3HandlerFunctionLogicalId();
246.             const customS3ResourceLogicalId = this.provider.naming.getCustomResourceS3ResourceLogicalId(
247.               functionName
248.             );
249. 
250.             // store how often the custom S3 resource is used
251.             if (bucketResources[bucket]) {
252.               bucketResources[bucket] = _.union(bucketResources[bucket], [
253.                 customS3ResourceLogicalId,
254.               ]);
255.             } else {
256.               Object.assign(bucketResources, {
257.                 [bucket]: [customS3ResourceLogicalId],
258.               });
259.             }
260. 
261.             let customS3Resource;
262.             if (numEventsForFunc === 1) {
263.               customS3Resource = {
264.                 [customS3ResourceLogicalId]: {
265.                   Type: 'Custom::S3',
266.                   Version: 1.0,
267.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
268.                   Properties: {
269.                     ServiceToken: {
270.                       'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
271.                     },
272.                     FunctionName,
273.                     BucketName: bucket,
274.                     BucketConfigs: [
275.                       {
276.                         Event: notificationEvent,
277.                         Rules: rules,
278.                       },
279.                     ],
280.                   },
281.                 },
282.               };
283. 
284.               iamRoleStatements.push({
285.                 Effect: 'Allow',
286.                 Resource: {
287.                   'Fn::Join': [':', ['arn', { Ref: 'AWS::Partition' }, 's3', '', '', bucket]],
288.                 },
289.                 Action: ['s3:PutBucketNotification', 's3:GetBucketNotification'],
290.               });
291.             } else {
292.               Resources[customS3ResourceLogicalId].Properties.BucketConfigs.push({
293.                 Event: notificationEvent,
294.                 Rules: rules,
295.               });
296.             }
297. 
298.             _.merge(Resources, customS3Resource);
299.           }
300.         });
301.       }
302. 
303.       if (funcUsesExistingS3Bucket) {
304.         iamRoleStatements.push({
305.           Effect: 'Allow',
306.           Resource: {
307.             'Fn::Join': [
308.               ':',
309.               [
310.                 'arn',
311.                 { Ref: 'AWS::Partition' },
312.                 'lambda',
313.                 { Ref: 'AWS::Region' },
314.                 { Ref: 'AWS::AccountId' },
315.                 'function',
316.                 FunctionName,
317.               ],
318.             ],
319.           },
320.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
321.         });
322.       }
323.     });
324. 
325.     // check if we need to add DependsOn clauses in case more than 1
326.     // custom resources are created for one bucket (to avoid race conditions)
327.     if (Object.keys(bucketResources).length > 0) {
328.       Object.keys(bucketResources).forEach(bucket => {
329.         const resources = bucketResources[bucket];
330.         if (resources.length > 1) {
331.           resources.forEach((currResourceLogicalId, idx) => {
332.             if (idx > 0) {
333.               const prevResourceLogicalId = resources[idx - 1];
334.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);
335.             }
336.           });
337.         }
338.       });
339.     }
340. 
341.     if (iamRoleStatements.length) {
342.       return addCustomResourceToService(this.provider, 's3', iamRoleStatements);
343.     }
344. 
345.     return null;
346.   }
347. }
348. 
349. module.exports = AwsCompileS3Events;


File: lib/plugins/aws/package/compile/events/sqs/index.js
Line number range: 5 - 170
Content:
class AwsCompileSQSEvents {
  constructor(serverless) {
    this.serverless = serverless;
    this.provider = this.serverless.getProvider('aws');

    this.hooks = {
      'package:compileEvents': this.compileSQSEvents.bind(this),
    };
  }

  compileSQSEvents() {
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);

      if (functionObj.events) {
        const sqsStatement = {
          Effect: 'Allow',
          Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
          Resource: [],
        };

        functionObj.events.forEach(event => {
          if (event.sqs) {
            let EventSourceArn;
            let BatchSize = 10;
            let Enabled = 'True';

            // TODO validate arn syntax
            if (typeof event.sqs === 'object') {
              if (!event.sqs.arn) {
                const errorMessage = [
                  `Missing "arn" property for sqs event in function "${functionName}"`,
                  ' The correct syntax is: sqs: <QueueArn>',
                  ' OR an object with an "arn" property.',
                  ' Please check the docs for more info.',
                ].join('');
                throw new this.serverless.classes.Error(errorMessage);
              }
              if (typeof event.sqs.arn !== 'string') {
                // for dynamic arns (GetAtt/ImportValue)
                if (
                  Object.keys(event.sqs.arn).length !== 1 ||
                  !(
                    _.has(event.sqs.arn, 'Fn::ImportValue') ||
                    _.has(event.sqs.arn, 'Fn::GetAtt') ||
                    _.has(event.sqs.arn, 'Fn::Join')
                  )
                ) {
                  const errorMessage = [
                    `Bad dynamic ARN property on sqs event in function "${functionName}"`,
                    ' If you use a dynamic "arn" (such as with Fn::GetAtt or Fn::ImportValue)',
                    ' there must only be one key (either Fn::GetAtt or Fn::ImportValue) in the arn',
                    ' object. Please check the docs for more info.',
                  ].join('');
                  throw new this.serverless.classes.Error(errorMessage);
                }
              }
              EventSourceArn = event.sqs.arn;
              BatchSize = event.sqs.batchSize || BatchSize;
              if (typeof event.sqs.enabled !== 'undefined') {
                Enabled = event.sqs.enabled ? 'True' : 'False';
              }
            } else if (typeof event.sqs === 'string') {
              EventSourceArn = event.sqs;
            } else {
              const errorMessage = [
                `SQS event of function "${functionName}" is not an object nor a string`,
                ' The correct syntax is: sqs: <QueueArn>',
                ' OR an object with an "arn" property.',
                ' Please check the docs for more info.',
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            const queueName = (function() {
              if (EventSourceArn['Fn::GetAtt']) {
                return EventSourceArn['Fn::GetAtt'][0];
              } else if (EventSourceArn['Fn::ImportValue']) {
                return EventSourceArn['Fn::ImportValue'];
              } else if (EventSourceArn['Fn::Join']) {
                // [0] is the used delimiter, [1] is the array with values
                return EventSourceArn['Fn::Join'][1].slice(-1).pop();
              }
              return EventSourceArn.split(':').pop();
            })();

            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
            const queueLogicalId = this.provider.naming.getQueueLogicalId(functionName, queueName);

            const funcRole = functionObj.role || this.serverless.service.provider.role;
            let dependsOn = '"IamRoleLambdaExecution"';
            if (funcRole) {
              if (
                // check whether the custom role is an ARN
                typeof funcRole === 'string' &&
                funcRole.indexOf(':') !== -1
              ) {
                dependsOn = '[]';
              } else if (
                // otherwise, check if we have an in-service reference to a role ARN
                typeof funcRole === 'object' &&
                'Fn::GetAtt' in funcRole &&
                Array.isArray(funcRole['Fn::GetAtt']) &&
                funcRole['Fn::GetAtt'].length === 2 &&
                typeof funcRole['Fn::GetAtt'][0] === 'string' &&
                typeof funcRole['Fn::GetAtt'][1] === 'string' &&
                funcRole['Fn::GetAtt'][1] === 'Arn'
              ) {
                dependsOn = `"${funcRole['Fn::GetAtt'][0]}"`;
              } else if (
                // otherwise, check if we have an import
                typeof funcRole === 'object' &&
                'Fn::ImportValue' in funcRole
              ) {
                dependsOn = '[]';
              } else if (typeof funcRole === 'string') {
                dependsOn = `"${funcRole}"`;
              }
            }
            const sqsTemplate = `
              {
                "Type": "AWS::Lambda::EventSourceMapping",
                "DependsOn": ${dependsOn},
                "Properties": {
                  "BatchSize": ${BatchSize},
                  "EventSourceArn": ${JSON.stringify(EventSourceArn)},
                  "FunctionName": {
                    "Fn::GetAtt": [
                      "${lambdaLogicalId}",
                      "Arn"
                    ]
                  },
                  "Enabled": "${Enabled}"
                }
              }
            `;

            // add event source ARNs to PolicyDocument statements
            sqsStatement.Resource.push(EventSourceArn);

            const newSQSObject = {
              [queueLogicalId]: JSON.parse(sqsTemplate),
            };

            _.merge(
              this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
              newSQSObject
            );
          }
        });

        // update the PolicyDocument statements (if default policy is used)
        if (
          this.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .IamRoleLambdaExecution
        ) {
          const statement = this.serverless.service.provider.compiledCloudFormationTemplate
            .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
          if (sqsStatement.Resource.length) {
            statement.push(sqsStatement);
          }
        }
      }
    });
  }
}


File: lib/plugins/aws/package/compile/events/stream/index.js
Line number range: 5 - 228
Content:
class AwsCompileStreamEvents {
  constructor(serverless) {
    this.serverless = serverless;
    this.provider = this.serverless.getProvider('aws');

    this.hooks = {
      'package:compileEvents': this.compileStreamEvents.bind(this),
    };
  }

  compileStreamEvents() {
    this.serverless.service.getAllFunctions().forEach(functionName => {
      const functionObj = this.serverless.service.getFunction(functionName);

      if (functionObj.events) {
        const dynamodbStreamStatement = {
          Effect: 'Allow',
          Action: [
            'dynamodb:GetRecords',
            'dynamodb:GetShardIterator',
            'dynamodb:DescribeStream',
            'dynamodb:ListStreams',
          ],
          Resource: [],
        };
        const kinesisStreamStatement = {
          Effect: 'Allow',
          Action: [
            'kinesis:GetRecords',
            'kinesis:GetShardIterator',
            'kinesis:DescribeStream',
            'kinesis:ListStreams',
          ],
          Resource: [],
        };

        functionObj.events.forEach(event => {
          if (event.stream) {
            let EventSourceArn;
            let BatchSize = 10;
            let StartingPosition = 'TRIM_HORIZON';
            let Enabled = 'True';

            // TODO validate arn syntax
            if (typeof event.stream === 'object') {
              if (!event.stream.arn) {
                const errorMessage = [
                  `Missing "arn" property for stream event in function "${functionName}"`,
                  ' The correct syntax is: stream: <StreamArn>',
                  ' OR an object with an "arn" property.',
                  ' Please check the docs for more info.',
                ].join('');
                throw new this.serverless.classes.Error(errorMessage);
              }
              if (typeof event.stream.arn !== 'string') {
                // for dynamic arns (GetAtt/ImportValue)
                if (!event.stream.type) {
                  const errorMessage = [
                    `Missing "type" property for stream event in function "${functionName}"`,
                    ' If the "arn" property on a stream is a complex type (such as Fn::GetAtt)',
                    ' then a "type" must be provided for the stream, either "kinesis" or,',
                    ' "dynamodb". Please check the docs for more info.',
                  ].join('');
                  throw new this.serverless.classes.Error(errorMessage);
                }
                if (
                  Object.keys(event.stream.arn).length !== 1 ||
                  !(
                    _.has(event.stream.arn, 'Fn::ImportValue') ||
                    _.has(event.stream.arn, 'Fn::GetAtt') ||
                    _.has(event.stream.arn, 'Fn::Join')
                  )
                ) {
                  const errorMessage = [
                    `Bad dynamic ARN property on stream event in function "${functionName}"`,
                    ' If you use a dynamic "arn" (such as with Fn::GetAtt, Fn::Join',
                    ' or Fn::ImportValue) there must only be one key (either Fn::GetAtt, Fn::Join',
                    ' or Fn::ImportValue) in the arn object. Please check the docs for more info.',
                  ].join('');
                  throw new this.serverless.classes.Error(errorMessage);
                }
              }
              EventSourceArn = event.stream.arn;
              BatchSize = event.stream.batchSize || BatchSize;
              StartingPosition = event.stream.startingPosition || StartingPosition;
              if (typeof event.stream.enabled !== 'undefined') {
                Enabled = event.stream.enabled ? 'True' : 'False';
              }
            } else if (typeof event.stream === 'string') {
              EventSourceArn = event.stream;
            } else {
              const errorMessage = [
                `Stream event of function "${functionName}" is not an object nor a string`,
                ' The correct syntax is: stream: <StreamArn>',
                ' OR an object with an "arn" property.',
                ' Please check the docs for more info.',
              ].join('');
              throw new this.serverless.classes.Error(errorMessage);
            }

            const streamType = event.stream.type || EventSourceArn.split(':')[2];
            const streamName = (function() {
              if (EventSourceArn['Fn::GetAtt']) {
                return EventSourceArn['Fn::GetAtt'][0];
              } else if (EventSourceArn['Fn::ImportValue']) {
                return EventSourceArn['Fn::ImportValue'];
              } else if (EventSourceArn['Fn::Join']) {
                // [0] is the used delimiter, [1] is the array with values
                const name = EventSourceArn['Fn::Join'][1].slice(-1).pop();
                if (name.split('/').length) {
                  return name.split('/').pop();
                }
                return name;
              }
              return EventSourceArn.split('/')[1];
            })();

            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
            const streamLogicalId = this.provider.naming.getStreamLogicalId(
              functionName,
              streamType,
              streamName
            );

            const funcRole = functionObj.role || this.serverless.service.provider.role;
            let dependsOn = '"IamRoleLambdaExecution"';
            if (funcRole) {
              if (
                // check whether the custom role is an ARN
                typeof funcRole === 'string' &&
                funcRole.indexOf(':') !== -1
              ) {
                dependsOn = '[]';
              } else if (
                // otherwise, check if we have an in-service reference to a role ARN
                typeof funcRole === 'object' &&
                'Fn::GetAtt' in funcRole &&
                Array.isArray(funcRole['Fn::GetAtt']) &&
                funcRole['Fn::GetAtt'].length === 2 &&
                typeof funcRole['Fn::GetAtt'][0] === 'string' &&
                typeof funcRole['Fn::GetAtt'][1] === 'string' &&
                funcRole['Fn::GetAtt'][1] === 'Arn'
              ) {
                dependsOn = `"${funcRole['Fn::GetAtt'][0]}"`;
              } else if (
                // otherwise, check if we have an import
                typeof funcRole === 'object' &&
                'Fn::ImportValue' in funcRole
              ) {
                dependsOn = '[]';
              } else if (typeof funcRole === 'string') {
                dependsOn = `"${funcRole}"`;
              }
            }
            const streamTemplate = `
              {
                "Type": "AWS::Lambda::EventSourceMapping",
                "DependsOn": ${dependsOn},
                "Properties": {
                  "BatchSize": ${BatchSize},
                  "EventSourceArn": ${JSON.stringify(EventSourceArn)},
                  "FunctionName": {
                    "Fn::GetAtt": [
                      "${lambdaLogicalId}",
                      "Arn"
                    ]
                  },
                  "StartingPosition": "${StartingPosition}",
                  "Enabled": "${Enabled}"
                }
              }
            `;

            // add event source ARNs to PolicyDocument statements
            if (streamType === 'dynamodb') {
              dynamodbStreamStatement.Resource.push(EventSourceArn);
            } else if (streamType === 'kinesis') {
              kinesisStreamStatement.Resource.push(EventSourceArn);
            } else {
              const errorMessage = [
                `Stream event of function '${functionName}' had unsupported stream type of`,
                ` '${streamType}'. Valid stream event source types include 'dynamodb' and`,
                " 'kinesis'. Please check the docs for more info.",
              ].join('');
              throw new this.serverless.classes.Properties.Policies[0].PolicyDocument.Error(
                errorMessage
              );
            }

            const streamResource = JSON.parse(streamTemplate);

            if (event.stream.batchWindow) {
              streamResource.Properties.MaximumBatchingWindowInSeconds = event.stream.batchWindow;
            }

            const newStreamObject = {
              [streamLogicalId]: streamResource,
            };

            _.merge(
              this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
              newStreamObject
            );
          }
        });

        // update the PolicyDocument statements (if default policy is used)
        if (
          this.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .IamRoleLambdaExecution
        ) {
          const statement = this.serverless.service.provider.compiledCloudFormationTemplate
            .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
          if (dynamodbStreamStatement.Resource.length) {
            statement.push(dynamodbStreamStatement);
          }
          if (kinesisStreamStatement.Resource.length) {
            statement.push(kinesisStreamStatement);
          }
        }
      }
    });
  }
}


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const AWS = require('aws-sdk');
4. const BbPromise = require('bluebird');
5. const crypto = require('crypto');
6. const fs = require('fs');
7. const _ = require('lodash');
8. const path = require('path');
9. 
10. class AwsCompileFunctions {
11.   constructor(serverless, options) {
12.     this.serverless = serverless;
13.     this.options = options;
14.     const servicePath = this.serverless.config.servicePath || '';
15.     this.packagePath =
16.       this.serverless.service.package.path || path.join(servicePath || '.', '.serverless');
17. 
18.     this.provider = this.serverless.getProvider('aws');
19. 
20.     if (
21.       this.serverless.service.provider.versionFunctions === undefined ||
22.       this.serverless.service.provider.versionFunctions === null
23.     ) {
24.       this.serverless.service.provider.versionFunctions = true;
25.     }
26. 
27.     this.hooks = {
28.       'package:compileFunctions': () =>
29.         BbPromise.bind(this)
30.           .then(this.downloadPackageArtifacts)
31.           .then(this.compileFunctions),
32.     };
33.   }
34. 
35.   compileRole(newFunction, role) {
36.     const compiledFunction = newFunction;
37.     const unnsupportedRoleError = new this.serverless.classes.Error(
38.       `Unsupported role provided: "${JSON.stringify(role)}"`
39.     );
40. 
41.     switch (typeof role) {
42.       case 'object':
43.         if ('Fn::GetAtt' in role) {
44.           // role is an "Fn::GetAtt" object
45.           compiledFunction.Properties.Role = role;
46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
47.             role['Fn::GetAtt'][0]
48.           );
49.         } else if ('Fn::ImportValue' in role) {
50.           // role is an "Fn::ImportValue" object
51.           compiledFunction.Properties.Role = role;
52.         } else {
53.           throw unnsupportedRoleError;
54.         }
55.         break;
56.       case 'string':
57.         if (role.startsWith('arn:aws')) {
58.           // role is a statically definied iam arn
59.           compiledFunction.Properties.Role = role;
60.         } else if (role === 'IamRoleLambdaExecution') {
61.           // role is the default role generated by the framework
62.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
64.             'IamRoleLambdaExecution'
65.           );
66.         } else {
67.           // role is a Logical Role Name
68.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);
70.         }
71.         break;
72.       default:
73.         throw unnsupportedRoleError;
74.     }
75.   }
76. 
77.   downloadPackageArtifact(functionName) {
78.     const { region } = this.options;
79.     const S3 = new AWS.S3({ region });
80. 
81.     const functionObject = this.serverless.service.getFunction(functionName);
82.     const artifactFilePath =
83.       _.get(functionObject, 'package.artifact') ||
84.       _.get(this, 'serverless.service.package.artifact');
85. 
86.     const regex = new RegExp('s3\\.amazonaws\\.com/(.+)/(.+)');
87.     const match = artifactFilePath.match(regex);
88. 
89.     if (match) {
90.       return new BbPromise((resolve, reject) => {
91.         const tmpDir = this.serverless.utils.getTmpDirPath();
92.         const filePath = path.join(tmpDir, match[2]);
93. 
94.         const readStream = S3.getObject({
95.           Bucket: match[1],
96.           Key: match[2],
97.         }).createReadStream();
98. 
99.         const writeStream = fs.createWriteStream(filePath);
100. 
101.         readStream.on('error', error => reject(error));
102.         readStream
103.           .pipe(writeStream)
104.           .on('error', reject)
105.           .on('close', () => {
106.             if (functionObject.package.artifact) {
107.               functionObject.package.artifact = filePath;
108.             } else {
109.               this.serverless.service.package.artifact = filePath;
110.             }
111.             return resolve(filePath);
112.           });
113.       });
114.     }
115. 
116.     return BbPromise.resolve();
117.   }
118. 
119.   compileFunction(functionName) {
120.     const newFunction = this.cfLambdaFunctionTemplate();
121.     const functionObject = this.serverless.service.getFunction(functionName);
122.     functionObject.package = functionObject.package || {};
123. 
124.     const serviceArtifactFileName = this.provider.naming.getServiceArtifactName();
125.     const functionArtifactFileName = this.provider.naming.getFunctionArtifactName(functionName);
126. 
127.     let artifactFilePath =
128.       functionObject.package.artifact || this.serverless.service.package.artifact;
129. 
130.     if (
131.       !artifactFilePath ||
132.       (this.serverless.service.artifact && !functionObject.package.artifact)
133.     ) {
134.       let artifactFileName = serviceArtifactFileName;
135.       if (this.serverless.service.package.individually || functionObject.package.individually) {
136.         artifactFileName = functionArtifactFileName;
137.       }
138. 
139.       artifactFilePath = path.join(
140.         this.serverless.config.servicePath,
141.         '.serverless',
142.         artifactFileName
143.       );
144.     }
145. 
146.     if (this.serverless.service.package.deploymentBucket) {
147.       newFunction.Properties.Code.S3Bucket = this.serverless.service.package.deploymentBucket;
148.     }
149. 
150.     const s3Folder = this.serverless.service.package.artifactDirectoryName;
151.     const s3FileName = artifactFilePath.split(path.sep).pop();
152.     newFunction.Properties.Code.S3Key = `${s3Folder}/${s3FileName}`;
153. 
154.     if (!functionObject.handler) {
155.       const errorMessage = [
156.         `Missing "handler" property in function "${functionName}".`,
157.         ' Please make sure you point to the correct lambda handler.',
158.         ' For example: handler.hello.',
159.         ' Please check the docs for more info',
160.       ].join('');
161.       return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
162.     }
163. 
164.     const Handler = functionObject.handler;
165.     const FunctionName = functionObject.name;
166.     const MemorySize =
167.       Number(functionObject.memorySize) ||
168.       Number(this.serverless.service.provider.memorySize) ||
169.       1024;
170.     const Timeout =
171.       Number(functionObject.timeout) || Number(this.serverless.service.provider.timeout) || 6;
172.     const Runtime =
173.       functionObject.runtime || this.serverless.service.provider.runtime || 'nodejs10.x';
174. 
175.     newFunction.Properties.Handler = Handler;
176.     newFunction.Properties.FunctionName = FunctionName;
177.     newFunction.Properties.MemorySize = MemorySize;
178.     newFunction.Properties.Timeout = Timeout;
179.     newFunction.Properties.Runtime = Runtime;
180. 
181.     // publish these properties to the platform
182.     this.serverless.service.functions[functionName].memory = MemorySize;
183.     this.serverless.service.functions[functionName].timeout = Timeout;
184.     this.serverless.service.functions[functionName].runtime = Runtime;
185. 
186.     if (functionObject.description) {
187.       newFunction.Properties.Description = functionObject.description;
188.     }
189. 
190.     if (functionObject.condition) {
191.       newFunction.Condition = functionObject.condition;
192.     }
193. 
194.     if (functionObject.dependsOn) {
195.       newFunction.DependsOn = (newFunction.DependsOn || []).concat(functionObject.dependsOn);
196.     }
197. 
198.     if (functionObject.tags || this.serverless.service.provider.tags) {
199.       const tags = Object.assign({}, this.serverless.service.provider.tags, functionObject.tags);
200.       newFunction.Properties.Tags = [];
201.       _.forEach(tags, (Value, Key) => {
202.         newFunction.Properties.Tags.push({ Key, Value });
203.       });
204.     }
205. 
206.     if (functionObject.onError) {
207.       const arn = functionObject.onError;
208. 
209.       if (typeof arn === 'string') {
210.         const splittedArn = arn.split(':');
211.         if (splittedArn[0] === 'arn' && (splittedArn[2] === 'sns' || splittedArn[2] === 'sqs')) {
212.           const dlqType = splittedArn[2];
213.           const iamRoleLambdaExecution = this.serverless.service.provider
214.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
215.           let stmt;
216. 
217.           newFunction.Properties.DeadLetterConfig = {
218.             TargetArn: arn,
219.           };
220. 
221.           if (dlqType === 'sns') {
222.             stmt = {
223.               Effect: 'Allow',
224.               Action: ['sns:Publish'],
225.               Resource: [arn],
226.             };
227.           } else if (dlqType === 'sqs') {
228.             const errorMessage = [
229.               'onError currently only supports SNS topic arns due to a',
230.               ' race condition when using SQS queue arns and updating the IAM role.',
231.               ' Please check the docs for more info.',
232.             ].join('');
233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
234.           }
235. 
236.           // update the PolicyDocument statements (if default policy is used)
237.           if (iamRoleLambdaExecution) {
238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);
239.           }
240.         } else {
241.           const errorMessage = 'onError config must be a SNS topic arn or SQS queue arn';
242.           return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
243.         }
244.       } else if (this.isArnRefGetAttOrImportValue(arn)) {
245.         newFunction.Properties.DeadLetterConfig = {
246.           TargetArn: arn,
247.         };
248.       } else {
249.         const errorMessage = [
250.           'onError config must be provided as an arn string,',
251.           ' Ref, Fn::GetAtt or Fn::ImportValue',
252.         ].join('');
253.         return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
254.       }
255.     }
256. 
257.     let kmsKeyArn;
258.     const serviceObj = this.serverless.service.serviceObject;
259.     if ('awsKmsKeyArn' in functionObject) {
260.       kmsKeyArn = functionObject.awsKmsKeyArn;
261.     } else if (serviceObj && 'awsKmsKeyArn' in serviceObj) {
262.       kmsKeyArn = serviceObj.awsKmsKeyArn;
263.     }
264. 
265.     if (kmsKeyArn) {
266.       const arn = kmsKeyArn;
267. 
268.       if (typeof arn === 'string') {
269.         const splittedArn = arn.split(':');
270.         if (splittedArn[0] === 'arn' && splittedArn[2] === 'kms') {
271.           const iamRoleLambdaExecution = this.serverless.service.provider
272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
273. 
274.           newFunction.Properties.KmsKeyArn = arn;
275. 
276.           const stmt = {
277.             Effect: 'Allow',
278.             Action: ['kms:Decrypt'],
279.             Resource: [arn],
280.           };
281. 
282.           // update the PolicyDocument statements (if default policy is used)
283.           if (iamRoleLambdaExecution) {
284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
286.               [stmt],
287.               _.isEqual
288.             );
289.           }
290.         } else {
291.           const errorMessage = 'awsKmsKeyArn config must be a KMS key arn';
292.           return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
293.         }
294.       } else {
295.         const errorMessage = 'awsKmsKeyArn config must be provided as a string';
296.         return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
297.       }
298.     }
299. 
300.     const tracing =
301.       functionObject.tracing ||
302.       (this.serverless.service.provider.tracing && this.serverless.service.provider.tracing.lambda);
303. 
304.     if (tracing) {
305.       if (typeof tracing === 'boolean' || typeof tracing === 'string') {
306.         let mode = tracing;
307. 
308.         if (typeof tracing === 'boolean') {
309.           mode = 'Active';
310.         }
311. 
312.         const iamRoleLambdaExecution = this.serverless.service.provider
313.           .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
314. 
315.         newFunction.Properties.TracingConfig = {
316.           Mode: mode,
317.         };
318. 
319.         const stmt = {
320.           Effect: 'Allow',
321.           Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],
322.           Resource: ['*'],
323.         };
324. 
325.         // update the PolicyDocument statements (if default policy is used)
326.         if (iamRoleLambdaExecution) {
327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
329.             [stmt],
330.             _.isEqual
331.           );
332.         }
333.       } else {
334.         const errorMessage = 'tracing requires a boolean value or the "mode" provided as a string';
335.         throw new this.serverless.classes.Error(errorMessage);
336.       }
337.     }
338. 
339.     if (functionObject.environment || this.serverless.service.provider.environment) {
340.       newFunction.Properties.Environment = {};
341.       newFunction.Properties.Environment.Variables = Object.assign(
342.         {},
343.         this.serverless.service.provider.environment,
344.         functionObject.environment
345.       );
346. 
347.       let invalidEnvVar = null;
348.       _.forEach(_.keys(newFunction.Properties.Environment.Variables), key => {
349.         // taken from the bash man pages
350.         if (!key.match(/^[A-Za-z_][a-zA-Z0-9_]*$/)) {
351.           invalidEnvVar = `Invalid characters in environment variable ${key}`;
352.           return false; // break loop with lodash
353.         }
354.         const value = newFunction.Properties.Environment.Variables[key];
355.         if (_.isObject(value)) {
356.           const isCFRef =
357.             _.isObject(value) && !_.some(value, (v, k) => k !== 'Ref' && !_.startsWith(k, 'Fn::'));
358.           if (!isCFRef) {
359.             invalidEnvVar = `Environment variable ${key} must contain string`;
360.             return false;
361.           }
362.         }
363.         return true;
364.       });
365. 
366.       if (invalidEnvVar) {
367.         return BbPromise.reject(new this.serverless.classes.Error(invalidEnvVar));
368.       }
369.     }
370. 
371.     if ('role' in functionObject) {
372.       this.compileRole(newFunction, functionObject.role);
373.     } else if ('role' in this.serverless.service.provider) {
374.       this.compileRole(newFunction, this.serverless.service.provider.role);
375.     } else {
376.       this.compileRole(newFunction, 'IamRoleLambdaExecution');
377.     }
378. 
379.     if (!functionObject.vpc) functionObject.vpc = {};
380.     if (!this.serverless.service.provider.vpc) this.serverless.service.provider.vpc = {};
381. 
382.     newFunction.Properties.VpcConfig = {
383.       SecurityGroupIds:
384.         functionObject.vpc.securityGroupIds ||
385.         this.serverless.service.provider.vpc.securityGroupIds,
386.       SubnetIds: functionObject.vpc.subnetIds || this.serverless.service.provider.vpc.subnetIds,
387.     };
388. 
389.     if (
390.       !newFunction.Properties.VpcConfig.SecurityGroupIds ||
391.       !newFunction.Properties.VpcConfig.SubnetIds
392.     ) {
393.       delete newFunction.Properties.VpcConfig;
394.     }
395. 
396.     if (functionObject.reservedConcurrency || functionObject.reservedConcurrency === 0) {
397.       // Try convert reservedConcurrency to integer
398.       const reservedConcurrency = _.parseInt(functionObject.reservedConcurrency);
399. 
400.       if (_.isInteger(reservedConcurrency)) {
401.         newFunction.Properties.ReservedConcurrentExecutions = reservedConcurrency;
402.       } else {
403.         const errorMessage = [
404.           'You should use integer as reservedConcurrency value on function: ',
405.           `${newFunction.Properties.FunctionName}`,
406.         ].join('');
407. 
408.         return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
409.       }
410.     }
411. 
412.     newFunction.DependsOn = [this.provider.naming.getLogGroupLogicalId(functionName)].concat(
413.       newFunction.DependsOn || []
414.     );
415. 
416.     if (functionObject.layers && _.isArray(functionObject.layers)) {
417.       newFunction.Properties.Layers = functionObject.layers;
418.     } else if (
419.       this.serverless.service.provider.layers &&
420.       _.isArray(this.serverless.service.provider.layers)
421.     ) {
422.       newFunction.Properties.Layers = this.serverless.service.provider.layers;
423.     }
424. 
425.     const functionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
426.     const newFunctionObject = {
427.       [functionLogicalId]: newFunction,
428.     };
429. 
430.     _.merge(
431.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
432.       newFunctionObject
433.     );
434. 
435.     const newVersion = this.cfLambdaVersionTemplate();
436. 
437.     // Create hashes for the artifact and the logical id of the version resource
438.     // The one for the version resource must include the function configuration
439.     // to make sure that a new version is created on configuration changes and
440.     // not only on source changes.
441.     const fileHash = crypto.createHash('sha256');
442.     const versionHash = crypto.createHash('sha256');
443.     fileHash.setEncoding('base64');
444.     versionHash.setEncoding('base64');
445. 
446.     // Read the file in chunks and add them to the hash (saves memory and performance)
447.     return BbPromise.fromCallback(cb => {
448.       const readStream = fs.createReadStream(artifactFilePath);
449. 
450.       readStream
451.         .on('data', chunk => {
452.           fileHash.write(chunk);
453.           versionHash.write(chunk);
454.         })
455.         .on('close', () => {
456.           cb();
457.         })
458.         .on('error', error => {
459.           cb(error);
460.         });
461.     }).then(() => {
462.       // Include function configuration in version id hash (without the Code part)
463.       const properties = _.omit(_.get(newFunction, 'Properties', {}), 'Code');
464.       _.forOwn(properties, value => {
465.         const hashedValue = _.isObject(value) ? JSON.stringify(value) : _.toString(value);
466.         versionHash.write(hashedValue);
467.       });
468. 
469.       // Finalize hashes
470.       fileHash.end();
471.       versionHash.end();
472. 
473.       const fileDigest = fileHash.read();
474.       const versionDigest = versionHash.read();
475. 
476.       newVersion.Properties.CodeSha256 = fileDigest;
477.       newVersion.Properties.FunctionName = { Ref: functionLogicalId };
478.       if (functionObject.description) {
479.         newVersion.Properties.Description = functionObject.description;
480.       }
481. 
482.       // use the version SHA in the logical resource ID of the version because
483.       // AWS::Lambda::Version resource will not support updates
484.       const versionLogicalId = this.provider.naming.getLambdaVersionLogicalId(
485.         functionName,
486.         versionDigest
487.       );
488.       const newVersionObject = {
489.         [versionLogicalId]: newVersion,
490.       };
491. 
492.       const versionFunction =
493.         functionObject.versionFunction != null
494.           ? functionObject.versionFunction
495.           : this.serverless.service.provider.versionFunctions;
496. 
497.       if (versionFunction) {
498.         _.merge(
499.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
500.           newVersionObject


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 10 - 580
Content:
class AwsCompileFunctions {
  constructor(serverless, options) {
    this.serverless = serverless;
    this.options = options;
    const servicePath = this.serverless.config.servicePath || '';
    this.packagePath =
      this.serverless.service.package.path || path.join(servicePath || '.', '.serverless');

    this.provider = this.serverless.getProvider('aws');

    if (
      this.serverless.service.provider.versionFunctions === undefined ||
      this.serverless.service.provider.versionFunctions === null
    ) {
      this.serverless.service.provider.versionFunctions = true;
    }

    this.hooks = {
      'package:compileFunctions': () =>
        BbPromise.bind(this)
          .then(this.downloadPackageArtifacts)
          .then(this.compileFunctions),
    };
  }

  compileRole(newFunction, role) {
    const compiledFunction = newFunction;
    const unnsupportedRoleError = new this.serverless.classes.Error(
      `Unsupported role provided: "${JSON.stringify(role)}"`
    );

    switch (typeof role) {
      case 'object':
        if ('Fn::GetAtt' in role) {
          // role is an "Fn::GetAtt" object
          compiledFunction.Properties.Role = role;
          compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
            role['Fn::GetAtt'][0]
          );
        } else if ('Fn::ImportValue' in role) {
          // role is an "Fn::ImportValue" object
          compiledFunction.Properties.Role = role;
        } else {
          throw unnsupportedRoleError;
        }
        break;
      case 'string':
        if (role.startsWith('arn:aws')) {
          // role is a statically definied iam arn
          compiledFunction.Properties.Role = role;
        } else if (role === 'IamRoleLambdaExecution') {
          // role is the default role generated by the framework
          compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
          compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
            'IamRoleLambdaExecution'
          );
        } else {
          // role is a Logical Role Name
          compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
          compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);
        }
        break;
      default:
        throw unnsupportedRoleError;
    }
  }

  downloadPackageArtifact(functionName) {
    const { region } = this.options;
    const S3 = new AWS.S3({ region });

    const functionObject = this.serverless.service.getFunction(functionName);
    const artifactFilePath =
      _.get(functionObject, 'package.artifact') ||
      _.get(this, 'serverless.service.package.artifact');

    const regex = new RegExp('s3\\.amazonaws\\.com/(.+)/(.+)');
    const match = artifactFilePath.match(regex);

    if (match) {
      return new BbPromise((resolve, reject) => {
        const tmpDir = this.serverless.utils.getTmpDirPath();
        const filePath = path.join(tmpDir, match[2]);

        const readStream = S3.getObject({
          Bucket: match[1],
          Key: match[2],
        }).createReadStream();

        const writeStream = fs.createWriteStream(filePath);

        readStream.on('error', error => reject(error));
        readStream
          .pipe(writeStream)
          .on('error', reject)
          .on('close', () => {
            if (functionObject.package.artifact) {
              functionObject.package.artifact = filePath;
            } else {
              this.serverless.service.package.artifact = filePath;
            }
            return resolve(filePath);
          });
      });
    }

    return BbPromise.resolve();
  }

  compileFunction(functionName) {
    const newFunction = this.cfLambdaFunctionTemplate();
    const functionObject = this.serverless.service.getFunction(functionName);
    functionObject.package = functionObject.package || {};

    const serviceArtifactFileName = this.provider.naming.getServiceArtifactName();
    const functionArtifactFileName = this.provider.naming.getFunctionArtifactName(functionName);

    let artifactFilePath =
      functionObject.package.artifact || this.serverless.service.package.artifact;

    if (
      !artifactFilePath ||
      (this.serverless.service.artifact && !functionObject.package.artifact)
    ) {
      let artifactFileName = serviceArtifactFileName;
      if (this.serverless.service.package.individually || functionObject.package.individually) {
        artifactFileName = functionArtifactFileName;
      }

      artifactFilePath = path.join(
        this.serverless.config.servicePath,
        '.serverless',
        artifactFileName
      );
    }

    if (this.serverless.service.package.deploymentBucket) {
      newFunction.Properties.Code.S3Bucket = this.serverless.service.package.deploymentBucket;
    }

    const s3Folder = this.serverless.service.package.artifactDirectoryName;
    const s3FileName = artifactFilePath.split(path.sep).pop();
    newFunction.Properties.Code.S3Key = `${s3Folder}/${s3FileName}`;

    if (!functionObject.handler) {
      const errorMessage = [
        `Missing "handler" property in function "${functionName}".`,
        ' Please make sure you point to the correct lambda handler.',
        ' For example: handler.hello.',
        ' Please check the docs for more info',
      ].join('');
      return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
    }

    const Handler = functionObject.handler;
    const FunctionName = functionObject.name;
    const MemorySize =
      Number(functionObject.memorySize) ||
      Number(this.serverless.service.provider.memorySize) ||
      1024;
    const Timeout =
      Number(functionObject.timeout) || Number(this.serverless.service.provider.timeout) || 6;
    const Runtime =
      functionObject.runtime || this.serverless.service.provider.runtime || 'nodejs10.x';

    newFunction.Properties.Handler = Handler;
    newFunction.Properties.FunctionName = FunctionName;
    newFunction.Properties.MemorySize = MemorySize;
    newFunction.Properties.Timeout = Timeout;
    newFunction.Properties.Runtime = Runtime;

    // publish these properties to the platform
    this.serverless.service.functions[functionName].memory = MemorySize;
    this.serverless.service.functions[functionName].timeout = Timeout;
    this.serverless.service.functions[functionName].runtime = Runtime;

    if (functionObject.description) {
      newFunction.Properties.Description = functionObject.description;
    }

    if (functionObject.condition) {
      newFunction.Condition = functionObject.condition;
    }

    if (functionObject.dependsOn) {
      newFunction.DependsOn = (newFunction.DependsOn || []).concat(functionObject.dependsOn);
    }

    if (functionObject.tags || this.serverless.service.provider.tags) {
      const tags = Object.assign({}, this.serverless.service.provider.tags, functionObject.tags);
      newFunction.Properties.Tags = [];
      _.forEach(tags, (Value, Key) => {
        newFunction.Properties.Tags.push({ Key, Value });
      });
    }

    if (functionObject.onError) {
      const arn = functionObject.onError;

      if (typeof arn === 'string') {
        const splittedArn = arn.split(':');
        if (splittedArn[0] === 'arn' && (splittedArn[2] === 'sns' || splittedArn[2] === 'sqs')) {
          const dlqType = splittedArn[2];
          const iamRoleLambdaExecution = this.serverless.service.provider
            .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
          let stmt;

          newFunction.Properties.DeadLetterConfig = {
            TargetArn: arn,
          };

          if (dlqType === 'sns') {
            stmt = {
              Effect: 'Allow',
              Action: ['sns:Publish'],
              Resource: [arn],
            };
          } else if (dlqType === 'sqs') {
            const errorMessage = [
              'onError currently only supports SNS topic arns due to a',
              ' race condition when using SQS queue arns and updating the IAM role.',
              ' Please check the docs for more info.',
            ].join('');
            return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
          }

          // update the PolicyDocument statements (if default policy is used)
          if (iamRoleLambdaExecution) {
            iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);
          }
        } else {
          const errorMessage = 'onError config must be a SNS topic arn or SQS queue arn';
          return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
        }
      } else if (this.isArnRefGetAttOrImportValue(arn)) {
        newFunction.Properties.DeadLetterConfig = {
          TargetArn: arn,
        };
      } else {
        const errorMessage = [
          'onError config must be provided as an arn string,',
          ' Ref, Fn::GetAtt or Fn::ImportValue',
        ].join('');
        return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
      }
    }

    let kmsKeyArn;
    const serviceObj = this.serverless.service.serviceObject;
    if ('awsKmsKeyArn' in functionObject) {
      kmsKeyArn = functionObject.awsKmsKeyArn;
    } else if (serviceObj && 'awsKmsKeyArn' in serviceObj) {
      kmsKeyArn = serviceObj.awsKmsKeyArn;
    }

    if (kmsKeyArn) {
      const arn = kmsKeyArn;

      if (typeof arn === 'string') {
        const splittedArn = arn.split(':');
        if (splittedArn[0] === 'arn' && splittedArn[2] === 'kms') {
          const iamRoleLambdaExecution = this.serverless.service.provider
            .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;

          newFunction.Properties.KmsKeyArn = arn;

          const stmt = {
            Effect: 'Allow',
            Action: ['kms:Decrypt'],
            Resource: [arn],
          };

          // update the PolicyDocument statements (if default policy is used)
          if (iamRoleLambdaExecution) {
            iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
              iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
              [stmt],
              _.isEqual
            );
          }
        } else {
          const errorMessage = 'awsKmsKeyArn config must be a KMS key arn';
          return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
        }
      } else {
        const errorMessage = 'awsKmsKeyArn config must be provided as a string';
        return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
      }
    }

    const tracing =
      functionObject.tracing ||
      (this.serverless.service.provider.tracing && this.serverless.service.provider.tracing.lambda);

    if (tracing) {
      if (typeof tracing === 'boolean' || typeof tracing === 'string') {
        let mode = tracing;

        if (typeof tracing === 'boolean') {
          mode = 'Active';
        }

        const iamRoleLambdaExecution = this.serverless.service.provider
          .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;

        newFunction.Properties.TracingConfig = {
          Mode: mode,
        };

        const stmt = {
          Effect: 'Allow',
          Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],
          Resource: ['*'],
        };

        // update the PolicyDocument statements (if default policy is used)
        if (iamRoleLambdaExecution) {
          iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
            iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
            [stmt],
            _.isEqual
          );
        }
      } else {
        const errorMessage = 'tracing requires a boolean value or the "mode" provided as a string';
        throw new this.serverless.classes.Error(errorMessage);
      }
    }

    if (functionObject.environment || this.serverless.service.provider.environment) {
      newFunction.Properties.Environment = {};
      newFunction.Properties.Environment.Variables = Object.assign(
        {},
        this.serverless.service.provider.environment,
        functionObject.environment
      );

      let invalidEnvVar = null;
      _.forEach(_.keys(newFunction.Properties.Environment.Variables), key => {
        // taken from the bash man pages
        if (!key.match(/^[A-Za-z_][a-zA-Z0-9_]*$/)) {
          invalidEnvVar = `Invalid characters in environment variable ${key}`;
          return false; // break loop with lodash
        }
        const value = newFunction.Properties.Environment.Variables[key];
        if (_.isObject(value)) {
          const isCFRef =
            _.isObject(value) && !_.some(value, (v, k) => k !== 'Ref' && !_.startsWith(k, 'Fn::'));
          if (!isCFRef) {
            invalidEnvVar = `Environment variable ${key} must contain string`;
            return false;
          }
        }
        return true;
      });

      if (invalidEnvVar) {
        return BbPromise.reject(new this.serverless.classes.Error(invalidEnvVar));
      }
    }

    if ('role' in functionObject) {
      this.compileRole(newFunction, functionObject.role);
    } else if ('role' in this.serverless.service.provider) {
      this.compileRole(newFunction, this.serverless.service.provider.role);
    } else {
      this.compileRole(newFunction, 'IamRoleLambdaExecution');
    }

    if (!functionObject.vpc) functionObject.vpc = {};
    if (!this.serverless.service.provider.vpc) this.serverless.service.provider.vpc = {};

    newFunction.Properties.VpcConfig = {
      SecurityGroupIds:
        functionObject.vpc.securityGroupIds ||
        this.serverless.service.provider.vpc.securityGroupIds,
      SubnetIds: functionObject.vpc.subnetIds || this.serverless.service.provider.vpc.subnetIds,
    };

    if (
      !newFunction.Properties.VpcConfig.SecurityGroupIds ||
      !newFunction.Properties.VpcConfig.SubnetIds
    ) {
      delete newFunction.Properties.VpcConfig;
    }

    if (functionObject.reservedConcurrency || functionObject.reservedConcurrency === 0) {
      // Try convert reservedConcurrency to integer
      const reservedConcurrency = _.parseInt(functionObject.reservedConcurrency);

      if (_.isInteger(reservedConcurrency)) {
        newFunction.Properties.ReservedConcurrentExecutions = reservedConcurrency;
      } else {
        const errorMessage = [
          'You should use integer as reservedConcurrency value on function: ',
          `${newFunction.Properties.FunctionName}`,
        ].join('');

        return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
      }
    }

    newFunction.DependsOn = [this.provider.naming.getLogGroupLogicalId(functionName)].concat(
      newFunction.DependsOn || []
    );

    if (functionObject.layers && _.isArray(functionObject.layers)) {
      newFunction.Properties.Layers = functionObject.layers;
    } else if (
      this.serverless.service.provider.layers &&
      _.isArray(this.serverless.service.provider.layers)
    ) {
      newFunction.Properties.Layers = this.serverless.service.provider.layers;
    }

    const functionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
    const newFunctionObject = {
      [functionLogicalId]: newFunction,
    };

    _.merge(
      this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
      newFunctionObject
    );

    const newVersion = this.cfLambdaVersionTemplate();

    // Create hashes for the artifact and the logical id of the version resource
    // The one for the version resource must include the function configuration
    // to make sure that a new version is created on configuration changes and
    // not only on source changes.
    const fileHash = crypto.createHash('sha256');
    const versionHash = crypto.createHash('sha256');
    fileHash.setEncoding('base64');
    versionHash.setEncoding('base64');

    // Read the file in chunks and add them to the hash (saves memory and performance)
    return BbPromise.fromCallback(cb => {
      const readStream = fs.createReadStream(artifactFilePath);

      readStream
        .on('data', chunk => {
          fileHash.write(chunk);
          versionHash.write(chunk);
        })
        .on('close', () => {
          cb();
        })
        .on('error', error => {
          cb(error);
        });
    }).then(() => {
      // Include function configuration in version id hash (without the Code part)
      const properties = _.omit(_.get(newFunction, 'Properties', {}), 'Code');
      _.forOwn(properties, value => {
        const hashedValue = _.isObject(value) ? JSON.stringify(value) : _.toString(value);
        versionHash.write(hashedValue);
      });

      // Finalize hashes
      fileHash.end();
      versionHash.end();

      const fileDigest = fileHash.read();
      const versionDigest = versionHash.read();

      newVersion.Properties.CodeSha256 = fileDigest;
      newVersion.Properties.FunctionName = { Ref: functionLogicalId };
      if (functionObject.description) {
        newVersion.Properties.Description = functionObject.description;
      }

      // use the version SHA in the logical resource ID of the version because
      // AWS::Lambda::Version resource will not support updates
      const versionLogicalId = this.provider.naming.getLambdaVersionLogicalId(
        functionName,
        versionDigest
      );
      const newVersionObject = {
        [versionLogicalId]: newVersion,
      };

      const versionFunction =
        functionObject.versionFunction != null
          ? functionObject.versionFunction
          : this.serverless.service.provider.versionFunctions;

      if (versionFunction) {
        _.merge(
          this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
          newVersionObject
        );
      }

      // Add function versions to Outputs section
      const functionVersionOutputLogicalId = this.provider.naming.getLambdaVersionOutputLogicalId(
        functionName
      );
      const newVersionOutput = this.cfOutputLatestVersionTemplate();

      newVersionOutput.Value = { Ref: versionLogicalId };

      if (versionFunction) {
        _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Outputs, {
          [functionVersionOutputLogicalId]: newVersionOutput,
        });
      }

      return BbPromise.resolve();
    });
  }

  downloadPackageArtifacts() {
    const allFunctions = this.serverless.service.getAllFunctions();
    return BbPromise.each(allFunctions, functionName => this.downloadPackageArtifact(functionName));
  }

  compileFunctions() {
    const allFunctions = this.serverless.service.getAllFunctions();
    return BbPromise.each(allFunctions, functionName => this.compileFunction(functionName));
  }

  // helper functions
  isArnRefGetAttOrImportValue(arn) {
    return (
      typeof arn === 'object' &&
      _.some(_.keys(arn), k => _.includes(['Ref', 'Fn::GetAtt', 'Fn::ImportValue'], k))
    );
  }

  cfLambdaFunctionTemplate() {
    return {
      Type: 'AWS::Lambda::Function',
      Properties: {
        Code: {
          S3Bucket: {
            Ref: 'ServerlessDeploymentBucket',
          },
          S3Key: 'S3Key',
        },
        FunctionName: 'FunctionName',
        Handler: 'Handler',
        MemorySize: 'MemorySize',
        Role: 'Role',
        Runtime: 'Runtime',
        Timeout: 'Timeout',
      },
    };
  }

  cfLambdaVersionTemplate() {
    return {
      Type: 'AWS::Lambda::Version',
      // Retain old versions even though they will not be in future
      // CloudFormation stacks. On stack delete, these will be removed when
      // their associated function is removed.
      DeletionPolicy: 'Retain',
      Properties: {
        FunctionName: 'FunctionName',
        CodeSha256: 'CodeSha256',
      },
    };
  }

  cfOutputLatestVersionTemplate() {
    return {
      Description: 'Current Lambda function version',
      Value: 'Value',
    };
  }
}


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 500 - 1000
Content:
500.           newVersionObject
501.         );
502.       }
503. 
504.       // Add function versions to Outputs section
505.       const functionVersionOutputLogicalId = this.provider.naming.getLambdaVersionOutputLogicalId(
506.         functionName
507.       );
508.       const newVersionOutput = this.cfOutputLatestVersionTemplate();
509. 
510.       newVersionOutput.Value = { Ref: versionLogicalId };
511. 
512.       if (versionFunction) {
513.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Outputs, {
514.           [functionVersionOutputLogicalId]: newVersionOutput,
515.         });
516.       }
517. 
518.       return BbPromise.resolve();
519.     });
520.   }
521. 
522.   downloadPackageArtifacts() {
523.     const allFunctions = this.serverless.service.getAllFunctions();
524.     return BbPromise.each(allFunctions, functionName => this.downloadPackageArtifact(functionName));
525.   }
526. 
527.   compileFunctions() {
528.     const allFunctions = this.serverless.service.getAllFunctions();
529.     return BbPromise.each(allFunctions, functionName => this.compileFunction(functionName));
530.   }
531. 
532.   // helper functions
533.   isArnRefGetAttOrImportValue(arn) {
534.     return (
535.       typeof arn === 'object' &&
536.       _.some(_.keys(arn), k => _.includes(['Ref', 'Fn::GetAtt', 'Fn::ImportValue'], k))
537.     );
538.   }
539. 
540.   cfLambdaFunctionTemplate() {
541.     return {
542.       Type: 'AWS::Lambda::Function',
543.       Properties: {
544.         Code: {
545.           S3Bucket: {
546.             Ref: 'ServerlessDeploymentBucket',
547.           },
548.           S3Key: 'S3Key',
549.         },
550.         FunctionName: 'FunctionName',
551.         Handler: 'Handler',
552.         MemorySize: 'MemorySize',
553.         Role: 'Role',
554.         Runtime: 'Runtime',
555.         Timeout: 'Timeout',
556.       },
557.     };
558.   }
559. 
560.   cfLambdaVersionTemplate() {
561.     return {
562.       Type: 'AWS::Lambda::Version',
563.       // Retain old versions even though they will not be in future
564.       // CloudFormation stacks. On stack delete, these will be removed when
565.       // their associated function is removed.
566.       DeletionPolicy: 'Retain',
567.       Properties: {
568.         FunctionName: 'FunctionName',
569.         CodeSha256: 'CodeSha256',
570.       },
571.     };
572.   }
573. 
574.   cfOutputLatestVersionTemplate() {
575.     return {
576.       Description: 'Current Lambda function version',
577.       Value: 'Value',
578.     };
579.   }
580. }
581. 
582. module.exports = AwsCompileFunctions;


File: lib/plugins/aws/package/compile/layers/index.js
Line number range: 1 - 140
Content:
1. 'use strict';
2. 
3. const crypto = require('crypto');
4. const BbPromise = require('bluebird');
5. const _ = require('lodash');
6. const path = require('path');
7. 
8. class AwsCompileLayers {
9.   constructor(serverless, options) {
10.     this.serverless = serverless;
11.     this.options = options;
12.     const servicePath = this.serverless.config.servicePath || '';
13.     this.packagePath =
14.       this.serverless.service.package.path || path.join(servicePath || '.', '.serverless');
15. 
16.     this.provider = this.serverless.getProvider('aws');
17. 
18.     this.hooks = {
19.       'package:compileLayers': () => BbPromise.bind(this).then(this.compileLayers),
20.     };
21.   }
22. 
23.   compileLayer(layerName) {
24.     const newLayer = this.cfLambdaLayerTemplate();
25.     const layerObject = this.serverless.service.getLayer(layerName);
26.     layerObject.package = layerObject.package || {};
27. 
28.     const artifactFileName = this.provider.naming.getLayerArtifactName(layerName);
29.     const artifactFilePath =
30.       layerObject.package && layerObject.package.artifact
31.         ? layerObject.package.artifact
32.         : path.join(this.serverless.config.servicePath, '.serverless', artifactFileName);
33. 
34.     if (this.serverless.service.package.deploymentBucket) {
35.       newLayer.Properties.Content.S3Bucket = this.serverless.service.package.deploymentBucket;
36.     }
37. 
38.     const s3Folder = this.serverless.service.package.artifactDirectoryName;
39.     const s3FileName = artifactFilePath.split(path.sep).pop();
40.     newLayer.Properties.Content.S3Key = `${s3Folder}/${s3FileName}`;
41. 
42.     newLayer.Properties.LayerName = layerObject.name || layerName;
43.     if (layerObject.description) {
44.       newLayer.Properties.Description = layerObject.description;
45.     }
46.     if (layerObject.licenseInfo) {
47.       newLayer.Properties.LicenseInfo = layerObject.licenseInfo;
48.     }
49.     if (layerObject.compatibleRuntimes) {
50.       newLayer.Properties.CompatibleRuntimes = layerObject.compatibleRuntimes;
51.     }
52. 
53.     let layerLogicalId = this.provider.naming.getLambdaLayerLogicalId(layerName);
54.     if (layerObject.retain) {
55.       const sha = crypto
56.         .createHash('sha1')
57.         .update(JSON.stringify(_.omit(newLayer, ['Properties.Content.S3Key'])))
58.         .digest('hex');
59.       layerLogicalId = `${layerLogicalId}${sha}`;
60.       newLayer.DeletionPolicy = 'Retain';
61.     }
62.     const newLayerObject = {
63.       [layerLogicalId]: newLayer,
64.     };
65. 
66.     if (layerObject.allowedAccounts) {
67.       layerObject.allowedAccounts.map(account => {
68.         let parsedAccount = account;
69.         // cast to string if account is number
70.         if (typeof account === 'number' && !isNaN(account)) {
71.           parsedAccount = `${account}`;
72.         }
73.         const newPermission = this.cfLambdaLayerPermissionTemplate();
74.         newPermission.Properties.LayerVersionArn = { Ref: layerLogicalId };
75.         newPermission.Properties.Principal = parsedAccount;
76.         const layerPermLogicalId = this.provider.naming.getLambdaLayerPermissionLogicalId(
77.           layerName,
78.           parsedAccount
79.         );
80.         newLayerObject[layerPermLogicalId] = newPermission;
81.         return newPermission;
82.       });
83.     }
84. 
85.     _.merge(
86.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
87.       newLayerObject
88.     );
89. 
90.     // Add layer to Outputs section
91.     const layerOutputLogicalId = this.provider.naming.getLambdaLayerOutputLogicalId(layerName);
92.     const newLayerOutput = this.cfOutputLayerTemplate();
93. 
94.     newLayerOutput.Value = { Ref: layerLogicalId };
95. 
96.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Outputs, {
97.       [layerOutputLogicalId]: newLayerOutput,
98.     });
99.   }
100. 
101.   compileLayers() {
102.     const allLayers = this.serverless.service.getAllLayers();
103.     return BbPromise.each(allLayers, layerName => this.compileLayer(layerName));
104.   }
105. 
106.   cfLambdaLayerTemplate() {
107.     return {
108.       Type: 'AWS::Lambda::LayerVersion',
109.       Properties: {
110.         Content: {
111.           S3Bucket: {
112.             Ref: 'ServerlessDeploymentBucket',
113.           },
114.           S3Key: 'S3Key',
115.         },
116.         LayerName: 'LayerName',
117.       },
118.     };
119.   }
120. 
121.   cfLambdaLayerPermissionTemplate() {
122.     return {
123.       Type: 'AWS::Lambda::LayerVersionPermission',
124.       Properties: {
125.         Action: 'lambda:GetLayerVersion',
126.         LayerVersionArn: 'LayerVersionArn',
127.         Principal: 'Principal',
128.       },
129.     };
130.   }
131. 
132.   cfOutputLayerTemplate() {
133.     return {
134.       Description: 'Current Lambda layer version',
135.       Value: 'Value',
136.     };
137.   }
138. }
139. 
140. module.exports = AwsCompileLayers;


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const AWS = require('aws-sdk');
4. const BbPromise = require('bluebird');
5. const HttpsProxyAgent = require('https-proxy-agent');
6. const url = require('url');
7. const chalk = require('chalk');
8. const _ = require('lodash');
9. const userStats = require('../../../utils/userStats');
10. const naming = require('../lib/naming.js');
11. const https = require('https');
12. const fs = require('fs');
13. const objectHash = require('object-hash');
14. const PromiseQueue = require('promise-queue');
15. const getS3EndpointForRegion = require('../utils/getS3EndpointForRegion');
16. const readline = require('readline');
17. 
18. const constants = {
19.   providerName: 'aws',
20. };
21. 
22. PromiseQueue.configure(BbPromise.Promise);
23. 
24. const impl = {
25.   /**
26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid
27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for
28.    * whak-a-mole!
29.    * @param credentials The credentials to test for validity
30.    * @return {boolean} Whether the given credentials were valid
31.    */
32.   validCredentials: credentials => {
33.     let result = false;
34.     if (credentials) {
35.       if (
36.         // valid credentials loaded
37.         (credentials.accessKeyId &&
38.           credentials.accessKeyId !== 'undefined' &&
39.           credentials.secretAccessKey &&
40.           credentials.secretAccessKey !== 'undefined') ||
41.         // a role to assume has been successfully loaded, the associated STS request has been
42.         // sent, and the temporary credentials will be asynchronously delivered.
43.         credentials.roleArn
44.       ) {
45.         result = true;
46.       }
47.     }
48.     return result;
49.   },
50.   /**
51.    * Add credentials, if present, to the given results
52.    * @param results The results to add the given credentials to if they are valid
53.    * @param credentials The credentials to validate and add to the results if valid
54.    */
55.   addCredentials: (results, credentials) => {
56.     if (impl.validCredentials(credentials)) {
57.       results.credentials = credentials; // eslint-disable-line no-param-reassign
58.     }
59.   },
60.   /**
61.    * Add credentials, if present, from the environment
62.    * @param results The results to add environment credentials to
63.    * @param prefix The environment variable prefix to use in extracting credentials
64.    */
65.   addEnvironmentCredentials: (results, prefix) => {
66.     if (prefix) {
67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);
68.       impl.addCredentials(results, environmentCredentials);
69.     }
70.   },
71.   /**
72.    * Add credentials from a profile, if the profile and credentials for it exists
73.    * @param results The results to add profile credentials to
74.    * @param profile The profile to load credentials from
75.    */
76.   addProfileCredentials: (results, profile) => {
77.     if (profile) {
78.       const params = { profile };
79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {
80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;
81.       }
82. 
83.       // Setup a MFA callback for asking the code from the user.
84.       params.tokenCodeFn = (mfaSerial, callback) => {
85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {
87.           rl.close();
88.           callback(null, answer);
89.         });
90.       };
91. 
92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);
93.       if (
94.         !(
95.           profileCredentials.accessKeyId ||
96.           profileCredentials.sessionToken ||
97.           profileCredentials.roleArn
98.         )
99.       ) {
100.         throw new Error(`Profile ${profile} does not exist`);
101.       }
102. 
103.       impl.addCredentials(results, profileCredentials);
104.     }
105.   },
106.   /**
107.    * Add credentials, if present, from a profile that is specified within the environment
108.    * @param results The prefix of the profile's declaration in the environment
109.    * @param prefix The prefix for the environment variable
110.    */
111.   addEnvironmentProfile: (results, prefix) => {
112.     if (prefix) {
113.       const profile = process.env[`${prefix}_PROFILE`];
114.       impl.addProfileCredentials(results, profile);
115.     }
116.   },
117. };
118. 
119. class AwsProvider {
120.   static getProviderName() {
121.     return constants.providerName;
122.   }
123. 
124.   constructor(serverless, options) {
125.     this.naming = { provider: this };
126.     this.options = options;
127.     this.provider = this; // only load plugin in an AWS service context
128.     this.serverless = serverless;
129.     this.sdk = AWS;
130.     this.serverless.setProvider(constants.providerName, this);
131.     if (this.serverless.service.provider.name === 'aws') {
132.       this.serverless.service.provider.region = this.getRegion();
133.     }
134.     this.requestCache = {};
135.     this.requestQueue = new PromiseQueue(2, Infinity);
136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).
137.     this.cachedCredentials = null;
138. 
139.     Object.assign(this.naming, naming);
140. 
141.     // Activate AWS SDK loggin
142.     if (process.env.SLS_DEBUG) {
143.       AWS.config.logger = this.serverless.cli;
144.     }
145. 
146.     // Use HTTPS Proxy (Optional)
147.     const proxy =
148.       process.env.proxy ||
149.       process.env.HTTP_PROXY ||
150.       process.env.http_proxy ||
151.       process.env.HTTPS_PROXY ||
152.       process.env.https_proxy;
153. 
154.     const proxyOptions = {};
155.     if (proxy) {
156.       Object.assign(proxyOptions, url.parse(proxy));
157.     }
158. 
159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;
160. 
161.     let caCerts = [];
162. 
163.     if (ca) {
164.       // Can be a single certificate or multiple, comma separated.
165.       const caArr = ca.split(',');
166.       // Replace the newline -- https://stackoverflow.com/questions/30400341
167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\n/g, '\n')));
168.     }
169. 
170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;
171. 
172.     if (cafile) {
173.       // Can be a single certificate file path or multiple paths, comma separated.
174.       const caPathArr = cafile.split(',');
175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));
176.     }
177. 
178.     if (caCerts.length > 0) {
179.       Object.assign(proxyOptions, {
180.         rejectUnauthorized: true,
181.         ca: caCerts,
182.       });
183.     }
184. 
185.     // Passes also certifications
186.     if (proxy) {
187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);
188.     } else if (proxyOptions.ca) {
189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html
190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);
191.     }
192. 
193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)
194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;
195.     if (timeout) {
196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);
197.     }
198. 
199.     // Support deploymentBucket configuration as an object
200.     const provider = this.serverless.service.provider;
201.     if (provider && provider.deploymentBucket) {
202.       if (_.isObject(provider.deploymentBucket)) {
203.         // store the object in a new variable so that it can be reused later on
204.         provider.deploymentBucketObject = provider.deploymentBucket;
205.         if (provider.deploymentBucket.name) {
206.           // (re)set the value of the deploymentBucket property to the name (which is a string)
207.           provider.deploymentBucket = provider.deploymentBucket.name;
208.         } else {
209.           provider.deploymentBucket = null;
210.         }
211.       }
212.     }
213.   }
214. 
215.   /**
216.    * Execute an AWS request by calling the AWS SDK
217.    * @param {string} service - Service name
218.    * @param {string} method - Method name
219.    * @param {Object} params - Parameters
220.    * @param {Object} [options] - Options to modify the request behavior
221.    * @prop [options.useCache] - Utilize cache to retrieve results
222.    * @prop [options.region] - Specify when to request to different region
223.    */
224.   request(service, method, params, options) {
225.     const that = this;
226.     const credentials = Object.assign({}, that.getCredentials());
227.     // Make sure options is an object (honors wrong calls of request)
228.     const requestOptions = _.isObject(options) ? options : {};
229.     const shouldCache = _.get(requestOptions, 'useCache', false);
230.     const paramsWithRegion = _.merge({}, params, {
231.       region: _.get(options, 'region'),
232.     });
233.     const paramsHash = objectHash.sha1(paramsWithRegion);
234.     const MAX_TRIES = 4;
235.     const persistentRequest = f =>
236.       new BbPromise((resolve, reject) => {
237.         const doCall = numTry => {
238.           f()
239.             // We're resembling if/else logic, therefore single `then` instead of `then`/`catch` pair
240.             .then(resolve, e => {
241.               if (
242.                 numTry < MAX_TRIES &&
243.                 e.statusCode !== 403 && // Invalid credentials
244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)
245.               ) {
246.                 that.serverless.cli.log(
247.                   _.join(
248.                     [
249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,
250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,
251.                     ],
252.                     ' '
253.                   )
254.                 );
255.                 setTimeout(doCall, 5000, numTry + 1);
256.               } else {
257.                 reject(e);
258.               }
259.             });
260.         };
261.         return doCall(0);
262.       });
263. 
264.     // Emit a warning for misuses of the old signature including stage and region
265.     // TODO: Determine calling module and log that
266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {
267.       this.serverless.cli.log('WARNING: Inappropriate call of provider.request()');
268.     }
269. 
270.     // Support S3 Transfer Acceleration
271.     if (this.canUseS3TransferAcceleration(service, method)) {
272.       this.enableS3TransferAcceleration(credentials);
273.     }
274. 
275.     if (shouldCache) {
276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);
277.       if (cachedRequest) {
278.         return BbPromise.resolve(cachedRequest);
279.       }
280.     }
281. 
282.     const request = this.requestQueue.add(() =>
283.       persistentRequest(() => {
284.         if (options && !_.isUndefined(options.region)) {
285.           credentials.region = options.region;
286.         }
287.         const awsService = new that.sdk[service](credentials);
288.         const req = awsService[method](params);
289. 
290.         // TODO: Add listeners, put Debug statments here...
291.         // req.on('send', function (r) {console.log(r)});
292. 
293.         const promise = req.promise
294.           ? req.promise()
295.           : BbPromise.fromCallback(cb => {
296.               req.send(cb);
297.             });
298.         return promise.catch(err => {
299.           let message = err.message !== null ? err.message : err.code;
300.           if (err.message === 'Missing credentials in config') {
301.             const errorMessage = [
302.               'AWS provider credentials not found.',
303.               ' Learn how to set up AWS provider credentials',
304.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
305.             ].join('');
306.             message = errorMessage;
307.             userStats.track('user_awsCredentialsNotFound');
308.             // We do not want to trigger the retry mechanism for credential errors
309.             return BbPromise.reject(
310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
311.                 providerError: _.assign({}, err, { retryable: false }),
312.               })
313.             );
314.           }
315. 
316.           return BbPromise.reject(
317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
318.               providerError: err,
319.             })
320.           );
321.         });
322.       }).then(data => {
323.         const result = BbPromise.resolve(data);
324.         if (shouldCache) {
325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);
326.         }
327.         return result;
328.       })
329.     );
330. 
331.     if (shouldCache) {
332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);
333.     }
334. 
335.     return request;
336.   }
337. 
338.   /**
339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the
340.    * well known environment variables
341.    * @returns {{region: *}}
342.    */
343.   getCredentials() {
344.     if (this.cachedCredentials) {
345.       // We have already created the credentials object once, so return it.
346.       return this.cachedCredentials;
347.     }
348.     const result = {};
349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;
350. 
351.     // add specified credentials, overriding with more specific declarations
352.     try {
353.       impl.addProfileCredentials(result, 'default');
354.     } catch (err) {
355.       if (err.message !== 'Profile default does not exist') {
356.         throw err;
357.       }
358.     }
359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds
360.     if (this.serverless.service.provider.profile && !this.options['aws-profile']) {
361.       // config profile
362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);
363.     }
364.     impl.addEnvironmentCredentials(result, 'AWS'); // creds for all stages
365.     impl.addEnvironmentProfile(result, 'AWS');
366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds
367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);
368.     if (this.options['aws-profile']) {
369.       impl.addProfileCredentials(result, this.options['aws-profile']); // CLI option profile
370.     }
371.     result.region = this.getRegion();
372. 
373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;
374.     if (
375.       deploymentBucketObject &&
376.       deploymentBucketObject.serverSideEncryption &&
377.       deploymentBucketObject.serverSideEncryption === 'aws:kms'
378.     ) {
379.       result.signatureVersion = 'v4';
380.     }
381. 
382.     // Store the credentials to avoid creating them again (messes up MFA).
383.     this.cachedCredentials = result;
384.     return result;
385.   }
386. 
387.   canUseS3TransferAcceleration(service, method) {
388.     // TODO enable more S3 APIs?
389.     return (
390.       service === 'S3' &&
391.       ['upload', 'putObject'].indexOf(method) !== -1 &&
392.       this.isS3TransferAccelerationEnabled()
393.     );
394.   }
395. 
396.   // This function will be used to block the addition of transfer acceleration options
397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)
398.   isS3TransferAccelerationSupported() {
399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)
400.     // since those regions do not yet support it
401.     const endpoint = getS3EndpointForRegion(this.getRegion());
402.     return endpoint === 's3.amazonaws.com';
403.   }
404. 
405.   isS3TransferAccelerationEnabled() {
406.     return !!this.options['aws-s3-accelerate'];
407.   }
408. 
409.   isS3TransferAccelerationDisabled() {
410.     return !!this.options['no-aws-s3-accelerate'];
411.   }
412. 
413.   disableTransferAccelerationForCurrentDeploy() {
414.     delete this.options['aws-s3-accelerate'];
415.   }
416. 
417.   enableS3TransferAcceleration(credentials) {
418.     this.serverless.cli.log('Using S3 Transfer Acceleration Endpoint...');
419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign
420.   }
421. 
422.   getValues(source, paths) {
423.     return paths.map(path => ({
424.       path,
425.       value: _.get(source, path.join('.')),
426.     }));
427.   }
428.   firstValue(values) {
429.     return values.reduce((result, current) => {
430.       return result.value ? result : current;
431.     }, {});
432.   }
433. 
434.   getRegionSourceValue() {
435.     const values = this.getValues(this, [
436.       ['options', 'region'],
437.       ['serverless', 'config', 'region'],
438.       ['serverless', 'service', 'provider', 'region'],
439.     ]);
440.     return this.firstValue(values);
441.   }
442.   getRegion() {
443.     const defaultRegion = 'us-east-1';
444.     const regionSourceValue = this.getRegionSourceValue();
445.     return regionSourceValue.value || defaultRegion;
446.   }
447. 
448.   getProfileSourceValue() {
449.     const values = this.getValues(this, [
450.       ['options', 'aws-profile'],
451.       ['options', 'profile'],
452.       ['serverless', 'config', 'profile'],
453.       ['serverless', 'service', 'provider', 'profile'],
454.     ]);
455.     const firstVal = this.firstValue(values);
456.     return firstVal ? firstVal.value : null;
457.   }
458.   getProfile() {
459.     return this.getProfileSourceValue();
460.   }
461. 
462.   getServerlessDeploymentBucketName() {
463.     if (this.serverless.service.provider.deploymentBucket) {
464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);
465.     }
466.     return this.request('CloudFormation', 'describeStackResource', {
467.       StackName: this.naming.getStackName(),
468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),
469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);
470.   }
471. 
472.   getDeploymentPrefix() {
473.     return this.serverless.service.provider.deploymentPrefix || 'serverless';
474.   }
475. 
476.   getLogRetentionInDays() {
477.     if (!_.has(this.serverless.service.provider, 'logRetentionInDays')) {
478.       return null;
479.     }
480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;
481.     const retentionInDays = parseInt(rawRetentionInDays, 10);
482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {
483.       return retentionInDays;
484.     }
485. 
486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;
487.     throw new this.serverless.classes.Error(errorMessage);
488.   }
489. 
490.   getStageSourceValue() {
491.     const values = this.getValues(this, [
492.       ['options', 'stage'],
493.       ['serverless', 'config', 'stage'],
494.       ['serverless', 'service', 'provider', 'stage'],
495.     ]);
496.     return this.firstValue(values);
497.   }
498.   getStage() {
499.     const defaultStage = 'dev';
500.     const stageSourceValue = this.getStageSourceValue();


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 500 - 1000
Content:
500.     const stageSourceValue = this.getStageSourceValue();
501.     return stageSourceValue.value || defaultStage;
502.   }
503. 
504.   getAccountId() {
505.     return this.getAccountInfo().then(result => result.accountId);
506.   }
507. 
508.   getAccountInfo() {
509.     return this.request('STS', 'getCallerIdentity', {}).then(result => {
510.       const arn = result.Arn;
511.       const accountId = result.Account;
512.       const partition = _.nth(_.split(arn, ':'), 1); // ex: arn:aws:iam:acctId:user/xyz
513.       return {
514.         accountId,
515.         partition,
516.         arn: result.Arn,
517.         userId: result.UserId,
518.       };
519.     });
520.   }
521. 
522.   /**
523.    * Get API Gateway Rest API ID from serverless config
524.    */
525.   getApiGatewayRestApiId() {
526.     if (
527.       this.serverless.service.provider.apiGateway &&
528.       this.serverless.service.provider.apiGateway.restApiId
529.     ) {
530.       return this.serverless.service.provider.apiGateway.restApiId;
531.     }
532. 
533.     return { Ref: this.naming.getRestApiLogicalId() };
534.   }
535. 
536.   getApiGatewayDescription() {
537.     if (
538.       this.serverless.service.provider.apiGateway &&
539.       this.serverless.service.provider.apiGateway.description
540.     ) {
541.       return this.serverless.service.provider.apiGateway.description;
542.     }
543.     return undefined;
544.   }
545. 
546.   getMethodArn(accountId, apiId, method, pathParam) {
547.     const region = this.getRegion();
548.     let path = pathParam;
549.     if (pathParam.startsWith('/')) {
550.       path = pathParam.replace(/^\/+/g, '');
551.     }
552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;
553.   }
554. 
555.   /**
556.    * Get Rest API Root Resource ID from serverless config
557.    */
558.   getApiGatewayRestApiRootResourceId() {
559.     if (
560.       this.serverless.service.provider.apiGateway &&
561.       this.serverless.service.provider.apiGateway.restApiRootResourceId
562.     ) {
563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;
564.     }
565.     return { 'Fn::GetAtt': [this.naming.getRestApiLogicalId(), 'RootResourceId'] };
566.   }
567. 
568.   /**
569.    * Get Rest API Predefined Resources from serverless config
570.    */
571.   getApiGatewayPredefinedResources() {
572.     if (
573.       !this.serverless.service.provider.apiGateway ||
574.       !this.serverless.service.provider.apiGateway.restApiResources
575.     ) {
576.       return [];
577.     }
578. 
579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {
580.       return this.serverless.service.provider.apiGateway.restApiResources;
581.     }
582. 
583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== 'object') {
584.       throw new Error('REST API resource must be an array of object');
585.     }
586. 
587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({
588.       path: key,
589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],
590.     }));
591.   }
592. 
593.   /**
594.    * Get API Gateway websocket API ID from serverless config
595.    */
596.   getApiGatewayWebsocketApiId() {
597.     if (
598.       this.serverless.service.provider.apiGateway &&
599.       this.serverless.service.provider.apiGateway.websocketApiId
600.     ) {
601.       return this.serverless.service.provider.apiGateway.websocketApiId;
602.     }
603. 
604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };
605.   }
606. 
607.   getStackResources(next, resourcesParam) {
608.     let resources = resourcesParam;
609.     const params = {
610.       StackName: this.naming.getStackName(),
611.     };
612.     if (!resources) resources = [];
613.     if (next) params.NextToken = next;
614. 
615.     return this.request('CloudFormation', 'listStackResources', params).then(res => {
616.       const allResources = resources.concat(res.StackResourceSummaries);
617.       if (!res.NextToken) {
618.         return allResources;
619.       }
620.       return this.getStackResources(res.NextToken, allResources);
621.     });
622.   }
623. }
624. 
625. module.exports = AwsProvider;

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 21:16:08,547 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='Query requests the contents of lib/plugins/aws/lib/validate.js explicitly. Including the full file content satisfies the request and provides baseline provider validation context.', relative_path='lib/plugins/aws/lib/validate.js', start_line=1, end_line=62), ContextOutput(reasoning='Query requests the contents of lib/plugins/aws/provider/awsProvider.js explicitly. Including first half of the file provides provider architecture and configuration context relevant to IAM and AWS interactions.', relative_path='lib/plugins/aws/provider/awsProvider.js', start_line=1, end_line=500), ContextOutput(reasoning='Continuation of lib/plugins/aws/provider/awsProvider.js content to satisfy the explicit request for the full file and provide complete context.', relative_path='lib/plugins/aws/provider/awsProvider.js', start_line=500, end_line=1000), ContextOutput(reasoning='Provides IAM Role naming and logical ID used across the AWS package/compile logic; essential to understand role resource references.', relative_path='lib/plugins/aws/lib/naming.js', start_line=86, end_line=106), ContextOutput(reasoning='Provides IAM Policy name generation used for default role/policy creation; necessary to understand policy resource naming.', relative_path='lib/plugins/aws/lib/naming.js', start_line=107, end_line=122), ContextOutput(reasoning='Provides logical ID for the custom resources IAM role that is later used when adding iamRoleStatements; critical for integrating iamRoleStatements support.', relative_path='lib/plugins/aws/lib/naming.js', start_line=447, end_line=453), ContextOutput(reasoning='This segment creates the Custom Resources IAM Role and merges iamRoleStatements into its PolicyDocument. It is central to how iamRoleStatements are applied and where support for NotAction/NotResource would need to be integrated or validated.', relative_path='lib/plugins/aws/customResources/index.js', start_line=89, end_line=160), ContextOutput(reasoning='Declares iamRoleStatements array in EventBridge compiler. This captures where event-driven iamRoleStatements are collected.', relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', start_line=21, end_line=23), ContextOutput(reasoning='Pushes iamRoleStatements for EventBridge rule management actions (events:PutRule etc.). Shows concrete actions/resources used.', relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', start_line=146, end_line=162), ContextOutput(reasoning='Adds iamRoleStatements for lambda:AddPermission/RemovePermission for EventBridge-triggered functions.', relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', start_line=174, end_line=190), ContextOutput(reasoning='Invokes addCustomResourceToService with the collected iamRoleStatements for EventBridge; key integration point.', relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', start_line=194, end_line=196), ContextOutput(reasoning='Declares iamRoleStatements array in S3 compiler for existing bucket integration; shows where statements aggregation starts.', relative_path='lib/plugins/aws/package/compile/events/s3/index.js', start_line=199, end_line=206), ContextOutput(reasoning='Pushes S3 bucket notification management permissions into iamRoleStatements (s3:PutBucketNotification, s3:GetBucketNotification).', relative_path='lib/plugins/aws/package/compile/events/s3/index.js', start_line=284, end_line=291), ContextOutput(reasoning='Pushes lambda:AddPermission/RemovePermission permissions into iamRoleStatements for S3 triggers.', relative_path='lib/plugins/aws/package/compile/events/s3/index.js', start_line=303, end_line=321), ContextOutput(reasoning='Invokes addCustomResourceToService with iamRoleStatements for S3 integration.', relative_path='lib/plugins/aws/package/compile/events/s3/index.js', start_line=341, end_line=343), ContextOutput(reasoning='Existing Cognito User Pool event compiler collects iamRoleStatements and adds Cognito and Lambda permissions, then calls addCustomResourceToService. Full method context provided to ensure accurate understanding of how iamRoleStatements are used.', relative_path='lib/plugins/aws/package/compile/events/cognitoUserPool/index.js', start_line=20, end_line=364), ContextOutput(reasoning='CloudFront compiler mutates IamRoleLambdaExecution (AssumeRole policy and logs permissions). This shows how IAM Role and Policy are handled for Lambda@Edge integration.', relative_path='lib/plugins/aws/package/compile/events/cloudFront/index.js', start_line=200, end_line=260), ContextOutput(reasoning='Function compilation handles IAM role assignment, supporting various role reference patterns (string ARN, logical name, Fn::GetAtt, Fn::ImportValue). Essential IAM role handling logic.', relative_path='lib/plugins/aws/package/compile/functions/index.js', start_line=35, end_line=75), ContextOutput(reasoning='Function compilation adds SNS onError policy statements to IamRoleLambdaExecution. Shows policy statement mutation points.', relative_path='lib/plugins/aws/package/compile/functions/index.js', start_line=216, end_line=240), ContextOutput(reasoning='Function compilation adds KMS decrypt policy statements to IamRoleLambdaExecution when awsKmsKeyArn is set.', relative_path='lib/plugins/aws/package/compile/functions/index.js', start_line=271, end_line=289), ContextOutput(reasoning='Function compilation adds X-Ray permissions to IamRoleLambdaExecution when tracing is enabled.', relative_path='lib/plugins/aws/package/compile/functions/index.js', start_line=319, end_line=333), ContextOutput(reasoning='Deploy Function logic normalizes role references, including resolving logical role resources to full ARN; relevant for IAM Role handling.', relative_path='lib/plugins/aws/deployFunction/index.js', start_line=71, end_line=116), ContextOutput(reasoning='Stream events compiler updates IamRoleLambdaExecution PolicyDocument with DynamoDB and Kinesis permissions; shows policy updates.', relative_path='lib/plugins/aws/package/compile/events/stream/index.js', start_line=200, end_line=228), ContextOutput(reasoning='SQS events compiler updates IamRoleLambdaExecution PolicyDocument with SQS permissions; shows policy updates.', relative_path='lib/plugins/aws/package/compile/events/sqs/index.js', start_line=131, end_line=170)]
2025-11-13 21:16:08,560 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 24 contexts to memory for query: Please provide the contents of lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and any files under lib/plugins/aws/package/lib and lib/plugins/aws/package/compile that handle IAM roles/policies and iamRoleStatements.
2025-11-13 21:16:09,103 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 21:16:09,105 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 24 new contexts to 0 existing contexts
2025-11-13 21:16:09,105 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 24 total contexts (removed 0 duplicates)
2025-11-13 21:16:09,107 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the contents of lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and any files under lib/plugins/aws/package/lib and lib/plugins/aws/package/compile that handle IAM roles/policies and iamRoleStatements.
Extra Requirements: If the exact files are unclear, include a directory listing and code snippets (with paths) for any modules referencing iamRoleStatements, IAM, Role, Policy, NotAction, or NotResource.
Purpose: I need to pinpoint where NotAction/NotResource are rejected and understand the architectural patterns to integrate support consistently.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/customResources/index.js
Line number range: 89 - 160
Content:
89.       let customResourceRole = Resources[customResourcesRoleLogicalId];
90.       if (!customResourceRole) {
91.         customResourceRole = {
92.           Type: 'AWS::IAM::Role',
93.           Properties: {
94.             AssumeRolePolicyDocument: {
95.               Version: '2012-10-17',
96.               Statement: [
97.                 {
98.                   Effect: 'Allow',
99.                   Principal: {
100.                     Service: ['lambda.amazonaws.com'],
101.                   },
102.                   Action: ['sts:AssumeRole'],
103.                 },
104.               ],
105.             },
106.             Policies: [
107.               {
108.                 PolicyName: {
109.                   'Fn::Join': [
110.                     '-',
111.                     [
112.                       awsProvider.getStage(),
113.                       awsProvider.serverless.service.service,
114.                       'custom-resources-lambda',
115.                     ],
116.                   ],
117.                 },
118.                 PolicyDocument: {
119.                   Version: '2012-10-17',
120.                   Statement: [],
121.                 },
122.               },
123.             ],
124.           },
125.         };
126. 
127.         if (shouldWriteLogs) {
128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);
129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(
130.             {
131.               Effect: 'Allow',
132.               Action: ['logs:CreateLogStream'],
133.               Resource: [
134.                 {
135.                   'Fn::Sub':
136.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
137.                     `:log-group:${logGroupsPrefix}*:*`,
138.                 },
139.               ],
140.             },
141.             {
142.               Effect: 'Allow',
143.               Action: ['logs:PutLogEvents'],
144.               Resource: [
145.                 {
146.                   'Fn::Sub':
147.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
148.                     `:log-group:${logGroupsPrefix}*:*:*`,
149.                 },
150.               ],
151.             }
152.           );
153.         }
154.       }
155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
156.       iamRoleStatements.forEach(newStmt => {
157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
158.           Statement.push(newStmt);
159.         }
160.       });


File: lib/plugins/aws/deployFunction/index.js
Line number range: 71 - 116
Content:
71.         throw new this.serverless.classes.Error(errorMessage);
72.       });
73.   }
74. 
75.   normalizeArnRole(role) {
76.     if (typeof role === 'string') {
77.       if (role.indexOf(':') === -1) {
78.         const roleResource = this.serverless.service.resources.Resources[role];
79. 
80.         if (roleResource.Type !== 'AWS::IAM::Role') {
81.           throw new Error('Provided resource is not IAM Role.');
82.         }
83. 
84.         const roleProperties = roleResource.Properties;
85.         const compiledFullRoleName = `${roleProperties.Path || '/'}${roleProperties.RoleName}`;
86. 
87.         return this.provider
88.           .getAccountInfo()
89.           .then(
90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`
91.           );
92.       }
93. 
94.       return BbPromise.resolve(role);
95.     }
96. 
97.     return this.provider
98.       .request('IAM', 'getRole', {
99.         RoleName: role['Fn::GetAtt'][0],
100.       })
101.       .then(data => data.Arn);
102.   }
103. 
104.   callUpdateFunctionConfiguration(params) {
105.     return this.provider.request('Lambda', 'updateFunctionConfiguration', params).then(() => {
106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);
107.     });
108.   }
109. 
110.   updateFunctionConfiguration() {
111.     const functionObj = this.options.functionObj;
112.     const serviceObj = this.serverless.service.serviceObject;
113.     const providerObj = this.serverless.service.provider;
114.     const params = {
115.       FunctionName: functionObj.name,
116.     };


File: lib/plugins/aws/lib/naming.js
Line number range: 86 - 106
Content:
86.   // Role
87.   getRolePath() {
88.     return '/';
89.   },
90.   getRoleName() {
91.     return {
92.       'Fn::Join': [
93.         '-',
94.         [
95.           this.provider.serverless.service.service,
96.           this.provider.getStage(),
97.           { Ref: 'AWS::Region' },
98.           'lambdaRole',
99.         ],
100.       ],
101.     };
102.   },
103.   getRoleLogicalId() {
104.     return 'IamRoleLambdaExecution';
105.   },
106. 


File: lib/plugins/aws/lib/naming.js
Line number range: 107 - 122
Content:
107.   // Policy
108.   getPolicyName() {
109.     return {
110.       // TODO should probably have name ordered and altered as above - see AWS docs
111.       'Fn::Join': [
112.         '-',
113.         [
114.           this.provider.getStage(),
115.           // TODO is it a bug here in that the role is not specific to the region?
116.           this.provider.serverless.service.service,
117.           'lambda',
118.         ],
119.       ],
120.     };
121.   },
122. 


File: lib/plugins/aws/lib/naming.js
Line number range: 447 - 453
Content:
447.   // Custom Resources
448.   getCustomResourcesArtifactDirectoryName() {
449.     return 'custom-resources';
450.   },
451.   getCustomResourcesRoleLogicalId() {
452.     return 'IamRoleCustomResourcesLambdaExecution';
453.   },


File: lib/plugins/aws/lib/validate.js
Line number range: 1 - 62
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const chalk = require('chalk');
5. const userStats = require('../../../utils/userStats');
6. 
7. module.exports = {
8.   validate() {
9.     if (!this.serverless.config.servicePath) {
10.       const error = new this.serverless.classes.Error(
11.         'This command can only be run inside a service directory'
12.       );
13.       return BbPromise.reject(error);
14.     }
15. 
16.     this.options.stage = this.provider.getStage();
17.     this.options.region = this.provider.getRegion();
18. 
19.     if (
20.       !['logs', 'info', 'deploy', 'remove', 'rollback', 'metrics', 'invoke'].includes(
21.         this.serverless.processedInput.commands[0]
22.       ) ||
23.       this.serverless.processedInput.commands[1] === 'local'
24.     ) {
25.       return BbPromise.resolve();
26.     }
27.     const creds = Object.assign({}, this.provider.getCredentials());
28.     delete creds.region;
29.     delete creds.signatureVersion;
30. 
31.     if (
32.       Object.keys(creds).length === 0 &&
33.       !process.env.ECS_CONTAINER_METADATA_FILE &&
34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&
35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI
36.     ) {
37.       // first check if the EC2 Metadata Service has creds before throwing error
38.       const metadataService = new this.provider.sdk.MetadataService({
39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout
40.         maxRetries: 0, // retry 0 times
41.       });
42.       return new BbPromise((resolve, reject) =>
43.         metadataService.request('/', (err, data) => {
44.           return err ? reject(err) : resolve(data);
45.         })
46.       )
47.         .catch(() => null)
48.         .then(identity => {
49.           if (!identity) {
50.             const message = [
51.               'AWS provider credentials not found.',
52.               ' Learn how to set up AWS provider credentials',
53.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
54.             ].join('');
55.             userStats.track('user_awsCredentialsNotFound');
56.             throw new this.serverless.classes.Error(message);
57.           }
58.         });
59.     }
60.     return BbPromise.resolve();
61.   },
62. };


File: lib/plugins/aws/package/compile/events/cloudFront/index.js
Line number range: 200 - 260
Content:
200.                 o.TargetOriginId === behavior.TargetOriginId
201.             );
202. 
203.             if (!existingBehaviour) {
204.               behaviors.push(behavior);
205.             } else {
206.               behavior = extendDeep(existingBehaviour, behavior);
207.             }
208. 
209.             lambdaAtEdgeFunctions.push(
210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })
211.             );
212.           }
213.         });
214.       }
215.     });
216. 
217.     // sort that first is without PathPattern if available
218.     behaviors.sort((a, b) => {
219.       if (b.PathPattern) {
220.         return -1;
221.       }
222.       return 0;
223.     });
224. 
225.     if (lambdaAtEdgeFunctions.length) {
226.       if (this.provider.getRegion() !== 'us-east-1') {
227.         throw new ServerlessError(
228.           'CloudFront associated functions have to be deployed to the us-east-1 region.'
229.         );
230.       }
231. 
232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(
233.         (permissions, lambdaAtEdgeFunction) => {
234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(
235.             lambdaAtEdgeFunction.functionName
236.           );
237.           const invokePermission = {
238.             Type: 'AWS::Lambda::Permission',
239.             Properties: {
240.               FunctionName: {
241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,
242.               },
243.               Action: 'lambda:InvokeFunction',
244.               Principal: 'edgelambda.amazonaws.com',
245.               SourceArn: {
246.                 'Fn::Join': [
247.                   '',
248.                   [
249.                     '',
250.                     'arn:aws:cloudfront::',
251.                     { Ref: 'AWS::AccountId' },
252.                     ':distribution/',
253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },
254.                   ],
255.                 ],
256.               },
257.             },
258.           };
259.           return Object.assign(permissions, {
260.             [invokePermissionName]: invokePermission,


File: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js
Line number range: 20 - 364
Content:
20. class AwsCompileCognitoUserPoolEvents {
21.   constructor(serverless, options) {
22.     this.serverless = serverless;
23.     this.options = options;
24.     this.provider = this.serverless.getProvider('aws');
25. 
26.     this.hooks = {
27.       'package:compileEvents': () => {
28.         return BbPromise.bind(this)
29.           .then(this.newCognitoUserPools)
30.           .then(this.existingCognitoUserPools);
31.       },
32.       'after:package:finalize': this.mergeWithCustomResources.bind(this),
33.     };
34.   }
35. 
36.   newCognitoUserPools() {
37.     const { service } = this.serverless;
38.     service.getAllFunctions().forEach(functionName => {
39.       const functionObj = service.getFunction(functionName);
40.       if (functionObj.events) {
41.         functionObj.events.forEach(event => {
42.           if (event.cognitoUserPool) {
43.             // return immediately if it's an existing Cognito User Pool event since we treat them differently
44.             if (event.cognitoUserPool.existing) return null;
45. 
46.             const result = this.findUserPoolsAndFunctions();
47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
48.             const userPools = result.userPools;
49. 
50.             // Generate CloudFormation templates for Cognito User Pool changes
51.             _.forEach(userPools, poolName => {
52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {
53.                 poolName,
54.               });
55.               const userPoolCFResource = this.generateTemplateForPool(
56.                 poolName,
57.                 currentPoolTriggerFunctions
58.               );
59. 
60.               _.merge(
61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
62.                 userPoolCFResource
63.               );
64.             });
65. 
66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda
67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {
68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(
69.                 cognitoUserPoolTriggerFunction.poolName
70.               );
71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(
72.                 cognitoUserPoolTriggerFunction.functionName
73.               );
74. 
75.               const permissionTemplate = {
76.                 Type: 'AWS::Lambda::Permission',
77.                 Properties: {
78.                   FunctionName: {
79.                     'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
80.                   },
81.                   Action: 'lambda:InvokeFunction',
82.                   Principal: 'cognito-idp.amazonaws.com',
83.                   SourceArn: {
84.                     'Fn::GetAtt': [userPoolLogicalId, 'Arn'],
85.                   },
86.                 },
87.               };
88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(
89.                 cognitoUserPoolTriggerFunction.functionName,
90.                 cognitoUserPoolTriggerFunction.poolName,
91.                 cognitoUserPoolTriggerFunction.triggerSource
92.               );
93.               const permissionCFResource = {
94.                 [lambdaPermissionLogicalId]: permissionTemplate,
95.               };
96.               _.merge(
97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
98.                 permissionCFResource
99.               );
100.             });
101.           }
102.           return null;
103.         });
104.       }
105.       return null;
106.     });
107.   }
108. 
109.   existingCognitoUserPools() {
110.     const { service } = this.serverless;
111.     const { provider } = service;
112.     const { compiledCloudFormationTemplate } = provider;
113.     const { Resources } = compiledCloudFormationTemplate;
114.     const iamRoleStatements = [];
115. 
116.     // used to keep track of the custom resources created for each Cognito User Pool
117.     const poolResources = {};
118. 
119.     service.getAllFunctions().forEach(functionName => {
120.       let numEventsForFunc = 0;
121.       let currentPoolName = null;
122.       let funcUsesExistingCognitoUserPool = false;
123.       const functionObj = service.getFunction(functionName);
124.       const FunctionName = functionObj.name;
125. 
126.       if (functionObj.events) {
127.         functionObj.events.forEach(event => {
128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {
129.             numEventsForFunc++;
130.             const { pool, trigger } = event.cognitoUserPool;
131.             funcUsesExistingCognitoUserPool = true;
132. 
133.             if (!currentPoolName) {
134.               currentPoolName = pool;
135.             }
136.             if (pool !== currentPoolName) {
137.               const errorMessage = [
138.                 'Only one Cognito User Pool can be configured per function.',
139.                 ` In "${FunctionName}" you're attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,
140.               ].join('');
141.               throw new this.serverless.classes.Error(errorMessage);
142.             }
143. 
144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();
146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(
147.               functionName
148.             );
149. 
150.             // store how often the custom Cognito User Pool resource is used
151.             if (poolResources[pool]) {
152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);
153.             } else {
154.               Object.assign(poolResources, {
155.                 [pool]: [customPoolResourceLogicalId],
156.               });
157.             }
158. 
159.             let customCognitoUserPoolResource;
160.             if (numEventsForFunc === 1) {
161.               customCognitoUserPoolResource = {
162.                 [customPoolResourceLogicalId]: {
163.                   Type: 'Custom::CognitoUserPool',
164.                   Version: 1.0,
165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
166.                   Properties: {
167.                     ServiceToken: {
168.                       'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
169.                     },
170.                     FunctionName,
171.                     UserPoolName: pool,
172.                     UserPoolConfigs: [
173.                       {
174.                         Trigger: trigger,
175.                       },
176.                     ],
177.                   },
178.                 },
179.               };
180. 
181.               iamRoleStatements.push({
182.                 Effect: 'Allow',
183.                 Resource: '*',
184.                 Action: [
185.                   'cognito-idp:ListUserPools',
186.                   'cognito-idp:DescribeUserPool',
187.                   'cognito-idp:UpdateUserPool',
188.                 ],
189.               });
190.             } else {
191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({
192.                 Trigger: trigger,
193.               });
194.             }
195. 
196.             _.merge(Resources, customCognitoUserPoolResource);
197.           }
198.         });
199.       }
200. 
201.       if (funcUsesExistingCognitoUserPool) {
202.         iamRoleStatements.push({
203.           Effect: 'Allow',
204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,
205.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
206.         });
207.       }
208.     });
209. 
210.     // check if we need to add DependsOn clauses in case more than 1
211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)
212.     if (Object.keys(poolResources).length > 0) {
213.       Object.keys(poolResources).forEach(pool => {
214.         const resources = poolResources[pool];
215.         if (resources.length > 1) {
216.           resources.forEach((currResourceLogicalId, idx) => {
217.             if (idx > 0) {
218.               const prevResourceLogicalId = resources[idx - 1];
219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);
220.             }
221.           });
222.         }
223.       });
224.     }
225. 
226.     if (iamRoleStatements.length) {
227.       return addCustomResourceToService(this.provider, 'cognitoUserPool', iamRoleStatements);
228.     }
229. 
230.     return null;
231.   }
232. 
233.   findUserPoolsAndFunctions() {
234.     const userPools = [];
235.     const cognitoUserPoolTriggerFunctions = [];
236. 
237.     // Iterate through all functions declared in `serverless.yml`
238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {
239.       const functionObj = this.serverless.service.getFunction(functionName);
240. 
241.       if (functionObj.events) {
242.         _.forEach(functionObj.events, event => {
243.           if (event.cognitoUserPool) {
244.             // Check event definition for `cognitoUserPool` object
245.             if (typeof event.cognitoUserPool === 'object') {
246.               // Check `cognitoUserPool` object has required properties
247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {
248.                 throw new this.serverless.classes.Error(
249.                   [
250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,
251.                     'The correct syntax is an object with the "pool" and "trigger" properties.',
252.                     'Please check the docs for more info.',
253.                   ].join(' ')
254.                 );
255.               }
256. 
257.               // Check `cognitoUserPool` trigger is valid
258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {
259.                 throw new this.serverless.classes.Error(
260.                   [
261.                     'Cognito User Pool trigger source is invalid, must be one of:',
262.                     `${validTriggerSources.join(', ')}.`,
263.                     'Please check the docs for more info.',
264.                   ].join(' ')
265.                 );
266.               }
267. 
268.               // Save trigger functions so we can use them to generate
269.               // IAM permissions later
270.               cognitoUserPoolTriggerFunctions.push({
271.                 functionName,
272.                 poolName: event.cognitoUserPool.pool,
273.                 triggerSource: event.cognitoUserPool.trigger,
274.               });
275. 
276.               // Save user pools so we can use them to generate
277.               // CloudFormation resources later
278.               userPools.push(event.cognitoUserPool.pool);
279.             } else {
280.               throw new this.serverless.classes.Error(
281.                 [
282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,
283.                   'The correct syntax is an object with the "pool" and "trigger" properties.',
284.                   'Please check the docs for more info.',
285.                 ].join(' ')
286.               );
287.             }
288.           }
289.         });
290.       }
291.     });
292. 
293.     return { cognitoUserPoolTriggerFunctions, userPools };
294.   }
295. 
296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {
297.     const lambdaConfig = _.reduce(
298.       currentPoolTriggerFunctions,
299.       (result, value) => {
300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);
301. 
302.         // Return a new object to avoid lint errors
303.         return Object.assign({}, result, {
304.           [value.triggerSource]: {
305.             'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
306.           },
307.         });
308.       },
309.       {}
310.     );
311. 
312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);
313. 
314.     // Attach `DependsOn` for any relevant Lambdas
315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>
316.       this.provider.naming.getLambdaLogicalId(value.functionName)
317.     );
318. 
319.     return {
320.       [userPoolLogicalId]: {
321.         Type: 'AWS::Cognito::UserPool',
322.         Properties: {
323.           UserPoolName: poolName,
324.           LambdaConfig: lambdaConfig,
325.         },
326.         DependsOn,
327.       },
328.     };
329.   }
330. 
331.   mergeWithCustomResources() {
332.     const result = this.findUserPoolsAndFunctions();
333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
334.     const userPools = result.userPools;
335. 
336.     _.forEach(userPools, poolName => {
337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });
338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);
339. 
340.       // If overrides exist in `Resources`, merge them in
341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {
342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];
343.         const generatedUserPool = this.generateTemplateForPool(
344.           poolName,
345.           currentPoolTriggerFunctions
346.         )[userPoolLogicalId];
347. 
348.         // Merge `DependsOn` clauses
349.         const customUserPoolDependsOn = _.get(customUserPool, 'DependsOn', []);
350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);
351. 
352.         // Merge default and custom resources, and `DependsOn` clause
353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {
354.           DependsOn,
355.         });
356. 
357.         // Merge resource back into `Resources`
358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
359.           [userPoolLogicalId]: mergedTemplate,
360.         });
361.       }
362.     });
363.   }
364. }


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 21 - 23
Content:
21.     const iamRoleStatements = [];
22. 
23.     service.getAllFunctions().forEach(functionName => {


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 146 - 162
Content:
146.                 iamRoleStatements.push({
147.                   Effect: 'Allow',
148.                   Resource: eventBusResource,
149.                   Action: ['events:CreateEventBus', 'events:DeleteEventBus'],
150.                 });
151.               }
152. 
153.               iamRoleStatements.push({
154.                 Effect: 'Allow',
155.                 Resource: ruleResource,
156.                 Action: [
157.                   'events:PutRule',
158.                   'events:RemoveTargets',
159.                   'events:PutTargets',
160.                   'events:DeleteRule',
161.                 ],
162.               });


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 174 - 190
Content:
174.       if (funcUsesEventBridge) {
175.         iamRoleStatements.push({
176.           Effect: 'Allow',
177.           Resource: {
178.             'Fn::Join': [
179.               ':',
180.               [
181.                 'arn:aws:lambda',
182.                 { Ref: 'AWS::Region' },
183.                 { Ref: 'AWS::AccountId' },
184.                 'function',
185.                 FunctionName,
186.               ],
187.             ],
188.           },
189.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
190.         });


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 194 - 196
Content:
194.     if (iamRoleStatements.length) {
195.       return addCustomResourceToService(this.provider, 'eventBridge', iamRoleStatements);
196.     }


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 199 - 206
Content:
199.   existingS3Buckets() {
200.     const { service } = this.serverless;
201.     const { provider } = service;
202.     const { compiledCloudFormationTemplate } = provider;
203.     const { Resources } = compiledCloudFormationTemplate;
204.     const iamRoleStatements = [];
205. 
206.     // used to keep track of the custom resources created for each bucket


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 284 - 291
Content:
284.               iamRoleStatements.push({
285.                 Effect: 'Allow',
286.                 Resource: {
287.                   'Fn::Join': [':', ['arn', { Ref: 'AWS::Partition' }, 's3', '', '', bucket]],
288.                 },
289.                 Action: ['s3:PutBucketNotification', 's3:GetBucketNotification'],
290.               });
291.             } else {


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 303 - 321
Content:
303.       if (funcUsesExistingS3Bucket) {
304.         iamRoleStatements.push({
305.           Effect: 'Allow',
306.           Resource: {
307.             'Fn::Join': [
308.               ':',
309.               [
310.                 'arn',
311.                 { Ref: 'AWS::Partition' },
312.                 'lambda',
313.                 { Ref: 'AWS::Region' },
314.                 { Ref: 'AWS::AccountId' },
315.                 'function',
316.                 FunctionName,
317.               ],
318.             ],
319.           },
320.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
321.         });


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 341 - 343
Content:
341.     if (iamRoleStatements.length) {
342.       return addCustomResourceToService(this.provider, 's3', iamRoleStatements);
343.     }


File: lib/plugins/aws/package/compile/events/sqs/index.js
Line number range: 131 - 170
Content:
131.                   "FunctionName": {
132.                     "Fn::GetAtt": [
133.                       "${lambdaLogicalId}",
134.                       "Arn"
135.                     ]
136.                   },
137.                   "Enabled": "${Enabled}"
138.                 }
139.               }
140.             `;
141. 
142.             // add event source ARNs to PolicyDocument statements
143.             sqsStatement.Resource.push(EventSourceArn);
144. 
145.             const newSQSObject = {
146.               [queueLogicalId]: JSON.parse(sqsTemplate),
147.             };
148. 
149.             _.merge(
150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
151.               newSQSObject
152.             );
153.           }
154.         });
155. 
156.         // update the PolicyDocument statements (if default policy is used)
157.         if (
158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources
159.             .IamRoleLambdaExecution
160.         ) {
161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate
162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
163.           if (sqsStatement.Resource.length) {
164.             statement.push(sqsStatement);
165.           }
166.         }
167.       }
168.     });
169.   }
170. }


File: lib/plugins/aws/package/compile/events/stream/index.js
Line number range: 200 - 228
Content:
200.             const newStreamObject = {
201.               [streamLogicalId]: streamResource,
202.             };
203. 
204.             _.merge(
205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
206.               newStreamObject
207.             );
208.           }
209.         });
210. 
211.         // update the PolicyDocument statements (if default policy is used)
212.         if (
213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.             .IamRoleLambdaExecution
215.         ) {
216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate
217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
218.           if (dynamodbStreamStatement.Resource.length) {
219.             statement.push(dynamodbStreamStatement);
220.           }
221.           if (kinesisStreamStatement.Resource.length) {
222.             statement.push(kinesisStreamStatement);
223.           }
224.         }
225.       }
226.     });
227.   }
228. }


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 35 - 75
Content:
35.   compileRole(newFunction, role) {
36.     const compiledFunction = newFunction;
37.     const unnsupportedRoleError = new this.serverless.classes.Error(
38.       `Unsupported role provided: "${JSON.stringify(role)}"`
39.     );
40. 
41.     switch (typeof role) {
42.       case 'object':
43.         if ('Fn::GetAtt' in role) {
44.           // role is an "Fn::GetAtt" object
45.           compiledFunction.Properties.Role = role;
46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
47.             role['Fn::GetAtt'][0]
48.           );
49.         } else if ('Fn::ImportValue' in role) {
50.           // role is an "Fn::ImportValue" object
51.           compiledFunction.Properties.Role = role;
52.         } else {
53.           throw unnsupportedRoleError;
54.         }
55.         break;
56.       case 'string':
57.         if (role.startsWith('arn:aws')) {
58.           // role is a statically definied iam arn
59.           compiledFunction.Properties.Role = role;
60.         } else if (role === 'IamRoleLambdaExecution') {
61.           // role is the default role generated by the framework
62.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
64.             'IamRoleLambdaExecution'
65.           );
66.         } else {
67.           // role is a Logical Role Name
68.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);
70.         }
71.         break;
72.       default:
73.         throw unnsupportedRoleError;
74.     }
75.   }


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 216 - 240
Content:
216. 
217.           newFunction.Properties.DeadLetterConfig = {
218.             TargetArn: arn,
219.           };
220. 
221.           if (dlqType === 'sns') {
222.             stmt = {
223.               Effect: 'Allow',
224.               Action: ['sns:Publish'],
225.               Resource: [arn],
226.             };
227.           } else if (dlqType === 'sqs') {
228.             const errorMessage = [
229.               'onError currently only supports SNS topic arns due to a',
230.               ' race condition when using SQS queue arns and updating the IAM role.',
231.               ' Please check the docs for more info.',
232.             ].join('');
233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
234.           }
235. 
236.           // update the PolicyDocument statements (if default policy is used)
237.           if (iamRoleLambdaExecution) {
238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);
239.           }
240.         } else {


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 271 - 289
Content:
271.           const iamRoleLambdaExecution = this.serverless.service.provider
272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
273. 
274.           newFunction.Properties.KmsKeyArn = arn;
275. 
276.           const stmt = {
277.             Effect: 'Allow',
278.             Action: ['kms:Decrypt'],
279.             Resource: [arn],
280.           };
281. 
282.           // update the PolicyDocument statements (if default policy is used)
283.           if (iamRoleLambdaExecution) {
284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
286.               [stmt],
287.               _.isEqual
288.             );
289.           }


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 319 - 333
Content:
319.         const stmt = {
320.           Effect: 'Allow',
321.           Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],
322.           Resource: ['*'],
323.         };
324. 
325.         // update the PolicyDocument statements (if default policy is used)
326.         if (iamRoleLambdaExecution) {
327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
329.             [stmt],
330.             _.isEqual
331.           );
332.         }
333.       } else {


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const AWS = require('aws-sdk');
4. const BbPromise = require('bluebird');
5. const HttpsProxyAgent = require('https-proxy-agent');
6. const url = require('url');
7. const chalk = require('chalk');
8. const _ = require('lodash');
9. const userStats = require('../../../utils/userStats');
10. const naming = require('../lib/naming.js');
11. const https = require('https');
12. const fs = require('fs');
13. const objectHash = require('object-hash');
14. const PromiseQueue = require('promise-queue');
15. const getS3EndpointForRegion = require('../utils/getS3EndpointForRegion');
16. const readline = require('readline');
17. 
18. const constants = {
19.   providerName: 'aws',
20. };
21. 
22. PromiseQueue.configure(BbPromise.Promise);
23. 
24. const impl = {
25.   /**
26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid
27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for
28.    * whak-a-mole!
29.    * @param credentials The credentials to test for validity
30.    * @return {boolean} Whether the given credentials were valid
31.    */
32.   validCredentials: credentials => {
33.     let result = false;
34.     if (credentials) {
35.       if (
36.         // valid credentials loaded
37.         (credentials.accessKeyId &&
38.           credentials.accessKeyId !== 'undefined' &&
39.           credentials.secretAccessKey &&
40.           credentials.secretAccessKey !== 'undefined') ||
41.         // a role to assume has been successfully loaded, the associated STS request has been
42.         // sent, and the temporary credentials will be asynchronously delivered.
43.         credentials.roleArn
44.       ) {
45.         result = true;
46.       }
47.     }
48.     return result;
49.   },
50.   /**
51.    * Add credentials, if present, to the given results
52.    * @param results The results to add the given credentials to if they are valid
53.    * @param credentials The credentials to validate and add to the results if valid
54.    */
55.   addCredentials: (results, credentials) => {
56.     if (impl.validCredentials(credentials)) {
57.       results.credentials = credentials; // eslint-disable-line no-param-reassign
58.     }
59.   },
60.   /**
61.    * Add credentials, if present, from the environment
62.    * @param results The results to add environment credentials to
63.    * @param prefix The environment variable prefix to use in extracting credentials
64.    */
65.   addEnvironmentCredentials: (results, prefix) => {
66.     if (prefix) {
67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);
68.       impl.addCredentials(results, environmentCredentials);
69.     }
70.   },
71.   /**
72.    * Add credentials from a profile, if the profile and credentials for it exists
73.    * @param results The results to add profile credentials to
74.    * @param profile The profile to load credentials from
75.    */
76.   addProfileCredentials: (results, profile) => {
77.     if (profile) {
78.       const params = { profile };
79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {
80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;
81.       }
82. 
83.       // Setup a MFA callback for asking the code from the user.
84.       params.tokenCodeFn = (mfaSerial, callback) => {
85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {
87.           rl.close();
88.           callback(null, answer);
89.         });
90.       };
91. 
92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);
93.       if (
94.         !(
95.           profileCredentials.accessKeyId ||
96.           profileCredentials.sessionToken ||
97.           profileCredentials.roleArn
98.         )
99.       ) {
100.         throw new Error(`Profile ${profile} does not exist`);
101.       }
102. 
103.       impl.addCredentials(results, profileCredentials);
104.     }
105.   },
106.   /**
107.    * Add credentials, if present, from a profile that is specified within the environment
108.    * @param results The prefix of the profile's declaration in the environment
109.    * @param prefix The prefix for the environment variable
110.    */
111.   addEnvironmentProfile: (results, prefix) => {
112.     if (prefix) {
113.       const profile = process.env[`${prefix}_PROFILE`];
114.       impl.addProfileCredentials(results, profile);
115.     }
116.   },
117. };
118. 
119. class AwsProvider {
120.   static getProviderName() {
121.     return constants.providerName;
122.   }
123. 
124.   constructor(serverless, options) {
125.     this.naming = { provider: this };
126.     this.options = options;
127.     this.provider = this; // only load plugin in an AWS service context
128.     this.serverless = serverless;
129.     this.sdk = AWS;
130.     this.serverless.setProvider(constants.providerName, this);
131.     if (this.serverless.service.provider.name === 'aws') {
132.       this.serverless.service.provider.region = this.getRegion();
133.     }
134.     this.requestCache = {};
135.     this.requestQueue = new PromiseQueue(2, Infinity);
136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).
137.     this.cachedCredentials = null;
138. 
139.     Object.assign(this.naming, naming);
140. 
141.     // Activate AWS SDK loggin
142.     if (process.env.SLS_DEBUG) {
143.       AWS.config.logger = this.serverless.cli;
144.     }
145. 
146.     // Use HTTPS Proxy (Optional)
147.     const proxy =
148.       process.env.proxy ||
149.       process.env.HTTP_PROXY ||
150.       process.env.http_proxy ||
151.       process.env.HTTPS_PROXY ||
152.       process.env.https_proxy;
153. 
154.     const proxyOptions = {};
155.     if (proxy) {
156.       Object.assign(proxyOptions, url.parse(proxy));
157.     }
158. 
159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;
160. 
161.     let caCerts = [];
162. 
163.     if (ca) {
164.       // Can be a single certificate or multiple, comma separated.
165.       const caArr = ca.split(',');
166.       // Replace the newline -- https://stackoverflow.com/questions/30400341
167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\n/g, '\n')));
168.     }
169. 
170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;
171. 
172.     if (cafile) {
173.       // Can be a single certificate file path or multiple paths, comma separated.
174.       const caPathArr = cafile.split(',');
175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));
176.     }
177. 
178.     if (caCerts.length > 0) {
179.       Object.assign(proxyOptions, {
180.         rejectUnauthorized: true,
181.         ca: caCerts,
182.       });
183.     }
184. 
185.     // Passes also certifications
186.     if (proxy) {
187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);
188.     } else if (proxyOptions.ca) {
189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html
190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);
191.     }
192. 
193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)
194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;
195.     if (timeout) {
196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);
197.     }
198. 
199.     // Support deploymentBucket configuration as an object
200.     const provider = this.serverless.service.provider;
201.     if (provider && provider.deploymentBucket) {
202.       if (_.isObject(provider.deploymentBucket)) {
203.         // store the object in a new variable so that it can be reused later on
204.         provider.deploymentBucketObject = provider.deploymentBucket;
205.         if (provider.deploymentBucket.name) {
206.           // (re)set the value of the deploymentBucket property to the name (which is a string)
207.           provider.deploymentBucket = provider.deploymentBucket.name;
208.         } else {
209.           provider.deploymentBucket = null;
210.         }
211.       }
212.     }
213.   }
214. 
215.   /**
216.    * Execute an AWS request by calling the AWS SDK
217.    * @param {string} service - Service name
218.    * @param {string} method - Method name
219.    * @param {Object} params - Parameters
220.    * @param {Object} [options] - Options to modify the request behavior
221.    * @prop [options.useCache] - Utilize cache to retrieve results
222.    * @prop [options.region] - Specify when to request to different region
223.    */
224.   request(service, method, params, options) {
225.     const that = this;
226.     const credentials = Object.assign({}, that.getCredentials());
227.     // Make sure options is an object (honors wrong calls of request)
228.     const requestOptions = _.isObject(options) ? options : {};
229.     const shouldCache = _.get(requestOptions, 'useCache', false);
230.     const paramsWithRegion = _.merge({}, params, {
231.       region: _.get(options, 'region'),
232.     });
233.     const paramsHash = objectHash.sha1(paramsWithRegion);
234.     const MAX_TRIES = 4;
235.     const persistentRequest = f =>
236.       new BbPromise((resolve, reject) => {
237.         const doCall = numTry => {
238.           f()
239.             // We're resembling if/else logic, therefore single `then` instead of `then`/`catch` pair
240.             .then(resolve, e => {
241.               if (
242.                 numTry < MAX_TRIES &&
243.                 e.statusCode !== 403 && // Invalid credentials
244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)
245.               ) {
246.                 that.serverless.cli.log(
247.                   _.join(
248.                     [
249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,
250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,
251.                     ],
252.                     ' '
253.                   )
254.                 );
255.                 setTimeout(doCall, 5000, numTry + 1);
256.               } else {
257.                 reject(e);
258.               }
259.             });
260.         };
261.         return doCall(0);
262.       });
263. 
264.     // Emit a warning for misuses of the old signature including stage and region
265.     // TODO: Determine calling module and log that
266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {
267.       this.serverless.cli.log('WARNING: Inappropriate call of provider.request()');
268.     }
269. 
270.     // Support S3 Transfer Acceleration
271.     if (this.canUseS3TransferAcceleration(service, method)) {
272.       this.enableS3TransferAcceleration(credentials);
273.     }
274. 
275.     if (shouldCache) {
276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);
277.       if (cachedRequest) {
278.         return BbPromise.resolve(cachedRequest);
279.       }
280.     }
281. 
282.     const request = this.requestQueue.add(() =>
283.       persistentRequest(() => {
284.         if (options && !_.isUndefined(options.region)) {
285.           credentials.region = options.region;
286.         }
287.         const awsService = new that.sdk[service](credentials);
288.         const req = awsService[method](params);
289. 
290.         // TODO: Add listeners, put Debug statments here...
291.         // req.on('send', function (r) {console.log(r)});
292. 
293.         const promise = req.promise
294.           ? req.promise()
295.           : BbPromise.fromCallback(cb => {
296.               req.send(cb);
297.             });
298.         return promise.catch(err => {
299.           let message = err.message !== null ? err.message : err.code;
300.           if (err.message === 'Missing credentials in config') {
301.             const errorMessage = [
302.               'AWS provider credentials not found.',
303.               ' Learn how to set up AWS provider credentials',
304.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
305.             ].join('');
306.             message = errorMessage;
307.             userStats.track('user_awsCredentialsNotFound');
308.             // We do not want to trigger the retry mechanism for credential errors
309.             return BbPromise.reject(
310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
311.                 providerError: _.assign({}, err, { retryable: false }),
312.               })
313.             );
314.           }
315. 
316.           return BbPromise.reject(
317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
318.               providerError: err,
319.             })
320.           );
321.         });
322.       }).then(data => {
323.         const result = BbPromise.resolve(data);
324.         if (shouldCache) {
325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);
326.         }
327.         return result;
328.       })
329.     );
330. 
331.     if (shouldCache) {
332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);
333.     }
334. 
335.     return request;
336.   }
337. 
338.   /**
339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the
340.    * well known environment variables
341.    * @returns {{region: *}}
342.    */
343.   getCredentials() {
344.     if (this.cachedCredentials) {
345.       // We have already created the credentials object once, so return it.
346.       return this.cachedCredentials;
347.     }
348.     const result = {};
349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;
350. 
351.     // add specified credentials, overriding with more specific declarations
352.     try {
353.       impl.addProfileCredentials(result, 'default');
354.     } catch (err) {
355.       if (err.message !== 'Profile default does not exist') {
356.         throw err;
357.       }
358.     }
359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds
360.     if (this.serverless.service.provider.profile && !this.options['aws-profile']) {
361.       // config profile
362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);
363.     }
364.     impl.addEnvironmentCredentials(result, 'AWS'); // creds for all stages
365.     impl.addEnvironmentProfile(result, 'AWS');
366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds
367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);
368.     if (this.options['aws-profile']) {
369.       impl.addProfileCredentials(result, this.options['aws-profile']); // CLI option profile
370.     }
371.     result.region = this.getRegion();
372. 
373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;
374.     if (
375.       deploymentBucketObject &&
376.       deploymentBucketObject.serverSideEncryption &&
377.       deploymentBucketObject.serverSideEncryption === 'aws:kms'
378.     ) {
379.       result.signatureVersion = 'v4';
380.     }
381. 
382.     // Store the credentials to avoid creating them again (messes up MFA).
383.     this.cachedCredentials = result;
384.     return result;
385.   }
386. 
387.   canUseS3TransferAcceleration(service, method) {
388.     // TODO enable more S3 APIs?
389.     return (
390.       service === 'S3' &&
391.       ['upload', 'putObject'].indexOf(method) !== -1 &&
392.       this.isS3TransferAccelerationEnabled()
393.     );
394.   }
395. 
396.   // This function will be used to block the addition of transfer acceleration options
397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)
398.   isS3TransferAccelerationSupported() {
399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)
400.     // since those regions do not yet support it
401.     const endpoint = getS3EndpointForRegion(this.getRegion());
402.     return endpoint === 's3.amazonaws.com';
403.   }
404. 
405.   isS3TransferAccelerationEnabled() {
406.     return !!this.options['aws-s3-accelerate'];
407.   }
408. 
409.   isS3TransferAccelerationDisabled() {
410.     return !!this.options['no-aws-s3-accelerate'];
411.   }
412. 
413.   disableTransferAccelerationForCurrentDeploy() {
414.     delete this.options['aws-s3-accelerate'];
415.   }
416. 
417.   enableS3TransferAcceleration(credentials) {
418.     this.serverless.cli.log('Using S3 Transfer Acceleration Endpoint...');
419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign
420.   }
421. 
422.   getValues(source, paths) {
423.     return paths.map(path => ({
424.       path,
425.       value: _.get(source, path.join('.')),
426.     }));
427.   }
428.   firstValue(values) {
429.     return values.reduce((result, current) => {
430.       return result.value ? result : current;
431.     }, {});
432.   }
433. 
434.   getRegionSourceValue() {
435.     const values = this.getValues(this, [
436.       ['options', 'region'],
437.       ['serverless', 'config', 'region'],
438.       ['serverless', 'service', 'provider', 'region'],
439.     ]);
440.     return this.firstValue(values);
441.   }
442.   getRegion() {
443.     const defaultRegion = 'us-east-1';
444.     const regionSourceValue = this.getRegionSourceValue();
445.     return regionSourceValue.value || defaultRegion;
446.   }
447. 
448.   getProfileSourceValue() {
449.     const values = this.getValues(this, [
450.       ['options', 'aws-profile'],
451.       ['options', 'profile'],
452.       ['serverless', 'config', 'profile'],
453.       ['serverless', 'service', 'provider', 'profile'],
454.     ]);
455.     const firstVal = this.firstValue(values);
456.     return firstVal ? firstVal.value : null;
457.   }
458.   getProfile() {
459.     return this.getProfileSourceValue();
460.   }
461. 
462.   getServerlessDeploymentBucketName() {
463.     if (this.serverless.service.provider.deploymentBucket) {
464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);
465.     }
466.     return this.request('CloudFormation', 'describeStackResource', {
467.       StackName: this.naming.getStackName(),
468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),
469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);
470.   }
471. 
472.   getDeploymentPrefix() {
473.     return this.serverless.service.provider.deploymentPrefix || 'serverless';
474.   }
475. 
476.   getLogRetentionInDays() {
477.     if (!_.has(this.serverless.service.provider, 'logRetentionInDays')) {
478.       return null;
479.     }
480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;
481.     const retentionInDays = parseInt(rawRetentionInDays, 10);
482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {
483.       return retentionInDays;
484.     }
485. 
486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;
487.     throw new this.serverless.classes.Error(errorMessage);
488.   }
489. 
490.   getStageSourceValue() {
491.     const values = this.getValues(this, [
492.       ['options', 'stage'],
493.       ['serverless', 'config', 'stage'],
494.       ['serverless', 'service', 'provider', 'stage'],
495.     ]);
496.     return this.firstValue(values);
497.   }
498.   getStage() {
499.     const defaultStage = 'dev';
500.     const stageSourceValue = this.getStageSourceValue();


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 500 - 1000
Content:
500.     const stageSourceValue = this.getStageSourceValue();
501.     return stageSourceValue.value || defaultStage;
502.   }
503. 
504.   getAccountId() {
505.     return this.getAccountInfo().then(result => result.accountId);
506.   }
507. 
508.   getAccountInfo() {
509.     return this.request('STS', 'getCallerIdentity', {}).then(result => {
510.       const arn = result.Arn;
511.       const accountId = result.Account;
512.       const partition = _.nth(_.split(arn, ':'), 1); // ex: arn:aws:iam:acctId:user/xyz
513.       return {
514.         accountId,
515.         partition,
516.         arn: result.Arn,
517.         userId: result.UserId,
518.       };
519.     });
520.   }
521. 
522.   /**
523.    * Get API Gateway Rest API ID from serverless config
524.    */
525.   getApiGatewayRestApiId() {
526.     if (
527.       this.serverless.service.provider.apiGateway &&
528.       this.serverless.service.provider.apiGateway.restApiId
529.     ) {
530.       return this.serverless.service.provider.apiGateway.restApiId;
531.     }
532. 
533.     return { Ref: this.naming.getRestApiLogicalId() };
534.   }
535. 
536.   getApiGatewayDescription() {
537.     if (
538.       this.serverless.service.provider.apiGateway &&
539.       this.serverless.service.provider.apiGateway.description
540.     ) {
541.       return this.serverless.service.provider.apiGateway.description;
542.     }
543.     return undefined;
544.   }
545. 
546.   getMethodArn(accountId, apiId, method, pathParam) {
547.     const region = this.getRegion();
548.     let path = pathParam;
549.     if (pathParam.startsWith('/')) {
550.       path = pathParam.replace(/^\/+/g, '');
551.     }
552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;
553.   }
554. 
555.   /**
556.    * Get Rest API Root Resource ID from serverless config
557.    */
558.   getApiGatewayRestApiRootResourceId() {
559.     if (
560.       this.serverless.service.provider.apiGateway &&
561.       this.serverless.service.provider.apiGateway.restApiRootResourceId
562.     ) {
563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;
564.     }
565.     return { 'Fn::GetAtt': [this.naming.getRestApiLogicalId(), 'RootResourceId'] };
566.   }
567. 
568.   /**
569.    * Get Rest API Predefined Resources from serverless config
570.    */
571.   getApiGatewayPredefinedResources() {
572.     if (
573.       !this.serverless.service.provider.apiGateway ||
574.       !this.serverless.service.provider.apiGateway.restApiResources
575.     ) {
576.       return [];
577.     }
578. 
579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {
580.       return this.serverless.service.provider.apiGateway.restApiResources;
581.     }
582. 
583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== 'object') {
584.       throw new Error('REST API resource must be an array of object');
585.     }
586. 
587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({
588.       path: key,
589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],
590.     }));
591.   }
592. 
593.   /**
594.    * Get API Gateway websocket API ID from serverless config
595.    */
596.   getApiGatewayWebsocketApiId() {
597.     if (
598.       this.serverless.service.provider.apiGateway &&
599.       this.serverless.service.provider.apiGateway.websocketApiId
600.     ) {
601.       return this.serverless.service.provider.apiGateway.websocketApiId;
602.     }
603. 
604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };
605.   }
606. 
607.   getStackResources(next, resourcesParam) {
608.     let resources = resourcesParam;
609.     const params = {
610.       StackName: this.naming.getStackName(),
611.     };
612.     if (!resources) resources = [];
613.     if (next) params.NextToken = next;
614. 
615.     return this.request('CloudFormation', 'listStackResources', params).then(res => {
616.       const allResources = resources.concat(res.StackResourceSummaries);
617.       if (!res.NextToken) {
618.         return allResources;
619.       }
620.       return this.getStackResources(res.NextToken, allResources);
621.     });
622.   }
623. }
624. 
625. module.exports = AwsProvider;

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 21:16:25,962 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The feature involves supporting NotAction/NotResource in iamRoleStatements. Current context shows various places where iamRoleStatements are appended for custom resources and events, but lacks the core logic that constructs the default IAM role (IamRoleLambdaExecution) and processes provider.iamRoleStatements from serverless.yml. The build failure likely originates in that compilation and validation code. We also need the IAM guide documentation to understand intended schema and conventions.' query='Please provide the contents of lib/plugins/aws/package/index.js and any module that creates the IamRoleLambdaExecution resource and processes provider.iamRoleStatements.' extra_requirements='If the role creation is in a different file, include its path and code; also share docs/providers/aws/guide/iam.md.' purpose='I need to locate where iamRoleStatements are validated/applied and understand the expected policy schema to implement support for NotAction/NotResource.'
2025-11-13 21:16:25,964 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the contents of lib/plugins/aws/package/index.js and any module that creates the IamRoleLambdaExecution resource and processes provider.iamRoleStatements.
2025-11-13 21:16:27,027 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 21:16:27,027 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 21:16:27,027 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 21:16:27,027 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 21:16:27,028 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 21:16:27,030 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 21:16:27,030 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the contents of lib/plugins/aws/package/index.js and any module that creates the IamRoleLambdaExecution resource and processes provider.iamRoleStatements.
Extra requirements: If the role creation is in a different file, include its path and code; also share docs/providers/aws/guide/iam.md.
Purpose: I need to locate where iamRoleStatements are validated/applied and understand the expected policy schema to implement support for NotAction/NotResource.
2025-11-13 21:16:35,388 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_C2Wm6lntmJwENYr4eFVRy2In', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 610, 'prompt_tokens': 2264, 'total_tokens': 2874, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--53b5a0b1-1e26-42bb-b957-0b99d7ceef13-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/index.js'}, 'id': 'call_C2Wm6lntmJwENYr4eFVRy2In', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2264, 'output_tokens': 610, 'total_tokens': 2874, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 21:16:36,395 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ah1YBehcVBMbAFJ0BInPOPMT', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 2340, 'total_tokens': 2369, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--feb417c6-9a9f-414d-a186-4380185edd7e-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/index.js'}, 'id': 'call_ah1YBehcVBMbAFJ0BInPOPMT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2340, 'output_tokens': 29, 'total_tokens': 2369, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:16:41,160 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VNs1PUIOW4WPfJ2gcMlcjgkG', 'function': {'arguments': '{"basename":"mergeIamTemplates.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 223, 'prompt_tokens': 3357, 'total_tokens': 3580, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cdbdc652-0e0a-4985-abcd-94d436c2fa72-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'mergeIamTemplates.js'}, 'id': 'call_VNs1PUIOW4WPfJ2gcMlcjgkG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3357, 'output_tokens': 223, 'total_tokens': 3580, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 21:16:42,490 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_FpnsfVn5z8W1lEqo6obJbR4E', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 3436, 'total_tokens': 3469, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--838aa772-55ce-4147-b39e-b945decff5e9-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_FpnsfVn5z8W1lEqo6obJbR4E', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3436, 'output_tokens': 33, 'total_tokens': 3469, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:16:48,277 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_2AuSgDDYPgkIoyyoRqbQah2h', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 292, 'prompt_tokens': 6054, 'total_tokens': 6346, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b5959e45-60e6-47af-946c-a9f5c86d98e3-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_2AuSgDDYPgkIoyyoRqbQah2h', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6054, 'output_tokens': 292, 'total_tokens': 6346, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 21:16:49,545 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_cW5ItrruzPdkTxanHGqTEq04', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 6134, 'total_tokens': 6165, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 6016}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--05ce3e5b-8300-4659-8047-207337498bf3-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_cW5ItrruzPdkTxanHGqTEq04', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6134, 'output_tokens': 31, 'total_tokens': 6165, 'input_token_details': {'audio': 0, 'cache_read': 6016}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:17:03,288 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I located and retrieved lib/plugins/aws/package/index.js. I also found and provided lib/plugins/aws/package/lib/mergeIamTemplates.js, which is the module that creates the IamRoleLambdaExecution resource (via the iam-role-lambda-execution-template.json) and validates/applies provider.iamRoleStatements (requiring Effect, Action, and Resource) into the generated policy. Finally, I fetched docs/providers/aws/guide/iam.md to show the documented schema and usage for iamRoleStatements and iamManagedPolicies. This should give you the exact validation logic and where the statements are merged so you can assess adding NotAction/NotResource support.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1164, 'prompt_tokens': 9937, 'total_tokens': 11101, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1024, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--8ba8d002-330a-4730-b078-70edb51c8289-0' usage_metadata={'input_tokens': 9937, 'output_tokens': 1164, 'total_tokens': 11101, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 1024}}
2025-11-13 21:17:03,292 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the contents of lib/plugins/aws/package/index.js and any module that creates the IamRoleLambdaExecution resource and processes provider.iamRoleStatements.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If the role creation is in a different file, include its path and code; also share docs/providers/aws/guide/iam.md.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need to locate where iamRoleStatements are validated/applied and understand the expected policy schema to implement support for NotAction/NotResource.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: docs/providers/aws/guide/iam.md
Line number range: 1 - 338
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Guide - IAM
3. description: How to manage your AWS Lambda functions and their AWS infrastructure resources easily with the Serverless Framework.
4. menuText: IAM
5. menuOrder: 13
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/guide/iam)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # IAM
16. 
17. Every AWS Lambda function needs permission to interact with other AWS infrastructure resources within your account. These permissions are set via an AWS IAM Role which the Serverless Framework automatically creates for each Serverless Service, and is shared by all of your Functions. The Framework allows you to modify this Role or create Function-specific Roles, easily.
18. 
19. ## The Default IAM Role
20. 
21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
22. 
23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
24. 
25. ```yml
26. service: new-service
27. 
28. provider:
29.   name: aws
30.   iamRoleStatements:
31.     - Effect: 'Allow'
32.       Action:
33.         - 's3:ListBucket'
34.       Resource:
35.         Fn::Join:
36.           - ''
37.           - - 'arn:aws:s3:::'
38.             - Ref: ServerlessDeploymentBucket
39.     - Effect: 'Allow'
40.       Action:
41.         - 's3:PutObject'
42.       Resource:
43.         Fn::Join:
44.           - ''
45.           - - 'arn:aws:s3:::'
46.             - Ref: ServerlessDeploymentBucket
47.             - '/*'
48. ```
49. 
50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
51. 
52. ```yml
53. service: new-service
54. 
55. provider:
56.   name: aws
57.   iamManagedPolicies:
58.     - 'some:aws:arn:xxx:*:*'
59.     - 'someOther:aws:arn:xxx:*:*'
60.     - { 'Fn::Join': [':', ['arn:aws:iam:', { Ref: 'AWSAccountId' }, 'some/path']] }
61. ```
62. 
63. ## Custom IAM Roles
64. 
65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.
66. 
67. That means that `iamRoleStatements` you've defined on the `provider` level won't be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.
68. 
69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.
70. 
71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.
72. 
73. The `role` attribute can have a value of the logical name of the role, the ARN of the role, or an object that will resolve in the ARN of the role. The declaration `{ function: { role: 'myRole' } }` will result in `{ 'Fn::GetAtt': ['myRole', 'Arn'] }`. You can of course just declare an ARN like so `{ function: { role: 'an:aws:arn:xxx:*:*' } }`. This use case is primarily for those who must create their roles and / or policies via a means outside of Serverless.
74. 
75. Here are some examples of using these capabilities to specify Lambda roles.
76. 
77. ### One Custom IAM Role For All Functions
78. 
79. ```yml
80. service: new-service
81. 
82. provider:
83.   name: aws
84.   # declare one of the following...
85.   role: myDefaultRole                                                  # must validly reference a role defined in the service
86.   role: arn:aws:iam::0123456789:role//my/default/path/roleInMyAccount  # must validly reference a role defined in your account
87.   role:                                                                # must validly resolve to the ARN of a role you have the rights to use
88.     Fn::GetAtt:
89.       - myRole
90.       - Arn
91. 
92. functions:
93.   func0: # will assume 'myDefaultRole'
94.     ... # does not define role
95.   func1: # will assume 'myDefaultRole'
96.     ... # does not define role
97. 
98. resources:
99.   Resources:
100.     myDefaultRole:
101.       Type: AWS::IAM::Role
102.       Properties:
103.         Path: /my/default/path/
104.         RoleName: MyDefaultRole # required if you want to use 'serverless deploy --function' later on
105.         AssumeRolePolicyDocument:
106.           Version: '2012-10-17'
107.           Statement:
108.             - Effect: Allow
109.               Principal:
110.                 Service:
111.                   - lambda.amazonaws.com
112.               Action: sts:AssumeRole
113.         # note that these rights are needed if you want your function to be able to communicate with resources within your vpc
114.         ManagedPolicyArns:
115.           - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
116.         Policies:
117.           - PolicyName: myPolicyName
118.             PolicyDocument:
119.               Version: '2012-10-17'
120.               Statement:
121.                 - Effect: Allow # note that these rights are given in the default policy and are required if you want logs out of your lambda(s)
122.                   Action:
123.                     - logs:CreateLogGroup
124.                     - logs:CreateLogStream
125.                     - logs:PutLogEvents
126.                   Resource:
127.                     - 'Fn::Join':
128.                       - ':'
129.                       -
130.                         - 'arn:aws:logs'
131.                         - Ref: 'AWS::Region'
132.                         - Ref: 'AWS::AccountId'
133.                         - 'log-group:/aws/lambda/*:*:*'
134.                 -  Effect: "Allow"
135.                    Action:
136.                      - "s3:PutObject"
137.                    Resource:
138.                      Fn::Join:
139.                        - ""
140.                        - - "arn:aws:s3:::"
141.                          - "Ref" : "ServerlessDeploymentBucket"
142. ```
143. 
144. ### Custom IAM Roles For Each Function
145. 
146. ```yml
147. service: new-service
148. 
149. provider:
150.   name: aws
151.   ... # does not define role
152. 
153. functions:
154.   func0:
155.     role: myCustRole0
156.     ...
157.   func1:
158.     role: myCustRole1
159.     ...
160. 
161. resources:
162.   Resources:
163.     myCustRole0:
164.       Type: AWS::IAM::Role
165.       Properties:
166.         Path: /my/cust/path/
167.         RoleName: MyCustRole0
168.         AssumeRolePolicyDocument:
169.           Version: '2012-10-17'
170.           Statement:
171.             - Effect: Allow
172.               Principal:
173.                 Service:
174.                   - lambda.amazonaws.com
175.               Action: sts:AssumeRole
176.         Policies:
177.           - PolicyName: myPolicyName
178.             PolicyDocument:
179.               Version: '2012-10-17'
180.               Statement:
181.                 - Effect: Allow
182.                   Action:
183.                     - logs:CreateLogGroup
184.                     - logs:CreateLogStream
185.                     - logs:PutLogEvents
186.                   Resource:
187.                     - 'Fn::Join':
188.                       - ':'
189.                       -
190.                         - 'arn:aws:logs'
191.                         - Ref: 'AWS::Region'
192.                         - Ref: 'AWS::AccountId'
193.                         - 'log-group:/aws/lambda/*:*:*'
194.                 - Effect: Allow
195.                   Action:
196.                     - ec2:CreateNetworkInterface
197.                     - ec2:DescribeNetworkInterfaces
198.                     - ec2:DetachNetworkInterface
199.                     - ec2:DeleteNetworkInterface
200.                   Resource: "*"
201.     myCustRole1:
202.       Type: AWS::IAM::Role
203.       Properties:
204.         Path: /my/cust/path/
205.         RoleName: MyCustRole1
206.         AssumeRolePolicyDocument:
207.           Version: '2012-10-17'
208.           Statement:
209.             - Effect: Allow
210.               Principal:
211.                 Service:
212.                   - lambda.amazonaws.com
213.               Action: sts:AssumeRole
214.         Policies:
215.           - PolicyName: myPolicyName
216.             PolicyDocument:
217.               Version: '2012-10-17'
218.               Statement:
219.                 - Effect: Allow # note that these rights are given in the default policy and are required if you want logs out of your lambda(s)
220.                   Action:
221.                     - logs:CreateLogGroup
222.                     - logs:CreateLogStream
223.                     - logs:PutLogEvents
224.                   Resource:
225.                     - 'Fn::Join':
226.                       - ':'
227.                       -
228.                         - 'arn:aws:logs'
229.                         - Ref: 'AWS::Region'
230.                         - Ref: 'AWS::AccountId'
231.                         - 'log-group:/aws/lambda/*:*:*'
232.                 -  Effect: "Allow"
233.                    Action:
234.                      - "s3:PutObject"
235.                    Resource:
236.                      Fn::Join:
237.                        - ""
238.                        - - "arn:aws:s3:::"
239.                          - "Ref" : "ServerlessDeploymentBucket"
240. ```
241. 
242. ### A Custom Default Role & Custom Function Roles
243. 
244. ```yml
245. service: new-service
246. 
247. provider:
248.   name: aws
249.   role: myDefaultRole
250. 
251. functions:
252.   func0:
253.     role: myCustRole0
254.     ...
255.   func1:
256.     ... # does not define role
257. 
258. resources:
259.   Resources:
260.     myDefaultRole:
261.       Type: AWS::IAM::Role
262.       Properties:
263.         Path: /my/default/path/
264.         RoleName: MyDefaultRole
265.         AssumeRolePolicyDocument:
266.           Version: '2012-10-17'
267.           Statement:
268.             - Effect: Allow
269.               Principal:
270.                 Service:
271.                   - lambda.amazonaws.com
272.               Action: sts:AssumeRole
273.         Policies:
274.           - PolicyName: myPolicyName
275.             PolicyDocument:
276.               Version: '2012-10-17'
277.               Statement:
278.                 - Effect: Allow # note that these rights are given in the default policy and are required if you want logs out of your lambda(s)
279.                   Action:
280.                     - logs:CreateLogGroup
281.                     - logs:CreateLogStream
282.                     - logs:PutLogEvents
283.                   Resource:
284.                     - 'Fn::Join':
285.                       - ':'
286.                       -
287.                         - 'arn:aws:logs'
288.                         - Ref: 'AWS::Region'
289.                         - Ref: 'AWS::AccountId'
290.                         - 'log-group:/aws/lambda/*:*:*'
291.                 -  Effect: "Allow"
292.                    Action:
293.                      - "s3:PutObject"
294.                    Resource:
295.                      Fn::Join:
296.                        - ""
297.                        - - "arn:aws:s3:::"
298.                          - "Ref" : "ServerlessDeploymentBucket"
299.     myCustRole0:
300.       Type: AWS::IAM::Role
301.       Properties:
302.         Path: /my/cust/path/
303.         RoleName: MyCustRole0
304.         AssumeRolePolicyDocument:
305.           Version: '2012-10-17'
306.           Statement:
307.             - Effect: Allow
308.               Principal:
309.                 Service:
310.                   - lambda.amazonaws.com
311.               Action: sts:AssumeRole
312.         Policies:
313.           - PolicyName: myPolicyName
314.             PolicyDocument:
315.               Version: '2012-10-17'
316.               Statement:
317.                 - Effect: Allow
318.                   Action:
319.                     - logs:CreateLogGroup
320.                     - logs:CreateLogStream
321.                     - logs:PutLogEvents
322.                   Resource:
323.                     - 'Fn::Join':
324.                       - ':'
325.                       -
326.                         - 'arn:aws:logs'
327.                         - Ref: 'AWS::Region'
328.                         - Ref: 'AWS::AccountId'
329.                         - 'log-group:/aws/lambda/*:*:*'
330.                 - Effect: Allow
331.                   Action:
332.                     - ec2:CreateNetworkInterface
333.                     - ec2:DescribeNetworkInterfaces
334.                     - ec2:DetachNetworkInterface
335.                     - ec2:DeleteNetworkInterface
336.                   Resource: "*"
337. 
338. ```


File: lib/plugins/aws/package/index.js
Line number range: 1 - 90
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const path = require('path');
5. const mergeCustomProviderResources = require('./lib/mergeCustomProviderResources');
6. const generateArtifactDirectoryName = require('./lib/generateArtifactDirectoryName');
7. const generateCoreTemplate = require('./lib/generateCoreTemplate');
8. const saveServiceState = require('./lib/saveServiceState');
9. const saveCompiledTemplate = require('./lib/saveCompiledTemplate');
10. const mergeIamTemplates = require('./lib/mergeIamTemplates');
11. 
12. class AwsPackage {
13.   constructor(serverless, options) {
14.     this.serverless = serverless;
15.     this.options = options;
16.     this.servicePath = this.serverless.config.servicePath || '';
17.     this.packagePath =
18.       this.options.package ||
19.       this.serverless.service.package.path ||
20.       path.join(this.servicePath || '.', '.serverless');
21.     this.provider = this.serverless.getProvider('aws');
22. 
23.     Object.assign(
24.       this,
25.       generateCoreTemplate,
26.       mergeIamTemplates,
27.       generateArtifactDirectoryName,
28.       mergeCustomProviderResources,
29.       saveServiceState,
30.       saveCompiledTemplate
31.     );
32. 
33.     // Define inner lifecycles
34.     this.commands = {
35.       aws: {
36.         type: 'entrypoint',
37.         commands: {
38.           package: {
39.             commands: {
40.               finalize: {
41.                 lifecycleEvents: ['mergeCustomProviderResources', 'saveServiceState'],
42.               },
43.             },
44.           },
45.         },
46.       },
47.     };
48. 
49.     this.hooks = {
50.       /**
51.        * Outer lifecycle hooks
52.        */
53.       'package:cleanup': () =>
54.         BbPromise.bind(this)
55.           .then(() => this.serverless.pluginManager.spawn('aws:common:validate'))
56.           .then(() => this.serverless.pluginManager.spawn('aws:common:cleanupTempDir')),
57. 
58.       'package:initialize': () => BbPromise.bind(this).then(this.generateCoreTemplate),
59. 
60.       'package:setupProviderConfiguration': () => BbPromise.bind(this).then(this.mergeIamTemplates),
61. 
62.       'before:package:compileFunctions': () =>
63.         BbPromise.bind(this).then(this.generateArtifactDirectoryName),
64. 
65.       'before:package:compileLayers': () =>
66.         BbPromise.bind(this).then(this.generateArtifactDirectoryName),
67. 
68.       'package:finalize': () =>
69.         BbPromise.bind(this).then(() =>
70.           this.serverless.pluginManager.spawn('aws:package:finalize')
71.         ),
72. 
73.       /**
74.        * Inner lifecycle hooks
75.        */
76. 
77.       // Package finalize inner lifecycle
78.       'aws:package:finalize:mergeCustomProviderResources': () =>
79.         BbPromise.bind(this).then(this.mergeCustomProviderResources),
80. 
81.       'aws:package:finalize:saveServiceState': () =>
82.         BbPromise.bind(this)
83.           .then(this.saveCompiledTemplate)
84.           .then(this.saveServiceState)
85.           .then(() => this.serverless.pluginManager.spawn('aws:common:moveArtifactsToPackage')),
86.     };
87.   }
88. }
89. 
90. module.exports = AwsPackage;


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 1 - 227
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const BbPromise = require('bluebird');
5. const path = require('path');
6. 
7. module.exports = {
8.   mergeIamTemplates() {
9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);
10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);
11.     return this.merge();
12.   },
13. 
14.   merge() {
15.     // resolve early if no functions are provided
16.     if (!this.serverless.service.getAllFunctions().length) {
17.       return BbPromise.resolve();
18.     }
19. 
20.     // create log group resources
21.     this.serverless.service.getAllFunctions().forEach(functionName => {
22.       const functionObject = this.serverless.service.getFunction(functionName);
23.       const logGroupLogicalId = this.provider.naming.getLogGroupLogicalId(functionName);
24.       const newLogGroup = {
25.         [logGroupLogicalId]: {
26.           Type: 'AWS::Logs::LogGroup',
27.           Properties: {
28.             LogGroupName: this.provider.naming.getLogGroupName(functionObject.name),
29.           },
30.         },
31.       };
32. 
33.       const logRetentionInDays = this.provider.getLogRetentionInDays();
34.       if (logRetentionInDays) {
35.         newLogGroup[logGroupLogicalId].Properties.RetentionInDays = logRetentionInDays;
36.       }
37. 
38.       _.merge(
39.         this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
40.         newLogGroup
41.       );
42.     });
43. 
44.     // resolve early if provider level role is provided
45.     if ('role' in this.serverless.service.provider) {
46.       return BbPromise.resolve();
47.     }
48. 
49.     // resolve early if all functions contain a custom role
50.     const customRolesProvided = [];
51.     this.serverless.service.getAllFunctions().forEach(functionName => {
52.       const functionObject = this.serverless.service.getFunction(functionName);
53.       customRolesProvided.push('role' in functionObject);
54.     });
55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {
56.       return BbPromise.resolve();
57.     }
58. 
59.     // merge in the iamRoleLambdaTemplate
60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(
61.       path.join(
62.         this.serverless.config.serverlessPath,
63.         'plugins',
64.         'aws',
65.         'package',
66.         'lib',
67.         'iam-role-lambda-execution-template.json'
68.       )
69.     );
70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();
71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();
72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();
73. 
74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,
76.     });
77. 
78.     const canonicalFunctionNamePrefix = `${
79.       this.provider.serverless.service.service
80.     }-${this.provider.getStage()}`;
81.     const logGroupsPrefix = this.provider.naming.getLogGroupName(canonicalFunctionNamePrefix);
82. 
83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate
84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument
85.       .Statement;
86. 
87.     let hasOneOrMoreCanonicallyNamedFunctions = false;
88. 
89.     // Ensure policies for functions with custom name resolution
90.     this.serverless.service.getAllFunctions().forEach(functionName => {
91.       const { name: resolvedFunctionName } = this.serverless.service.getFunction(functionName);
92.       if (!resolvedFunctionName || resolvedFunctionName.startsWith(canonicalFunctionNamePrefix)) {
93.         hasOneOrMoreCanonicallyNamedFunctions = true;
94.         return;
95.       }
96. 
97.       const customFunctionNamelogGroupsPrefix = this.provider.naming.getLogGroupName(
98.         resolvedFunctionName
99.       );
100. 
101.       policyDocumentStatements[0].Resource.push({
102.         'Fn::Sub':
103.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
104.           `:log-group:${customFunctionNamelogGroupsPrefix}:*`,
105.       });
106. 
107.       policyDocumentStatements[1].Resource.push({
108.         'Fn::Sub':
109.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
110.           `:log-group:${customFunctionNamelogGroupsPrefix}:*:*`,
111.       });
112.     });
113. 
114.     if (hasOneOrMoreCanonicallyNamedFunctions) {
115.       // Ensure general policies for functions with default name resolution
116.       policyDocumentStatements[0].Resource.push({
117.         'Fn::Sub':
118.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
119.           `:log-group:${logGroupsPrefix}*:*`,
120.       });
121. 
122.       policyDocumentStatements[1].Resource.push({
123.         'Fn::Sub':
124.           'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
125.           `:log-group:${logGroupsPrefix}*:*:*`,
126.       });
127.     }
128. 
129.     if (this.serverless.service.provider.iamRoleStatements) {
130.       // add custom iam role statements
131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
132.         this.provider.naming.getRoleLogicalId()
133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(
134.         this.serverless.service.provider.iamRoleStatements
135.       );
136.     }
137. 
138.     if (this.serverless.service.provider.iamManagedPolicies) {
139.       // add iam managed policies
140.       const iamManagedPolicies = this.serverless.service.provider.iamManagedPolicies;
141.       if (iamManagedPolicies.length > 0) {
142.         this.mergeManagedPolicies(iamManagedPolicies);
143.       }
144.     }
145. 
146.     // check if one of the functions contains vpc configuration
147.     const vpcConfigProvided = [];
148.     this.serverless.service.getAllFunctions().forEach(functionName => {
149.       const functionObject = this.serverless.service.getFunction(functionName);
150.       if ('vpc' in functionObject) {
151.         vpcConfigProvided.push(true);
152.       }
153.     });
154. 
155.     if (_.includes(vpcConfigProvided, true) || this.serverless.service.provider.vpc) {
156.       // add managed iam policy to allow ENI management
157.       this.mergeManagedPolicies([
158.         {
159.           'Fn::Join': [
160.             '',
161.             [
162.               'arn:',
163.               { Ref: 'AWS::Partition' },
164.               ':iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole',
165.             ],
166.           ],
167.         },
168.       ]);
169.     }
170. 
171.     return BbPromise.resolve();
172.   },
173. 
174.   mergeManagedPolicies(managedPolicies) {
175.     const resource = this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
176.       this.provider.naming.getRoleLogicalId()
177.     ].Properties;
178.     if (!_.has(resource, 'ManagedPolicyArns') || _.isEmpty(resource.ManagedPolicyArns)) {
179.       resource.ManagedPolicyArns = [];
180.     }
181.     resource.ManagedPolicyArns = resource.ManagedPolicyArns.concat(managedPolicies);
182.   },
183. 
184.   validateStatements(statements) {
185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
186.     // Action: ..., Resource: ... } objects.
187.     if (!statements) {
188.       return;
189.     }
190.     let violationsFound;
191.     if (!(statements instanceof Array)) {
192.       violationsFound = 'it is not an array';
193.     } else {
194.       const descriptions = statements.map((statement, i) => {
195.         const missing = ['Effect', 'Action', 'Resource'].filter(
196.           prop => statement[prop] === undefined
197.         );
198.         return missing.length === 0
199.           ? null
200.           : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
201.       });
202.       const flawed = descriptions.filter(curr => curr);
203.       if (flawed.length) {
204.         violationsFound = flawed.join('; ');
205.       }
206.     }
207. 
208.     if (violationsFound) {
209.       const errorMessage = [
210.         'iamRoleStatements should be an array of objects,',
211.         ' where each object has Effect, Action, Resource fields.',
212.         ` Specifically, ${violationsFound}`,
213.       ].join('');
214.       throw new this.serverless.classes.Error(errorMessage);
215.     }
216.   },
217. 
218.   validateManagedPolicies(iamManagedPolicies) {
219.     // Verify that iamManagedPolicies (if present) is an array
220.     if (!iamManagedPolicies) {
221.       return;
222.     }
223.     if (!_.isArray(iamManagedPolicies)) {
224.       throw new this.serverless.classes.Error('iamManagedPolicies should be an array of arns');
225.     }
226.   },
227. };

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 21:17:40,029 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='Query asks for lib/plugins/aws/package/index.js contents and where iamRoleStatements are processed. These lines show mergeIamTemplates being required, mixed into the class, and hooked into the packaging lifecycle where it runs.', relative_path='lib/plugins/aws/package/index.js', start_line=10, end_line=10), ContextOutput(reasoning='These lines show mergeIamTemplates (and related helpers) being mixed into the AwsPackage instance methods, indicating where the functionality is sourced.', relative_path='lib/plugins/aws/package/index.js', start_line=23, end_line=31), ContextOutput(reasoning='This hook shows when mergeIamTemplates is executed during packaging, which is essential to know when the IAM role is created/merged.', relative_path='lib/plugins/aws/package/index.js', start_line=60, end_line=61), ContextOutput(reasoning='This method is the entry point that validates iamRoleStatements and iamManagedPolicies and then performs the merge. It directly addresses processing of provider.iamRoleStatements.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=8, end_line=12), ContextOutput(reasoning='These lines early-return when a provider-level role is set or all functions define custom roles, explaining when the default IamRoleLambdaExecution resource is not created. Essential context for role creation conditions.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=44, end_line=58), ContextOutput(reasoning='This block loads the iam-role-lambda-execution CloudFormation template, sets Path/RoleName/PolicyName, and merges it under the role logical ID. It is the code that creates the IamRoleLambdaExecution resource.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=59, end_line=76), ContextOutput(reasoning='This block locates the default policy statements array within the created role resource; needed to understand where custom statements will be appended.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=83, end_line=86), ContextOutput(reasoning="This block appends provider.iamRoleStatements to the role's PolicyDocument.Statement, directly showing how custom statements are applied.", relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=129, end_line=136), ContextOutput(reasoning='This function validates provider.iamRoleStatements schema, requiring Effect, Action, and Resource fields; crucial for understanding expected policy schema and why NotAction/NotResource would not pass validation.', relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', start_line=184, end_line=216), ContextOutput(reasoning='This documentation section explains the default IAM role and how provider.iamRoleStatements are defined/merged, with example schema demonstrating Effect/Action/Resource fields.', relative_path='docs/providers/aws/guide/iam.md', start_line=19, end_line=48), ContextOutput(reasoning='This documentation section explains provider.iamManagedPolicies which are also merged into the role; useful extended context alongside iamRoleStatements.', relative_path='docs/providers/aws/guide/iam.md', start_line=50, end_line=61), ContextOutput(reasoning="This documentation section warns that when custom roles are defined, provider-level iamRoleStatements are not applied—important context matching the code's early-return conditions.", relative_path='docs/providers/aws/guide/iam.md', start_line=63, end_line=71)]
2025-11-13 21:17:40,034 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 12 contexts to memory for query: Please provide the contents of lib/plugins/aws/package/index.js and any module that creates the IamRoleLambdaExecution resource and processes provider.iamRoleStatements.
2025-11-13 21:17:44,296 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 21:17:44,297 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 12 new contexts to 24 existing contexts
2025-11-13 21:17:44,298 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 36 total contexts (removed 0 duplicates)
2025-11-13 21:17:44,300 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   └── workflows
|       └── update-sfe-next.yml
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       └── spotinst
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── plugin-install.md
|           |   ├── plugin-list.md
|           |   ├── plugin-search.md
|           |   ├── plugin-uninstall.md
|           |   ├── remove.md
|           |   └── stage.md
|           ├── events
|           |   ├── README.md
|           |   ├── http.md
|           |   └── schedule.md
|           ├── examples
|           |   ├── README.md
|           |   ├── java8
|           |   ├── node
|           |   ├── python
|           |   └── ruby
|           └── guide
|               ├── IAM-roles.md
|               ├── README.md
|               ├── active-versions.md
|               ├── cors.md
|               ├── create-token.md
|               ├── credentials.md
|               ├── endpoints.md
|               ├── intro.md
|               ├── quick-start.md
|               ├── serverless.yml.md
|               └── variables.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   └── serverlessLog.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── sentry.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── iot
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Support NotAction and NotResource

Issue description: 
# Feature Proposal

## Description

<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->
<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->

Currently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).

These should be supported, as they are valid IAM role statements.

e.g. to allow a lambda to send text messages, but not publish to any SNS topics
```yaml
      - Effect: 'Allow'
        Action: 'sns:Publish'
        NotResource: 'arn:aws:sns:*:*:*'
```

Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the contents of lib/plugins/aws/lib/validate.js, lib/plugins/aws/provider/awsProvider.js, and any files under lib/plugins/aws/package/lib and lib/plugins/aws/package/compile that handle IAM roles/policies and iamRoleStatements.
Extra Requirements: If the exact files are unclear, include a directory listing and code snippets (with paths) for any modules referencing iamRoleStatements, IAM, Role, Policy, NotAction, or NotResource.
Purpose: I need to pinpoint where NotAction/NotResource are rejected and understand the architectural patterns to integrate support consistently.

Previous refined query 2:
Essential Query: Please provide the contents of lib/plugins/aws/package/index.js and any module that creates the IamRoleLambdaExecution resource and processes provider.iamRoleStatements.
Extra Requirements: If the role creation is in a different file, include its path and code; also share docs/providers/aws/guide/iam.md.
Purpose: I need to locate where iamRoleStatements are validated/applied and understand the expected policy schema to implement support for NotAction/NotResource.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/guide/iam.md
Line number range: 19 - 48
Content:
19. ## The Default IAM Role
20. 
21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
22. 
23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
24. 
25. ```yml
26. service: new-service
27. 
28. provider:
29.   name: aws
30.   iamRoleStatements:
31.     - Effect: 'Allow'
32.       Action:
33.         - 's3:ListBucket'
34.       Resource:
35.         Fn::Join:
36.           - ''
37.           - - 'arn:aws:s3:::'
38.             - Ref: ServerlessDeploymentBucket
39.     - Effect: 'Allow'
40.       Action:
41.         - 's3:PutObject'
42.       Resource:
43.         Fn::Join:
44.           - ''
45.           - - 'arn:aws:s3:::'
46.             - Ref: ServerlessDeploymentBucket
47.             - '/*'
48. ```


File: docs/providers/aws/guide/iam.md
Line number range: 50 - 61
Content:
50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
51. 
52. ```yml
53. service: new-service
54. 
55. provider:
56.   name: aws
57.   iamManagedPolicies:
58.     - 'some:aws:arn:xxx:*:*'
59.     - 'someOther:aws:arn:xxx:*:*'
60.     - { 'Fn::Join': [':', ['arn:aws:iam:', { Ref: 'AWSAccountId' }, 'some/path']] }
61. ```


File: docs/providers/aws/guide/iam.md
Line number range: 63 - 71
Content:
63. ## Custom IAM Roles
64. 
65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.
66. 
67. That means that `iamRoleStatements` you've defined on the `provider` level won't be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.
68. 
69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.
70. 
71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.


File: lib/plugins/aws/customResources/index.js
Line number range: 89 - 160
Content:
89.       let customResourceRole = Resources[customResourcesRoleLogicalId];
90.       if (!customResourceRole) {
91.         customResourceRole = {
92.           Type: 'AWS::IAM::Role',
93.           Properties: {
94.             AssumeRolePolicyDocument: {
95.               Version: '2012-10-17',
96.               Statement: [
97.                 {
98.                   Effect: 'Allow',
99.                   Principal: {
100.                     Service: ['lambda.amazonaws.com'],
101.                   },
102.                   Action: ['sts:AssumeRole'],
103.                 },
104.               ],
105.             },
106.             Policies: [
107.               {
108.                 PolicyName: {
109.                   'Fn::Join': [
110.                     '-',
111.                     [
112.                       awsProvider.getStage(),
113.                       awsProvider.serverless.service.service,
114.                       'custom-resources-lambda',
115.                     ],
116.                   ],
117.                 },
118.                 PolicyDocument: {
119.                   Version: '2012-10-17',
120.                   Statement: [],
121.                 },
122.               },
123.             ],
124.           },
125.         };
126. 
127.         if (shouldWriteLogs) {
128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);
129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(
130.             {
131.               Effect: 'Allow',
132.               Action: ['logs:CreateLogStream'],
133.               Resource: [
134.                 {
135.                   'Fn::Sub':
136.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
137.                     `:log-group:${logGroupsPrefix}*:*`,
138.                 },
139.               ],
140.             },
141.             {
142.               Effect: 'Allow',
143.               Action: ['logs:PutLogEvents'],
144.               Resource: [
145.                 {
146.                   'Fn::Sub':
147.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +
148.                     `:log-group:${logGroupsPrefix}*:*:*`,
149.                 },
150.               ],
151.             }
152.           );
153.         }
154.       }
155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
156.       iamRoleStatements.forEach(newStmt => {
157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
158.           Statement.push(newStmt);
159.         }
160.       });


File: lib/plugins/aws/deployFunction/index.js
Line number range: 71 - 116
Content:
71.         throw new this.serverless.classes.Error(errorMessage);
72.       });
73.   }
74. 
75.   normalizeArnRole(role) {
76.     if (typeof role === 'string') {
77.       if (role.indexOf(':') === -1) {
78.         const roleResource = this.serverless.service.resources.Resources[role];
79. 
80.         if (roleResource.Type !== 'AWS::IAM::Role') {
81.           throw new Error('Provided resource is not IAM Role.');
82.         }
83. 
84.         const roleProperties = roleResource.Properties;
85.         const compiledFullRoleName = `${roleProperties.Path || '/'}${roleProperties.RoleName}`;
86. 
87.         return this.provider
88.           .getAccountInfo()
89.           .then(
90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`
91.           );
92.       }
93. 
94.       return BbPromise.resolve(role);
95.     }
96. 
97.     return this.provider
98.       .request('IAM', 'getRole', {
99.         RoleName: role['Fn::GetAtt'][0],
100.       })
101.       .then(data => data.Arn);
102.   }
103. 
104.   callUpdateFunctionConfiguration(params) {
105.     return this.provider.request('Lambda', 'updateFunctionConfiguration', params).then(() => {
106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);
107.     });
108.   }
109. 
110.   updateFunctionConfiguration() {
111.     const functionObj = this.options.functionObj;
112.     const serviceObj = this.serverless.service.serviceObject;
113.     const providerObj = this.serverless.service.provider;
114.     const params = {
115.       FunctionName: functionObj.name,
116.     };


File: lib/plugins/aws/lib/naming.js
Line number range: 86 - 106
Content:
86.   // Role
87.   getRolePath() {
88.     return '/';
89.   },
90.   getRoleName() {
91.     return {
92.       'Fn::Join': [
93.         '-',
94.         [
95.           this.provider.serverless.service.service,
96.           this.provider.getStage(),
97.           { Ref: 'AWS::Region' },
98.           'lambdaRole',
99.         ],
100.       ],
101.     };
102.   },
103.   getRoleLogicalId() {
104.     return 'IamRoleLambdaExecution';
105.   },
106. 


File: lib/plugins/aws/lib/naming.js
Line number range: 107 - 122
Content:
107.   // Policy
108.   getPolicyName() {
109.     return {
110.       // TODO should probably have name ordered and altered as above - see AWS docs
111.       'Fn::Join': [
112.         '-',
113.         [
114.           this.provider.getStage(),
115.           // TODO is it a bug here in that the role is not specific to the region?
116.           this.provider.serverless.service.service,
117.           'lambda',
118.         ],
119.       ],
120.     };
121.   },
122. 


File: lib/plugins/aws/lib/naming.js
Line number range: 447 - 453
Content:
447.   // Custom Resources
448.   getCustomResourcesArtifactDirectoryName() {
449.     return 'custom-resources';
450.   },
451.   getCustomResourcesRoleLogicalId() {
452.     return 'IamRoleCustomResourcesLambdaExecution';
453.   },


File: lib/plugins/aws/lib/validate.js
Line number range: 1 - 62
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const chalk = require('chalk');
5. const userStats = require('../../../utils/userStats');
6. 
7. module.exports = {
8.   validate() {
9.     if (!this.serverless.config.servicePath) {
10.       const error = new this.serverless.classes.Error(
11.         'This command can only be run inside a service directory'
12.       );
13.       return BbPromise.reject(error);
14.     }
15. 
16.     this.options.stage = this.provider.getStage();
17.     this.options.region = this.provider.getRegion();
18. 
19.     if (
20.       !['logs', 'info', 'deploy', 'remove', 'rollback', 'metrics', 'invoke'].includes(
21.         this.serverless.processedInput.commands[0]
22.       ) ||
23.       this.serverless.processedInput.commands[1] === 'local'
24.     ) {
25.       return BbPromise.resolve();
26.     }
27.     const creds = Object.assign({}, this.provider.getCredentials());
28.     delete creds.region;
29.     delete creds.signatureVersion;
30. 
31.     if (
32.       Object.keys(creds).length === 0 &&
33.       !process.env.ECS_CONTAINER_METADATA_FILE &&
34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&
35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI
36.     ) {
37.       // first check if the EC2 Metadata Service has creds before throwing error
38.       const metadataService = new this.provider.sdk.MetadataService({
39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout
40.         maxRetries: 0, // retry 0 times
41.       });
42.       return new BbPromise((resolve, reject) =>
43.         metadataService.request('/', (err, data) => {
44.           return err ? reject(err) : resolve(data);
45.         })
46.       )
47.         .catch(() => null)
48.         .then(identity => {
49.           if (!identity) {
50.             const message = [
51.               'AWS provider credentials not found.',
52.               ' Learn how to set up AWS provider credentials',
53.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
54.             ].join('');
55.             userStats.track('user_awsCredentialsNotFound');
56.             throw new this.serverless.classes.Error(message);
57.           }
58.         });
59.     }
60.     return BbPromise.resolve();
61.   },
62. };


File: lib/plugins/aws/package/compile/events/cloudFront/index.js
Line number range: 200 - 260
Content:
200.                 o.TargetOriginId === behavior.TargetOriginId
201.             );
202. 
203.             if (!existingBehaviour) {
204.               behaviors.push(behavior);
205.             } else {
206.               behavior = extendDeep(existingBehaviour, behavior);
207.             }
208. 
209.             lambdaAtEdgeFunctions.push(
210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })
211.             );
212.           }
213.         });
214.       }
215.     });
216. 
217.     // sort that first is without PathPattern if available
218.     behaviors.sort((a, b) => {
219.       if (b.PathPattern) {
220.         return -1;
221.       }
222.       return 0;
223.     });
224. 
225.     if (lambdaAtEdgeFunctions.length) {
226.       if (this.provider.getRegion() !== 'us-east-1') {
227.         throw new ServerlessError(
228.           'CloudFront associated functions have to be deployed to the us-east-1 region.'
229.         );
230.       }
231. 
232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(
233.         (permissions, lambdaAtEdgeFunction) => {
234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(
235.             lambdaAtEdgeFunction.functionName
236.           );
237.           const invokePermission = {
238.             Type: 'AWS::Lambda::Permission',
239.             Properties: {
240.               FunctionName: {
241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,
242.               },
243.               Action: 'lambda:InvokeFunction',
244.               Principal: 'edgelambda.amazonaws.com',
245.               SourceArn: {
246.                 'Fn::Join': [
247.                   '',
248.                   [
249.                     '',
250.                     'arn:aws:cloudfront::',
251.                     { Ref: 'AWS::AccountId' },
252.                     ':distribution/',
253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },
254.                   ],
255.                 ],
256.               },
257.             },
258.           };
259.           return Object.assign(permissions, {
260.             [invokePermissionName]: invokePermission,


File: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js
Line number range: 20 - 364
Content:
20. class AwsCompileCognitoUserPoolEvents {
21.   constructor(serverless, options) {
22.     this.serverless = serverless;
23.     this.options = options;
24.     this.provider = this.serverless.getProvider('aws');
25. 
26.     this.hooks = {
27.       'package:compileEvents': () => {
28.         return BbPromise.bind(this)
29.           .then(this.newCognitoUserPools)
30.           .then(this.existingCognitoUserPools);
31.       },
32.       'after:package:finalize': this.mergeWithCustomResources.bind(this),
33.     };
34.   }
35. 
36.   newCognitoUserPools() {
37.     const { service } = this.serverless;
38.     service.getAllFunctions().forEach(functionName => {
39.       const functionObj = service.getFunction(functionName);
40.       if (functionObj.events) {
41.         functionObj.events.forEach(event => {
42.           if (event.cognitoUserPool) {
43.             // return immediately if it's an existing Cognito User Pool event since we treat them differently
44.             if (event.cognitoUserPool.existing) return null;
45. 
46.             const result = this.findUserPoolsAndFunctions();
47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
48.             const userPools = result.userPools;
49. 
50.             // Generate CloudFormation templates for Cognito User Pool changes
51.             _.forEach(userPools, poolName => {
52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {
53.                 poolName,
54.               });
55.               const userPoolCFResource = this.generateTemplateForPool(
56.                 poolName,
57.                 currentPoolTriggerFunctions
58.               );
59. 
60.               _.merge(
61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
62.                 userPoolCFResource
63.               );
64.             });
65. 
66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda
67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {
68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(
69.                 cognitoUserPoolTriggerFunction.poolName
70.               );
71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(
72.                 cognitoUserPoolTriggerFunction.functionName
73.               );
74. 
75.               const permissionTemplate = {
76.                 Type: 'AWS::Lambda::Permission',
77.                 Properties: {
78.                   FunctionName: {
79.                     'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
80.                   },
81.                   Action: 'lambda:InvokeFunction',
82.                   Principal: 'cognito-idp.amazonaws.com',
83.                   SourceArn: {
84.                     'Fn::GetAtt': [userPoolLogicalId, 'Arn'],
85.                   },
86.                 },
87.               };
88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(
89.                 cognitoUserPoolTriggerFunction.functionName,
90.                 cognitoUserPoolTriggerFunction.poolName,
91.                 cognitoUserPoolTriggerFunction.triggerSource
92.               );
93.               const permissionCFResource = {
94.                 [lambdaPermissionLogicalId]: permissionTemplate,
95.               };
96.               _.merge(
97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
98.                 permissionCFResource
99.               );
100.             });
101.           }
102.           return null;
103.         });
104.       }
105.       return null;
106.     });
107.   }
108. 
109.   existingCognitoUserPools() {
110.     const { service } = this.serverless;
111.     const { provider } = service;
112.     const { compiledCloudFormationTemplate } = provider;
113.     const { Resources } = compiledCloudFormationTemplate;
114.     const iamRoleStatements = [];
115. 
116.     // used to keep track of the custom resources created for each Cognito User Pool
117.     const poolResources = {};
118. 
119.     service.getAllFunctions().forEach(functionName => {
120.       let numEventsForFunc = 0;
121.       let currentPoolName = null;
122.       let funcUsesExistingCognitoUserPool = false;
123.       const functionObj = service.getFunction(functionName);
124.       const FunctionName = functionObj.name;
125. 
126.       if (functionObj.events) {
127.         functionObj.events.forEach(event => {
128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {
129.             numEventsForFunc++;
130.             const { pool, trigger } = event.cognitoUserPool;
131.             funcUsesExistingCognitoUserPool = true;
132. 
133.             if (!currentPoolName) {
134.               currentPoolName = pool;
135.             }
136.             if (pool !== currentPoolName) {
137.               const errorMessage = [
138.                 'Only one Cognito User Pool can be configured per function.',
139.                 ` In "${FunctionName}" you're attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,
140.               ].join('');
141.               throw new this.serverless.classes.Error(errorMessage);
142.             }
143. 
144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();
146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(
147.               functionName
148.             );
149. 
150.             // store how often the custom Cognito User Pool resource is used
151.             if (poolResources[pool]) {
152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);
153.             } else {
154.               Object.assign(poolResources, {
155.                 [pool]: [customPoolResourceLogicalId],
156.               });
157.             }
158. 
159.             let customCognitoUserPoolResource;
160.             if (numEventsForFunc === 1) {
161.               customCognitoUserPoolResource = {
162.                 [customPoolResourceLogicalId]: {
163.                   Type: 'Custom::CognitoUserPool',
164.                   Version: 1.0,
165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],
166.                   Properties: {
167.                     ServiceToken: {
168.                       'Fn::GetAtt': [customResourceFunctionLogicalId, 'Arn'],
169.                     },
170.                     FunctionName,
171.                     UserPoolName: pool,
172.                     UserPoolConfigs: [
173.                       {
174.                         Trigger: trigger,
175.                       },
176.                     ],
177.                   },
178.                 },
179.               };
180. 
181.               iamRoleStatements.push({
182.                 Effect: 'Allow',
183.                 Resource: '*',
184.                 Action: [
185.                   'cognito-idp:ListUserPools',
186.                   'cognito-idp:DescribeUserPool',
187.                   'cognito-idp:UpdateUserPool',
188.                 ],
189.               });
190.             } else {
191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({
192.                 Trigger: trigger,
193.               });
194.             }
195. 
196.             _.merge(Resources, customCognitoUserPoolResource);
197.           }
198.         });
199.       }
200. 
201.       if (funcUsesExistingCognitoUserPool) {
202.         iamRoleStatements.push({
203.           Effect: 'Allow',
204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,
205.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
206.         });
207.       }
208.     });
209. 
210.     // check if we need to add DependsOn clauses in case more than 1
211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)
212.     if (Object.keys(poolResources).length > 0) {
213.       Object.keys(poolResources).forEach(pool => {
214.         const resources = poolResources[pool];
215.         if (resources.length > 1) {
216.           resources.forEach((currResourceLogicalId, idx) => {
217.             if (idx > 0) {
218.               const prevResourceLogicalId = resources[idx - 1];
219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);
220.             }
221.           });
222.         }
223.       });
224.     }
225. 
226.     if (iamRoleStatements.length) {
227.       return addCustomResourceToService(this.provider, 'cognitoUserPool', iamRoleStatements);
228.     }
229. 
230.     return null;
231.   }
232. 
233.   findUserPoolsAndFunctions() {
234.     const userPools = [];
235.     const cognitoUserPoolTriggerFunctions = [];
236. 
237.     // Iterate through all functions declared in `serverless.yml`
238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {
239.       const functionObj = this.serverless.service.getFunction(functionName);
240. 
241.       if (functionObj.events) {
242.         _.forEach(functionObj.events, event => {
243.           if (event.cognitoUserPool) {
244.             // Check event definition for `cognitoUserPool` object
245.             if (typeof event.cognitoUserPool === 'object') {
246.               // Check `cognitoUserPool` object has required properties
247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {
248.                 throw new this.serverless.classes.Error(
249.                   [
250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,
251.                     'The correct syntax is an object with the "pool" and "trigger" properties.',
252.                     'Please check the docs for more info.',
253.                   ].join(' ')
254.                 );
255.               }
256. 
257.               // Check `cognitoUserPool` trigger is valid
258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {
259.                 throw new this.serverless.classes.Error(
260.                   [
261.                     'Cognito User Pool trigger source is invalid, must be one of:',
262.                     `${validTriggerSources.join(', ')}.`,
263.                     'Please check the docs for more info.',
264.                   ].join(' ')
265.                 );
266.               }
267. 
268.               // Save trigger functions so we can use them to generate
269.               // IAM permissions later
270.               cognitoUserPoolTriggerFunctions.push({
271.                 functionName,
272.                 poolName: event.cognitoUserPool.pool,
273.                 triggerSource: event.cognitoUserPool.trigger,
274.               });
275. 
276.               // Save user pools so we can use them to generate
277.               // CloudFormation resources later
278.               userPools.push(event.cognitoUserPool.pool);
279.             } else {
280.               throw new this.serverless.classes.Error(
281.                 [
282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,
283.                   'The correct syntax is an object with the "pool" and "trigger" properties.',
284.                   'Please check the docs for more info.',
285.                 ].join(' ')
286.               );
287.             }
288.           }
289.         });
290.       }
291.     });
292. 
293.     return { cognitoUserPoolTriggerFunctions, userPools };
294.   }
295. 
296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {
297.     const lambdaConfig = _.reduce(
298.       currentPoolTriggerFunctions,
299.       (result, value) => {
300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);
301. 
302.         // Return a new object to avoid lint errors
303.         return Object.assign({}, result, {
304.           [value.triggerSource]: {
305.             'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
306.           },
307.         });
308.       },
309.       {}
310.     );
311. 
312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);
313. 
314.     // Attach `DependsOn` for any relevant Lambdas
315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>
316.       this.provider.naming.getLambdaLogicalId(value.functionName)
317.     );
318. 
319.     return {
320.       [userPoolLogicalId]: {
321.         Type: 'AWS::Cognito::UserPool',
322.         Properties: {
323.           UserPoolName: poolName,
324.           LambdaConfig: lambdaConfig,
325.         },
326.         DependsOn,
327.       },
328.     };
329.   }
330. 
331.   mergeWithCustomResources() {
332.     const result = this.findUserPoolsAndFunctions();
333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;
334.     const userPools = result.userPools;
335. 
336.     _.forEach(userPools, poolName => {
337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });
338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);
339. 
340.       // If overrides exist in `Resources`, merge them in
341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {
342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];
343.         const generatedUserPool = this.generateTemplateForPool(
344.           poolName,
345.           currentPoolTriggerFunctions
346.         )[userPoolLogicalId];
347. 
348.         // Merge `DependsOn` clauses
349.         const customUserPoolDependsOn = _.get(customUserPool, 'DependsOn', []);
350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);
351. 
352.         // Merge default and custom resources, and `DependsOn` clause
353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {
354.           DependsOn,
355.         });
356. 
357.         // Merge resource back into `Resources`
358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
359.           [userPoolLogicalId]: mergedTemplate,
360.         });
361.       }
362.     });
363.   }
364. }


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 21 - 23
Content:
21.     const iamRoleStatements = [];
22. 
23.     service.getAllFunctions().forEach(functionName => {


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 146 - 162
Content:
146.                 iamRoleStatements.push({
147.                   Effect: 'Allow',
148.                   Resource: eventBusResource,
149.                   Action: ['events:CreateEventBus', 'events:DeleteEventBus'],
150.                 });
151.               }
152. 
153.               iamRoleStatements.push({
154.                 Effect: 'Allow',
155.                 Resource: ruleResource,
156.                 Action: [
157.                   'events:PutRule',
158.                   'events:RemoveTargets',
159.                   'events:PutTargets',
160.                   'events:DeleteRule',
161.                 ],
162.               });


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 174 - 190
Content:
174.       if (funcUsesEventBridge) {
175.         iamRoleStatements.push({
176.           Effect: 'Allow',
177.           Resource: {
178.             'Fn::Join': [
179.               ':',
180.               [
181.                 'arn:aws:lambda',
182.                 { Ref: 'AWS::Region' },
183.                 { Ref: 'AWS::AccountId' },
184.                 'function',
185.                 FunctionName,
186.               ],
187.             ],
188.           },
189.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
190.         });


File: lib/plugins/aws/package/compile/events/eventBridge/index.js
Line number range: 194 - 196
Content:
194.     if (iamRoleStatements.length) {
195.       return addCustomResourceToService(this.provider, 'eventBridge', iamRoleStatements);
196.     }


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 199 - 206
Content:
199.   existingS3Buckets() {
200.     const { service } = this.serverless;
201.     const { provider } = service;
202.     const { compiledCloudFormationTemplate } = provider;
203.     const { Resources } = compiledCloudFormationTemplate;
204.     const iamRoleStatements = [];
205. 
206.     // used to keep track of the custom resources created for each bucket


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 284 - 291
Content:
284.               iamRoleStatements.push({
285.                 Effect: 'Allow',
286.                 Resource: {
287.                   'Fn::Join': [':', ['arn', { Ref: 'AWS::Partition' }, 's3', '', '', bucket]],
288.                 },
289.                 Action: ['s3:PutBucketNotification', 's3:GetBucketNotification'],
290.               });
291.             } else {


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 303 - 321
Content:
303.       if (funcUsesExistingS3Bucket) {
304.         iamRoleStatements.push({
305.           Effect: 'Allow',
306.           Resource: {
307.             'Fn::Join': [
308.               ':',
309.               [
310.                 'arn',
311.                 { Ref: 'AWS::Partition' },
312.                 'lambda',
313.                 { Ref: 'AWS::Region' },
314.                 { Ref: 'AWS::AccountId' },
315.                 'function',
316.                 FunctionName,
317.               ],
318.             ],
319.           },
320.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],
321.         });


File: lib/plugins/aws/package/compile/events/s3/index.js
Line number range: 341 - 343
Content:
341.     if (iamRoleStatements.length) {
342.       return addCustomResourceToService(this.provider, 's3', iamRoleStatements);
343.     }


File: lib/plugins/aws/package/compile/events/sqs/index.js
Line number range: 131 - 170
Content:
131.                   "FunctionName": {
132.                     "Fn::GetAtt": [
133.                       "${lambdaLogicalId}",
134.                       "Arn"
135.                     ]
136.                   },
137.                   "Enabled": "${Enabled}"
138.                 }
139.               }
140.             `;
141. 
142.             // add event source ARNs to PolicyDocument statements
143.             sqsStatement.Resource.push(EventSourceArn);
144. 
145.             const newSQSObject = {
146.               [queueLogicalId]: JSON.parse(sqsTemplate),
147.             };
148. 
149.             _.merge(
150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
151.               newSQSObject
152.             );
153.           }
154.         });
155. 
156.         // update the PolicyDocument statements (if default policy is used)
157.         if (
158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources
159.             .IamRoleLambdaExecution
160.         ) {
161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate
162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
163.           if (sqsStatement.Resource.length) {
164.             statement.push(sqsStatement);
165.           }
166.         }
167.       }
168.     });
169.   }
170. }


File: lib/plugins/aws/package/compile/events/stream/index.js
Line number range: 200 - 228
Content:
200.             const newStreamObject = {
201.               [streamLogicalId]: streamResource,
202.             };
203. 
204.             _.merge(
205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
206.               newStreamObject
207.             );
208.           }
209.         });
210. 
211.         // update the PolicyDocument statements (if default policy is used)
212.         if (
213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.             .IamRoleLambdaExecution
215.         ) {
216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate
217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;
218.           if (dynamodbStreamStatement.Resource.length) {
219.             statement.push(dynamodbStreamStatement);
220.           }
221.           if (kinesisStreamStatement.Resource.length) {
222.             statement.push(kinesisStreamStatement);
223.           }
224.         }
225.       }
226.     });
227.   }
228. }


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 35 - 75
Content:
35.   compileRole(newFunction, role) {
36.     const compiledFunction = newFunction;
37.     const unnsupportedRoleError = new this.serverless.classes.Error(
38.       `Unsupported role provided: "${JSON.stringify(role)}"`
39.     );
40. 
41.     switch (typeof role) {
42.       case 'object':
43.         if ('Fn::GetAtt' in role) {
44.           // role is an "Fn::GetAtt" object
45.           compiledFunction.Properties.Role = role;
46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
47.             role['Fn::GetAtt'][0]
48.           );
49.         } else if ('Fn::ImportValue' in role) {
50.           // role is an "Fn::ImportValue" object
51.           compiledFunction.Properties.Role = role;
52.         } else {
53.           throw unnsupportedRoleError;
54.         }
55.         break;
56.       case 'string':
57.         if (role.startsWith('arn:aws')) {
58.           // role is a statically definied iam arn
59.           compiledFunction.Properties.Role = role;
60.         } else if (role === 'IamRoleLambdaExecution') {
61.           // role is the default role generated by the framework
62.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(
64.             'IamRoleLambdaExecution'
65.           );
66.         } else {
67.           // role is a Logical Role Name
68.           compiledFunction.Properties.Role = { 'Fn::GetAtt': [role, 'Arn'] };
69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);
70.         }
71.         break;
72.       default:
73.         throw unnsupportedRoleError;
74.     }
75.   }


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 216 - 240
Content:
216. 
217.           newFunction.Properties.DeadLetterConfig = {
218.             TargetArn: arn,
219.           };
220. 
221.           if (dlqType === 'sns') {
222.             stmt = {
223.               Effect: 'Allow',
224.               Action: ['sns:Publish'],
225.               Resource: [arn],
226.             };
227.           } else if (dlqType === 'sqs') {
228.             const errorMessage = [
229.               'onError currently only supports SNS topic arns due to a',
230.               ' race condition when using SQS queue arns and updating the IAM role.',
231.               ' Please check the docs for more info.',
232.             ].join('');
233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));
234.           }
235. 
236.           // update the PolicyDocument statements (if default policy is used)
237.           if (iamRoleLambdaExecution) {
238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);
239.           }
240.         } else {


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 271 - 289
Content:
271.           const iamRoleLambdaExecution = this.serverless.service.provider
272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;
273. 
274.           newFunction.Properties.KmsKeyArn = arn;
275. 
276.           const stmt = {
277.             Effect: 'Allow',
278.             Action: ['kms:Decrypt'],
279.             Resource: [arn],
280.           };
281. 
282.           // update the PolicyDocument statements (if default policy is used)
283.           if (iamRoleLambdaExecution) {
284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
286.               [stmt],
287.               _.isEqual
288.             );
289.           }


File: lib/plugins/aws/package/compile/functions/index.js
Line number range: 319 - 333
Content:
319.         const stmt = {
320.           Effect: 'Allow',
321.           Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],
322.           Resource: ['*'],
323.         };
324. 
325.         // update the PolicyDocument statements (if default policy is used)
326.         if (iamRoleLambdaExecution) {
327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(
328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,
329.             [stmt],
330.             _.isEqual
331.           );
332.         }
333.       } else {


File: lib/plugins/aws/package/index.js
Line number range: 10 - 10
Content:
10. const mergeIamTemplates = require('./lib/mergeIamTemplates');


File: lib/plugins/aws/package/index.js
Line number range: 23 - 31
Content:
23.     Object.assign(
24.       this,
25.       generateCoreTemplate,
26.       mergeIamTemplates,
27.       generateArtifactDirectoryName,
28.       mergeCustomProviderResources,
29.       saveServiceState,
30.       saveCompiledTemplate
31.     );


File: lib/plugins/aws/package/index.js
Line number range: 60 - 61
Content:
60.       'package:setupProviderConfiguration': () => BbPromise.bind(this).then(this.mergeIamTemplates),
61. 


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 8 - 12
Content:
8.   mergeIamTemplates() {
9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);
10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);
11.     return this.merge();
12.   },


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 44 - 58
Content:
44.     // resolve early if provider level role is provided
45.     if ('role' in this.serverless.service.provider) {
46.       return BbPromise.resolve();
47.     }
48. 
49.     // resolve early if all functions contain a custom role
50.     const customRolesProvided = [];
51.     this.serverless.service.getAllFunctions().forEach(functionName => {
52.       const functionObject = this.serverless.service.getFunction(functionName);
53.       customRolesProvided.push('role' in functionObject);
54.     });
55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {
56.       return BbPromise.resolve();
57.     }
58. 


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 59 - 76
Content:
59.     // merge in the iamRoleLambdaTemplate
60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(
61.       path.join(
62.         this.serverless.config.serverlessPath,
63.         'plugins',
64.         'aws',
65.         'package',
66.         'lib',
67.         'iam-role-lambda-execution-template.json'
68.       )
69.     );
70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();
71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();
72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();
73. 
74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,
76.     });


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 83 - 86
Content:
83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate
84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument
85.       .Statement;
86. 


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 129 - 136
Content:
129.     if (this.serverless.service.provider.iamRoleStatements) {
130.       // add custom iam role statements
131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[
132.         this.provider.naming.getRoleLogicalId()
133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(
134.         this.serverless.service.provider.iamRoleStatements
135.       );
136.     }


File: lib/plugins/aws/package/lib/mergeIamTemplates.js
Line number range: 184 - 216
Content:
184.   validateStatements(statements) {
185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
186.     // Action: ..., Resource: ... } objects.
187.     if (!statements) {
188.       return;
189.     }
190.     let violationsFound;
191.     if (!(statements instanceof Array)) {
192.       violationsFound = 'it is not an array';
193.     } else {
194.       const descriptions = statements.map((statement, i) => {
195.         const missing = ['Effect', 'Action', 'Resource'].filter(
196.           prop => statement[prop] === undefined
197.         );
198.         return missing.length === 0
199.           ? null
200.           : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
201.       });
202.       const flawed = descriptions.filter(curr => curr);
203.       if (flawed.length) {
204.         violationsFound = flawed.join('; ');
205.       }
206.     }
207. 
208.     if (violationsFound) {
209.       const errorMessage = [
210.         'iamRoleStatements should be an array of objects,',
211.         ' where each object has Effect, Action, Resource fields.',
212.         ` Specifically, ${violationsFound}`,
213.       ].join('');
214.       throw new this.serverless.classes.Error(errorMessage);
215.     }
216.   },


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const AWS = require('aws-sdk');
4. const BbPromise = require('bluebird');
5. const HttpsProxyAgent = require('https-proxy-agent');
6. const url = require('url');
7. const chalk = require('chalk');
8. const _ = require('lodash');
9. const userStats = require('../../../utils/userStats');
10. const naming = require('../lib/naming.js');
11. const https = require('https');
12. const fs = require('fs');
13. const objectHash = require('object-hash');
14. const PromiseQueue = require('promise-queue');
15. const getS3EndpointForRegion = require('../utils/getS3EndpointForRegion');
16. const readline = require('readline');
17. 
18. const constants = {
19.   providerName: 'aws',
20. };
21. 
22. PromiseQueue.configure(BbPromise.Promise);
23. 
24. const impl = {
25.   /**
26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid
27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for
28.    * whak-a-mole!
29.    * @param credentials The credentials to test for validity
30.    * @return {boolean} Whether the given credentials were valid
31.    */
32.   validCredentials: credentials => {
33.     let result = false;
34.     if (credentials) {
35.       if (
36.         // valid credentials loaded
37.         (credentials.accessKeyId &&
38.           credentials.accessKeyId !== 'undefined' &&
39.           credentials.secretAccessKey &&
40.           credentials.secretAccessKey !== 'undefined') ||
41.         // a role to assume has been successfully loaded, the associated STS request has been
42.         // sent, and the temporary credentials will be asynchronously delivered.
43.         credentials.roleArn
44.       ) {
45.         result = true;
46.       }
47.     }
48.     return result;
49.   },
50.   /**
51.    * Add credentials, if present, to the given results
52.    * @param results The results to add the given credentials to if they are valid
53.    * @param credentials The credentials to validate and add to the results if valid
54.    */
55.   addCredentials: (results, credentials) => {
56.     if (impl.validCredentials(credentials)) {
57.       results.credentials = credentials; // eslint-disable-line no-param-reassign
58.     }
59.   },
60.   /**
61.    * Add credentials, if present, from the environment
62.    * @param results The results to add environment credentials to
63.    * @param prefix The environment variable prefix to use in extracting credentials
64.    */
65.   addEnvironmentCredentials: (results, prefix) => {
66.     if (prefix) {
67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);
68.       impl.addCredentials(results, environmentCredentials);
69.     }
70.   },
71.   /**
72.    * Add credentials from a profile, if the profile and credentials for it exists
73.    * @param results The results to add profile credentials to
74.    * @param profile The profile to load credentials from
75.    */
76.   addProfileCredentials: (results, profile) => {
77.     if (profile) {
78.       const params = { profile };
79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {
80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;
81.       }
82. 
83.       // Setup a MFA callback for asking the code from the user.
84.       params.tokenCodeFn = (mfaSerial, callback) => {
85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {
87.           rl.close();
88.           callback(null, answer);
89.         });
90.       };
91. 
92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);
93.       if (
94.         !(
95.           profileCredentials.accessKeyId ||
96.           profileCredentials.sessionToken ||
97.           profileCredentials.roleArn
98.         )
99.       ) {
100.         throw new Error(`Profile ${profile} does not exist`);
101.       }
102. 
103.       impl.addCredentials(results, profileCredentials);
104.     }
105.   },
106.   /**
107.    * Add credentials, if present, from a profile that is specified within the environment
108.    * @param results The prefix of the profile's declaration in the environment
109.    * @param prefix The prefix for the environment variable
110.    */
111.   addEnvironmentProfile: (results, prefix) => {
112.     if (prefix) {
113.       const profile = process.env[`${prefix}_PROFILE`];
114.       impl.addProfileCredentials(results, profile);
115.     }
116.   },
117. };
118. 
119. class AwsProvider {
120.   static getProviderName() {
121.     return constants.providerName;
122.   }
123. 
124.   constructor(serverless, options) {
125.     this.naming = { provider: this };
126.     this.options = options;
127.     this.provider = this; // only load plugin in an AWS service context
128.     this.serverless = serverless;
129.     this.sdk = AWS;
130.     this.serverless.setProvider(constants.providerName, this);
131.     if (this.serverless.service.provider.name === 'aws') {
132.       this.serverless.service.provider.region = this.getRegion();
133.     }
134.     this.requestCache = {};
135.     this.requestQueue = new PromiseQueue(2, Infinity);
136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).
137.     this.cachedCredentials = null;
138. 
139.     Object.assign(this.naming, naming);
140. 
141.     // Activate AWS SDK loggin
142.     if (process.env.SLS_DEBUG) {
143.       AWS.config.logger = this.serverless.cli;
144.     }
145. 
146.     // Use HTTPS Proxy (Optional)
147.     const proxy =
148.       process.env.proxy ||
149.       process.env.HTTP_PROXY ||
150.       process.env.http_proxy ||
151.       process.env.HTTPS_PROXY ||
152.       process.env.https_proxy;
153. 
154.     const proxyOptions = {};
155.     if (proxy) {
156.       Object.assign(proxyOptions, url.parse(proxy));
157.     }
158. 
159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;
160. 
161.     let caCerts = [];
162. 
163.     if (ca) {
164.       // Can be a single certificate or multiple, comma separated.
165.       const caArr = ca.split(',');
166.       // Replace the newline -- https://stackoverflow.com/questions/30400341
167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\n/g, '\n')));
168.     }
169. 
170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;
171. 
172.     if (cafile) {
173.       // Can be a single certificate file path or multiple paths, comma separated.
174.       const caPathArr = cafile.split(',');
175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));
176.     }
177. 
178.     if (caCerts.length > 0) {
179.       Object.assign(proxyOptions, {
180.         rejectUnauthorized: true,
181.         ca: caCerts,
182.       });
183.     }
184. 
185.     // Passes also certifications
186.     if (proxy) {
187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);
188.     } else if (proxyOptions.ca) {
189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html
190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);
191.     }
192. 
193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)
194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;
195.     if (timeout) {
196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);
197.     }
198. 
199.     // Support deploymentBucket configuration as an object
200.     const provider = this.serverless.service.provider;
201.     if (provider && provider.deploymentBucket) {
202.       if (_.isObject(provider.deploymentBucket)) {
203.         // store the object in a new variable so that it can be reused later on
204.         provider.deploymentBucketObject = provider.deploymentBucket;
205.         if (provider.deploymentBucket.name) {
206.           // (re)set the value of the deploymentBucket property to the name (which is a string)
207.           provider.deploymentBucket = provider.deploymentBucket.name;
208.         } else {
209.           provider.deploymentBucket = null;
210.         }
211.       }
212.     }
213.   }
214. 
215.   /**
216.    * Execute an AWS request by calling the AWS SDK
217.    * @param {string} service - Service name
218.    * @param {string} method - Method name
219.    * @param {Object} params - Parameters
220.    * @param {Object} [options] - Options to modify the request behavior
221.    * @prop [options.useCache] - Utilize cache to retrieve results
222.    * @prop [options.region] - Specify when to request to different region
223.    */
224.   request(service, method, params, options) {
225.     const that = this;
226.     const credentials = Object.assign({}, that.getCredentials());
227.     // Make sure options is an object (honors wrong calls of request)
228.     const requestOptions = _.isObject(options) ? options : {};
229.     const shouldCache = _.get(requestOptions, 'useCache', false);
230.     const paramsWithRegion = _.merge({}, params, {
231.       region: _.get(options, 'region'),
232.     });
233.     const paramsHash = objectHash.sha1(paramsWithRegion);
234.     const MAX_TRIES = 4;
235.     const persistentRequest = f =>
236.       new BbPromise((resolve, reject) => {
237.         const doCall = numTry => {
238.           f()
239.             // We're resembling if/else logic, therefore single `then` instead of `then`/`catch` pair
240.             .then(resolve, e => {
241.               if (
242.                 numTry < MAX_TRIES &&
243.                 e.statusCode !== 403 && // Invalid credentials
244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)
245.               ) {
246.                 that.serverless.cli.log(
247.                   _.join(
248.                     [
249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,
250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,
251.                     ],
252.                     ' '
253.                   )
254.                 );
255.                 setTimeout(doCall, 5000, numTry + 1);
256.               } else {
257.                 reject(e);
258.               }
259.             });
260.         };
261.         return doCall(0);
262.       });
263. 
264.     // Emit a warning for misuses of the old signature including stage and region
265.     // TODO: Determine calling module and log that
266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {
267.       this.serverless.cli.log('WARNING: Inappropriate call of provider.request()');
268.     }
269. 
270.     // Support S3 Transfer Acceleration
271.     if (this.canUseS3TransferAcceleration(service, method)) {
272.       this.enableS3TransferAcceleration(credentials);
273.     }
274. 
275.     if (shouldCache) {
276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);
277.       if (cachedRequest) {
278.         return BbPromise.resolve(cachedRequest);
279.       }
280.     }
281. 
282.     const request = this.requestQueue.add(() =>
283.       persistentRequest(() => {
284.         if (options && !_.isUndefined(options.region)) {
285.           credentials.region = options.region;
286.         }
287.         const awsService = new that.sdk[service](credentials);
288.         const req = awsService[method](params);
289. 
290.         // TODO: Add listeners, put Debug statments here...
291.         // req.on('send', function (r) {console.log(r)});
292. 
293.         const promise = req.promise
294.           ? req.promise()
295.           : BbPromise.fromCallback(cb => {
296.               req.send(cb);
297.             });
298.         return promise.catch(err => {
299.           let message = err.message !== null ? err.message : err.code;
300.           if (err.message === 'Missing credentials in config') {
301.             const errorMessage = [
302.               'AWS provider credentials not found.',
303.               ' Learn how to set up AWS provider credentials',
304.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
305.             ].join('');
306.             message = errorMessage;
307.             userStats.track('user_awsCredentialsNotFound');
308.             // We do not want to trigger the retry mechanism for credential errors
309.             return BbPromise.reject(
310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
311.                 providerError: _.assign({}, err, { retryable: false }),
312.               })
313.             );
314.           }
315. 
316.           return BbPromise.reject(
317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {
318.               providerError: err,
319.             })
320.           );
321.         });
322.       }).then(data => {
323.         const result = BbPromise.resolve(data);
324.         if (shouldCache) {
325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);
326.         }
327.         return result;
328.       })
329.     );
330. 
331.     if (shouldCache) {
332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);
333.     }
334. 
335.     return request;
336.   }
337. 
338.   /**
339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the
340.    * well known environment variables
341.    * @returns {{region: *}}
342.    */
343.   getCredentials() {
344.     if (this.cachedCredentials) {
345.       // We have already created the credentials object once, so return it.
346.       return this.cachedCredentials;
347.     }
348.     const result = {};
349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;
350. 
351.     // add specified credentials, overriding with more specific declarations
352.     try {
353.       impl.addProfileCredentials(result, 'default');
354.     } catch (err) {
355.       if (err.message !== 'Profile default does not exist') {
356.         throw err;
357.       }
358.     }
359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds
360.     if (this.serverless.service.provider.profile && !this.options['aws-profile']) {
361.       // config profile
362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);
363.     }
364.     impl.addEnvironmentCredentials(result, 'AWS'); // creds for all stages
365.     impl.addEnvironmentProfile(result, 'AWS');
366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds
367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);
368.     if (this.options['aws-profile']) {
369.       impl.addProfileCredentials(result, this.options['aws-profile']); // CLI option profile
370.     }
371.     result.region = this.getRegion();
372. 
373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;
374.     if (
375.       deploymentBucketObject &&
376.       deploymentBucketObject.serverSideEncryption &&
377.       deploymentBucketObject.serverSideEncryption === 'aws:kms'
378.     ) {
379.       result.signatureVersion = 'v4';
380.     }
381. 
382.     // Store the credentials to avoid creating them again (messes up MFA).
383.     this.cachedCredentials = result;
384.     return result;
385.   }
386. 
387.   canUseS3TransferAcceleration(service, method) {
388.     // TODO enable more S3 APIs?
389.     return (
390.       service === 'S3' &&
391.       ['upload', 'putObject'].indexOf(method) !== -1 &&
392.       this.isS3TransferAccelerationEnabled()
393.     );
394.   }
395. 
396.   // This function will be used to block the addition of transfer acceleration options
397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)
398.   isS3TransferAccelerationSupported() {
399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)
400.     // since those regions do not yet support it
401.     const endpoint = getS3EndpointForRegion(this.getRegion());
402.     return endpoint === 's3.amazonaws.com';
403.   }
404. 
405.   isS3TransferAccelerationEnabled() {
406.     return !!this.options['aws-s3-accelerate'];
407.   }
408. 
409.   isS3TransferAccelerationDisabled() {
410.     return !!this.options['no-aws-s3-accelerate'];
411.   }
412. 
413.   disableTransferAccelerationForCurrentDeploy() {
414.     delete this.options['aws-s3-accelerate'];
415.   }
416. 
417.   enableS3TransferAcceleration(credentials) {
418.     this.serverless.cli.log('Using S3 Transfer Acceleration Endpoint...');
419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign
420.   }
421. 
422.   getValues(source, paths) {
423.     return paths.map(path => ({
424.       path,
425.       value: _.get(source, path.join('.')),
426.     }));
427.   }
428.   firstValue(values) {
429.     return values.reduce((result, current) => {
430.       return result.value ? result : current;
431.     }, {});
432.   }
433. 
434.   getRegionSourceValue() {
435.     const values = this.getValues(this, [
436.       ['options', 'region'],
437.       ['serverless', 'config', 'region'],
438.       ['serverless', 'service', 'provider', 'region'],
439.     ]);
440.     return this.firstValue(values);
441.   }
442.   getRegion() {
443.     const defaultRegion = 'us-east-1';
444.     const regionSourceValue = this.getRegionSourceValue();
445.     return regionSourceValue.value || defaultRegion;
446.   }
447. 
448.   getProfileSourceValue() {
449.     const values = this.getValues(this, [
450.       ['options', 'aws-profile'],
451.       ['options', 'profile'],
452.       ['serverless', 'config', 'profile'],
453.       ['serverless', 'service', 'provider', 'profile'],
454.     ]);
455.     const firstVal = this.firstValue(values);
456.     return firstVal ? firstVal.value : null;
457.   }
458.   getProfile() {
459.     return this.getProfileSourceValue();
460.   }
461. 
462.   getServerlessDeploymentBucketName() {
463.     if (this.serverless.service.provider.deploymentBucket) {
464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);
465.     }
466.     return this.request('CloudFormation', 'describeStackResource', {
467.       StackName: this.naming.getStackName(),
468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),
469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);
470.   }
471. 
472.   getDeploymentPrefix() {
473.     return this.serverless.service.provider.deploymentPrefix || 'serverless';
474.   }
475. 
476.   getLogRetentionInDays() {
477.     if (!_.has(this.serverless.service.provider, 'logRetentionInDays')) {
478.       return null;
479.     }
480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;
481.     const retentionInDays = parseInt(rawRetentionInDays, 10);
482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {
483.       return retentionInDays;
484.     }
485. 
486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;
487.     throw new this.serverless.classes.Error(errorMessage);
488.   }
489. 
490.   getStageSourceValue() {
491.     const values = this.getValues(this, [
492.       ['options', 'stage'],
493.       ['serverless', 'config', 'stage'],
494.       ['serverless', 'service', 'provider', 'stage'],
495.     ]);
496.     return this.firstValue(values);
497.   }
498.   getStage() {
499.     const defaultStage = 'dev';
500.     const stageSourceValue = this.getStageSourceValue();


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 500 - 1000
Content:
500.     const stageSourceValue = this.getStageSourceValue();
501.     return stageSourceValue.value || defaultStage;
502.   }
503. 
504.   getAccountId() {
505.     return this.getAccountInfo().then(result => result.accountId);
506.   }
507. 
508.   getAccountInfo() {
509.     return this.request('STS', 'getCallerIdentity', {}).then(result => {
510.       const arn = result.Arn;
511.       const accountId = result.Account;
512.       const partition = _.nth(_.split(arn, ':'), 1); // ex: arn:aws:iam:acctId:user/xyz
513.       return {
514.         accountId,
515.         partition,
516.         arn: result.Arn,
517.         userId: result.UserId,
518.       };
519.     });
520.   }
521. 
522.   /**
523.    * Get API Gateway Rest API ID from serverless config
524.    */
525.   getApiGatewayRestApiId() {
526.     if (
527.       this.serverless.service.provider.apiGateway &&
528.       this.serverless.service.provider.apiGateway.restApiId
529.     ) {
530.       return this.serverless.service.provider.apiGateway.restApiId;
531.     }
532. 
533.     return { Ref: this.naming.getRestApiLogicalId() };
534.   }
535. 
536.   getApiGatewayDescription() {
537.     if (
538.       this.serverless.service.provider.apiGateway &&
539.       this.serverless.service.provider.apiGateway.description
540.     ) {
541.       return this.serverless.service.provider.apiGateway.description;
542.     }
543.     return undefined;
544.   }
545. 
546.   getMethodArn(accountId, apiId, method, pathParam) {
547.     const region = this.getRegion();
548.     let path = pathParam;
549.     if (pathParam.startsWith('/')) {
550.       path = pathParam.replace(/^\/+/g, '');
551.     }
552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;
553.   }
554. 
555.   /**
556.    * Get Rest API Root Resource ID from serverless config
557.    */
558.   getApiGatewayRestApiRootResourceId() {
559.     if (
560.       this.serverless.service.provider.apiGateway &&
561.       this.serverless.service.provider.apiGateway.restApiRootResourceId
562.     ) {
563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;
564.     }
565.     return { 'Fn::GetAtt': [this.naming.getRestApiLogicalId(), 'RootResourceId'] };
566.   }
567. 
568.   /**
569.    * Get Rest API Predefined Resources from serverless config
570.    */
571.   getApiGatewayPredefinedResources() {
572.     if (
573.       !this.serverless.service.provider.apiGateway ||
574.       !this.serverless.service.provider.apiGateway.restApiResources
575.     ) {
576.       return [];
577.     }
578. 
579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {
580.       return this.serverless.service.provider.apiGateway.restApiResources;
581.     }
582. 
583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== 'object') {
584.       throw new Error('REST API resource must be an array of object');
585.     }
586. 
587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({
588.       path: key,
589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],
590.     }));
591.   }
592. 
593.   /**
594.    * Get API Gateway websocket API ID from serverless config
595.    */
596.   getApiGatewayWebsocketApiId() {
597.     if (
598.       this.serverless.service.provider.apiGateway &&
599.       this.serverless.service.provider.apiGateway.websocketApiId
600.     ) {
601.       return this.serverless.service.provider.apiGateway.websocketApiId;
602.     }
603. 
604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };
605.   }
606. 
607.   getStackResources(next, resourcesParam) {
608.     let resources = resourcesParam;
609.     const params = {
610.       StackName: this.naming.getStackName(),
611.     };
612.     if (!resources) resources = [];
613.     if (next) params.NextToken = next;
614. 
615.     return this.request('CloudFormation', 'listStackResources', params).then(res => {
616.       const allResources = resources.concat(res.StackResourceSummaries);
617.       if (!res.NextToken) {
618.         return allResources;
619.       }
620.       return this.getStackResources(res.NextToken, allResources);
621.     });
622.   }
623. }
624. 
625. module.exports = AwsProvider;

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 21:18:03,856 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The feature concerns allowing NotAction/NotResource in provider.iamRoleStatements. The provided context includes the exact validator that rejects such statements (lib/plugins/aws/package/lib/mergeIamTemplates.js – validateStatements requires Action and Resource), the merging logic that injects iamRoleStatements into the default role, relevant AWS provider and naming patterns, and IAM docs. No other critical dependencies or referenced modules are missing for understanding and implementing this change.' query='' extra_requirements='' purpose='This context is sufficient to identify where to modify validation and how iamRoleStatements are merged, ensuring consistent integration.'
2025-11-13 21:18:03,861 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/guide/iam.md', content="19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: 'Allow'\n32.       Action:\n33.         - 's3:ListBucket'\n34.       Resource:\n35.         Fn::Join:\n36.           - ''\n37.           - - 'arn:aws:s3:::'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: 'Allow'\n40.       Action:\n41.         - 's3:PutObject'\n42.       Resource:\n43.         Fn::Join:\n44.           - ''\n45.           - - 'arn:aws:s3:::'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - '/*'\n48. ```", start_line_number=19, end_line_number=48), Context(relative_path='docs/providers/aws/guide/iam.md', content="50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - 'some:aws:arn:xxx:*:*'\n59.     - 'someOther:aws:arn:xxx:*:*'\n60.     - { 'Fn::Join': [':', ['arn:aws:iam:', { Ref: 'AWSAccountId' }, 'some/path']] }\n61. ```", start_line_number=50, end_line_number=61), Context(relative_path='docs/providers/aws/guide/iam.md', content="63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you've defined on the `provider` level won't be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.", start_line_number=63, end_line_number=71), Context(relative_path='lib/plugins/aws/customResources/index.js', content="89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: 'AWS::IAM::Role',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: '2012-10-17',\n96.               Statement: [\n97.                 {\n98.                   Effect: 'Allow',\n99.                   Principal: {\n100.                     Service: ['lambda.amazonaws.com'],\n101.                   },\n102.                   Action: ['sts:AssumeRole'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   'Fn::Join': [\n110.                     '-',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       'custom-resources-lambda',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: '2012-10-17',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: 'Allow',\n132.               Action: ['logs:CreateLogStream'],\n133.               Resource: [\n134.                 {\n135.                   'Fn::Sub':\n136.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: 'Allow',\n143.               Action: ['logs:PutLogEvents'],\n144.               Resource: [\n145.                 {\n146.                   'Fn::Sub':\n147.                     'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });", start_line_number=89, end_line_number=160), Context(relative_path='lib/plugins/aws/deployFunction/index.js', content="71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === 'string') {\n77.       if (role.indexOf(':') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== 'AWS::IAM::Role') {\n81.           throw new Error('Provided resource is not IAM Role.');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || '/'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request('IAM', 'getRole', {\n99.         RoleName: role['Fn::GetAtt'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request('Lambda', 'updateFunctionConfiguration', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };", start_line_number=71, end_line_number=116), Context(relative_path='lib/plugins/aws/lib/naming.js', content="86.   // Role\n87.   getRolePath() {\n88.     return '/';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       'Fn::Join': [\n93.         '-',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: 'AWS::Region' },\n98.           'lambdaRole',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return 'IamRoleLambdaExecution';\n105.   },\n106. ", start_line_number=86, end_line_number=106), Context(relative_path='lib/plugins/aws/lib/naming.js', content="107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       'Fn::Join': [\n112.         '-',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           'lambda',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. ", start_line_number=107, end_line_number=122), Context(relative_path='lib/plugins/aws/lib/naming.js', content="447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return 'custom-resources';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return 'IamRoleCustomResourcesLambdaExecution';\n453.   },", start_line_number=447, end_line_number=453), Context(relative_path='lib/plugins/aws/lib/validate.js', content="1. 'use strict';\n2. \n3. const BbPromise = require('bluebird');\n4. const chalk = require('chalk');\n5. const userStats = require('../../../utils/userStats');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         'This command can only be run inside a service directory'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       !['logs', 'info', 'deploy', 'remove', 'rollback', 'metrics', 'invoke'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === 'local'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request('/', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               'AWS provider credentials not found.',\n52.               ' Learn how to set up AWS provider credentials',\n53.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,\n54.             ].join('');\n55.             userStats.track('user_awsCredentialsNotFound');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };", start_line_number=1, end_line_number=62), Context(relative_path='lib/plugins/aws/package/compile/events/cloudFront/index.js', content="200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== 'us-east-1') {\n227.         throw new ServerlessError(\n228.           'CloudFront associated functions have to be deployed to the us-east-1 region.'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: 'AWS::Lambda::Permission',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: 'lambda:InvokeFunction',\n244.               Principal: 'edgelambda.amazonaws.com',\n245.               SourceArn: {\n246.                 'Fn::Join': [\n247.                   '',\n248.                   [\n249.                     '',\n250.                     'arn:aws:cloudfront::',\n251.                     { Ref: 'AWS::AccountId' },\n252.                     ':distribution/',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,", start_line_number=200, end_line_number=260), Context(relative_path='lib/plugins/aws/package/compile/events/cognitoUserPool/index.js', content='20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }', start_line_number=20, end_line_number=364), Context(relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', content='21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {', start_line_number=21, end_line_number=23), Context(relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', content="146.                 iamRoleStatements.push({\n147.                   Effect: 'Allow',\n148.                   Resource: eventBusResource,\n149.                   Action: ['events:CreateEventBus', 'events:DeleteEventBus'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: 'Allow',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   'events:PutRule',\n158.                   'events:RemoveTargets',\n159.                   'events:PutTargets',\n160.                   'events:DeleteRule',\n161.                 ],\n162.               });", start_line_number=146, end_line_number=162), Context(relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', content="174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: 'Allow',\n177.           Resource: {\n178.             'Fn::Join': [\n179.               ':',\n180.               [\n181.                 'arn:aws:lambda',\n182.                 { Ref: 'AWS::Region' },\n183.                 { Ref: 'AWS::AccountId' },\n184.                 'function',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],\n190.         });", start_line_number=174, end_line_number=190), Context(relative_path='lib/plugins/aws/package/compile/events/eventBridge/index.js', content="194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, 'eventBridge', iamRoleStatements);\n196.     }", start_line_number=194, end_line_number=196), Context(relative_path='lib/plugins/aws/package/compile/events/s3/index.js', content='199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket', start_line_number=199, end_line_number=206), Context(relative_path='lib/plugins/aws/package/compile/events/s3/index.js', content="284.               iamRoleStatements.push({\n285.                 Effect: 'Allow',\n286.                 Resource: {\n287.                   'Fn::Join': [':', ['arn', { Ref: 'AWS::Partition' }, 's3', '', '', bucket]],\n288.                 },\n289.                 Action: ['s3:PutBucketNotification', 's3:GetBucketNotification'],\n290.               });\n291.             } else {", start_line_number=284, end_line_number=291), Context(relative_path='lib/plugins/aws/package/compile/events/s3/index.js', content="303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: 'Allow',\n306.           Resource: {\n307.             'Fn::Join': [\n308.               ':',\n309.               [\n310.                 'arn',\n311.                 { Ref: 'AWS::Partition' },\n312.                 'lambda',\n313.                 { Ref: 'AWS::Region' },\n314.                 { Ref: 'AWS::AccountId' },\n315.                 'function',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: ['lambda:AddPermission', 'lambda:RemovePermission'],\n321.         });", start_line_number=303, end_line_number=321), Context(relative_path='lib/plugins/aws/package/compile/events/s3/index.js', content="341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, 's3', iamRoleStatements);\n343.     }", start_line_number=341, end_line_number=343), Context(relative_path='lib/plugins/aws/package/compile/events/sqs/index.js', content='131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }', start_line_number=131, end_line_number=170), Context(relative_path='lib/plugins/aws/package/compile/events/stream/index.js', content='200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }', start_line_number=200, end_line_number=228), Context(relative_path='lib/plugins/aws/package/compile/functions/index.js', content='35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }', start_line_number=35, end_line_number=75), Context(relative_path='lib/plugins/aws/package/compile/functions/index.js', content="216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === 'sns') {\n222.             stmt = {\n223.               Effect: 'Allow',\n224.               Action: ['sns:Publish'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === 'sqs') {\n228.             const errorMessage = [\n229.               'onError currently only supports SNS topic arns due to a',\n230.               ' race condition when using SQS queue arns and updating the IAM role.',\n231.               ' Please check the docs for more info.',\n232.             ].join('');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {", start_line_number=216, end_line_number=240), Context(relative_path='lib/plugins/aws/package/compile/functions/index.js', content="271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: 'Allow',\n278.             Action: ['kms:Decrypt'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }", start_line_number=271, end_line_number=289), Context(relative_path='lib/plugins/aws/package/compile/functions/index.js', content="319.         const stmt = {\n320.           Effect: 'Allow',\n321.           Action: ['xray:PutTraceSegments', 'xray:PutTelemetryRecords'],\n322.           Resource: ['*'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {", start_line_number=319, end_line_number=333), Context(relative_path='lib/plugins/aws/package/index.js', content="10. const mergeIamTemplates = require('./lib/mergeIamTemplates');", start_line_number=10, end_line_number=10), Context(relative_path='lib/plugins/aws/package/index.js', content='23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );', start_line_number=23, end_line_number=31), Context(relative_path='lib/plugins/aws/package/index.js', content="60.       'package:setupProviderConfiguration': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. ", start_line_number=60, end_line_number=61), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content='8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },', start_line_number=8, end_line_number=12), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content="44.     // resolve early if provider level role is provided\n45.     if ('role' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push('role' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. ", start_line_number=44, end_line_number=58), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content="59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         'plugins',\n64.         'aws',\n65.         'package',\n66.         'lib',\n67.         'iam-role-lambda-execution-template.json'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });", start_line_number=59, end_line_number=76), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content='83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. ', start_line_number=83, end_line_number=86), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content='129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }', start_line_number=129, end_line_number=136), Context(relative_path='lib/plugins/aws/package/lib/mergeIamTemplates.js', content="184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = 'it is not an array';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = ['Effect', 'Action', 'Resource'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join('; ');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         'iamRoleStatements should be an array of objects,',\n211.         ' where each object has Effect, Action, Resource fields.',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join('');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },", start_line_number=184, end_line_number=216), Context(relative_path='lib/plugins/aws/provider/awsProvider.js', content="1. 'use strict';\n2. \n3. const AWS = require('aws-sdk');\n4. const BbPromise = require('bluebird');\n5. const HttpsProxyAgent = require('https-proxy-agent');\n6. const url = require('url');\n7. const chalk = require('chalk');\n8. const _ = require('lodash');\n9. const userStats = require('../../../utils/userStats');\n10. const naming = require('../lib/naming.js');\n11. const https = require('https');\n12. const fs = require('fs');\n13. const objectHash = require('object-hash');\n14. const PromiseQueue = require('promise-queue');\n15. const getS3EndpointForRegion = require('../utils/getS3EndpointForRegion');\n16. const readline = require('readline');\n17. \n18. const constants = {\n19.   providerName: 'aws',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== 'undefined' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== 'undefined') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile's declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === 'aws') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(',');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, '\\n')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(',');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, 'useCache', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, 'region'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We're resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     ' '\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log('WARNING: Inappropriate call of provider.request()');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on('send', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === 'Missing credentials in config') {\n301.             const errorMessage = [\n302.               'AWS provider credentials not found.',\n303.               ' Learn how to set up AWS provider credentials',\n304.               ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,\n305.             ].join('');\n306.             message = errorMessage;\n307.             userStats.track('user_awsCredentialsNotFound');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, 'default');\n354.     } catch (err) {\n355.       if (err.message !== 'Profile default does not exist') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options['aws-profile']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, 'AWS'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, 'AWS');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options['aws-profile']) {\n369.       impl.addProfileCredentials(result, this.options['aws-profile']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === 'aws:kms'\n378.     ) {\n379.       result.signatureVersion = 'v4';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === 'S3' &&\n391.       ['upload', 'putObject'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === 's3.amazonaws.com';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options['aws-s3-accelerate'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options['no-aws-s3-accelerate'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options['aws-s3-accelerate'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log('Using S3 Transfer Acceleration Endpoint...');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join('.')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       ['options', 'region'],\n437.       ['serverless', 'config', 'region'],\n438.       ['serverless', 'service', 'provider', 'region'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = 'us-east-1';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       ['options', 'aws-profile'],\n451.       ['options', 'profile'],\n452.       ['serverless', 'config', 'profile'],\n453.       ['serverless', 'service', 'provider', 'profile'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request('CloudFormation', 'describeStackResource', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || 'serverless';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, 'logRetentionInDays')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       ['options', 'stage'],\n493.       ['serverless', 'config', 'stage'],\n494.       ['serverless', 'service', 'provider', 'stage'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = 'dev';\n500.     const stageSourceValue = this.getStageSourceValue();", start_line_number=1, end_line_number=500), Context(relative_path='lib/plugins/aws/provider/awsProvider.js', content="500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request('STS', 'getCallerIdentity', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, ':'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith('/')) {\n550.       path = pathParam.replace(/^\\/+/g, '');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { 'Fn::GetAtt': [this.naming.getRestApiLogicalId(), 'RootResourceId'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== 'object') {\n584.       throw new Error('REST API resource must be an array of object');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request('CloudFormation', 'listStackResources', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;", start_line_number=500, end_line_number=1000)]
2025-11-13 21:18:03,865 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n' additional_kwargs={} response_metadata={}
2025-11-13 21:18:10,341 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ngWwEKO3DPGDIy1rz1GGfC1c', 'function': {'arguments': '{"query":"AWS IAM policy NotAction NotResource rules can you use NotAction with NotResource?"}', 'name': 'web_search'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 424, 'prompt_tokens': 17735, 'total_tokens': 18159, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d6d9e80a-0fda-47f3-9531-bb354d2ec406-0' tool_calls=[{'name': 'web_search', 'args': {'query': 'AWS IAM policy NotAction NotResource rules can you use NotAction with NotResource?'}, 'id': 'call_ngWwEKO3DPGDIy1rz1GGfC1c', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17735, 'output_tokens': 424, 'total_tokens': 18159, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 21:18:10,346 - thread-135845298308800.prometheus.tools.web_search - DEBUG - Query: AWS IAM policy NotAction NotResource rules can you use NotAction with NotResource?
2025-11-13 21:18:14,875 - thread-135845298308800.prometheus.tools.web_search - INFO - web_search format_response: Answer: In AWS IAM, you cannot use NotAction with NotResource together in a single policy statement. Use NotAction to specify denied actions and NotResource to specify resources that are not affected.

Sources:
- WildCard in NotResource: https://stackoverflow.com/questions/75269073/wildcard-in-notresource
- not_actions vs explicit deny & allow statements in an IAM ...: https://stackoverflow.com/questions/72104664/not-actions-vs-explicit-deny-allow-statements-in-an-iam-policy
- AWS IAM multiple policies with conflicting conditions: https://stackoverflow.com/questions/58066572/aws-iam-multiple-policies-with-conflicting-conditions
- How do I combine these two AWS-IAM policies to allow ...: https://stackoverflow.com/questions/77442087/how-do-i-combine-these-two-aws-iam-policies-to-allow-certain-actions-to-only-cer
- SCP to deny all resources except certain resources in AWS ...: https://stackoverflow.com/questions/71421347/scp-to-deny-all-resources-except-certain-resources-in-aws-organization

Detailed Results:

Title: WildCard in NotResource
URL: https://stackoverflow.com/questions/75269073/wildcard-in-notresource
Content: A policy statement element with NotResource applies to any resource that does not match the listed resource(s).

Title: not_actions vs explicit deny & allow statements in an IAM ...
URL: https://stackoverflow.com/questions/72104664/not-actions-vs-explicit-deny-allow-statements-in-an-iam-policy
Content: ```
data "aws_iam_policy_document" "kms_policy" { statement { sid = "AllowEKSKMSAccess" actions = [ "kms:" ] not_actions = [ "kms:Delete", "kms:ScheduleKeyDeletion", "kms:Revoke", "kms:Disable", ] resources = [""] } } 
```

Policy 2: [...] with `Allow` effect where you have the list of precise `Action`s, because you can always allow more than you should with wildcard ``, don't be lazy especially when you have AWS tools like IAM Policy Simulator
 with explicit ARNs for `Resource`s (at least precise the account), avoid `[]`

Since you are using Terraform, you have tools like Checkov for analyzing your code and giving you best practice tips.

Share

Improve this answer

answered Jul 7, 2022 at 9:21

gokan [...] I only use `not_actions` when I want to deny a lot of things to make the resulting IAM policy smaller, as I know it is guaranteed to be future proof if the policy is well-secured.

Share

Improve this answer

edited May 3, 2022 at 20:11

answered May 3, 2022 at 20:05

Ermiya Eskandary

24.4k44 gold badges5858 silver badges7272 bronze badges

Sign up to request clarification or add additional context in comments.

## 3 Comments

DmitrySemenov

DmitrySemenov

Title: AWS IAM multiple policies with conflicting conditions
URL: https://stackoverflow.com/questions/58066572/aws-iam-multiple-policies-with-conflicting-conditions
Content: Follow this answer to receive notifications

edited Jan 2, 2024 at 20:12

johnnyRose

7,5301717 gold badges4242 silver badges6161 bronze badges

answered Sep 23, 2019 at 18:15

WaltDeWaltDe

1,8701010 silver badges1717 bronze badges

5

 that says nothing about how conflicting conditions are merged

  red888

  – 
  red888

  2019-09-23 18:16:48 +00:00

  Commented
  Sep 23, 2019 at 18:16
 2 [...] Conditions are not merged, they are evaluated using boolean logic. I've updated my answer to explain multiple conditional statements. I'll be able to answer where question if you include the complete policy statements with the effect statements.

  WaltDe

  – 
  WaltDe

  2019-09-23 18:24:32 +00:00

  Commented
  Sep 23, 2019 at 18:24
 ill add to my question the actions and everything

  red888

  – 
  red888

  2019-09-23 18:28:31 +00:00 [...] My other question: I have one policy that has a condition and one does not. Both are attached to the same entity and target the same resources

One policy allows access to all resources with no conditions like this:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "secretsmanager:",
            "Resource": ""
        }
    ]
}

```

One policy has a condition:

Title: How do I combine these two AWS-IAM policies to allow ...
URL: https://stackoverflow.com/questions/77442087/how-do-i-combine-these-two-aws-iam-policies-to-allow-certain-actions-to-only-cer
Content: When combining AWS IAM policies, all statements are merged, and combining allow-only policies results in a more permissive policy, not less.

Title: SCP to deny all resources except certain resources in AWS ...
URL: https://stackoverflow.com/questions/71421347/scp-to-deny-all-resources-except-certain-resources-in-aws-organization
Content: I want to block all resources except EC2, RDS and global services in AWS Organization. Below is my SCP Policy.
2025-11-13 21:19:01,890 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content="Below is a high-level analysis and implementation plan to support IAM policy elements NotAction and NotResource in provider.iamRoleStatements.\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Allow users to specify IAM statements using NotAction and/or NotResource within provider.iamRoleStatements in serverless.yml.\n  - Currently, the framework rejects iamRoleStatements that do not contain Action and Resource. The request is to accept valid IAM statements that use NotAction and/or NotResource instead.\n\n- Requirements:\n  - Update validation to accept statements that define either Action or NotAction, and either Resource or NotResource, consistent with AWS IAM policy rules.\n  - Ensure statements using NotAction/NotResource are merged properly into the generated IAM Role and into any custom resource roles without being dropped or incorrectly deduped.\n  - Update documentation to reflect support and provide examples.\n\n- Ambiguities/edge cases to clarify and handle:\n  - Exclusivity:\n    - In a single policy statement, Action and NotAction must not both be present.\n    - Resource and NotResource must not both be present.\n  - Ensure validation requires at least one of {Action, NotAction} and at least one of {Resource, NotResource}.\n  - Deduplication logic should not incorrectly treat all statements with missing Resource as duplicates (e.g., two different NotResource statements must be handled distinctly).\n  - Complex CloudFormation intrinsics (Fn::Join, Ref, Fn::Sub, etc.) should continue to be supported on any of these fields.\n\n2) Architecture Analysis\n\n- Primary integration points:\n  - Validation and merging of provider.iamRoleStatements occurs in lib/plugins/aws/package/lib/mergeIamTemplates.js. This is where current validation enforces Action and Resource presence. It needs update.\n  - Custom resources role merging occurs in lib/plugins/aws/customResources/index.js where iamRoleStatements for custom resource handlers are appended and deduped using Resource-only equality checks. This needs update to consider NotResource and avoid false positives.\n\n- Files/modules impacted:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js\n    - validateStatements(...) function and associated error messages.\n    - mergeIamTemplates() path remains the same; only validation and concatenation need to support NotAction/NotResource.\n  - lib/plugins/aws/customResources/index.js\n    - Logic that pushes provider-level iamRoleStatements into custom resource role PolicyDocument (Statement deduping by Resource).\n  - Documentation:\n    - docs/providers/aws/guide/iam.md (add examples and explanation for NotAction and NotResource).\n\n- Architectural constraints/patterns:\n  - The framework largely passes-through IAM policy statements into CloudFormation templates; it should avoid imposing non-AWS constraints.\n  - Maintain backward compatibility: existing Action/Resource statements continue to work unmodified.\n  - Keep validation simple, but ensure it enforces mutually exclusive Action vs NotAction and Resource vs NotResource.\n\n3) Implementation Plan\n\nA) Update validation to accept NotAction/NotResource\n\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n  - Function: validateStatements(statements)\n  - Changes:\n    - Adjust validation rules:\n      - Each statement must include Effect.\n      - Each statement must include either Action or NotAction (exactly one of these).\n      - Each statement must include either Resource or NotResource (exactly one of these).\n    - If both Action and NotAction are present, flag validation error.\n    - If both Resource and NotResource are present, flag validation error.\n    - If neither Action nor NotAction are present, flag validation error.\n    - If neither Resource nor NotResource are present, flag validation error.\n    - Update the error message to reflect the accepted shapes, e.g., “Each IAM statement must have Effect and either Action or NotAction, and either Resource or NotResource.”\n  - Why: This is the root cause of the current build failures. Adjusting these checks ensures valid AWS IAM statements with NotAction/NotResource are allowed.\n\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n  - Code block: where provider.iamRoleStatements are concatenated into the default role (Properties.Policies[0].PolicyDocument.Statement).\n  - Changes:\n    - No logical change is required for the merge itself; the concatenation should work as-is once validation permits NotAction/NotResource.\n  - Why: Merging is already a pass-through. Validation updates are sufficient.\n\nB) Fix deduplication logic for custom resource roles\n\n- File: lib/plugins/aws/customResources/index.js\n  - Code block: lines 154-160 (current dedupe logic: find existing statement by comparing Resource equality only).\n  - Changes:\n    - Replace the Resource-only equality check with a more robust comparison that considers NotResource as well.\n    - Proposed logic: treat statements as duplicates only if all of the following match: Effect, Action or NotAction content, Resource or NotResource content, and any Condition if present. Use deep equality for these relevant fields, rather than just Resource equality.\n    - If deep equality utilities are available (e.g., lodash.isEqual), use them to avoid false deduplication. Otherwise, compute a safe comparison key using the presence and values of Resource/NotResource and Action/NotAction.\n  - Why: Statements using NotResource will have Resource undefined; current logic will treat multiple such statements as duplicates if an existing statement also lacks Resource, which is incorrect. Robust dedupe ensures all user-provided statements are honored.\n\nC) Documentation updates\n\n- File: docs/providers/aws/guide/iam.md\n  - Section: “The Default IAM Role” and surrounding IAM role statements guidance.\n  - Changes:\n    - Add explanation that provider.iamRoleStatements supports both Action and NotAction, and both Resource and NotResource, with the noted exclusivity rules.\n    - Provide an example illustrating NotResource for SNS Publish to allow SMS but not topics, e.g., with Action: 'sns:Publish' and NotResource: 'arn:aws:sns:*:*:*'.\n    - Clarify that you cannot mix Action with NotAction or Resource with NotResource in the same statement and that the framework enforces AWS IAM constraints at validation time.\n  - Why: Users need guidance and examples for using NotAction/NotResource.\n\n4) Considerations\n\n- Potential impacts:\n  - Validation behavior change: previously rejected statements will now be accepted. This should only be positive for users.\n  - Custom resource roles dedupe changes: ensuring correct dedupe prevents accidental dropping of valid NotResource-based statements.\n\n- Backward compatibility:\n  - Existing configurations with Action+Resource continue to work unchanged.\n  - Error messages become more informative when users provide invalid combinations (e.g., both Action and NotAction).\n  - No changes to templates structure beyond accepting and passing new statement shapes.\n\n- Dependencies/prerequisites:\n  - If using deep equality for dedupe, ensure lodash (or similar) is imported in lib/plugins/aws/customResources/index.js. If it is already used elsewhere in the plugin, reuse it; otherwise add an import in that module.\n  - No other external dependencies required.\n\n- Testing suggestions (not code, but to guide implementation):\n  - Add unit tests for validateStatements to cover:\n    - Valid: Effect + NotAction + Resource\n    - Valid: Effect + Action + NotResource\n    - Invalid: Effect only\n    - Invalid: Effect + Action + NotAction (both present)\n    - Invalid: Effect + Resource + NotResource (both present)\n  - Add tests for custom resources dedupe to ensure:\n    - Two distinct statements with NotResource are both retained.\n    - Statements with identical Action/NotAction + Resource/NotResource are deduped as expected, but different ones are not.\n\nThis set of changes will allow the framework to accept and correctly merge IAM statements that use NotAction and NotResource, consistent with AWS IAM policy semantics, while preserving existing behavior and documentation clarity." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 4323, 'prompt_tokens': 18966, 'total_tokens': 23289, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2688, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--53b27c3b-f283-44cb-a738-14503d979b97-0' usage_metadata={'input_tokens': 18966, 'output_tokens': 4323, 'total_tokens': 23289, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 2688}}
2025-11-13 21:19:01,895 - thread-135845298308800.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nBelow is a high-level analysis and implementation plan to support IAM policy elements NotAction and NotResource in provider.iamRoleStatements.\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Allow users to specify IAM statements using NotAction and/or NotResource within provider.iamRoleStatements in serverless.yml.\n  - Currently, the framework rejects iamRoleStatements that do not contain Action and Resource. The request is to accept valid IAM statements that use NotAction and/or NotResource instead.\n\n- Requirements:\n  - Update validation to accept statements that define either Action or NotAction, and either Resource or NotResource, consistent with AWS IAM policy rules.\n  - Ensure statements using NotAction/NotResource are merged properly into the generated IAM Role and into any custom resource roles without being dropped or incorrectly deduped.\n  - Update documentation to reflect support and provide examples.\n\n- Ambiguities/edge cases to clarify and handle:\n  - Exclusivity:\n    - In a single policy statement, Action and NotAction must not both be present.\n    - Resource and NotResource must not both be present.\n  - Ensure validation requires at least one of {Action, NotAction} and at least one of {Resource, NotResource}.\n  - Deduplication logic should not incorrectly treat all statements with missing Resource as duplicates (e.g., two different NotResource statements must be handled distinctly).\n  - Complex CloudFormation intrinsics (Fn::Join, Ref, Fn::Sub, etc.) should continue to be supported on any of these fields.\n\n2) Architecture Analysis\n\n- Primary integration points:\n  - Validation and merging of provider.iamRoleStatements occurs in lib/plugins/aws/package/lib/mergeIamTemplates.js. This is where current validation enforces Action and Resource presence. It needs update.\n  - Custom resources role merging occurs in lib/plugins/aws/customResources/index.js where iamRoleStatements for custom resource handlers are appended and deduped using Resource-only equality checks. This needs update to consider NotResource and avoid false positives.\n\n- Files/modules impacted:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js\n    - validateStatements(...) function and associated error messages.\n    - mergeIamTemplates() path remains the same; only validation and concatenation need to support NotAction/NotResource.\n  - lib/plugins/aws/customResources/index.js\n    - Logic that pushes provider-level iamRoleStatements into custom resource role PolicyDocument (Statement deduping by Resource).\n  - Documentation:\n    - docs/providers/aws/guide/iam.md (add examples and explanation for NotAction and NotResource).\n\n- Architectural constraints/patterns:\n  - The framework largely passes-through IAM policy statements into CloudFormation templates; it should avoid imposing non-AWS constraints.\n  - Maintain backward compatibility: existing Action/Resource statements continue to work unmodified.\n  - Keep validation simple, but ensure it enforces mutually exclusive Action vs NotAction and Resource vs NotResource.\n\n3) Implementation Plan\n\nA) Update validation to accept NotAction/NotResource\n\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n  - Function: validateStatements(statements)\n  - Changes:\n    - Adjust validation rules:\n      - Each statement must include Effect.\n      - Each statement must include either Action or NotAction (exactly one of these).\n      - Each statement must include either Resource or NotResource (exactly one of these).\n    - If both Action and NotAction are present, flag validation error.\n    - If both Resource and NotResource are present, flag validation error.\n    - If neither Action nor NotAction are present, flag validation error.\n    - If neither Resource nor NotResource are present, flag validation error.\n    - Update the error message to reflect the accepted shapes, e.g., “Each IAM statement must have Effect and either Action or NotAction, and either Resource or NotResource.”\n  - Why: This is the root cause of the current build failures. Adjusting these checks ensures valid AWS IAM statements with NotAction/NotResource are allowed.\n\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n  - Code block: where provider.iamRoleStatements are concatenated into the default role (Properties.Policies[0].PolicyDocument.Statement).\n  - Changes:\n    - No logical change is required for the merge itself; the concatenation should work as-is once validation permits NotAction/NotResource.\n  - Why: Merging is already a pass-through. Validation updates are sufficient.\n\nB) Fix deduplication logic for custom resource roles\n\n- File: lib/plugins/aws/customResources/index.js\n  - Code block: lines 154-160 (current dedupe logic: find existing statement by comparing Resource equality only).\n  - Changes:\n    - Replace the Resource-only equality check with a more robust comparison that considers NotResource as well.\n    - Proposed logic: treat statements as duplicates only if all of the following match: Effect, Action or NotAction content, Resource or NotResource content, and any Condition if present. Use deep equality for these relevant fields, rather than just Resource equality.\n    - If deep equality utilities are available (e.g., lodash.isEqual), use them to avoid false deduplication. Otherwise, compute a safe comparison key using the presence and values of Resource/NotResource and Action/NotAction.\n  - Why: Statements using NotResource will have Resource undefined; current logic will treat multiple such statements as duplicates if an existing statement also lacks Resource, which is incorrect. Robust dedupe ensures all user-provided statements are honored.\n\nC) Documentation updates\n\n- File: docs/providers/aws/guide/iam.md\n  - Section: “The Default IAM Role” and surrounding IAM role statements guidance.\n  - Changes:\n    - Add explanation that provider.iamRoleStatements supports both Action and NotAction, and both Resource and NotResource, with the noted exclusivity rules.\n    - Provide an example illustrating NotResource for SNS Publish to allow SMS but not topics, e.g., with Action: \'sns:Publish\' and NotResource: \'arn:aws:sns:*:*:*\'.\n    - Clarify that you cannot mix Action with NotAction or Resource with NotResource in the same statement and that the framework enforces AWS IAM constraints at validation time.\n  - Why: Users need guidance and examples for using NotAction/NotResource.\n\n4) Considerations\n\n- Potential impacts:\n  - Validation behavior change: previously rejected statements will now be accepted. This should only be positive for users.\n  - Custom resource roles dedupe changes: ensuring correct dedupe prevents accidental dropping of valid NotResource-based statements.\n\n- Backward compatibility:\n  - Existing configurations with Action+Resource continue to work unchanged.\n  - Error messages become more informative when users provide invalid combinations (e.g., both Action and NotAction).\n  - No changes to templates structure beyond accepting and passing new statement shapes.\n\n- Dependencies/prerequisites:\n  - If using deep equality for dedupe, ensure lodash (or similar) is imported in lib/plugins/aws/customResources/index.js. If it is already used elsewhere in the plugin, reuse it; otherwise add an import in that module.\n  - No other external dependencies required.\n\n- Testing suggestions (not code, but to guide implementation):\n  - Add unit tests for validateStatements to cover:\n    - Valid: Effect + NotAction + Resource\n    - Valid: Effect + Action + NotResource\n    - Invalid: Effect only\n    - Invalid: Effect + Action + NotAction (both present)\n    - Invalid: Effect + Resource + NotResource (both present)\n  - Add tests for custom resources dedupe to ensure:\n    - Two distinct statements with NotResource are both retained.\n    - Statements with identical Action/NotAction + Resource/NotResource are deduped as expected, but different ones are not.\n\nThis set of changes will allow the framework to accept and correctly merge IAM statements that use NotAction and NotResource, consistent with AWS IAM policy semantics, while preserving existing behavior and documentation clarity.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 21:19:05,264 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ukQ6Wlij6ISRbX5y7ygZ04ee', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 223, 'prompt_tokens': 19765, 'total_tokens': 19988, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bfe45e4f-c425-4867-93cd-8df65f59c888-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_ukQ6Wlij6ISRbX5y7ygZ04ee', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19765, 'output_tokens': 223, 'total_tokens': 19988, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 21:19:11,634 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xkeanYdc24fv8Kr71qz0Xgw7', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 290, 'prompt_tokens': 21851, 'total_tokens': 22141, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ffc81ca3-2086-4bf8-b99a-5bbc91679726-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_xkeanYdc24fv8Kr71qz0Xgw7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21851, 'output_tokens': 290, 'total_tokens': 22141, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 21:19:42,185 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_aoGaTyj8vNOkDiif0dEBRVBN', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"const path = require(\'path\');","new_content":"const _ = require(\'lodash\');\\nconst path = require(\'path\');"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2558, 'prompt_tokens': 24110, 'total_tokens': 26668, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2496, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 21760}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--794dfdf6-687e-4fbf-91aa-a103e8836bc7-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': "const path = require('path');", 'new_content': "const _ = require('lodash');\nconst path = require('path');"}, 'id': 'call_aoGaTyj8vNOkDiif0dEBRVBN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24110, 'output_tokens': 2558, 'total_tokens': 26668, 'input_token_details': {'audio': 0, 'cache_read': 21760}, 'output_token_details': {'audio': 0, 'reasoning': 2496}}
2025-11-13 21:19:43,931 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_rJaVCqJ3UHstct4FdKEbOR1e', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 24186, 'total_tokens': 24211, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b19d3575-c987-4ae5-a8e6-16af420fc58e-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_rJaVCqJ3UHstct4FdKEbOR1e', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24186, 'output_tokens': 25, 'total_tokens': 24211, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:19:57,384 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_B9P27PfjrMDM5kKm3xDTCS7P', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","start_line":19,"end_line":49}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1645, 'prompt_tokens': 26281, 'total_tokens': 27926, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1600, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4c0aed21-69ae-490e-91de-012044175aca-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'start_line': 19, 'end_line': 49}, 'id': 'call_B9P27PfjrMDM5kKm3xDTCS7P', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26281, 'output_tokens': 1645, 'total_tokens': 27926, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1600}}
2025-11-13 21:19:59,292 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_afUkMTcVCbCnaHHUD6N97d8K', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","start_line":50,"end_line":72}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 26656, 'total_tokens': 26695, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3ce0e774-5602-40ca-af67-aca42248151c-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'start_line': 50, 'end_line': 72}, 'id': 'call_afUkMTcVCbCnaHHUD6N97d8K', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26656, 'output_tokens': 39, 'total_tokens': 26695, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:20:23,474 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PYPiqIufG65cCca1MFC114PZ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js","old_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\\n    // Action: ..., Resource: ... } objects.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\\n          prop => statement[prop] === undefined\\n        );\\n        return missing.length === 0\\n          ? null\\n          : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect, Action, Resource fields.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },","new_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of objects with Effect and\\n    // either Action or NotAction, and either Resource or NotResource (but not both pairs).\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const hasEffect = statement.Effect !== undefined;\\n        const hasAction = statement.Action !== undefined;\\n        const hasNotAction = statement.NotAction !== undefined;\\n        const hasResource = statement.Resource !== undefined;\\n        const hasNotResource = statement.NotResource !== undefined;\\n\\n        const errors = [];\\n        if (!hasEffect) {\\n          errors.push(\'Effect\');\\n        }\\n        // Validate Action/NotAction presence and exclusivity\\n        if (!(hasAction || hasNotAction)) {\\n          errors.push(\'Action or NotAction\');\\n        } else if (hasAction && hasNotAction) {\\n          errors.push(\'cannot contain both Action and NotAction\');\\n        }\\n        // Validate Resource/NotResource presence and exclusivity\\n        if (!(hasResource || hasNotResource)) {\\n          errors.push(\'Resource or NotResource\');\\n        } else if (hasResource && hasNotResource) {\\n          errors.push(\'cannot contain both Resource and NotResource\');\\n        }\\n\\n        return errors.length === 0\\n          ? null\\n          : `statement ${i} is invalid: ${errors.join(\', \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect and either Action or NotAction, and either Resource or NotResource.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3001, 'prompt_tokens': 27129, 'total_tokens': 30130, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2176, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1fb1819f-d707-4538-8eb9-86eb1f275538-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js', 'old_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n    // Action: ..., Resource: ... } objects.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const missing = ['Effect', 'Action', 'Resource'].filter(\n          prop => statement[prop] === undefined\n        );\n        return missing.length === 0\n          ? null\n          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect, Action, Resource fields.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },", 'new_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of objects with Effect and\n    // either Action or NotAction, and either Resource or NotResource (but not both pairs).\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const hasEffect = statement.Effect !== undefined;\n        const hasAction = statement.Action !== undefined;\n        const hasNotAction = statement.NotAction !== undefined;\n        const hasResource = statement.Resource !== undefined;\n        const hasNotResource = statement.NotResource !== undefined;\n\n        const errors = [];\n        if (!hasEffect) {\n          errors.push('Effect');\n        }\n        // Validate Action/NotAction presence and exclusivity\n        if (!(hasAction || hasNotAction)) {\n          errors.push('Action or NotAction');\n        } else if (hasAction && hasNotAction) {\n          errors.push('cannot contain both Action and NotAction');\n        }\n        // Validate Resource/NotResource presence and exclusivity\n        if (!(hasResource || hasNotResource)) {\n          errors.push('Resource or NotResource');\n        } else if (hasResource && hasNotResource) {\n          errors.push('cannot contain both Resource and NotResource');\n        }\n\n        return errors.length === 0\n          ? null\n          : `statement ${i} is invalid: ${errors.join(', ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect and either Action or NotAction, and either Resource or NotResource.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },"}, 'id': 'call_PYPiqIufG65cCca1MFC114PZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27129, 'output_tokens': 3001, 'total_tokens': 30130, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 2176}}
2025-11-13 21:20:25,527 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_fxcSNejAvw7qQvgkvh2qfZOD', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 27971, 'total_tokens': 27999, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1d5b152b-5e3e-4ffd-a8ae-c3298a3ccab1-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_fxcSNejAvw7qQvgkvh2qfZOD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27971, 'output_tokens': 28, 'total_tokens': 27999, 'input_token_details': {'audio': 0, 'cache_read': 19712}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:20:40,078 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_taZMukh3UPlo1qd62L4EBueL', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\\n          Statement.push(newStmt);\\n        }\\n      });","new_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        const keys = [\'Effect\', \'Action\', \'NotAction\', \'Resource\', \'NotResource\', \'Condition\'];\\n        const isDuplicate = Statement.find(existingStmt =>\\n          _.isEqual(_.pick(existingStmt, keys), _.pick(newStmt, keys))\\n        );\\n        if (!isDuplicate) {\\n          Statement.push(newStmt);\\n        }\\n      });"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1427, 'prompt_tokens': 30453, 'total_tokens': 31880, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1216, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24064}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5298d094-c817-4c9d-8f17-823cbd74f0f6-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n          Statement.push(newStmt);\n        }\n      });', 'new_content': "      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        const keys = ['Effect', 'Action', 'NotAction', 'Resource', 'NotResource', 'Condition'];\n        const isDuplicate = Statement.find(existingStmt =>\n          _.isEqual(_.pick(existingStmt, keys), _.pick(newStmt, keys))\n        );\n        if (!isDuplicate) {\n          Statement.push(newStmt);\n        }\n      });"}, 'id': 'call_taZMukh3UPlo1qd62L4EBueL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30453, 'output_tokens': 1427, 'total_tokens': 31880, 'input_token_details': {'audio': 0, 'cache_read': 24064}, 'output_token_details': {'audio': 0, 'reasoning': 1216}}
2025-11-13 21:20:42,028 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_mtvdRpzQnf83aVtoX5mRXYoD', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 30678, 'total_tokens': 30703, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9e73325e-edf4-4f92-a3c3-75bebdfcde62-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_mtvdRpzQnf83aVtoX5mRXYoD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30678, 'output_tokens': 25, 'total_tokens': 30703, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:20:44,642 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_goU6ZYYduMzuZc72UAyRUzAL', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.","new_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. `iamRoleStatements` supports both Action and NotAction, and both Resource and NotResource (following IAM policy rules you must specify exactly one of Action/NotAction and exactly one of Resource/NotResource)."}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 193, 'prompt_tokens': 32825, 'total_tokens': 33018, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 26624}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--796f547b-c7de-4b2b-a70a-efd3115a6d15-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': 'To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.', 'new_content': 'To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. `iamRoleStatements` supports both Action and NotAction, and both Resource and NotResource (following IAM policy rules you must specify exactly one of Action/NotAction and exactly one of Resource/NotResource).'}, 'id': 'call_goU6ZYYduMzuZc72UAyRUzAL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 32825, 'output_tokens': 193, 'total_tokens': 33018, 'input_token_details': {'audio': 0, 'cache_read': 26624}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:20:46,927 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_6YQvxyzFIbPAJDBRsJXFptdf', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","start_line":19,"end_line":49}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 33039, 'total_tokens': 33078, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 26240}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1ba3680d-cbc5-4f6d-bbc4-460239ea6674-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'start_line': 19, 'end_line': 49}, 'id': 'call_6YQvxyzFIbPAJDBRsJXFptdf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33039, 'output_tokens': 39, 'total_tokens': 33078, 'input_token_details': {'audio': 0, 'cache_read': 26240}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:20:51,167 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ZQHN8nTciyLw3x0Id5LszwPh', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n ```","new_content":"    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n    # Example using NotResource to allow SNS publish to SMS but not to topics\\n    - Effect: \'Allow\'\\n      Action: \'sns:Publish\'\\n      NotResource: \'arn:aws:sns:*:*:*\'\\n ```"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 215, 'prompt_tokens': 33456, 'total_tokens': 33671, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6fdccd0f-27f6-46a4-aaab-f2bd38e7ec43-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': "    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n ```", 'new_content': "    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n    # Example using NotResource to allow SNS publish to SMS but not to topics\n    - Effect: 'Allow'\n      Action: 'sns:Publish'\n      NotResource: 'arn:aws:sns:*:*:*'\n ```"}, 'id': 'call_ZQHN8nTciyLw3x0Id5LszwPh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33456, 'output_tokens': 215, 'total_tokens': 33671, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:20:54,449 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_X7UwKKWJpHeIix0ZrPp7GDsc', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 224, 'prompt_tokens': 33705, 'total_tokens': 33929, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 32896}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cf7a431c-b533-41de-aedb-d83822f743f2-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_X7UwKKWJpHeIix0ZrPp7GDsc', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33705, 'output_tokens': 224, 'total_tokens': 33929, 'input_token_details': {'audio': 0, 'cache_read': 32896}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 21:20:59,144 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_KVXIyx2GZkCXrDYe0PNDpG9N', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n```","new_content":"```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n    # Example using NotResource to allow publishing to SMS (but not to SNS topics)\\n    - Effect: \'Allow\'\\n      Action: \'sns:Publish\'\\n      NotResource: \'arn:aws:sns:*:*:*\'\\n```"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 383, 'prompt_tokens': 37147, 'total_tokens': 37530, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--06f3ce02-2aa0-4881-a0e1-d06e31fed597-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': "```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n```", 'new_content': "```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n    # Example using NotResource to allow publishing to SMS (but not to SNS topics)\n    - Effect: 'Allow'\n      Action: 'sns:Publish'\n      NotResource: 'arn:aws:sns:*:*:*'\n```"}, 'id': 'call_KVXIyx2GZkCXrDYe0PNDpG9N', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37147, 'output_tokens': 383, 'total_tokens': 37530, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:21:00,653 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_oP5dt9qqamiWwLKSrTScjGNW', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 37551, 'total_tokens': 37577, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 33664}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5b68c6d3-bcc1-4ec5-a5ef-db0ee185da21-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_oP5dt9qqamiWwLKSrTScjGNW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37551, 'output_tokens': 26, 'total_tokens': 37577, 'input_token_details': {'audio': 0, 'cache_read': 33664}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:21:09,240 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I have implemented support for NotAction and NotResource in IAM role statements.\n\nSummary of changes:\n- Updated validation to allow NotAction and NotResource with proper exclusivity rules:\n  - Each statement must include Effect.\n  - Exactly one of Action or NotAction must be present.\n  - Exactly one of Resource or NotResource must be present.\n  - Updated error messages to reflect the new rules.\n\n- Improved custom resource role statement deduplication:\n  - Previously deduped only by Resource, which failed for NotResource-based statements.\n  - Now uses deep equality across Effect, Action, NotAction, Resource, NotResource, and Condition to avoid false deduplication.\n\n- Documentation updates:\n  - Clarified that iamRoleStatements supports both Action and NotAction, and both Resource and NotResource, with exclusivity requirements.\n  - Added an example demonstrating use of NotResource with sns:Publish.\n\nFiles modified:\n- lib/plugins/aws/package/lib/mergeIamTemplates.js: Updated validateStatements logic and error messages.\n- lib/plugins/aws/customResources/index.js: Added lodash import and enhanced deduplication logic.\n- docs/providers/aws/guide/iam.md: Added support note and example for NotResource.\n\nThese changes ensure valid IAM statements using NotAction and NotResource are accepted and merged correctly.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 783, 'prompt_tokens': 41048, 'total_tokens': 41831, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30592}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--3ae6564c-cb60-4461-8355-64dae41cb8b1-0' usage_metadata={'input_tokens': 41048, 'output_tokens': 783, 'total_tokens': 41831, 'input_token_details': {'audio': 0, 'cache_read': 30592}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 21:21:09,323 - thread-135845298308800.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md
index f08eef33c..432d474f5 100644
--- a/docs/providers/aws/guide/iam.md
+++ b/docs/providers/aws/guide/iam.md
@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc
 
 By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
 
-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. `iamRoleStatements` supports both Action and NotAction, and both Resource and NotResource (following IAM policy rules you must specify exactly one of Action/NotAction and exactly one of Resource/NotResource).
 
 ```yml
 service: new-service
@@ -45,6 +45,10 @@ provider:
           - - 'arn:aws:s3:::'
             - Ref: ServerlessDeploymentBucket
             - '/*'
+    # Example using NotResource to allow publishing to SMS (but not to SNS topics)
+    - Effect: 'Allow'
+      Action: 'sns:Publish'
+      NotResource: 'arn:aws:sns:*:*:*'
 ```
 
 Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
diff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js
index b3b9b4f99..1a8f56162 100644
--- a/lib/plugins/aws/customResources/index.js
+++ b/lib/plugins/aws/customResources/index.js
@@ -1,5 +1,6 @@
 'use strict';
 
+const _ = require('lodash');
 const path = require('path');
 const crypto = require('crypto');
 const BbPromise = require('bluebird');
@@ -154,7 +155,11 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements
       }
       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
       iamRoleStatements.forEach(newStmt => {
-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
+        const keys = ['Effect', 'Action', 'NotAction', 'Resource', 'NotResource', 'Condition'];
+        const isDuplicate = Statement.find(existingStmt =>
+          _.isEqual(_.pick(existingStmt, keys), _.pick(newStmt, keys))
+        );
+        if (!isDuplicate) {
           Statement.push(newStmt);
         }
       });
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js
index 2d97671ad..92fed5d59 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -182,8 +182,8 @@ module.exports = {
   },
 
   validateStatements(statements) {
-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
-    // Action: ..., Resource: ... } objects.
+    // Verify that iamRoleStatements (if present) is an array of objects with Effect and
+    // either Action or NotAction, and either Resource or NotResource (but not both pairs).
     if (!statements) {
       return;
     }
@@ -192,12 +192,32 @@ module.exports = {
       violationsFound = 'it is not an array';
     } else {
       const descriptions = statements.map((statement, i) => {
-        const missing = ['Effect', 'Action', 'Resource'].filter(
-          prop => statement[prop] === undefined
-        );
-        return missing.length === 0
+        const hasEffect = statement.Effect !== undefined;
+        const hasAction = statement.Action !== undefined;
+        const hasNotAction = statement.NotAction !== undefined;
+        const hasResource = statement.Resource !== undefined;
+        const hasNotResource = statement.NotResource !== undefined;
+
+        const errors = [];
+        if (!hasEffect) {
+          errors.push('Effect');
+        }
+        // Validate Action/NotAction presence and exclusivity
+        if (!(hasAction || hasNotAction)) {
+          errors.push('Action or NotAction');
+        } else if (hasAction && hasNotAction) {
+          errors.push('cannot contain both Action and NotAction');
+        }
+        // Validate Resource/NotResource presence and exclusivity
+        if (!(hasResource || hasNotResource)) {
+          errors.push('Resource or NotResource');
+        } else if (hasResource && hasNotResource) {
+          errors.push('cannot contain both Resource and NotResource');
+        }
+
+        return errors.length === 0
           ? null
-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
+          : `statement ${i} is invalid: ${errors.join(', ')}`;
       });
       const flawed = descriptions.filter(curr => curr);
       if (flawed.length) {
@@ -208,7 +228,7 @@ module.exports = {
     if (violationsFound) {
       const errorMessage = [
         'iamRoleStatements should be an array of objects,',
-        ' where each object has Effect, Action, Resource fields.',
+        ' where each object has Effect and either Action or NotAction, and either Resource or NotResource.',
         ` Specifically, ${violationsFound}`,
       ].join('');
       throw new this.serverless.classes.Error(errorMessage);

2025-11-13 21:21:09,325 - thread-135845298308800.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 21:21:09,348 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 21:21:09,349 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 21:21:09,353 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n' additional_kwargs={} response_metadata={}
2025-11-13 21:21:21,520 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HLOXqZQe2pTLdL4zieHMdHft', 'function': {'arguments': '{"query":"AWS IAM NotAction NotResource policy elements validation rules allowed combinations Action vs NotAction Resource vs NotResource"}', 'name': 'web_search'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1195, 'prompt_tokens': 17735, 'total_tokens': 18930, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bfae4a92-6239-487a-9d5c-108e79b17354-0' tool_calls=[{'name': 'web_search', 'args': {'query': 'AWS IAM NotAction NotResource policy elements validation rules allowed combinations Action vs NotAction Resource vs NotResource'}, 'id': 'call_HLOXqZQe2pTLdL4zieHMdHft', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17735, 'output_tokens': 1195, 'total_tokens': 18930, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-13 21:21:21,524 - thread-135845298308800.prometheus.tools.web_search - DEBUG - Query: AWS IAM NotAction NotResource policy elements validation rules allowed combinations Action vs NotAction Resource vs NotResource
2025-11-13 21:21:25,830 - thread-135845298308800.prometheus.tools.web_search - INFO - web_search format_response: Answer: NotAction and NotResource in AWS IAM policies explicitly deny specified actions and resources. Combining allow and deny policies can result in deny taking precedence. Always use precise actions and resources for clarity.

Sources:
- SwaroopGiri/AWS-SAP-C02-Notes: https://github.com/SwaroopGiri/AWS-SAP-C02-Notes
- not_actions vs explicit deny & allow statements in an IAM ...: https://stackoverflow.com/questions/72104664/not-actions-vs-explicit-deny-allow-statements-in-an-iam-policy
- AWS IAM multiple policies with conflicting conditions: https://stackoverflow.com/questions/58066572/aws-iam-multiple-policies-with-conflicting-conditions
- How do I combine these two AWS-IAM policies to allow ...: https://stackoverflow.com/questions/77442087/how-do-i-combine-these-two-aws-iam-policies-to-allow-certain-actions-to-only-cer
- mykter/aws-security-cert-service-notes: https://github.com/mykter/aws-security-cert-service-notes

Detailed Results:

Title: SwaroopGiri/AWS-SAP-C02-Notes
URL: https://github.com/SwaroopGiri/AWS-SAP-C02-Notes
Content: Take note that the NotAction/NotResource is an advanced policy element that explicitly matches everything except the list of action/resources that you specified.

Consolidated billing for instances is tagged per AZ and not per account. Instances running in same AZ but different accounts in same organization will benifit from the purchase. [...] Bucket policies are resource based policies, if bucket explictly allows access to a user/resource then the policy in IAM role makes no difference.

aws:SecureTransport condition can be used in bucket policies to enforce https connections

## EBS

EBS are tied to single AZ and can only be used with EC2

You can use EBS Multi-Attach to attach an EBS volume to multiple instances

Use Snapshots to migrate EBS to different AZ [...] With AWS Service Catalog, you can meet your compliance requirements while making sure your customers can quickly deploy the cloud resources they need

## Service Control Policies (SCP)

The syntax for an SCP requires only one Statement element. You can have multiple objects within a single Statement element though

SCP has ultimate say whether a call goes through. Even if an IAM user is an admin but scp has no allow rule for the user, the user can't access the resource

Title: not_actions vs explicit deny & allow statements in an IAM ...
URL: https://stackoverflow.com/questions/72104664/not-actions-vs-explicit-deny-allow-statements-in-an-iam-policy
Content: ```
data "aws_iam_policy_document" "kms_policy" { statement { sid = "AllowEKSKMSAccess" actions = [ "kms:" ] not_actions = [ "kms:Delete", "kms:ScheduleKeyDeletion", "kms:Revoke", "kms:Disable", ] resources = [""] } } 
```

Policy 2: [...] with `Allow` effect where you have the list of precise `Action`s, because you can always allow more than you should with wildcard ``, don't be lazy especially when you have AWS tools like IAM Policy Simulator
 with explicit ARNs for `Resource`s (at least precise the account), avoid `[]`

Since you are using Terraform, you have tools like Checkov for analyzing your code and giving you best practice tips.

Share

Improve this answer

answered Jul 7, 2022 at 9:21

gokan [...] ```
data "aws_iam_policy_document" "kms_policy" { statement { sid = "AllowEKSKMSAccess" effect = "Allow" actions = [ "kms:" ] resources = [""] } statement { sid = "DenyEKSKMSDeletion" effect = "Deny" actions = [ "kms:Delete", "kms:ScheduleKeyDeletion", "kms:Revoke", "kms:Disable", ] resources = [""] } } 
```

I want to prevent 4 actions from within the role associated with a managed EKS node group.

Is policy 1 or policy 2 the preferred policy?

Title: AWS IAM multiple policies with conflicting conditions
URL: https://stackoverflow.com/questions/58066572/aws-iam-multiple-policies-with-conflicting-conditions
Content: ```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "secretsmanager:",
            "Resource": "",
            "Condition": {
                "StringNotEquals": {
                    "secretsmanager:ResourceTag/allow": "False"
                }
            }
        }
    ]
}

```

Which one wins? I don't think you can order policies. How does AWS merge the conditions? [...] As far as i know Deny/Block wins over the allow if they are attached to the same entity. This doc seems to be relevant docs.aws.amazon.com/IAM/latest/UserGuide/…

  suprasad

  – 
  suprasad

  2019-09-23 17:57:30 +00:00

  Commented
  Sep 23, 2019 at 17:57

Add a comment
 |

## 1 Answer 1

Reset to default

This answer is useful

15

Save this answer.

Show activity on this post.

First, let me answer the question directly. This is logically what IAM is doing. [...] Follow this answer to receive notifications

edited Jan 2, 2024 at 20:12

johnnyRose

7,5301717 gold badges4242 silver badges6161 bronze badges

answered Sep 23, 2019 at 18:15

WaltDeWaltDe

1,8701010 silver badges1717 bronze badges

5

 that says nothing about how conflicting conditions are merged

  red888

  – 
  red888

  2019-09-23 18:16:48 +00:00

  Commented
  Sep 23, 2019 at 18:16
 2

Title: How do I combine these two AWS-IAM policies to allow ...
URL: https://stackoverflow.com/questions/77442087/how-do-i-combine-these-two-aws-iam-policies-to-allow-certain-actions-to-only-cer
Content: When combining AWS IAM policies, all statements are merged, and combining allow-only policies results in a more permissive policy, not less.

Title: mykter/aws-security-cert-service-notes
URL: https://github.com/mykter/aws-security-cert-service-notes
Content: I don't plan to actively maintain this document as AWS evolves - reader beware, the rate of change at AWS is high! I would like to correct any errors though - please do raise an issue. I'll also happily accept pull requests if you find yourself using it and wish to bring it up to date, or fix errors, or otherwise enhance it in any way. [...] | DynamoDB | Standard AWS HTTPS endpoint | KMS | CloudTrail, excl. Get/Put  docs | IAM only. Cognito possible.  docs | IAM identity policies - resources & condition keys  docs |
| Redshift | ACM managed certificate, redshift specific root  docs | KMS; CloudHSM Classic | S3  docs | DB user accounts - SQL; IAM with custom drivers  docs | SQL | [...] probably pass the security certification exam. It worked for me, anyway!
2025-11-13 21:22:07,941 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='Feature Understanding:\n- The request is to allow IAM role statements in serverless.yml that use NotAction or NotResource, which are valid AWS IAM policy elements per AWS documentation.\n- Current behavior: the framework rejects builds when provider.iamRoleStatements contain NotAction or NotResource, even though they are valid IAM constructs. This is due to validation that insists each statement must have Action and Resource.\n- Desired functionality: Accept provider.iamRoleStatements where either Action or NotAction is present, and either Resource or NotResource is present, and pass them through into the generated IAM PolicyDocument.\n- Ambiguities and edge cases to clarify:\n  - Disallow having both Action and NotAction in the same statement (IAM requires exactly one of them).\n  - Disallow having both Resource and NotResource in the same statement (IAM requires exactly one of them).\n  - Continue to require Effect.\n  - Ensure statements that use CloudFormation intrinsic functions (e.g., Fn::Join, Ref) are still supported as they currently are.\n  - Note that NotResource patterns are commonly used to allow SNS Publish to SMS phone numbers while preventing publishing to SNS topics; this pattern should be documented.\n\nArchitecture Analysis:\n- The rejection originates in lib/plugins/aws/package/lib/mergeIamTemplates.js within validateStatements(statements). It currently enforces presence of Effect, Action, and Resource.\n- provider.iamRoleStatements are merged into the default role in mergeIamTemplates.merge(). Once validation is relaxed, these statements will be concatenated into the PolicyDocument.Statement as-is.\n- Custom resource role building (lib/plugins/aws/customResources/index.js) deduplicates statements only by comparing the Resource field. While provider-level iamRoleStatements are not used there, event compilers call addCustomResourceToService() with their own iamRoleStatements (which include Resource). For robustness, the dedupe logic should be adjusted to not assume Resource always exists.\n- Documentation in docs/providers/aws/guide/iam.md currently illustrates only Action/Resource examples. It should be updated to describe and show NotAction/NotResource usage and cautions.\n\nImplementation Plan:\n1) Update validation to support NotAction/NotResource\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function: validateStatements(statements)\n- Changes:\n  - Modify the validation rules to:\n    - Require Effect to be present.\n    - Require exactly one of Action or NotAction to be present. If neither is present, flag an error. If both are present, flag an error.\n    - Require exactly one of Resource or NotResource to be present. If neither is present, flag an error. If both are present, flag an error.\n  - Update error messages to reflect the new accepted forms, e.g., “Each statement must include Effect and either Action or NotAction, and either Resource or NotResource. Statement X violates …”.\n  - Keep the existing array type check for the statements input.\n  - Do not enforce type/shape of Action/Resource values beyond presence; retain compatibility with CloudFormation intrinsics allowed today.\n\n2) Ensure merging accepts these statements\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function: mergeIamTemplates.merge() (implicit via mergeIamTemplates.mergeIamTemplates() and subsequent lines 129–136)\n- Changes:\n  - No structural change needed; concatenation of iamRoleStatements to PolicyDocument.Statement should remain as-is because IAM will accept NotAction/NotResource in the generated JSON.\n  - Confirm any internal logic does not assume Action/Resource when concatenating; current code just concatenates arrays and is fine.\n\n3) Make deduplication robust in custom resources\n- File: lib/plugins/aws/customResources/index.js\n- Code block: lines 155–160 (where it deduplicates before pushing iamRoleStatements into the custom resource role PolicyDocument.Statement)\n- Changes:\n  - Adjust the dedupe predicate to consider both Resource and NotResource:\n    - If newStmt has Resource, compare existingStmt.Resource === newStmt.Resource as today.\n    - If newStmt has NotResource, dedupe by comparing existingStmt.NotResource === newStmt.NotResource.\n    - If neither key is present (highly unlikely for IAM statements but for completeness), fallback to deep equality check of the whole statement object to avoid accidental drops.\n  - This prevents incorrectly treating all NotResource statements as duplicates due to undefined Resource.\n\n4) Documentation updates\n- File: docs/providers/aws/guide/iam.md\n- Sections to modify:\n  - Expand “The Default IAM Role” section to state that provider.iamRoleStatements support NotAction and NotResource.\n  - Add a new subsection showing examples:\n    - Example of Allow with NotResource to permit SNS Publish to phone numbers but not to topics, referencing AWS’s recommended pattern.\n    - Example of Deny using NotAction or NotResource to clarify semantics and caution about careful usage.\n  - Include a brief note on best practices and potential security implications when using NotAction/NotResource.\n\nConsiderations:\n- Impacts on existing functionality:\n  - Existing users with Action/Resource continue to pass validation unchanged.\n  - Users with NotAction or NotResource will now be accepted and merged into the default role policy.\n  - Custom resource IAM role deduping change is conservative and should not affect existing behavior for statements that include Resource, but it avoids incorrect deduping for future cases where NotResource appears.\n- Backward compatibility:\n  - Validation changes broaden acceptance and do not remove existing accepted forms.\n  - Error messages are updated but remain informative.\n  - No changes to how policies are generated besides accepting more valid IAM constructs.\n- Dependencies and prerequisites:\n  - None external; changes are internal to validation and minimal dedupe logic.\n  - Ensure any unit/integration tests around iamRoleStatements validation are updated to include cases for NotAction and NotResource (e.g., statements with Effect + NotAction + Resource, Effect + Action + NotResource, and errors for both Action/NotAction present or both Resource/NotResource present).\n- Edge cases:\n  - Statements with CloudFormation intrinsics are still supported; validation only checks property presence.\n  - Be cautious not to attempt to “normalize” or transform NotAction/NotResource; leave them as-is for IAM to interpret.\n  - IAM semantics of NotAction/NotResource can be subtle; the framework should not enforce effect-specific restrictions, just accept valid shape.\n\nWhy these changes implement the feature:\n- The build errors stem from overly strict validation requiring Action and Resource. Allowing NotAction/NotResource aligns the validator with IAM’s schema, enabling users to define advanced IAM statements that AWS supports.\n- The merge logic already handles arbitrary statements, so no changes are needed there beyond ensuring statements pass validation.\n- Documentation updates make the new capability discoverable and provide an example pattern aligned with the reported use case.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 4287, 'prompt_tokens': 19341, 'total_tokens': 23628, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2880, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17664}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--a1773fbb-d570-45d9-878b-b2696dd81884-0' usage_metadata={'input_tokens': 19341, 'output_tokens': 4287, 'total_tokens': 23628, 'input_token_details': {'audio': 0, 'cache_read': 17664}, 'output_token_details': {'audio': 0, 'reasoning': 2880}}
2025-11-13 21:22:07,947 - thread-135845298308800.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nFeature Understanding:\n- The request is to allow IAM role statements in serverless.yml that use NotAction or NotResource, which are valid AWS IAM policy elements per AWS documentation.\n- Current behavior: the framework rejects builds when provider.iamRoleStatements contain NotAction or NotResource, even though they are valid IAM constructs. This is due to validation that insists each statement must have Action and Resource.\n- Desired functionality: Accept provider.iamRoleStatements where either Action or NotAction is present, and either Resource or NotResource is present, and pass them through into the generated IAM PolicyDocument.\n- Ambiguities and edge cases to clarify:\n  - Disallow having both Action and NotAction in the same statement (IAM requires exactly one of them).\n  - Disallow having both Resource and NotResource in the same statement (IAM requires exactly one of them).\n  - Continue to require Effect.\n  - Ensure statements that use CloudFormation intrinsic functions (e.g., Fn::Join, Ref) are still supported as they currently are.\n  - Note that NotResource patterns are commonly used to allow SNS Publish to SMS phone numbers while preventing publishing to SNS topics; this pattern should be documented.\n\nArchitecture Analysis:\n- The rejection originates in lib/plugins/aws/package/lib/mergeIamTemplates.js within validateStatements(statements). It currently enforces presence of Effect, Action, and Resource.\n- provider.iamRoleStatements are merged into the default role in mergeIamTemplates.merge(). Once validation is relaxed, these statements will be concatenated into the PolicyDocument.Statement as-is.\n- Custom resource role building (lib/plugins/aws/customResources/index.js) deduplicates statements only by comparing the Resource field. While provider-level iamRoleStatements are not used there, event compilers call addCustomResourceToService() with their own iamRoleStatements (which include Resource). For robustness, the dedupe logic should be adjusted to not assume Resource always exists.\n- Documentation in docs/providers/aws/guide/iam.md currently illustrates only Action/Resource examples. It should be updated to describe and show NotAction/NotResource usage and cautions.\n\nImplementation Plan:\n1) Update validation to support NotAction/NotResource\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function: validateStatements(statements)\n- Changes:\n  - Modify the validation rules to:\n    - Require Effect to be present.\n    - Require exactly one of Action or NotAction to be present. If neither is present, flag an error. If both are present, flag an error.\n    - Require exactly one of Resource or NotResource to be present. If neither is present, flag an error. If both are present, flag an error.\n  - Update error messages to reflect the new accepted forms, e.g., “Each statement must include Effect and either Action or NotAction, and either Resource or NotResource. Statement X violates …”.\n  - Keep the existing array type check for the statements input.\n  - Do not enforce type/shape of Action/Resource values beyond presence; retain compatibility with CloudFormation intrinsics allowed today.\n\n2) Ensure merging accepts these statements\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function: mergeIamTemplates.merge() (implicit via mergeIamTemplates.mergeIamTemplates() and subsequent lines 129–136)\n- Changes:\n  - No structural change needed; concatenation of iamRoleStatements to PolicyDocument.Statement should remain as-is because IAM will accept NotAction/NotResource in the generated JSON.\n  - Confirm any internal logic does not assume Action/Resource when concatenating; current code just concatenates arrays and is fine.\n\n3) Make deduplication robust in custom resources\n- File: lib/plugins/aws/customResources/index.js\n- Code block: lines 155–160 (where it deduplicates before pushing iamRoleStatements into the custom resource role PolicyDocument.Statement)\n- Changes:\n  - Adjust the dedupe predicate to consider both Resource and NotResource:\n    - If newStmt has Resource, compare existingStmt.Resource === newStmt.Resource as today.\n    - If newStmt has NotResource, dedupe by comparing existingStmt.NotResource === newStmt.NotResource.\n    - If neither key is present (highly unlikely for IAM statements but for completeness), fallback to deep equality check of the whole statement object to avoid accidental drops.\n  - This prevents incorrectly treating all NotResource statements as duplicates due to undefined Resource.\n\n4) Documentation updates\n- File: docs/providers/aws/guide/iam.md\n- Sections to modify:\n  - Expand “The Default IAM Role” section to state that provider.iamRoleStatements support NotAction and NotResource.\n  - Add a new subsection showing examples:\n    - Example of Allow with NotResource to permit SNS Publish to phone numbers but not to topics, referencing AWS’s recommended pattern.\n    - Example of Deny using NotAction or NotResource to clarify semantics and caution about careful usage.\n  - Include a brief note on best practices and potential security implications when using NotAction/NotResource.\n\nConsiderations:\n- Impacts on existing functionality:\n  - Existing users with Action/Resource continue to pass validation unchanged.\n  - Users with NotAction or NotResource will now be accepted and merged into the default role policy.\n  - Custom resource IAM role deduping change is conservative and should not affect existing behavior for statements that include Resource, but it avoids incorrect deduping for future cases where NotResource appears.\n- Backward compatibility:\n  - Validation changes broaden acceptance and do not remove existing accepted forms.\n  - Error messages are updated but remain informative.\n  - No changes to how policies are generated besides accepting more valid IAM constructs.\n- Dependencies and prerequisites:\n  - None external; changes are internal to validation and minimal dedupe logic.\n  - Ensure any unit/integration tests around iamRoleStatements validation are updated to include cases for NotAction and NotResource (e.g., statements with Effect + NotAction + Resource, Effect + Action + NotResource, and errors for both Action/NotAction present or both Resource/NotResource present).\n- Edge cases:\n  - Statements with CloudFormation intrinsics are still supported; validation only checks property presence.\n  - Be cautious not to attempt to “normalize” or transform NotAction/NotResource; leave them as-is for IAM to interpret.\n  - IAM semantics of NotAction/NotResource can be subtle; the framework should not enforce effect-specific restrictions, just accept valid shape.\n\nWhy these changes implement the feature:\n- The build errors stem from overly strict validation requiring Action and Resource. Allowing NotAction/NotResource aligns the validator with IAM’s schema, enabling users to define advanced IAM statements that AWS supports.\n- The merge logic already handles arbitrary statements, so no changes are needed there beyond ensuring statements pass validation.\n- Documentation updates make the new capability discoverable and provide an example pattern aligned with the reported use case.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 21:22:19,832 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HqbHiOUnmUKflIZoVrqS9bW7', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1378, 'prompt_tokens': 19537, 'total_tokens': 20915, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1344, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c435f24d-73c4-4f30-a034-35fdad4031c7-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_HqbHiOUnmUKflIZoVrqS9bW7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19537, 'output_tokens': 1378, 'total_tokens': 20915, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 1344}}
2025-11-13 21:27:32,023 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_KOinmkt2kvGtu8QYhY5wEleC', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 543, 'prompt_tokens': 21796, 'total_tokens': 22339, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d985633c-1e94-4d97-8a75-8a3d74ebb7b5-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_KOinmkt2kvGtu8QYhY5wEleC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21796, 'output_tokens': 543, 'total_tokens': 22339, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 21:27:33,679 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XKKa5pOFdG7UiHQoe8xpfu00', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 23882, 'total_tokens': 23908, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bc30cb7e-111d-4a9f-a8dd-121ae56e4d35-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_XKKa5pOFdG7UiHQoe8xpfu00', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23882, 'output_tokens': 26, 'total_tokens': 23908, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:28:18,580 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yKs9Xhu7vCRzk4zSJ2mX6Hsx', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js","old_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\\n    // Action: ..., Resource: ... } objects.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\\n          prop => statement[prop] === undefined\\n        );\\n        return missing.length === 0\\n          ? null\\n          : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect, Action, Resource fields.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },","new_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of statement objects with:\\n    // - Effect\\n    // - exactly one of Action or NotAction\\n    // - exactly one of Resource or NotResource\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const errors = [];\\n        if (statement.Effect === undefined) {\\n          errors.push(\'Effect\');\\n        }\\n        const hasAction = statement.Action !== undefined;\\n        const hasNotAction = statement.NotAction !== undefined;\\n        if (hasAction && hasNotAction) {\\n          errors.push(\'both Action and NotAction are present\');\\n        } else if (!hasAction && !hasNotAction) {\\n          errors.push(\'neither Action nor NotAction is present\');\\n        }\\n        const hasResource = statement.Resource !== undefined;\\n        const hasNotResource = statement.NotResource !== undefined;\\n        if (hasResource && hasNotResource) {\\n          errors.push(\'both Resource and NotResource are present\');\\n        } else if (!hasResource && !hasNotResource) {\\n          errors.push(\'neither Resource nor NotResource is present\');\\n        }\\n        if (errors.length === 0) {\\n          return null;\\n        }\\n        const missingEffect = statement.Effect === undefined ? [\'Effect\'] : [];\\n        if (missingEffect.length && errors.length === 1) {\\n          return `statement ${i} is missing the following properties: ${missingEffect.join(\', \')}`;\\n        }\\n        return `statement ${i} violates validation: ${errors.join(\', \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect and either Action or NotAction, and either Resource or NotResource.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3943, 'prompt_tokens': 27282, 'total_tokens': 31225, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3072, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 23808}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b6aa52c1-f409-4e41-b5ac-84314e68b181-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js', 'old_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n    // Action: ..., Resource: ... } objects.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const missing = ['Effect', 'Action', 'Resource'].filter(\n          prop => statement[prop] === undefined\n        );\n        return missing.length === 0\n          ? null\n          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect, Action, Resource fields.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },", 'new_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of statement objects with:\n    // - Effect\n    // - exactly one of Action or NotAction\n    // - exactly one of Resource or NotResource\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const errors = [];\n        if (statement.Effect === undefined) {\n          errors.push('Effect');\n        }\n        const hasAction = statement.Action !== undefined;\n        const hasNotAction = statement.NotAction !== undefined;\n        if (hasAction && hasNotAction) {\n          errors.push('both Action and NotAction are present');\n        } else if (!hasAction && !hasNotAction) {\n          errors.push('neither Action nor NotAction is present');\n        }\n        const hasResource = statement.Resource !== undefined;\n        const hasNotResource = statement.NotResource !== undefined;\n        if (hasResource && hasNotResource) {\n          errors.push('both Resource and NotResource are present');\n        } else if (!hasResource && !hasNotResource) {\n          errors.push('neither Resource nor NotResource is present');\n        }\n        if (errors.length === 0) {\n          return null;\n        }\n        const missingEffect = statement.Effect === undefined ? ['Effect'] : [];\n        if (missingEffect.length && errors.length === 1) {\n          return `statement ${i} is missing the following properties: ${missingEffect.join(', ')}`;\n        }\n        return `statement ${i} violates validation: ${errors.join(', ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect and either Action or NotAction, and either Resource or NotResource.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },"}, 'id': 'call_yKs9Xhu7vCRzk4zSJ2mX6Hsx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27282, 'output_tokens': 3943, 'total_tokens': 31225, 'input_token_details': {'audio': 0, 'cache_read': 23808}, 'output_token_details': {'audio': 0, 'reasoning': 3072}}
2025-11-13 21:28:20,944 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_whPUH6qVPCG4giUQricKwlY3', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 28170, 'total_tokens': 28198, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1c30f0a5-3918-4cf9-8b18-34169f60be55-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_whPUH6qVPCG4giUQricKwlY3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28170, 'output_tokens': 28, 'total_tokens': 28198, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:28:23,524 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pjwl1Vt6d9CXgKePHgwGUEgx', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\\n          Statement.push(newStmt);\\n        }\\n      });\\n","new_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        const isDuplicate = Statement.find(existingStmt => {\\n          if (newStmt.Resource !== undefined) {\\n            return existingStmt.Resource === newStmt.Resource;\\n          }\\n          if (newStmt.NotResource !== undefined) {\\n            return existingStmt.NotResource === newStmt.NotResource;\\n          }\\n          return _.isEqual(existingStmt, newStmt);\\n        });\\n        if (!isDuplicate) {\\n          Statement.push(newStmt);\\n        }\\n      });\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 228, 'prompt_tokens': 30694, 'total_tokens': 30922, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8a8922e5-e3c8-4926-b890-5476214df5ed-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n          Statement.push(newStmt);\n        }\n      });\n', 'new_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        const isDuplicate = Statement.find(existingStmt => {\n          if (newStmt.Resource !== undefined) {\n            return existingStmt.Resource === newStmt.Resource;\n          }\n          if (newStmt.NotResource !== undefined) {\n            return existingStmt.NotResource === newStmt.NotResource;\n          }\n          return _.isEqual(existingStmt, newStmt);\n        });\n        if (!isDuplicate) {\n          Statement.push(newStmt);\n        }\n      });\n'}, 'id': 'call_pjwl1Vt6d9CXgKePHgwGUEgx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30694, 'output_tokens': 228, 'total_tokens': 30922, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:28:25,369 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_d7IrkwLXqSCUYIclXVlV1AnE', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 30942, 'total_tokens': 30967, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 21760}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9c7aa59f-6227-451a-8aca-195ca492454c-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_d7IrkwLXqSCUYIclXVlV1AnE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30942, 'output_tokens': 25, 'total_tokens': 30967, 'input_token_details': {'audio': 0, 'cache_read': 21760}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:28:41,846 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_zAGvW6R0P0HKNDmBFugLFx8C', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"\'use strict\';\\n\\nconst path = require(\'path\');\\nconst crypto = require(\'crypto\');\\nconst BbPromise = require(\'bluebird\');\\nconst fse = BbPromise.promisifyAll(require(\'fs-extra\'));\\nconst childProcess = BbPromise.promisifyAll(require(\'child_process\'));\\nconst getTmpDirPath = require(\'../../../utils/fs/getTmpDirPath\');\\nconst createZipFile = require(\'../../../utils/fs/createZipFile\');\\n","new_content":"\'use strict\';\\n\\nconst path = require(\'path\');\\nconst crypto = require(\'crypto\');\\nconst BbPromise = require(\'bluebird\');\\nconst _ = require(\'lodash\');\\nconst fse = BbPromise.promisifyAll(require(\'fs-extra\'));\\nconst childProcess = BbPromise.promisifyAll(require(\'child_process\'));\\nconst getTmpDirPath = require(\'../../../utils/fs/getTmpDirPath\');\\nconst createZipFile = require(\'../../../utils/fs/createZipFile\');\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1146, 'prompt_tokens': 33107, 'total_tokens': 34253, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--317b7fb8-59b0-42ce-9da6-565bb8635ce4-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': "'use strict';\n\nconst path = require('path');\nconst crypto = require('crypto');\nconst BbPromise = require('bluebird');\nconst fse = BbPromise.promisifyAll(require('fs-extra'));\nconst childProcess = BbPromise.promisifyAll(require('child_process'));\nconst getTmpDirPath = require('../../../utils/fs/getTmpDirPath');\nconst createZipFile = require('../../../utils/fs/createZipFile');\n", 'new_content': "'use strict';\n\nconst path = require('path');\nconst crypto = require('crypto');\nconst BbPromise = require('bluebird');\nconst _ = require('lodash');\nconst fse = BbPromise.promisifyAll(require('fs-extra'));\nconst childProcess = BbPromise.promisifyAll(require('child_process'));\nconst getTmpDirPath = require('../../../utils/fs/getTmpDirPath');\nconst createZipFile = require('../../../utils/fs/createZipFile');\n"}, 'id': 'call_zAGvW6R0P0HKNDmBFugLFx8C', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33107, 'output_tokens': 1146, 'total_tokens': 34253, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 21:28:45,904 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_MjOD8Ll3WQohGmRvh2ioV7e7', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\\n\\n```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n```\\n","new_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\\n\\nStatements support both Action/Resource and the complementary NotAction/NotResource elements as per AWS IAM policy syntax. Each statement must include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.\\n\\n```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n    # Example: allow SNS Publish to SMS (phone numbers) but not to SNS topics\\n    - Effect: \'Allow\'\\n      Action: \'sns:Publish\'\\n      NotResource: \'arn:aws:sns:*:*:*\'\\n```\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 556, 'prompt_tokens': 33371, 'total_tokens': 33927, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30848}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ea66625c-8f4c-418c-abf3-79089730ff1f-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': "To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n\n```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n```\n", 'new_content': "To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n\nStatements support both Action/Resource and the complementary NotAction/NotResource elements as per AWS IAM policy syntax. Each statement must include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.\n\n```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n    # Example: allow SNS Publish to SMS (phone numbers) but not to SNS topics\n    - Effect: 'Allow'\n      Action: 'sns:Publish'\n      NotResource: 'arn:aws:sns:*:*:*'\n```\n"}, 'id': 'call_MjOD8Ll3WQohGmRvh2ioV7e7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33371, 'output_tokens': 556, 'total_tokens': 33927, 'input_token_details': {'audio': 0, 'cache_read': 30848}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:28:48,834 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_1uSUr0nPRacNyz83KQRONvlt', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 33948, 'total_tokens': 33974, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27264}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--674450f5-707e-48db-9443-fd6d7e731e59-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_1uSUr0nPRacNyz83KQRONvlt', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33948, 'output_tokens': 26, 'total_tokens': 33974, 'input_token_details': {'audio': 0, 'cache_read': 27264}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:28:58,441 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I implemented support for NotAction and NotResource in IAM role statements and adjusted deduplication logic and documentation accordingly.\n\nChanges made:\n- Updated validation in lib/plugins/aws/package/lib/mergeIamTemplates.js:\n  - Each IAM statement now must include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.\n  - Improved error messaging to reflect the new validation rules.\n\n- Enhanced deduplication in lib/plugins/aws/customResources/index.js:\n  - Dedupe now checks Resource or NotResource appropriately; if neither is present, it falls back to deep equality.\n  - Added lodash import to support deep equality checks.\n\n- Updated documentation in docs/providers/aws/guide/iam.md:\n  - Clarified that provider.iamRoleStatements support NotAction and NotResource.\n  - Added an example demonstrating NotResource with sns:Publish to exclude SNS topics.\n\nThe changes have been verified by reading the modified files.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 774, 'prompt_tokens': 37454, 'total_tokens': 38228, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30848}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--5a1b5cd0-f170-48a9-92ad-7f5c3dd5f94b-0' usage_metadata={'input_tokens': 37454, 'output_tokens': 774, 'total_tokens': 38228, 'input_token_details': {'audio': 0, 'cache_read': 30848}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 21:28:58,479 - thread-135845298308800.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md
index f08eef33c..1714a9b5c 100644
--- a/docs/providers/aws/guide/iam.md
+++ b/docs/providers/aws/guide/iam.md
@@ -22,6 +22,8 @@ By default, one IAM Role is shared by all of the Lambda functions in your servic
 
 To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
 
+Statements support both Action/Resource and the complementary NotAction/NotResource elements as per AWS IAM policy syntax. Each statement must include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.
+
 ```yml
 service: new-service
 
@@ -45,6 +47,10 @@ provider:
           - - 'arn:aws:s3:::'
             - Ref: ServerlessDeploymentBucket
             - '/*'
+    # Example: allow SNS Publish to SMS (phone numbers) but not to SNS topics
+    - Effect: 'Allow'
+      Action: 'sns:Publish'
+      NotResource: 'arn:aws:sns:*:*:*'
 ```
 
 Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
diff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js
index b3b9b4f99..e7b83d581 100644
--- a/lib/plugins/aws/customResources/index.js
+++ b/lib/plugins/aws/customResources/index.js
@@ -3,6 +3,7 @@
 const path = require('path');
 const crypto = require('crypto');
 const BbPromise = require('bluebird');
+const _ = require('lodash');
 const fse = BbPromise.promisifyAll(require('fs-extra'));
 const childProcess = BbPromise.promisifyAll(require('child_process'));
 const getTmpDirPath = require('../../../utils/fs/getTmpDirPath');
@@ -154,7 +155,16 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements
       }
       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
       iamRoleStatements.forEach(newStmt => {
-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
+        const isDuplicate = Statement.find(existingStmt => {
+          if (newStmt.Resource !== undefined) {
+            return existingStmt.Resource === newStmt.Resource;
+          }
+          if (newStmt.NotResource !== undefined) {
+            return existingStmt.NotResource === newStmt.NotResource;
+          }
+          return _.isEqual(existingStmt, newStmt);
+        });
+        if (!isDuplicate) {
           Statement.push(newStmt);
         }
       });
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js
index 2d97671ad..5abd66f0f 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -182,8 +182,10 @@ module.exports = {
   },
 
   validateStatements(statements) {
-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
-    // Action: ..., Resource: ... } objects.
+    // Verify that iamRoleStatements (if present) is an array of statement objects with:
+    // - Effect
+    // - exactly one of Action or NotAction
+    // - exactly one of Resource or NotResource
     if (!statements) {
       return;
     }
@@ -192,12 +194,32 @@ module.exports = {
       violationsFound = 'it is not an array';
     } else {
       const descriptions = statements.map((statement, i) => {
-        const missing = ['Effect', 'Action', 'Resource'].filter(
-          prop => statement[prop] === undefined
-        );
-        return missing.length === 0
-          ? null
-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
+        const errors = [];
+        if (statement.Effect === undefined) {
+          errors.push('Effect');
+        }
+        const hasAction = statement.Action !== undefined;
+        const hasNotAction = statement.NotAction !== undefined;
+        if (hasAction && hasNotAction) {
+          errors.push('both Action and NotAction are present');
+        } else if (!hasAction && !hasNotAction) {
+          errors.push('neither Action nor NotAction is present');
+        }
+        const hasResource = statement.Resource !== undefined;
+        const hasNotResource = statement.NotResource !== undefined;
+        if (hasResource && hasNotResource) {
+          errors.push('both Resource and NotResource are present');
+        } else if (!hasResource && !hasNotResource) {
+          errors.push('neither Resource nor NotResource is present');
+        }
+        if (errors.length === 0) {
+          return null;
+        }
+        const missingEffect = statement.Effect === undefined ? ['Effect'] : [];
+        if (missingEffect.length && errors.length === 1) {
+          return `statement ${i} is missing the following properties: ${missingEffect.join(', ')}`;
+        }
+        return `statement ${i} violates validation: ${errors.join(', ')}`;
       });
       const flawed = descriptions.filter(curr => curr);
       if (flawed.length) {
@@ -208,7 +230,7 @@ module.exports = {
     if (violationsFound) {
       const errorMessage = [
         'iamRoleStatements should be an array of objects,',
-        ' where each object has Effect, Action, Resource fields.',
+        ' where each object has Effect and either Action or NotAction, and either Resource or NotResource.',
         ` Specifically, ${violationsFound}`,
       ].join('');
       throw new this.serverless.classes.Error(errorMessage);

2025-11-13 21:28:58,481 - thread-135845298308800.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 21:28:58,504 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 21:28:58,505 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 21:28:58,508 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n' additional_kwargs={} response_metadata={}
2025-11-13 21:29:31,542 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_LVVQ9yWUM19cSdXPzTEY3E7l', 'function': {'arguments': '{"query":"AWS IAM policy elements NotAction NotResource documentation exclusivity Action vs NotAction Resource vs NotResource"}', 'name': 'web_search'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3306, 'prompt_tokens': 17735, 'total_tokens': 21041, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3264, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--76299295-443e-4768-932a-f1ac8ac8e489-0' tool_calls=[{'name': 'web_search', 'args': {'query': 'AWS IAM policy elements NotAction NotResource documentation exclusivity Action vs NotAction Resource vs NotResource'}, 'id': 'call_LVVQ9yWUM19cSdXPzTEY3E7l', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17735, 'output_tokens': 3306, 'total_tokens': 21041, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3264}}
2025-11-13 21:29:31,546 - thread-135845298308800.prometheus.tools.web_search - DEBUG - Query: AWS IAM policy elements NotAction NotResource documentation exclusivity Action vs NotAction Resource vs NotResource
2025-11-13 21:29:35,466 - thread-135845298308800.prometheus.tools.web_search - INFO - web_search format_response: Answer: In AWS IAM policies, "Action" specifies allowed actions, while "NotAction" denies specific actions. "Resource" specifies allowed resources, and "NotResource" denies specific resources. These are mutually exclusive pairs.

Sources:
- AWS IAM Policy JSON Schema: https://gist.github.com/jstewmon/ee5d4b7ec0d8d60cbc303cb515272f8a
- Can I search existing IAM policies for a specific action?: https://stackoverflow.com/questions/38270609/can-i-search-existing-iam-policies-for-a-specific-action
- How to deny all actions except one in an IAM resource policy: https://stackoverflow.com/questions/79020035/how-to-deny-all-actions-except-one-in-an-iam-resource-policy
- AWS Lambda function seems to ignore its specified ...: https://stackoverflow.com/questions/48236169/aws-lambda-function-seems-to-ignore-its-specified-execution-role
- wp-plugins/updraftplus: WordPress.org Plugin Mirror: https://github.com/wp-plugins/updraftplus

Detailed Results:

Title: AWS IAM Policy JSON Schema
URL: https://gist.github.com/jstewmon/ee5d4b7ec0d8d60cbc303cb515272f8a
Content: Just looking at the required section for the 'Statement' you have 'Action' and 'Resource' in there but they are mutually exclusive with their 'NotAction' and '

Title: Can I search existing IAM policies for a specific action?
URL: https://stackoverflow.com/questions/38270609/can-i-search-existing-iam-policies-for-a-specific-action
Content: In AWS IAM is there a way, either by scripting or in the web console, to find which existing policies contain a given action?

Title: How to deny all actions except one in an IAM resource policy
URL: https://stackoverflow.com/questions/79020035/how-to-deny-all-actions-except-one-in-an-iam-resource-policy
Content: I am trying to craft an S3 bucket policy to deny all actions except one (S3:GetBucketLocation) in the IAM resource policy, with a condition on the principal

Title: AWS Lambda function seems to ignore its specified ...
URL: https://stackoverflow.com/questions/48236169/aws-lambda-function-seems-to-ignore-its-specified-execution-role
Content: The Lambda function and the Lambda infrastructure aren't actually looking at or aware of the permissions associated with the execution role.

Title: wp-plugins/updraftplus: WordPress.org Plugin Mirror
URL: https://github.com/wp-plugins/updraftplus
Content: | index.html | | index.html |  |  |
| options.php | | options.php |  |  |
| readme.txt | | readme.txt |  |  |
| restorer.php | | restorer.php |  |  |
| updraftplus.php | | updraftplus.php |  |  |
| View all files | | | [...] | Name | | Name | Last commit message | Last commit date |
 ---  --- 
| Latest commit   History1,110 Commits | | |
| images | | images |  |  |
| includes | | includes |  |  |
| languages | | languages |  |  |
| methods | | methods |  |  |
| oc | | oc |  |  |
| admin.php | | admin.php |  |  |
| backup.php | | backup.php |  |  |
| class-updraftplus.php | | class-updraftplus.php |  |  |
| class-zip.php | | class-zip.php |  |  |
| example-decrypt.php | | example-decrypt.php |  |  | [...] ## Navigation Menu

# Search code, repositories, users, issues, pull requests...

# Provide feedback

We read every piece of feedback, and take your input very seriously.

# Saved searches

## Use saved searches to filter your results more quickly

To see all available qualifiers, see our documentation.

WordPress.org Plugin Mirror

### Uh oh!

There was an error while loading. Please reload this page.

There was an error while loading. Please reload this page.

# wp-plugins/updraftplus
2025-11-13 21:30:16,673 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='Below is a high-level analysis and implementation plan to add support for NotAction and NotResource in IAM role statements.\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Serverless currently rejects iamRoleStatements that use NotAction or NotResource because the validation enforces Action and Resource presence. The feature request asks to support NotAction and NotResource in iamRoleStatements as they are valid AWS IAM policy elements.\n  - Example use case: Allow sns:Publish but exclude SNS topic resources by using NotResource.\n\n- Requirements:\n  - Accept IAM policy statements in provider.iamRoleStatements that contain either:\n    - Action or NotAction (mutually exclusive)\n    - Resource or NotResource (mutually exclusive)\n  - Continue to pass through statements unchanged into the generated CloudFormation IAM policy.\n\n- Ambiguities and edge cases:\n  - Mutual exclusivity: AWS IAM policies do not allow Action with NotAction in the same statement, nor Resource with NotResource. Validation should reflect that to fail early with a clear error.\n  - Cross-pair requirements: While AWS docs commonly pair NotAction with Resource, and NotResource with Action, the general support should not enforce cross-pair restrictions beyond mutual exclusivity. Let AWS validation handle more nuanced cases.\n  - Statement merging/deduplication logic elsewhere in the code sometimes checks “statement.Resource” for deduplication. Ensure that adding NotResource does not break these paths or result in unexpected duplicates. These paths currently only handle framework-generated statements, but adding a defensive check is low risk.\n\n2) Architecture Analysis\n\n- Main integration point:\n  - Validation occurs in lib/plugins/aws/package/lib/mergeIamTemplates.js via validateStatements(). This function currently enforces that Effect, Action, and Resource must be present on each iamRoleStatements entry.\n  - After validation, the statements are merged verbatim into the default role policy in merge() (same module) by concatenating provider.iamRoleStatements into PolicyDocument.Statement.\n\n- Related code areas to review:\n  - lib/plugins/aws/customResources/index.js merges iamRoleStatements for custom resources’ roles and compares statements by Resource for deduplication. This currently applies to internally generated statements (not provider.iamRoleStatements), but we should ensure it won’t assume Resource always exists.\n  - Documentation in docs/providers/aws/guide/iam.md should reflect support for NotAction and NotResource, including examples and constraints (mutual exclusivity).\n\n- Architectural conventions:\n  - Validation is kept minimal and defers to AWS for deep policy validation.\n  - The framework generally merges user-provided structures directly into the CloudFormation template, respecting CloudFormation intrinsic functions.\n\n3) Implementation Plan\n\nA) Update validation to support NotAction and NotResource\n\n- File to modify: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function to change: validateStatements(statements)\n- Changes:\n  - Replace the current requirement that every statement must include Effect, Action, Resource with the following validation rules:\n    - Effect must be present.\n    - Exactly one of Action or NotAction must be present.\n    - Exactly one of Resource or NotResource must be present.\n  - Update the error message to clearly state the rules, e.g., “Each statement must have Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.”\n  - Keep acceptance of arrays, strings, or intrinsic functions for these properties; do not restrict the value types further in validation.\n- Rationale:\n  - This relaxes validation to match AWS IAM capabilities while still catching structurally invalid statements early.\n\nB) Optionally guard deduplication logic to be resilient to NotResource\n\n- File to modify: lib/plugins/aws/customResources/index.js\n- Code block to review: lines 155–160 (where Statement.find checks existingStmt.Resource === newStmt.Resource)\n- Change:\n  - Adjust the deduplication condition to consider both Resource and NotResource, e.g., avoid assuming Resource is always present by checking:\n    - If newStmt has Resource: dedupe on Resource equality as today.\n    - If newStmt has NotResource: optionally dedupe on NotResource equality to prevent accidental duplicates.\n- Rationale:\n  - While this path uses internally constructed statements with Resource, adding the guard makes the code more robust and future-proof if any path ever introduces a NotResource statement.\n\nC) Update documentation to reflect support and constraints\n\n- File to modify: docs/providers/aws/guide/iam.md\n- Sections to update:\n  - In “The Default IAM Role” section where iamRoleStatements are described, add:\n    - Statement that Action or NotAction is supported (mutually exclusive).\n    - Statement that Resource or NotResource is supported (mutually exclusive).\n    - A short example of NotResource use similar to the issue’s example.\n  - Optionally add a short note reminding that detailed semantics are governed by AWS IAM (link to official AWS docs) and that invalid combinations will be rejected by AWS.\n- Rationale:\n  - Keeps docs accurate and guides users on how to craft policies.\n\nD) Tests (if applicable in your repo)\n\n- Add unit tests (if a testing framework exists for this module) to cover validateStatements():\n  - Accepts statements with:\n    - Action + Resource\n    - NotAction + Resource\n    - Action + NotResource\n  - Rejects statements with:\n    - Both Action and NotAction\n    - Both Resource and NotResource\n    - Missing Effect\n  - Existing tests for Action + Resource should remain passing.\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Existing configurations that use Action + Resource remain unaffected.\n  - Only validation logic is relaxed; merging and CFN output remain unchanged.\n  - Potential deduplication changes in customResources/index.js are defensive and should not affect behavior for current internal statements.\n\n- Backward compatibility:\n  - Fully backward compatible; no breaking changes.\n  - The feature only broadens accepted configurations.\n\n- Dependencies or prerequisites:\n  - None beyond knowledge of AWS IAM semantics.\n  - Keep using CloudFormation intrinsic functions without additional validation.\n\n- Edge cases:\n  - Do not attempt to enforce advanced AWS IAM semantics (e.g., cross-pair requirements) in the framework. Let AWS handle that. The framework should only ensure structural correctness and mutual exclusivity where AWS requires it.\n\nThis plan ensures that iamRoleStatements can include NotAction and NotResource, updates validation accordingly, improves resilience in minor deduplication logic, and documents the new support clearly.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3637, 'prompt_tokens': 18654, 'total_tokens': 22291, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2304, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--62270e74-4688-43e7-9f77-0c465368fcfe-0' usage_metadata={'input_tokens': 18654, 'output_tokens': 3637, 'total_tokens': 22291, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 2304}}
2025-11-13 21:30:16,679 - thread-135845298308800.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nBelow is a high-level analysis and implementation plan to add support for NotAction and NotResource in IAM role statements.\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Serverless currently rejects iamRoleStatements that use NotAction or NotResource because the validation enforces Action and Resource presence. The feature request asks to support NotAction and NotResource in iamRoleStatements as they are valid AWS IAM policy elements.\n  - Example use case: Allow sns:Publish but exclude SNS topic resources by using NotResource.\n\n- Requirements:\n  - Accept IAM policy statements in provider.iamRoleStatements that contain either:\n    - Action or NotAction (mutually exclusive)\n    - Resource or NotResource (mutually exclusive)\n  - Continue to pass through statements unchanged into the generated CloudFormation IAM policy.\n\n- Ambiguities and edge cases:\n  - Mutual exclusivity: AWS IAM policies do not allow Action with NotAction in the same statement, nor Resource with NotResource. Validation should reflect that to fail early with a clear error.\n  - Cross-pair requirements: While AWS docs commonly pair NotAction with Resource, and NotResource with Action, the general support should not enforce cross-pair restrictions beyond mutual exclusivity. Let AWS validation handle more nuanced cases.\n  - Statement merging/deduplication logic elsewhere in the code sometimes checks “statement.Resource” for deduplication. Ensure that adding NotResource does not break these paths or result in unexpected duplicates. These paths currently only handle framework-generated statements, but adding a defensive check is low risk.\n\n2) Architecture Analysis\n\n- Main integration point:\n  - Validation occurs in lib/plugins/aws/package/lib/mergeIamTemplates.js via validateStatements(). This function currently enforces that Effect, Action, and Resource must be present on each iamRoleStatements entry.\n  - After validation, the statements are merged verbatim into the default role policy in merge() (same module) by concatenating provider.iamRoleStatements into PolicyDocument.Statement.\n\n- Related code areas to review:\n  - lib/plugins/aws/customResources/index.js merges iamRoleStatements for custom resources’ roles and compares statements by Resource for deduplication. This currently applies to internally generated statements (not provider.iamRoleStatements), but we should ensure it won’t assume Resource always exists.\n  - Documentation in docs/providers/aws/guide/iam.md should reflect support for NotAction and NotResource, including examples and constraints (mutual exclusivity).\n\n- Architectural conventions:\n  - Validation is kept minimal and defers to AWS for deep policy validation.\n  - The framework generally merges user-provided structures directly into the CloudFormation template, respecting CloudFormation intrinsic functions.\n\n3) Implementation Plan\n\nA) Update validation to support NotAction and NotResource\n\n- File to modify: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function to change: validateStatements(statements)\n- Changes:\n  - Replace the current requirement that every statement must include Effect, Action, Resource with the following validation rules:\n    - Effect must be present.\n    - Exactly one of Action or NotAction must be present.\n    - Exactly one of Resource or NotResource must be present.\n  - Update the error message to clearly state the rules, e.g., “Each statement must have Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.”\n  - Keep acceptance of arrays, strings, or intrinsic functions for these properties; do not restrict the value types further in validation.\n- Rationale:\n  - This relaxes validation to match AWS IAM capabilities while still catching structurally invalid statements early.\n\nB) Optionally guard deduplication logic to be resilient to NotResource\n\n- File to modify: lib/plugins/aws/customResources/index.js\n- Code block to review: lines 155–160 (where Statement.find checks existingStmt.Resource === newStmt.Resource)\n- Change:\n  - Adjust the deduplication condition to consider both Resource and NotResource, e.g., avoid assuming Resource is always present by checking:\n    - If newStmt has Resource: dedupe on Resource equality as today.\n    - If newStmt has NotResource: optionally dedupe on NotResource equality to prevent accidental duplicates.\n- Rationale:\n  - While this path uses internally constructed statements with Resource, adding the guard makes the code more robust and future-proof if any path ever introduces a NotResource statement.\n\nC) Update documentation to reflect support and constraints\n\n- File to modify: docs/providers/aws/guide/iam.md\n- Sections to update:\n  - In “The Default IAM Role” section where iamRoleStatements are described, add:\n    - Statement that Action or NotAction is supported (mutually exclusive).\n    - Statement that Resource or NotResource is supported (mutually exclusive).\n    - A short example of NotResource use similar to the issue’s example.\n  - Optionally add a short note reminding that detailed semantics are governed by AWS IAM (link to official AWS docs) and that invalid combinations will be rejected by AWS.\n- Rationale:\n  - Keeps docs accurate and guides users on how to craft policies.\n\nD) Tests (if applicable in your repo)\n\n- Add unit tests (if a testing framework exists for this module) to cover validateStatements():\n  - Accepts statements with:\n    - Action + Resource\n    - NotAction + Resource\n    - Action + NotResource\n  - Rejects statements with:\n    - Both Action and NotAction\n    - Both Resource and NotResource\n    - Missing Effect\n  - Existing tests for Action + Resource should remain passing.\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Existing configurations that use Action + Resource remain unaffected.\n  - Only validation logic is relaxed; merging and CFN output remain unchanged.\n  - Potential deduplication changes in customResources/index.js are defensive and should not affect behavior for current internal statements.\n\n- Backward compatibility:\n  - Fully backward compatible; no breaking changes.\n  - The feature only broadens accepted configurations.\n\n- Dependencies or prerequisites:\n  - None beyond knowledge of AWS IAM semantics.\n  - Keep using CloudFormation intrinsic functions without additional validation.\n\n- Edge cases:\n  - Do not attempt to enforce advanced AWS IAM semantics (e.g., cross-pair requirements) in the framework. Let AWS handle that. The framework should only ensure structural correctness and mutual exclusivity where AWS requires it.\n\nThis plan ensures that iamRoleStatements can include NotAction and NotResource, updates validation accordingly, improves resilience in minor deduplication logic, and documents the new support clearly.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 21:30:21,968 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XGKypfb55i836z2JySGRmVe7', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 482, 'prompt_tokens': 19463, 'total_tokens': 19945, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--eab6dc90-dba1-4418-9ea8-dbb5dce95e17-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_XGKypfb55i836z2JySGRmVe7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19463, 'output_tokens': 482, 'total_tokens': 19945, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:30:28,290 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_l88u99rF1NYrT5Cq5Wh4HyiX', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 543, 'prompt_tokens': 21722, 'total_tokens': 22265, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ca0008b8-a0ad-4c2a-9189-b17ed4155ef6-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_l88u99rF1NYrT5Cq5Wh4HyiX', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21722, 'output_tokens': 543, 'total_tokens': 22265, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 21:30:30,294 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JOjFsEDv7zxHEDhYPh4cbzhX', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 96, 'prompt_tokens': 23808, 'total_tokens': 23904, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--254e9813-6a9b-4a27-a35a-2c98d5f5d2fa-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_JOjFsEDv7zxHEDhYPh4cbzhX', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23808, 'output_tokens': 96, 'total_tokens': 23904, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 21:31:08,047 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nXY0AnpsamuFNVjbsbEflkuA', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js","old_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\\n    // Action: ..., Resource: ... } objects.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\\n          prop => statement[prop] === undefined\\n        );\\n        return missing.length === 0\\n          ? null\\n          : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect, Action, Resource fields.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },","new_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of policy statement objects that\\n    // include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const errors = [];\\n        if (statement.Effect === undefined) {\\n          errors.push(\'missing property: Effect\');\\n        }\\n        const hasAction = statement.Action !== undefined;\\n        const hasNotAction = statement.NotAction !== undefined;\\n        if (!hasAction && !hasNotAction) {\\n          errors.push(\'missing property: Action or NotAction\');\\n        }\\n        if (hasAction && hasNotAction) {\\n          errors.push(\'cannot have both Action and NotAction\');\\n        }\\n        const hasResource = statement.Resource !== undefined;\\n        const hasNotResource = statement.NotResource !== undefined;\\n        if (!hasResource && !hasNotResource) {\\n          errors.push(\'missing property: Resource or NotResource\');\\n        }\\n        if (hasResource && hasNotResource) {\\n          errors.push(\'cannot have both Resource and NotResource\');\\n        }\\n        return errors.length ? `statement ${i} ${errors.join(\', \')}` : null;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect and exactly one of Action or NotAction,\',\\n        \' and exactly one of Resource or NotResource.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5348, 'prompt_tokens': 27208, 'total_tokens': 32556, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 4544, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d9e1e68f-d0dc-49fd-8644-3d374dace6d1-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js', 'old_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n    // Action: ..., Resource: ... } objects.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const missing = ['Effect', 'Action', 'Resource'].filter(\n          prop => statement[prop] === undefined\n        );\n        return missing.length === 0\n          ? null\n          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect, Action, Resource fields.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },", 'new_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of policy statement objects that\n    // include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const errors = [];\n        if (statement.Effect === undefined) {\n          errors.push('missing property: Effect');\n        }\n        const hasAction = statement.Action !== undefined;\n        const hasNotAction = statement.NotAction !== undefined;\n        if (!hasAction && !hasNotAction) {\n          errors.push('missing property: Action or NotAction');\n        }\n        if (hasAction && hasNotAction) {\n          errors.push('cannot have both Action and NotAction');\n        }\n        const hasResource = statement.Resource !== undefined;\n        const hasNotResource = statement.NotResource !== undefined;\n        if (!hasResource && !hasNotResource) {\n          errors.push('missing property: Resource or NotResource');\n        }\n        if (hasResource && hasNotResource) {\n          errors.push('cannot have both Resource and NotResource');\n        }\n        return errors.length ? `statement ${i} ${errors.join(', ')}` : null;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect and exactly one of Action or NotAction,',\n        ' and exactly one of Resource or NotResource.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },"}, 'id': 'call_nXY0AnpsamuFNVjbsbEflkuA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27208, 'output_tokens': 5348, 'total_tokens': 32556, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 4544}}
2025-11-13 21:31:11,640 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xIzzpTNkJm4hsFUEzbmCnrGy', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 28029, 'total_tokens': 28057, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--07261b6a-a308-4d11-851c-04536ef9b0b6-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_xIzzpTNkJm4hsFUEzbmCnrGy', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28029, 'output_tokens': 28, 'total_tokens': 28057, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:31:14,586 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PPRyy9Lty0x6kW3eHmfa5xC4', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\\n          Statement.push(newStmt);\\n        }\\n      });\\n","new_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        const isDuplicate = Statement.find(existingStmt => {\\n          if (existingStmt.Resource !== undefined || newStmt.Resource !== undefined) {\\n            return existingStmt.Resource === newStmt.Resource;\\n          }\\n          if (existingStmt.NotResource !== undefined || newStmt.NotResource !== undefined) {\\n            return existingStmt.NotResource === newStmt.NotResource;\\n          }\\n          return false;\\n        });\\n        if (!isDuplicate) {\\n          Statement.push(newStmt);\\n        }\\n      });\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 234, 'prompt_tokens': 30480, 'total_tokens': 30714, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27136}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ac24c9f1-7c29-410f-9056-1eb48abdb201-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n          Statement.push(newStmt);\n        }\n      });\n', 'new_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        const isDuplicate = Statement.find(existingStmt => {\n          if (existingStmt.Resource !== undefined || newStmt.Resource !== undefined) {\n            return existingStmt.Resource === newStmt.Resource;\n          }\n          if (existingStmt.NotResource !== undefined || newStmt.NotResource !== undefined) {\n            return existingStmt.NotResource === newStmt.NotResource;\n          }\n          return false;\n        });\n        if (!isDuplicate) {\n          Statement.push(newStmt);\n        }\n      });\n'}, 'id': 'call_PPRyy9Lty0x6kW3eHmfa5xC4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30480, 'output_tokens': 234, 'total_tokens': 30714, 'input_token_details': {'audio': 0, 'cache_read': 27136}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:31:16,506 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_qEFdh09yFRnVKIacL9BBv1dD', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 30734, 'total_tokens': 30759, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--73f620fc-03b9-4efc-bffc-cb32babfe0eb-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_qEFdh09yFRnVKIacL9BBv1dD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30734, 'output_tokens': 25, 'total_tokens': 30759, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:31:20,713 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_N3cbW1vEJNtq9lEpuapD3F1D', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 32905, 'total_tokens': 32931, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30592}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--202851f5-57d1-407e-b749-7523ce99cf52-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_N3cbW1vEJNtq9lEpuapD3F1D', 'type': 'tool_call'}] usage_metadata={'input_tokens': 32905, 'output_tokens': 26, 'total_tokens': 32931, 'input_token_details': {'audio': 0, 'cache_read': 30592}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:31:40,490 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JpoZu2Y1tgUjIKt0kAmvLOrN', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\\n","new_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements may use Action or NotAction, and Resource or NotResource (Action and NotAction are mutually exclusive, as are Resource and NotResource).\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1533, 'prompt_tokens': 36305, 'total_tokens': 37838, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1344, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--402306d8-a86a-4850-aca0-7f3d1249da27-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': 'To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n', 'new_content': 'To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements may use Action or NotAction, and Resource or NotResource (Action and NotAction are mutually exclusive, as are Resource and NotResource).\n'}, 'id': 'call_JpoZu2Y1tgUjIKt0kAmvLOrN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 36305, 'output_tokens': 1533, 'total_tokens': 37838, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 1344}}
2025-11-13 21:31:43,820 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_2zHgwOLixYrYnQkNtlNhlIkN', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n```\\n","new_content":"```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n    # Example using NotResource to exclude all SNS topics\\n    - Effect: \'Allow\'\\n      Action: \'sns:Publish\'\\n      NotResource: \'arn:aws:sns:*:*:*\'\\n```\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 380, 'prompt_tokens': 36509, 'total_tokens': 36889, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8a483059-5300-4388-b5c7-584723f5b290-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': "```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n```\n", 'new_content': "```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n    # Example using NotResource to exclude all SNS topics\n    - Effect: 'Allow'\n      Action: 'sns:Publish'\n      NotResource: 'arn:aws:sns:*:*:*'\n```\n"}, 'id': 'call_2zHgwOLixYrYnQkNtlNhlIkN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 36509, 'output_tokens': 380, 'total_tokens': 36889, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:31:50,504 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='Implemented support for NotAction and NotResource in IAM role statements.\n\nSummary of changes:\n- Updated validation logic to allow statements that include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource. Mutually exclusive pairs are enforced with clear errors.\n- Hardened custom resources IAM role statement deduplication to consider NotResource in addition to Resource, avoiding assumptions that Resource is always present.\n- Updated AWS IAM guide documentation to mention support for NotAction and NotResource, including an example using NotResource.\n\nFiles modified:\n- lib/plugins/aws/package/lib/mergeIamTemplates.js\n- lib/plugins/aws/customResources/index.js\n- docs/providers/aws/guide/iam.md\n\nThese changes allow valid IAM statements using NotAction or NotResource to be accepted and merged into the generated IAM policies.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 429, 'prompt_tokens': 36910, 'total_tokens': 37339, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--f587c49e-28af-4fe8-be4a-a17cf4a13927-0' usage_metadata={'input_tokens': 36910, 'output_tokens': 429, 'total_tokens': 37339, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 21:31:50,542 - thread-135845298308800.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md
index f08eef33c..bc5a3dbaa 100644
--- a/docs/providers/aws/guide/iam.md
+++ b/docs/providers/aws/guide/iam.md
@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc
 
 By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
 
-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements may use Action or NotAction, and Resource or NotResource (Action and NotAction are mutually exclusive, as are Resource and NotResource).
 
 ```yml
 service: new-service
@@ -45,6 +45,10 @@ provider:
           - - 'arn:aws:s3:::'
             - Ref: ServerlessDeploymentBucket
             - '/*'
+    # Example using NotResource to exclude all SNS topics
+    - Effect: 'Allow'
+      Action: 'sns:Publish'
+      NotResource: 'arn:aws:sns:*:*:*'
 ```
 
 Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
diff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js
index b3b9b4f99..dc43b9e42 100644
--- a/lib/plugins/aws/customResources/index.js
+++ b/lib/plugins/aws/customResources/index.js
@@ -154,7 +154,16 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements
       }
       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
       iamRoleStatements.forEach(newStmt => {
-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
+        const isDuplicate = Statement.find(existingStmt => {
+          if (existingStmt.Resource !== undefined || newStmt.Resource !== undefined) {
+            return existingStmt.Resource === newStmt.Resource;
+          }
+          if (existingStmt.NotResource !== undefined || newStmt.NotResource !== undefined) {
+            return existingStmt.NotResource === newStmt.NotResource;
+          }
+          return false;
+        });
+        if (!isDuplicate) {
           Statement.push(newStmt);
         }
       });
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js
index 2d97671ad..591859191 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -182,8 +182,8 @@ module.exports = {
   },
 
   validateStatements(statements) {
-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
-    // Action: ..., Resource: ... } objects.
+    // Verify that iamRoleStatements (if present) is an array of policy statement objects that
+    // include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.
     if (!statements) {
       return;
     }
@@ -192,12 +192,27 @@ module.exports = {
       violationsFound = 'it is not an array';
     } else {
       const descriptions = statements.map((statement, i) => {
-        const missing = ['Effect', 'Action', 'Resource'].filter(
-          prop => statement[prop] === undefined
-        );
-        return missing.length === 0
-          ? null
-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
+        const errors = [];
+        if (statement.Effect === undefined) {
+          errors.push('missing property: Effect');
+        }
+        const hasAction = statement.Action !== undefined;
+        const hasNotAction = statement.NotAction !== undefined;
+        if (!hasAction && !hasNotAction) {
+          errors.push('missing property: Action or NotAction');
+        }
+        if (hasAction && hasNotAction) {
+          errors.push('cannot have both Action and NotAction');
+        }
+        const hasResource = statement.Resource !== undefined;
+        const hasNotResource = statement.NotResource !== undefined;
+        if (!hasResource && !hasNotResource) {
+          errors.push('missing property: Resource or NotResource');
+        }
+        if (hasResource && hasNotResource) {
+          errors.push('cannot have both Resource and NotResource');
+        }
+        return errors.length ? `statement ${i} ${errors.join(', ')}` : null;
       });
       const flawed = descriptions.filter(curr => curr);
       if (flawed.length) {
@@ -208,7 +223,8 @@ module.exports = {
     if (violationsFound) {
       const errorMessage = [
         'iamRoleStatements should be an array of objects,',
-        ' where each object has Effect, Action, Resource fields.',
+        ' where each object has Effect and exactly one of Action or NotAction,',
+        ' and exactly one of Resource or NotResource.',
         ` Specifically, ${violationsFound}`,
       ].join('');
       throw new this.serverless.classes.Error(errorMessage);

2025-11-13 21:31:50,544 - thread-135845298308800.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 21:31:50,568 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 21:31:50,570 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 21:31:50,573 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n' additional_kwargs={} response_metadata={}
2025-11-13 21:32:24,734 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='Below is a high-level analysis and implementation plan to support IAM policy elements NotAction and NotResource in Serverless’ AWS provider.\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Allow users to define provider-level iamRoleStatements that include NotAction and/or NotResource, which are valid IAM policy elements per AWS IAM.\n  - Currently build fails when such statements are present because of overly strict validation requiring Action and Resource.\n\n- Requirements:\n  - Update validation to accept statements that use either Action or NotAction.\n  - Update validation to accept statements that use either Resource or NotResource.\n  - Ensure that statements using NotAction/NotResource flow through and are included in the generated IAM PolicyDocument unchanged.\n  - Maintain sensible validation rules: do not allow both Action and NotAction in the same statement, and do not allow both Resource and NotResource in the same statement.\n\n- Ambiguities/edge cases to clarify and handle:\n  - Mixed keys in one statement should be rejected:\n    - Statement must have exactly one of Action or NotAction.\n    - Statement must have exactly one of Resource or NotResource.\n  - Allow other optional policy fields such as Condition, Sid, Principal/NotPrincipal (Principal is not applicable in IAM policies attached to roles, but leave existing behavior unchanged).\n  - Arrays vs strings for Action/NotAction and Resource/NotResource should continue to be accepted as-is (current validation only checks presence).\n  - Deduplication code that keys off .Resource should be updated to handle .NotResource-based statements.\n\n2) Architecture Analysis\n\n- Key integration points:\n  - Validation of iamRoleStatements is performed in lib/plugins/aws/package/lib/mergeIamTemplates.js within validateStatements(statements). This currently enforces presence of Effect, Action, Resource and rejects statements with NotAction/NotResource.\n  - Provider role statements are merged in mergeIamTemplates() by concatenating provider.iamRoleStatements into the default IAM role PolicyDocument. That path should pass through statements unchanged once validation is relaxed.\n  - Custom Resources role assembly in lib/plugins/aws/customResources/index.js deduplicates statements by comparing the Resource property. This should be adjusted to account for NotResource.\n\n- Conventions:\n  - The AWS provider uses CloudFormation templates assembled in compiledCloudFormationTemplate.Resources.\n  - Statement objects are passed through and appended; minimal transformation is performed.\n  - Validation errors use serverless.classes.Error.\n\n- Files impacted:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js (validation logic and messaging)\n  - lib/plugins/aws/customResources/index.js (deduplication of iam role statements)\n  - docs/providers/aws/guide/iam.md (documentation to mention NotAction and NotResource support and examples)\n\n3) Implementation Plan\n\nA. Update validation to permit NotAction/NotResource\n- File to modify: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function to change: validateStatements(statements)\n- Changes:\n  - Adjust the validation to:\n    - Require Effect to be present.\n    - Require exactly one of Action or NotAction to be present.\n    - Require exactly one of Resource or NotResource to be present.\n  - Collect violations accordingly:\n    - If both Action and NotAction are provided in one statement, generate an error for mutually exclusive fields.\n    - If neither Action nor NotAction are provided, error for missing action field.\n    - If both Resource and NotResource are provided in one statement, error for mutually exclusive fields.\n    - If neither Resource nor NotResource are provided, error for missing resource field.\n  - Update the error message to reflect the accepted shapes, e.g., “iamRoleStatements should be an array of objects with Effect and exactly one of Action/NotAction, and exactly one of Resource/NotResource.”\n- Integration:\n  - This change allows provider-level iamRoleStatements with NotAction/NotResource to pass validation and be concatenated into the policy in mergeIamTemplates().\n  - No change to merge() logic is required; statements will be appended as-is.\n\nB. Adjust custom resource IAM role statement deduplication\n- File to modify: lib/plugins/aws/customResources/index.js\n- Code block to change: around lines 155–160 where deduplication is performed before pushing statements into customResourceRole.Properties.Policies[0].PolicyDocument.Statement\n- Changes:\n  - Modify the deduplication logic so it does not only compare the Resource field. Instead:\n    - If newStmt has Resource, compare against existingStmt.Resource.\n    - If newStmt has NotResource, compare against existingStmt.NotResource.\n    - Optionally, strengthen deduplication by considering Action/NotAction and Resource/NotResource together (e.g., treat a statement as duplicate if both its action key and resource key match an existing statement), or fallback to deep equality on the statement object when feasible.\n- Integration:\n  - Ensures that statements with NotResource are deduplicated consistently, avoiding duplicates when using NotResource.\n  - Does not change existing behavior for statements with Resource.\n\nC. Documentation updates\n- File to modify: docs/providers/aws/guide/iam.md\n- Sections:\n  - The Default IAM Role section (lines 19–48) currently shows examples with Action and Resource only.\n- Changes:\n  - Add a subsection or note stating that NotAction and NotResource are supported in iamRoleStatements.\n  - Provide a short example similar to the one from the issue, illustrating NotResource usage with sns:Publish.\n  - Clarify the mutual exclusivity rule: in any single statement, use Action or NotAction, and use Resource or NotResource.\n- Integration:\n  - Improves discoverability and reduces confusion for users.\n\nD. Optional: configuration schema (if present)\n- If there is a JSON schema for provider.iamRoleStatements elsewhere in the codebase (not shown in the provided files), update it to permit NotAction and NotResource alongside Action and Resource with mutual exclusivity constraints.\n- If no schema or it’s not enforced, the validation change above suffices.\n\nE. Tests (if a test suite exists)\n- Add unit tests for validateStatements to ensure:\n  - Valid statements with NotAction + Resource pass.\n  - Valid statements with Action + NotResource pass.\n  - Invalid statements with both Action and NotAction are rejected with an appropriate error.\n  - Invalid statements with both Resource and NotResource are rejected with an appropriate error.\n  - Invalid statements missing both action keys or both resource keys are rejected.\n- Add an integration test that compiles a service with provider.iamRoleStatements including NotResource to confirm the generated PolicyDocument contains the NotResource as expected.\n- If applicable, add a test covering deduplication behavior in custom resources when NotResource is used.\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Existing valid iamRoleStatements using Action/Resource continue to be accepted; no breaking changes.\n  - Users previously blocked by validation errors can now proceed with NotAction/NotResource.\n  - Dedup logic change may slightly alter how duplicates are detected in custom resource roles; behavior remains consistent and should only improve support for NotResource-based statements.\n\n- Backward compatibility:\n  - The validation change is additive and loosens constraints to allow additional valid policy shapes.\n  - Error messaging becomes more informative, but no change for currently valid statements.\n\n- Dependencies/prerequisites:\n  - None external; relies on standard AWS IAM behavior and CloudFormation support for NotAction/NotResource.\n  - Ensure any internal schema or validation not shown is updated similarly if present.\n\nThis plan ensures Serverless supports NotAction and NotResource in iamRoleStatements, aligns with AWS IAM semantics, and integrates seamlessly with existing policy generation and custom resource handling.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3695, 'prompt_tokens': 17735, 'total_tokens': 21430, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2112, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--91722f93-c09b-4658-bd38-eae2537e1f11-0' usage_metadata={'input_tokens': 17735, 'output_tokens': 3695, 'total_tokens': 21430, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 2112}}
2025-11-13 21:32:24,740 - thread-135845298308800.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nBelow is a high-level analysis and implementation plan to support IAM policy elements NotAction and NotResource in Serverless’ AWS provider.\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Allow users to define provider-level iamRoleStatements that include NotAction and/or NotResource, which are valid IAM policy elements per AWS IAM.\n  - Currently build fails when such statements are present because of overly strict validation requiring Action and Resource.\n\n- Requirements:\n  - Update validation to accept statements that use either Action or NotAction.\n  - Update validation to accept statements that use either Resource or NotResource.\n  - Ensure that statements using NotAction/NotResource flow through and are included in the generated IAM PolicyDocument unchanged.\n  - Maintain sensible validation rules: do not allow both Action and NotAction in the same statement, and do not allow both Resource and NotResource in the same statement.\n\n- Ambiguities/edge cases to clarify and handle:\n  - Mixed keys in one statement should be rejected:\n    - Statement must have exactly one of Action or NotAction.\n    - Statement must have exactly one of Resource or NotResource.\n  - Allow other optional policy fields such as Condition, Sid, Principal/NotPrincipal (Principal is not applicable in IAM policies attached to roles, but leave existing behavior unchanged).\n  - Arrays vs strings for Action/NotAction and Resource/NotResource should continue to be accepted as-is (current validation only checks presence).\n  - Deduplication code that keys off .Resource should be updated to handle .NotResource-based statements.\n\n2) Architecture Analysis\n\n- Key integration points:\n  - Validation of iamRoleStatements is performed in lib/plugins/aws/package/lib/mergeIamTemplates.js within validateStatements(statements). This currently enforces presence of Effect, Action, Resource and rejects statements with NotAction/NotResource.\n  - Provider role statements are merged in mergeIamTemplates() by concatenating provider.iamRoleStatements into the default IAM role PolicyDocument. That path should pass through statements unchanged once validation is relaxed.\n  - Custom Resources role assembly in lib/plugins/aws/customResources/index.js deduplicates statements by comparing the Resource property. This should be adjusted to account for NotResource.\n\n- Conventions:\n  - The AWS provider uses CloudFormation templates assembled in compiledCloudFormationTemplate.Resources.\n  - Statement objects are passed through and appended; minimal transformation is performed.\n  - Validation errors use serverless.classes.Error.\n\n- Files impacted:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js (validation logic and messaging)\n  - lib/plugins/aws/customResources/index.js (deduplication of iam role statements)\n  - docs/providers/aws/guide/iam.md (documentation to mention NotAction and NotResource support and examples)\n\n3) Implementation Plan\n\nA. Update validation to permit NotAction/NotResource\n- File to modify: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function to change: validateStatements(statements)\n- Changes:\n  - Adjust the validation to:\n    - Require Effect to be present.\n    - Require exactly one of Action or NotAction to be present.\n    - Require exactly one of Resource or NotResource to be present.\n  - Collect violations accordingly:\n    - If both Action and NotAction are provided in one statement, generate an error for mutually exclusive fields.\n    - If neither Action nor NotAction are provided, error for missing action field.\n    - If both Resource and NotResource are provided in one statement, error for mutually exclusive fields.\n    - If neither Resource nor NotResource are provided, error for missing resource field.\n  - Update the error message to reflect the accepted shapes, e.g., “iamRoleStatements should be an array of objects with Effect and exactly one of Action/NotAction, and exactly one of Resource/NotResource.”\n- Integration:\n  - This change allows provider-level iamRoleStatements with NotAction/NotResource to pass validation and be concatenated into the policy in mergeIamTemplates().\n  - No change to merge() logic is required; statements will be appended as-is.\n\nB. Adjust custom resource IAM role statement deduplication\n- File to modify: lib/plugins/aws/customResources/index.js\n- Code block to change: around lines 155–160 where deduplication is performed before pushing statements into customResourceRole.Properties.Policies[0].PolicyDocument.Statement\n- Changes:\n  - Modify the deduplication logic so it does not only compare the Resource field. Instead:\n    - If newStmt has Resource, compare against existingStmt.Resource.\n    - If newStmt has NotResource, compare against existingStmt.NotResource.\n    - Optionally, strengthen deduplication by considering Action/NotAction and Resource/NotResource together (e.g., treat a statement as duplicate if both its action key and resource key match an existing statement), or fallback to deep equality on the statement object when feasible.\n- Integration:\n  - Ensures that statements with NotResource are deduplicated consistently, avoiding duplicates when using NotResource.\n  - Does not change existing behavior for statements with Resource.\n\nC. Documentation updates\n- File to modify: docs/providers/aws/guide/iam.md\n- Sections:\n  - The Default IAM Role section (lines 19–48) currently shows examples with Action and Resource only.\n- Changes:\n  - Add a subsection or note stating that NotAction and NotResource are supported in iamRoleStatements.\n  - Provide a short example similar to the one from the issue, illustrating NotResource usage with sns:Publish.\n  - Clarify the mutual exclusivity rule: in any single statement, use Action or NotAction, and use Resource or NotResource.\n- Integration:\n  - Improves discoverability and reduces confusion for users.\n\nD. Optional: configuration schema (if present)\n- If there is a JSON schema for provider.iamRoleStatements elsewhere in the codebase (not shown in the provided files), update it to permit NotAction and NotResource alongside Action and Resource with mutual exclusivity constraints.\n- If no schema or it’s not enforced, the validation change above suffices.\n\nE. Tests (if a test suite exists)\n- Add unit tests for validateStatements to ensure:\n  - Valid statements with NotAction + Resource pass.\n  - Valid statements with Action + NotResource pass.\n  - Invalid statements with both Action and NotAction are rejected with an appropriate error.\n  - Invalid statements with both Resource and NotResource are rejected with an appropriate error.\n  - Invalid statements missing both action keys or both resource keys are rejected.\n- Add an integration test that compiles a service with provider.iamRoleStatements including NotResource to confirm the generated PolicyDocument contains the NotResource as expected.\n- If applicable, add a test covering deduplication behavior in custom resources when NotResource is used.\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Existing valid iamRoleStatements using Action/Resource continue to be accepted; no breaking changes.\n  - Users previously blocked by validation errors can now proceed with NotAction/NotResource.\n  - Dedup logic change may slightly alter how duplicates are detected in custom resource roles; behavior remains consistent and should only improve support for NotResource-based statements.\n\n- Backward compatibility:\n  - The validation change is additive and loosens constraints to allow additional valid policy shapes.\n  - Error messaging becomes more informative, but no change for currently valid statements.\n\n- Dependencies/prerequisites:\n  - None external; relies on standard AWS IAM behavior and CloudFormation support for NotAction/NotResource.\n  - Ensure any internal schema or validation not shown is updated similarly if present.\n\nThis plan ensures Serverless supports NotAction and NotResource in iamRoleStatements, aligns with AWS IAM semantics, and integrates seamlessly with existing policy generation and custom resource handling.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 21:32:35,835 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XSuREko5TOSqSvT3TPUDTktz', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 994, 'prompt_tokens': 19713, 'total_tokens': 20707, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4f6e8722-2754-4674-97bb-778c587bad13-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_XSuREko5TOSqSvT3TPUDTktz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19713, 'output_tokens': 994, 'total_tokens': 20707, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 21:32:42,346 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dGxDiKNGqpStJilPOmWoZ2Qt', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 671, 'prompt_tokens': 21972, 'total_tokens': 22643, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d131c45f-97b6-45f1-83db-ae2fc55c9073-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_dGxDiKNGqpStJilPOmWoZ2Qt', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21972, 'output_tokens': 671, 'total_tokens': 22643, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:32:43,841 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ZGWbF2aKNcOdqOJgNJSs96yp', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 24058, 'total_tokens': 24084, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7221344b-f4cd-4198-9622-2f4608f47f03-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_ZGWbF2aKNcOdqOJgNJSs96yp', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24058, 'output_tokens': 26, 'total_tokens': 24084, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:33:12,826 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_2g75vcD2oUoSNBovAbmYJKMv', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js","old_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\\n    // Action: ..., Resource: ... } objects.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\\n          prop => statement[prop] === undefined\\n        );\\n        return missing.length === 0\\n          ? null\\n          : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect, Action, Resource fields.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },","new_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of valid policy statement objects,\\n    // each having Effect and exactly one of Action/NotAction and exactly one of Resource/NotResource.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const issues = [];\\n\\n        if (statement.Effect === undefined) {\\n          issues.push(\'missing property: Effect\');\\n        }\\n\\n        const hasAction = statement.Action !== undefined;\\n        const hasNotAction = statement.NotAction !== undefined;\\n        if (hasAction && hasNotAction) {\\n          issues.push(\'has mutually exclusive properties: Action and NotAction\');\\n        } else if (!hasAction && !hasNotAction) {\\n          issues.push(\'missing one of required properties: Action or NotAction\');\\n        }\\n\\n        const hasResource = statement.Resource !== undefined;\\n        const hasNotResource = statement.NotResource !== undefined;\\n        if (hasResource && hasNotResource) {\\n          issues.push(\'has mutually exclusive properties: Resource and NotResource\');\\n        } else if (!hasResource && !hasNotResource) {\\n          issues.push(\'missing one of required properties: Resource or NotResource\');\\n        }\\n\\n        return issues.length === 0\\n          ? null\\n          : `statement ${i} ${issues.join(\'; \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect and exactly one of Action/NotAction, and exactly one of Resource/NotResource.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 4083, 'prompt_tokens': 27458, 'total_tokens': 31541, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3264, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8f63d015-5b6a-4270-a7c4-985f03e0fa73-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js', 'old_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n    // Action: ..., Resource: ... } objects.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const missing = ['Effect', 'Action', 'Resource'].filter(\n          prop => statement[prop] === undefined\n        );\n        return missing.length === 0\n          ? null\n          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect, Action, Resource fields.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },", 'new_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of valid policy statement objects,\n    // each having Effect and exactly one of Action/NotAction and exactly one of Resource/NotResource.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const issues = [];\n\n        if (statement.Effect === undefined) {\n          issues.push('missing property: Effect');\n        }\n\n        const hasAction = statement.Action !== undefined;\n        const hasNotAction = statement.NotAction !== undefined;\n        if (hasAction && hasNotAction) {\n          issues.push('has mutually exclusive properties: Action and NotAction');\n        } else if (!hasAction && !hasNotAction) {\n          issues.push('missing one of required properties: Action or NotAction');\n        }\n\n        const hasResource = statement.Resource !== undefined;\n        const hasNotResource = statement.NotResource !== undefined;\n        if (hasResource && hasNotResource) {\n          issues.push('has mutually exclusive properties: Resource and NotResource');\n        } else if (!hasResource && !hasNotResource) {\n          issues.push('missing one of required properties: Resource or NotResource');\n        }\n\n        return issues.length === 0\n          ? null\n          : `statement ${i} ${issues.join('; ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect and exactly one of Action/NotAction, and exactly one of Resource/NotResource.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },"}, 'id': 'call_2g75vcD2oUoSNBovAbmYJKMv', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27458, 'output_tokens': 4083, 'total_tokens': 31541, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 3264}}
2025-11-13 21:33:14,292 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PCmTPoeFlez3z12dLKRjtJPA', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 28294, 'total_tokens': 28322, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24064}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c2c4d434-61b3-4e54-b22e-b0eded753cd4-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_PCmTPoeFlez3z12dLKRjtJPA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28294, 'output_tokens': 28, 'total_tokens': 28322, 'input_token_details': {'audio': 0, 'cache_read': 24064}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:33:17,630 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gkjgh28KEMpYT5KCbgvkB0S7', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\\n          Statement.push(newStmt);\\n        }\\n      });\\n","new_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        const isDuplicate = Statement.find(existingStmt => {\\n          const newHasResource = newStmt.Resource !== undefined;\\n          const existingHasResource = existingStmt.Resource !== undefined;\\n          const newHasNotResource = newStmt.NotResource !== undefined;\\n          const existingHasNotResource = existingStmt.NotResource !== undefined;\\n\\n          if (newHasResource && existingHasResource) {\\n            return existingStmt.Resource === newStmt.Resource;\\n          }\\n          if (newHasNotResource && existingHasNotResource) {\\n            return existingStmt.NotResource === newStmt.NotResource;\\n          }\\n          return false;\\n        });\\n        if (!isDuplicate) {\\n          Statement.push(newStmt);\\n        }\\n      });\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 283, 'prompt_tokens': 30768, 'total_tokens': 31051, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27392}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fc9f03b3-29b4-4b7d-8e47-ecac11398b66-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n          Statement.push(newStmt);\n        }\n      });\n', 'new_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        const isDuplicate = Statement.find(existingStmt => {\n          const newHasResource = newStmt.Resource !== undefined;\n          const existingHasResource = existingStmt.Resource !== undefined;\n          const newHasNotResource = newStmt.NotResource !== undefined;\n          const existingHasNotResource = existingStmt.NotResource !== undefined;\n\n          if (newHasResource && existingHasResource) {\n            return existingStmt.Resource === newStmt.Resource;\n          }\n          if (newHasNotResource && existingHasNotResource) {\n            return existingStmt.NotResource === newStmt.NotResource;\n          }\n          return false;\n        });\n        if (!isDuplicate) {\n          Statement.push(newStmt);\n        }\n      });\n'}, 'id': 'call_gkjgh28KEMpYT5KCbgvkB0S7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30768, 'output_tokens': 283, 'total_tokens': 31051, 'input_token_details': {'audio': 0, 'cache_read': 27392}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:33:22,477 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OLhiOrr9rXgQEYNcMbiAi9F2', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\\n24. \\n25. ```yml\\n26. service: new-service\\n27. \\n28. provider:\\n29.   name: aws\\n30.   iamRoleStatements:\\n31.     - Effect: \'Allow\'\\n32.       Action:\\n33.         - \'s3:ListBucket\'\\n34.       Resource:\\n35.         Fn::Join:\\n36.           - \'\'\\n37.           - - \'arn:aws:s3:::\'\\n38.             - Ref: ServerlessDeploymentBucket\\n39.     - Effect: \'Allow\'\\n40.       Action:\\n41.         - \'s3:PutObject\'\\n42.       Resource:\\n43.         Fn::Join:\\n44.           - \'\'\\n45.           - - \'arn:aws:s3:::\'\\n46.             - Ref: ServerlessDeploymentBucket\\n47.             - \'/*\'\\n48. ```\\n","new_content":"23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. You may use either `Action` or `NotAction`, and either `Resource` or `NotResource` within a single statement (but not both of each).\\n24. \\n25. ```yml\\n26. service: new-service\\n27. \\n28. provider:\\n29.   name: aws\\n30.   iamRoleStatements:\\n31.     - Effect: \'Allow\'\\n32.       Action:\\n33.         - \'s3:ListBucket\'\\n34.       Resource:\\n35.         Fn::Join:\\n36.           - \'\'\\n37.           - - \'arn:aws:s3:::\'\\n38.             - Ref: ServerlessDeploymentBucket\\n39.     - Effect: \'Allow\'\\n40.       Action:\\n41.         - \'s3:PutObject\'\\n42.       Resource:\\n43.         Fn::Join:\\n44.           - \'\'\\n45.           - - \'arn:aws:s3:::\'\\n46.             - Ref: ServerlessDeploymentBucket\\n47.             - \'/*\'\\n48.     # Example using NotResource to allow publishing to SNS but exclude all SNS topics\\n49.     - Effect: \'Allow\'\\n50.       Action: \'sns:Publish\'\\n51.       NotResource: \'arn:aws:sns:*:*:*\'\\n52. ```\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 656, 'prompt_tokens': 31071, 'total_tokens': 31727, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30976}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dddf277b-a689-4ba7-b7f6-19279d0e2edf-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': "23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: 'Allow'\n32.       Action:\n33.         - 's3:ListBucket'\n34.       Resource:\n35.         Fn::Join:\n36.           - ''\n37.           - - 'arn:aws:s3:::'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: 'Allow'\n40.       Action:\n41.         - 's3:PutObject'\n42.       Resource:\n43.         Fn::Join:\n44.           - ''\n45.           - - 'arn:aws:s3:::'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - '/*'\n48. ```\n", 'new_content': "23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. You may use either `Action` or `NotAction`, and either `Resource` or `NotResource` within a single statement (but not both of each).\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: 'Allow'\n32.       Action:\n33.         - 's3:ListBucket'\n34.       Resource:\n35.         Fn::Join:\n36.           - ''\n37.           - - 'arn:aws:s3:::'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: 'Allow'\n40.       Action:\n41.         - 's3:PutObject'\n42.       Resource:\n43.         Fn::Join:\n44.           - ''\n45.           - - 'arn:aws:s3:::'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - '/*'\n48.     # Example using NotResource to allow publishing to SNS but exclude all SNS topics\n49.     - Effect: 'Allow'\n50.       Action: 'sns:Publish'\n51.       NotResource: 'arn:aws:sns:*:*:*'\n52. ```\n"}, 'id': 'call_OLhiOrr9rXgQEYNcMbiAi9F2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31071, 'output_tokens': 656, 'total_tokens': 31727, 'input_token_details': {'audio': 0, 'cache_read': 30976}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:33:24,886 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_eO6TEh7WJkdJQY9pj3JBdkeQ', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","start_line":19,"end_line":61}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 45, 'prompt_tokens': 31761, 'total_tokens': 31806, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--623eee0b-4076-4b52-94d9-dfc312ed19cb-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'start_line': 19, 'end_line': 61}, 'id': 'call_eO6TEh7WJkdJQY9pj3JBdkeQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31761, 'output_tokens': 45, 'total_tokens': 31806, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:33:36,380 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_iKYIVdyv8BReeTdSiie5kV01', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\\n\\n```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n```","new_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. You may use either `Action` or `NotAction`, and either `Resource` or `NotResource` within a single statement (but not both of each).\\n\\n```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n    # Example using NotResource to allow a lambda to send text messages, but not publish to any SNS topics\\n    - Effect: \'Allow\'\\n      Action: \'sns:Publish\'\\n      NotResource: \'arn:aws:sns:*:*:*\'\\n```"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1508, 'prompt_tokens': 32306, 'total_tokens': 33814, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--caf2a0ff-db2a-4503-b048-b64e0c601f49-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': "To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n\n```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n```", 'new_content': "To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. You may use either `Action` or `NotAction`, and either `Resource` or `NotResource` within a single statement (but not both of each).\n\n```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n    # Example using NotResource to allow a lambda to send text messages, but not publish to any SNS topics\n    - Effect: 'Allow'\n      Action: 'sns:Publish'\n      NotResource: 'arn:aws:sns:*:*:*'\n```"}, 'id': 'call_iKYIVdyv8BReeTdSiie5kV01', 'type': 'tool_call'}] usage_metadata={'input_tokens': 32306, 'output_tokens': 1508, 'total_tokens': 33814, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 21:33:39,086 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_8WX8K3f6FY56QHC79WFnKwrp', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 32869, 'total_tokens': 32895, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f61b5412-a511-4b05-94b7-f2adf9c300c5-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_8WX8K3f6FY56QHC79WFnKwrp', 'type': 'tool_call'}] usage_metadata={'input_tokens': 32869, 'output_tokens': 26, 'total_tokens': 32895, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:33:46,458 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I implemented support for NotAction and NotResource in IAM role statements by making the following precise changes:\n\n- Updated validation in lib/plugins/aws/package/lib/mergeIamTemplates.js:\n  - validateStatements now permits statements that include either Action or NotAction, and either Resource or NotResource (but not both in the same statement).\n  - Added clear error messages for missing Effect, mutually exclusive properties, or missing required properties.\n  - This resolves the previous build failure when using NotAction/NotResource.\n\n- Adjusted custom resource IAM statement deduplication in lib/plugins/aws/customResources/index.js:\n  - The deduplication logic now considers both Resource and NotResource, avoiding duplicates when NotResource is used in statements.\n\n- Updated documentation in docs/providers/aws/guide/iam.md:\n  - Added clarification that iamRoleStatements may use either Action or NotAction, and either Resource or NotResource within a single statement (but not both of each).\n  - Included an example showing NotResource with sns:Publish.\n\nAll changes have been verified by reading the modified files.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 608, 'prompt_tokens': 36362, 'total_tokens': 36970, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 31616}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--fd63ec30-7cfa-43ec-8cf3-0c625f4e7a16-0' usage_metadata={'input_tokens': 36362, 'output_tokens': 608, 'total_tokens': 36970, 'input_token_details': {'audio': 0, 'cache_read': 31616}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 21:33:46,496 - thread-135845298308800.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md
index f08eef33c..fe9808d21 100644
--- a/docs/providers/aws/guide/iam.md
+++ b/docs/providers/aws/guide/iam.md
@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc
 
 By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
 
-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. You may use either `Action` or `NotAction`, and either `Resource` or `NotResource` within a single statement (but not both of each).
 
 ```yml
 service: new-service
@@ -45,6 +45,10 @@ provider:
           - - 'arn:aws:s3:::'
             - Ref: ServerlessDeploymentBucket
             - '/*'
+    # Example using NotResource to allow a lambda to send text messages, but not publish to any SNS topics
+    - Effect: 'Allow'
+      Action: 'sns:Publish'
+      NotResource: 'arn:aws:sns:*:*:*'
 ```
 
 Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
diff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js
index b3b9b4f99..d5f959f36 100644
--- a/lib/plugins/aws/customResources/index.js
+++ b/lib/plugins/aws/customResources/index.js
@@ -154,7 +154,21 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements
       }
       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
       iamRoleStatements.forEach(newStmt => {
-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
+        const isDuplicate = Statement.find(existingStmt => {
+          const newHasResource = newStmt.Resource !== undefined;
+          const existingHasResource = existingStmt.Resource !== undefined;
+          const newHasNotResource = newStmt.NotResource !== undefined;
+          const existingHasNotResource = existingStmt.NotResource !== undefined;
+
+          if (newHasResource && existingHasResource) {
+            return existingStmt.Resource === newStmt.Resource;
+          }
+          if (newHasNotResource && existingHasNotResource) {
+            return existingStmt.NotResource === newStmt.NotResource;
+          }
+          return false;
+        });
+        if (!isDuplicate) {
           Statement.push(newStmt);
         }
       });
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js
index 2d97671ad..2a879155b 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -182,8 +182,8 @@ module.exports = {
   },
 
   validateStatements(statements) {
-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
-    // Action: ..., Resource: ... } objects.
+    // Verify that iamRoleStatements (if present) is an array of valid policy statement objects,
+    // each having Effect and exactly one of Action/NotAction and exactly one of Resource/NotResource.
     if (!statements) {
       return;
     }
@@ -192,12 +192,31 @@ module.exports = {
       violationsFound = 'it is not an array';
     } else {
       const descriptions = statements.map((statement, i) => {
-        const missing = ['Effect', 'Action', 'Resource'].filter(
-          prop => statement[prop] === undefined
-        );
-        return missing.length === 0
+        const issues = [];
+
+        if (statement.Effect === undefined) {
+          issues.push('missing property: Effect');
+        }
+
+        const hasAction = statement.Action !== undefined;
+        const hasNotAction = statement.NotAction !== undefined;
+        if (hasAction && hasNotAction) {
+          issues.push('has mutually exclusive properties: Action and NotAction');
+        } else if (!hasAction && !hasNotAction) {
+          issues.push('missing one of required properties: Action or NotAction');
+        }
+
+        const hasResource = statement.Resource !== undefined;
+        const hasNotResource = statement.NotResource !== undefined;
+        if (hasResource && hasNotResource) {
+          issues.push('has mutually exclusive properties: Resource and NotResource');
+        } else if (!hasResource && !hasNotResource) {
+          issues.push('missing one of required properties: Resource or NotResource');
+        }
+
+        return issues.length === 0
           ? null
-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
+          : `statement ${i} ${issues.join('; ')}`;
       });
       const flawed = descriptions.filter(curr => curr);
       if (flawed.length) {
@@ -208,7 +227,7 @@ module.exports = {
     if (violationsFound) {
       const errorMessage = [
         'iamRoleStatements should be an array of objects,',
-        ' where each object has Effect, Action, Resource fields.',
+        ' where each object has Effect and exactly one of Action/NotAction, and exactly one of Resource/NotResource.',
         ` Specifically, ${violationsFound}`,
       ].join('');
       throw new this.serverless.classes.Error(errorMessage);

2025-11-13 21:33:46,498 - thread-135845298308800.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 21:33:46,523 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 21:33:46,524 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 21:33:46,528 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n' additional_kwargs={} response_metadata={}
2025-11-13 21:34:10,527 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_MnRI394yTPw9iXtPL4Bh2GFX', 'function': {'arguments': '{"query":"AWS IAM policy NotAction and Action together allowed? NotResource vs Resource allowed both? documentation"}', 'name': 'web_search'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2281, 'prompt_tokens': 17735, 'total_tokens': 20016, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2240, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17664}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5a20baf0-c4a0-4fa3-801c-57df780d8bef-0' tool_calls=[{'name': 'web_search', 'args': {'query': 'AWS IAM policy NotAction and Action together allowed? NotResource vs Resource allowed both? documentation'}, 'id': 'call_MnRI394yTPw9iXtPL4Bh2GFX', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17735, 'output_tokens': 2281, 'total_tokens': 20016, 'input_token_details': {'audio': 0, 'cache_read': 17664}, 'output_token_details': {'audio': 0, 'reasoning': 2240}}
2025-11-13 21:34:10,531 - thread-135845298308800.prometheus.tools.web_search - DEBUG - Query: AWS IAM policy NotAction and Action together allowed? NotResource vs Resource allowed both? documentation
2025-11-13 21:34:14,725 - thread-135845298308800.prometheus.tools.web_search - INFO - web_search format_response: Answer: AWS IAM allows both Action and NotAction together in policies. Conditions override, so NotResource does not override Resource. Policies are merged, making the most permissive one effective.

Sources:
- AWS IAM multiple policies with conflicting conditions: https://stackoverflow.com/questions/58066572/aws-iam-multiple-policies-with-conflicting-conditions
- How do I combine these two AWS-IAM policies to allow ...: https://stackoverflow.com/questions/77442087/how-do-i-combine-these-two-aws-iam-policies-to-allow-certain-actions-to-only-cer
- Can I search existing IAM policies for a specific action?: https://stackoverflow.com/questions/38270609/can-i-search-existing-iam-policies-for-a-specific-action
- SwaroopGiri/AWS-SAP-C02-Notes: https://github.com/SwaroopGiri/AWS-SAP-C02-Notes
- AWS DevOps Engineer Professional Study Notes: https://gist.github.com/ejlp12/e8666c6d8c4d88f64f8c0b96972713bf

Detailed Results:

Title: AWS IAM multiple policies with conflicting conditions
URL: https://stackoverflow.com/questions/58066572/aws-iam-multiple-policies-with-conflicting-conditions
Content: ```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "secretsmanager:",
            "Resource": "",
            "Condition": {
                "StringNotEquals": {
                    "secretsmanager:ResourceTag/allow": "False"
                }
            }
        }
    ]
}

```

Which one wins? I don't think you can order policies. How does AWS merge the conditions? [...] ```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "secretsmanager:",
            "Resource": "",
            "Condition": {
                "StringEquals": {
                    "secretsmanager:ResourceTag/allow": "True"
                }
            }
        }
    ]
}

```

Use case #2 above:

The user will always be granted access because of the first policy statement is always true. [...] My other question: I have one policy that has a condition and one does not. Both are attached to the same entity and target the same resources

One policy allows access to all resources with no conditions like this:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "secretsmanager:",
            "Resource": ""
        }
    ]
}

```

One policy has a condition:

Title: How do I combine these two AWS-IAM policies to allow ...
URL: https://stackoverflow.com/questions/77442087/how-do-i-combine-these-two-aws-iam-policies-to-allow-certain-actions-to-only-cer
Content: When combining AWS IAM policies, all statements are merged, and combining allow-only policies results in a more permissive policy, not less.

Title: Can I search existing IAM policies for a specific action?
URL: https://stackoverflow.com/questions/38270609/can-i-search-existing-iam-policies-for-a-specific-action
Content: In AWS IAM is there a way, either by scripting or in the web console, to find which existing policies contain a given action?

Title: SwaroopGiri/AWS-SAP-C02-Notes
URL: https://github.com/SwaroopGiri/AWS-SAP-C02-Notes
Content: These notes are my attempt at helping myself and possibly others to pass the AWS Certified Solutions Architect Professional Exam.

Title: AWS DevOps Engineer Professional Study Notes
URL: https://gist.github.com/ejlp12/e8666c6d8c4d88f64f8c0b96972713bf
Content: AWS DevOps Engineer Professional Study Notes. GitHub Gist: instantly share code, notes, and snippets.
2025-11-13 21:34:51,194 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='Feature Understanding:\n- The request is to allow IAM policy statements in provider.iamRoleStatements that use NotAction and NotResource, which are valid AWS IAM elements. Currently, the framework rejects such statements because validation requires Action and Resource keys.\n- Desired functionality:\n  - Accept IAM role statements that specify either Action or NotAction, and either Resource or NotResource.\n  - Ensure statements that use NotAction/NotResource are merged into the generated IAM PolicyDocument like other statements.\n- Requirements and constraints:\n  - Effect should remain required and be either Allow or Deny.\n  - AWS IAM does not allow using both Action and NotAction within the same statement, nor both Resource and NotResource. Validation should enforce mutual exclusivity.\n  - NotAction/NotResource can be strings or arrays (consistent with IAM policy semantics).\n- Ambiguities/edge cases to clarify:\n  - Deduplication logic when adding statements to custom resource roles currently compares only the Resource field; we need to ensure statements using NotResource are handled and duplicates are identified appropriately. The safest approach is dedup by full statement equality rather than just Resource.\n  - If a user provides a provider-level custom role (provider.role) or function-level role, validation still currently runs on provider.iamRoleStatements even though they’re not merged. Confirm whether we want to keep that behavior; for consistency, keep validation but update it to allow NotAction/NotResource.\n\nArchitecture Analysis:\n- Primary integration points:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js: validateStatements currently enforces presence of Effect, Action, Resource. Update to support NotAction and NotResource, and enforce IAM rules on mutual exclusivity.\n  - lib/plugins/aws/customResources/index.js: When merging iamRoleStatements into the custom resource lambda role, dedup logic uses Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource). This will fail or behave incorrectly if statements have NotResource; update the logic to avoid dependence on Resource and to compare full statements.\n- Other modules that generate IAM statements for events (s3, sqs, streams, eventBridge, cognito) already produce standard Action/Resource statements; they don’t need modification for this feature but should not break if provider.iamRoleStatements include NotAction/NotResource.\n- Documentation needs updating to reflect support for NotAction and NotResource with examples and constraints.\n\nImplementation Plan:\n1) Update validation in lib/plugins/aws/package/lib/mergeIamTemplates.js\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function: validateStatements(statements)\n- Changes:\n  - Replace the hard requirement for Action and Resource with logic that requires:\n    - Effect is present\n    - Exactly one of Action or NotAction is present\n    - Exactly one of Resource or NotResource is present\n  - If both Action and NotAction are present (or both Resource and NotResource), produce a clear error describing mutual exclusivity per IAM policy rules.\n  - Adjust error messages to reflect the new rules, e.g., “Each statement must include Effect and one of Action/NotAction, and one of Resource/NotResource. Action and NotAction cannot be used together; Resource and NotResource cannot be used together.”\n  - Optionally validate Effect value (Allow or Deny) for correctness without being overly strict on types of Action/NotAction and Resource/NotResource to preserve existing flexibility in CloudFormation intrinsic functions.\n- Integration:\n  - The rest of mergeIamTemplates.js (merging default role and concatenating provider.iamRoleStatements) can remain unchanged; PolicyDocument.Statement concatenation should handle NotAction/NotResource entries naturally.\n\n2) Fix deduplication logic when attaching iamRoleStatements to custom resources\n- File: lib/plugins/aws/customResources/index.js\n- Code block around lines 155-160 where pushing new statements:\n  - Current behavior: de-dup checks only equality of the Resource field and then pushes newStmt.\n  - Update:\n    - Modify the deduplication to compare the whole statement object rather than just the Resource field. This ensures statements with NotResource or different Action/NotAction values aren’t incorrectly considered duplicates or erroneously allowed multiple times.\n    - Ensure the code does not assume newStmt.Resource exists; account for NotResource-only statements.\n- Integration:\n  - This change prevents runtime errors and correctly supports NotResource statements when building the custom resource role (e.g., for Cognito, S3, EventBridge custom resources).\n\n3) Documentation update to reflect support for NotAction and NotResource\n- File: docs/providers/aws/guide/iam.md\n- Changes:\n  - Add a brief section or note under “The Default IAM Role” explaining that provider.iamRoleStatements supports NotAction and NotResource.\n  - Include an example using NotResource to allow sns:Publish but exclude SNS topics, as requested:\n    - Example: Effect: Allow, Action: sns:Publish, NotResource: arn:aws:sns:*:*:* (illustrates allowing SMS publish while excluding topic publish).\n  - Clarify constraints:\n    - Do not use Action and NotAction together in the same statement.\n    - Do not use Resource and NotResource together in the same statement.\n    - Link to AWS IAM docs for NotAction and NotResource elements for further reference.\n\n4) Confirm other references to Resource in merging logic won’t break\n- Files to review but likely no changes needed:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js (merging iamRoleStatements via concat, already agnostic)\n  - lib/plugins/aws/package/index.js (calls validateStatements, then merge)\n  - Event compilers (cognitoUserPool, eventBridge, s3, sqs, stream, cloudFront) only push internally generated Action/Resource statements; these do not need to support NotResource/NotAction but should remain compatible with provider-level statements being appended later.\n\nConsiderations:\n- Impact on existing functionality:\n  - Validation becomes more permissive but remains strictly aligned to IAM rules. Existing Action/Resource statements continue to pass validation unchanged.\n  - Dedup logic change in customResources role creation will slightly alter how duplicates are detected; comparing entire statements is safer and avoids accidental collisions based solely on Resource. This should reduce the chance of missing unique statements or mishandling NotResource statements.\n- Backward compatibility:\n  - Existing configurations are preserved; the new validation simply adds support for NotAction/NotResource.\n  - Error messages become more informative for users who try to specify both Action and NotAction (or both Resource and NotResource).\n- Dependencies/prerequisites:\n  - No new external dependencies.\n  - Ensure any unit tests or integration tests that assert the old validation error messages or dedup behavior are updated to reflect the new rules.\n  - No changes to the CloudFormation IAM role template JSON required; AWS IAM supports NotAction and NotResource in PolicyDocument Statements already.\n\nBy making these changes, provider.iamRoleStatements will correctly accept and process valid IAM statements that include NotAction and NotResource, and the custom resource role assembly will handle deduplication robustly without relying on the presence of Resource.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 4215, 'prompt_tokens': 18623, 'total_tokens': 22838, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2752, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17664}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--ba310e7c-a292-4591-9b6e-f4d4c1dadbc2-0' usage_metadata={'input_tokens': 18623, 'output_tokens': 4215, 'total_tokens': 22838, 'input_token_details': {'audio': 0, 'cache_read': 17664}, 'output_token_details': {'audio': 0, 'reasoning': 2752}}
2025-11-13 21:34:51,199 - thread-135845298308800.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nSupport NotAction and NotResource\n\nIssue description: \n# Feature Proposal\n\n## Description\n\n<!-- Please use https://forum.serverless.com, StackOverflow or other forums for Q&A -->\n<!-- Please answer ALL the question below. Otherwise we probably have to close the issue due to missing information -->\n\nCurrently Serverless refuses to build if there are iamRoleStatements that contain [`NotAction`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notaction.html) or [`NotResource`](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_notresource.html).\n\nThese should be supported, as they are valid IAM role statements.\n\ne.g. to allow a lambda to send text messages, but not publish to any SNS topics\n```yaml\n      - Effect: \'Allow\'\n        Action: \'sns:Publish\'\n        NotResource: \'arn:aws:sns:*:*:*\'\n```\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/guide/iam.md\nLine number range: 19 - 48\nContent:\n19. ## The Default IAM Role\n20. \n21. By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n22. \n23. To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n24. \n25. ```yml\n26. service: new-service\n27. \n28. provider:\n29.   name: aws\n30.   iamRoleStatements:\n31.     - Effect: \'Allow\'\n32.       Action:\n33.         - \'s3:ListBucket\'\n34.       Resource:\n35.         Fn::Join:\n36.           - \'\'\n37.           - - \'arn:aws:s3:::\'\n38.             - Ref: ServerlessDeploymentBucket\n39.     - Effect: \'Allow\'\n40.       Action:\n41.         - \'s3:PutObject\'\n42.       Resource:\n43.         Fn::Join:\n44.           - \'\'\n45.           - - \'arn:aws:s3:::\'\n46.             - Ref: ServerlessDeploymentBucket\n47.             - \'/*\'\n48. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 50 - 61\nContent:\n50. Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\n51. \n52. ```yml\n53. service: new-service\n54. \n55. provider:\n56.   name: aws\n57.   iamManagedPolicies:\n58.     - \'some:aws:arn:xxx:*:*\'\n59.     - \'someOther:aws:arn:xxx:*:*\'\n60.     - { \'Fn::Join\': [\':\', [\'arn:aws:iam:\', { Ref: \'AWSAccountId\' }, \'some/path\']] }\n61. ```\n\n\nFile: docs/providers/aws/guide/iam.md\nLine number range: 63 - 71\nContent:\n63. ## Custom IAM Roles\n64. \n65. **WARNING:** You need to take care of the overall role setup as soon as you define custom roles.\n66. \n67. That means that `iamRoleStatements` you\'ve defined on the `provider` level won\'t be applied anymore. Furthermore, you need to provide the corresponding permissions for your Lambdas `logs` and [`stream`](../events/streams.md) events.\n68. \n69. Serverless empowers you to define custom roles and apply them to your functions on a provider or individual function basis. To do this, you must declare a `role` attribute at the level at which you would like the role to be applied.\n70. \n71. Defining it on the provider will make the role referenced by the `role` value the default role for any Lambda without its own `role` declared. This is to say that defining a `role` attribute on individual functions will override any provider level declared role. If every function within your service has a role assigned to it (either via provider level `role` declaration, individual declarations, or a mix of the two) then the default role and policy will not be generated and added to your Cloud Formation Template.\n\n\nFile: lib/plugins/aws/customResources/index.js\nLine number range: 89 - 160\nContent:\n89.       let customResourceRole = Resources[customResourcesRoleLogicalId];\n90.       if (!customResourceRole) {\n91.         customResourceRole = {\n92.           Type: \'AWS::IAM::Role\',\n93.           Properties: {\n94.             AssumeRolePolicyDocument: {\n95.               Version: \'2012-10-17\',\n96.               Statement: [\n97.                 {\n98.                   Effect: \'Allow\',\n99.                   Principal: {\n100.                     Service: [\'lambda.amazonaws.com\'],\n101.                   },\n102.                   Action: [\'sts:AssumeRole\'],\n103.                 },\n104.               ],\n105.             },\n106.             Policies: [\n107.               {\n108.                 PolicyName: {\n109.                   \'Fn::Join\': [\n110.                     \'-\',\n111.                     [\n112.                       awsProvider.getStage(),\n113.                       awsProvider.serverless.service.service,\n114.                       \'custom-resources-lambda\',\n115.                     ],\n116.                   ],\n117.                 },\n118.                 PolicyDocument: {\n119.                   Version: \'2012-10-17\',\n120.                   Statement: [],\n121.                 },\n122.               },\n123.             ],\n124.           },\n125.         };\n126. \n127.         if (shouldWriteLogs) {\n128.           const logGroupsPrefix = awsProvider.naming.getLogGroupName(funcPrefix);\n129.           customResourceRole.Properties.Policies[0].PolicyDocument.Statement.push(\n130.             {\n131.               Effect: \'Allow\',\n132.               Action: [\'logs:CreateLogStream\'],\n133.               Resource: [\n134.                 {\n135.                   \'Fn::Sub\':\n136.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n137.                     `:log-group:${logGroupsPrefix}*:*`,\n138.                 },\n139.               ],\n140.             },\n141.             {\n142.               Effect: \'Allow\',\n143.               Action: [\'logs:PutLogEvents\'],\n144.               Resource: [\n145.                 {\n146.                   \'Fn::Sub\':\n147.                     \'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}\' +\n148.                     `:log-group:${logGroupsPrefix}*:*:*`,\n149.                 },\n150.               ],\n151.             }\n152.           );\n153.         }\n154.       }\n155.       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n156.       iamRoleStatements.forEach(newStmt => {\n157.         if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n158.           Statement.push(newStmt);\n159.         }\n160.       });\n\n\nFile: lib/plugins/aws/deployFunction/index.js\nLine number range: 71 - 116\nContent:\n71.         throw new this.serverless.classes.Error(errorMessage);\n72.       });\n73.   }\n74. \n75.   normalizeArnRole(role) {\n76.     if (typeof role === \'string\') {\n77.       if (role.indexOf(\':\') === -1) {\n78.         const roleResource = this.serverless.service.resources.Resources[role];\n79. \n80.         if (roleResource.Type !== \'AWS::IAM::Role\') {\n81.           throw new Error(\'Provided resource is not IAM Role.\');\n82.         }\n83. \n84.         const roleProperties = roleResource.Properties;\n85.         const compiledFullRoleName = `${roleProperties.Path || \'/\'}${roleProperties.RoleName}`;\n86. \n87.         return this.provider\n88.           .getAccountInfo()\n89.           .then(\n90.             result => `arn:${result.partition}:iam::${result.accountId}:role${compiledFullRoleName}`\n91.           );\n92.       }\n93. \n94.       return BbPromise.resolve(role);\n95.     }\n96. \n97.     return this.provider\n98.       .request(\'IAM\', \'getRole\', {\n99.         RoleName: role[\'Fn::GetAtt\'][0],\n100.       })\n101.       .then(data => data.Arn);\n102.   }\n103. \n104.   callUpdateFunctionConfiguration(params) {\n105.     return this.provider.request(\'Lambda\', \'updateFunctionConfiguration\', params).then(() => {\n106.       this.serverless.cli.log(`Successfully updated function: ${this.options.function}`);\n107.     });\n108.   }\n109. \n110.   updateFunctionConfiguration() {\n111.     const functionObj = this.options.functionObj;\n112.     const serviceObj = this.serverless.service.serviceObject;\n113.     const providerObj = this.serverless.service.provider;\n114.     const params = {\n115.       FunctionName: functionObj.name,\n116.     };\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 86 - 106\nContent:\n86.   // Role\n87.   getRolePath() {\n88.     return \'/\';\n89.   },\n90.   getRoleName() {\n91.     return {\n92.       \'Fn::Join\': [\n93.         \'-\',\n94.         [\n95.           this.provider.serverless.service.service,\n96.           this.provider.getStage(),\n97.           { Ref: \'AWS::Region\' },\n98.           \'lambdaRole\',\n99.         ],\n100.       ],\n101.     };\n102.   },\n103.   getRoleLogicalId() {\n104.     return \'IamRoleLambdaExecution\';\n105.   },\n106. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 107 - 122\nContent:\n107.   // Policy\n108.   getPolicyName() {\n109.     return {\n110.       // TODO should probably have name ordered and altered as above - see AWS docs\n111.       \'Fn::Join\': [\n112.         \'-\',\n113.         [\n114.           this.provider.getStage(),\n115.           // TODO is it a bug here in that the role is not specific to the region?\n116.           this.provider.serverless.service.service,\n117.           \'lambda\',\n118.         ],\n119.       ],\n120.     };\n121.   },\n122. \n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 447 - 453\nContent:\n447.   // Custom Resources\n448.   getCustomResourcesArtifactDirectoryName() {\n449.     return \'custom-resources\';\n450.   },\n451.   getCustomResourcesRoleLogicalId() {\n452.     return \'IamRoleCustomResourcesLambdaExecution\';\n453.   },\n\n\nFile: lib/plugins/aws/lib/validate.js\nLine number range: 1 - 62\nContent:\n1. \'use strict\';\n2. \n3. const BbPromise = require(\'bluebird\');\n4. const chalk = require(\'chalk\');\n5. const userStats = require(\'../../../utils/userStats\');\n6. \n7. module.exports = {\n8.   validate() {\n9.     if (!this.serverless.config.servicePath) {\n10.       const error = new this.serverless.classes.Error(\n11.         \'This command can only be run inside a service directory\'\n12.       );\n13.       return BbPromise.reject(error);\n14.     }\n15. \n16.     this.options.stage = this.provider.getStage();\n17.     this.options.region = this.provider.getRegion();\n18. \n19.     if (\n20.       ![\'logs\', \'info\', \'deploy\', \'remove\', \'rollback\', \'metrics\', \'invoke\'].includes(\n21.         this.serverless.processedInput.commands[0]\n22.       ) ||\n23.       this.serverless.processedInput.commands[1] === \'local\'\n24.     ) {\n25.       return BbPromise.resolve();\n26.     }\n27.     const creds = Object.assign({}, this.provider.getCredentials());\n28.     delete creds.region;\n29.     delete creds.signatureVersion;\n30. \n31.     if (\n32.       Object.keys(creds).length === 0 &&\n33.       !process.env.ECS_CONTAINER_METADATA_FILE &&\n34.       !process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &&\n35.       !process.env.AWS_CONTAINER_CREDENTIALS_FULL_URI\n36.     ) {\n37.       // first check if the EC2 Metadata Service has creds before throwing error\n38.       const metadataService = new this.provider.sdk.MetadataService({\n39.         httpOptions: { timeout: 100, connectTimeout: 100 }, // .1 second timeout\n40.         maxRetries: 0, // retry 0 times\n41.       });\n42.       return new BbPromise((resolve, reject) =>\n43.         metadataService.request(\'/\', (err, data) => {\n44.           return err ? reject(err) : resolve(data);\n45.         })\n46.       )\n47.         .catch(() => null)\n48.         .then(identity => {\n49.           if (!identity) {\n50.             const message = [\n51.               \'AWS provider credentials not found.\',\n52.               \' Learn how to set up AWS provider credentials\',\n53.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n54.             ].join(\'\');\n55.             userStats.track(\'user_awsCredentialsNotFound\');\n56.             throw new this.serverless.classes.Error(message);\n57.           }\n58.         });\n59.     }\n60.     return BbPromise.resolve();\n61.   },\n62. };\n\n\nFile: lib/plugins/aws/package/compile/events/cloudFront/index.js\nLine number range: 200 - 260\nContent:\n200.                 o.TargetOriginId === behavior.TargetOriginId\n201.             );\n202. \n203.             if (!existingBehaviour) {\n204.               behaviors.push(behavior);\n205.             } else {\n206.               behavior = extendDeep(existingBehaviour, behavior);\n207.             }\n208. \n209.             lambdaAtEdgeFunctions.push(\n210.               Object.assign({}, functionObj, { functionName, lambdaVersionLogicalId })\n211.             );\n212.           }\n213.         });\n214.       }\n215.     });\n216. \n217.     // sort that first is without PathPattern if available\n218.     behaviors.sort((a, b) => {\n219.       if (b.PathPattern) {\n220.         return -1;\n221.       }\n222.       return 0;\n223.     });\n224. \n225.     if (lambdaAtEdgeFunctions.length) {\n226.       if (this.provider.getRegion() !== \'us-east-1\') {\n227.         throw new ServerlessError(\n228.           \'CloudFront associated functions have to be deployed to the us-east-1 region.\'\n229.         );\n230.       }\n231. \n232.       const lambdaInvokePermissions = lambdaAtEdgeFunctions.reduce(\n233.         (permissions, lambdaAtEdgeFunction) => {\n234.           const invokePermissionName = this.provider.naming.getLambdaAtEdgeInvokePermissionLogicalId(\n235.             lambdaAtEdgeFunction.functionName\n236.           );\n237.           const invokePermission = {\n238.             Type: \'AWS::Lambda::Permission\',\n239.             Properties: {\n240.               FunctionName: {\n241.                 Ref: lambdaAtEdgeFunction.lambdaVersionLogicalId,\n242.               },\n243.               Action: \'lambda:InvokeFunction\',\n244.               Principal: \'edgelambda.amazonaws.com\',\n245.               SourceArn: {\n246.                 \'Fn::Join\': [\n247.                   \'\',\n248.                   [\n249.                     \'\',\n250.                     \'arn:aws:cloudfront::\',\n251.                     { Ref: \'AWS::AccountId\' },\n252.                     \':distribution/\',\n253.                     { Ref: this.provider.naming.getCloudFrontDistributionLogicalId() },\n254.                   ],\n255.                 ],\n256.               },\n257.             },\n258.           };\n259.           return Object.assign(permissions, {\n260.             [invokePermissionName]: invokePermission,\n\n\nFile: lib/plugins/aws/package/compile/events/cognitoUserPool/index.js\nLine number range: 20 - 364\nContent:\n20. class AwsCompileCognitoUserPoolEvents {\n21.   constructor(serverless, options) {\n22.     this.serverless = serverless;\n23.     this.options = options;\n24.     this.provider = this.serverless.getProvider(\'aws\');\n25. \n26.     this.hooks = {\n27.       \'package:compileEvents\': () => {\n28.         return BbPromise.bind(this)\n29.           .then(this.newCognitoUserPools)\n30.           .then(this.existingCognitoUserPools);\n31.       },\n32.       \'after:package:finalize\': this.mergeWithCustomResources.bind(this),\n33.     };\n34.   }\n35. \n36.   newCognitoUserPools() {\n37.     const { service } = this.serverless;\n38.     service.getAllFunctions().forEach(functionName => {\n39.       const functionObj = service.getFunction(functionName);\n40.       if (functionObj.events) {\n41.         functionObj.events.forEach(event => {\n42.           if (event.cognitoUserPool) {\n43.             // return immediately if it\'s an existing Cognito User Pool event since we treat them differently\n44.             if (event.cognitoUserPool.existing) return null;\n45. \n46.             const result = this.findUserPoolsAndFunctions();\n47.             const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n48.             const userPools = result.userPools;\n49. \n50.             // Generate CloudFormation templates for Cognito User Pool changes\n51.             _.forEach(userPools, poolName => {\n52.               const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, {\n53.                 poolName,\n54.               });\n55.               const userPoolCFResource = this.generateTemplateForPool(\n56.                 poolName,\n57.                 currentPoolTriggerFunctions\n58.               );\n59. \n60.               _.merge(\n61.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n62.                 userPoolCFResource\n63.               );\n64.             });\n65. \n66.             // Generate CloudFormation templates for IAM permissions to allow Cognito to trigger Lambda\n67.             _.forEach(cognitoUserPoolTriggerFunctions, cognitoUserPoolTriggerFunction => {\n68.               const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(\n69.                 cognitoUserPoolTriggerFunction.poolName\n70.               );\n71.               const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(\n72.                 cognitoUserPoolTriggerFunction.functionName\n73.               );\n74. \n75.               const permissionTemplate = {\n76.                 Type: \'AWS::Lambda::Permission\',\n77.                 Properties: {\n78.                   FunctionName: {\n79.                     \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n80.                   },\n81.                   Action: \'lambda:InvokeFunction\',\n82.                   Principal: \'cognito-idp.amazonaws.com\',\n83.                   SourceArn: {\n84.                     \'Fn::GetAtt\': [userPoolLogicalId, \'Arn\'],\n85.                   },\n86.                 },\n87.               };\n88.               const lambdaPermissionLogicalId = this.provider.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n89.                 cognitoUserPoolTriggerFunction.functionName,\n90.                 cognitoUserPoolTriggerFunction.poolName,\n91.                 cognitoUserPoolTriggerFunction.triggerSource\n92.               );\n93.               const permissionCFResource = {\n94.                 [lambdaPermissionLogicalId]: permissionTemplate,\n95.               };\n96.               _.merge(\n97.                 this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n98.                 permissionCFResource\n99.               );\n100.             });\n101.           }\n102.           return null;\n103.         });\n104.       }\n105.       return null;\n106.     });\n107.   }\n108. \n109.   existingCognitoUserPools() {\n110.     const { service } = this.serverless;\n111.     const { provider } = service;\n112.     const { compiledCloudFormationTemplate } = provider;\n113.     const { Resources } = compiledCloudFormationTemplate;\n114.     const iamRoleStatements = [];\n115. \n116.     // used to keep track of the custom resources created for each Cognito User Pool\n117.     const poolResources = {};\n118. \n119.     service.getAllFunctions().forEach(functionName => {\n120.       let numEventsForFunc = 0;\n121.       let currentPoolName = null;\n122.       let funcUsesExistingCognitoUserPool = false;\n123.       const functionObj = service.getFunction(functionName);\n124.       const FunctionName = functionObj.name;\n125. \n126.       if (functionObj.events) {\n127.         functionObj.events.forEach(event => {\n128.           if (event.cognitoUserPool && event.cognitoUserPool.existing) {\n129.             numEventsForFunc++;\n130.             const { pool, trigger } = event.cognitoUserPool;\n131.             funcUsesExistingCognitoUserPool = true;\n132. \n133.             if (!currentPoolName) {\n134.               currentPoolName = pool;\n135.             }\n136.             if (pool !== currentPoolName) {\n137.               const errorMessage = [\n138.                 \'Only one Cognito User Pool can be configured per function.\',\n139.                 ` In "${FunctionName}" you\'re attempting to configure "${currentPoolName}" and "${pool}" at the same time.`,\n140.               ].join(\'\');\n141.               throw new this.serverless.classes.Error(errorMessage);\n142.             }\n143. \n144.             const eventFunctionLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n145.             const customResourceFunctionLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId();\n146.             const customPoolResourceLogicalId = this.provider.naming.getCustomResourceCognitoUserPoolResourceLogicalId(\n147.               functionName\n148.             );\n149. \n150.             // store how often the custom Cognito User Pool resource is used\n151.             if (poolResources[pool]) {\n152.               poolResources[pool] = _.union(poolResources[pool], [customPoolResourceLogicalId]);\n153.             } else {\n154.               Object.assign(poolResources, {\n155.                 [pool]: [customPoolResourceLogicalId],\n156.               });\n157.             }\n158. \n159.             let customCognitoUserPoolResource;\n160.             if (numEventsForFunc === 1) {\n161.               customCognitoUserPoolResource = {\n162.                 [customPoolResourceLogicalId]: {\n163.                   Type: \'Custom::CognitoUserPool\',\n164.                   Version: 1.0,\n165.                   DependsOn: [eventFunctionLogicalId, customResourceFunctionLogicalId],\n166.                   Properties: {\n167.                     ServiceToken: {\n168.                       \'Fn::GetAtt\': [customResourceFunctionLogicalId, \'Arn\'],\n169.                     },\n170.                     FunctionName,\n171.                     UserPoolName: pool,\n172.                     UserPoolConfigs: [\n173.                       {\n174.                         Trigger: trigger,\n175.                       },\n176.                     ],\n177.                   },\n178.                 },\n179.               };\n180. \n181.               iamRoleStatements.push({\n182.                 Effect: \'Allow\',\n183.                 Resource: \'*\',\n184.                 Action: [\n185.                   \'cognito-idp:ListUserPools\',\n186.                   \'cognito-idp:DescribeUserPool\',\n187.                   \'cognito-idp:UpdateUserPool\',\n188.                 ],\n189.               });\n190.             } else {\n191.               Resources[customPoolResourceLogicalId].Properties.UserPoolConfigs.push({\n192.                 Trigger: trigger,\n193.               });\n194.             }\n195. \n196.             _.merge(Resources, customCognitoUserPoolResource);\n197.           }\n198.         });\n199.       }\n200. \n201.       if (funcUsesExistingCognitoUserPool) {\n202.         iamRoleStatements.push({\n203.           Effect: \'Allow\',\n204.           Resource: `arn:aws:lambda:*:*:function:${FunctionName}`,\n205.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n206.         });\n207.       }\n208.     });\n209. \n210.     // check if we need to add DependsOn clauses in case more than 1\n211.     // custom resources are created for one Cognito User Pool (to avoid race conditions)\n212.     if (Object.keys(poolResources).length > 0) {\n213.       Object.keys(poolResources).forEach(pool => {\n214.         const resources = poolResources[pool];\n215.         if (resources.length > 1) {\n216.           resources.forEach((currResourceLogicalId, idx) => {\n217.             if (idx > 0) {\n218.               const prevResourceLogicalId = resources[idx - 1];\n219.               Resources[currResourceLogicalId].DependsOn.push(prevResourceLogicalId);\n220.             }\n221.           });\n222.         }\n223.       });\n224.     }\n225. \n226.     if (iamRoleStatements.length) {\n227.       return addCustomResourceToService(this.provider, \'cognitoUserPool\', iamRoleStatements);\n228.     }\n229. \n230.     return null;\n231.   }\n232. \n233.   findUserPoolsAndFunctions() {\n234.     const userPools = [];\n235.     const cognitoUserPoolTriggerFunctions = [];\n236. \n237.     // Iterate through all functions declared in `serverless.yml`\n238.     _.forEach(this.serverless.service.getAllFunctions(), functionName => {\n239.       const functionObj = this.serverless.service.getFunction(functionName);\n240. \n241.       if (functionObj.events) {\n242.         _.forEach(functionObj.events, event => {\n243.           if (event.cognitoUserPool) {\n244.             // Check event definition for `cognitoUserPool` object\n245.             if (typeof event.cognitoUserPool === \'object\') {\n246.               // Check `cognitoUserPool` object has required properties\n247.               if (!event.cognitoUserPool.pool || !event.cognitoUserPool.trigger) {\n248.                 throw new this.serverless.classes.Error(\n249.                   [\n250.                     `Cognito User Pool event of function "${functionName}" is not an object.`,\n251.                     \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n252.                     \'Please check the docs for more info.\',\n253.                   ].join(\' \')\n254.                 );\n255.               }\n256. \n257.               // Check `cognitoUserPool` trigger is valid\n258.               if (!_.includes(validTriggerSources, event.cognitoUserPool.trigger)) {\n259.                 throw new this.serverless.classes.Error(\n260.                   [\n261.                     \'Cognito User Pool trigger source is invalid, must be one of:\',\n262.                     `${validTriggerSources.join(\', \')}.`,\n263.                     \'Please check the docs for more info.\',\n264.                   ].join(\' \')\n265.                 );\n266.               }\n267. \n268.               // Save trigger functions so we can use them to generate\n269.               // IAM permissions later\n270.               cognitoUserPoolTriggerFunctions.push({\n271.                 functionName,\n272.                 poolName: event.cognitoUserPool.pool,\n273.                 triggerSource: event.cognitoUserPool.trigger,\n274.               });\n275. \n276.               // Save user pools so we can use them to generate\n277.               // CloudFormation resources later\n278.               userPools.push(event.cognitoUserPool.pool);\n279.             } else {\n280.               throw new this.serverless.classes.Error(\n281.                 [\n282.                   `Cognito User Pool event of function "${functionName}" is not an object.`,\n283.                   \'The correct syntax is an object with the "pool" and "trigger" properties.\',\n284.                   \'Please check the docs for more info.\',\n285.                 ].join(\' \')\n286.               );\n287.             }\n288.           }\n289.         });\n290.       }\n291.     });\n292. \n293.     return { cognitoUserPoolTriggerFunctions, userPools };\n294.   }\n295. \n296.   generateTemplateForPool(poolName, currentPoolTriggerFunctions) {\n297.     const lambdaConfig = _.reduce(\n298.       currentPoolTriggerFunctions,\n299.       (result, value) => {\n300.         const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(value.functionName);\n301. \n302.         // Return a new object to avoid lint errors\n303.         return Object.assign({}, result, {\n304.           [value.triggerSource]: {\n305.             \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n306.           },\n307.         });\n308.       },\n309.       {}\n310.     );\n311. \n312.     const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n313. \n314.     // Attach `DependsOn` for any relevant Lambdas\n315.     const DependsOn = _.map(currentPoolTriggerFunctions, value =>\n316.       this.provider.naming.getLambdaLogicalId(value.functionName)\n317.     );\n318. \n319.     return {\n320.       [userPoolLogicalId]: {\n321.         Type: \'AWS::Cognito::UserPool\',\n322.         Properties: {\n323.           UserPoolName: poolName,\n324.           LambdaConfig: lambdaConfig,\n325.         },\n326.         DependsOn,\n327.       },\n328.     };\n329.   }\n330. \n331.   mergeWithCustomResources() {\n332.     const result = this.findUserPoolsAndFunctions();\n333.     const cognitoUserPoolTriggerFunctions = result.cognitoUserPoolTriggerFunctions;\n334.     const userPools = result.userPools;\n335. \n336.     _.forEach(userPools, poolName => {\n337.       const currentPoolTriggerFunctions = _.filter(cognitoUserPoolTriggerFunctions, { poolName });\n338.       const userPoolLogicalId = this.provider.naming.getCognitoUserPoolLogicalId(poolName);\n339. \n340.       // If overrides exist in `Resources`, merge them in\n341.       if (_.has(this.serverless.service.resources, userPoolLogicalId)) {\n342.         const customUserPool = this.serverless.service.resources[userPoolLogicalId];\n343.         const generatedUserPool = this.generateTemplateForPool(\n344.           poolName,\n345.           currentPoolTriggerFunctions\n346.         )[userPoolLogicalId];\n347. \n348.         // Merge `DependsOn` clauses\n349.         const customUserPoolDependsOn = _.get(customUserPool, \'DependsOn\', []);\n350.         const DependsOn = generatedUserPool.DependsOn.concat(customUserPoolDependsOn);\n351. \n352.         // Merge default and custom resources, and `DependsOn` clause\n353.         const mergedTemplate = Object.assign({}, _.merge(generatedUserPool, customUserPool), {\n354.           DependsOn,\n355.         });\n356. \n357.         // Merge resource back into `Resources`\n358.         _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n359.           [userPoolLogicalId]: mergedTemplate,\n360.         });\n361.       }\n362.     });\n363.   }\n364. }\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 21 - 23\nContent:\n21.     const iamRoleStatements = [];\n22. \n23.     service.getAllFunctions().forEach(functionName => {\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 146 - 162\nContent:\n146.                 iamRoleStatements.push({\n147.                   Effect: \'Allow\',\n148.                   Resource: eventBusResource,\n149.                   Action: [\'events:CreateEventBus\', \'events:DeleteEventBus\'],\n150.                 });\n151.               }\n152. \n153.               iamRoleStatements.push({\n154.                 Effect: \'Allow\',\n155.                 Resource: ruleResource,\n156.                 Action: [\n157.                   \'events:PutRule\',\n158.                   \'events:RemoveTargets\',\n159.                   \'events:PutTargets\',\n160.                   \'events:DeleteRule\',\n161.                 ],\n162.               });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 174 - 190\nContent:\n174.       if (funcUsesEventBridge) {\n175.         iamRoleStatements.push({\n176.           Effect: \'Allow\',\n177.           Resource: {\n178.             \'Fn::Join\': [\n179.               \':\',\n180.               [\n181.                 \'arn:aws:lambda\',\n182.                 { Ref: \'AWS::Region\' },\n183.                 { Ref: \'AWS::AccountId\' },\n184.                 \'function\',\n185.                 FunctionName,\n186.               ],\n187.             ],\n188.           },\n189.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n190.         });\n\n\nFile: lib/plugins/aws/package/compile/events/eventBridge/index.js\nLine number range: 194 - 196\nContent:\n194.     if (iamRoleStatements.length) {\n195.       return addCustomResourceToService(this.provider, \'eventBridge\', iamRoleStatements);\n196.     }\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 199 - 206\nContent:\n199.   existingS3Buckets() {\n200.     const { service } = this.serverless;\n201.     const { provider } = service;\n202.     const { compiledCloudFormationTemplate } = provider;\n203.     const { Resources } = compiledCloudFormationTemplate;\n204.     const iamRoleStatements = [];\n205. \n206.     // used to keep track of the custom resources created for each bucket\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 284 - 291\nContent:\n284.               iamRoleStatements.push({\n285.                 Effect: \'Allow\',\n286.                 Resource: {\n287.                   \'Fn::Join\': [\':\', [\'arn\', { Ref: \'AWS::Partition\' }, \'s3\', \'\', \'\', bucket]],\n288.                 },\n289.                 Action: [\'s3:PutBucketNotification\', \'s3:GetBucketNotification\'],\n290.               });\n291.             } else {\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 303 - 321\nContent:\n303.       if (funcUsesExistingS3Bucket) {\n304.         iamRoleStatements.push({\n305.           Effect: \'Allow\',\n306.           Resource: {\n307.             \'Fn::Join\': [\n308.               \':\',\n309.               [\n310.                 \'arn\',\n311.                 { Ref: \'AWS::Partition\' },\n312.                 \'lambda\',\n313.                 { Ref: \'AWS::Region\' },\n314.                 { Ref: \'AWS::AccountId\' },\n315.                 \'function\',\n316.                 FunctionName,\n317.               ],\n318.             ],\n319.           },\n320.           Action: [\'lambda:AddPermission\', \'lambda:RemovePermission\'],\n321.         });\n\n\nFile: lib/plugins/aws/package/compile/events/s3/index.js\nLine number range: 341 - 343\nContent:\n341.     if (iamRoleStatements.length) {\n342.       return addCustomResourceToService(this.provider, \'s3\', iamRoleStatements);\n343.     }\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.js\nLine number range: 131 - 170\nContent:\n131.                   "FunctionName": {\n132.                     "Fn::GetAtt": [\n133.                       "${lambdaLogicalId}",\n134.                       "Arn"\n135.                     ]\n136.                   },\n137.                   "Enabled": "${Enabled}"\n138.                 }\n139.               }\n140.             `;\n141. \n142.             // add event source ARNs to PolicyDocument statements\n143.             sqsStatement.Resource.push(EventSourceArn);\n144. \n145.             const newSQSObject = {\n146.               [queueLogicalId]: JSON.parse(sqsTemplate),\n147.             };\n148. \n149.             _.merge(\n150.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n151.               newSQSObject\n152.             );\n153.           }\n154.         });\n155. \n156.         // update the PolicyDocument statements (if default policy is used)\n157.         if (\n158.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n159.             .IamRoleLambdaExecution\n160.         ) {\n161.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n162.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n163.           if (sqsStatement.Resource.length) {\n164.             statement.push(sqsStatement);\n165.           }\n166.         }\n167.       }\n168.     });\n169.   }\n170. }\n\n\nFile: lib/plugins/aws/package/compile/events/stream/index.js\nLine number range: 200 - 228\nContent:\n200.             const newStreamObject = {\n201.               [streamLogicalId]: streamResource,\n202.             };\n203. \n204.             _.merge(\n205.               this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n206.               newStreamObject\n207.             );\n208.           }\n209.         });\n210. \n211.         // update the PolicyDocument statements (if default policy is used)\n212.         if (\n213.           this.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.             .IamRoleLambdaExecution\n215.         ) {\n216.           const statement = this.serverless.service.provider.compiledCloudFormationTemplate\n217.             .Resources.IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement;\n218.           if (dynamodbStreamStatement.Resource.length) {\n219.             statement.push(dynamodbStreamStatement);\n220.           }\n221.           if (kinesisStreamStatement.Resource.length) {\n222.             statement.push(kinesisStreamStatement);\n223.           }\n224.         }\n225.       }\n226.     });\n227.   }\n228. }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 35 - 75\nContent:\n35.   compileRole(newFunction, role) {\n36.     const compiledFunction = newFunction;\n37.     const unnsupportedRoleError = new this.serverless.classes.Error(\n38.       `Unsupported role provided: "${JSON.stringify(role)}"`\n39.     );\n40. \n41.     switch (typeof role) {\n42.       case \'object\':\n43.         if (\'Fn::GetAtt\' in role) {\n44.           // role is an "Fn::GetAtt" object\n45.           compiledFunction.Properties.Role = role;\n46.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n47.             role[\'Fn::GetAtt\'][0]\n48.           );\n49.         } else if (\'Fn::ImportValue\' in role) {\n50.           // role is an "Fn::ImportValue" object\n51.           compiledFunction.Properties.Role = role;\n52.         } else {\n53.           throw unnsupportedRoleError;\n54.         }\n55.         break;\n56.       case \'string\':\n57.         if (role.startsWith(\'arn:aws\')) {\n58.           // role is a statically definied iam arn\n59.           compiledFunction.Properties.Role = role;\n60.         } else if (role === \'IamRoleLambdaExecution\') {\n61.           // role is the default role generated by the framework\n62.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n63.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(\n64.             \'IamRoleLambdaExecution\'\n65.           );\n66.         } else {\n67.           // role is a Logical Role Name\n68.           compiledFunction.Properties.Role = { \'Fn::GetAtt\': [role, \'Arn\'] };\n69.           compiledFunction.DependsOn = (compiledFunction.DependsOn || []).concat(role);\n70.         }\n71.         break;\n72.       default:\n73.         throw unnsupportedRoleError;\n74.     }\n75.   }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 216 - 240\nContent:\n216. \n217.           newFunction.Properties.DeadLetterConfig = {\n218.             TargetArn: arn,\n219.           };\n220. \n221.           if (dlqType === \'sns\') {\n222.             stmt = {\n223.               Effect: \'Allow\',\n224.               Action: [\'sns:Publish\'],\n225.               Resource: [arn],\n226.             };\n227.           } else if (dlqType === \'sqs\') {\n228.             const errorMessage = [\n229.               \'onError currently only supports SNS topic arns due to a\',\n230.               \' race condition when using SQS queue arns and updating the IAM role.\',\n231.               \' Please check the docs for more info.\',\n232.             ].join(\'\');\n233.             return BbPromise.reject(new this.serverless.classes.Error(errorMessage));\n234.           }\n235. \n236.           // update the PolicyDocument statements (if default policy is used)\n237.           if (iamRoleLambdaExecution) {\n238.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.push(stmt);\n239.           }\n240.         } else {\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 271 - 289\nContent:\n271.           const iamRoleLambdaExecution = this.serverless.service.provider\n272.             .compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution;\n273. \n274.           newFunction.Properties.KmsKeyArn = arn;\n275. \n276.           const stmt = {\n277.             Effect: \'Allow\',\n278.             Action: [\'kms:Decrypt\'],\n279.             Resource: [arn],\n280.           };\n281. \n282.           // update the PolicyDocument statements (if default policy is used)\n283.           if (iamRoleLambdaExecution) {\n284.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n285.               iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n286.               [stmt],\n287.               _.isEqual\n288.             );\n289.           }\n\n\nFile: lib/plugins/aws/package/compile/functions/index.js\nLine number range: 319 - 333\nContent:\n319.         const stmt = {\n320.           Effect: \'Allow\',\n321.           Action: [\'xray:PutTraceSegments\', \'xray:PutTelemetryRecords\'],\n322.           Resource: [\'*\'],\n323.         };\n324. \n325.         // update the PolicyDocument statements (if default policy is used)\n326.         if (iamRoleLambdaExecution) {\n327.           iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement = _.unionWith(\n328.             iamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement,\n329.             [stmt],\n330.             _.isEqual\n331.           );\n332.         }\n333.       } else {\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 10 - 10\nContent:\n10. const mergeIamTemplates = require(\'./lib/mergeIamTemplates\');\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 23 - 31\nContent:\n23.     Object.assign(\n24.       this,\n25.       generateCoreTemplate,\n26.       mergeIamTemplates,\n27.       generateArtifactDirectoryName,\n28.       mergeCustomProviderResources,\n29.       saveServiceState,\n30.       saveCompiledTemplate\n31.     );\n\n\nFile: lib/plugins/aws/package/index.js\nLine number range: 60 - 61\nContent:\n60.       \'package:setupProviderConfiguration\': () => BbPromise.bind(this).then(this.mergeIamTemplates),\n61. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 8 - 12\nContent:\n8.   mergeIamTemplates() {\n9.     this.validateStatements(this.serverless.service.provider.iamRoleStatements);\n10.     this.validateManagedPolicies(this.serverless.service.provider.iamManagedPolicies);\n11.     return this.merge();\n12.   },\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 44 - 58\nContent:\n44.     // resolve early if provider level role is provided\n45.     if (\'role\' in this.serverless.service.provider) {\n46.       return BbPromise.resolve();\n47.     }\n48. \n49.     // resolve early if all functions contain a custom role\n50.     const customRolesProvided = [];\n51.     this.serverless.service.getAllFunctions().forEach(functionName => {\n52.       const functionObject = this.serverless.service.getFunction(functionName);\n53.       customRolesProvided.push(\'role\' in functionObject);\n54.     });\n55.     if (_.isEqual(_.uniq(customRolesProvided), [true])) {\n56.       return BbPromise.resolve();\n57.     }\n58. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 59 - 76\nContent:\n59.     // merge in the iamRoleLambdaTemplate\n60.     const iamRoleLambdaExecutionTemplate = this.serverless.utils.readFileSync(\n61.       path.join(\n62.         this.serverless.config.serverlessPath,\n63.         \'plugins\',\n64.         \'aws\',\n65.         \'package\',\n66.         \'lib\',\n67.         \'iam-role-lambda-execution-template.json\'\n68.       )\n69.     );\n70.     iamRoleLambdaExecutionTemplate.Properties.Path = this.provider.naming.getRolePath();\n71.     iamRoleLambdaExecutionTemplate.Properties.RoleName = this.provider.naming.getRoleName();\n72.     iamRoleLambdaExecutionTemplate.Properties.Policies[0].PolicyName = this.provider.naming.getPolicyName();\n73. \n74.     _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {\n75.       [this.provider.naming.getRoleLogicalId()]: iamRoleLambdaExecutionTemplate,\n76.     });\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 83 - 86\nContent:\n83.     const policyDocumentStatements = this.serverless.service.provider.compiledCloudFormationTemplate\n84.       .Resources[this.provider.naming.getRoleLogicalId()].Properties.Policies[0].PolicyDocument\n85.       .Statement;\n86. \n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 129 - 136\nContent:\n129.     if (this.serverless.service.provider.iamRoleStatements) {\n130.       // add custom iam role statements\n131.       this.serverless.service.provider.compiledCloudFormationTemplate.Resources[\n132.         this.provider.naming.getRoleLogicalId()\n133.       ].Properties.Policies[0].PolicyDocument.Statement = policyDocumentStatements.concat(\n134.         this.serverless.service.provider.iamRoleStatements\n135.       );\n136.     }\n\n\nFile: lib/plugins/aws/package/lib/mergeIamTemplates.js\nLine number range: 184 - 216\nContent:\n184.   validateStatements(statements) {\n185.     // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n186.     // Action: ..., Resource: ... } objects.\n187.     if (!statements) {\n188.       return;\n189.     }\n190.     let violationsFound;\n191.     if (!(statements instanceof Array)) {\n192.       violationsFound = \'it is not an array\';\n193.     } else {\n194.       const descriptions = statements.map((statement, i) => {\n195.         const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\n196.           prop => statement[prop] === undefined\n197.         );\n198.         return missing.length === 0\n199.           ? null\n200.           : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\n201.       });\n202.       const flawed = descriptions.filter(curr => curr);\n203.       if (flawed.length) {\n204.         violationsFound = flawed.join(\'; \');\n205.       }\n206.     }\n207. \n208.     if (violationsFound) {\n209.       const errorMessage = [\n210.         \'iamRoleStatements should be an array of objects,\',\n211.         \' where each object has Effect, Action, Resource fields.\',\n212.         ` Specifically, ${violationsFound}`,\n213.       ].join(\'\');\n214.       throw new this.serverless.classes.Error(errorMessage);\n215.     }\n216.   },\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const AWS = require(\'aws-sdk\');\n4. const BbPromise = require(\'bluebird\');\n5. const HttpsProxyAgent = require(\'https-proxy-agent\');\n6. const url = require(\'url\');\n7. const chalk = require(\'chalk\');\n8. const _ = require(\'lodash\');\n9. const userStats = require(\'../../../utils/userStats\');\n10. const naming = require(\'../lib/naming.js\');\n11. const https = require(\'https\');\n12. const fs = require(\'fs\');\n13. const objectHash = require(\'object-hash\');\n14. const PromiseQueue = require(\'promise-queue\');\n15. const getS3EndpointForRegion = require(\'../utils/getS3EndpointForRegion\');\n16. const readline = require(\'readline\');\n17. \n18. const constants = {\n19.   providerName: \'aws\',\n20. };\n21. \n22. PromiseQueue.configure(BbPromise.Promise);\n23. \n24. const impl = {\n25.   /**\n26.    * Determine whether the given credentials are valid.  It turned out that detecting invalid\n27.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for\n28.    * whak-a-mole!\n29.    * @param credentials The credentials to test for validity\n30.    * @return {boolean} Whether the given credentials were valid\n31.    */\n32.   validCredentials: credentials => {\n33.     let result = false;\n34.     if (credentials) {\n35.       if (\n36.         // valid credentials loaded\n37.         (credentials.accessKeyId &&\n38.           credentials.accessKeyId !== \'undefined\' &&\n39.           credentials.secretAccessKey &&\n40.           credentials.secretAccessKey !== \'undefined\') ||\n41.         // a role to assume has been successfully loaded, the associated STS request has been\n42.         // sent, and the temporary credentials will be asynchronously delivered.\n43.         credentials.roleArn\n44.       ) {\n45.         result = true;\n46.       }\n47.     }\n48.     return result;\n49.   },\n50.   /**\n51.    * Add credentials, if present, to the given results\n52.    * @param results The results to add the given credentials to if they are valid\n53.    * @param credentials The credentials to validate and add to the results if valid\n54.    */\n55.   addCredentials: (results, credentials) => {\n56.     if (impl.validCredentials(credentials)) {\n57.       results.credentials = credentials; // eslint-disable-line no-param-reassign\n58.     }\n59.   },\n60.   /**\n61.    * Add credentials, if present, from the environment\n62.    * @param results The results to add environment credentials to\n63.    * @param prefix The environment variable prefix to use in extracting credentials\n64.    */\n65.   addEnvironmentCredentials: (results, prefix) => {\n66.     if (prefix) {\n67.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);\n68.       impl.addCredentials(results, environmentCredentials);\n69.     }\n70.   },\n71.   /**\n72.    * Add credentials from a profile, if the profile and credentials for it exists\n73.    * @param results The results to add profile credentials to\n74.    * @param profile The profile to load credentials from\n75.    */\n76.   addProfileCredentials: (results, profile) => {\n77.     if (profile) {\n78.       const params = { profile };\n79.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {\n80.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;\n81.       }\n82. \n83.       // Setup a MFA callback for asking the code from the user.\n84.       params.tokenCodeFn = (mfaSerial, callback) => {\n85.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n86.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {\n87.           rl.close();\n88.           callback(null, answer);\n89.         });\n90.       };\n91. \n92.       const profileCredentials = new AWS.SharedIniFileCredentials(params);\n93.       if (\n94.         !(\n95.           profileCredentials.accessKeyId ||\n96.           profileCredentials.sessionToken ||\n97.           profileCredentials.roleArn\n98.         )\n99.       ) {\n100.         throw new Error(`Profile ${profile} does not exist`);\n101.       }\n102. \n103.       impl.addCredentials(results, profileCredentials);\n104.     }\n105.   },\n106.   /**\n107.    * Add credentials, if present, from a profile that is specified within the environment\n108.    * @param results The prefix of the profile\'s declaration in the environment\n109.    * @param prefix The prefix for the environment variable\n110.    */\n111.   addEnvironmentProfile: (results, prefix) => {\n112.     if (prefix) {\n113.       const profile = process.env[`${prefix}_PROFILE`];\n114.       impl.addProfileCredentials(results, profile);\n115.     }\n116.   },\n117. };\n118. \n119. class AwsProvider {\n120.   static getProviderName() {\n121.     return constants.providerName;\n122.   }\n123. \n124.   constructor(serverless, options) {\n125.     this.naming = { provider: this };\n126.     this.options = options;\n127.     this.provider = this; // only load plugin in an AWS service context\n128.     this.serverless = serverless;\n129.     this.sdk = AWS;\n130.     this.serverless.setProvider(constants.providerName, this);\n131.     if (this.serverless.service.provider.name === \'aws\') {\n132.       this.serverless.service.provider.region = this.getRegion();\n133.     }\n134.     this.requestCache = {};\n135.     this.requestQueue = new PromiseQueue(2, Infinity);\n136.     // Store credentials in this variable to avoid creating them several times (messes up MFA).\n137.     this.cachedCredentials = null;\n138. \n139.     Object.assign(this.naming, naming);\n140. \n141.     // Activate AWS SDK loggin\n142.     if (process.env.SLS_DEBUG) {\n143.       AWS.config.logger = this.serverless.cli;\n144.     }\n145. \n146.     // Use HTTPS Proxy (Optional)\n147.     const proxy =\n148.       process.env.proxy ||\n149.       process.env.HTTP_PROXY ||\n150.       process.env.http_proxy ||\n151.       process.env.HTTPS_PROXY ||\n152.       process.env.https_proxy;\n153. \n154.     const proxyOptions = {};\n155.     if (proxy) {\n156.       Object.assign(proxyOptions, url.parse(proxy));\n157.     }\n158. \n159.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;\n160. \n161.     let caCerts = [];\n162. \n163.     if (ca) {\n164.       // Can be a single certificate or multiple, comma separated.\n165.       const caArr = ca.split(\',\');\n166.       // Replace the newline -- https://stackoverflow.com/questions/30400341\n167.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\\\n/g, \'\\n\')));\n168.     }\n169. \n170.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;\n171. \n172.     if (cafile) {\n173.       // Can be a single certificate file path or multiple paths, comma separated.\n174.       const caPathArr = cafile.split(\',\');\n175.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));\n176.     }\n177. \n178.     if (caCerts.length > 0) {\n179.       Object.assign(proxyOptions, {\n180.         rejectUnauthorized: true,\n181.         ca: caCerts,\n182.       });\n183.     }\n184. \n185.     // Passes also certifications\n186.     if (proxy) {\n187.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);\n188.     } else if (proxyOptions.ca) {\n189.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html\n190.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);\n191.     }\n192. \n193.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)\n194.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;\n195.     if (timeout) {\n196.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);\n197.     }\n198. \n199.     // Support deploymentBucket configuration as an object\n200.     const provider = this.serverless.service.provider;\n201.     if (provider && provider.deploymentBucket) {\n202.       if (_.isObject(provider.deploymentBucket)) {\n203.         // store the object in a new variable so that it can be reused later on\n204.         provider.deploymentBucketObject = provider.deploymentBucket;\n205.         if (provider.deploymentBucket.name) {\n206.           // (re)set the value of the deploymentBucket property to the name (which is a string)\n207.           provider.deploymentBucket = provider.deploymentBucket.name;\n208.         } else {\n209.           provider.deploymentBucket = null;\n210.         }\n211.       }\n212.     }\n213.   }\n214. \n215.   /**\n216.    * Execute an AWS request by calling the AWS SDK\n217.    * @param {string} service - Service name\n218.    * @param {string} method - Method name\n219.    * @param {Object} params - Parameters\n220.    * @param {Object} [options] - Options to modify the request behavior\n221.    * @prop [options.useCache] - Utilize cache to retrieve results\n222.    * @prop [options.region] - Specify when to request to different region\n223.    */\n224.   request(service, method, params, options) {\n225.     const that = this;\n226.     const credentials = Object.assign({}, that.getCredentials());\n227.     // Make sure options is an object (honors wrong calls of request)\n228.     const requestOptions = _.isObject(options) ? options : {};\n229.     const shouldCache = _.get(requestOptions, \'useCache\', false);\n230.     const paramsWithRegion = _.merge({}, params, {\n231.       region: _.get(options, \'region\'),\n232.     });\n233.     const paramsHash = objectHash.sha1(paramsWithRegion);\n234.     const MAX_TRIES = 4;\n235.     const persistentRequest = f =>\n236.       new BbPromise((resolve, reject) => {\n237.         const doCall = numTry => {\n238.           f()\n239.             // We\'re resembling if/else logic, therefore single `then` instead of `then`/`catch` pair\n240.             .then(resolve, e => {\n241.               if (\n242.                 numTry < MAX_TRIES &&\n243.                 e.statusCode !== 403 && // Invalid credentials\n244.                 ((e.providerError && e.providerError.retryable) || e.statusCode === 429)\n245.               ) {\n246.                 that.serverless.cli.log(\n247.                   _.join(\n248.                     [\n249.                       `Recoverable error occurred (${e.message}), sleeping for 5 seconds.`,\n250.                       `Try ${numTry + 1} of ${MAX_TRIES}`,\n251.                     ],\n252.                     \' \'\n253.                   )\n254.                 );\n255.                 setTimeout(doCall, 5000, numTry + 1);\n256.               } else {\n257.                 reject(e);\n258.               }\n259.             });\n260.         };\n261.         return doCall(0);\n262.       });\n263. \n264.     // Emit a warning for misuses of the old signature including stage and region\n265.     // TODO: Determine calling module and log that\n266.     if (process.env.SLS_DEBUG && !_.isNil(options) && !_.isObject(options)) {\n267.       this.serverless.cli.log(\'WARNING: Inappropriate call of provider.request()\');\n268.     }\n269. \n270.     // Support S3 Transfer Acceleration\n271.     if (this.canUseS3TransferAcceleration(service, method)) {\n272.       this.enableS3TransferAcceleration(credentials);\n273.     }\n274. \n275.     if (shouldCache) {\n276.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);\n277.       if (cachedRequest) {\n278.         return BbPromise.resolve(cachedRequest);\n279.       }\n280.     }\n281. \n282.     const request = this.requestQueue.add(() =>\n283.       persistentRequest(() => {\n284.         if (options && !_.isUndefined(options.region)) {\n285.           credentials.region = options.region;\n286.         }\n287.         const awsService = new that.sdk[service](credentials);\n288.         const req = awsService[method](params);\n289. \n290.         // TODO: Add listeners, put Debug statments here...\n291.         // req.on(\'send\', function (r) {console.log(r)});\n292. \n293.         const promise = req.promise\n294.           ? req.promise()\n295.           : BbPromise.fromCallback(cb => {\n296.               req.send(cb);\n297.             });\n298.         return promise.catch(err => {\n299.           let message = err.message !== null ? err.message : err.code;\n300.           if (err.message === \'Missing credentials in config\') {\n301.             const errorMessage = [\n302.               \'AWS provider credentials not found.\',\n303.               \' Learn how to set up AWS provider credentials\',\n304.               ` in our docs here: <${chalk.green(\'http://slss.io/aws-creds-setup\')}>.`,\n305.             ].join(\'\');\n306.             message = errorMessage;\n307.             userStats.track(\'user_awsCredentialsNotFound\');\n308.             // We do not want to trigger the retry mechanism for credential errors\n309.             return BbPromise.reject(\n310.               Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n311.                 providerError: _.assign({}, err, { retryable: false }),\n312.               })\n313.             );\n314.           }\n315. \n316.           return BbPromise.reject(\n317.             Object.assign(new this.serverless.classes.Error(message, err.statusCode), {\n318.               providerError: err,\n319.             })\n320.           );\n321.         });\n322.       }).then(data => {\n323.         const result = BbPromise.resolve(data);\n324.         if (shouldCache) {\n325.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);\n326.         }\n327.         return result;\n328.       })\n329.     );\n330. \n331.     if (shouldCache) {\n332.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);\n333.     }\n334. \n335.     return request;\n336.   }\n337. \n338.   /**\n339.    * Fetch credentials directly or using a profile from serverless yml configuration or from the\n340.    * well known environment variables\n341.    * @returns {{region: *}}\n342.    */\n343.   getCredentials() {\n344.     if (this.cachedCredentials) {\n345.       // We have already created the credentials object once, so return it.\n346.       return this.cachedCredentials;\n347.     }\n348.     const result = {};\n349.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;\n350. \n351.     // add specified credentials, overriding with more specific declarations\n352.     try {\n353.       impl.addProfileCredentials(result, \'default\');\n354.     } catch (err) {\n355.       if (err.message !== \'Profile default does not exist\') {\n356.         throw err;\n357.       }\n358.     }\n359.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds\n360.     if (this.serverless.service.provider.profile && !this.options[\'aws-profile\']) {\n361.       // config profile\n362.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);\n363.     }\n364.     impl.addEnvironmentCredentials(result, \'AWS\'); // creds for all stages\n365.     impl.addEnvironmentProfile(result, \'AWS\');\n366.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds\n367.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);\n368.     if (this.options[\'aws-profile\']) {\n369.       impl.addProfileCredentials(result, this.options[\'aws-profile\']); // CLI option profile\n370.     }\n371.     result.region = this.getRegion();\n372. \n373.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;\n374.     if (\n375.       deploymentBucketObject &&\n376.       deploymentBucketObject.serverSideEncryption &&\n377.       deploymentBucketObject.serverSideEncryption === \'aws:kms\'\n378.     ) {\n379.       result.signatureVersion = \'v4\';\n380.     }\n381. \n382.     // Store the credentials to avoid creating them again (messes up MFA).\n383.     this.cachedCredentials = result;\n384.     return result;\n385.   }\n386. \n387.   canUseS3TransferAcceleration(service, method) {\n388.     // TODO enable more S3 APIs?\n389.     return (\n390.       service === \'S3\' &&\n391.       [\'upload\', \'putObject\'].indexOf(method) !== -1 &&\n392.       this.isS3TransferAccelerationEnabled()\n393.     );\n394.   }\n395. \n396.   // This function will be used to block the addition of transfer acceleration options\n397.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)\n398.   isS3TransferAccelerationSupported() {\n399.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)\n400.     // since those regions do not yet support it\n401.     const endpoint = getS3EndpointForRegion(this.getRegion());\n402.     return endpoint === \'s3.amazonaws.com\';\n403.   }\n404. \n405.   isS3TransferAccelerationEnabled() {\n406.     return !!this.options[\'aws-s3-accelerate\'];\n407.   }\n408. \n409.   isS3TransferAccelerationDisabled() {\n410.     return !!this.options[\'no-aws-s3-accelerate\'];\n411.   }\n412. \n413.   disableTransferAccelerationForCurrentDeploy() {\n414.     delete this.options[\'aws-s3-accelerate\'];\n415.   }\n416. \n417.   enableS3TransferAcceleration(credentials) {\n418.     this.serverless.cli.log(\'Using S3 Transfer Acceleration Endpoint...\');\n419.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign\n420.   }\n421. \n422.   getValues(source, paths) {\n423.     return paths.map(path => ({\n424.       path,\n425.       value: _.get(source, path.join(\'.\')),\n426.     }));\n427.   }\n428.   firstValue(values) {\n429.     return values.reduce((result, current) => {\n430.       return result.value ? result : current;\n431.     }, {});\n432.   }\n433. \n434.   getRegionSourceValue() {\n435.     const values = this.getValues(this, [\n436.       [\'options\', \'region\'],\n437.       [\'serverless\', \'config\', \'region\'],\n438.       [\'serverless\', \'service\', \'provider\', \'region\'],\n439.     ]);\n440.     return this.firstValue(values);\n441.   }\n442.   getRegion() {\n443.     const defaultRegion = \'us-east-1\';\n444.     const regionSourceValue = this.getRegionSourceValue();\n445.     return regionSourceValue.value || defaultRegion;\n446.   }\n447. \n448.   getProfileSourceValue() {\n449.     const values = this.getValues(this, [\n450.       [\'options\', \'aws-profile\'],\n451.       [\'options\', \'profile\'],\n452.       [\'serverless\', \'config\', \'profile\'],\n453.       [\'serverless\', \'service\', \'provider\', \'profile\'],\n454.     ]);\n455.     const firstVal = this.firstValue(values);\n456.     return firstVal ? firstVal.value : null;\n457.   }\n458.   getProfile() {\n459.     return this.getProfileSourceValue();\n460.   }\n461. \n462.   getServerlessDeploymentBucketName() {\n463.     if (this.serverless.service.provider.deploymentBucket) {\n464.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);\n465.     }\n466.     return this.request(\'CloudFormation\', \'describeStackResource\', {\n467.       StackName: this.naming.getStackName(),\n468.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),\n469.     }).then(result => result.StackResourceDetail.PhysicalResourceId);\n470.   }\n471. \n472.   getDeploymentPrefix() {\n473.     return this.serverless.service.provider.deploymentPrefix || \'serverless\';\n474.   }\n475. \n476.   getLogRetentionInDays() {\n477.     if (!_.has(this.serverless.service.provider, \'logRetentionInDays\')) {\n478.       return null;\n479.     }\n480.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;\n481.     const retentionInDays = parseInt(rawRetentionInDays, 10);\n482.     if (_.isInteger(retentionInDays) && retentionInDays > 0) {\n483.       return retentionInDays;\n484.     }\n485. \n486.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;\n487.     throw new this.serverless.classes.Error(errorMessage);\n488.   }\n489. \n490.   getStageSourceValue() {\n491.     const values = this.getValues(this, [\n492.       [\'options\', \'stage\'],\n493.       [\'serverless\', \'config\', \'stage\'],\n494.       [\'serverless\', \'service\', \'provider\', \'stage\'],\n495.     ]);\n496.     return this.firstValue(values);\n497.   }\n498.   getStage() {\n499.     const defaultStage = \'dev\';\n500.     const stageSourceValue = this.getStageSourceValue();\n\n\nFile: lib/plugins/aws/provider/awsProvider.js\nLine number range: 500 - 1000\nContent:\n500.     const stageSourceValue = this.getStageSourceValue();\n501.     return stageSourceValue.value || defaultStage;\n502.   }\n503. \n504.   getAccountId() {\n505.     return this.getAccountInfo().then(result => result.accountId);\n506.   }\n507. \n508.   getAccountInfo() {\n509.     return this.request(\'STS\', \'getCallerIdentity\', {}).then(result => {\n510.       const arn = result.Arn;\n511.       const accountId = result.Account;\n512.       const partition = _.nth(_.split(arn, \':\'), 1); // ex: arn:aws:iam:acctId:user/xyz\n513.       return {\n514.         accountId,\n515.         partition,\n516.         arn: result.Arn,\n517.         userId: result.UserId,\n518.       };\n519.     });\n520.   }\n521. \n522.   /**\n523.    * Get API Gateway Rest API ID from serverless config\n524.    */\n525.   getApiGatewayRestApiId() {\n526.     if (\n527.       this.serverless.service.provider.apiGateway &&\n528.       this.serverless.service.provider.apiGateway.restApiId\n529.     ) {\n530.       return this.serverless.service.provider.apiGateway.restApiId;\n531.     }\n532. \n533.     return { Ref: this.naming.getRestApiLogicalId() };\n534.   }\n535. \n536.   getApiGatewayDescription() {\n537.     if (\n538.       this.serverless.service.provider.apiGateway &&\n539.       this.serverless.service.provider.apiGateway.description\n540.     ) {\n541.       return this.serverless.service.provider.apiGateway.description;\n542.     }\n543.     return undefined;\n544.   }\n545. \n546.   getMethodArn(accountId, apiId, method, pathParam) {\n547.     const region = this.getRegion();\n548.     let path = pathParam;\n549.     if (pathParam.startsWith(\'/\')) {\n550.       path = pathParam.replace(/^\\/+/g, \'\');\n551.     }\n552.     return `arn:aws:execute-api:${region}:${accountId}:${apiId}/*/${method.toUpperCase()}/${path}`;\n553.   }\n554. \n555.   /**\n556.    * Get Rest API Root Resource ID from serverless config\n557.    */\n558.   getApiGatewayRestApiRootResourceId() {\n559.     if (\n560.       this.serverless.service.provider.apiGateway &&\n561.       this.serverless.service.provider.apiGateway.restApiRootResourceId\n562.     ) {\n563.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;\n564.     }\n565.     return { \'Fn::GetAtt\': [this.naming.getRestApiLogicalId(), \'RootResourceId\'] };\n566.   }\n567. \n568.   /**\n569.    * Get Rest API Predefined Resources from serverless config\n570.    */\n571.   getApiGatewayPredefinedResources() {\n572.     if (\n573.       !this.serverless.service.provider.apiGateway ||\n574.       !this.serverless.service.provider.apiGateway.restApiResources\n575.     ) {\n576.       return [];\n577.     }\n578. \n579.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {\n580.       return this.serverless.service.provider.apiGateway.restApiResources;\n581.     }\n582. \n583.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== \'object\') {\n584.       throw new Error(\'REST API resource must be an array of object\');\n585.     }\n586. \n587.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({\n588.       path: key,\n589.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],\n590.     }));\n591.   }\n592. \n593.   /**\n594.    * Get API Gateway websocket API ID from serverless config\n595.    */\n596.   getApiGatewayWebsocketApiId() {\n597.     if (\n598.       this.serverless.service.provider.apiGateway &&\n599.       this.serverless.service.provider.apiGateway.websocketApiId\n600.     ) {\n601.       return this.serverless.service.provider.apiGateway.websocketApiId;\n602.     }\n603. \n604.     return { Ref: this.naming.getWebsocketsApiLogicalId() };\n605.   }\n606. \n607.   getStackResources(next, resourcesParam) {\n608.     let resources = resourcesParam;\n609.     const params = {\n610.       StackName: this.naming.getStackName(),\n611.     };\n612.     if (!resources) resources = [];\n613.     if (next) params.NextToken = next;\n614. \n615.     return this.request(\'CloudFormation\', \'listStackResources\', params).then(res => {\n616.       const allResources = resources.concat(res.StackResourceSummaries);\n617.       if (!res.NextToken) {\n618.         return allResources;\n619.       }\n620.       return this.getStackResources(res.NextToken, allResources);\n621.     });\n622.   }\n623. }\n624. \n625. module.exports = AwsProvider;\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nFeature Understanding:\n- The request is to allow IAM policy statements in provider.iamRoleStatements that use NotAction and NotResource, which are valid AWS IAM elements. Currently, the framework rejects such statements because validation requires Action and Resource keys.\n- Desired functionality:\n  - Accept IAM role statements that specify either Action or NotAction, and either Resource or NotResource.\n  - Ensure statements that use NotAction/NotResource are merged into the generated IAM PolicyDocument like other statements.\n- Requirements and constraints:\n  - Effect should remain required and be either Allow or Deny.\n  - AWS IAM does not allow using both Action and NotAction within the same statement, nor both Resource and NotResource. Validation should enforce mutual exclusivity.\n  - NotAction/NotResource can be strings or arrays (consistent with IAM policy semantics).\n- Ambiguities/edge cases to clarify:\n  - Deduplication logic when adding statements to custom resource roles currently compares only the Resource field; we need to ensure statements using NotResource are handled and duplicates are identified appropriately. The safest approach is dedup by full statement equality rather than just Resource.\n  - If a user provides a provider-level custom role (provider.role) or function-level role, validation still currently runs on provider.iamRoleStatements even though they’re not merged. Confirm whether we want to keep that behavior; for consistency, keep validation but update it to allow NotAction/NotResource.\n\nArchitecture Analysis:\n- Primary integration points:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js: validateStatements currently enforces presence of Effect, Action, Resource. Update to support NotAction and NotResource, and enforce IAM rules on mutual exclusivity.\n  - lib/plugins/aws/customResources/index.js: When merging iamRoleStatements into the custom resource lambda role, dedup logic uses Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource). This will fail or behave incorrectly if statements have NotResource; update the logic to avoid dependence on Resource and to compare full statements.\n- Other modules that generate IAM statements for events (s3, sqs, streams, eventBridge, cognito) already produce standard Action/Resource statements; they don’t need modification for this feature but should not break if provider.iamRoleStatements include NotAction/NotResource.\n- Documentation needs updating to reflect support for NotAction and NotResource with examples and constraints.\n\nImplementation Plan:\n1) Update validation in lib/plugins/aws/package/lib/mergeIamTemplates.js\n- File: lib/plugins/aws/package/lib/mergeIamTemplates.js\n- Function: validateStatements(statements)\n- Changes:\n  - Replace the hard requirement for Action and Resource with logic that requires:\n    - Effect is present\n    - Exactly one of Action or NotAction is present\n    - Exactly one of Resource or NotResource is present\n  - If both Action and NotAction are present (or both Resource and NotResource), produce a clear error describing mutual exclusivity per IAM policy rules.\n  - Adjust error messages to reflect the new rules, e.g., “Each statement must include Effect and one of Action/NotAction, and one of Resource/NotResource. Action and NotAction cannot be used together; Resource and NotResource cannot be used together.”\n  - Optionally validate Effect value (Allow or Deny) for correctness without being overly strict on types of Action/NotAction and Resource/NotResource to preserve existing flexibility in CloudFormation intrinsic functions.\n- Integration:\n  - The rest of mergeIamTemplates.js (merging default role and concatenating provider.iamRoleStatements) can remain unchanged; PolicyDocument.Statement concatenation should handle NotAction/NotResource entries naturally.\n\n2) Fix deduplication logic when attaching iamRoleStatements to custom resources\n- File: lib/plugins/aws/customResources/index.js\n- Code block around lines 155-160 where pushing new statements:\n  - Current behavior: de-dup checks only equality of the Resource field and then pushes newStmt.\n  - Update:\n    - Modify the deduplication to compare the whole statement object rather than just the Resource field. This ensures statements with NotResource or different Action/NotAction values aren’t incorrectly considered duplicates or erroneously allowed multiple times.\n    - Ensure the code does not assume newStmt.Resource exists; account for NotResource-only statements.\n- Integration:\n  - This change prevents runtime errors and correctly supports NotResource statements when building the custom resource role (e.g., for Cognito, S3, EventBridge custom resources).\n\n3) Documentation update to reflect support for NotAction and NotResource\n- File: docs/providers/aws/guide/iam.md\n- Changes:\n  - Add a brief section or note under “The Default IAM Role” explaining that provider.iamRoleStatements supports NotAction and NotResource.\n  - Include an example using NotResource to allow sns:Publish but exclude SNS topics, as requested:\n    - Example: Effect: Allow, Action: sns:Publish, NotResource: arn:aws:sns:*:*:* (illustrates allowing SMS publish while excluding topic publish).\n  - Clarify constraints:\n    - Do not use Action and NotAction together in the same statement.\n    - Do not use Resource and NotResource together in the same statement.\n    - Link to AWS IAM docs for NotAction and NotResource elements for further reference.\n\n4) Confirm other references to Resource in merging logic won’t break\n- Files to review but likely no changes needed:\n  - lib/plugins/aws/package/lib/mergeIamTemplates.js (merging iamRoleStatements via concat, already agnostic)\n  - lib/plugins/aws/package/index.js (calls validateStatements, then merge)\n  - Event compilers (cognitoUserPool, eventBridge, s3, sqs, stream, cloudFront) only push internally generated Action/Resource statements; these do not need to support NotResource/NotAction but should remain compatible with provider-level statements being appended later.\n\nConsiderations:\n- Impact on existing functionality:\n  - Validation becomes more permissive but remains strictly aligned to IAM rules. Existing Action/Resource statements continue to pass validation unchanged.\n  - Dedup logic change in customResources role creation will slightly alter how duplicates are detected; comparing entire statements is safer and avoids accidental collisions based solely on Resource. This should reduce the chance of missing unique statements or mishandling NotResource statements.\n- Backward compatibility:\n  - Existing configurations are preserved; the new validation simply adds support for NotAction/NotResource.\n  - Error messages become more informative for users who try to specify both Action and NotAction (or both Resource and NotResource).\n- Dependencies/prerequisites:\n  - No new external dependencies.\n  - Ensure any unit tests or integration tests that assert the old validation error messages or dedup behavior are updated to reflect the new rules.\n  - No changes to the CloudFormation IAM role template JSON required; AWS IAM supports NotAction and NotResource in PolicyDocument Statements already.\n\nBy making these changes, provider.iamRoleStatements will correctly accept and process valid IAM statements that include NotAction and NotResource, and the custom resource role assembly will handle deduplication robustly without relying on the presence of Resource.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 21:34:59,030 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CNKrUceeSAIp9dXEvPIpOcuX', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 479, 'prompt_tokens': 19593, 'total_tokens': 20072, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6664ce17-54c4-46ec-b5cf-491d570f4d35-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_CNKrUceeSAIp9dXEvPIpOcuX', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19593, 'output_tokens': 479, 'total_tokens': 20072, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:35:10,924 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_YibWcXmILf74R0TUGUAWhPFA', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 672, 'prompt_tokens': 21679, 'total_tokens': 22351, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8bb96e35-77d9-46b0-bc79-d6f2bc3584d8-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_YibWcXmILf74R0TUGUAWhPFA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21679, 'output_tokens': 672, 'total_tokens': 22351, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 21:35:13,612 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_t2bVDXuEkI9AdTkj0qbmRBrO', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 25079, 'total_tokens': 25107, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--aa785d19-1745-4631-ab05-51c7d95ab6f6-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_t2bVDXuEkI9AdTkj0qbmRBrO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25079, 'output_tokens': 28, 'total_tokens': 25107, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:35:45,707 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5kkRh1qNjbcdPeGsnFDHLozz', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"const BbPromise = require(\'bluebird\');\\nconst fse = BbPromise.promisifyAll(require(\'fs-extra\'));\\nconst childProcess = BbPromise.promisifyAll(require(\'child_process\'));","new_content":"const BbPromise = require(\'bluebird\');\\nconst _ = require(\'lodash\');\\nconst fse = BbPromise.promisifyAll(require(\'fs-extra\'));\\nconst childProcess = BbPromise.promisifyAll(require(\'child_process\'));"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3526, 'prompt_tokens': 27338, 'total_tokens': 30864, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3392, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0d182fcb-5da4-4ffc-8b04-f9bb7cb6e141-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': "const BbPromise = require('bluebird');\nconst fse = BbPromise.promisifyAll(require('fs-extra'));\nconst childProcess = BbPromise.promisifyAll(require('child_process'));", 'new_content': "const BbPromise = require('bluebird');\nconst _ = require('lodash');\nconst fse = BbPromise.promisifyAll(require('fs-extra'));\nconst childProcess = BbPromise.promisifyAll(require('child_process'));"}, 'id': 'call_5kkRh1qNjbcdPeGsnFDHLozz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27338, 'output_tokens': 3526, 'total_tokens': 30864, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 3392}}
2025-11-13 21:35:48,187 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gM6vYxPH5cpgmAmk8CHoWq7r', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js","old_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\\n          Statement.push(newStmt);\\n        }\\n      });","new_content":"      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\\n      iamRoleStatements.forEach(newStmt => {\\n        if (!Statement.find(existingStmt => _.isEqual(existingStmt, newStmt))) {\\n          Statement.push(newStmt);\\n        }\\n      });"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 154, 'prompt_tokens': 27486, 'total_tokens': 27640, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 21632}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--03fa2536-7636-4d24-9061-4b88b8da608d-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js', 'old_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n          Statement.push(newStmt);\n        }\n      });', 'new_content': '      const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n      iamRoleStatements.forEach(newStmt => {\n        if (!Statement.find(existingStmt => _.isEqual(existingStmt, newStmt))) {\n          Statement.push(newStmt);\n        }\n      });'}, 'id': 'call_gM6vYxPH5cpgmAmk8CHoWq7r', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27486, 'output_tokens': 154, 'total_tokens': 27640, 'input_token_details': {'audio': 0, 'cache_read': 21632}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:35:50,243 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_sW8UskoAc1KmkM3VhAWDn4Fu', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/customResources/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 27660, 'total_tokens': 27685, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27264}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--980d9b89-832b-4ba4-be7f-8f0a8a16b03a-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/customResources/index.js'}, 'id': 'call_sW8UskoAc1KmkM3VhAWDn4Fu', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27660, 'output_tokens': 25, 'total_tokens': 27685, 'input_token_details': {'audio': 0, 'cache_read': 27264}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:35:56,116 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XZ3zL0Y2dCuu8ojLOrL2qND5', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js","old_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\\n    // Action: ..., Resource: ... } objects.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const missing = [\'Effect\', \'Action\', \'Resource\'].filter(\\n          prop => statement[prop] === undefined\\n        );\\n        return missing.length === 0\\n          ? null\\n          : `statement ${i} is missing the following properties: ${missing.join(\', \')}`;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect, Action, Resource fields.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },","new_content":"  validateStatements(statements) {\\n    // Verify that iamRoleStatements (if present) is an array of IAM policy statements.\\n    // Each statement must include Effect and exactly one of Action/NotAction,\\n    // and exactly one of Resource/NotResource.\\n    if (!statements) {\\n      return;\\n    }\\n    let violationsFound;\\n    if (!(statements instanceof Array)) {\\n      violationsFound = \'it is not an array\';\\n    } else {\\n      const descriptions = statements.map((statement, i) => {\\n        const hasEffect = statement.Effect !== undefined;\\n        const hasAction = statement.Action !== undefined;\\n        const hasNotAction = statement.NotAction !== undefined;\\n        const hasResource = statement.Resource !== undefined;\\n        const hasNotResource = statement.NotResource !== undefined;\\n\\n        const missingProps = [];\\n        if (!hasEffect) missingProps.push(\'Effect\');\\n        if (!hasAction && !hasNotAction) missingProps.push(\'Action or NotAction\');\\n        if (!hasResource && !hasNotResource) missingProps.push(\'Resource or NotResource\');\\n\\n        const exclusivityErrors = [];\\n        if (hasAction && hasNotAction) {\\n          exclusivityErrors.push(\'cannot have both Action and NotAction\');\\n        }\\n        if (hasResource && hasNotResource) {\\n          exclusivityErrors.push(\'cannot have both Resource and NotResource\');\\n        }\\n\\n        if (missingProps.length || exclusivityErrors.length) {\\n          const parts = [];\\n          if (missingProps.length) {\\n            parts.push(`missing the following properties: ${missingProps.join(\', \')}`);\\n          }\\n          if (exclusivityErrors.length) {\\n            parts.push(exclusivityErrors.join(\'; \'));\\n          }\\n          return `statement ${i} is ${parts.join(\'; \')}`;\\n        }\\n        return null;\\n      });\\n      const flawed = descriptions.filter(curr => curr);\\n      if (flawed.length) {\\n        violationsFound = flawed.join(\'; \');\\n      }\\n    }\\n\\n    if (violationsFound) {\\n      const errorMessage = [\\n        \'iamRoleStatements should be an array of objects,\',\\n        \' where each object has Effect and one of Action/NotAction, and one of Resource/NotResource.\',\\n        \' Action and NotAction cannot be used together; Resource and NotResource cannot be used together.\',\\n        ` Specifically, ${violationsFound}`,\\n      ].join(\'\');\\n      throw new this.serverless.classes.Error(errorMessage);\\n    }\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 902, 'prompt_tokens': 29756, 'total_tokens': 30658, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cdc49843-7fe2-4496-a3b3-c6b127335b9b-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js', 'old_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n    // Action: ..., Resource: ... } objects.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const missing = ['Effect', 'Action', 'Resource'].filter(\n          prop => statement[prop] === undefined\n        );\n        return missing.length === 0\n          ? null\n          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect, Action, Resource fields.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },", 'new_content': "  validateStatements(statements) {\n    // Verify that iamRoleStatements (if present) is an array of IAM policy statements.\n    // Each statement must include Effect and exactly one of Action/NotAction,\n    // and exactly one of Resource/NotResource.\n    if (!statements) {\n      return;\n    }\n    let violationsFound;\n    if (!(statements instanceof Array)) {\n      violationsFound = 'it is not an array';\n    } else {\n      const descriptions = statements.map((statement, i) => {\n        const hasEffect = statement.Effect !== undefined;\n        const hasAction = statement.Action !== undefined;\n        const hasNotAction = statement.NotAction !== undefined;\n        const hasResource = statement.Resource !== undefined;\n        const hasNotResource = statement.NotResource !== undefined;\n\n        const missingProps = [];\n        if (!hasEffect) missingProps.push('Effect');\n        if (!hasAction && !hasNotAction) missingProps.push('Action or NotAction');\n        if (!hasResource && !hasNotResource) missingProps.push('Resource or NotResource');\n\n        const exclusivityErrors = [];\n        if (hasAction && hasNotAction) {\n          exclusivityErrors.push('cannot have both Action and NotAction');\n        }\n        if (hasResource && hasNotResource) {\n          exclusivityErrors.push('cannot have both Resource and NotResource');\n        }\n\n        if (missingProps.length || exclusivityErrors.length) {\n          const parts = [];\n          if (missingProps.length) {\n            parts.push(`missing the following properties: ${missingProps.join(', ')}`);\n          }\n          if (exclusivityErrors.length) {\n            parts.push(exclusivityErrors.join('; '));\n          }\n          return `statement ${i} is ${parts.join('; ')}`;\n        }\n        return null;\n      });\n      const flawed = descriptions.filter(curr => curr);\n      if (flawed.length) {\n        violationsFound = flawed.join('; ');\n      }\n    }\n\n    if (violationsFound) {\n      const errorMessage = [\n        'iamRoleStatements should be an array of objects,',\n        ' where each object has Effect and one of Action/NotAction, and one of Resource/NotResource.',\n        ' Action and NotAction cannot be used together; Resource and NotResource cannot be used together.',\n        ` Specifically, ${violationsFound}`,\n      ].join('');\n      throw new this.serverless.classes.Error(errorMessage);\n    }\n  },"}, 'id': 'call_XZ3zL0Y2dCuu8ojLOrL2qND5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29756, 'output_tokens': 902, 'total_tokens': 30658, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:35:58,180 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_mQ6NE4ZLPpsLm06fEQkDnMhE', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/lib/mergeIamTemplates.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 28, 'prompt_tokens': 30682, 'total_tokens': 30710, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27648}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b5f50a29-4d5c-4b38-ba4e-a9b769b3ede0-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/lib/mergeIamTemplates.js'}, 'id': 'call_mQ6NE4ZLPpsLm06fEQkDnMhE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30682, 'output_tokens': 28, 'total_tokens': 30710, 'input_token_details': {'audio': 0, 'cache_read': 27648}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:36:00,409 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0DmeEFV9zGa7gqY3vG1NIDnN', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.","new_content":"To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements support standard IAM elements, including using NotAction and NotResource (mutually exclusive with Action and Resource respectively)."}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 174, 'prompt_tokens': 33245, 'total_tokens': 33419, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30592}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6adbbe3e-49ec-4dec-b8a3-ef843c81b071-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': 'To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.', 'new_content': 'To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements support standard IAM elements, including using NotAction and NotResource (mutually exclusive with Action and Resource respectively).'}, 'id': 'call_0DmeEFV9zGa7gqY3vG1NIDnN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33245, 'output_tokens': 174, 'total_tokens': 33419, 'input_token_details': {'audio': 0, 'cache_read': 30592}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:36:03,660 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_g8Rwxy6KaRwFtkl7F3yl5DYn', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md","old_content":"```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n```","new_content":"```yml\\nservice: new-service\\n\\nprovider:\\n  name: aws\\n  iamRoleStatements:\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:ListBucket\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n    - Effect: \'Allow\'\\n      Action:\\n        - \'s3:PutObject\'\\n      Resource:\\n        Fn::Join:\\n          - \'\'\\n          - - \'arn:aws:s3:::\'\\n            - Ref: ServerlessDeploymentBucket\\n            - \'/*\'\\n    # Example using NotResource (mutually exclusive with Resource)\\n    - Effect: \'Allow\'\\n      Action: \'sns:Publish\'\\n      NotResource: \'arn:aws:sns:*:*:*\'\\n```"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 378, 'prompt_tokens': 33440, 'total_tokens': 33818, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d1d2e7ac-f910-4983-aaaf-568b5ce56055-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md', 'old_content': "```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n```", 'new_content': "```yml\nservice: new-service\n\nprovider:\n  name: aws\n  iamRoleStatements:\n    - Effect: 'Allow'\n      Action:\n        - 's3:ListBucket'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n    - Effect: 'Allow'\n      Action:\n        - 's3:PutObject'\n      Resource:\n        Fn::Join:\n          - ''\n          - - 'arn:aws:s3:::'\n            - Ref: ServerlessDeploymentBucket\n            - '/*'\n    # Example using NotResource (mutually exclusive with Resource)\n    - Effect: 'Allow'\n      Action: 'sns:Publish'\n      NotResource: 'arn:aws:sns:*:*:*'\n```"}, 'id': 'call_g8Rwxy6KaRwFtkl7F3yl5DYn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33440, 'output_tokens': 378, 'total_tokens': 33818, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:36:07,324 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_8rRA0Pm6Mzz2yp6qfJudhRak', 'function': {'arguments': '{"relative_path":"docs/providers/aws/guide/iam.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 33839, 'total_tokens': 33865, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--25f427e8-776b-4732-9457-b919eb52564a-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/guide/iam.md'}, 'id': 'call_8rRA0Pm6Mzz2yp6qfJudhRak', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33839, 'output_tokens': 26, 'total_tokens': 33865, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 21:36:16,874 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I implemented support for NotAction and NotResource in IAM role statements and adjusted deduplication logic for custom resource roles, along with updating the documentation.\n\nChanges made:\n- lib/plugins/aws/package/lib/mergeIamTemplates.js\n  - Updated validateStatements to allow statements that include:\n    - Effect (required)\n    - Exactly one of Action or NotAction\n    - Exactly one of Resource or NotResource\n  - Enforced mutual exclusivity between Action/NotAction and Resource/NotResource\n  - Improved error messaging accordingly\n\n- lib/plugins/aws/customResources/index.js\n  - Switched deduplication of IAM statements for the custom resources role from comparing only Resource to comparing full statement objects using deep equality (lodash isEqual)\n  - Added lodash import to support deep equality check\n\n- docs/providers/aws/guide/iam.md\n  - Clarified that iamRoleStatements support NotAction and NotResource (mutually exclusive with Action and Resource)\n  - Added an example using NotResource for sns:Publish\n\nAll edits were verified by reading the files before and after changes.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 676, 'prompt_tokens': 37312, 'total_tokens': 37988, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 33792}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--25cd19df-7891-4b0b-a3d6-263a1e07ab4d-0' usage_metadata={'input_tokens': 37312, 'output_tokens': 676, 'total_tokens': 37988, 'input_token_details': {'audio': 0, 'cache_read': 33792}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 21:36:16,912 - thread-135845298308800.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md
index f08eef33c..32df09e28 100644
--- a/docs/providers/aws/guide/iam.md
+++ b/docs/providers/aws/guide/iam.md
@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc
 
 By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
 
-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements support standard IAM elements, including using NotAction and NotResource (mutually exclusive with Action and Resource respectively).
 
 ```yml
 service: new-service
@@ -45,6 +45,10 @@ provider:
           - - 'arn:aws:s3:::'
             - Ref: ServerlessDeploymentBucket
             - '/*'
+    # Example using NotResource (mutually exclusive with Resource)
+    - Effect: 'Allow'
+      Action: 'sns:Publish'
+      NotResource: 'arn:aws:sns:*:*:*'
 ```
 
 Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
diff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js
index b3b9b4f99..4ce1d4249 100644
--- a/lib/plugins/aws/customResources/index.js
+++ b/lib/plugins/aws/customResources/index.js
@@ -3,6 +3,7 @@
 const path = require('path');
 const crypto = require('crypto');
 const BbPromise = require('bluebird');
+const _ = require('lodash');
 const fse = BbPromise.promisifyAll(require('fs-extra'));
 const childProcess = BbPromise.promisifyAll(require('child_process'));
 const getTmpDirPath = require('../../../utils/fs/getTmpDirPath');
@@ -154,7 +155,7 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements
       }
       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
       iamRoleStatements.forEach(newStmt => {
-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
+        if (!Statement.find(existingStmt => _.isEqual(existingStmt, newStmt))) {
           Statement.push(newStmt);
         }
       });
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js
index 2d97671ad..7558546b0 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -182,8 +182,9 @@ module.exports = {
   },
 
   validateStatements(statements) {
-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
-    // Action: ..., Resource: ... } objects.
+    // Verify that iamRoleStatements (if present) is an array of IAM policy statements.
+    // Each statement must include Effect and exactly one of Action/NotAction,
+    // and exactly one of Resource/NotResource.
     if (!statements) {
       return;
     }
@@ -192,12 +193,36 @@ module.exports = {
       violationsFound = 'it is not an array';
     } else {
       const descriptions = statements.map((statement, i) => {
-        const missing = ['Effect', 'Action', 'Resource'].filter(
-          prop => statement[prop] === undefined
-        );
-        return missing.length === 0
-          ? null
-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
+        const hasEffect = statement.Effect !== undefined;
+        const hasAction = statement.Action !== undefined;
+        const hasNotAction = statement.NotAction !== undefined;
+        const hasResource = statement.Resource !== undefined;
+        const hasNotResource = statement.NotResource !== undefined;
+
+        const missingProps = [];
+        if (!hasEffect) missingProps.push('Effect');
+        if (!hasAction && !hasNotAction) missingProps.push('Action or NotAction');
+        if (!hasResource && !hasNotResource) missingProps.push('Resource or NotResource');
+
+        const exclusivityErrors = [];
+        if (hasAction && hasNotAction) {
+          exclusivityErrors.push('cannot have both Action and NotAction');
+        }
+        if (hasResource && hasNotResource) {
+          exclusivityErrors.push('cannot have both Resource and NotResource');
+        }
+
+        if (missingProps.length || exclusivityErrors.length) {
+          const parts = [];
+          if (missingProps.length) {
+            parts.push(`missing the following properties: ${missingProps.join(', ')}`);
+          }
+          if (exclusivityErrors.length) {
+            parts.push(exclusivityErrors.join('; '));
+          }
+          return `statement ${i} is ${parts.join('; ')}`;
+        }
+        return null;
       });
       const flawed = descriptions.filter(curr => curr);
       if (flawed.length) {
@@ -208,7 +233,8 @@ module.exports = {
     if (violationsFound) {
       const errorMessage = [
         'iamRoleStatements should be an array of objects,',
-        ' where each object has Effect, Action, Resource fields.',
+        ' where each object has Effect and one of Action/NotAction, and one of Resource/NotResource.',
+        ' Action and NotAction cannot be used together; Resource and NotResource cannot be used together.',
         ` Specifically, ${violationsFound}`,
       ].join('');
       throw new this.serverless.classes.Error(errorMessage);

2025-11-13 21:36:16,914 - thread-135845298308800.prometheus.lang_graph.nodes.patch_normalization_node - INFO - Starting to process 5 patches
2025-11-13 21:36:16,921 - thread-135845298308800.prometheus.lang_graph.nodes.patch_normalization_node - INFO - Deduplication complete: 5 -> 5 unique patches
2025-11-13 21:36:16,921 - thread-135845298308800.prometheus.lang_graph.nodes.patch_normalization_node - INFO - Patch processing complete, deduplicated to 5 unique patches
2025-11-13 21:36:16,923 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - INFO - Enter get_pass_regression_test_patch_subgraph_node
2025-11-13 21:36:16,923 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - selected_regression_tests: []
2025-11-13 21:36:16,923 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - INFO - No regression tests selected, skipping patch testing.
2025-11-13 21:36:16,924 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - DEBUG - Total candidate patches: 5
2025-11-13 21:36:16,925 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - DEBUG - Candidate patches: ["diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md\nindex f08eef33c..432d474f5 100644\n--- a/docs/providers/aws/guide/iam.md\n+++ b/docs/providers/aws/guide/iam.md\n@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc\n \n By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n \n-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. `iamRoleStatements` supports both Action and NotAction, and both Resource and NotResource (following IAM policy rules you must specify exactly one of Action/NotAction and exactly one of Resource/NotResource).\n \n ```yml\n service: new-service\n@@ -45,6 +45,10 @@ provider:\n           - - 'arn:aws:s3:::'\n             - Ref: ServerlessDeploymentBucket\n             - '/*'\n+    # Example using NotResource to allow publishing to SMS (but not to SNS topics)\n+    - Effect: 'Allow'\n+      Action: 'sns:Publish'\n+      NotResource: 'arn:aws:sns:*:*:*'\n ```\n \n Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\ndiff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js\nindex b3b9b4f99..1a8f56162 100644\n--- a/lib/plugins/aws/customResources/index.js\n+++ b/lib/plugins/aws/customResources/index.js\n@@ -1,5 +1,6 @@\n 'use strict';\n \n+const _ = require('lodash');\n const path = require('path');\n const crypto = require('crypto');\n const BbPromise = require('bluebird');\n@@ -154,7 +155,11 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements\n       }\n       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n       iamRoleStatements.forEach(newStmt => {\n-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n+        const keys = ['Effect', 'Action', 'NotAction', 'Resource', 'NotResource', 'Condition'];\n+        const isDuplicate = Statement.find(existingStmt =>\n+          _.isEqual(_.pick(existingStmt, keys), _.pick(newStmt, keys))\n+        );\n+        if (!isDuplicate) {\n           Statement.push(newStmt);\n         }\n       });\ndiff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js\nindex 2d97671ad..92fed5d59 100644\n--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js\n+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js\n@@ -182,8 +182,8 @@ module.exports = {\n   },\n \n   validateStatements(statements) {\n-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n-    // Action: ..., Resource: ... } objects.\n+    // Verify that iamRoleStatements (if present) is an array of objects with Effect and\n+    // either Action or NotAction, and either Resource or NotResource (but not both pairs).\n     if (!statements) {\n       return;\n     }\n@@ -192,12 +192,32 @@ module.exports = {\n       violationsFound = 'it is not an array';\n     } else {\n       const descriptions = statements.map((statement, i) => {\n-        const missing = ['Effect', 'Action', 'Resource'].filter(\n-          prop => statement[prop] === undefined\n-        );\n-        return missing.length === 0\n+        const hasEffect = statement.Effect !== undefined;\n+        const hasAction = statement.Action !== undefined;\n+        const hasNotAction = statement.NotAction !== undefined;\n+        const hasResource = statement.Resource !== undefined;\n+        const hasNotResource = statement.NotResource !== undefined;\n+\n+        const errors = [];\n+        if (!hasEffect) {\n+          errors.push('Effect');\n+        }\n+        // Validate Action/NotAction presence and exclusivity\n+        if (!(hasAction || hasNotAction)) {\n+          errors.push('Action or NotAction');\n+        } else if (hasAction && hasNotAction) {\n+          errors.push('cannot contain both Action and NotAction');\n+        }\n+        // Validate Resource/NotResource presence and exclusivity\n+        if (!(hasResource || hasNotResource)) {\n+          errors.push('Resource or NotResource');\n+        } else if (hasResource && hasNotResource) {\n+          errors.push('cannot contain both Resource and NotResource');\n+        }\n+\n+        return errors.length === 0\n           ? null\n-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n+          : `statement ${i} is invalid: ${errors.join(', ')}`;\n       });\n       const flawed = descriptions.filter(curr => curr);\n       if (flawed.length) {\n@@ -208,7 +228,7 @@ module.exports = {\n     if (violationsFound) {\n       const errorMessage = [\n         'iamRoleStatements should be an array of objects,',\n-        ' where each object has Effect, Action, Resource fields.',\n+        ' where each object has Effect and either Action or NotAction, and either Resource or NotResource.',\n         ` Specifically, ${violationsFound}`,\n       ].join('');\n       throw new this.serverless.classes.Error(errorMessage);\n", "diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md\nindex f08eef33c..1714a9b5c 100644\n--- a/docs/providers/aws/guide/iam.md\n+++ b/docs/providers/aws/guide/iam.md\n@@ -22,6 +22,8 @@ By default, one IAM Role is shared by all of the Lambda functions in your servic\n \n To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n \n+Statements support both Action/Resource and the complementary NotAction/NotResource elements as per AWS IAM policy syntax. Each statement must include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.\n+\n ```yml\n service: new-service\n \n@@ -45,6 +47,10 @@ provider:\n           - - 'arn:aws:s3:::'\n             - Ref: ServerlessDeploymentBucket\n             - '/*'\n+    # Example: allow SNS Publish to SMS (phone numbers) but not to SNS topics\n+    - Effect: 'Allow'\n+      Action: 'sns:Publish'\n+      NotResource: 'arn:aws:sns:*:*:*'\n ```\n \n Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\ndiff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js\nindex b3b9b4f99..e7b83d581 100644\n--- a/lib/plugins/aws/customResources/index.js\n+++ b/lib/plugins/aws/customResources/index.js\n@@ -3,6 +3,7 @@\n const path = require('path');\n const crypto = require('crypto');\n const BbPromise = require('bluebird');\n+const _ = require('lodash');\n const fse = BbPromise.promisifyAll(require('fs-extra'));\n const childProcess = BbPromise.promisifyAll(require('child_process'));\n const getTmpDirPath = require('../../../utils/fs/getTmpDirPath');\n@@ -154,7 +155,16 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements\n       }\n       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n       iamRoleStatements.forEach(newStmt => {\n-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n+        const isDuplicate = Statement.find(existingStmt => {\n+          if (newStmt.Resource !== undefined) {\n+            return existingStmt.Resource === newStmt.Resource;\n+          }\n+          if (newStmt.NotResource !== undefined) {\n+            return existingStmt.NotResource === newStmt.NotResource;\n+          }\n+          return _.isEqual(existingStmt, newStmt);\n+        });\n+        if (!isDuplicate) {\n           Statement.push(newStmt);\n         }\n       });\ndiff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js\nindex 2d97671ad..5abd66f0f 100644\n--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js\n+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js\n@@ -182,8 +182,10 @@ module.exports = {\n   },\n \n   validateStatements(statements) {\n-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n-    // Action: ..., Resource: ... } objects.\n+    // Verify that iamRoleStatements (if present) is an array of statement objects with:\n+    // - Effect\n+    // - exactly one of Action or NotAction\n+    // - exactly one of Resource or NotResource\n     if (!statements) {\n       return;\n     }\n@@ -192,12 +194,32 @@ module.exports = {\n       violationsFound = 'it is not an array';\n     } else {\n       const descriptions = statements.map((statement, i) => {\n-        const missing = ['Effect', 'Action', 'Resource'].filter(\n-          prop => statement[prop] === undefined\n-        );\n-        return missing.length === 0\n-          ? null\n-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n+        const errors = [];\n+        if (statement.Effect === undefined) {\n+          errors.push('Effect');\n+        }\n+        const hasAction = statement.Action !== undefined;\n+        const hasNotAction = statement.NotAction !== undefined;\n+        if (hasAction && hasNotAction) {\n+          errors.push('both Action and NotAction are present');\n+        } else if (!hasAction && !hasNotAction) {\n+          errors.push('neither Action nor NotAction is present');\n+        }\n+        const hasResource = statement.Resource !== undefined;\n+        const hasNotResource = statement.NotResource !== undefined;\n+        if (hasResource && hasNotResource) {\n+          errors.push('both Resource and NotResource are present');\n+        } else if (!hasResource && !hasNotResource) {\n+          errors.push('neither Resource nor NotResource is present');\n+        }\n+        if (errors.length === 0) {\n+          return null;\n+        }\n+        const missingEffect = statement.Effect === undefined ? ['Effect'] : [];\n+        if (missingEffect.length && errors.length === 1) {\n+          return `statement ${i} is missing the following properties: ${missingEffect.join(', ')}`;\n+        }\n+        return `statement ${i} violates validation: ${errors.join(', ')}`;\n       });\n       const flawed = descriptions.filter(curr => curr);\n       if (flawed.length) {\n@@ -208,7 +230,7 @@ module.exports = {\n     if (violationsFound) {\n       const errorMessage = [\n         'iamRoleStatements should be an array of objects,',\n-        ' where each object has Effect, Action, Resource fields.',\n+        ' where each object has Effect and either Action or NotAction, and either Resource or NotResource.',\n         ` Specifically, ${violationsFound}`,\n       ].join('');\n       throw new this.serverless.classes.Error(errorMessage);\n", "diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md\nindex f08eef33c..bc5a3dbaa 100644\n--- a/docs/providers/aws/guide/iam.md\n+++ b/docs/providers/aws/guide/iam.md\n@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc\n \n By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n \n-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements may use Action or NotAction, and Resource or NotResource (Action and NotAction are mutually exclusive, as are Resource and NotResource).\n \n ```yml\n service: new-service\n@@ -45,6 +45,10 @@ provider:\n           - - 'arn:aws:s3:::'\n             - Ref: ServerlessDeploymentBucket\n             - '/*'\n+    # Example using NotResource to exclude all SNS topics\n+    - Effect: 'Allow'\n+      Action: 'sns:Publish'\n+      NotResource: 'arn:aws:sns:*:*:*'\n ```\n \n Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\ndiff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js\nindex b3b9b4f99..dc43b9e42 100644\n--- a/lib/plugins/aws/customResources/index.js\n+++ b/lib/plugins/aws/customResources/index.js\n@@ -154,7 +154,16 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements\n       }\n       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n       iamRoleStatements.forEach(newStmt => {\n-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n+        const isDuplicate = Statement.find(existingStmt => {\n+          if (existingStmt.Resource !== undefined || newStmt.Resource !== undefined) {\n+            return existingStmt.Resource === newStmt.Resource;\n+          }\n+          if (existingStmt.NotResource !== undefined || newStmt.NotResource !== undefined) {\n+            return existingStmt.NotResource === newStmt.NotResource;\n+          }\n+          return false;\n+        });\n+        if (!isDuplicate) {\n           Statement.push(newStmt);\n         }\n       });\ndiff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js\nindex 2d97671ad..591859191 100644\n--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js\n+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js\n@@ -182,8 +182,8 @@ module.exports = {\n   },\n \n   validateStatements(statements) {\n-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n-    // Action: ..., Resource: ... } objects.\n+    // Verify that iamRoleStatements (if present) is an array of policy statement objects that\n+    // include Effect and exactly one of Action or NotAction, and exactly one of Resource or NotResource.\n     if (!statements) {\n       return;\n     }\n@@ -192,12 +192,27 @@ module.exports = {\n       violationsFound = 'it is not an array';\n     } else {\n       const descriptions = statements.map((statement, i) => {\n-        const missing = ['Effect', 'Action', 'Resource'].filter(\n-          prop => statement[prop] === undefined\n-        );\n-        return missing.length === 0\n-          ? null\n-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n+        const errors = [];\n+        if (statement.Effect === undefined) {\n+          errors.push('missing property: Effect');\n+        }\n+        const hasAction = statement.Action !== undefined;\n+        const hasNotAction = statement.NotAction !== undefined;\n+        if (!hasAction && !hasNotAction) {\n+          errors.push('missing property: Action or NotAction');\n+        }\n+        if (hasAction && hasNotAction) {\n+          errors.push('cannot have both Action and NotAction');\n+        }\n+        const hasResource = statement.Resource !== undefined;\n+        const hasNotResource = statement.NotResource !== undefined;\n+        if (!hasResource && !hasNotResource) {\n+          errors.push('missing property: Resource or NotResource');\n+        }\n+        if (hasResource && hasNotResource) {\n+          errors.push('cannot have both Resource and NotResource');\n+        }\n+        return errors.length ? `statement ${i} ${errors.join(', ')}` : null;\n       });\n       const flawed = descriptions.filter(curr => curr);\n       if (flawed.length) {\n@@ -208,7 +223,8 @@ module.exports = {\n     if (violationsFound) {\n       const errorMessage = [\n         'iamRoleStatements should be an array of objects,',\n-        ' where each object has Effect, Action, Resource fields.',\n+        ' where each object has Effect and exactly one of Action or NotAction,',\n+        ' and exactly one of Resource or NotResource.',\n         ` Specifically, ${violationsFound}`,\n       ].join('');\n       throw new this.serverless.classes.Error(errorMessage);\n", "diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md\nindex f08eef33c..fe9808d21 100644\n--- a/docs/providers/aws/guide/iam.md\n+++ b/docs/providers/aws/guide/iam.md\n@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc\n \n By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n \n-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. You may use either `Action` or `NotAction`, and either `Resource` or `NotResource` within a single statement (but not both of each).\n \n ```yml\n service: new-service\n@@ -45,6 +45,10 @@ provider:\n           - - 'arn:aws:s3:::'\n             - Ref: ServerlessDeploymentBucket\n             - '/*'\n+    # Example using NotResource to allow a lambda to send text messages, but not publish to any SNS topics\n+    - Effect: 'Allow'\n+      Action: 'sns:Publish'\n+      NotResource: 'arn:aws:sns:*:*:*'\n ```\n \n Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\ndiff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js\nindex b3b9b4f99..d5f959f36 100644\n--- a/lib/plugins/aws/customResources/index.js\n+++ b/lib/plugins/aws/customResources/index.js\n@@ -154,7 +154,21 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements\n       }\n       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n       iamRoleStatements.forEach(newStmt => {\n-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n+        const isDuplicate = Statement.find(existingStmt => {\n+          const newHasResource = newStmt.Resource !== undefined;\n+          const existingHasResource = existingStmt.Resource !== undefined;\n+          const newHasNotResource = newStmt.NotResource !== undefined;\n+          const existingHasNotResource = existingStmt.NotResource !== undefined;\n+\n+          if (newHasResource && existingHasResource) {\n+            return existingStmt.Resource === newStmt.Resource;\n+          }\n+          if (newHasNotResource && existingHasNotResource) {\n+            return existingStmt.NotResource === newStmt.NotResource;\n+          }\n+          return false;\n+        });\n+        if (!isDuplicate) {\n           Statement.push(newStmt);\n         }\n       });\ndiff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js\nindex 2d97671ad..2a879155b 100644\n--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js\n+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js\n@@ -182,8 +182,8 @@ module.exports = {\n   },\n \n   validateStatements(statements) {\n-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n-    // Action: ..., Resource: ... } objects.\n+    // Verify that iamRoleStatements (if present) is an array of valid policy statement objects,\n+    // each having Effect and exactly one of Action/NotAction and exactly one of Resource/NotResource.\n     if (!statements) {\n       return;\n     }\n@@ -192,12 +192,31 @@ module.exports = {\n       violationsFound = 'it is not an array';\n     } else {\n       const descriptions = statements.map((statement, i) => {\n-        const missing = ['Effect', 'Action', 'Resource'].filter(\n-          prop => statement[prop] === undefined\n-        );\n-        return missing.length === 0\n+        const issues = [];\n+\n+        if (statement.Effect === undefined) {\n+          issues.push('missing property: Effect');\n+        }\n+\n+        const hasAction = statement.Action !== undefined;\n+        const hasNotAction = statement.NotAction !== undefined;\n+        if (hasAction && hasNotAction) {\n+          issues.push('has mutually exclusive properties: Action and NotAction');\n+        } else if (!hasAction && !hasNotAction) {\n+          issues.push('missing one of required properties: Action or NotAction');\n+        }\n+\n+        const hasResource = statement.Resource !== undefined;\n+        const hasNotResource = statement.NotResource !== undefined;\n+        if (hasResource && hasNotResource) {\n+          issues.push('has mutually exclusive properties: Resource and NotResource');\n+        } else if (!hasResource && !hasNotResource) {\n+          issues.push('missing one of required properties: Resource or NotResource');\n+        }\n+\n+        return issues.length === 0\n           ? null\n-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n+          : `statement ${i} ${issues.join('; ')}`;\n       });\n       const flawed = descriptions.filter(curr => curr);\n       if (flawed.length) {\n@@ -208,7 +227,7 @@ module.exports = {\n     if (violationsFound) {\n       const errorMessage = [\n         'iamRoleStatements should be an array of objects,',\n-        ' where each object has Effect, Action, Resource fields.',\n+        ' where each object has Effect and exactly one of Action/NotAction, and exactly one of Resource/NotResource.',\n         ` Specifically, ${violationsFound}`,\n       ].join('');\n       throw new this.serverless.classes.Error(errorMessage);\n", "diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md\nindex f08eef33c..32df09e28 100644\n--- a/docs/providers/aws/guide/iam.md\n+++ b/docs/providers/aws/guide/iam.md\n@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc\n \n By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.\n \n-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.\n+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. Statements support standard IAM elements, including using NotAction and NotResource (mutually exclusive with Action and Resource respectively).\n \n ```yml\n service: new-service\n@@ -45,6 +45,10 @@ provider:\n           - - 'arn:aws:s3:::'\n             - Ref: ServerlessDeploymentBucket\n             - '/*'\n+    # Example using NotResource (mutually exclusive with Resource)\n+    - Effect: 'Allow'\n+      Action: 'sns:Publish'\n+      NotResource: 'arn:aws:sns:*:*:*'\n ```\n \n Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.\ndiff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js\nindex b3b9b4f99..4ce1d4249 100644\n--- a/lib/plugins/aws/customResources/index.js\n+++ b/lib/plugins/aws/customResources/index.js\n@@ -3,6 +3,7 @@\n const path = require('path');\n const crypto = require('crypto');\n const BbPromise = require('bluebird');\n+const _ = require('lodash');\n const fse = BbPromise.promisifyAll(require('fs-extra'));\n const childProcess = BbPromise.promisifyAll(require('child_process'));\n const getTmpDirPath = require('../../../utils/fs/getTmpDirPath');\n@@ -154,7 +155,7 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements\n       }\n       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;\n       iamRoleStatements.forEach(newStmt => {\n-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {\n+        if (!Statement.find(existingStmt => _.isEqual(existingStmt, newStmt))) {\n           Statement.push(newStmt);\n         }\n       });\ndiff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js\nindex 2d97671ad..7558546b0 100644\n--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js\n+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js\n@@ -182,8 +182,9 @@ module.exports = {\n   },\n \n   validateStatements(statements) {\n-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,\n-    // Action: ..., Resource: ... } objects.\n+    // Verify that iamRoleStatements (if present) is an array of IAM policy statements.\n+    // Each statement must include Effect and exactly one of Action/NotAction,\n+    // and exactly one of Resource/NotResource.\n     if (!statements) {\n       return;\n     }\n@@ -192,12 +193,36 @@ module.exports = {\n       violationsFound = 'it is not an array';\n     } else {\n       const descriptions = statements.map((statement, i) => {\n-        const missing = ['Effect', 'Action', 'Resource'].filter(\n-          prop => statement[prop] === undefined\n-        );\n-        return missing.length === 0\n-          ? null\n-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;\n+        const hasEffect = statement.Effect !== undefined;\n+        const hasAction = statement.Action !== undefined;\n+        const hasNotAction = statement.NotAction !== undefined;\n+        const hasResource = statement.Resource !== undefined;\n+        const hasNotResource = statement.NotResource !== undefined;\n+\n+        const missingProps = [];\n+        if (!hasEffect) missingProps.push('Effect');\n+        if (!hasAction && !hasNotAction) missingProps.push('Action or NotAction');\n+        if (!hasResource && !hasNotResource) missingProps.push('Resource or NotResource');\n+\n+        const exclusivityErrors = [];\n+        if (hasAction && hasNotAction) {\n+          exclusivityErrors.push('cannot have both Action and NotAction');\n+        }\n+        if (hasResource && hasNotResource) {\n+          exclusivityErrors.push('cannot have both Resource and NotResource');\n+        }\n+\n+        if (missingProps.length || exclusivityErrors.length) {\n+          const parts = [];\n+          if (missingProps.length) {\n+            parts.push(`missing the following properties: ${missingProps.join(', ')}`);\n+          }\n+          if (exclusivityErrors.length) {\n+            parts.push(exclusivityErrors.join('; '));\n+          }\n+          return `statement ${i} is ${parts.join('; ')}`;\n+        }\n+        return null;\n       });\n       const flawed = descriptions.filter(curr => curr);\n       if (flawed.length) {\n@@ -208,7 +233,8 @@ module.exports = {\n     if (violationsFound) {\n       const errorMessage = [\n         'iamRoleStatements should be an array of objects,',\n-        ' where each object has Effect, Action, Resource fields.',\n+        ' where each object has Effect and one of Action/NotAction, and one of Resource/NotResource.',\n+        ' Action and NotAction cannot be used together; Resource and NotResource cannot be used together.',\n         ` Specifically, ${violationsFound}`,\n       ].join('');\n       throw new this.serverless.classes.Error(errorMessage);\n"]
2025-11-13 21:36:40,383 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 1/10 try:Selected patch index: 3, 
2025-11-13 21:37:07,540 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 2/10 try:Selected patch index: 3, 
2025-11-13 21:37:36,161 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 3/10 try:Selected patch index: 2, 
2025-11-13 21:38:09,401 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 4/10 try:Selected patch index: 3, 
2025-11-13 21:38:47,691 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 5/10 try:Selected patch index: 3, 
2025-11-13 21:39:19,522 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 6/10 try:Selected patch index: 3, 
2025-11-13 21:39:55,382 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 7/10 try:Selected patch index: 3, 
2025-11-13 21:39:55,382 - thread-135845298308800.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode early stopping at turn 7 with result: [0, 0, 1, 6, 0], first place: 6, second place: 1, lead: 5, remaining votes: 3, selected patch index: 3
2025-11-13 21:40:06,827 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_responder_node - DEBUG - content='Thanks for the request to support NotAction and NotResource in iamRoleStatements.\n\nWhat’s implemented:\n- Validation now accepts policy statements that use exactly one of Action/NotAction and exactly one of Resource/NotResource, alongside Effect. If both forms are provided (e.g., Action and NotAction together), a clear validation error is returned.\n- Deduplication logic for custom resource IAM statements recognizes NotResource as well as Resource, so statements using NotResource aren’t inadvertently dropped.\n- Documentation has been updated to describe the supported combinations and includes an example using NotResource for SNS (matching your use case).\n\nExample (now documented):\n- Allow a Lambda to send text messages, but not publish to any SNS topics:\n  - Effect: Allow\n  - Action: sns:Publish\n  - NotResource: arn:aws:sns:*:*:*\n\nVerification:\n- No automated tests were run for this change.\n\nThis is an initial implementation and may require refinement. Please give it a try and let us know if you encounter any issues or edge cases.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 926, 'prompt_tokens': 1860, 'total_tokens': 2786, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--618a74c2-ffa4-400b-9769-2003de6dbe03-0' usage_metadata={'input_tokens': 1860, 'output_tokens': 926, 'total_tokens': 2786, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 21:40:06,856 - thread-135845298308800.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-13 21:40:06,857 - thread-135845298308800.prometheus.docker.base_container - INFO - Closing persistent shell...
2025-11-13 21:40:06,957 - thread-135845298308800.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-13 21:40:17,170 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_subgraph_node - INFO - Generated patch:
diff --git a/docs/providers/aws/guide/iam.md b/docs/providers/aws/guide/iam.md
index f08eef33c..fe9808d21 100644
--- a/docs/providers/aws/guide/iam.md
+++ b/docs/providers/aws/guide/iam.md
@@ -20,7 +20,7 @@ Every AWS Lambda function needs permission to interact with other AWS infrastruc
 
 By default, one IAM Role is shared by all of the Lambda functions in your service. Also by default, your Lambda functions have permission to create and write to CloudWatch logs. When VPC configuration is provided the default AWS `AWSLambdaVPCAccessExecutionRole` will be associated in order to communicate with your VPC resources.
 
-To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature.
+To add specific rights to this service-wide Role, define statements in `provider.iamRoleStatements` which will be merged into the generated policy. As those statements will be merged into the CloudFormation template, you can use `Join`, `Ref` or any other CloudFormation method or feature. You may use either `Action` or `NotAction`, and either `Resource` or `NotResource` within a single statement (but not both of each).
 
 ```yml
 service: new-service
@@ -45,6 +45,10 @@ provider:
           - - 'arn:aws:s3:::'
             - Ref: ServerlessDeploymentBucket
             - '/*'
+    # Example using NotResource to allow a lambda to send text messages, but not publish to any SNS topics
+    - Effect: 'Allow'
+      Action: 'sns:Publish'
+      NotResource: 'arn:aws:sns:*:*:*'
 ```
 
 Alongside `provider.iamRoleStatements` managed policies can also be added to this service-wide Role, define managed policies in `provider.iamManagedPolicies`. These will also be merged into the generated IAM Role so you can use `Join`, `Ref` or any other CloudFormation method or feature here too.
diff --git a/lib/plugins/aws/customResources/index.js b/lib/plugins/aws/customResources/index.js
index b3b9b4f99..d5f959f36 100644
--- a/lib/plugins/aws/customResources/index.js
+++ b/lib/plugins/aws/customResources/index.js
@@ -154,7 +154,21 @@ function addCustomResourceToService(awsProvider, resourceName, iamRoleStatements
       }
       const { Statement } = customResourceRole.Properties.Policies[0].PolicyDocument;
       iamRoleStatements.forEach(newStmt => {
-        if (!Statement.find(existingStmt => existingStmt.Resource === newStmt.Resource)) {
+        const isDuplicate = Statement.find(existingStmt => {
+          const newHasResource = newStmt.Resource !== undefined;
+          const existingHasResource = existingStmt.Resource !== undefined;
+          const newHasNotResource = newStmt.NotResource !== undefined;
+          const existingHasNotResource = existingStmt.NotResource !== undefined;
+
+          if (newHasResource && existingHasResource) {
+            return existingStmt.Resource === newStmt.Resource;
+          }
+          if (newHasNotResource && existingHasNotResource) {
+            return existingStmt.NotResource === newStmt.NotResource;
+          }
+          return false;
+        });
+        if (!isDuplicate) {
           Statement.push(newStmt);
         }
       });
diff --git a/lib/plugins/aws/package/lib/mergeIamTemplates.js b/lib/plugins/aws/package/lib/mergeIamTemplates.js
index 2d97671ad..2a879155b 100644
--- a/lib/plugins/aws/package/lib/mergeIamTemplates.js
+++ b/lib/plugins/aws/package/lib/mergeIamTemplates.js
@@ -182,8 +182,8 @@ module.exports = {
   },
 
   validateStatements(statements) {
-    // Verify that iamRoleStatements (if present) is an array of { Effect: ...,
-    // Action: ..., Resource: ... } objects.
+    // Verify that iamRoleStatements (if present) is an array of valid policy statement objects,
+    // each having Effect and exactly one of Action/NotAction and exactly one of Resource/NotResource.
     if (!statements) {
       return;
     }
@@ -192,12 +192,31 @@ module.exports = {
       violationsFound = 'it is not an array';
     } else {
       const descriptions = statements.map((statement, i) => {
-        const missing = ['Effect', 'Action', 'Resource'].filter(
-          prop => statement[prop] === undefined
-        );
-        return missing.length === 0
+        const issues = [];
+
+        if (statement.Effect === undefined) {
+          issues.push('missing property: Effect');
+        }
+
+        const hasAction = statement.Action !== undefined;
+        const hasNotAction = statement.NotAction !== undefined;
+        if (hasAction && hasNotAction) {
+          issues.push('has mutually exclusive properties: Action and NotAction');
+        } else if (!hasAction && !hasNotAction) {
+          issues.push('missing one of required properties: Action or NotAction');
+        }
+
+        const hasResource = statement.Resource !== undefined;
+        const hasNotResource = statement.NotResource !== undefined;
+        if (hasResource && hasNotResource) {
+          issues.push('has mutually exclusive properties: Resource and NotResource');
+        } else if (!hasResource && !hasNotResource) {
+          issues.push('missing one of required properties: Resource or NotResource');
+        }
+
+        return issues.length === 0
           ? null
-          : `statement ${i} is missing the following properties: ${missing.join(', ')}`;
+          : `statement ${i} ${issues.join('; ')}`;
       });
       const flawed = descriptions.filter(curr => curr);
       if (flawed.length) {
@@ -208,7 +227,7 @@ module.exports = {
     if (violationsFound) {
       const errorMessage = [
         'iamRoleStatements should be an array of objects,',
-        ' where each object has Effect, Action, Resource fields.',
+        ' where each object has Effect and exactly one of Action/NotAction, and exactly one of Resource/NotResource.',
         ` Specifically, ${violationsFound}`,
       ].join('');
       throw new this.serverless.classes.Error(errorMessage);

2025-11-13 21:40:17,171 - thread-135845298308800.prometheus.lang_graph.nodes.issue_feature_subgraph_node - INFO - Feature implementation completed

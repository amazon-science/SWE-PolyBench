2025-11-13 20:22:31,789 - thread-135845298308800.prometheus.docker.base_container - INFO - Created temporary project directory: /tmp/tmpq2xx0rnt/serverless
2025-11-13 20:22:31,789 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Using workdir: /testbed
2025-11-13 20:22:32,173 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_build: False
2025-11-13 20:22:32,173 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-13 20:22:32,173 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-13 20:22:32,173 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_reproduce_test: True
2025-11-13 20:22:32,173 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 5
2025-11-13 20:22:32,173 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - Enter IssueClassificationSubgraphNode
2025-11-13 20:22:32,174 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classification_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

2025-11-13 20:22:32,174 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 20:22:32,175 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:23:00,872 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The issue concerns SNS event redrivePolicy compilation and SQS QueuePolicy generation in the AWS provider. The provided tree lacks the actual implementation and tests for SNS event packaging, as well as the SNS events documentation. To accurately classify whether this is a bug or documentation issue, I need to inspect the code that builds the RedrivePolicy and QueuePolicy (to confirm ARN vs Ref handling) and compare it with the SNS event docs. These critical files are not included in the current context.' query='Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/sns/index.js, lib/plugins/aws/package/compile/events/sns/index.test.js, and docs/providers/aws/events/sns.md.' extra_requirements='If sns/index.js uses helper functions (e.g., from naming.js or validate.js) to construct the QueuePolicy or redrive policy, please include those specific helper function implementations with line numbers.' purpose='To verify how redrivePolicy and QueuePolicy are compiled (ARN vs Ref usage) and compare with documentation, enabling accurate classification of the issue as a bug or documentation update.'
2025-11-13 20:23:00,873 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/sns/index.js, lib/plugins/aws/package/compile/events/sns/index.test.js, and docs/providers/aws/events/sns.md.
2025-11-13 20:23:02,925 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 20:23:02,925 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 20:23:02,925 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 20:23:02,925 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 20:23:02,927 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 20:23:02,927 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 20:23:02,927 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/sns/index.js, lib/plugins/aws/package/compile/events/sns/index.test.js, and docs/providers/aws/events/sns.md.
Extra requirements: If sns/index.js uses helper functions (e.g., from naming.js or validate.js) to construct the QueuePolicy or redrive policy, please include those specific helper function implementations with line numbers.
Purpose: To verify how redrivePolicy and QueuePolicy are compiled (ARN vs Ref usage) and compare with documentation, enabling accurate classification of the issue as a bug or documentation update.
2025-11-13 20:23:08,071 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5DnXh1obMRN7gsSzg9rzlXnz', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 488, 'prompt_tokens': 2302, 'total_tokens': 2790, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--53042276-6550-407d-9721-fbe3d5a41ed8-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js'}, 'id': 'call_5DnXh1obMRN7gsSzg9rzlXnz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2302, 'output_tokens': 488, 'total_tokens': 2790, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:23:09,250 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_k3wbygquZoVbb92EMI9sRXoW', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 5186, 'total_tokens': 5221, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5bd83e49-ac85-44d9-9cfd-25c8982b4c08-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_k3wbygquZoVbb92EMI9sRXoW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5186, 'output_tokens': 35, 'total_tokens': 5221, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:23:10,569 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ut28rXWbXhUwEi3SfpfWXwjW', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/sns.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 10427, 'total_tokens': 10457, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5120}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a8a61b95-74db-4364-9d9c-e1ccfe03c8ce-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/events/sns.md'}, 'id': 'call_ut28rXWbXhUwEi3SfpfWXwjW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10427, 'output_tokens': 30, 'total_tokens': 10457, 'input_token_details': {'audio': 0, 'cache_read': 5120}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:23:19,034 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Bhuc7Fp2BEFxNgvgf76xcrOq', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/naming.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 802, 'prompt_tokens': 12121, 'total_tokens': 12923, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1e779d21-79d2-43b9-89e9-8a831a4d4da5-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/naming.js'}, 'id': 'call_Bhuc7Fp2BEFxNgvgf76xcrOq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12121, 'output_tokens': 802, 'total_tokens': 12923, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 20:23:33,498 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_oyZDgSYDREDatKqGWLlMXmd3', 'function': {'arguments': '{"basename":"naming.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1502, 'prompt_tokens': 12175, 'total_tokens': 13677, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--660040e9-9ee4-455a-b52a-bb6c99abd6b0-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'naming.js'}, 'id': 'call_oyZDgSYDREDatKqGWLlMXmd3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12175, 'output_tokens': 1502, 'total_tokens': 13677, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-13 20:23:35,291 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dt3HEXIv8YMc4bMz0DvU7jLy', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 12249, 'total_tokens': 12279, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12160}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4d7c7c25-0943-4bd1-8d60-eb58ab2d7c7f-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.js'}, 'id': 'call_dt3HEXIv8YMc4bMz0DvU7jLy', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12249, 'output_tokens': 30, 'total_tokens': 12279, 'input_token_details': {'audio': 0, 'cache_read': 12160}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:23:50,757 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_GTsBlHKWkBsAQGq6A1Rcb9uI', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js","start_line":501,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1714, 'prompt_tokens': 18025, 'total_tokens': 19739, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1664, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--26ca9a4a-3fe9-4c58-9e24-e07c98c24a83-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'start_line': 501, 'end_line': 2000}, 'id': 'call_GTsBlHKWkBsAQGq6A1Rcb9uI', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18025, 'output_tokens': 1714, 'total_tokens': 19739, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1664}}
2025-11-13 20:24:05,338 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I fetched the full, line-numbered contents of lib/plugins/aws/package/compile/events/sns/index.js, its test lib/plugins/aws/package/compile/events/sns/index.test.js (including the additional lines beyond the initial preview), and the documentation file docs/providers/aws/events/sns.md. I also located and included the relevant helper implementations from lib/plugins/aws/lib/naming.js, specifically getQueueLogicalId (and its dependency normalizeNameToAlphaNumericOnly), which are used in constructing the SQS QueuePolicy when a redrivePolicy is defined. From the code, redrivePolicy is passed through directly to the SNS Subscription Properties, and the QueuePolicy uses the deadLetterTargetArn and topicArn as ARNs rather than Refs. This should give you the exact implementation details and line references needed to compare behavior with the documentation.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1521, 'prompt_tokens': 19655, 'total_tokens': 21176, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1344, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--786e4c7e-6ce0-4138-8a12-4033c52bde4b-0' usage_metadata={'input_tokens': 19655, 'output_tokens': 1521, 'total_tokens': 21176, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1344}}
2025-11-13 20:24:05,342 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/sns/index.js, lib/plugins/aws/package/compile/events/sns/index.test.js, and docs/providers/aws/events/sns.md.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If sns/index.js uses helper functions (e.g., from naming.js or validate.js) to construct the QueuePolicy or redrive policy, please include those specific helper function implementations with line numbers.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
To verify how redrivePolicy and QueuePolicy are compiled (ARN vs Ref usage) and compare with documentation, enabling accurate classification of the issue as a bug or documentation update.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: docs/providers/aws/events/sns.md
Line number range: 1 - 170
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - SNS
3. menuText: SNS
4. menuOrder: 7
5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # SNS
16. 
17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.
18. 
19. ```yml
20. functions:
21.   dispatcher:
22.     handler: dispatcher.dispatch
23.     events:
24.       - sns: dispatch
25. ```
26. 
27. You're also able to add the same SNS topic to multiple functions:
28. 
29. ```yml
30. functions:
31.   dispatcher:
32.     handler: dispatcher.dispatch
33.     events:
34.       - sns: dispatch
35.   dispatcher2:
36.     handler: dispatcher2.dispatch
37.     events:
38.       - sns: dispatch
39. ```
40. 
41. This will run both functions for a message sent to the dispatch topic.
42. 
43. ## Using a pre-existing topic
44. 
45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.
46. 
47. ```yml
48. functions:
49.   dispatcher:
50.     handler: dispatcher.dispatch
51.     events:
52.       - sns: arn:xxx
53. ```
54. 
55. ```yml
56. functions:
57.   dispatcher:
58.     handler: dispatcher.dispatch
59.     events:
60.       - sns:
61.           arn: arn:xxx
62. ```
63. 
64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).
65. **Note:** The arn can be in a different region to enable cross region invocation
66. 
67. ```yml
68. functions:
69.   dispatcher:
70.     handler: dispatcher.dispatch
71.     events:
72.       - sns:
73.           arn:
74.             Fn::Join:
75.               - ':'
76.               - - 'arn:aws:sns'
77.                 - Ref: 'AWS::Region'
78.                 - Ref: 'AWS::AccountId'
79.                 - 'MyCustomTopic'
80.           topicName: MyCustomTopic
81. ```
82. 
83. If your SNS topic doesn't yet exist but is defined in the serverless.yml file you're editing, you'll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!
84. 
85. ```yml
86. functions:
87.   dispatcher:
88.     handler: dispatcher.dispatch
89.     events:
90.       - sns:
91.           arn: !Ref SuperTopic
92.           topicName: MyCustomTopic
93. 
94. resources:
95.   Resources:
96.     SuperTopic:
97.       Type: AWS::SNS::Topic
98.       Properties:
99.         TopicName: MyCustomTopic
100. ```
101. 
102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.
103. 
104. ```yml
105. functions:
106.   hello:
107.     handler: handler.run
108.     events:
109.       - sns:
110.           arn: arn:aws:sns:us-east-1:00000000000:topicname
111.           topicName: topicname-account-1-us-east-1
112.       - sns:
113.           arn: arn:aws:sns:us-east-1:11111111111:topicname
114.           topicName: topicname-account-2-us-east-1
115. ```
116. 
117. ## Setting a display name
118. 
119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the
120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the
121. SNS topic is used for.
122. 
123. ```yml
124. functions:
125.   aggregator:
126.     handler: aggregator.handler
127.     events:
128.       - sns:
129.           topicName: aggregate
130.           displayName: Data aggregation pipeline
131. ```
132. 
133. ## Setting a filter policy
134. 
135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don't have attribute key `pet` with value `dog` or `cat`.
136. 
137. ```yml
138. functions:
139.   pets:
140.     handler: pets.handler
141.     events:
142.       - sns:
143.           topicName: pets
144.           filterPolicy:
145.             pet:
146.               - dog
147.               - cat
148. ```
149. 
150. ## Setting a redrive policy
151. 
152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`
153. 
154. ```yml
155. functions:
156.   dispatcher:
157.     handler: dispatcher.handler
158.     events:
159.       - sns:
160.           topicName: dispatcher
161.           redrivePolicy:
162.             deadLetterTargetArn: !Ref myDLQ
163. 
164. resources:
165.   Resources:
166.     myDLQ:
167.       Type: AWS::SQS::Queue
168.       Properties:
169.         QueueName: myDLQ
170. ```


File: lib/plugins/aws/lib/naming.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const crypto = require('crypto');
5. 
6. /**
7.  * A centralized naming object that provides naming standards for the AWS provider plugin.  The
8.  * intent is for this to enable naming standards to be configured using a custom naming plugin or
9.  * a naming configuration feature, based on which of those is determined to in the best approach.
10.  *
11.  * There are two main concepts:
12.  * 1. normalization - normalization of a name comprises removing any unacceptable characters and
13.  * changing the name to comply with capitalization expectations.
14.  * 2. logicalization - logicalization of a name comprises preparing it for use as an attribute name
15.  * for a resource within the Service's CloudFormation Template.  Notably, a suffix or prefix should
16.  * be added to the name of resources.  These help to disambiguate attributes identifying or
17.  * declaring different aspects or data about the same resource.  (e.g. MyFuncLambdaFunction vs.
18.  * MyFuncLambdaFunctionArn)  Generally, normalization of the name also occurs.
19.  *
20.  * Sometimes, it is important to deconstruct the names that are created via this centralized
21.  * utility.  As a result, the regular expressions used for identifying specific resource types using
22.  * their names or the logic to extract a name components from a logical name are things that must
23.  * also be centralized so that they co-occur and are more correlated spatially within the code base.
24.  * That is to say that they are easier to change together.
25.  */
26. module.exports = {
27.   // General
28.   normalizeName(name) {
29.     return `${_.upperFirst(name)}`;
30.   },
31.   normalizeNameToAlphaNumericOnly(name) {
32.     return this.normalizeName(name.replace(/[^0-9A-Za-z]/g, ''));
33.   },
34.   normalizePathPart(path) {
35.     return _.upperFirst(
36.       _.capitalize(path)
37.         .replace(/-/g, 'Dash')
38.         .replace(/\{(.*)\}/g, '$1Var')
39.         .replace(/[^0-9A-Za-z]/g, '')
40.     );
41.   },
42. 
43.   getServiceEndpointRegex() {
44.     return /^(ServiceEndpoint|HttpApiUrl)/;
45.   },
46. 
47.   // Stack
48.   getStackName() {
49.     if (
50.       this.provider.serverless.service.provider.stackName &&
51.       _.isString(this.provider.serverless.service.provider.stackName)
52.     ) {
53.       return `${this.provider.serverless.service.provider.stackName}`;
54.     }
55.     return `${this.provider.serverless.service.service}-${this.provider.getStage()}`;
56.   },
57. 
58.   getServiceArtifactName() {
59.     return `${this.provider.serverless.service.service}.zip`;
60.   },
61. 
62.   getFunctionArtifactName(functionName) {
63.     return `${functionName}.zip`;
64.   },
65. 
66.   getLayerArtifactName(layerName) {
67.     return `${layerName}.zip`;
68.   },
69. 
70.   getServiceStateFileName() {
71.     return 'serverless-state.json';
72.   },
73. 
74.   getCompiledTemplateFileName() {
75.     return 'cloudformation-template-update-stack.json';
76.   },
77. 
78.   getCompiledTemplateS3Suffix() {
79.     return 'compiled-cloudformation-template.json';
80.   },
81. 
82.   getCoreTemplateFileName() {
83.     return 'cloudformation-template-create-stack.json';
84.   },
85. 
86.   // Role
87.   getRolePath() {
88.     return '/';
89.   },
90.   getRoleName() {
91.     return {
92.       'Fn::Join': [
93.         '-',
94.         [
95.           this.provider.serverless.service.service,
96.           this.provider.getStage(),
97.           { Ref: 'AWS::Region' },
98.           'lambdaRole',
99.         ],
100.       ],
101.     };
102.   },
103.   getRoleLogicalId() {
104.     return 'IamRoleLambdaExecution';
105.   },
106. 
107.   // Policy
108.   getPolicyName() {
109.     return {
110.       // TODO should probably have name ordered and altered as above - see AWS docs
111.       'Fn::Join': [
112.         '-',
113.         [
114.           this.provider.getStage(),
115.           // TODO is it a bug here in that the role is not specific to the region?
116.           this.provider.serverless.service.service,
117.           'lambda',
118.         ],
119.       ],
120.     };
121.   },
122. 
123.   // Log Group
124.   getLogGroupLogicalId(functionName) {
125.     return `${this.getNormalizedFunctionName(functionName)}LogGroup`;
126.   },
127.   getLogGroupName(functionName) {
128.     return `/aws/lambda/${functionName}`;
129.   },
130. 
131.   // Lambda
132.   getNormalizedFunctionName(functionName) {
133.     return this.normalizeName(functionName.replace(/-/g, 'Dash').replace(/_/g, 'Underscore'));
134.   },
135.   extractLambdaNameFromArn(functionArn) {
136.     return functionArn.substring(functionArn.lastIndexOf(':') + 1);
137.   },
138.   extractAuthorizerNameFromArn(functionArn) {
139.     const splitArn = functionArn.split(':');
140.     // TODO the following two lines assumes default function naming?  Is there a better way?
141.     // TODO (see ~/lib/classes/Service.js:~155)
142.     const splitName = splitArn[splitArn.length - 1].split('-');
143.     return splitName[splitName.length - 1];
144.   },
145.   getLambdaLogicalId(functionName) {
146.     return `${this.getNormalizedFunctionName(functionName)}LambdaFunction`;
147.   },
148.   getLambdaLayerLogicalId(layerName) {
149.     return `${this.getNormalizedFunctionName(layerName)}LambdaLayer`;
150.   },
151.   getLambdaLayerPermissionLogicalId(layerName, account) {
152.     return `${this.getNormalizedFunctionName(layerName)}${account.replace(
153.       '*',
154.       'Wild'
155.     )}LambdaLayerPermission`;
156.   },
157.   getLambdaLogicalIdRegex() {
158.     return /LambdaFunction$/;
159.   },
160.   getLambdaVersionLogicalId(functionName, sha) {
161.     return `${this.getNormalizedFunctionName(functionName)}LambdaVersion${sha.replace(
162.       /[^0-9a-z]/gi,
163.       ''
164.     )}`;
165.   },
166.   getCodeDeployApplicationLogicalId() {
167.     return 'CodeDeployApplication';
168.   },
169.   getCodeDeployDeploymentGroupLogicalId() {
170.     return 'CodeDeployDeploymentGroup';
171.   },
172.   getCodeDeployRoleLogicalId() {
173.     return 'CodeDeployRole';
174.   },
175.   getLambdaProvisionedConcurrencyAliasLogicalId(functionName) {
176.     return `${this.getNormalizedFunctionName(functionName)}ProvConcLambdaAlias`;
177.   },
178.   getLambdaProvisionedConcurrencyAliasName() {
179.     return 'provisioned';
180.   },
181.   getLambdaVersionOutputLogicalId(functionName) {
182.     return `${this.getLambdaLogicalId(functionName)}QualifiedArn`;
183.   },
184.   getLambdaLayerOutputLogicalId(layerName) {
185.     return `${this.getLambdaLayerLogicalId(layerName)}QualifiedArn`;
186.   },
187. 
188.   // Websockets API
189.   getWebsocketsApiName() {
190.     if (
191.       this.provider.serverless.service.provider.websocketsApiName &&
192.       _.isString(this.provider.serverless.service.provider.websocketsApiName)
193.     ) {
194.       return `${this.provider.serverless.service.provider.websocketsApiName}`;
195.     }
196.     return `${this.provider.getStage()}-${this.provider.serverless.service.service}-websockets`;
197.   },
198.   getWebsocketsApiLogicalId() {
199.     return 'WebsocketsApi';
200.   },
201.   getWebsocketsIntegrationLogicalId(functionName) {
202.     return `${this.getNormalizedFunctionName(functionName)}WebsocketsIntegration`;
203.   },
204. 
205.   getLambdaWebsocketsPermissionLogicalId(functionName) {
206.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionWebsockets`;
207.   },
208. 
209.   getNormalizedWebsocketsRouteKey(route) {
210.     return route
211.       .replace(/\$/g, 'S') // dollar sign
212.       .replace(/\//g, 'Slash')
213.       .replace(/-/g, 'Dash')
214.       .replace(/_/g, 'Underscore')
215.       .replace(/\./g, 'Period');
216.   },
217. 
218.   getWebsocketsRouteLogicalId(route) {
219.     return `${this.getNormalizedWebsocketsRouteKey(route)}WebsocketsRoute`;
220.   },
221. 
222.   getWebsocketsDeploymentLogicalId(sha) {
223.     return `WebsocketsDeployment${sha.replace(/[^0-9a-z]/gi, '')}`;
224.   },
225. 
226.   getWebsocketsStageLogicalId() {
227.     return 'WebsocketsDeploymentStage';
228.   },
229. 
230.   getWebsocketsAuthorizerLogicalId(functionName) {
231.     return `${this.getNormalizedAuthorizerName(functionName)}WebsocketsAuthorizer`;
232.   },
233.   getWebsocketsLogGroupLogicalId() {
234.     return 'WebsocketsLogGroup';
235.   },
236. 
237.   // API Gateway
238.   getApiGatewayName() {
239.     if (
240.       this.provider.serverless.service.provider.apiName &&
241.       _.isString(this.provider.serverless.service.provider.apiName)
242.     ) {
243.       return `${this.provider.serverless.service.provider.apiName}`;
244.     }
245.     return `${this.provider.getStage()}-${this.provider.serverless.service.service}`;
246.   },
247.   generateApiGatewayDeploymentLogicalId(id) {
248.     return `ApiGatewayDeployment${id}`;
249.   },
250.   getRestApiLogicalId() {
251.     return 'ApiGatewayRestApi';
252.   },
253.   getNormalizedAuthorizerName(functionName) {
254.     return this.getNormalizedFunctionName(functionName);
255.   },
256.   getAuthorizerLogicalId(functionName) {
257.     return `${this.getNormalizedAuthorizerName(functionName)}ApiGatewayAuthorizer`;
258.   },
259.   normalizePath(resourcePath) {
260.     return resourcePath
261.       .split('/')
262.       .map(this.normalizePathPart.bind(this))
263.       .join('');
264.   },
265.   getResourceLogicalId(resourcePath) {
266.     return `ApiGatewayResource${this.normalizePath(resourcePath)}`;
267.   },
268.   extractResourceId(resourceLogicalId) {
269.     return resourceLogicalId.match(/ApiGatewayResource(.*)/)[1];
270.   },
271.   normalizeMethodName(methodName) {
272.     return this.normalizeName(methodName.toLowerCase());
273.   },
274.   getMethodLogicalId(resourceId, methodName) {
275.     return `ApiGatewayMethod${resourceId}${this.normalizeMethodName(methodName)}`;
276.   },
277.   getValidatorLogicalId(resourceId, methodName) {
278.     return `${this.getMethodLogicalId(resourceId, methodName)}Validator`;
279.   },
280.   getModelLogicalId(resourceId, methodName, contentType) {
281.     return `${this.getMethodLogicalId(resourceId, methodName)}${_.startCase(contentType).replace(
282.       ' ',
283.       ''
284.     )}Model`;
285.   },
286.   getApiKeyLogicalId(apiKeyNumber, apiKeyName) {
287.     if (apiKeyName) {
288.       return `ApiGatewayApiKey${this.normalizeName(apiKeyName)}${apiKeyNumber}`;
289.     }
290.     return `ApiGatewayApiKey${apiKeyNumber}`;
291.   },
292.   getApiKeyLogicalIdRegex() {
293.     return /^ApiGatewayApiKey/;
294.   },
295.   getUsagePlanLogicalId(name) {
296.     if (name) {
297.       return `ApiGatewayUsagePlan${this.normalizeName(name)}`;
298.     }
299.     return 'ApiGatewayUsagePlan';
300.   },
301.   getUsagePlanKeyLogicalId(usagePlanKeyNumber, usagePlanKeyName) {
302.     if (usagePlanKeyName) {
303.       return `ApiGatewayUsagePlanKey${this.normalizeName(usagePlanKeyName)}${usagePlanKeyNumber}`;
304.     }
305.     return `ApiGatewayUsagePlanKey${usagePlanKeyNumber}`;
306.   },
307.   getStageLogicalId() {
308.     return 'ApiGatewayStage';
309.   },
310.   getApiGatewayLogGroupLogicalId() {
311.     return 'ApiGatewayLogGroup';
312.   },
313. 
314.   // S3
315.   getDeploymentBucketLogicalId() {
316.     return 'ServerlessDeploymentBucket';
317.   },
318.   getDeploymentBucketOutputLogicalId() {
319.     return 'ServerlessDeploymentBucketName';
320.   },
321.   getDeploymentBucketPolicyLogicalId() {
322.     return 'ServerlessDeploymentBucketPolicy';
323.   },
324.   normalizeBucketName(bucketName) {
325.     return this.normalizeNameToAlphaNumericOnly(bucketName);
326.   },
327.   getBucketLogicalId(bucketName) {
328.     return `S3Bucket${this.normalizeBucketName(bucketName)}`;
329.   },
330. 
331.   // SNS
332.   normalizeTopicName(topicName) {
333.     return this.normalizeNameToAlphaNumericOnly(topicName);
334.   },
335.   getTopicLogicalId(topicName) {
336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;
337.   },
338. 
339.   // Schedule
340.   getScheduleId(functionName) {
341.     return `${functionName}Schedule`;
342.   },
343.   getScheduleLogicalId(functionName, scheduleIndex) {
344.     return `${this.getNormalizedFunctionName(functionName)}EventsRuleSchedule${scheduleIndex}`;
345.   },
346. 
347.   // Stream
348.   getStreamLogicalId(functionName, streamType, streamName) {
349.     return `${this.getNormalizedFunctionName(functionName)}EventSourceMapping${this.normalizeName(
350.       streamType
351.     )}${this.normalizeNameToAlphaNumericOnly(streamName)}`;
352.   },
353.   getStreamConsumerName(functionName, streamName) {
354.     return `${functionName}${streamName}Consumer`;
355.   },
356.   getStreamConsumerLogicalId(streamConsumerName) {
357.     return `${this.getNormalizedFunctionName(streamConsumerName)}StreamConsumer`;
358.   },
359. 
360.   // IoT
361.   getIotLogicalId(functionName, iotIndex) {
362.     return `${this.getNormalizedFunctionName(functionName)}IotTopicRule${iotIndex}`;
363.   },
364.   getLambdaIotPermissionLogicalId(functionName, iotIndex) {
365.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionIotTopicRule${iotIndex}`;
366.   },
367. 
368.   // CloudWatch Event
369.   getCloudWatchEventId(functionName) {
370.     return `${functionName}CloudWatchEvent`;
371.   },
372.   getCloudWatchEventLogicalId(functionName, cloudWatchIndex) {
373.     return `${this.getNormalizedFunctionName(
374.       functionName
375.     )}EventsRuleCloudWatchEvent${cloudWatchIndex}`;
376.   },
377. 
378.   // CloudWatch Log
379.   getCloudWatchLogLogicalId(functionName, logsIndex) {
380.     return `${this.getNormalizedFunctionName(
381.       functionName
382.     )}LogsSubscriptionFilterCloudWatchLog${logsIndex}`;
383.   },
384. 
385.   // Cognito User Pool
386.   getCognitoUserPoolLogicalId(poolId) {
387.     return `CognitoUserPool${this.normalizeNameToAlphaNumericOnly(poolId)}`;
388.   },
389. 
390.   // SQS
391.   getQueueLogicalId(functionName, queueName) {
392.     return `${this.getNormalizedFunctionName(
393.       functionName
394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;
395.   },
396. 
397.   // ALB
398.   getAlbTargetGroupLogicalId(functionName, albId, multiValueHeaders) {
399.     return `${this.getNormalizedFunctionName(functionName)}Alb${
400.       multiValueHeaders ? 'MultiValue' : ''
401.     }TargetGroup${albId}`;
402.   },
403.   getAlbTargetGroupNameTagValue(functionName, albId, multiValueHeaders) {
404.     return `${this.provider.serverless.service.service}-${functionName}-${albId}-${
405.       multiValueHeaders ? 'multi-value-' : ''
406.     }${this.provider.getStage()}`;
407.   },
408.   getAlbTargetGroupName(functionName, albId, multiValueHeaders) {
409.     const hash = crypto
410.       .createHash('md5')
411.       .update(this.getAlbTargetGroupNameTagValue(functionName, albId, multiValueHeaders))
412.       .digest('hex');
413. 
414.     const albTargetGroupName = this.provider.getAlbTargetGroupPrefix() + hash;
415.     return albTargetGroupName.slice(0, 32);
416.   },
417.   getAlbListenerRuleLogicalId(functionName, idx) {
418.     return `${this.getNormalizedFunctionName(functionName)}AlbListenerRule${idx}`;
419.   },
420. 
421.   // Permissions
422.   getLambdaS3PermissionLogicalId(functionName, bucketName) {
423.     return `${this.getNormalizedFunctionName(
424.       functionName
425.     )}LambdaPermission${this.normalizeBucketName(bucketName)}S3`;
426.   },
427.   getLambdaSnsPermissionLogicalId(functionName, topicName) {
428.     return `${this.getNormalizedFunctionName(
429.       functionName
430.     )}LambdaPermission${this.normalizeTopicName(topicName)}SNS`;
431.   },
432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {
433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(
434.       topicName
435.     )}`;
436.   },
437.   getLambdaSchedulePermissionLogicalId(functionName, scheduleIndex) {
438.     return `${this.getNormalizedFunctionName(
439.       functionName
440.     )}LambdaPermissionEventsRuleSchedule${scheduleIndex}`;
441.   },
442.   getLambdaCloudWatchEventPermissionLogicalId(functionName, cloudWatchIndex) {
443.     return `${this.getNormalizedFunctionName(
444.       functionName
445.     )}LambdaPermissionEventsRuleCloudWatchEvent${cloudWatchIndex}`;
446.   },
447.   getLambdaApiGatewayPermissionLogicalId(functionName) {
448.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionApiGateway`;
449.   },
450.   getLambdaHttpApiPermissionLogicalId(functionName) {
451.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionHttpApi`;
452.   },
453.   getLambdaAlexaSkillPermissionLogicalId(functionName, alexaSkillIndex) {
454.     return `${this.getNormalizedFunctionName(
455.       functionName
456.     )}LambdaPermissionAlexaSkill${alexaSkillIndex || '0'}`;
457.   },
458.   getLambdaAlexaSmartHomePermissionLogicalId(functionName, alexaSmartHomeIndex) {
459.     return `${this.getNormalizedFunctionName(
460.       functionName
461.     )}LambdaPermissionAlexaSmartHome${alexaSmartHomeIndex}`;
462.   },
463.   getLambdaCloudWatchLogPermissionLogicalId(functionName) {
464.     return `${this.getNormalizedFunctionName(
465.       functionName
466.     )}LambdaPermissionLogsSubscriptionFilterCloudWatchLog`;
467.   },
468.   getLambdaCognitoUserPoolPermissionLogicalId(functionName, poolId, triggerSource) {
469.     return `${this.getNormalizedFunctionName(
470.       functionName
471.     )}LambdaPermissionCognitoUserPool${this.normalizeNameToAlphaNumericOnly(
472.       poolId
473.     )}TriggerSource${triggerSource}`;
474.   },
475.   getLambdaAlbPermissionLogicalId(functionName) {
476.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionAlb`;
477.   },
478.   getLambdaRegisterTargetPermissionLogicalId(functionName) {
479.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionRegisterTarget`;
480.   },
481. 
482.   // Custom Resources
483.   getCustomResourcesArtifactName() {
484.     return 'custom-resources.zip';
485.   },
486.   getCustomResourcesRoleLogicalId() {
487.     return 'IamRoleCustomResourcesLambdaExecution';
488.   },
489.   // S3
490.   getCustomResourceS3HandlerFunctionName() {
491.     return 'custom-resource-existing-s3';
492.   },
493.   getCustomResourceS3HandlerFunctionLogicalId() {
494.     return this.getLambdaLogicalId(
495.       `${this.getNormalizedFunctionName(this.getCustomResourceS3HandlerFunctionName())}`
496.     );
497.   },
498.   getCustomResourceS3ResourceLogicalId(functionName) {
499.     // NOTE: we have to keep the 1 at the end to ensure backwards compatibility
500.     // previously we've used an index to allow the creation of multiple custom S3 resources


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 1 - 267
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileSNSEvents {
6.   constructor(serverless, options) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9.     this.options = options;
10.     this.hooks = {
11.       'package:compileEvents': this.compileSNSEvents.bind(this),
12.     };
13.   }
14. 
15.   invalidPropertyErrorMessage(functionName, property) {
16.     return [
17.       `Missing or invalid ${property} property for sns event`,
18.       ` in function "${functionName}"`,
19.       ' The correct syntax is: sns: topic-name-or-arn',
20.       ' OR an object with ',
21.       ' arn and topicName OR',
22.       ' topicName and displayName.',
23.       ' Please check the docs for more info.',
24.     ].join('');
25.   }
26. 
27.   isValidStackImport(variable) {
28.     if (Object.keys(variable).length !== 1) {
29.       return false;
30.     }
31.     if (
32.       _.has(variable, 'Fn::ImportValue') &&
33.       (_.has(variable, 'Fn::ImportValue.Fn::GetAtt') || _.has(variable, 'Fn::ImportValue.Ref'))
34.     ) {
35.       return false;
36.     }
37.     const intrinsicFunctions = ['Fn::ImportValue', 'Ref', 'Fn::GetAtt', 'Fn::Sub', 'Fn::Join'];
38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));
39.   }
40. 
41.   compileSNSEvents() {
42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;
43. 
44.     this.serverless.service.getAllFunctions().forEach(functionName => {
45.       const functionObj = this.serverless.service.getFunction(functionName);
46. 
47.       if (functionObj.events) {
48.         functionObj.events.forEach(event => {
49.           if (event.sns) {
50.             let topicArn;
51.             let topicName;
52.             let region;
53.             let displayName = '';
54.             if (typeof event.sns === 'object') {
55.               if (event.sns.arn) {
56.                 topicArn = event.sns.arn;
57.                 if (typeof topicArn === 'object') {
58.                   if (!this.isValidStackImport(topicArn)) {
59.                     throw new this.serverless.classes.Error(
60.                       this.invalidPropertyErrorMessage(functionName, 'arn')
61.                     );
62.                   }
63.                 } else if (typeof topicArn === 'string') {
64.                   if (topicArn.indexOf('arn:') === 0) {
65.                     // NOTE: we need to process the topic ARN that way due to lacking
66.                     // support of regex lookbehind in Node.js 6.
67.                     // Once Node.js 6 support is dropped we can change this to:
68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`
69.                     const splitArn = topicArn
70.                       .replace(/::/g, '@@')
71.                       .split(':')
72.                       .map(s => s.replace(/@@/g, '::'));
73.                     topicName = splitArn[splitArn.length - 1];
74.                     if (splitArn[3] !== this.options.region) {
75.                       region = splitArn[3];
76.                     }
77.                   } else {
78.                     throw new this.serverless.classes.Error(
79.                       this.invalidPropertyErrorMessage(functionName, 'arn')
80.                     );
81.                   }
82.                 } else {
83.                   throw new this.serverless.classes.Error(
84.                     this.invalidPropertyErrorMessage(functionName, 'arn')
85.                   );
86.                 }
87.                 topicName = event.sns.topicName || topicName;
88.                 if (!topicName || typeof topicName !== 'string') {
89.                   throw new this.serverless.classes.Error(
90.                     this.invalidPropertyErrorMessage(functionName, 'topicName')
91.                   );
92.                 }
93.               } else {
94.                 ['topicName', 'displayName'].forEach(property => {
95.                   if (typeof event.sns[property] === 'string') {
96.                     return;
97.                   }
98.                   throw new this.serverless.classes.Error(
99.                     this.invalidPropertyErrorMessage(functionName, property)
100.                   );
101.                 });
102.                 displayName = event.sns.displayName;
103.                 topicName = event.sns.topicName;
104.               }
105.             } else if (typeof event.sns === 'string') {
106.               if (event.sns.indexOf('arn:') === 0) {
107.                 topicArn = event.sns;
108.                 const splitArn = topicArn.split(':');
109.                 topicName = splitArn[splitArn.length - 1];
110.               } else {
111.                 topicName = event.sns;
112.               }
113.             } else {
114.               const errorMessage = [
115.                 `SNS event of function ${functionName} is not an object nor a string`,
116.                 ' The correct syntax is: sns: topic-name-or-arn',
117.                 ' OR an object with ',
118.                 ' arn and topicName OR',
119.                 ' topicName and displayName.',
120.                 ' Please check the docs for more info.',
121.               ].join('');
122.               throw new this.serverless.classes.Error(errorMessage);
123.             }
124. 
125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
126. 
127.             const endpoint = {
128.               'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
129.             };
130. 
131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(
132.               functionName,
133.               topicName
134.             );
135. 
136.             if (topicArn) {
137.               _.merge(template.Resources, {
138.                 [subscriptionLogicalId]: {
139.                   Type: 'AWS::SNS::Subscription',
140.                   Properties: {
141.                     TopicArn: topicArn,
142.                     Protocol: 'lambda',
143.                     Endpoint: endpoint,
144.                     FilterPolicy: event.sns.filterPolicy,
145.                     RedrivePolicy: event.sns.redrivePolicy,
146.                     Region: region,
147.                   },
148.                 },
149.               });
150.             } else {
151.               topicArn = {
152.                 'Fn::Join': [
153.                   '',
154.                   [
155.                     'arn:',
156.                     { Ref: 'AWS::Partition' },
157.                     ':sns:',
158.                     { Ref: 'AWS::Region' },
159.                     ':',
160.                     { Ref: 'AWS::AccountId' },
161.                     ':',
162.                     topicName,
163.                   ],
164.                 ],
165.               };
166. 
167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);
168. 
169.               const subscription = {
170.                 Endpoint: endpoint,
171.                 Protocol: 'lambda',
172.               };
173. 
174.               if (!(topicLogicalId in template.Resources)) {
175.                 _.merge(template.Resources, {
176.                   [topicLogicalId]: {
177.                     Type: 'AWS::SNS::Topic',
178.                     Properties: {
179.                       TopicName: topicName,
180.                       DisplayName: displayName,
181.                     },
182.                   },
183.                 });
184.               }
185. 
186.               if (
187.                 event.sns.filterPolicy ||
188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)
189.               ) {
190.                 _.merge(template.Resources, {
191.                   [subscriptionLogicalId]: {
192.                     Type: 'AWS::SNS::Subscription',
193.                     Properties: _.merge(subscription, {
194.                       TopicArn: {
195.                         Ref: topicLogicalId,
196.                       },
197.                       FilterPolicy: event.sns.filterPolicy,
198.                       RedrivePolicy: event.sns.redrivePolicy,
199.                     }),
200.                   },
201.                 });
202.               } else {
203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {
204.                   template.Resources[topicLogicalId].Properties.Subscription = [];
205.                 }
206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);
207.               }
208.             }
209. 
210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(
211.               functionName,
212.               topicName
213.             );
214. 
215.             _.merge(template.Resources, {
216.               [lambdaPermissionLogicalId]: {
217.                 Type: 'AWS::Lambda::Permission',
218.                 Properties: {
219.                   FunctionName: endpoint,
220.                   Action: 'lambda:InvokeFunction',
221.                   Principal: 'sns.amazonaws.com',
222.                   SourceArn: topicArn,
223.                 },
224.               },
225.             });
226. 
227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
229.                 functionName,
230.                 `${topicName}DLQ`
231.               );
232.               Object.assign(template.Resources, {
233.                 [queuePolicyLogicalId]: {
234.                   Type: 'AWS::SQS::QueuePolicy',
235.                   Properties: {
236.                     PolicyDocument: {
237.                       Version: '2012-10-17',
238.                       Id: queuePolicyLogicalId,
239.                       Statement: [
240.                         {
241.                           Effect: 'Allow',
242.                           Principal: {
243.                             Service: 'sns.amazonaws.com',
244.                           },
245.                           Action: 'sqs:SendMessage',
246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,
247.                           Condition: {
248.                             ArnEquals: {
249.                               'aws:SourceArn': topicArn,
250.                             },
251.                           },
252.                         },
253.                       ],
254.                     },
255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
256.                   },
257.                 },
258.               });
259.             }
260.           }
261.         });
262.       }
263.     });
264.   }
265. }
266. 
267. module.exports = AwsCompileSNSEvents;


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileSNSEvents', () => {
9.   let serverless;
10.   let awsCompileSNSEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     const options = {
15.       region: 'some-region',
16.     };
17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
18.     serverless.setProvider('aws', new AwsProvider(serverless));
19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
20.   });
21. 
22.   describe('#constructor()', () => {
23.     it('should set the provider variable to an instance of AwsProvider', () =>
24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));
25.   });
26. 
27.   describe('#compileSNSEvents()', () => {
28.     it('should throw an error if SNS event type is not a string or an object', () => {
29.       awsCompileSNSEvents.serverless.service.functions = {
30.         first: {
31.           events: [
32.             {
33.               sns: 42,
34.             },
35.           ],
36.         },
37.       };
38. 
39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);
40.     });
41. 
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });
89. 
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });
150. 
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });
184. 
185.     it('should throw an error when the event an object and the displayName is not given', () => {
186.       awsCompileSNSEvents.serverless.service.functions = {
187.         first: {
188.           events: [
189.             {
190.               sns: {
191.                 displayName: 'Display name for topic 1',
192.               },
193.             },
194.           ],
195.         },
196.       };
197. 
198.       expect(() => {
199.         awsCompileSNSEvents.compileSNSEvents();
200.       }).to.throw(Error);
201.     });
202. 
203.     it('should not create corresponding resources when SNS events are not given', () => {
204.       awsCompileSNSEvents.serverless.service.functions = {
205.         first: {
206.           events: [],
207.         },
208.       };
209. 
210.       awsCompileSNSEvents.compileSNSEvents();
211. 
212.       expect(
213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.       ).to.deep.equal({});
215.     });
216. 
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });
248. 
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });
278. 
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });
311. 
312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {
313.       awsCompileSNSEvents.serverless.service.functions = {
314.         first: {
315.           events: [
316.             {
317.               sns: {
318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',
319.               },
320.             },
321.           ],
322.         },
323.       };
324. 
325.       awsCompileSNSEvents.compileSNSEvents();
326.       expect(
327.         Object.keys(
328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
329.         )
330.       ).to.have.length(2);
331.       expect(
332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
333.           .FirstSnsSubscriptionFoo.Type
334.       ).to.equal('AWS::SNS::Subscription');
335.       expect(
336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
337.           .FirstSnsSubscriptionFoo.Properties.Region
338.       ).to.equal('${AWS::Region}');
339.       expect(
340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
341.           .FirstLambdaPermissionFooSNS.Type
342.       ).to.equal('AWS::Lambda::Permission');
343.     });
344. 
345.     it('should throw an error when the arn an object and the value is not a string', () => {
346.       awsCompileSNSEvents.serverless.service.functions = {
347.         first: {
348.           events: [
349.             {
350.               sns: {
351.                 arn: 123,
352.               },
353.             },
354.           ],
355.         },
356.       };
357. 
358.       expect(() => {
359.         awsCompileSNSEvents.compileSNSEvents();
360.       }).to.throw(Error);
361.     });
362. 
363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {
364.       awsCompileSNSEvents.serverless.service.functions = {
365.         first: {
366.           events: [
367.             {
368.               sns: {
369.                 topicName: 'bar',
370.                 arn: 'arn:aws:sns:region:accountid:bar',
371.               },
372.             },
373.           ],
374.         },
375.       };
376. 
377.       awsCompileSNSEvents.compileSNSEvents();
378. 
379.       expect(
380.         Object.keys(
381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
382.         )
383.       ).to.have.length(2);
384.       expect(
385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
386.           .FirstSnsSubscriptionBar.Type
387.       ).to.equal('AWS::SNS::Subscription');
388.       expect(
389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
390.           .FirstLambdaPermissionBarSNS.Type
391.       ).to.equal('AWS::Lambda::Permission');
392.     });
393. 
394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {
395.       awsCompileSNSEvents.serverless.service.functions = {
396.         first: {
397.           events: [
398.             {
399.               sns: {
400.                 topicName: 'first',
401.                 arn: 'arn:aws:sns:region-1:accountid:bar',
402.               },
403.             },
404.             {
405.               sns: {
406.                 topicName: 'second',
407.                 arn: 'arn:aws:sns:region-2:accountid:bar',
408.               },
409.             },
410.           ],
411.         },
412.       };
413. 
414.       awsCompileSNSEvents.compileSNSEvents();
415. 
416.       expect(
417.         Object.keys(
418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
419.         )
420.       ).to.have.length(4);
421.       expect(
422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
423.           .FirstSnsSubscriptionFirst.Type
424.       ).to.equal('AWS::SNS::Subscription');
425.       expect(
426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
427.           .FirstSnsSubscriptionSecond.Type
428.       ).to.equal('AWS::SNS::Subscription');
429.     });
430. 
431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {
432.       awsCompileSNSEvents.serverless.service.functions = {
433.         first: {
434.           events: [
435.             {
436.               sns: {
437.                 topicName: 'foo',
438.                 arn: 'arn:aws:sns:region:accountid:bar',
439.               },
440.             },
441.           ],
442.         },
443.       };
444. 
445.       awsCompileSNSEvents.compileSNSEvents();
446. 
447.       expect(
448.         Object.keys(
449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
450.         )
451.       ).to.have.length(2);
452.       expect(
453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
454.           .FirstSnsSubscriptionFoo.Type
455.       ).to.equal('AWS::SNS::Subscription');
456.       expect(
457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
458.           .FirstLambdaPermissionFooSNS.Type
459.       ).to.equal('AWS::Lambda::Permission');
460.     });
461. 
462.     // eslint-disable-next-line max-len
463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {
464.       awsCompileSNSEvents.serverless.service.functions = {
465.         first: {
466.           events: [
467.             {
468.               sns: {
469.                 topicName: 'bar',
470.                 arn: {
471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
472.                 },
473.               },
474.             },
475.           ],
476.         },
477.       };
478. 
479.       awsCompileSNSEvents.compileSNSEvents();
480. 
481.       expect(
482.         Object.keys(
483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
484.         )
485.       ).to.have.length(2);
486.       expect(
487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
488.           .FirstSnsSubscriptionBar.Type
489.       ).to.equal('AWS::SNS::Subscription');
490.       expect(
491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
492.           .FirstLambdaPermissionBarSNS.Type
493.       ).to.equal('AWS::Lambda::Permission');
494.     });
495. 
496.     // eslint-disable-next-line max-len
497.     it('should throw an error when arn object and no topicName are given as object properties', () => {
498.       awsCompileSNSEvents.serverless.service.functions = {
499.         first: {
500.           events: [


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 501 - 2000
Content:
501.             {
502.               sns: {
503.                 arn: {
504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
505.                 },
506.               },
507.             },
508.           ],
509.         },
510.       };
511. 
512.       expect(() => {
513.         awsCompileSNSEvents.compileSNSEvents();
514.       }).to.throw(Error);
515.     });
516. 
517.     // eslint-disable-next-line max-len
518.     it('should throw an error when invalid imported arn object is given as object properties', () => {
519.       awsCompileSNSEvents.serverless.service.functions = {
520.         first: {
521.           events: [
522.             {
523.               sns: {
524.                 topicName: 'bar',
525.                 arn: {
526.                   'Fn::ImportValue': {
527.                     Ref: 'BarTopic',
528.                   },
529.                 },
530.               },
531.             },
532.           ],
533.         },
534.       };
535. 
536.       expect(() => {
537.         awsCompileSNSEvents.compileSNSEvents();
538.       }).to.throw(Error);
539. 
540.       awsCompileSNSEvents.serverless.service.functions = {
541.         first: {
542.           events: [
543.             {
544.               sns: {
545.                 topicName: 'bar',
546.                 arn: {
547.                   'Fn::ImportValue': {
548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],
549.                   },
550.                 },
551.               },
552.             },
553.           ],
554.         },
555.       };
556. 
557.       expect(() => {
558.         awsCompileSNSEvents.compileSNSEvents();
559.       }).to.throw(Error);
560.     });
561. 
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });
599. 
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });
654.   });
655. });

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 20:24:28,303 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='The full implementation of SNS event compilation is required to verify how redrivePolicy and QueuePolicy are compiled, including whether ARNs or Refs are used. It contains logic creating SNS::Subscription with RedrivePolicy and SQS::QueuePolicy tied to DLQ.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=1, end_line=267), ContextOutput(reasoning='Comprehensive tests validate expected behavior for redrivePolicy and QueuePolicy and demonstrate how logical IDs and properties are set (including Region handling and RedrivePolicy). Essential for comparison and verification.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=1, end_line=655), ContextOutput(reasoning='Documentation section for SNS, including the redrive policy example that shows Ref usage for DLQ ARN. Necessary to compare implementation vs. docs.', relative_path='docs/providers/aws/events/sns.md', start_line=1, end_line=170), ContextOutput(reasoning='Helper function used by sns/index.js to build the QueuePolicy logical id for DLQ policy. It directly affects QueuePolicy construction.', relative_path='lib/plugins/aws/lib/naming.js', start_line=391, end_line=395), ContextOutput(reasoning='Helper function used by sns/index.js to build the SNS Subscription logical id, which is the resource where RedrivePolicy is attached when topic is created by the framework.', relative_path='lib/plugins/aws/lib/naming.js', start_line=432, end_line=436), ContextOutput(reasoning='Helper used by sns/index.js to get the Topic logical id, enabling use of Ref in Subscription TopicArn when creating topics (important for checking ARN vs Ref usage).', relative_path='lib/plugins/aws/lib/naming.js', start_line=335, end_line=337)]
2025-11-13 20:24:28,308 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 6 contexts to memory for query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/sns/index.js, lib/plugins/aws/package/compile/events/sns/index.test.js, and docs/providers/aws/events/sns.md.
2025-11-13 20:24:30,914 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 20:24:30,915 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 6 new contexts to 0 existing contexts
2025-11-13 20:24:30,916 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 6 total contexts (removed 0 duplicates)
2025-11-13 20:24:30,917 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/sns/index.js, lib/plugins/aws/package/compile/events/sns/index.test.js, and docs/providers/aws/events/sns.md.
Extra Requirements: If sns/index.js uses helper functions (e.g., from naming.js or validate.js) to construct the QueuePolicy or redrive policy, please include those specific helper function implementations with line numbers.
Purpose: To verify how redrivePolicy and QueuePolicy are compiled (ARN vs Ref usage) and compare with documentation, enabling accurate classification of the issue as a bug or documentation update.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/sns.md
Line number range: 1 - 170
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - SNS
3. menuText: SNS
4. menuOrder: 7
5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # SNS
16. 
17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.
18. 
19. ```yml
20. functions:
21.   dispatcher:
22.     handler: dispatcher.dispatch
23.     events:
24.       - sns: dispatch
25. ```
26. 
27. You're also able to add the same SNS topic to multiple functions:
28. 
29. ```yml
30. functions:
31.   dispatcher:
32.     handler: dispatcher.dispatch
33.     events:
34.       - sns: dispatch
35.   dispatcher2:
36.     handler: dispatcher2.dispatch
37.     events:
38.       - sns: dispatch
39. ```
40. 
41. This will run both functions for a message sent to the dispatch topic.
42. 
43. ## Using a pre-existing topic
44. 
45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.
46. 
47. ```yml
48. functions:
49.   dispatcher:
50.     handler: dispatcher.dispatch
51.     events:
52.       - sns: arn:xxx
53. ```
54. 
55. ```yml
56. functions:
57.   dispatcher:
58.     handler: dispatcher.dispatch
59.     events:
60.       - sns:
61.           arn: arn:xxx
62. ```
63. 
64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).
65. **Note:** The arn can be in a different region to enable cross region invocation
66. 
67. ```yml
68. functions:
69.   dispatcher:
70.     handler: dispatcher.dispatch
71.     events:
72.       - sns:
73.           arn:
74.             Fn::Join:
75.               - ':'
76.               - - 'arn:aws:sns'
77.                 - Ref: 'AWS::Region'
78.                 - Ref: 'AWS::AccountId'
79.                 - 'MyCustomTopic'
80.           topicName: MyCustomTopic
81. ```
82. 
83. If your SNS topic doesn't yet exist but is defined in the serverless.yml file you're editing, you'll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!
84. 
85. ```yml
86. functions:
87.   dispatcher:
88.     handler: dispatcher.dispatch
89.     events:
90.       - sns:
91.           arn: !Ref SuperTopic
92.           topicName: MyCustomTopic
93. 
94. resources:
95.   Resources:
96.     SuperTopic:
97.       Type: AWS::SNS::Topic
98.       Properties:
99.         TopicName: MyCustomTopic
100. ```
101. 
102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.
103. 
104. ```yml
105. functions:
106.   hello:
107.     handler: handler.run
108.     events:
109.       - sns:
110.           arn: arn:aws:sns:us-east-1:00000000000:topicname
111.           topicName: topicname-account-1-us-east-1
112.       - sns:
113.           arn: arn:aws:sns:us-east-1:11111111111:topicname
114.           topicName: topicname-account-2-us-east-1
115. ```
116. 
117. ## Setting a display name
118. 
119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the
120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the
121. SNS topic is used for.
122. 
123. ```yml
124. functions:
125.   aggregator:
126.     handler: aggregator.handler
127.     events:
128.       - sns:
129.           topicName: aggregate
130.           displayName: Data aggregation pipeline
131. ```
132. 
133. ## Setting a filter policy
134. 
135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don't have attribute key `pet` with value `dog` or `cat`.
136. 
137. ```yml
138. functions:
139.   pets:
140.     handler: pets.handler
141.     events:
142.       - sns:
143.           topicName: pets
144.           filterPolicy:
145.             pet:
146.               - dog
147.               - cat
148. ```
149. 
150. ## Setting a redrive policy
151. 
152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`
153. 
154. ```yml
155. functions:
156.   dispatcher:
157.     handler: dispatcher.handler
158.     events:
159.       - sns:
160.           topicName: dispatcher
161.           redrivePolicy:
162.             deadLetterTargetArn: !Ref myDLQ
163. 
164. resources:
165.   Resources:
166.     myDLQ:
167.       Type: AWS::SQS::Queue
168.       Properties:
169.         QueueName: myDLQ
170. ```


File: lib/plugins/aws/lib/naming.js
Line number range: 335 - 337
Content:
335.   getTopicLogicalId(topicName) {
336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;
337.   },


File: lib/plugins/aws/lib/naming.js
Line number range: 391 - 395
Content:
391.   getQueueLogicalId(functionName, queueName) {
392.     return `${this.getNormalizedFunctionName(
393.       functionName
394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;
395.   },


File: lib/plugins/aws/lib/naming.js
Line number range: 432 - 436
Content:
432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {
433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(
434.       topicName
435.     )}`;
436.   },


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 1 - 267
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileSNSEvents {
6.   constructor(serverless, options) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9.     this.options = options;
10.     this.hooks = {
11.       'package:compileEvents': this.compileSNSEvents.bind(this),
12.     };
13.   }
14. 
15.   invalidPropertyErrorMessage(functionName, property) {
16.     return [
17.       `Missing or invalid ${property} property for sns event`,
18.       ` in function "${functionName}"`,
19.       ' The correct syntax is: sns: topic-name-or-arn',
20.       ' OR an object with ',
21.       ' arn and topicName OR',
22.       ' topicName and displayName.',
23.       ' Please check the docs for more info.',
24.     ].join('');
25.   }
26. 
27.   isValidStackImport(variable) {
28.     if (Object.keys(variable).length !== 1) {
29.       return false;
30.     }
31.     if (
32.       _.has(variable, 'Fn::ImportValue') &&
33.       (_.has(variable, 'Fn::ImportValue.Fn::GetAtt') || _.has(variable, 'Fn::ImportValue.Ref'))
34.     ) {
35.       return false;
36.     }
37.     const intrinsicFunctions = ['Fn::ImportValue', 'Ref', 'Fn::GetAtt', 'Fn::Sub', 'Fn::Join'];
38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));
39.   }
40. 
41.   compileSNSEvents() {
42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;
43. 
44.     this.serverless.service.getAllFunctions().forEach(functionName => {
45.       const functionObj = this.serverless.service.getFunction(functionName);
46. 
47.       if (functionObj.events) {
48.         functionObj.events.forEach(event => {
49.           if (event.sns) {
50.             let topicArn;
51.             let topicName;
52.             let region;
53.             let displayName = '';
54.             if (typeof event.sns === 'object') {
55.               if (event.sns.arn) {
56.                 topicArn = event.sns.arn;
57.                 if (typeof topicArn === 'object') {
58.                   if (!this.isValidStackImport(topicArn)) {
59.                     throw new this.serverless.classes.Error(
60.                       this.invalidPropertyErrorMessage(functionName, 'arn')
61.                     );
62.                   }
63.                 } else if (typeof topicArn === 'string') {
64.                   if (topicArn.indexOf('arn:') === 0) {
65.                     // NOTE: we need to process the topic ARN that way due to lacking
66.                     // support of regex lookbehind in Node.js 6.
67.                     // Once Node.js 6 support is dropped we can change this to:
68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`
69.                     const splitArn = topicArn
70.                       .replace(/::/g, '@@')
71.                       .split(':')
72.                       .map(s => s.replace(/@@/g, '::'));
73.                     topicName = splitArn[splitArn.length - 1];
74.                     if (splitArn[3] !== this.options.region) {
75.                       region = splitArn[3];
76.                     }
77.                   } else {
78.                     throw new this.serverless.classes.Error(
79.                       this.invalidPropertyErrorMessage(functionName, 'arn')
80.                     );
81.                   }
82.                 } else {
83.                   throw new this.serverless.classes.Error(
84.                     this.invalidPropertyErrorMessage(functionName, 'arn')
85.                   );
86.                 }
87.                 topicName = event.sns.topicName || topicName;
88.                 if (!topicName || typeof topicName !== 'string') {
89.                   throw new this.serverless.classes.Error(
90.                     this.invalidPropertyErrorMessage(functionName, 'topicName')
91.                   );
92.                 }
93.               } else {
94.                 ['topicName', 'displayName'].forEach(property => {
95.                   if (typeof event.sns[property] === 'string') {
96.                     return;
97.                   }
98.                   throw new this.serverless.classes.Error(
99.                     this.invalidPropertyErrorMessage(functionName, property)
100.                   );
101.                 });
102.                 displayName = event.sns.displayName;
103.                 topicName = event.sns.topicName;
104.               }
105.             } else if (typeof event.sns === 'string') {
106.               if (event.sns.indexOf('arn:') === 0) {
107.                 topicArn = event.sns;
108.                 const splitArn = topicArn.split(':');
109.                 topicName = splitArn[splitArn.length - 1];
110.               } else {
111.                 topicName = event.sns;
112.               }
113.             } else {
114.               const errorMessage = [
115.                 `SNS event of function ${functionName} is not an object nor a string`,
116.                 ' The correct syntax is: sns: topic-name-or-arn',
117.                 ' OR an object with ',
118.                 ' arn and topicName OR',
119.                 ' topicName and displayName.',
120.                 ' Please check the docs for more info.',
121.               ].join('');
122.               throw new this.serverless.classes.Error(errorMessage);
123.             }
124. 
125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
126. 
127.             const endpoint = {
128.               'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
129.             };
130. 
131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(
132.               functionName,
133.               topicName
134.             );
135. 
136.             if (topicArn) {
137.               _.merge(template.Resources, {
138.                 [subscriptionLogicalId]: {
139.                   Type: 'AWS::SNS::Subscription',
140.                   Properties: {
141.                     TopicArn: topicArn,
142.                     Protocol: 'lambda',
143.                     Endpoint: endpoint,
144.                     FilterPolicy: event.sns.filterPolicy,
145.                     RedrivePolicy: event.sns.redrivePolicy,
146.                     Region: region,
147.                   },
148.                 },
149.               });
150.             } else {
151.               topicArn = {
152.                 'Fn::Join': [
153.                   '',
154.                   [
155.                     'arn:',
156.                     { Ref: 'AWS::Partition' },
157.                     ':sns:',
158.                     { Ref: 'AWS::Region' },
159.                     ':',
160.                     { Ref: 'AWS::AccountId' },
161.                     ':',
162.                     topicName,
163.                   ],
164.                 ],
165.               };
166. 
167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);
168. 
169.               const subscription = {
170.                 Endpoint: endpoint,
171.                 Protocol: 'lambda',
172.               };
173. 
174.               if (!(topicLogicalId in template.Resources)) {
175.                 _.merge(template.Resources, {
176.                   [topicLogicalId]: {
177.                     Type: 'AWS::SNS::Topic',
178.                     Properties: {
179.                       TopicName: topicName,
180.                       DisplayName: displayName,
181.                     },
182.                   },
183.                 });
184.               }
185. 
186.               if (
187.                 event.sns.filterPolicy ||
188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)
189.               ) {
190.                 _.merge(template.Resources, {
191.                   [subscriptionLogicalId]: {
192.                     Type: 'AWS::SNS::Subscription',
193.                     Properties: _.merge(subscription, {
194.                       TopicArn: {
195.                         Ref: topicLogicalId,
196.                       },
197.                       FilterPolicy: event.sns.filterPolicy,
198.                       RedrivePolicy: event.sns.redrivePolicy,
199.                     }),
200.                   },
201.                 });
202.               } else {
203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {
204.                   template.Resources[topicLogicalId].Properties.Subscription = [];
205.                 }
206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);
207.               }
208.             }
209. 
210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(
211.               functionName,
212.               topicName
213.             );
214. 
215.             _.merge(template.Resources, {
216.               [lambdaPermissionLogicalId]: {
217.                 Type: 'AWS::Lambda::Permission',
218.                 Properties: {
219.                   FunctionName: endpoint,
220.                   Action: 'lambda:InvokeFunction',
221.                   Principal: 'sns.amazonaws.com',
222.                   SourceArn: topicArn,
223.                 },
224.               },
225.             });
226. 
227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
229.                 functionName,
230.                 `${topicName}DLQ`
231.               );
232.               Object.assign(template.Resources, {
233.                 [queuePolicyLogicalId]: {
234.                   Type: 'AWS::SQS::QueuePolicy',
235.                   Properties: {
236.                     PolicyDocument: {
237.                       Version: '2012-10-17',
238.                       Id: queuePolicyLogicalId,
239.                       Statement: [
240.                         {
241.                           Effect: 'Allow',
242.                           Principal: {
243.                             Service: 'sns.amazonaws.com',
244.                           },
245.                           Action: 'sqs:SendMessage',
246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,
247.                           Condition: {
248.                             ArnEquals: {
249.                               'aws:SourceArn': topicArn,
250.                             },
251.                           },
252.                         },
253.                       ],
254.                     },
255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
256.                   },
257.                 },
258.               });
259.             }
260.           }
261.         });
262.       }
263.     });
264.   }
265. }
266. 
267. module.exports = AwsCompileSNSEvents;


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 655
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileSNSEvents', () => {
9.   let serverless;
10.   let awsCompileSNSEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     const options = {
15.       region: 'some-region',
16.     };
17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
18.     serverless.setProvider('aws', new AwsProvider(serverless));
19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
20.   });
21. 
22.   describe('#constructor()', () => {
23.     it('should set the provider variable to an instance of AwsProvider', () =>
24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));
25.   });
26. 
27.   describe('#compileSNSEvents()', () => {
28.     it('should throw an error if SNS event type is not a string or an object', () => {
29.       awsCompileSNSEvents.serverless.service.functions = {
30.         first: {
31.           events: [
32.             {
33.               sns: 42,
34.             },
35.           ],
36.         },
37.       };
38. 
39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);
40.     });
41. 
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });
89. 
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });
150. 
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });
184. 
185.     it('should throw an error when the event an object and the displayName is not given', () => {
186.       awsCompileSNSEvents.serverless.service.functions = {
187.         first: {
188.           events: [
189.             {
190.               sns: {
191.                 displayName: 'Display name for topic 1',
192.               },
193.             },
194.           ],
195.         },
196.       };
197. 
198.       expect(() => {
199.         awsCompileSNSEvents.compileSNSEvents();
200.       }).to.throw(Error);
201.     });
202. 
203.     it('should not create corresponding resources when SNS events are not given', () => {
204.       awsCompileSNSEvents.serverless.service.functions = {
205.         first: {
206.           events: [],
207.         },
208.       };
209. 
210.       awsCompileSNSEvents.compileSNSEvents();
211. 
212.       expect(
213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.       ).to.deep.equal({});
215.     });
216. 
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });
248. 
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });
278. 
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });
311. 
312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {
313.       awsCompileSNSEvents.serverless.service.functions = {
314.         first: {
315.           events: [
316.             {
317.               sns: {
318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',
319.               },
320.             },
321.           ],
322.         },
323.       };
324. 
325.       awsCompileSNSEvents.compileSNSEvents();
326.       expect(
327.         Object.keys(
328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
329.         )
330.       ).to.have.length(2);
331.       expect(
332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
333.           .FirstSnsSubscriptionFoo.Type
334.       ).to.equal('AWS::SNS::Subscription');
335.       expect(
336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
337.           .FirstSnsSubscriptionFoo.Properties.Region
338.       ).to.equal('${AWS::Region}');
339.       expect(
340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
341.           .FirstLambdaPermissionFooSNS.Type
342.       ).to.equal('AWS::Lambda::Permission');
343.     });
344. 
345.     it('should throw an error when the arn an object and the value is not a string', () => {
346.       awsCompileSNSEvents.serverless.service.functions = {
347.         first: {
348.           events: [
349.             {
350.               sns: {
351.                 arn: 123,
352.               },
353.             },
354.           ],
355.         },
356.       };
357. 
358.       expect(() => {
359.         awsCompileSNSEvents.compileSNSEvents();
360.       }).to.throw(Error);
361.     });
362. 
363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {
364.       awsCompileSNSEvents.serverless.service.functions = {
365.         first: {
366.           events: [
367.             {
368.               sns: {
369.                 topicName: 'bar',
370.                 arn: 'arn:aws:sns:region:accountid:bar',
371.               },
372.             },
373.           ],
374.         },
375.       };
376. 
377.       awsCompileSNSEvents.compileSNSEvents();
378. 
379.       expect(
380.         Object.keys(
381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
382.         )
383.       ).to.have.length(2);
384.       expect(
385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
386.           .FirstSnsSubscriptionBar.Type
387.       ).to.equal('AWS::SNS::Subscription');
388.       expect(
389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
390.           .FirstLambdaPermissionBarSNS.Type
391.       ).to.equal('AWS::Lambda::Permission');
392.     });
393. 
394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {
395.       awsCompileSNSEvents.serverless.service.functions = {
396.         first: {
397.           events: [
398.             {
399.               sns: {
400.                 topicName: 'first',
401.                 arn: 'arn:aws:sns:region-1:accountid:bar',
402.               },
403.             },
404.             {
405.               sns: {
406.                 topicName: 'second',
407.                 arn: 'arn:aws:sns:region-2:accountid:bar',
408.               },
409.             },
410.           ],
411.         },
412.       };
413. 
414.       awsCompileSNSEvents.compileSNSEvents();
415. 
416.       expect(
417.         Object.keys(
418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
419.         )
420.       ).to.have.length(4);
421.       expect(
422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
423.           .FirstSnsSubscriptionFirst.Type
424.       ).to.equal('AWS::SNS::Subscription');
425.       expect(
426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
427.           .FirstSnsSubscriptionSecond.Type
428.       ).to.equal('AWS::SNS::Subscription');
429.     });
430. 
431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {
432.       awsCompileSNSEvents.serverless.service.functions = {
433.         first: {
434.           events: [
435.             {
436.               sns: {
437.                 topicName: 'foo',
438.                 arn: 'arn:aws:sns:region:accountid:bar',
439.               },
440.             },
441.           ],
442.         },
443.       };
444. 
445.       awsCompileSNSEvents.compileSNSEvents();
446. 
447.       expect(
448.         Object.keys(
449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
450.         )
451.       ).to.have.length(2);
452.       expect(
453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
454.           .FirstSnsSubscriptionFoo.Type
455.       ).to.equal('AWS::SNS::Subscription');
456.       expect(
457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
458.           .FirstLambdaPermissionFooSNS.Type
459.       ).to.equal('AWS::Lambda::Permission');
460.     });
461. 
462.     // eslint-disable-next-line max-len
463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {
464.       awsCompileSNSEvents.serverless.service.functions = {
465.         first: {
466.           events: [
467.             {
468.               sns: {
469.                 topicName: 'bar',
470.                 arn: {
471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
472.                 },
473.               },
474.             },
475.           ],
476.         },
477.       };
478. 
479.       awsCompileSNSEvents.compileSNSEvents();
480. 
481.       expect(
482.         Object.keys(
483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
484.         )
485.       ).to.have.length(2);
486.       expect(
487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
488.           .FirstSnsSubscriptionBar.Type
489.       ).to.equal('AWS::SNS::Subscription');
490.       expect(
491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
492.           .FirstLambdaPermissionBarSNS.Type
493.       ).to.equal('AWS::Lambda::Permission');
494.     });
495. 
496.     // eslint-disable-next-line max-len
497.     it('should throw an error when arn object and no topicName are given as object properties', () => {
498.       awsCompileSNSEvents.serverless.service.functions = {
499.         first: {
500.           events: [
501.             {
502.               sns: {
503.                 arn: {
504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
505.                 },
506.               },
507.             },
508.           ],
509.         },
510.       };
511. 
512.       expect(() => {
513.         awsCompileSNSEvents.compileSNSEvents();
514.       }).to.throw(Error);
515.     });
516. 
517.     // eslint-disable-next-line max-len
518.     it('should throw an error when invalid imported arn object is given as object properties', () => {
519.       awsCompileSNSEvents.serverless.service.functions = {
520.         first: {
521.           events: [
522.             {
523.               sns: {
524.                 topicName: 'bar',
525.                 arn: {
526.                   'Fn::ImportValue': {
527.                     Ref: 'BarTopic',
528.                   },
529.                 },
530.               },
531.             },
532.           ],
533.         },
534.       };
535. 
536.       expect(() => {
537.         awsCompileSNSEvents.compileSNSEvents();
538.       }).to.throw(Error);
539. 
540.       awsCompileSNSEvents.serverless.service.functions = {
541.         first: {
542.           events: [
543.             {
544.               sns: {
545.                 topicName: 'bar',
546.                 arn: {
547.                   'Fn::ImportValue': {
548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],
549.                   },
550.                 },
551.               },
552.             },
553.           ],
554.         },
555.       };
556. 
557.       expect(() => {
558.         awsCompileSNSEvents.compileSNSEvents();
559.       }).to.throw(Error);
560.     });
561. 
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });
599. 
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });
654.   });
655. });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:24:47,571 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The aggregated context includes the full implementation of SNS event compilation (lib/plugins/aws/package/compile/events/sns/index.js), its corresponding tests, and the relevant documentation page (docs/providers/aws/events/sns.md). These reveal how redrivePolicy and QueuePolicy are currently handled (using deadLetterTargetArn for both Resource and Queues) and the docs example that incorrectly uses !Ref for an ARN. No additional helper implementations or broader system architecture are needed to classify the issue. Therefore, the current context is sufficient.' query='' extra_requirements='' purpose=''
2025-11-13 20:24:47,574 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/events/sns.md', content="1. <!--\n2. title: Serverless Framework - AWS Lambda Events - SNS\n3. menuText: SNS\n4. menuOrder: 7\n5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. \n11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)\n12. \n13. <!-- DOCS-SITE-LINK:END -->\n14. \n15. # SNS\n16. \n17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.\n18. \n19. ```yml\n20. functions:\n21.   dispatcher:\n22.     handler: dispatcher.dispatch\n23.     events:\n24.       - sns: dispatch\n25. ```\n26. \n27. You're also able to add the same SNS topic to multiple functions:\n28. \n29. ```yml\n30. functions:\n31.   dispatcher:\n32.     handler: dispatcher.dispatch\n33.     events:\n34.       - sns: dispatch\n35.   dispatcher2:\n36.     handler: dispatcher2.dispatch\n37.     events:\n38.       - sns: dispatch\n39. ```\n40. \n41. This will run both functions for a message sent to the dispatch topic.\n42. \n43. ## Using a pre-existing topic\n44. \n45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.\n46. \n47. ```yml\n48. functions:\n49.   dispatcher:\n50.     handler: dispatcher.dispatch\n51.     events:\n52.       - sns: arn:xxx\n53. ```\n54. \n55. ```yml\n56. functions:\n57.   dispatcher:\n58.     handler: dispatcher.dispatch\n59.     events:\n60.       - sns:\n61.           arn: arn:xxx\n62. ```\n63. \n64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).\n65. **Note:** The arn can be in a different region to enable cross region invocation\n66. \n67. ```yml\n68. functions:\n69.   dispatcher:\n70.     handler: dispatcher.dispatch\n71.     events:\n72.       - sns:\n73.           arn:\n74.             Fn::Join:\n75.               - ':'\n76.               - - 'arn:aws:sns'\n77.                 - Ref: 'AWS::Region'\n78.                 - Ref: 'AWS::AccountId'\n79.                 - 'MyCustomTopic'\n80.           topicName: MyCustomTopic\n81. ```\n82. \n83. If your SNS topic doesn't yet exist but is defined in the serverless.yml file you're editing, you'll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!\n84. \n85. ```yml\n86. functions:\n87.   dispatcher:\n88.     handler: dispatcher.dispatch\n89.     events:\n90.       - sns:\n91.           arn: !Ref SuperTopic\n92.           topicName: MyCustomTopic\n93. \n94. resources:\n95.   Resources:\n96.     SuperTopic:\n97.       Type: AWS::SNS::Topic\n98.       Properties:\n99.         TopicName: MyCustomTopic\n100. ```\n101. \n102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.\n103. \n104. ```yml\n105. functions:\n106.   hello:\n107.     handler: handler.run\n108.     events:\n109.       - sns:\n110.           arn: arn:aws:sns:us-east-1:00000000000:topicname\n111.           topicName: topicname-account-1-us-east-1\n112.       - sns:\n113.           arn: arn:aws:sns:us-east-1:11111111111:topicname\n114.           topicName: topicname-account-2-us-east-1\n115. ```\n116. \n117. ## Setting a display name\n118. \n119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the\n120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the\n121. SNS topic is used for.\n122. \n123. ```yml\n124. functions:\n125.   aggregator:\n126.     handler: aggregator.handler\n127.     events:\n128.       - sns:\n129.           topicName: aggregate\n130.           displayName: Data aggregation pipeline\n131. ```\n132. \n133. ## Setting a filter policy\n134. \n135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don't have attribute key `pet` with value `dog` or `cat`.\n136. \n137. ```yml\n138. functions:\n139.   pets:\n140.     handler: pets.handler\n141.     events:\n142.       - sns:\n143.           topicName: pets\n144.           filterPolicy:\n145.             pet:\n146.               - dog\n147.               - cat\n148. ```\n149. \n150. ## Setting a redrive policy\n151. \n152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\n153. \n154. ```yml\n155. functions:\n156.   dispatcher:\n157.     handler: dispatcher.handler\n158.     events:\n159.       - sns:\n160.           topicName: dispatcher\n161.           redrivePolicy:\n162.             deadLetterTargetArn: !Ref myDLQ\n163. \n164. resources:\n165.   Resources:\n166.     myDLQ:\n167.       Type: AWS::SQS::Queue\n168.       Properties:\n169.         QueueName: myDLQ\n170. ```", start_line_number=1, end_line_number=170), Context(relative_path='lib/plugins/aws/lib/naming.js', content='335.   getTopicLogicalId(topicName) {\n336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;\n337.   },', start_line_number=335, end_line_number=337), Context(relative_path='lib/plugins/aws/lib/naming.js', content='391.   getQueueLogicalId(functionName, queueName) {\n392.     return `${this.getNormalizedFunctionName(\n393.       functionName\n394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;\n395.   },', start_line_number=391, end_line_number=395), Context(relative_path='lib/plugins/aws/lib/naming.js', content='432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {\n433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(\n434.       topicName\n435.     )}`;\n436.   },', start_line_number=432, end_line_number=436), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.js', content='1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileSNSEvents {\n6.   constructor(serverless, options) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9.     this.options = options;\n10.     this.hooks = {\n11.       \'package:compileEvents\': this.compileSNSEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   invalidPropertyErrorMessage(functionName, property) {\n16.     return [\n17.       `Missing or invalid ${property} property for sns event`,\n18.       ` in function "${functionName}"`,\n19.       \' The correct syntax is: sns: topic-name-or-arn\',\n20.       \' OR an object with \',\n21.       \' arn and topicName OR\',\n22.       \' topicName and displayName.\',\n23.       \' Please check the docs for more info.\',\n24.     ].join(\'\');\n25.   }\n26. \n27.   isValidStackImport(variable) {\n28.     if (Object.keys(variable).length !== 1) {\n29.       return false;\n30.     }\n31.     if (\n32.       _.has(variable, \'Fn::ImportValue\') &&\n33.       (_.has(variable, \'Fn::ImportValue.Fn::GetAtt\') || _.has(variable, \'Fn::ImportValue.Ref\'))\n34.     ) {\n35.       return false;\n36.     }\n37.     const intrinsicFunctions = [\'Fn::ImportValue\', \'Ref\', \'Fn::GetAtt\', \'Fn::Sub\', \'Fn::Join\'];\n38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));\n39.   }\n40. \n41.   compileSNSEvents() {\n42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;\n43. \n44.     this.serverless.service.getAllFunctions().forEach(functionName => {\n45.       const functionObj = this.serverless.service.getFunction(functionName);\n46. \n47.       if (functionObj.events) {\n48.         functionObj.events.forEach(event => {\n49.           if (event.sns) {\n50.             let topicArn;\n51.             let topicName;\n52.             let region;\n53.             let displayName = \'\';\n54.             if (typeof event.sns === \'object\') {\n55.               if (event.sns.arn) {\n56.                 topicArn = event.sns.arn;\n57.                 if (typeof topicArn === \'object\') {\n58.                   if (!this.isValidStackImport(topicArn)) {\n59.                     throw new this.serverless.classes.Error(\n60.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n61.                     );\n62.                   }\n63.                 } else if (typeof topicArn === \'string\') {\n64.                   if (topicArn.indexOf(\'arn:\') === 0) {\n65.                     // NOTE: we need to process the topic ARN that way due to lacking\n66.                     // support of regex lookbehind in Node.js 6.\n67.                     // Once Node.js 6 support is dropped we can change this to:\n68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`\n69.                     const splitArn = topicArn\n70.                       .replace(/::/g, \'@@\')\n71.                       .split(\':\')\n72.                       .map(s => s.replace(/@@/g, \'::\'));\n73.                     topicName = splitArn[splitArn.length - 1];\n74.                     if (splitArn[3] !== this.options.region) {\n75.                       region = splitArn[3];\n76.                     }\n77.                   } else {\n78.                     throw new this.serverless.classes.Error(\n79.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n80.                     );\n81.                   }\n82.                 } else {\n83.                   throw new this.serverless.classes.Error(\n84.                     this.invalidPropertyErrorMessage(functionName, \'arn\')\n85.                   );\n86.                 }\n87.                 topicName = event.sns.topicName || topicName;\n88.                 if (!topicName || typeof topicName !== \'string\') {\n89.                   throw new this.serverless.classes.Error(\n90.                     this.invalidPropertyErrorMessage(functionName, \'topicName\')\n91.                   );\n92.                 }\n93.               } else {\n94.                 [\'topicName\', \'displayName\'].forEach(property => {\n95.                   if (typeof event.sns[property] === \'string\') {\n96.                     return;\n97.                   }\n98.                   throw new this.serverless.classes.Error(\n99.                     this.invalidPropertyErrorMessage(functionName, property)\n100.                   );\n101.                 });\n102.                 displayName = event.sns.displayName;\n103.                 topicName = event.sns.topicName;\n104.               }\n105.             } else if (typeof event.sns === \'string\') {\n106.               if (event.sns.indexOf(\'arn:\') === 0) {\n107.                 topicArn = event.sns;\n108.                 const splitArn = topicArn.split(\':\');\n109.                 topicName = splitArn[splitArn.length - 1];\n110.               } else {\n111.                 topicName = event.sns;\n112.               }\n113.             } else {\n114.               const errorMessage = [\n115.                 `SNS event of function ${functionName} is not an object nor a string`,\n116.                 \' The correct syntax is: sns: topic-name-or-arn\',\n117.                 \' OR an object with \',\n118.                 \' arn and topicName OR\',\n119.                 \' topicName and displayName.\',\n120.                 \' Please check the docs for more info.\',\n121.               ].join(\'\');\n122.               throw new this.serverless.classes.Error(errorMessage);\n123.             }\n124. \n125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n126. \n127.             const endpoint = {\n128.               \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n129.             };\n130. \n131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\n132.               functionName,\n133.               topicName\n134.             );\n135. \n136.             if (topicArn) {\n137.               _.merge(template.Resources, {\n138.                 [subscriptionLogicalId]: {\n139.                   Type: \'AWS::SNS::Subscription\',\n140.                   Properties: {\n141.                     TopicArn: topicArn,\n142.                     Protocol: \'lambda\',\n143.                     Endpoint: endpoint,\n144.                     FilterPolicy: event.sns.filterPolicy,\n145.                     RedrivePolicy: event.sns.redrivePolicy,\n146.                     Region: region,\n147.                   },\n148.                 },\n149.               });\n150.             } else {\n151.               topicArn = {\n152.                 \'Fn::Join\': [\n153.                   \'\',\n154.                   [\n155.                     \'arn:\',\n156.                     { Ref: \'AWS::Partition\' },\n157.                     \':sns:\',\n158.                     { Ref: \'AWS::Region\' },\n159.                     \':\',\n160.                     { Ref: \'AWS::AccountId\' },\n161.                     \':\',\n162.                     topicName,\n163.                   ],\n164.                 ],\n165.               };\n166. \n167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);\n168. \n169.               const subscription = {\n170.                 Endpoint: endpoint,\n171.                 Protocol: \'lambda\',\n172.               };\n173. \n174.               if (!(topicLogicalId in template.Resources)) {\n175.                 _.merge(template.Resources, {\n176.                   [topicLogicalId]: {\n177.                     Type: \'AWS::SNS::Topic\',\n178.                     Properties: {\n179.                       TopicName: topicName,\n180.                       DisplayName: displayName,\n181.                     },\n182.                   },\n183.                 });\n184.               }\n185. \n186.               if (\n187.                 event.sns.filterPolicy ||\n188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)\n189.               ) {\n190.                 _.merge(template.Resources, {\n191.                   [subscriptionLogicalId]: {\n192.                     Type: \'AWS::SNS::Subscription\',\n193.                     Properties: _.merge(subscription, {\n194.                       TopicArn: {\n195.                         Ref: topicLogicalId,\n196.                       },\n197.                       FilterPolicy: event.sns.filterPolicy,\n198.                       RedrivePolicy: event.sns.redrivePolicy,\n199.                     }),\n200.                   },\n201.                 });\n202.               } else {\n203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {\n204.                   template.Resources[topicLogicalId].Properties.Subscription = [];\n205.                 }\n206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);\n207.               }\n208.             }\n209. \n210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(\n211.               functionName,\n212.               topicName\n213.             );\n214. \n215.             _.merge(template.Resources, {\n216.               [lambdaPermissionLogicalId]: {\n217.                 Type: \'AWS::Lambda::Permission\',\n218.                 Properties: {\n219.                   FunctionName: endpoint,\n220.                   Action: \'lambda:InvokeFunction\',\n221.                   Principal: \'sns.amazonaws.com\',\n222.                   SourceArn: topicArn,\n223.                 },\n224.               },\n225.             });\n226. \n227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n229.                 functionName,\n230.                 `${topicName}DLQ`\n231.               );\n232.               Object.assign(template.Resources, {\n233.                 [queuePolicyLogicalId]: {\n234.                   Type: \'AWS::SQS::QueuePolicy\',\n235.                   Properties: {\n236.                     PolicyDocument: {\n237.                       Version: \'2012-10-17\',\n238.                       Id: queuePolicyLogicalId,\n239.                       Statement: [\n240.                         {\n241.                           Effect: \'Allow\',\n242.                           Principal: {\n243.                             Service: \'sns.amazonaws.com\',\n244.                           },\n245.                           Action: \'sqs:SendMessage\',\n246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,\n247.                           Condition: {\n248.                             ArnEquals: {\n249.                               \'aws:SourceArn\': topicArn,\n250.                             },\n251.                           },\n252.                         },\n253.                       ],\n254.                     },\n255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\n256.                   },\n257.                 },\n258.               });\n259.             }\n260.           }\n261.         });\n262.       }\n263.     });\n264.   }\n265. }\n266. \n267. module.exports = AwsCompileSNSEvents;', start_line_number=1, end_line_number=267), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. \n8. describe('AwsCompileSNSEvents', () => {\n9.   let serverless;\n10.   let awsCompileSNSEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     const options = {\n15.       region: 'some-region',\n16.     };\n17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n18.     serverless.setProvider('aws', new AwsProvider(serverless));\n19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\n20.   });\n21. \n22.   describe('#constructor()', () => {\n23.     it('should set the provider variable to an instance of AwsProvider', () =>\n24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));\n25.   });\n26. \n27.   describe('#compileSNSEvents()', () => {\n28.     it('should throw an error if SNS event type is not a string or an object', () => {\n29.       awsCompileSNSEvents.serverless.service.functions = {\n30.         first: {\n31.           events: [\n32.             {\n33.               sns: 42,\n34.             },\n35.           ],\n36.         },\n37.       };\n38. \n39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);\n40.     });\n41. \n42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });\n89. \n90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });\n150. \n151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });\n184. \n185.     it('should throw an error when the event an object and the displayName is not given', () => {\n186.       awsCompileSNSEvents.serverless.service.functions = {\n187.         first: {\n188.           events: [\n189.             {\n190.               sns: {\n191.                 displayName: 'Display name for topic 1',\n192.               },\n193.             },\n194.           ],\n195.         },\n196.       };\n197. \n198.       expect(() => {\n199.         awsCompileSNSEvents.compileSNSEvents();\n200.       }).to.throw(Error);\n201.     });\n202. \n203.     it('should not create corresponding resources when SNS events are not given', () => {\n204.       awsCompileSNSEvents.serverless.service.functions = {\n205.         first: {\n206.           events: [],\n207.         },\n208.       };\n209. \n210.       awsCompileSNSEvents.compileSNSEvents();\n211. \n212.       expect(\n213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.       ).to.deep.equal({});\n215.     });\n216. \n217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });\n248. \n249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });\n278. \n279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });\n311. \n312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {\n313.       awsCompileSNSEvents.serverless.service.functions = {\n314.         first: {\n315.           events: [\n316.             {\n317.               sns: {\n318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',\n319.               },\n320.             },\n321.           ],\n322.         },\n323.       };\n324. \n325.       awsCompileSNSEvents.compileSNSEvents();\n326.       expect(\n327.         Object.keys(\n328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n329.         )\n330.       ).to.have.length(2);\n331.       expect(\n332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n333.           .FirstSnsSubscriptionFoo.Type\n334.       ).to.equal('AWS::SNS::Subscription');\n335.       expect(\n336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n337.           .FirstSnsSubscriptionFoo.Properties.Region\n338.       ).to.equal('${AWS::Region}');\n339.       expect(\n340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n341.           .FirstLambdaPermissionFooSNS.Type\n342.       ).to.equal('AWS::Lambda::Permission');\n343.     });\n344. \n345.     it('should throw an error when the arn an object and the value is not a string', () => {\n346.       awsCompileSNSEvents.serverless.service.functions = {\n347.         first: {\n348.           events: [\n349.             {\n350.               sns: {\n351.                 arn: 123,\n352.               },\n353.             },\n354.           ],\n355.         },\n356.       };\n357. \n358.       expect(() => {\n359.         awsCompileSNSEvents.compileSNSEvents();\n360.       }).to.throw(Error);\n361.     });\n362. \n363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {\n364.       awsCompileSNSEvents.serverless.service.functions = {\n365.         first: {\n366.           events: [\n367.             {\n368.               sns: {\n369.                 topicName: 'bar',\n370.                 arn: 'arn:aws:sns:region:accountid:bar',\n371.               },\n372.             },\n373.           ],\n374.         },\n375.       };\n376. \n377.       awsCompileSNSEvents.compileSNSEvents();\n378. \n379.       expect(\n380.         Object.keys(\n381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n382.         )\n383.       ).to.have.length(2);\n384.       expect(\n385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n386.           .FirstSnsSubscriptionBar.Type\n387.       ).to.equal('AWS::SNS::Subscription');\n388.       expect(\n389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n390.           .FirstLambdaPermissionBarSNS.Type\n391.       ).to.equal('AWS::Lambda::Permission');\n392.     });\n393. \n394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {\n395.       awsCompileSNSEvents.serverless.service.functions = {\n396.         first: {\n397.           events: [\n398.             {\n399.               sns: {\n400.                 topicName: 'first',\n401.                 arn: 'arn:aws:sns:region-1:accountid:bar',\n402.               },\n403.             },\n404.             {\n405.               sns: {\n406.                 topicName: 'second',\n407.                 arn: 'arn:aws:sns:region-2:accountid:bar',\n408.               },\n409.             },\n410.           ],\n411.         },\n412.       };\n413. \n414.       awsCompileSNSEvents.compileSNSEvents();\n415. \n416.       expect(\n417.         Object.keys(\n418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n419.         )\n420.       ).to.have.length(4);\n421.       expect(\n422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n423.           .FirstSnsSubscriptionFirst.Type\n424.       ).to.equal('AWS::SNS::Subscription');\n425.       expect(\n426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n427.           .FirstSnsSubscriptionSecond.Type\n428.       ).to.equal('AWS::SNS::Subscription');\n429.     });\n430. \n431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {\n432.       awsCompileSNSEvents.serverless.service.functions = {\n433.         first: {\n434.           events: [\n435.             {\n436.               sns: {\n437.                 topicName: 'foo',\n438.                 arn: 'arn:aws:sns:region:accountid:bar',\n439.               },\n440.             },\n441.           ],\n442.         },\n443.       };\n444. \n445.       awsCompileSNSEvents.compileSNSEvents();\n446. \n447.       expect(\n448.         Object.keys(\n449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n450.         )\n451.       ).to.have.length(2);\n452.       expect(\n453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n454.           .FirstSnsSubscriptionFoo.Type\n455.       ).to.equal('AWS::SNS::Subscription');\n456.       expect(\n457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n458.           .FirstLambdaPermissionFooSNS.Type\n459.       ).to.equal('AWS::Lambda::Permission');\n460.     });\n461. \n462.     // eslint-disable-next-line max-len\n463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {\n464.       awsCompileSNSEvents.serverless.service.functions = {\n465.         first: {\n466.           events: [\n467.             {\n468.               sns: {\n469.                 topicName: 'bar',\n470.                 arn: {\n471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],\n472.                 },\n473.               },\n474.             },\n475.           ],\n476.         },\n477.       };\n478. \n479.       awsCompileSNSEvents.compileSNSEvents();\n480. \n481.       expect(\n482.         Object.keys(\n483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n484.         )\n485.       ).to.have.length(2);\n486.       expect(\n487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n488.           .FirstSnsSubscriptionBar.Type\n489.       ).to.equal('AWS::SNS::Subscription');\n490.       expect(\n491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n492.           .FirstLambdaPermissionBarSNS.Type\n493.       ).to.equal('AWS::Lambda::Permission');\n494.     });\n495. \n496.     // eslint-disable-next-line max-len\n497.     it('should throw an error when arn object and no topicName are given as object properties', () => {\n498.       awsCompileSNSEvents.serverless.service.functions = {\n499.         first: {\n500.           events: [\n501.             {\n502.               sns: {\n503.                 arn: {\n504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],\n505.                 },\n506.               },\n507.             },\n508.           ],\n509.         },\n510.       };\n511. \n512.       expect(() => {\n513.         awsCompileSNSEvents.compileSNSEvents();\n514.       }).to.throw(Error);\n515.     });\n516. \n517.     // eslint-disable-next-line max-len\n518.     it('should throw an error when invalid imported arn object is given as object properties', () => {\n519.       awsCompileSNSEvents.serverless.service.functions = {\n520.         first: {\n521.           events: [\n522.             {\n523.               sns: {\n524.                 topicName: 'bar',\n525.                 arn: {\n526.                   'Fn::ImportValue': {\n527.                     Ref: 'BarTopic',\n528.                   },\n529.                 },\n530.               },\n531.             },\n532.           ],\n533.         },\n534.       };\n535. \n536.       expect(() => {\n537.         awsCompileSNSEvents.compileSNSEvents();\n538.       }).to.throw(Error);\n539. \n540.       awsCompileSNSEvents.serverless.service.functions = {\n541.         first: {\n542.           events: [\n543.             {\n544.               sns: {\n545.                 topicName: 'bar',\n546.                 arn: {\n547.                   'Fn::ImportValue': {\n548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],\n549.                   },\n550.                 },\n551.               },\n552.             },\n553.           ],\n554.         },\n555.       };\n556. \n557.       expect(() => {\n558.         awsCompileSNSEvents.compileSNSEvents();\n559.       }).to.throw(Error);\n560.     });\n561. \n562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });\n599. \n600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });\n654.   });\n655. });", start_line_number=1, end_line_number=655)]
2025-11-13 20:24:52,906 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classifier_node - INFO - IssueClassifierNode classified the issue as: bug
2025-11-13 20:24:52,907 - thread-135845298308800.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - issue_type: bug
2025-11-13 20:24:52,909 - thread-135845298308800.prometheus.docker.base_container - INFO - Pulling docker image: ghcr.io/timesler/swe-polybench.eval.x86_64.serverless__serverless-7277:latest
2025-11-13 20:25:34,298 - thread-135845298308800.prometheus.docker.base_container - INFO - Tagging pulled image as: prometheus_user_defined_container_43f8f5f7fa
2025-11-13 20:25:34,307 - thread-135845298308800.prometheus.docker.base_container - INFO - Starting container from image prometheus_user_defined_container_43f8f5f7fa
2025-11-13 20:25:34,740 - thread-135845298308800.prometheus.docker.base_container - INFO - Starting persistent shell for interactive mode...
2025-11-13 20:25:35,166 - thread-135845298308800.prometheus.docker.base_container - INFO - Persistent shell is ready
2025-11-13 20:25:35,167 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - Enter IssueBugSubgraphNode
2025-11-13 20:25:35,170 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - INFO - Enter bug_get_regression_tests_subgraph_node
2025-11-13 20:25:35,171 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_context_message_node - DEBUG - Sending query to context provider subgraph:
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

2025-11-13 20:25:35,172 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 20:25:35,174 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:25:51,326 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We need exact test case content with imports, setup, assertions, and line numbers. The file tree alone is insufficient. The issue concerns SNS event redrivePolicy referencing an SQS dead-letter queue (ARN vs URL). Likely relevant tests are under integration-all/sns and unit tests for AWS packaging of SNS events. Therefore, we need specific test file contents to identify 8 suitable regression tests.' query='Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.' extra_requirements='If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.' purpose='I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.'
2025-11-13 20:25:51,328 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.
2025-11-13 20:25:54,087 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 20:25:54,087 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 20:25:54,087 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 20:25:54,087 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 20:25:54,089 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 20:25:54,090 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 20:25:54,090 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.
Extra requirements: If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.
Purpose: I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.
2025-11-13 20:25:57,684 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_WlcSH8wjDs4UwQ7XrvTxyDJI', 'function': {'arguments': '{"relative_path":"tests/integration-all/sns/tests.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 228, 'prompt_tokens': 2311, 'total_tokens': 2539, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--28c4b0cd-f825-4b77-8cfe-0b8454761559-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'tests/integration-all/sns/tests.js'}, 'id': 'call_WlcSH8wjDs4UwQ7XrvTxyDJI', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2311, 'output_tokens': 228, 'total_tokens': 2539, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:26:00,136 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_1IsK3BtKGMoNWtt8WWRWlUkT', 'function': {'arguments': '{"relative_path":"tests/integration-all/sns/tests.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 2391, 'total_tokens': 2422, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1f1f63ac-e323-4824-8f7c-883f59cbe732-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/integration-all/sns/tests.js'}, 'id': 'call_1IsK3BtKGMoNWtt8WWRWlUkT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2391, 'output_tokens': 31, 'total_tokens': 2422, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:26:02,883 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CrNj1svXJmkbkCGthV33LCic', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 104, 'prompt_tokens': 4326, 'total_tokens': 4430, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ebdbe1cd-35b8-41d7-b9e3-b1b5dffc396c-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_CrNj1svXJmkbkCGthV33LCic', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4326, 'output_tokens': 104, 'total_tokens': 4430, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:26:16,675 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Ix3k4uQFCdi4b76wWeYegQUj', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 4415, 'total_tokens': 4450, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0a9036cb-b56c-4905-bbf5-5063e95e0792-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_Ix3k4uQFCdi4b76wWeYegQUj', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4415, 'output_tokens': 35, 'total_tokens': 4450, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:26:17,896 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_EMx0jp31yibhH569A1bxD2jZ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js","start_line":500,"end_line":999}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 9656, 'total_tokens': 9699, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a9de1807-1825-44b2-9afa-57cf0a228544-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'start_line': 500, 'end_line': 999}, 'id': 'call_EMx0jp31yibhH569A1bxD2jZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9656, 'output_tokens': 43, 'total_tokens': 9699, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:26:32,263 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I located both requested files and provided their full contents with line numbers: tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js. I confirmed that index.test.js contains an explicit test covering SNS redrivePolicy and SQS QueuePolicy behavior (lines 600–653). The integration test covers SNS event configuration and filtering scenarios but not redrivePolicy specifically. No other standalone tests for SNS redrivePolicy or queue policy were found beyond the one in index.test.js.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1585, 'prompt_tokens': 11292, 'total_tokens': 12877, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--fcf21d3c-497e-442b-bb05-70bef5c1ff41-0' usage_metadata={'input_tokens': 11292, 'output_tokens': 1585, 'total_tokens': 12877, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-13 20:26:32,268 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileSNSEvents', () => {
9.   let serverless;
10.   let awsCompileSNSEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     const options = {
15.       region: 'some-region',
16.     };
17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
18.     serverless.setProvider('aws', new AwsProvider(serverless));
19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
20.   });
21. 
22.   describe('#constructor()', () => {
23.     it('should set the provider variable to an instance of AwsProvider', () =>
24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));
25.   });
26. 
27.   describe('#compileSNSEvents()', () => {
28.     it('should throw an error if SNS event type is not a string or an object', () => {
29.       awsCompileSNSEvents.serverless.service.functions = {
30.         first: {
31.           events: [
32.             {
33.               sns: 42,
34.             },
35.           ],
36.         },
37.       };
38. 
39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);
40.     });
41. 
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });
89. 
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });
150. 
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });
184. 
185.     it('should throw an error when the event an object and the displayName is not given', () => {
186.       awsCompileSNSEvents.serverless.service.functions = {
187.         first: {
188.           events: [
189.             {
190.               sns: {
191.                 displayName: 'Display name for topic 1',
192.               },
193.             },
194.           ],
195.         },
196.       };
197. 
198.       expect(() => {
199.         awsCompileSNSEvents.compileSNSEvents();
200.       }).to.throw(Error);
201.     });
202. 
203.     it('should not create corresponding resources when SNS events are not given', () => {
204.       awsCompileSNSEvents.serverless.service.functions = {
205.         first: {
206.           events: [],
207.         },
208.       };
209. 
210.       awsCompileSNSEvents.compileSNSEvents();
211. 
212.       expect(
213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.       ).to.deep.equal({});
215.     });
216. 
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });
248. 
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });
278. 
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });
311. 
312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {
313.       awsCompileSNSEvents.serverless.service.functions = {
314.         first: {
315.           events: [
316.             {
317.               sns: {
318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',
319.               },
320.             },
321.           ],
322.         },
323.       };
324. 
325.       awsCompileSNSEvents.compileSNSEvents();
326.       expect(
327.         Object.keys(
328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
329.         )
330.       ).to.have.length(2);
331.       expect(
332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
333.           .FirstSnsSubscriptionFoo.Type
334.       ).to.equal('AWS::SNS::Subscription');
335.       expect(
336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
337.           .FirstSnsSubscriptionFoo.Properties.Region
338.       ).to.equal('${AWS::Region}');
339.       expect(
340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
341.           .FirstLambdaPermissionFooSNS.Type
342.       ).to.equal('AWS::Lambda::Permission');
343.     });
344. 
345.     it('should throw an error when the arn an object and the value is not a string', () => {
346.       awsCompileSNSEvents.serverless.service.functions = {
347.         first: {
348.           events: [
349.             {
350.               sns: {
351.                 arn: 123,
352.               },
353.             },
354.           ],
355.         },
356.       };
357. 
358.       expect(() => {
359.         awsCompileSNSEvents.compileSNSEvents();
360.       }).to.throw(Error);
361.     });
362. 
363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {
364.       awsCompileSNSEvents.serverless.service.functions = {
365.         first: {
366.           events: [
367.             {
368.               sns: {
369.                 topicName: 'bar',
370.                 arn: 'arn:aws:sns:region:accountid:bar',
371.               },
372.             },
373.           ],
374.         },
375.       };
376. 
377.       awsCompileSNSEvents.compileSNSEvents();
378. 
379.       expect(
380.         Object.keys(
381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
382.         )
383.       ).to.have.length(2);
384.       expect(
385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
386.           .FirstSnsSubscriptionBar.Type
387.       ).to.equal('AWS::SNS::Subscription');
388.       expect(
389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
390.           .FirstLambdaPermissionBarSNS.Type
391.       ).to.equal('AWS::Lambda::Permission');
392.     });
393. 
394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {
395.       awsCompileSNSEvents.serverless.service.functions = {
396.         first: {
397.           events: [
398.             {
399.               sns: {
400.                 topicName: 'first',
401.                 arn: 'arn:aws:sns:region-1:accountid:bar',
402.               },
403.             },
404.             {
405.               sns: {
406.                 topicName: 'second',
407.                 arn: 'arn:aws:sns:region-2:accountid:bar',
408.               },
409.             },
410.           ],
411.         },
412.       };
413. 
414.       awsCompileSNSEvents.compileSNSEvents();
415. 
416.       expect(
417.         Object.keys(
418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
419.         )
420.       ).to.have.length(4);
421.       expect(
422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
423.           .FirstSnsSubscriptionFirst.Type
424.       ).to.equal('AWS::SNS::Subscription');
425.       expect(
426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
427.           .FirstSnsSubscriptionSecond.Type
428.       ).to.equal('AWS::SNS::Subscription');
429.     });
430. 
431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {
432.       awsCompileSNSEvents.serverless.service.functions = {
433.         first: {
434.           events: [
435.             {
436.               sns: {
437.                 topicName: 'foo',
438.                 arn: 'arn:aws:sns:region:accountid:bar',
439.               },
440.             },
441.           ],
442.         },
443.       };
444. 
445.       awsCompileSNSEvents.compileSNSEvents();
446. 
447.       expect(
448.         Object.keys(
449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
450.         )
451.       ).to.have.length(2);
452.       expect(
453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
454.           .FirstSnsSubscriptionFoo.Type
455.       ).to.equal('AWS::SNS::Subscription');
456.       expect(
457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
458.           .FirstLambdaPermissionFooSNS.Type
459.       ).to.equal('AWS::Lambda::Permission');
460.     });
461. 
462.     // eslint-disable-next-line max-len
463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {
464.       awsCompileSNSEvents.serverless.service.functions = {
465.         first: {
466.           events: [
467.             {
468.               sns: {
469.                 topicName: 'bar',
470.                 arn: {
471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
472.                 },
473.               },
474.             },
475.           ],
476.         },
477.       };
478. 
479.       awsCompileSNSEvents.compileSNSEvents();
480. 
481.       expect(
482.         Object.keys(
483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
484.         )
485.       ).to.have.length(2);
486.       expect(
487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
488.           .FirstSnsSubscriptionBar.Type
489.       ).to.equal('AWS::SNS::Subscription');
490.       expect(
491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
492.           .FirstLambdaPermissionBarSNS.Type
493.       ).to.equal('AWS::Lambda::Permission');
494.     });
495. 
496.     // eslint-disable-next-line max-len
497.     it('should throw an error when arn object and no topicName are given as object properties', () => {
498.       awsCompileSNSEvents.serverless.service.functions = {
499.         first: {
500.           events: [


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 500 - 999
Content:
500.           events: [
501.             {
502.               sns: {
503.                 arn: {
504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
505.                 },
506.               },
507.             },
508.           ],
509.         },
510.       };
511. 
512.       expect(() => {
513.         awsCompileSNSEvents.compileSNSEvents();
514.       }).to.throw(Error);
515.     });
516. 
517.     // eslint-disable-next-line max-len
518.     it('should throw an error when invalid imported arn object is given as object properties', () => {
519.       awsCompileSNSEvents.serverless.service.functions = {
520.         first: {
521.           events: [
522.             {
523.               sns: {
524.                 topicName: 'bar',
525.                 arn: {
526.                   'Fn::ImportValue': {
527.                     Ref: 'BarTopic',
528.                   },
529.                 },
530.               },
531.             },
532.           ],
533.         },
534.       };
535. 
536.       expect(() => {
537.         awsCompileSNSEvents.compileSNSEvents();
538.       }).to.throw(Error);
539. 
540.       awsCompileSNSEvents.serverless.service.functions = {
541.         first: {
542.           events: [
543.             {
544.               sns: {
545.                 topicName: 'bar',
546.                 arn: {
547.                   'Fn::ImportValue': {
548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],
549.                   },
550.                 },
551.               },
552.             },
553.           ],
554.         },
555.       };
556. 
557.       expect(() => {
558.         awsCompileSNSEvents.compileSNSEvents();
559.       }).to.throw(Error);
560.     });
561. 
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });
599. 
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });
654.   });
655. });


File: tests/integration-all/sns/tests.js
Line number range: 1 - 143
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const BbPromise = require('bluebird');
5. const { expect } = require('chai');
6. 
7. const { getTmpDirPath } = require('../../utils/fs');
8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');
9. const {
10.   createTestService,
11.   deployService,
12.   removeService,
13.   waitForFunctionLogs,
14. } = require('../../utils/integration');
15. const { getMarkers } = require('../shared/utils');
16. 
17. describe('AWS - SNS Integration Test', function() {
18.   this.timeout(1000 * 60 * 100); // Involves time-taking deploys
19.   let serviceName;
20.   let stackName;
21.   let tmpDirPath;
22.   let minimalTopicName;
23.   let filteredTopicName;
24.   let existingTopicName;
25.   const stage = 'dev';
26. 
27.   before(async () => {
28.     tmpDirPath = getTmpDirPath();
29.     console.info(`Temporary path: ${tmpDirPath}`);
30.     const serverlessConfig = await createTestService(tmpDirPath, {
31.       templateDir: path.join(__dirname, 'service'),
32.       filesToAdd: [path.join(__dirname, '..', 'shared')],
33.       serverlessConfigHook:
34.         // Ensure unique topics (to avoid collision among concurrent CI runs)
35.         config => {
36.           minimalTopicName = `${config.service}-minimal`;
37.           filteredTopicName = `${config.service}-filtered`;
38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;
39.           existingTopicName = `${config.service}-existing`;
40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;
41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;
42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;
43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;
44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;
45.           config.functions.snsExisting.events[0].sns.arn['Fn::Join'][1][3] = existingTopicName;
46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;
47.         },
48.     });
49.     serviceName = serverlessConfig.service;
50.     stackName = `${serviceName}-${stage}`;
51.     // create "existing" SNS topics
52.     // NOTE: deployment can only be done once the SNS topics are created
53.     console.info(`Creating SNS topic "${existingTopicName}"...`);
54.     return createSnsTopic(existingTopicName).then(() => {
55.       console.info(`Deploying "${stackName}" service...`);
56.       return deployService(tmpDirPath);
57.     });
58.   });
59. 
60.   after(async () => {
61.     console.info('Removing service...');
62.     await removeService(tmpDirPath);
63.     console.info('Deleting SNS topics');
64.     return removeSnsTopic(existingTopicName);
65.   });
66. 
67.   describe('Minimal Setup', () => {
68.     it('should invoke on a topic message', () => {
69.       const functionName = 'snsMinimal';
70.       const markers = getMarkers(functionName);
71.       const message = 'Hello from SNS!';
72. 
73.       return publishSnsMessage(minimalTopicName, message)
74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
75.         .then(logs => {
76.           expect(logs).to.include(functionName);
77.           expect(logs).to.include(message);
78.         });
79.     });
80.   });
81. 
82.   describe('Multiple and Filtered Setup', () => {
83.     it('should invoke on a topic message that matches filter', () => {
84.       const leftFunctionName = 'snsMultipleFilteredLeft';
85.       const leftMarkers = getMarkers(leftFunctionName);
86.       const rightFunctionName = 'snsMultipleFilteredRight';
87.       const rightMarkers = getMarkers(rightFunctionName);
88.       const leftMessage = 'Hello to the left-side from SNS!';
89.       const rightMessage = 'Hello to the right-side from SNS!';
90.       const middleMessage = 'Hello to the middle-side from SNS!';
91.       const leftAttributes = { side: { DataType: 'String', StringValue: 'left' } };
92.       const middleAttributes = { side: { DataType: 'String', StringValue: 'middle' } };
93.       const rightAttributes = { side: { DataType: 'String', StringValue: 'right' } };
94. 
95.       return BbPromise.all([
96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),
97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),
98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),
99.       ])
100.         .then(() =>
101.           BbPromise.all([
102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),
103.             waitForFunctionLogs(
104.               tmpDirPath,
105.               rightFunctionName,
106.               rightMarkers.start,
107.               rightMarkers.end
108.             ),
109.           ])
110.         )
111.         .then(logs => {
112.           const leftLogs = logs[0];
113.           const rightLogs = logs[1];
114.           // left side is filtered to only get "left" messages from topic:
115.           expect(leftLogs).to.include(leftFunctionName);
116.           expect(leftLogs).to.include(leftMessage);
117.           expect(leftLogs).not.to.include(middleMessage);
118.           expect(leftLogs).not.to.include(rightMessage);
119.           // right side is filtered to only get "right" messages from topic:
120.           expect(rightLogs).to.include(rightFunctionName);
121.           expect(rightLogs).not.to.include(leftMessage);
122.           expect(rightLogs).not.to.include(middleMessage);
123.           expect(rightLogs).to.include(rightMessage);
124.           // "middle" messages will not cause an invocation.
125.         });
126.     });
127.   });
128. 
129.   describe('Existing Setup', () => {
130.     it('should invoke on an existing topic message', () => {
131.       const functionName = 'snsExisting';
132.       const markers = getMarkers(functionName);
133.       const message = 'Hello from an existing SNS!';
134. 
135.       return publishSnsMessage(existingTopicName, message)
136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
137.         .then(logs => {
138.           expect(logs).to.include(functionName);
139.           expect(logs).to.include(message);
140.         });
141.     });
142.   });
143. });

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 20:27:05,169 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requirement analysis: The request asks for tests around SNS event packaging and any tests that explicitly cover SNS redrivePolicy or queue policy behavior. 2. Extended relevance: These import and setup lines are necessary for understanding and running all tests within the SNS packaging test file.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=1, end_line=7), ContextOutput(reasoning='1. Query requirement analysis: Explicitly tests SNS redrivePolicy behavior, asserting RedrivePolicy on the subscription and creation of SQS QueuePolicy resource. 2. Extended relevance: Provides complete setup, resource injection, compile call, and all assertions affected by fixes to redrivePolicy references.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=600, end_line=653), ContextOutput(reasoning='1. Query requirement analysis: Exercises core SNS event packaging with object and string topic, including filterPolicy; important for verifying packaging flow affected by changes. 2. Extended relevance: Includes assertions for created Topic, Permission, Subscription, and FilterPolicy.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=42, end_line=88), ContextOutput(reasoning='1. Query requirement analysis: Validates behavior when SNS topic is defined in CloudFormation resources; relevant to packaging and referencing topics. 2. Extended relevance: Asserts Topic creation or reuse, Lambda permission, Subscription and FilterPolicy.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=90, end_line=149), ContextOutput(reasoning='1. Query requirement analysis: Ensures no duplicate topics are created when referenced repeatedly, covering packaging deduplication logic. 2. Extended relevance: Asserts only two resources exist and validates Topic and Lambda Permission.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=151, end_line=183), ContextOutput(reasoning='1. Query requirement analysis: Tests SNS event packaging when arn is provided as a string; common path impacted by packaging changes. 2. Extended relevance: Asserts Subscription, Lambda Permission, and absence of FilterPolicy.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=217, end_line=247), ContextOutput(reasoning='1. Query requirement analysis: Tests packaging when only arn is provided as an object property; confirms handling of object-based arns. 2. Extended relevance: Asserts Subscription and Lambda Permission creation.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=249, end_line=277), ContextOutput(reasoning='1. Query requirement analysis: Covers cross-region subscription packaging, which is part of SNS event compilation behavior. 2. Extended relevance: Asserts Subscription with Region property and Lambda Permission; essential for completeness.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=279, end_line=310), ContextOutput(reasoning='1. Query requirement analysis: Validates packaging when arn, topicName, and filterPolicy are specified together; common scenario impacted by compilation logic. 2. Extended relevance: Asserts Subscription, FilterPolicy, and Lambda Permission.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=562, end_line=598), ContextOutput(reasoning='1. Query requirement analysis: The user asked for the content of the SNS integration tests; these import and utility lines are essential for the tests. 2. Extended relevance: Provide necessary setup for running integration tests that exercise SNS event configuration.', relative_path='tests/integration-all/sns/tests.js', start_line=1, end_line=16), ContextOutput(reasoning='1. Query requirement analysis: Integration test pre-deployment setup that programmatically customizes topic names and properties; exercises SNS configuration. 2. Extended relevance: Critical for understanding how integration tests generate unique topics and tie into the subsequent invocations.', relative_path='tests/integration-all/sns/tests.js', start_line=27, end_line=58), ContextOutput(reasoning='1. Query requirement analysis: Minimal SNS integration test verifying invocation on topic message. 2. Extended relevance: Ensures basic SNS event wiring works, including imports, message publish, and assertion on logs.', relative_path='tests/integration-all/sns/tests.js', start_line=67, end_line=80), ContextOutput(reasoning='1. Query requirement analysis: Integration test covering filtered SNS subscriptions; relevant to event configuration impacted by packaging logic. 2. Extended relevance: Publishes messages with attributes and asserts correct invocations based on filterPolicy, including imports and assertions.', relative_path='tests/integration-all/sns/tests.js', start_line=82, end_line=127), ContextOutput(reasoning='1. Query requirement analysis: Integration test verifying invocation on an existing topic; relevant to SNS event configuration. 2. Extended relevance: Asserts proper handling of existing topics with log checks.', relative_path='tests/integration-all/sns/tests.js', start_line=129, end_line=142)]
2025-11-13 20:27:05,173 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 14 contexts to memory for query: Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.
2025-11-13 20:27:07,320 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 20:27:07,322 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 14 new contexts to 0 existing contexts
2025-11-13 20:27:07,323 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 14 total contexts (removed 0 duplicates)
2025-11-13 20:27:07,325 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.
Extra Requirements: If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.
Purpose: I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 7
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 42 - 88
Content:
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 90 - 149
Content:
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 151 - 183
Content:
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 217 - 247
Content:
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 249 - 277
Content:
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 279 - 310
Content:
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 562 - 598
Content:
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 600 - 653
Content:
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });


File: tests/integration-all/sns/tests.js
Line number range: 1 - 16
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const BbPromise = require('bluebird');
5. const { expect } = require('chai');
6. 
7. const { getTmpDirPath } = require('../../utils/fs');
8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');
9. const {
10.   createTestService,
11.   deployService,
12.   removeService,
13.   waitForFunctionLogs,
14. } = require('../../utils/integration');
15. const { getMarkers } = require('../shared/utils');
16. 


File: tests/integration-all/sns/tests.js
Line number range: 27 - 58
Content:
27.   before(async () => {
28.     tmpDirPath = getTmpDirPath();
29.     console.info(`Temporary path: ${tmpDirPath}`);
30.     const serverlessConfig = await createTestService(tmpDirPath, {
31.       templateDir: path.join(__dirname, 'service'),
32.       filesToAdd: [path.join(__dirname, '..', 'shared')],
33.       serverlessConfigHook:
34.         // Ensure unique topics (to avoid collision among concurrent CI runs)
35.         config => {
36.           minimalTopicName = `${config.service}-minimal`;
37.           filteredTopicName = `${config.service}-filtered`;
38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;
39.           existingTopicName = `${config.service}-existing`;
40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;
41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;
42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;
43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;
44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;
45.           config.functions.snsExisting.events[0].sns.arn['Fn::Join'][1][3] = existingTopicName;
46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;
47.         },
48.     });
49.     serviceName = serverlessConfig.service;
50.     stackName = `${serviceName}-${stage}`;
51.     // create "existing" SNS topics
52.     // NOTE: deployment can only be done once the SNS topics are created
53.     console.info(`Creating SNS topic "${existingTopicName}"...`);
54.     return createSnsTopic(existingTopicName).then(() => {
55.       console.info(`Deploying "${stackName}" service...`);
56.       return deployService(tmpDirPath);
57.     });
58.   });


File: tests/integration-all/sns/tests.js
Line number range: 67 - 80
Content:
67.   describe('Minimal Setup', () => {
68.     it('should invoke on a topic message', () => {
69.       const functionName = 'snsMinimal';
70.       const markers = getMarkers(functionName);
71.       const message = 'Hello from SNS!';
72. 
73.       return publishSnsMessage(minimalTopicName, message)
74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
75.         .then(logs => {
76.           expect(logs).to.include(functionName);
77.           expect(logs).to.include(message);
78.         });
79.     });
80.   });


File: tests/integration-all/sns/tests.js
Line number range: 82 - 127
Content:
82.   describe('Multiple and Filtered Setup', () => {
83.     it('should invoke on a topic message that matches filter', () => {
84.       const leftFunctionName = 'snsMultipleFilteredLeft';
85.       const leftMarkers = getMarkers(leftFunctionName);
86.       const rightFunctionName = 'snsMultipleFilteredRight';
87.       const rightMarkers = getMarkers(rightFunctionName);
88.       const leftMessage = 'Hello to the left-side from SNS!';
89.       const rightMessage = 'Hello to the right-side from SNS!';
90.       const middleMessage = 'Hello to the middle-side from SNS!';
91.       const leftAttributes = { side: { DataType: 'String', StringValue: 'left' } };
92.       const middleAttributes = { side: { DataType: 'String', StringValue: 'middle' } };
93.       const rightAttributes = { side: { DataType: 'String', StringValue: 'right' } };
94. 
95.       return BbPromise.all([
96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),
97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),
98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),
99.       ])
100.         .then(() =>
101.           BbPromise.all([
102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),
103.             waitForFunctionLogs(
104.               tmpDirPath,
105.               rightFunctionName,
106.               rightMarkers.start,
107.               rightMarkers.end
108.             ),
109.           ])
110.         )
111.         .then(logs => {
112.           const leftLogs = logs[0];
113.           const rightLogs = logs[1];
114.           // left side is filtered to only get "left" messages from topic:
115.           expect(leftLogs).to.include(leftFunctionName);
116.           expect(leftLogs).to.include(leftMessage);
117.           expect(leftLogs).not.to.include(middleMessage);
118.           expect(leftLogs).not.to.include(rightMessage);
119.           // right side is filtered to only get "right" messages from topic:
120.           expect(rightLogs).to.include(rightFunctionName);
121.           expect(rightLogs).not.to.include(leftMessage);
122.           expect(rightLogs).not.to.include(middleMessage);
123.           expect(rightLogs).to.include(rightMessage);
124.           // "middle" messages will not cause an invocation.
125.         });
126.     });
127.   });


File: tests/integration-all/sns/tests.js
Line number range: 129 - 142
Content:
129.   describe('Existing Setup', () => {
130.     it('should invoke on an existing topic message', () => {
131.       const functionName = 'snsExisting';
132.       const markers = getMarkers(functionName);
133.       const message = 'Hello from an existing SNS!';
134. 
135.       return publishSnsMessage(existingTopicName, message)
136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
137.         .then(logs => {
138.           expect(logs).to.include(functionName);
139.           expect(logs).to.include(message);
140.         });
141.     });
142.   });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:27:29,003 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We need 8 complete, self-contained test cases with exact line numbers. Current snippets show individual SNS packaging tests but omit the file’s setup (describe/before hooks, awsCompileSNSEvents initialization) and do not include assertions for QueuePolicy properties crucial to the issue. Integration SNS tests are also partial, missing top-level describe/hooks. Therefore, additional context is essential to capture full test contents and ensure correctness of line numbers and setup.' query='Please provide the complete content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and the missing sections of tests/integration-all/sns/tests.js, especially setup/describe/hooks and any tests asserting SQS QueuePolicy Queues and Resource for redrivePolicy.' extra_requirements='If sending full files is too large, include at minimum: (a) the import/setup and awsCompileSNSEvents initialization in index.test.js, and (b) all test blocks that verify redrivePolicy and QueuePolicy properties, with exact line numbers.' purpose='I need the full test definitions and setup to extract 8 accurate, self-contained test cases impacted by fixing SNS redrivePolicy references, including precise imports, hooks, and assertions.'
2025-11-13 20:27:29,005 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the complete content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and the missing sections of tests/integration-all/sns/tests.js, especially setup/describe/hooks and any tests asserting SQS QueuePolicy Queues and Resource for redrivePolicy.
2025-11-13 20:27:32,040 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.', 'query_extra_requirements': 'If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.', 'query_purpose': 'I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. ", 'start_line_number': 1, 'end_line_number': 7}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });", 'start_line_number': 600, 'end_line_number': 653}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });", 'start_line_number': 42, 'end_line_number': 88}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });", 'start_line_number': 90, 'end_line_number': 149}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });", 'start_line_number': 151, 'end_line_number': 183}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });", 'start_line_number': 217, 'end_line_number': 247}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });", 'start_line_number': 249, 'end_line_number': 277}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });", 'start_line_number': 279, 'end_line_number': 310}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });", 'start_line_number': 562, 'end_line_number': 598}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "1. 'use strict';\n2. \n3. const path = require('path');\n4. const BbPromise = require('bluebird');\n5. const { expect } = require('chai');\n6. \n7. const { getTmpDirPath } = require('../../utils/fs');\n8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');\n9. const {\n10.   createTestService,\n11.   deployService,\n12.   removeService,\n13.   waitForFunctionLogs,\n14. } = require('../../utils/integration');\n15. const { getMarkers } = require('../shared/utils');\n16. ", 'start_line_number': 1, 'end_line_number': 16}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '27.   before(async () => {\n28.     tmpDirPath = getTmpDirPath();\n29.     console.info(`Temporary path: ${tmpDirPath}`);\n30.     const serverlessConfig = await createTestService(tmpDirPath, {\n31.       templateDir: path.join(__dirname, \'service\'),\n32.       filesToAdd: [path.join(__dirname, \'..\', \'shared\')],\n33.       serverlessConfigHook:\n34.         // Ensure unique topics (to avoid collision among concurrent CI runs)\n35.         config => {\n36.           minimalTopicName = `${config.service}-minimal`;\n37.           filteredTopicName = `${config.service}-filtered`;\n38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;\n39.           existingTopicName = `${config.service}-existing`;\n40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;\n41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;\n42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;\n43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;\n44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;\n45.           config.functions.snsExisting.events[0].sns.arn[\'Fn::Join\'][1][3] = existingTopicName;\n46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;\n47.         },\n48.     });\n49.     serviceName = serverlessConfig.service;\n50.     stackName = `${serviceName}-${stage}`;\n51.     // create "existing" SNS topics\n52.     // NOTE: deployment can only be done once the SNS topics are created\n53.     console.info(`Creating SNS topic "${existingTopicName}"...`);\n54.     return createSnsTopic(existingTopicName).then(() => {\n55.       console.info(`Deploying "${stackName}" service...`);\n56.       return deployService(tmpDirPath);\n57.     });\n58.   });', 'start_line_number': 27, 'end_line_number': 58}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "67.   describe('Minimal Setup', () => {\n68.     it('should invoke on a topic message', () => {\n69.       const functionName = 'snsMinimal';\n70.       const markers = getMarkers(functionName);\n71.       const message = 'Hello from SNS!';\n72. \n73.       return publishSnsMessage(minimalTopicName, message)\n74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n75.         .then(logs => {\n76.           expect(logs).to.include(functionName);\n77.           expect(logs).to.include(message);\n78.         });\n79.     });\n80.   });", 'start_line_number': 67, 'end_line_number': 80}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '82.   describe(\'Multiple and Filtered Setup\', () => {\n83.     it(\'should invoke on a topic message that matches filter\', () => {\n84.       const leftFunctionName = \'snsMultipleFilteredLeft\';\n85.       const leftMarkers = getMarkers(leftFunctionName);\n86.       const rightFunctionName = \'snsMultipleFilteredRight\';\n87.       const rightMarkers = getMarkers(rightFunctionName);\n88.       const leftMessage = \'Hello to the left-side from SNS!\';\n89.       const rightMessage = \'Hello to the right-side from SNS!\';\n90.       const middleMessage = \'Hello to the middle-side from SNS!\';\n91.       const leftAttributes = { side: { DataType: \'String\', StringValue: \'left\' } };\n92.       const middleAttributes = { side: { DataType: \'String\', StringValue: \'middle\' } };\n93.       const rightAttributes = { side: { DataType: \'String\', StringValue: \'right\' } };\n94. \n95.       return BbPromise.all([\n96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),\n97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),\n98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),\n99.       ])\n100.         .then(() =>\n101.           BbPromise.all([\n102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),\n103.             waitForFunctionLogs(\n104.               tmpDirPath,\n105.               rightFunctionName,\n106.               rightMarkers.start,\n107.               rightMarkers.end\n108.             ),\n109.           ])\n110.         )\n111.         .then(logs => {\n112.           const leftLogs = logs[0];\n113.           const rightLogs = logs[1];\n114.           // left side is filtered to only get "left" messages from topic:\n115.           expect(leftLogs).to.include(leftFunctionName);\n116.           expect(leftLogs).to.include(leftMessage);\n117.           expect(leftLogs).not.to.include(middleMessage);\n118.           expect(leftLogs).not.to.include(rightMessage);\n119.           // right side is filtered to only get "right" messages from topic:\n120.           expect(rightLogs).to.include(rightFunctionName);\n121.           expect(rightLogs).not.to.include(leftMessage);\n122.           expect(rightLogs).not.to.include(middleMessage);\n123.           expect(rightLogs).to.include(rightMessage);\n124.           // "middle" messages will not cause an invocation.\n125.         });\n126.     });\n127.   });', 'start_line_number': 82, 'end_line_number': 127}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "129.   describe('Existing Setup', () => {\n130.     it('should invoke on an existing topic message', () => {\n131.       const functionName = 'snsExisting';\n132.       const markers = getMarkers(functionName);\n133.       const message = 'Hello from an existing SNS!';\n134. \n135.       return publishSnsMessage(existingTopicName, message)\n136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n137.         .then(logs => {\n138.           expect(logs).to.include(functionName);\n139.           expect(logs).to.include(message);\n140.         });\n141.     });\n142.   });", 'start_line_number': 129, 'end_line_number': 142}]}]
2025-11-13 20:27:32,041 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 1 memories from memory
2025-11-13 20:27:32,041 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 14 contexts from memory
2025-11-13 20:27:32,042 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 14 contexts from memory
2025-11-13 20:27:32,044 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 14 new contexts to 14 existing contexts
2025-11-13 20:27:32,046 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 14 total contexts (removed 14 duplicates)
2025-11-13 20:27:32,049 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.
Extra Requirements: If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.
Purpose: I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.

Previous refined query 2:
Essential Query: Please provide the complete content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and the missing sections of tests/integration-all/sns/tests.js, especially setup/describe/hooks and any tests asserting SQS QueuePolicy Queues and Resource for redrivePolicy.
Extra Requirements: If sending full files is too large, include at minimum: (a) the import/setup and awsCompileSNSEvents initialization in index.test.js, and (b) all test blocks that verify redrivePolicy and QueuePolicy properties, with exact line numbers.
Purpose: I need the full test definitions and setup to extract 8 accurate, self-contained test cases impacted by fixing SNS redrivePolicy references, including precise imports, hooks, and assertions.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 7
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 42 - 88
Content:
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 90 - 149
Content:
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 151 - 183
Content:
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 217 - 247
Content:
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 249 - 277
Content:
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 279 - 310
Content:
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 562 - 598
Content:
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 600 - 653
Content:
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });


File: tests/integration-all/sns/tests.js
Line number range: 1 - 16
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const BbPromise = require('bluebird');
5. const { expect } = require('chai');
6. 
7. const { getTmpDirPath } = require('../../utils/fs');
8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');
9. const {
10.   createTestService,
11.   deployService,
12.   removeService,
13.   waitForFunctionLogs,
14. } = require('../../utils/integration');
15. const { getMarkers } = require('../shared/utils');
16. 


File: tests/integration-all/sns/tests.js
Line number range: 27 - 58
Content:
27.   before(async () => {
28.     tmpDirPath = getTmpDirPath();
29.     console.info(`Temporary path: ${tmpDirPath}`);
30.     const serverlessConfig = await createTestService(tmpDirPath, {
31.       templateDir: path.join(__dirname, 'service'),
32.       filesToAdd: [path.join(__dirname, '..', 'shared')],
33.       serverlessConfigHook:
34.         // Ensure unique topics (to avoid collision among concurrent CI runs)
35.         config => {
36.           minimalTopicName = `${config.service}-minimal`;
37.           filteredTopicName = `${config.service}-filtered`;
38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;
39.           existingTopicName = `${config.service}-existing`;
40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;
41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;
42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;
43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;
44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;
45.           config.functions.snsExisting.events[0].sns.arn['Fn::Join'][1][3] = existingTopicName;
46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;
47.         },
48.     });
49.     serviceName = serverlessConfig.service;
50.     stackName = `${serviceName}-${stage}`;
51.     // create "existing" SNS topics
52.     // NOTE: deployment can only be done once the SNS topics are created
53.     console.info(`Creating SNS topic "${existingTopicName}"...`);
54.     return createSnsTopic(existingTopicName).then(() => {
55.       console.info(`Deploying "${stackName}" service...`);
56.       return deployService(tmpDirPath);
57.     });
58.   });


File: tests/integration-all/sns/tests.js
Line number range: 67 - 80
Content:
67.   describe('Minimal Setup', () => {
68.     it('should invoke on a topic message', () => {
69.       const functionName = 'snsMinimal';
70.       const markers = getMarkers(functionName);
71.       const message = 'Hello from SNS!';
72. 
73.       return publishSnsMessage(minimalTopicName, message)
74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
75.         .then(logs => {
76.           expect(logs).to.include(functionName);
77.           expect(logs).to.include(message);
78.         });
79.     });
80.   });


File: tests/integration-all/sns/tests.js
Line number range: 82 - 127
Content:
82.   describe('Multiple and Filtered Setup', () => {
83.     it('should invoke on a topic message that matches filter', () => {
84.       const leftFunctionName = 'snsMultipleFilteredLeft';
85.       const leftMarkers = getMarkers(leftFunctionName);
86.       const rightFunctionName = 'snsMultipleFilteredRight';
87.       const rightMarkers = getMarkers(rightFunctionName);
88.       const leftMessage = 'Hello to the left-side from SNS!';
89.       const rightMessage = 'Hello to the right-side from SNS!';
90.       const middleMessage = 'Hello to the middle-side from SNS!';
91.       const leftAttributes = { side: { DataType: 'String', StringValue: 'left' } };
92.       const middleAttributes = { side: { DataType: 'String', StringValue: 'middle' } };
93.       const rightAttributes = { side: { DataType: 'String', StringValue: 'right' } };
94. 
95.       return BbPromise.all([
96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),
97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),
98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),
99.       ])
100.         .then(() =>
101.           BbPromise.all([
102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),
103.             waitForFunctionLogs(
104.               tmpDirPath,
105.               rightFunctionName,
106.               rightMarkers.start,
107.               rightMarkers.end
108.             ),
109.           ])
110.         )
111.         .then(logs => {
112.           const leftLogs = logs[0];
113.           const rightLogs = logs[1];
114.           // left side is filtered to only get "left" messages from topic:
115.           expect(leftLogs).to.include(leftFunctionName);
116.           expect(leftLogs).to.include(leftMessage);
117.           expect(leftLogs).not.to.include(middleMessage);
118.           expect(leftLogs).not.to.include(rightMessage);
119.           // right side is filtered to only get "right" messages from topic:
120.           expect(rightLogs).to.include(rightFunctionName);
121.           expect(rightLogs).not.to.include(leftMessage);
122.           expect(rightLogs).not.to.include(middleMessage);
123.           expect(rightLogs).to.include(rightMessage);
124.           // "middle" messages will not cause an invocation.
125.         });
126.     });
127.   });


File: tests/integration-all/sns/tests.js
Line number range: 129 - 142
Content:
129.   describe('Existing Setup', () => {
130.     it('should invoke on an existing topic message', () => {
131.       const functionName = 'snsExisting';
132.       const markers = getMarkers(functionName);
133.       const message = 'Hello from an existing SNS!';
134. 
135.       return publishSnsMessage(existingTopicName, message)
136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
137.         .then(logs => {
138.           expect(logs).to.include(functionName);
139.           expect(logs).to.include(message);
140.         });
141.     });
142.   });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:27:50,759 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The objective is to deliver 8 complete, self-contained tests with exact paths and line numbers that exercise SNS redrivePolicy and QueuePolicy behavior. Current context shows only excerpts of lib/plugins/aws/package/compile/events/sns/index.test.js and tests/integration-all/sns/tests.js, missing critical setup (describe/beforeEach, awsCompileSNSEvents initialization) and any assertions on QueuePolicy Queues vs Resource needed to capture the bug. Without the full test files, I cannot provide complete test cases with imports and setup.' query='Please provide the full content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and tests/integration-all/sns/tests.js.' extra_requirements='If sharing entire files is not feasible, include at minimum: (a) all imports and test setup/initialization blocks, and (b) all tests that assert SNS redrivePolicy and SQS QueuePolicy properties (Queues and Resource), with exact line numbers.' purpose='I need the complete tests to extract 8 precise, self-contained cases that will catch regressions when fixing redrivePolicy/QueuePolicy references.'
2025-11-13 20:27:50,761 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and tests/integration-all/sns/tests.js.
2025-11-13 20:27:52,434 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.', 'query_extra_requirements': 'If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.', 'query_purpose': 'I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. ", 'start_line_number': 1, 'end_line_number': 7}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });", 'start_line_number': 600, 'end_line_number': 653}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });", 'start_line_number': 42, 'end_line_number': 88}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });", 'start_line_number': 90, 'end_line_number': 149}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });", 'start_line_number': 151, 'end_line_number': 183}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });", 'start_line_number': 217, 'end_line_number': 247}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });", 'start_line_number': 249, 'end_line_number': 277}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });", 'start_line_number': 279, 'end_line_number': 310}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });", 'start_line_number': 562, 'end_line_number': 598}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "1. 'use strict';\n2. \n3. const path = require('path');\n4. const BbPromise = require('bluebird');\n5. const { expect } = require('chai');\n6. \n7. const { getTmpDirPath } = require('../../utils/fs');\n8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');\n9. const {\n10.   createTestService,\n11.   deployService,\n12.   removeService,\n13.   waitForFunctionLogs,\n14. } = require('../../utils/integration');\n15. const { getMarkers } = require('../shared/utils');\n16. ", 'start_line_number': 1, 'end_line_number': 16}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '27.   before(async () => {\n28.     tmpDirPath = getTmpDirPath();\n29.     console.info(`Temporary path: ${tmpDirPath}`);\n30.     const serverlessConfig = await createTestService(tmpDirPath, {\n31.       templateDir: path.join(__dirname, \'service\'),\n32.       filesToAdd: [path.join(__dirname, \'..\', \'shared\')],\n33.       serverlessConfigHook:\n34.         // Ensure unique topics (to avoid collision among concurrent CI runs)\n35.         config => {\n36.           minimalTopicName = `${config.service}-minimal`;\n37.           filteredTopicName = `${config.service}-filtered`;\n38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;\n39.           existingTopicName = `${config.service}-existing`;\n40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;\n41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;\n42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;\n43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;\n44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;\n45.           config.functions.snsExisting.events[0].sns.arn[\'Fn::Join\'][1][3] = existingTopicName;\n46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;\n47.         },\n48.     });\n49.     serviceName = serverlessConfig.service;\n50.     stackName = `${serviceName}-${stage}`;\n51.     // create "existing" SNS topics\n52.     // NOTE: deployment can only be done once the SNS topics are created\n53.     console.info(`Creating SNS topic "${existingTopicName}"...`);\n54.     return createSnsTopic(existingTopicName).then(() => {\n55.       console.info(`Deploying "${stackName}" service...`);\n56.       return deployService(tmpDirPath);\n57.     });\n58.   });', 'start_line_number': 27, 'end_line_number': 58}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "67.   describe('Minimal Setup', () => {\n68.     it('should invoke on a topic message', () => {\n69.       const functionName = 'snsMinimal';\n70.       const markers = getMarkers(functionName);\n71.       const message = 'Hello from SNS!';\n72. \n73.       return publishSnsMessage(minimalTopicName, message)\n74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n75.         .then(logs => {\n76.           expect(logs).to.include(functionName);\n77.           expect(logs).to.include(message);\n78.         });\n79.     });\n80.   });", 'start_line_number': 67, 'end_line_number': 80}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '82.   describe(\'Multiple and Filtered Setup\', () => {\n83.     it(\'should invoke on a topic message that matches filter\', () => {\n84.       const leftFunctionName = \'snsMultipleFilteredLeft\';\n85.       const leftMarkers = getMarkers(leftFunctionName);\n86.       const rightFunctionName = \'snsMultipleFilteredRight\';\n87.       const rightMarkers = getMarkers(rightFunctionName);\n88.       const leftMessage = \'Hello to the left-side from SNS!\';\n89.       const rightMessage = \'Hello to the right-side from SNS!\';\n90.       const middleMessage = \'Hello to the middle-side from SNS!\';\n91.       const leftAttributes = { side: { DataType: \'String\', StringValue: \'left\' } };\n92.       const middleAttributes = { side: { DataType: \'String\', StringValue: \'middle\' } };\n93.       const rightAttributes = { side: { DataType: \'String\', StringValue: \'right\' } };\n94. \n95.       return BbPromise.all([\n96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),\n97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),\n98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),\n99.       ])\n100.         .then(() =>\n101.           BbPromise.all([\n102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),\n103.             waitForFunctionLogs(\n104.               tmpDirPath,\n105.               rightFunctionName,\n106.               rightMarkers.start,\n107.               rightMarkers.end\n108.             ),\n109.           ])\n110.         )\n111.         .then(logs => {\n112.           const leftLogs = logs[0];\n113.           const rightLogs = logs[1];\n114.           // left side is filtered to only get "left" messages from topic:\n115.           expect(leftLogs).to.include(leftFunctionName);\n116.           expect(leftLogs).to.include(leftMessage);\n117.           expect(leftLogs).not.to.include(middleMessage);\n118.           expect(leftLogs).not.to.include(rightMessage);\n119.           // right side is filtered to only get "right" messages from topic:\n120.           expect(rightLogs).to.include(rightFunctionName);\n121.           expect(rightLogs).not.to.include(leftMessage);\n122.           expect(rightLogs).not.to.include(middleMessage);\n123.           expect(rightLogs).to.include(rightMessage);\n124.           // "middle" messages will not cause an invocation.\n125.         });\n126.     });\n127.   });', 'start_line_number': 82, 'end_line_number': 127}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "129.   describe('Existing Setup', () => {\n130.     it('should invoke on an existing topic message', () => {\n131.       const functionName = 'snsExisting';\n132.       const markers = getMarkers(functionName);\n133.       const message = 'Hello from an existing SNS!';\n134. \n135.       return publishSnsMessage(existingTopicName, message)\n136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n137.         .then(logs => {\n138.           expect(logs).to.include(functionName);\n139.           expect(logs).to.include(message);\n140.         });\n141.     });\n142.   });", 'start_line_number': 129, 'end_line_number': 142}]}]
2025-11-13 20:27:52,434 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 1 memories from memory
2025-11-13 20:27:52,434 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 14 contexts from memory
2025-11-13 20:27:52,435 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 14 contexts from memory
2025-11-13 20:27:52,437 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 14 new contexts to 14 existing contexts
2025-11-13 20:27:52,439 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 14 total contexts (removed 14 duplicates)
2025-11-13 20:27:52,440 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - INFO - Reached max_refined_query_loop, not asking for more context
2025-11-13 20:27:52,443 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. ", start_line_number=1, end_line_number=7), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });", start_line_number=42, end_line_number=88), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });", start_line_number=90, end_line_number=149), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });", start_line_number=151, end_line_number=183), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });", start_line_number=217, end_line_number=247), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });", start_line_number=249, end_line_number=277), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });", start_line_number=279, end_line_number=310), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });", start_line_number=562, end_line_number=598), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });", start_line_number=600, end_line_number=653), Context(relative_path='tests/integration-all/sns/tests.js', content="1. 'use strict';\n2. \n3. const path = require('path');\n4. const BbPromise = require('bluebird');\n5. const { expect } = require('chai');\n6. \n7. const { getTmpDirPath } = require('../../utils/fs');\n8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');\n9. const {\n10.   createTestService,\n11.   deployService,\n12.   removeService,\n13.   waitForFunctionLogs,\n14. } = require('../../utils/integration');\n15. const { getMarkers } = require('../shared/utils');\n16. ", start_line_number=1, end_line_number=16), Context(relative_path='tests/integration-all/sns/tests.js', content='27.   before(async () => {\n28.     tmpDirPath = getTmpDirPath();\n29.     console.info(`Temporary path: ${tmpDirPath}`);\n30.     const serverlessConfig = await createTestService(tmpDirPath, {\n31.       templateDir: path.join(__dirname, \'service\'),\n32.       filesToAdd: [path.join(__dirname, \'..\', \'shared\')],\n33.       serverlessConfigHook:\n34.         // Ensure unique topics (to avoid collision among concurrent CI runs)\n35.         config => {\n36.           minimalTopicName = `${config.service}-minimal`;\n37.           filteredTopicName = `${config.service}-filtered`;\n38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;\n39.           existingTopicName = `${config.service}-existing`;\n40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;\n41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;\n42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;\n43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;\n44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;\n45.           config.functions.snsExisting.events[0].sns.arn[\'Fn::Join\'][1][3] = existingTopicName;\n46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;\n47.         },\n48.     });\n49.     serviceName = serverlessConfig.service;\n50.     stackName = `${serviceName}-${stage}`;\n51.     // create "existing" SNS topics\n52.     // NOTE: deployment can only be done once the SNS topics are created\n53.     console.info(`Creating SNS topic "${existingTopicName}"...`);\n54.     return createSnsTopic(existingTopicName).then(() => {\n55.       console.info(`Deploying "${stackName}" service...`);\n56.       return deployService(tmpDirPath);\n57.     });\n58.   });', start_line_number=27, end_line_number=58), Context(relative_path='tests/integration-all/sns/tests.js', content="67.   describe('Minimal Setup', () => {\n68.     it('should invoke on a topic message', () => {\n69.       const functionName = 'snsMinimal';\n70.       const markers = getMarkers(functionName);\n71.       const message = 'Hello from SNS!';\n72. \n73.       return publishSnsMessage(minimalTopicName, message)\n74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n75.         .then(logs => {\n76.           expect(logs).to.include(functionName);\n77.           expect(logs).to.include(message);\n78.         });\n79.     });\n80.   });", start_line_number=67, end_line_number=80), Context(relative_path='tests/integration-all/sns/tests.js', content='82.   describe(\'Multiple and Filtered Setup\', () => {\n83.     it(\'should invoke on a topic message that matches filter\', () => {\n84.       const leftFunctionName = \'snsMultipleFilteredLeft\';\n85.       const leftMarkers = getMarkers(leftFunctionName);\n86.       const rightFunctionName = \'snsMultipleFilteredRight\';\n87.       const rightMarkers = getMarkers(rightFunctionName);\n88.       const leftMessage = \'Hello to the left-side from SNS!\';\n89.       const rightMessage = \'Hello to the right-side from SNS!\';\n90.       const middleMessage = \'Hello to the middle-side from SNS!\';\n91.       const leftAttributes = { side: { DataType: \'String\', StringValue: \'left\' } };\n92.       const middleAttributes = { side: { DataType: \'String\', StringValue: \'middle\' } };\n93.       const rightAttributes = { side: { DataType: \'String\', StringValue: \'right\' } };\n94. \n95.       return BbPromise.all([\n96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),\n97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),\n98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),\n99.       ])\n100.         .then(() =>\n101.           BbPromise.all([\n102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),\n103.             waitForFunctionLogs(\n104.               tmpDirPath,\n105.               rightFunctionName,\n106.               rightMarkers.start,\n107.               rightMarkers.end\n108.             ),\n109.           ])\n110.         )\n111.         .then(logs => {\n112.           const leftLogs = logs[0];\n113.           const rightLogs = logs[1];\n114.           // left side is filtered to only get "left" messages from topic:\n115.           expect(leftLogs).to.include(leftFunctionName);\n116.           expect(leftLogs).to.include(leftMessage);\n117.           expect(leftLogs).not.to.include(middleMessage);\n118.           expect(leftLogs).not.to.include(rightMessage);\n119.           // right side is filtered to only get "right" messages from topic:\n120.           expect(rightLogs).to.include(rightFunctionName);\n121.           expect(rightLogs).not.to.include(leftMessage);\n122.           expect(rightLogs).not.to.include(middleMessage);\n123.           expect(rightLogs).to.include(rightMessage);\n124.           // "middle" messages will not cause an invocation.\n125.         });\n126.     });\n127.   });', start_line_number=82, end_line_number=127), Context(relative_path='tests/integration-all/sns/tests.js', content="129.   describe('Existing Setup', () => {\n130.     it('should invoke on an existing topic message', () => {\n131.       const functionName = 'snsExisting';\n132.       const markers = getMarkers(functionName);\n133.       const message = 'Hello from an existing SNS!';\n134. \n135.       return publishSnsMessage(existingTopicName, message)\n136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n137.         .then(logs => {\n138.           expect(logs).to.include(functionName);\n139.           expect(logs).to.include(message);\n140.         });\n141.     });\n142.   });", start_line_number=129, end_line_number=142)]
2025-11-13 20:28:23,020 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_tests_selection_node - DEBUG - Model response: selected_tests=[RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: This test directly exercises the SNS redrivePolicy path, verifying that a dead-letter queue (DLQ) is wired via deadLetterTargetArn and that a QueuePolicy resource is produced. The reported bug is about incorrect ARN vs Ref usage when creating the QueuePolicy for the DLQ, so any fix will most likely affect this flow.\n2. Impact likelihood: Adjusting how the QueuePolicy is constructed (Resource as GetAtt Arn and Queues as Ref/URL) could change generated resources or their properties. This test will detect regressions in producing RedrivePolicy and the QueuePolicy resource.\n3. Not skipped: This is a unit test in the compile SNSEvents suite and runs in normal test runs.', test_identifier='lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: Validates the baseline SNS event compilation (topics, subscriptions, permissions, and filterPolicy). The redrivePolicy fix should not break standard SNS event generation; this test ensures that.\n2. Impact likelihood: Changes in compilation logic to handle DLQ could inadvertently affect the default SNS path (resource creation/IDs, permissions, filter policy wiring). This test will catch such regressions.\n3. Not skipped: It is a standard unit test run by default.', test_identifier='lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: Ensures correct behavior when a topic is defined in CloudFormation resources rather than inferred. The DLQ-related changes must not disrupt referencing existing topics.\n2. Impact likelihood: Modifications around resource resolution or logical ID generation for SNS events (introduced by fixing redrivePolicy handling) could affect how existing topics are linked to subscriptions and permissions. This test guards against that.\n3. Not skipped: This unit test runs in normal CI.', test_identifier='lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: Confirms deduplication of topic resources when referenced multiple times. Redrive policy logic may introduce or alter internal mappings during compilation; dedup behavior must remain intact.\n2. Impact likelihood: Fixes in compilation could inadvertently cause duplicate topics or alter logical IDs. This test is likely to fail if such regressions occur.\n3. Not skipped: It is part of the normal unit test suite.', test_identifier='lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: Covers a more complex SNS configuration with both arn and topicName plus filterPolicy. While not using redrivePolicy, it validates that other SNS compilation branches still work after changing the resource construction for DLQs.\n2. Impact likelihood: Broad changes to compilation to fix redrivePolicy can affect how subscriptions, permissions, and filter policies are generated, especially when arn and topicName interplay is involved. This test will detect regressions in those code paths.\n3. Not skipped: It is a normal unit test that runs by default.', test_identifier='lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object')]
2025-11-13 20:28:23,020 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_tests_selection_node - DEBUG - 5 tests selected as regression tests
2025-11-13 20:28:23,022 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:28:23,022 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:28:27,537 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XYLyAxVYaLpcqfMOtnjvNx5X', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 218, 'prompt_tokens': 675, 'total_tokens': 893, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0c8aab16-2694-44b8-855f-3ca5fb9a5984-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_XYLyAxVYaLpcqfMOtnjvNx5X', 'type': 'tool_call'}] usage_metadata={'input_tokens': 675, 'output_tokens': 218, 'total_tokens': 893, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:28:27,540 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:28:27,642 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:28:27,642 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1324
drwxr-xr-x   1 root root    4096 Aug 28 02:06 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:25 [01;34m..[0m
-rw-rw-r--   1 root root      35 Aug 28 02:06 .codecov.yml
-rw-rw-r--   1 root root     273 Aug 28 02:06 .editorconfig
drwxrwxr-x   7 root root    4096 Aug 28 02:06 [01;34m.git[0m
drwxrwxr-x   3 root root    4096 Aug 28 02:06 [01;34m.github[0m
-rwxrwxr-x   1 root root      90 Aug 28 02:06 [01;32m.gitignore[0m
-rw-rw-r--   1 root root   13275 Aug 28 02:06 .travis.yml
-rw-rw-r--   1 root root    5152 Aug 28 02:06 0.5.x-RESOURCES.md
-rw-rw-r--   1 root root  124479 Aug 28 02:06 CHANGELOG.md
-rw-rw-r--   1 root root    3292 Aug 28 02:06 CODE_OF_CONDUCT.md
-rw-rw-r--   1 root root    4867 Aug 28 02:06 CONTRIBUTING.md
-rw-rw-r--   1 root root     130 Aug 28 02:06 Dockerfile
-rw-rw-r--   1 root root    1086 Aug 28 02:06 LICENSE.txt
-rw-rw-r--   1 root root   13197 Aug 28 02:06 README.md
-rw-rw-r--   1 root root    7651 Aug 28 02:06 README_CN.md
-rw-rw-r--   1 root root    5539 Aug 28 02:06 RELEASE_PROCESS.md
-rw-rw-r--   1 root root    3896 Aug 28 02:06 VERSIONING.md
drwxrwxr-x   2 root root    4096 Aug 28 02:06 [01;34massets[0m
drwxrwxr-x   2 root root    4096 Aug 28 02:06 [01;34mbin[0m
-rw-rw-r--   1 root root     924 Aug 28 02:06 commitlint.config.js
-rw-rw-r--   1 root root    3970 Aug 28 02:06 docker-compose.yml
drwxrwxr-x   5 root root    4096 Aug 28 02:06 [01;34mdocs[0m
drwxrwxr-x   5 root root    4096 Aug 28 02:06 [01;34mlib[0m
drwxr-xr-x 829 root root   28672 Aug 28 02:06 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1042361 Aug 28 02:06 package-lock.json
-rw-rw-r--   1 root root    6325 Aug 28 02:06 package.json
-rw-rw-r--   1 root root      86 Aug 28 02:06 prettier.config.js
drwxrwxr-x   3 root root    4096 Aug 28 02:06 [01;34mscripts[0m
drwxrwxr-x   8 root root    4096 Aug 28 02:06 [01;34mtests[0m
[?2004l
2025-11-13 20:28:30,818 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0CohkKCxvlRtH0refrcDcwrq', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 1617, 'total_tokens': 1707, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--19582991-e8ab-4875-aca9-4b31e62c34de-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_0CohkKCxvlRtH0refrcDcwrq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1617, 'output_tokens': 90, 'total_tokens': 1707, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:28:30,821 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:28:30,923 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:28:30,923 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.64.0",
  "engines": {
    "node": ">=6.0"
  },
  "engineStrict": true,
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "author": "serverless.com",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/serverless/serverless"
  },
  "keywords": [
    "serverless",
    "serverless framework",
    "serverless applications",
    "serverless modules",
    "api gateway",
    "lambda",
    "aws",
    "aws lambda",
    "amazon",
    "amazon web services",
    "azure",
    "azure functions",
    "google cloud functions",
    "apache open whisk",
    "iot",
    "internet of things",
    "serverless.com"
  ],
  "files": [
    "bin",
    "lib",
    "scripts/postinstall.js",
    "scripts/preuninstall.js",
    "scripts/pre-release.js",
    "package.json",
    "README.md",
    "LICENSE.txt",
    "CHANGELOG.md"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "commitlint:pull-request": "commitlint -f HEAD~1",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node tests/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 tests/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha tests/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check tests/integration-package/**/*.tests.js",
    "lint": "eslint . --cache",
    "lint:fix": "npm run lint -- --fix",
    "lint:updated": "pipe-git-updated --ext=js -- eslint --cache",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c --ignore-path .gitignore \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write --ignore-path .gitignore \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/*"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "lib/plugins/create/templates/**",
    "lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./tests/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "tests/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    }
  },
  "devDependencies": {
    "@commitlint/cli": "^8.3.5",
    "@serverless/eslint-config": "^1.2.1",
    "@serverless/test": "^3.5.2",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "eslint": "^6.8.0",
    "eslint-plugin-import": "^2.20.1",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "log": "^6.0.0",
    "mocha": "^6.2.2",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^14.1.1",
    "pkg": "^4.4.3",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^7.5.0",
    "sinon-chai": "^3.4.0",
    "standard-version": "^7.1.0",
    "strip-ansi": "^5.2.0",
    "ws": "^7.2.1",
    "xml2js": "^0.4.23"
  },
  "dependencies": {
    "@serverless/cli": "^1.4.0",
    "@serverless/enterprise-plugin": "^3.4.0",
    "archiver": "^1.3.0",
    "async": "^1.5.2",
    "aws-sdk": "^2.620.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.0",
    "ci-info": "^1.6.0",
    "d": "^1.0.1",
    "dayjs": "^1.8.20",
    "decompress": "^4.2.0",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^0.30.0",
    "get-stdin": "^5.0.1",
    "globby": "^6.1.0",
    "graceful-fs": "^4.2.3",
    "https-proxy-agent": "^4.0.0",
    "inquirer": "^6.5.2",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.1.1",
    "js-yaml": "^3.13.1",
    "json-cycle": "^1.3.0",
    "json-refs": "^2.1.7",
    "jszip": "^3.2.2",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.15",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.1",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.0.1",
    "node-fetch": "^1.7.3",
    "object-hash": "^1.3.1",
    "p-limit": "^2.2.2",
    "promise-queue": "^2.2.5",
    "raven": "^1.2.1",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^5.7.1",
    "semver-regex": "^1.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^2.0.3",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^16.1.0"
  }
}
[?2004l
2025-11-13 20:32:20,318 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_i9Kt3ckcajRegl2C4VaYhtTv', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 620, 'prompt_tokens': 3821, 'total_tokens': 4441, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0f91df76-dd75-4b51-a296-61881ed00820-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/package/compile/events/sns/index.test.js"}, 'id': 'call_i9Kt3ckcajRegl2C4VaYhtTv', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3821, 'output_tokens': 620, 'total_tokens': 4441, 'input_token_details': {'audio': 0, 'cache_read': 3712}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 20:32:20,322 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/package/compile/events/sns/index.test.js
2025-11-13 20:32:20,424 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:20,424 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/package/compile/event
ts/sns/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsProvider = require('../../../../provider/awsProvider');
const AwsCompileSNSEvents = require('./index');
const Serverless = require('../../../../../../Serverless');

describe('AwsCompileSNSEvents', () => {
  let serverless;
  let awsCompileSNSEvents;

  beforeEach(() => {
    serverless = new Serverless();
    const options = {
      region: 'some-region',
    };
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.setProvider('aws', new AwsProvider(serverless));
    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
  });

  describe('#constructor()', () => {
    it('should set the provider variable to an instance of AwsProvider', () =>
      expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));
  });

  describe('#compileSNSEvents()', () => {
    it('should throw an error if SNS event type is not a string or an object', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: 42,
            },
          ],
        },
      };

      expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);
    });

    it('should create corresponding resources when SNS events are given', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'Topic 1',
                displayName: 'Display name for topic 1',
                filterPolicy: {
                  pet: ['dog', 'cat'],
                },
              },
            },
            {
              sns: 'Topic 2',
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .SNSTopicTopic1.Type
      ).to.equal('AWS::SNS::Topic');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .SNSTopicTopic2.Type
      ).to.equal('AWS::SNS::Topic');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionTopic1SNS.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionTopic2SNS.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionTopic1.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
      ).to.eql({ pet: ['dog', 'cat'] });
    });

    it('should create corresponding resources when topic is defined in resources', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'Topic 1',
                displayName: 'Display name for topic 1',
                filterPolicy: {
                  pet: ['dog', 'cat'],
                },
              },
            },
            {
              sns: 'Topic 2',
            },
          ],
        },
      };

      Object.assign(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
        {
          SNSTopicTopic2: {
            Type: 'AWS::SNS::Topic',
            Properties: {
              TopicName: 'Topic 2',
              DisplayName: 'Display name for topic 2',
            },
          },
        }
      );

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .SNSTopicTopic1.Type
      ).to.equal('AWS::SNS::Topic');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .SNSTopicTopic2.Type
      ).to.equal('AWS::SNS::Topic');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionTopic1SNS.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionTopic2SNS.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionTopic1.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
      ).to.eql({ pet: ['dog', 'cat'] });
    });

    it('should create single SNS topic when the same topic is referenced repeatedly', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'Topic 1',
                displayName: 'Display name for topic 1',
              },
            },
            {
              sns: 'Topic 1',
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .SNSTopicTopic1.Type
      ).to.equal('AWS::SNS::Topic');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionTopic1SNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should throw an error when the event an object and the displayName is not given', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                displayName: 'Display name for topic 1',
              },
            },
          ],
        },
      };

      expect(() => {
        awsCompileSNSEvents.compileSNSEvents();
      }).to.throw(Error);
[?2004l
2025-11-13 20:32:22,215 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_jcPKvOl8MzZxUIMpwiWFSUWW', 'function': {'arguments': '{"command":"sed -n \'200,400p\' lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 38, 'prompt_tokens': 5297, 'total_tokens': 5335, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6542aa54-682d-4f95-9601-5968361b1e34-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,400p' lib/plugins/aws/package/compile/events/sns/index.test.js"}, 'id': 'call_jcPKvOl8MzZxUIMpwiWFSUWW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5297, 'output_tokens': 38, 'total_tokens': 5335, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:22,219 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,400p' lib/plugins/aws/package/compile/events/sns/index.test.js
2025-11-13 20:32:22,320 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:22,320 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,400p' lib/plugins/aws/package/compile/eve
ents/sns/index.test.js
[?2004l
      }).to.throw(Error);
    });

    it('should not create corresponding resources when SNS events are not given', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });

    it('should create SNS topic when arn is given as a string', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: 'arn:aws:foo',
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionFooSNS.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Properties.FilterPolicy
      ).to.equal(undefined);
    });

    it('should create SNS topic when only arn is given as an object property', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                arn: 'arn:aws:sns:region:accountid:foo',
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionFooSNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                arn: 'arn:aws:sns:some-other-region:accountid:foo',
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();
      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Properties.Region
      ).to.equal('some-other-region');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionFooSNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();
      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Properties.Region
      ).to.equal('${AWS::Region}');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionFooSNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should throw an error when the arn an object and the value is not a string', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                arn: 123,
              },
            },
          ],
        },
      };

      expect(() => {
        awsCompileSNSEvents.compileSNSEvents();
      }).to.throw(Error);
    });

    it('should create SNS topic when both arn and topicName are given as object properties', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'bar',
                arn: 'arn:aws:sns:region:accountid:bar',
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionBar.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionBarSNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'first',
[?2004l
2025-11-13 20:32:23,376 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_LEJeS9JRLy4xeDbYsVogOStC', 'function': {'arguments': '{"command":"sed -n \'400,800p\' lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 38, 'prompt_tokens': 6751, 'total_tokens': 6789, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0ac61799-a955-414b-8797-cd00d56a7995-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '400,800p' lib/plugins/aws/package/compile/events/sns/index.test.js"}, 'id': 'call_LEJeS9JRLy4xeDbYsVogOStC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6751, 'output_tokens': 38, 'total_tokens': 6789, 'input_token_details': {'audio': 0, 'cache_read': 3712}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:23,379 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: sed -n '400,800p' lib/plugins/aws/package/compile/events/sns/index.test.js
2025-11-13 20:32:23,480 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:23,481 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '400,800p' lib/plugins/aws/package/compile/eve
ents/sns/index.test.js
[?2004l
                topicName: 'first',
                arn: 'arn:aws:sns:region-1:accountid:bar',
              },
            },
            {
              sns: {
                topicName: 'second',
                arn: 'arn:aws:sns:region-2:accountid:bar',
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(4);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFirst.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionSecond.Type
      ).to.equal('AWS::SNS::Subscription');
    });

    it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'foo',
                arn: 'arn:aws:sns:region:accountid:bar',
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionFoo.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionFooSNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    // eslint-disable-next-line max-len
    it('should create SNS topic when arn object and topicName are given as object properties', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'bar',
                arn: {
                  'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
                },
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionBar.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionBarSNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    // eslint-disable-next-line max-len
    it('should throw an error when arn object and no topicName are given as object properties', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                arn: {
                  'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
                },
              },
            },
          ],
        },
      };

      expect(() => {
        awsCompileSNSEvents.compileSNSEvents();
      }).to.throw(Error);
    });

    // eslint-disable-next-line max-len
    it('should throw an error when invalid imported arn object is given as object properties', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'bar',
                arn: {
                  'Fn::ImportValue': {
                    Ref: 'BarTopic',
                  },
                },
              },
            },
          ],
        },
      };

      expect(() => {
        awsCompileSNSEvents.compileSNSEvents();
      }).to.throw(Error);

      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'bar',
                arn: {
                  'Fn::ImportValue': {
                    'Fn::GetAtt': ['BarTopic', 'Arn'],
                  },
                },
              },
            },
          ],
        },
      };

      expect(() => {
        awsCompileSNSEvents.compileSNSEvents();
      }).to.throw(Error);
    });

    it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'bar',
                arn: 'arn:aws:sns:region:accountid:bar',
                filterPolicy: {
                  pet: ['dog', 'cat'],
                },
              },
            },
          ],
        },
      };

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        Object.keys(
          awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
        )
      ).to.have.length(2);
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionBar.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionBar.Properties.FilterPolicy
      ).to.eql({ pet: ['dog', 'cat'] });
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionBarSNS.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
      awsCompileSNSEvents.serverless.service.functions = {
        first: {
          events: [
            {
              sns: {
                topicName: 'Topic 1',
                displayName: 'Display name for topic 1',
                redrivePolicy: {
                  deadLetterTargetArn: {
                    'Fn::GetAtt': ['SNSDLQ', 'Arn'],
                  },
                },
              },
            },
          ],
        },
      };

      Object.assign(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
        {
          SNSDLQ: {
            Type: 'AWS::SQS::Queue',
            Properties: {
              QueueName: 'SNSDLQ',
            },
          },
        }
      );

      awsCompileSNSEvents.compileSNSEvents();

      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .SNSTopicTopic1.Type
      ).to.equal('AWS::SNS::Topic');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstLambdaPermissionTopic1SNS.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionTopic1.Type
      ).to.equal('AWS::SNS::Subscription');
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
      ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
      expect(
        awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .FirstEventSourceMappingSQSTopic1DLQ.Type
      ).to.equal('AWS::SQS::QueuePolicy');
    });
  });
});
[?2004l
2025-11-13 20:32:32,292 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_IRda0uxPU5B2byCcndpUTRQK', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js --grep \\"should link topic to corresponding dlq when redrivePolicy is defined|should create corresponding resources when SNS events are given|should create corresponding resources when topic is defined in resources|should create single SNS topic when the same topic is referenced repeatedly|should create SNS topic when arn, topicName, and filterPolicy are given as object\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1007, 'prompt_tokens': 8520, 'total_tokens': 9527, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2b299116-0400-4f78-a3d3-3e2f588cde6a-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js --grep "should link topic to corresponding dlq when redrivePolicy is defined|should create corresponding resources when SNS events are given|should create corresponding resources when topic is defined in resources|should create single SNS topic when the same topic is referenced repeatedly|should create SNS topic when arn, topicName, and filterPolicy are given as object"'}, 'id': 'call_IRda0uxPU5B2byCcndpUTRQK', 'type': 'tool_call'}] usage_metadata={'input_tokens': 8520, 'output_tokens': 1007, 'total_tokens': 9527, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 20:32:32,295 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js --grep "should link topic to corresponding dlq when redrivePolicy is defined|should create corresponding resources when SNS events are given|should create corresponding resources when topic is defined in resources|should create single SNS topic when the same topic is referenced repeatedly|should create SNS topic when arn, topicName, and filterPolicy are given as object"
2025-11-13 20:32:33,309 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:33,309 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js --grep "should link topic to corresponding dlq whe
en redrivePolicy is defined|should create corresponding resources when SNS events
s are given|should create corresponding resources when topic is defined in resour
rces|should create single SNS topic when the same topic is referenced repeatedly|
|should create SNS topic when arn, topicName, and filterPolicy are given as objec
ct"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when SNS events are given[0m
    [32m  ✓[0m[90m should create corresponding resources when topic is defined in resources[0m
    [32m  ✓[0m[90m should create single SNS topic when the same topic is referenced repeatedly[0m
    [32m  ✓[0m[90m should create SNS topic when arn, topicName, and filterPolicy are given as object[0m
    [32m  ✓[0m[90m should link topic to corresponding dlq when redrivePolicy is defined[0m


[92m [0m[32m 5 passing[0m[90m (23ms)[0m

(node:270) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:32:35,470 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n5 tests run. All selected tests passed.\nExact output:\n  AwsCompileSNSEvents\n    #compileSNSEvents()\n      ✓ should create corresponding resources when SNS events are given\n      ✓ should create corresponding resources when topic is defined in resources\n      ✓ should create single SNS topic when the same topic is referenced repeatedly\n      ✓ should create SNS topic when arn, topicName, and filterPolicy are given as object\n      ✓ should link topic to corresponding dlq when redrivePolicy is defined\n\n  5 passing (23ms)\n\n(node:270) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 202, 'prompt_tokens': 9075, 'total_tokens': 9277, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--d5a6c802-d327-4683-9d8f-f10bbaf6dcba-0' usage_metadata={'input_tokens': 9075, 'output_tokens': 202, 'total_tokens': 9277, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:35,472 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined
lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given
lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources
lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly
lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
5 tests run. All selected tests passed.
Exact output:
  AwsCompileSNSEvents
    #compileSNSEvents()
      ✓ should create corresponding resources when SNS events are given
      ✓ should create corresponding resources when topic is defined in resources
      ✓ should create single SNS topic when the same topic is referenced repeatedly
      ✓ should create SNS topic when arn, topicName, and filterPolicy are given as object
      ✓ should link topic to corresponding dlq when redrivePolicy is defined

  5 passing (23ms)

(node:270) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:32:42,768 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object'] regression_test_fail_log='' total_tests_run=5
2025-11-13 20:32:42,769 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:32:42,769 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:32:42,770 - thread-135845298308800.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - DEBUG - Selected 5 regression tests: ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:32:42,772 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - Enter bug_reproduction_subgraph
2025-11-13 20:32:42,774 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_reproduction_context_message_node - DEBUG - Sending query to context provider subgraph:
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


OBJECTIVE: Find 5 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 5 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 5 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

2025-11-13 20:32:42,775 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 20:32:42,777 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


OBJECTIVE: Find 5 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 5 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 5 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:33:03,551 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The task requires extracting 5 complete, self-contained test cases with exact imports, setups, assertions, and line numbers. The provided context only lists the file tree without any file contents, so I cannot identify or quote specific tests or line numbers. Given the bug concerns SNS redrive policy referencing an SQS DLQ (ARN vs Ref/URL), the most likely relevant tests are the SNS and SQS integration tests, CloudFormation packaging tests, and AWS naming/unit tests. I need the full content of those files to select and present the exact test cases and preserve line numbers.' query='Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.' extra_requirements='If any file lacks direct coverage of SNS redrive policy/SQS QueuePolicy, please also include any unit tests that compile SNS events or generate SQS policies (with exact paths and line numbers).' purpose='I need the exact test implementations and their line numbers to return 5 complete, relevant test cases demonstrating similar functionality to the reported bug.'
2025-11-13 20:33:03,553 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.
2025-11-13 20:33:06,770 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 20:33:06,770 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 20:33:06,770 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 20:33:06,770 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 20:33:06,772 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 20:33:06,773 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 20:33:06,773 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.
Extra requirements: If any file lacks direct coverage of SNS redrive policy/SQS QueuePolicy, please also include any unit tests that compile SNS events or generate SQS policies (with exact paths and line numbers).
Purpose: I need the exact test implementations and their line numbers to return 5 complete, relevant test cases demonstrating similar functionality to the reported bug.
2025-11-13 20:33:17,472 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nesWBF4rC0kymvOFNT7Dfsbo', 'function': {'arguments': '{"relative_path":"tests/integration-all/sns/tests.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 869, 'prompt_tokens': 2311, 'total_tokens': 3180, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d9e4a506-0c7b-4822-b893-08831c6efbe2-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/integration-all/sns/tests.js'}, 'id': 'call_nesWBF4rC0kymvOFNT7Dfsbo', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2311, 'output_tokens': 869, 'total_tokens': 3180, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 20:33:18,588 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_S6fW4YKTpVqyOGLUADb11E5g', 'function': {'arguments': '{"relative_path":"tests/integration-all/sqs/tests.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 4246, 'total_tokens': 4277, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d689da3b-3365-4fa4-8b83-0da21991f422-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/integration-all/sqs/tests.js'}, 'id': 'call_S6fW4YKTpVqyOGLUADb11E5g', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4246, 'output_tokens': 31, 'total_tokens': 4277, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:33:20,298 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kjdhub4TAYNbToPtZK5OjYdX', 'function': {'arguments': '{"relative_path":"tests/integration-package/cloudformation.tests.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 5160, 'total_tokens': 5191, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9f69da2a-3717-4c6e-b737-38d5f71f849d-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'tests/integration-package/cloudformation.tests.js'}, 'id': 'call_kjdhub4TAYNbToPtZK5OjYdX', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5160, 'output_tokens': 31, 'total_tokens': 5191, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:33:21,647 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7Sfq2ml8nj3Wn23N0bAYDKZ9', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 6823, 'total_tokens': 6854, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e926d4df-56d1-409e-917d-1bf00c6014ec-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.test.js'}, 'id': 'call_7Sfq2ml8nj3Wn23N0bAYDKZ9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6823, 'output_tokens': 31, 'total_tokens': 6854, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:33:22,889 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_LKaBcpSyz2pnZdbb63qXCYHS', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 13203, 'total_tokens': 13233, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f4a635dd-6a89-4066-bcdc-2042dc3098f4-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/index.test.js'}, 'id': 'call_LKaBcpSyz2pnZdbb63qXCYHS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13203, 'output_tokens': 30, 'total_tokens': 13233, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:33:31,741 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7Di3kuR8H8LgRScy1GrQrjKF', 'function': {'arguments': '{"basename":"sns.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 734, 'prompt_tokens': 15327, 'total_tokens': 16061, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--532e28ca-bb12-497a-803f-78af800c01f0-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'sns.test.js'}, 'id': 'call_7Di3kuR8H8LgRScy1GrQrjKF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15327, 'output_tokens': 734, 'total_tokens': 16061, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 20:33:39,926 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_SoFvR75prMZJh1wLiolWzHsh', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 680, 'prompt_tokens': 15377, 'total_tokens': 16057, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6895ea22-5e65-486f-8692-7adbc3f17994-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_SoFvR75prMZJh1wLiolWzHsh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15377, 'output_tokens': 680, 'total_tokens': 16057, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:33:41,724 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pzckYhPq4GzpLSum2ba0YIzY', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 15466, 'total_tokens': 15501, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5120}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0e9052a5-d028-4e8a-94c4-27b0d795e034-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_pzckYhPq4GzpLSum2ba0YIzY', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15466, 'output_tokens': 35, 'total_tokens': 15501, 'input_token_details': {'audio': 0, 'cache_read': 5120}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:00,225 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OF2LKy3nQUQGXL0Qj5HcmmQm', 'function': {'arguments': '{"relative_path":"tests/integration-all/sns/tests.js","start_line":1,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1774, 'prompt_tokens': 20707, 'total_tokens': 22481, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1728, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6c811f8f-81e2-4261-92de-cc463d308bde-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'tests/integration-all/sns/tests.js', 'start_line': 1, 'end_line': 1000}, 'id': 'call_OF2LKy3nQUQGXL0Qj5HcmmQm', 'type': 'tool_call'}] usage_metadata={'input_tokens': 20707, 'output_tokens': 1774, 'total_tokens': 22481, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1728}}
2025-11-13 20:34:02,187 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_P54YCeZ410yfRYWKlWysWvxT', 'function': {'arguments': '{"relative_path":"tests/integration-all/sqs/tests.js","start_line":1,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 22651, 'total_tokens': 22691, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 6784}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ddeff988-c52a-408d-85ad-1efffad412c7-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'tests/integration-all/sqs/tests.js', 'start_line': 1, 'end_line': 1000}, 'id': 'call_P54YCeZ410yfRYWKlWysWvxT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 22651, 'output_tokens': 40, 'total_tokens': 22691, 'input_token_details': {'audio': 0, 'cache_read': 6784}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:03,926 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4cuQezfH3ocJWKpEzkfJMn2V', 'function': {'arguments': '{"relative_path":"tests/integration-package/cloudformation.tests.js","start_line":1,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 23574, 'total_tokens': 23614, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4224}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5166e1dd-2fac-4759-b411-d458b947ff40-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'tests/integration-package/cloudformation.tests.js', 'start_line': 1, 'end_line': 1000}, 'id': 'call_4cuQezfH3ocJWKpEzkfJMn2V', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23574, 'output_tokens': 40, 'total_tokens': 23614, 'input_token_details': {'audio': 0, 'cache_read': 4224}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:05,849 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9HsjHZkBQiumGvrT0UEiiI2t', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.test.js","start_line":1,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 25246, 'total_tokens': 25286, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 23552}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4603e8e8-3e97-4dbd-9078-a43a3a10fdfe-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.test.js', 'start_line': 1, 'end_line': 1000}, 'id': 'call_9HsjHZkBQiumGvrT0UEiiI2t', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25246, 'output_tokens': 40, 'total_tokens': 25286, 'input_token_details': {'audio': 0, 'cache_read': 23552}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:19,789 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_u7aMQM2oJQuBcpMPwrxd9IHx', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js","start_line":1,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1138, 'prompt_tokens': 37091, 'total_tokens': 38229, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1088, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--050e3013-5cf0-42c0-aa9b-66e184583932-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'start_line': 1, 'end_line': 2000}, 'id': 'call_u7aMQM2oJQuBcpMPwrxd9IHx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37091, 'output_tokens': 1138, 'total_tokens': 38229, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1088}}
2025-11-13 20:34:24,920 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_cej7d4zG4wAkXo24WoTOZQF9', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sqs/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 360, 'prompt_tokens': 43852, 'total_tokens': 44212, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a8a820b2-be61-418f-a6a4-1ac95480b22f-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sqs/index.test.js'}, 'id': 'call_cej7d4zG4wAkXo24WoTOZQF9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 43852, 'output_tokens': 360, 'total_tokens': 44212, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:34:26,820 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xHZESfdcy2FCyIgxR9WIuEAd', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sqs/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 43941, 'total_tokens': 43976, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 25216}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--778c7bbc-34b5-4405-9cf4-6cffde433b27-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sqs/index.test.js'}, 'id': 'call_xHZESfdcy2FCyIgxR9WIuEAd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 43941, 'output_tokens': 35, 'total_tokens': 43976, 'input_token_details': {'audio': 0, 'cache_read': 25216}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:34,959 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ry4eDVGGLX13uLdCt8sRJWQE', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sqs/index.test.js","start_line":500,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 562, 'prompt_tokens': 49519, 'total_tokens': 50081, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 15232}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--150d7950-5b0c-4315-a1d4-657801f5cdb6-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sqs/index.test.js', 'start_line': 500, 'end_line': 2000}, 'id': 'call_ry4eDVGGLX13uLdCt8sRJWQE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 49519, 'output_tokens': 562, 'total_tokens': 50081, 'input_token_details': {'audio': 0, 'cache_read': 15232}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:34:51,786 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='- Retrieved and returned the full contents with line numbers for all five requested tests: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.\n- Because those do not directly cover SNS redrive policy or SQS QueuePolicy, I also included the relevant unit tests: lib/plugins/aws/package/compile/events/sns/index.test.js (covers SNS redrivePolicy linking to DLQ and creation of AWS::SQS::QueuePolicy) and lib/plugins/aws/package/compile/events/sqs/index.test.js (covers generating SQS IAM policies/event source mappings).\n- All files are shown with exact paths and line numbers in the outputs so you can extract 5 complete, relevant test cases aligned with the reported bug.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1336, 'prompt_tokens': 50694, 'total_tokens': 52030, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--11359430-61b0-45b9-9253-d5448f407a63-0' usage_metadata={'input_tokens': 50694, 'output_tokens': 1336, 'total_tokens': 52030, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-13 20:34:51,791 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If any file lacks direct coverage of SNS redrive policy/SQS QueuePolicy, please also include any unit tests that compile SNS events or generate SQS policies (with exact paths and line numbers).
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need the exact test implementations and their line numbers to return 5 complete, relevant test cases demonstrating similar functionality to the reported bug.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/plugins/aws/lib/naming.test.js
Line number range: 1 - 1000
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. 
5. const SDK = require('../provider/awsProvider');
6. const Serverless = require('../../../Serverless');
7. 
8. describe('#naming()', () => {
9.   let options;
10.   let serverless;
11.   let sdk;
12. 
13.   beforeEach(() => {
14.     options = {
15.       stage: 'dev',
16.       region: 'us-east-1',
17.     };
18.     serverless = new Serverless(options);
19.     sdk = new SDK(serverless, options);
20.   });
21. 
22.   describe('#normalizeName()', () => {
23.     it('should capitalize the first letter', () => {
24.       expect(sdk.naming.normalizeName('name')).to.equal('Name');
25.     });
26. 
27.     it('should have no effect on caps', () => {
28.       expect(sdk.naming.normalizeName('Name')).to.equal('Name');
29.     });
30. 
31.     it('should have no effect on the rest of the name', () => {
32.       expect(sdk.naming.normalizeName('nAME')).to.equal('NAME');
33.     });
34.   });
35. 
36.   describe('#normalizeNameToAlphaNumericOnly()', () => {
37.     it('should strip non-alpha-numeric characters', () => {
38.       expect(
39.         sdk.naming.normalizeNameToAlphaNumericOnly('`!@#$%^&*()-={}|[]\\:";\'<>?,./')
40.       ).to.equal('');
41.     });
42. 
43.     it('should apply normalizeName to the remaining characters', () => {
44.       expect(sdk.naming.normalizeNameToAlphaNumericOnly('a-b-c')).to.equal('Abc');
45.     });
46.   });
47. 
48.   describe('#normalizePathPart()', () => {
49.     it('converts `-` to `Dash`', () => {
50.       expect(sdk.naming.normalizePathPart('a-path')).to.equal('ADashpath');
51.     });
52. 
53.     it('converts variable declarations (`${var}`) to `VariableVar`', () => {
54.       expect(sdk.naming.normalizePathPart('${variable}')).to.equal('VariableVar');
55.     });
56. 
57.     it('converts variable declarations prefixes to `VariableVarpath`', () => {
58.       expect(sdk.naming.normalizePathPart('${variable}Path')).to.equal('VariableVarpath');
59.     });
60. 
61.     it('converts variable declarations suffixes to `PathvariableVar`', () => {
62.       expect(sdk.naming.normalizePathPart('path${variable}')).to.equal('PathvariableVar');
63.     });
64. 
65.     it('converts variable declarations in center to `PathvariableVardir`', () => {
66.       expect(sdk.naming.normalizePathPart('path${variable}Dir')).to.equal('PathvariableVardir');
67.     });
68.   });
69. 
70.   describe('#getServiceEndpointRegex()', () => {
71.     it('should match the prefix', () => {
72.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpoint')).to.equal(true);
73.     });
74. 
75.     it('should not match a name without the prefix', () => {
76.       expect(sdk.naming.getServiceEndpointRegex().test('NotThePrefixServiceEndpoint')).to.equal(
77.         false
78.       );
79.     });
80. 
81.     it('should match a name with the prefix', () => {
82.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpointForAService')).to.equal(
83.         true
84.       );
85.     });
86.   });
87. 
88.   describe('#getStackName()', () => {
89.     it('should use the service name & stage if custom stack name not provided', () => {
90.       serverless.service.service = 'myService';
91.       expect(sdk.naming.getStackName()).to.equal(
92.         `${serverless.service.service}-${sdk.naming.provider.getStage()}`
93.       );
94.     });
95. 
96.     it('should use the custom stack name if provided', () => {
97.       serverless.service.provider.stackName = 'app-dev-testApp';
98.       serverless.service.service = 'myService';
99.       serverless.service.provider.stage = sdk.naming.provider.getStage();
100.       expect(sdk.naming.getStackName()).to.equal('app-dev-testApp');
101.     });
102.   });
103. 
104.   describe('#getRolePath()', () => {
105.     it('should return `/`', () => {
106.       expect(sdk.naming.getRolePath()).to.equal('/');
107.     });
108.   });
109. 
110.   describe('#getRoleName()', () => {
111.     it('uses the service name, stage, and region to generate a role name', () => {
112.       serverless.service.service = 'myService';
113.       expect(sdk.naming.getRoleName()).to.eql({
114.         'Fn::Join': [
115.           '-',
116.           [
117.             serverless.service.service,
118.             sdk.naming.provider.getStage(),
119.             { Ref: 'AWS::Region' },
120.             'lambdaRole',
121.           ],
122.         ],
123.       });
124.     });
125.   });
126. 
127.   describe('#getRoleLogicalId()', () => {
128.     it('should return the expected role name (IamRoleLambdaExecution)', () => {
129.       expect(sdk.naming.getRoleLogicalId()).to.equal('IamRoleLambdaExecution');
130.     });
131.   });
132. 
133.   describe('#getPolicyName()', () => {
134.     it('should use the stage and service name', () => {
135.       serverless.service.service = 'myService';
136.       expect(sdk.naming.getPolicyName()).to.eql({
137.         'Fn::Join': ['-', [sdk.naming.provider.getStage(), serverless.service.service, 'lambda']],
138.       });
139.     });
140.   });
141. 
142.   describe('#getLogicalLogGroupName()', () => {
143.     it('should prefix the normalized function name to "LogGroup"', () => {
144.       expect(sdk.naming.getLogGroupLogicalId('functionName')).to.equal('FunctionNameLogGroup');
145.     });
146.   });
147. 
148.   describe('#getLogGroupName()', () => {
149.     it('should add the function name to the log group name', () => {
150.       expect(sdk.naming.getLogGroupName('functionName')).to.equal('/aws/lambda/functionName');
151.     });
152.   });
153. 
154.   describe('#getNormalizedFunctionName()', () => {
155.     it('should normalize the given functionName', () => {
156.       expect(sdk.naming.getNormalizedFunctionName('functionName')).to.equal('FunctionName');
157.     });
158. 
159.     it('should normalize the given functionName with an underscore', () => {
160.       expect(sdk.naming.getNormalizedFunctionName('hello_world')).to.equal('HelloUnderscoreworld');
161.     });
162. 
163.     it('should normalize the given functionName with a dash', () => {
164.       expect(sdk.naming.getNormalizedFunctionName('hello-world')).to.equal('HelloDashworld');
165.     });
166.   });
167. 
168.   describe('#extractAuthorizerNameFromArn()', () => {
169.     it('should extract everything after the last colon and dash', () => {
170.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
171.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
172.     });
173.   });
174. 
175.   describe('#extractLambdaNameFromArn()', () => {
176.     it('should extract everything after the last colon', () => {
177.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
178.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal('my-dev-lambda');
179.     });
180.   });
181. 
182.   describe('#getLambdaLogicalId()', () => {
183.     it('should normalize the function name and add the logical suffix', () => {
184.       expect(sdk.naming.getLambdaLogicalId('functionName')).to.equal('FunctionNameLambdaFunction');
185.     });
186.   });
187. 
188.   describe('#getLambdaLogicalIdRegex()', () => {
189.     it('should match the suffix', () => {
190.       expect(sdk.naming.getLambdaLogicalIdRegex().test('LambdaFunction')).to.equal(true);
191.     });
192. 
193.     it('should not match a name without the suffix', () => {
194.       expect(sdk.naming.getLambdaLogicalIdRegex().test('LambdaFunctionNotTheSuffix')).to.equal(
195.         false
196.       );
197.     });
198. 
199.     it('should match a name with the suffix', () => {
200.       expect(sdk.naming.getLambdaLogicalIdRegex().test('AFunctionNameLambdaFunction')).to.equal(
201.         true
202.       );
203.     });
204.   });
205. 
206.   describe('#getWebsocketsApiName()', () => {
207.     it('should return the composition of stage & service name if custom name not provided', () => {
208.       serverless.service.service = 'myService';
209.       expect(sdk.naming.getWebsocketsApiName()).to.equal(
210.         `${sdk.naming.provider.getStage()}-${serverless.service.service}-websockets`
211.       );
212.     });
213. 
214.     it('should return the custom api name if provided', () => {
215.       serverless.service.provider.websocketsApiName = 'app-dev-websockets-testApi';
216.       serverless.service.service = 'myService';
217.       serverless.service.provider.stage = sdk.naming.provider.getStage();
218.       expect(sdk.naming.getWebsocketsApiName()).to.equal('app-dev-websockets-testApi');
219.     });
220.   });
221. 
222.   describe('#getWebsocketsApiLogicalId()', () => {
223.     it('should return the websocket API logical id', () => {
224.       expect(sdk.naming.getWebsocketsApiLogicalId()).to.equal('WebsocketsApi');
225.     });
226.   });
227. 
228.   describe('#getWebsocketsIntegrationLogicalId()', () => {
229.     it('should return the integrations logical id', () => {
230.       expect(sdk.naming.getWebsocketsIntegrationLogicalId('myFunc')).to.equal(
231.         'MyFuncWebsocketsIntegration'
232.       );
233.     });
234.   });
235. 
236.   describe('#getLambdaWebsocketsPermissionLogicalId()', () => {
237.     it('should return the lambda websocket permission logical id', () => {
238.       expect(sdk.naming.getLambdaWebsocketsPermissionLogicalId('myFunc')).to.equal(
239.         'MyFuncLambdaPermissionWebsockets'
240.       );
241.     });
242.   });
243. 
244.   describe('#getNormalizedWebsocketsRouteKey()', () => {
245.     it('should return a normalized version of the route key', () => {
246.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('$connect')).to.equal('Sconnect');
247. 
248.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo/bar')).to.equal('fooSlashbar');
249. 
250.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo-bar')).to.equal('fooDashbar');
251. 
252.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo_bar')).to.equal('fooUnderscorebar');
253. 
254.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo.bar')).to.equal('fooPeriodbar');
255.     });
256. 
257.     it('converts multiple `-` correctly', () => {
258.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('a-longer-path')).to.equal(
259.         'aDashlongerDashpath'
260.       );
261.     });
262. 
263.     it('converts multiple `-` and `_` correctly', () => {
264.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('a-long_er-path_still')).to.equal(
265.         'aDashlongUnderscoreerDashpathUnderscorestill'
266.       );
267.     });
268.   });
269. 
270.   describe('#getWebsocketsRouteLogicalId()', () => {
271.     it('should return the websockets route logical id', () => {
272.       expect(sdk.naming.getWebsocketsRouteLogicalId('$connect')).to.equal(
273.         'SconnectWebsocketsRoute'
274.       );
275.     });
276.   });
277. 
278.   describe('#getWebsocketsDeploymentLogicalId()', () => {
279.     it('should return the websockets deployment logical id', () => {
280.       expect(sdk.naming.getWebsocketsDeploymentLogicalId('Abc+123=')).to.equal(
281.         'WebsocketsDeploymentAbc123'
282.       );
283.     });
284.   });
285. 
286.   describe('#getWebsocketsStageLogicalId()', () => {
287.     it('should return the websockets stage logical id', () => {
288.       expect(sdk.naming.getWebsocketsStageLogicalId()).to.equal('WebsocketsDeploymentStage');
289.     });
290.   });
291. 
292.   describe('#getWebsocketsAuthorizerLogicalId()', () => {
293.     it('should return the websockets authorizer logical id', () => {
294.       expect(sdk.naming.getWebsocketsAuthorizerLogicalId('auth')).to.equal(
295.         'AuthWebsocketsAuthorizer'
296.       );
297.     });
298.   });
299. 
300.   describe('#getWebsocketsLogGroupLogicalId()', () => {
301.     it('should return the Websockets log group logical id', () => {
302.       expect(sdk.naming.getWebsocketsLogGroupLogicalId()).to.equal('WebsocketsLogGroup');
303.     });
304.   });
305. 
306.   describe('#getApiGatewayName()', () => {
307.     it('should return the composition of stage & service name if custom name not provided', () => {
308.       serverless.service.service = 'myService';
309.       expect(sdk.naming.getApiGatewayName()).to.equal(
310.         `${sdk.naming.provider.getStage()}-${serverless.service.service}`
311.       );
312.     });
313. 
314.     it('should return the custom api name if provided', () => {
315.       serverless.service.provider.apiName = 'app-dev-testApi';
316.       serverless.service.service = 'myService';
317.       serverless.service.provider.stage = sdk.naming.provider.getStage();
318.       expect(sdk.naming.getApiGatewayName()).to.equal('app-dev-testApi');
319.     });
320.   });
321. 
322.   describe('#generateApiGatewayDeploymentLogicalId()', () => {
323.     it('should return ApiGatewayDeployment with a suffix', () => {
324.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId(1234)).to.equal(
325.         'ApiGatewayDeployment1234'
326.       );
327.     });
328.   });
329. 
330.   describe('#getRestApiLogicalId()', () => {
331.     it('should return ApiGatewayRestApi', () => {
332.       expect(sdk.naming.getRestApiLogicalId()).to.equal('ApiGatewayRestApi');
333.     });
334.   });
335. 
336.   describe('#getNormalizedAuthorizerName()', () => {
337.     it('normalize the authorizer name', () => {
338.       expect(sdk.naming.getNormalizedAuthorizerName('authorizerName')).to.equal('AuthorizerName');
339.     });
340.   });
341. 
342.   describe('#getAuthorizerLogicalId()', () => {
343.     it('should normalize the authorizer name and add the standard suffix', () => {
344.       expect(sdk.naming.getAuthorizerLogicalId('authorizerName')).to.equal(
345.         'AuthorizerNameApiGatewayAuthorizer'
346.       );
347.     });
348.   });
349. 
350.   describe('#extractAuthorizerNameFromArn()', () => {
351.     it('should extract the authorizer name from an ARN', () => {
352.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
353.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
354.     });
355.   });
356. 
357.   describe('#normalizePath()', () => {
358.     it('should normalize each part of the resource path and remove non-alpha-numeric characters', () => {
359.       expect(sdk.naming.normalizePath('my/path/to/a-${var}-resource')).to.equal(
360.         'MyPathToADashvarVarDashresource'
361.       );
362.     });
363.   });
364. 
365.   describe('#getResourceLogicalId()', () => {
366.     it('should normalize the resource and add the standard suffix', () => {
367.       expect(sdk.naming.getResourceLogicalId('my/path/to/a-${var}-resource')).to.equal(
368.         'ApiGatewayResourceMyPathToADashvarVarDashresource'
369.       );
370.     });
371.   });
372. 
373.   describe('#extractResourceId()', () => {
374.     it('should extract the normalized resource name', () => {
375.       expect(
376.         sdk.naming.extractResourceId('ApiGatewayResourceMyPathToADashvarVarDashResource')
377.       ).to.equal('MyPathToADashvarVarDashResource');
378.     });
379.   });
380. 
381.   describe('#normalizeMethodName()', () => {
382.     it('should capitalize the first letter and lowercase any other characters', () => {
383.       expect(sdk.naming.normalizeMethodName('gET')).to.equal('Get');
384.     });
385.   });
386. 
387.   describe('#getMethodLogicalId()', () => {
388.     it('', () => {
389.       expect(sdk.naming.getMethodLogicalId('ResourceId', 'get')).to.equal(
390.         'ApiGatewayMethodResourceIdGet'
391.       );
392.     });
393.   });
394. 
395.   describe('#getValidatorLogicalId()', () => {
396.     it('', () => {
397.       expect(sdk.naming.getValidatorLogicalId('ResourceId', 'get')).to.equal(
398.         'ApiGatewayMethodResourceIdGetValidator'
399.       );
400.     });
401.   });
402. 
403.   describe('#getModelLogicalId()', () => {
404.     it('', () => {
405.       expect(sdk.naming.getModelLogicalId('ResourceId', 'get', 'application/json')).to.equal(
406.         'ApiGatewayMethodResourceIdGetApplicationJsonModel'
407.       );
408.     });
409.   });
410. 
411.   describe('#getApiKeyLogicalId(keyIndex)', () => {
412.     it('should produce the given index with ApiGatewayApiKey as a prefix', () => {
413.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal('ApiGatewayApiKey1');
414.     });
415. 
416.     it('should support API Key names', () => {
417.       expect(sdk.naming.getApiKeyLogicalId(1, 'free')).to.equal('ApiGatewayApiKeyFree1');
418.     });
419.   });
420. 
421.   describe('#getApiKeyLogicalIdRegex()', () => {
422.     it('should match the prefix', () => {
423.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('ApiGatewayApiKey')).to.equal(true);
424.     });
425. 
426.     it('should not match a name without the prefix', () => {
427.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('NotThePrefixApiGatewayApiKey')).to.equal(
428.         false
429.       );
430.     });
431. 
432.     it('should match a name with the prefix', () => {
433.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('ApiGatewayApiKeySuffix')).to.equal(true);
434.     });
435.   });
436. 
437.   describe('#getUsagePlanLogicalId()', () => {
438.     it('should return the default ApiGateway usage plan logical id', () => {
439.       expect(sdk.naming.getUsagePlanLogicalId()).to.equal('ApiGatewayUsagePlan');
440.     });
441. 
442.     it('should return the named ApiGateway usage plan logical id', () => {
443.       expect(sdk.naming.getUsagePlanLogicalId('free')).to.equal('ApiGatewayUsagePlanFree');
444.     });
445.   });
446. 
447.   describe('#getUsagePlanKeyLogicalId()', () => {
448.     it('should produce the given index with ApiGatewayUsagePlanKey as a prefix', () => {
449.       expect(sdk.naming.getUsagePlanKeyLogicalId(1)).to.equal('ApiGatewayUsagePlanKey1');
450.     });
451. 
452.     it('should support API Key names', () => {
453.       expect(sdk.naming.getUsagePlanKeyLogicalId(1, 'free')).to.equal(
454.         'ApiGatewayUsagePlanKeyFree1'
455.       );
456.     });
457.   });
458. 
459.   describe('#getStageLogicalId()', () => {
460.     it('should return the API Gateway stage logical id', () => {
461.       expect(sdk.naming.getStageLogicalId()).to.equal('ApiGatewayStage');
462.     });
463.   });
464. 
465.   describe('#getApiGatewayLogGroupLogicalId()', () => {
466.     it('should return the API Gateway log group logical id', () => {
467.       expect(sdk.naming.getApiGatewayLogGroupLogicalId()).to.equal('ApiGatewayLogGroup');
468.     });
469.   });
470. 
471.   describe('#getDeploymentBucketLogicalId()', () => {
472.     it('should return "ServerlessDeploymentBucket"', () => {
473.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal('ServerlessDeploymentBucket');
474.     });
475.   });
476. 
477.   describe('#getDeploymentBucketOutputLogicalId()', () => {
478.     it('should return "ServerlessDeploymentBucketName"', () => {
479.       expect(sdk.naming.getDeploymentBucketOutputLogicalId()).to.equal(
480.         'ServerlessDeploymentBucketName'
481.       );
482.     });
483.   });
484. 
485.   describe('#getDeploymentBucketPolicyLogicalId()', () => {
486.     it('should return "ServerlessDeploymentBucketPolicy"', () => {
487.       expect(sdk.naming.getDeploymentBucketPolicyLogicalId()).to.equal(
488.         'ServerlessDeploymentBucketPolicy'
489.       );
490.     });
491.   });
492. 
493.   describe('#normalizeBucketName()', () => {
494.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
495.       expect(sdk.naming.normalizeBucketName('b!u@c#k$e%t^N&a*m(e')).to.equal('BucketName');
496.     });
497.   });
498. 
499.   describe('#getBucketLogicalId()', () => {
500.     it('should normalize the bucket name and add the standard prefix', () => {
501.       expect(sdk.naming.getBucketLogicalId('b!u@c#k$e%t^N&a*m(e')).to.equal('S3BucketBucketName');
502.     });
503.   });
504. 
505.   describe('#normalizeTopicName()', () => {
506.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
507.       expect(sdk.naming.normalizeTopicName('t!o@p#i$c%N^a&m*e')).to.equal('TopicName');
508.     });
509.   });
510. 
511.   describe('#getTopicLogicalId()', () => {
512.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
513.       expect(sdk.naming.getTopicLogicalId('t!o@p#i$c%N^a&m*e')).to.equal('SNSTopicTopicName');
514.     });
515.   });
516. 
517.   describe('#getScheduleId()', () => {
518.     it('should add the standard suffix', () => {
519.       expect(sdk.naming.getScheduleId('functionName')).to.equal('functionNameSchedule');
520.     });
521.   });
522. 
523.   describe('#getScheduleLogicalId()', () => {
524.     it('should normalize the function name and add the standard suffix including the index', () => {
525.       expect(sdk.naming.getScheduleLogicalId('functionName', 0)).to.equal(
526.         'FunctionNameEventsRuleSchedule0'
527.       );
528.     });
529.   });
530. 
531.   describe('#getStreamConsumerName()', () => {
532.     it('should add the standard suffix', () => {
533.       expect(sdk.naming.getStreamConsumerName('functionName', 'streamName')).to.equal(
534.         'functionNamestreamNameConsumer'
535.       );
536.     });
537.   });
538. 
539.   describe('#getStreamConsumerLogicalId()', () => {
540.     it('should normalize the stream consumer name and add the standard suffix', () => {
541.       expect(sdk.naming.getStreamConsumerLogicalId('streamConsumerName')).to.equal(
542.         'StreamConsumerNameStreamConsumer'
543.       );
544.     });
545.   });
546. 
547.   describe('#getCloudWatchEventId()', () => {
548.     it('should add the standard suffix', () => {
549.       expect(sdk.naming.getCloudWatchEventId('functionName')).to.equal(
550.         'functionNameCloudWatchEvent'
551.       );
552.     });
553.   });
554. 
555.   describe('#getCloudWatchEventLogicalId()', () => {
556.     it('should normalize the function name and add the standard suffix including the index', () => {
557.       expect(sdk.naming.getCloudWatchEventLogicalId('functionName', 0)).to.equal(
558.         'FunctionNameEventsRuleCloudWatchEvent0'
559.       );
560.     });
561.   });
562. 
563.   describe('#getCloudWatchLogLogicalId()', () => {
564.     it('should normalize the function name and add the standard suffix including the index', () => {
565.       expect(sdk.naming.getCloudWatchLogLogicalId('functionName', 0)).to.equal(
566.         'FunctionNameLogsSubscriptionFilterCloudWatchLog0'
567.       );
568.     });
569.   });
570. 
571.   describe('#getCognitoUserPoolLogicalId()', () => {
572.     it('should normalize the user pool name and add the standard prefix', () => {
573.       expect(sdk.naming.getCognitoUserPoolLogicalId('us-east-1_v123sDAS1')).to.equal(
574.         'CognitoUserPoolUseast1v123sDAS1'
575.       );
576.     });
577.   });
578. 
579.   describe('#getLambdaS3PermissionLogicalId()', () => {
580.     it('should normalize the function name and add the standard suffix', () => {
581.       expect(sdk.naming.getLambdaS3PermissionLogicalId('functionName', 'bucket')).to.equal(
582.         'FunctionNameLambdaPermissionBucketS3'
583.       );
584.     });
585.   });
586. 
587.   describe('#getLambdaSnsPermissionLogicalId()', () => {
588.     it(
589.       'should normalize the function and topic names and add them as prefix and suffix to the ' +
590.         'standard permission center',
591.       () => {
592.         expect(sdk.naming.getLambdaSnsPermissionLogicalId('functionName', 'topic')).to.equal(
593.           'FunctionNameLambdaPermissionTopicSNS'
594.         );
595.       }
596.     );
597.   });
598. 
599.   describe('#getLambdaSchedulePermissionLogicalId()', () => {
600.     it('should normalize the function name and add the standard suffix including event index', () => {
601.       expect(sdk.naming.getLambdaSchedulePermissionLogicalId('functionName', 0)).to.equal(
602.         'FunctionNameLambdaPermissionEventsRuleSchedule0'
603.       );
604.     });
605.   });
606. 
607.   describe('#getLambdaCloudWatchEventPermissionLogicalId()', () => {
608.     it('should normalize the function name and add the standard suffix including event index', () => {
609.       expect(sdk.naming.getLambdaCloudWatchEventPermissionLogicalId('functionName', 0)).to.equal(
610.         'FunctionNameLambdaPermissionEventsRuleCloudWatchEvent0'
611.       );
612.     });
613.   });
614. 
615.   describe('#getLambdaApiGatewayPermissionLogicalId()', () => {
616.     it('should normalize the function name and append the standard suffix', () => {
617.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId('functionName')).to.equal(
618.         'FunctionNameLambdaPermissionApiGateway'
619.       );
620.     });
621.   });
622. 
623.   describe('#getIotLogicalId()', () => {
624.     it('should normalize the function name and add the standard suffix including the index', () => {
625.       expect(sdk.naming.getIotLogicalId('functionName', 0)).to.equal('FunctionNameIotTopicRule0');
626.     });
627.   });
628. 
629.   describe('#getLambdaIotPermissionLogicalId()', () => {
630.     it('should normalize the function name and add the standard suffix including event index', () => {
631.       expect(sdk.naming.getLambdaIotPermissionLogicalId('functionName', 0)).to.equal(
632.         'FunctionNameLambdaPermissionIotTopicRule0'
633.       );
634.     });
635.   });
636. 
637.   describe('#getLambdaAlexaSkillPermissionLogicalId()', () => {
638.     it('should normalize the function name and append the standard suffix', () => {
639.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName', 2)).to.equal(
640.         'FunctionNameLambdaPermissionAlexaSkill2'
641.       );
642.     });
643. 
644.     it('should normalize the function name and append a default suffix if not defined', () => {
645.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName')).to.equal(
646.         'FunctionNameLambdaPermissionAlexaSkill0'
647.       );
648.     });
649.   });
650. 
651.   describe('#getLambdaAlexaSmartHomePermissionLogicalId()', () => {
652.     it('should normalize the function name and append the standard suffix', () => {
653.       expect(sdk.naming.getLambdaAlexaSmartHomePermissionLogicalId('functionName', 0)).to.equal(
654.         'FunctionNameLambdaPermissionAlexaSmartHome0'
655.       );
656.     });
657.   });
658. 
659.   describe('#getLambdaSnsSubscriptionLogicalId()', () => {
660.     it('should normalize the function name and append the standard suffix', () => {
661.       expect(sdk.naming.getLambdaSnsSubscriptionLogicalId('functionName', 'topicName')).to.equal(
662.         'FunctionNameSnsSubscriptionTopicName'
663.       );
664.     });
665.   });
666. 
667.   describe('#getLambdaCloudWatchLogPermissionLogicalId()', () => {
668.     it('should normalize the function name and add the standard suffix including event index', () => {
669.       expect(sdk.naming.getLambdaCloudWatchLogPermissionLogicalId('functionName')).to.equal(
670.         'FunctionNameLambdaPermissionLogsSubscriptionFilterCloudWatchLog'
671.       );
672.     });
673.   });
674. 
675.   describe('#getLambdaCognitoUserPoolPermissionLogicalId()', () => {
676.     it('should normalize the function name and add the standard suffix', () => {
677.       expect(
678.         sdk.naming.getLambdaCognitoUserPoolPermissionLogicalId(
679.           'functionName',
680.           'Pool1',
681.           'CustomMessage'
682.         )
683.       ).to.equal('FunctionNameLambdaPermissionCognitoUserPoolPool1TriggerSourceCustomMessage');
684.     });
685. 
686.     describe('#getLambdaAlbPermissionLogicalId()', () => {
687.       it('should normalize the function name', () => {
688.         expect(sdk.naming.getLambdaAlbPermissionLogicalId('functionName')).to.equal(
689.           'FunctionNameLambdaPermissionAlb'
690.         );
691.       });
692.     });
693. 
694.     describe('#getLambdaRegisterTargetPermissionLogicalId()', () => {
695.       it('should normalize the function name and add the correct suffix', () => {
696.         expect(sdk.naming.getLambdaRegisterTargetPermissionLogicalId('functionName')).to.equal(
697.           'FunctionNameLambdaPermissionRegisterTarget'
698.         );
699.       });
700.     });
701.   });
702. 
703.   describe('#getQueueLogicalId()', () => {
704.     it('should normalize the function name and add the standard suffix', () => {
705.       expect(sdk.naming.getQueueLogicalId('functionName', 'MyQueue')).to.equal(
706.         'FunctionNameEventSourceMappingSQSMyQueue'
707.       );
708.     });
709.   });
710. 
711.   describe('#getAlbTargetGroupLogicalId()', () => {
712.     it('should normalize the function name', () => {
713.       expect(sdk.naming.getAlbTargetGroupLogicalId('functionName', 'abc123')).to.equal(
714.         'FunctionNameAlbTargetGroupabc123'
715.       );
716.     });
717. 
718.     it('should normalize the function name and add MultiValue prefix if multiValueHeader is true', () => {
719.       expect(sdk.naming.getAlbTargetGroupLogicalId('functionName', 'abc123', true)).to.equal(
720.         'FunctionNameAlbMultiValueTargetGroupabc123'
721.       );
722.     });
723.   });
724. 
725.   describe('#getAlbListenerRuleLogicalId()', () => {
726.     it('should normalize the function name and add an index', () => {
727.       expect(sdk.naming.getAlbListenerRuleLogicalId('functionName', 0)).to.equal(
728.         'FunctionNameAlbListenerRule0'
729.       );
730.     });
731.   });
732. 
733.   describe('#getAlbTargetGroupName()', () => {
734.     it('should return a unique identifier based on the service name, function name, alb id, multi-value attribute and stage', () => {
735.       serverless.service.service = 'myService';
736.       expect(sdk.naming.getAlbTargetGroupName('functionName', 'abc123', true)).to.equal(
737.         '79039bd239ac0b3f6ff6d9296f23e27c'
738.       );
739.     });
740. 
741.     it('should return a prefixed unique identifer of not longer than 32 characters if alb.targetGroupPrefix is set', () => {
742.       serverless.service.service = 'myService';
743.       serverless.service.provider.alb = {};
744.       serverless.service.provider.alb.targetGroupPrefix = 'myPrefix-';
745.       expect(sdk.naming.getAlbTargetGroupName('functionName', 'abc123', true)).to.equal(
746.         'myPrefix-79039bd239ac0b3f6ff6d92'
747.       );
748.     });
749.   });
750. 
751.   describe('#getAlbTargetGroupNameTagValue()', () => {
752.     it('should return the composition of service name, function name, alb id, multi-value attribute and stage', () => {
753.       serverless.service.service = 'myService';
754.       expect(sdk.naming.getAlbTargetGroupNameTagValue('functionName', 'abc123', true)).to.equal(
755.         `${
756.           serverless.service.service
757.         }-functionName-abc123-multi-value-${sdk.naming.provider.getStage()}`
758.       );
759.     });
760.   });
761. 
762.   describe('#getCustomResourcesArtifactName()', () => {
763.     it('should return the custom resources artifact directory name', () => {
764.       expect(sdk.naming.getCustomResourcesArtifactName()).to.equal('custom-resources.zip');
765.     });
766.   });
767. 
768.   describe('#getCustomResourcesRoleLogicalId()', () => {
769.     it('should return the custom resources role logical id', () => {
770.       expect(sdk.naming.getCustomResourcesRoleLogicalId()).to.equal(
771.         'IamRoleCustomResourcesLambdaExecution'
772.       );
773.     });
774.   });
775. 
776.   describe('#getCustomResourceS3HandlerFunctionName()', () => {
777.     it('should return the name of the S3 custom resource handler function', () => {
778.       expect(sdk.naming.getCustomResourceS3HandlerFunctionName()).to.equal(
779.         'custom-resource-existing-s3'
780.       );
781.     });
782.   });
783. 
784.   describe('#getCustomResourceS3HandlerFunctionLogicalId()', () => {
785.     it('should return the logical id of the S3 custom resource handler function', () => {
786.       expect(sdk.naming.getCustomResourceS3HandlerFunctionLogicalId()).to.equal(
787.         'CustomDashresourceDashexistingDashs3LambdaFunction'
788.       );
789.     });
790.   });
791. 
792.   describe('#getCustomResourceS3ResourceLogicalId()', () => {
793.     it('should return the logical id of the S3 custom resource', () => {
794.       const functionName = 'my-function';
795.       expect(sdk.naming.getCustomResourceS3ResourceLogicalId(functionName)).to.equal(
796.         'MyDashfunctionCustomS31'
797.       );
798.     });
799.   });
800. 
801.   describe('#getCustomResourceCognitoUserPoolHandlerFunctionName()', () => {
802.     it('should return the name of the Cognito User Pool custom resource handler function', () => {
803.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionName()).to.equal(
804.         'custom-resource-existing-cup'
805.       );
806.     });
807.   });
808. 
809.   describe('#getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()', () => {
810.     it('should return the logical id of the Cognito User Pool custom resource handler function', () => {
811.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()).to.equal(
812.         'CustomDashresourceDashexistingDashcupLambdaFunction'
813.       );
814.     });
815.   });
816. 
817.   describe('#getCustomResourceCognitoUserPoolResourceLogicalId()', () => {
818.     it('should return the logical id of the Cognito User Pool custom resource', () => {
819.       const functionName = 'my-function';
820.       expect(sdk.naming.getCustomResourceCognitoUserPoolResourceLogicalId(functionName)).to.equal(
821.         'MyDashfunctionCustomCognitoUserPool1'
822.       );
823.     });
824.   });
825. 
826.   describe('#getCustomResourceEventBridgeHandlerFunctionName()', () => {
827.     it('should return the name of the Event Bridge custom resource handler function', () => {
828.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionName()).to.equal(
829.         'custom-resource-event-bridge'
830.       );
831.     });
832.   });
833. 
834.   describe('#getCustomResourceEventBridgeHandlerFunctionLogicalId()', () => {
835.     it('should return the logical id of the Event Bridge custom resource handler function', () => {
836.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId()).to.equal(
837.         'CustomDashresourceDasheventDashbridgeLambdaFunction'
838.       );
839.     });
840.   });
841. 
842.   describe('#getCustomResourceEventBridgeResourceLogicalId()', () => {
843.     it('should return the logical id of the Event Bridge custom resource', () => {
844.       const functionName = 'my-function';
845.       const index = 1;
846.       expect(
847.         sdk.naming.getCustomResourceEventBridgeResourceLogicalId(functionName, index)
848.       ).to.equal('MyDashfunctionCustomEventBridge1');
849.     });
850.   });
851. 
852.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()', () => {
853.     it('should return the name of the APIGW Account CloudWatch role custom resource handler function', () => {
854.       expect(
855.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()
856.       ).to.equal('custom-resource-apigw-cw-role');
857.     });
858.   });
859. 
860.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()', () => {
861.     it('should return the logical id of the APIGW Account CloudWatch role custom resource handler function', () => {
862.       expect(
863.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()
864.       ).to.equal('CustomDashresourceDashapigwDashcwDashroleLambdaFunction');
865.     });
866.   });
867. 
868.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()', () => {
869.     it('should return the logical id of the APIGW Account CloudWatch role custom resource', () => {
870.       expect(
871.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()
872.       ).to.equal('CustomApiGatewayAccountCloudWatchRole');
873.     });
874.   });
875. 
876.   describe('#getCloudFrontDistributionLogicalId()', () => {
877.     it('should return CloudFront distribution logical id', () => {
878.       expect(sdk.naming.getCloudFrontDistributionLogicalId()).to.equal('CloudFrontDistribution');
879.     });
880.   });
881. 
882.   describe('#getCloudFrontDistributionDomainNameLogicalId()', () => {
883.     it('should return CloudFront distribution domain name logical id', () => {
884.       expect(sdk.naming.getCloudFrontDistributionDomainNameLogicalId()).to.equal(
885.         'CloudFrontDistributionDomainName'
886.       );
887.     });
888.   });
889. 
890.   describe('#getLambdaAtEdgeInvokePermissionLogicalId()', () => {
891.     it('should return lambda@edge invoke permission logical id', () => {
892.       expect(sdk.naming.getLambdaAtEdgeInvokePermissionLogicalId('functionName')).to.equal(
893.         'FunctionNameLambdaFunctionInvokePermission'
894.       );
895.     });
896.   });
897. 
898.   describe('#getCloudFrontOriginId()', () => {
899.     it('should return CloudFront origin id for s3 origin', () => {
900.       expect(
901.         sdk.naming.getCloudFrontOriginId({
902.           S3OriginConfig: {},
903.           DomainName: 'domain.name',
904.           OriginPath: '/path',
905.         })
906.       ).to.equal('s3/domain.name/path');
907.     });
908. 
909.     it('should return CloudFront origin id for custom origin', () => {
910.       expect(
911.         sdk.naming.getCloudFrontOriginId({
912.           CustomOriginConfig: {},
913.           DomainName: 'domain.name',
914.           OriginPath: '/path',
915.         })
916.       ).to.equal('custom/domain.name/path');
917.     });
918. 
919.     it('should return CloudFront origin id from domain as a object', () => {
920.       expect(
921.         sdk.naming.getCloudFrontOriginId({
922.           CustomOriginConfig: {},
923.           DomainName: {
924.             'Fn::Join': ['', ['Ref: ApiGatewayRestApi', '.execute-api.']],
925.           },
926.         })
927.       ).to.equal('custom/FnJoinRefApiGatewayRestApiexecuteapi');
928.     });
929.   });
930. });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 2000
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileSNSEvents', () => {
9.   let serverless;
10.   let awsCompileSNSEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     const options = {
15.       region: 'some-region',
16.     };
17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
18.     serverless.setProvider('aws', new AwsProvider(serverless));
19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
20.   });
21. 
22.   describe('#constructor()', () => {
23.     it('should set the provider variable to an instance of AwsProvider', () =>
24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));
25.   });
26. 
27.   describe('#compileSNSEvents()', () => {
28.     it('should throw an error if SNS event type is not a string or an object', () => {
29.       awsCompileSNSEvents.serverless.service.functions = {
30.         first: {
31.           events: [
32.             {
33.               sns: 42,
34.             },
35.           ],
36.         },
37.       };
38. 
39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);
40.     });
41. 
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });
89. 
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });
150. 
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });
184. 
185.     it('should throw an error when the event an object and the displayName is not given', () => {
186.       awsCompileSNSEvents.serverless.service.functions = {
187.         first: {
188.           events: [
189.             {
190.               sns: {
191.                 displayName: 'Display name for topic 1',
192.               },
193.             },
194.           ],
195.         },
196.       };
197. 
198.       expect(() => {
199.         awsCompileSNSEvents.compileSNSEvents();
200.       }).to.throw(Error);
201.     });
202. 
203.     it('should not create corresponding resources when SNS events are not given', () => {
204.       awsCompileSNSEvents.serverless.service.functions = {
205.         first: {
206.           events: [],
207.         },
208.       };
209. 
210.       awsCompileSNSEvents.compileSNSEvents();
211. 
212.       expect(
213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.       ).to.deep.equal({});
215.     });
216. 
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });
248. 
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });
278. 
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });
311. 
312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {
313.       awsCompileSNSEvents.serverless.service.functions = {
314.         first: {
315.           events: [
316.             {
317.               sns: {
318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',
319.               },
320.             },
321.           ],
322.         },
323.       };
324. 
325.       awsCompileSNSEvents.compileSNSEvents();
326.       expect(
327.         Object.keys(
328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
329.         )
330.       ).to.have.length(2);
331.       expect(
332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
333.           .FirstSnsSubscriptionFoo.Type
334.       ).to.equal('AWS::SNS::Subscription');
335.       expect(
336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
337.           .FirstSnsSubscriptionFoo.Properties.Region
338.       ).to.equal('${AWS::Region}');
339.       expect(
340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
341.           .FirstLambdaPermissionFooSNS.Type
342.       ).to.equal('AWS::Lambda::Permission');
343.     });
344. 
345.     it('should throw an error when the arn an object and the value is not a string', () => {
346.       awsCompileSNSEvents.serverless.service.functions = {
347.         first: {
348.           events: [
349.             {
350.               sns: {
351.                 arn: 123,
352.               },
353.             },
354.           ],
355.         },
356.       };
357. 
358.       expect(() => {
359.         awsCompileSNSEvents.compileSNSEvents();
360.       }).to.throw(Error);
361.     });
362. 
363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {
364.       awsCompileSNSEvents.serverless.service.functions = {
365.         first: {
366.           events: [
367.             {
368.               sns: {
369.                 topicName: 'bar',
370.                 arn: 'arn:aws:sns:region:accountid:bar',
371.               },
372.             },
373.           ],
374.         },
375.       };
376. 
377.       awsCompileSNSEvents.compileSNSEvents();
378. 
379.       expect(
380.         Object.keys(
381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
382.         )
383.       ).to.have.length(2);
384.       expect(
385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
386.           .FirstSnsSubscriptionBar.Type
387.       ).to.equal('AWS::SNS::Subscription');
388.       expect(
389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
390.           .FirstLambdaPermissionBarSNS.Type
391.       ).to.equal('AWS::Lambda::Permission');
392.     });
393. 
394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {
395.       awsCompileSNSEvents.serverless.service.functions = {
396.         first: {
397.           events: [
398.             {
399.               sns: {
400.                 topicName: 'first',
401.                 arn: 'arn:aws:sns:region-1:accountid:bar',
402.               },
403.             },
404.             {
405.               sns: {
406.                 topicName: 'second',
407.                 arn: 'arn:aws:sns:region-2:accountid:bar',
408.               },
409.             },
410.           ],
411.         },
412.       };
413. 
414.       awsCompileSNSEvents.compileSNSEvents();
415. 
416.       expect(
417.         Object.keys(
418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
419.         )
420.       ).to.have.length(4);
421.       expect(
422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
423.           .FirstSnsSubscriptionFirst.Type
424.       ).to.equal('AWS::SNS::Subscription');
425.       expect(
426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
427.           .FirstSnsSubscriptionSecond.Type
428.       ).to.equal('AWS::SNS::Subscription');
429.     });
430. 
431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {
432.       awsCompileSNSEvents.serverless.service.functions = {
433.         first: {
434.           events: [
435.             {
436.               sns: {
437.                 topicName: 'foo',
438.                 arn: 'arn:aws:sns:region:accountid:bar',
439.               },
440.             },
441.           ],
442.         },
443.       };
444. 
445.       awsCompileSNSEvents.compileSNSEvents();
446. 
447.       expect(
448.         Object.keys(
449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
450.         )
451.       ).to.have.length(2);
452.       expect(
453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
454.           .FirstSnsSubscriptionFoo.Type
455.       ).to.equal('AWS::SNS::Subscription');
456.       expect(
457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
458.           .FirstLambdaPermissionFooSNS.Type
459.       ).to.equal('AWS::Lambda::Permission');
460.     });
461. 
462.     // eslint-disable-next-line max-len
463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {
464.       awsCompileSNSEvents.serverless.service.functions = {
465.         first: {
466.           events: [
467.             {
468.               sns: {
469.                 topicName: 'bar',
470.                 arn: {
471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
472.                 },
473.               },
474.             },
475.           ],
476.         },
477.       };
478. 
479.       awsCompileSNSEvents.compileSNSEvents();
480. 
481.       expect(
482.         Object.keys(
483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
484.         )
485.       ).to.have.length(2);
486.       expect(
487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
488.           .FirstSnsSubscriptionBar.Type
489.       ).to.equal('AWS::SNS::Subscription');
490.       expect(
491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
492.           .FirstLambdaPermissionBarSNS.Type
493.       ).to.equal('AWS::Lambda::Permission');
494.     });
495. 
496.     // eslint-disable-next-line max-len
497.     it('should throw an error when arn object and no topicName are given as object properties', () => {
498.       awsCompileSNSEvents.serverless.service.functions = {
499.         first: {
500.           events: [
501.             {
502.               sns: {
503.                 arn: {
504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
505.                 },
506.               },
507.             },
508.           ],
509.         },
510.       };
511. 
512.       expect(() => {
513.         awsCompileSNSEvents.compileSNSEvents();
514.       }).to.throw(Error);
515.     });
516. 
517.     // eslint-disable-next-line max-len
518.     it('should throw an error when invalid imported arn object is given as object properties', () => {
519.       awsCompileSNSEvents.serverless.service.functions = {
520.         first: {
521.           events: [
522.             {
523.               sns: {
524.                 topicName: 'bar',
525.                 arn: {
526.                   'Fn::ImportValue': {
527.                     Ref: 'BarTopic',
528.                   },
529.                 },
530.               },
531.             },
532.           ],
533.         },
534.       };
535. 
536.       expect(() => {
537.         awsCompileSNSEvents.compileSNSEvents();
538.       }).to.throw(Error);
539. 
540.       awsCompileSNSEvents.serverless.service.functions = {
541.         first: {
542.           events: [
543.             {
544.               sns: {
545.                 topicName: 'bar',
546.                 arn: {
547.                   'Fn::ImportValue': {
548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],
549.                   },
550.                 },
551.               },
552.             },
553.           ],
554.         },
555.       };
556. 
557.       expect(() => {
558.         awsCompileSNSEvents.compileSNSEvents();
559.       }).to.throw(Error);
560.     });
561. 
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });
599. 
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });
654.   });
655. });


File: lib/plugins/aws/package/compile/events/sqs/index.test.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSQSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileSQSEvents', () => {
9.   let serverless;
10.   let awsCompileSQSEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     serverless.service.provider.compiledCloudFormationTemplate = {
15.       Resources: {
16.         IamRoleLambdaExecution: {
17.           Properties: {
18.             Policies: [
19.               {
20.                 PolicyDocument: {
21.                   Statement: [],
22.                 },
23.               },
24.             ],
25.           },
26.         },
27.       },
28.     };
29.     serverless.setProvider('aws', new AwsProvider(serverless));
30.     awsCompileSQSEvents = new AwsCompileSQSEvents(serverless);
31.     awsCompileSQSEvents.serverless.service.service = 'new-service';
32.   });
33. 
34.   describe('#constructor()', () => {
35.     it('should set the provider variable to be an instance of AwsProvider', () =>
36.       expect(awsCompileSQSEvents.provider).to.be.instanceof(AwsProvider));
37.   });
38. 
39.   describe('#compileSQSEvents()', () => {
40.     it('should throw an error if sqs event type is not a string or an object', () => {
41.       awsCompileSQSEvents.serverless.service.functions = {
42.         first: {
43.           events: [
44.             {
45.               sqs: 42,
46.             },
47.           ],
48.         },
49.       };
50. 
51.       expect(() => awsCompileSQSEvents.compileSQSEvents()).to.throw(Error);
52.     });
53. 
54.     it('should throw an error if the "arn" property is not given', () => {
55.       awsCompileSQSEvents.serverless.service.functions = {
56.         first: {
57.           events: [
58.             {
59.               sqs: {
60.                 arn: null,
61.               },
62.             },
63.           ],
64.         },
65.       };
66. 
67.       expect(() => awsCompileSQSEvents.compileSQSEvents()).to.throw(Error);
68.     });
69. 
70.     it('should not throw error or merge role statements if default policy is not present', () => {
71.       awsCompileSQSEvents.serverless.service.functions = {
72.         first: {
73.           events: [
74.             {
75.               sqs: 'arn:aws:sqs:region:account:queueName',
76.             },
77.           ],
78.         },
79.       };
80. 
81.       // pretend that the default IamRoleLambdaExecution is not in place
82.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
83. 
84.       expect(() => {
85.         awsCompileSQSEvents.compileSQSEvents();
86.       }).to.not.throw(Error);
87.       expect(
88.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
89.           .IamRoleLambdaExecution
90.       ).to.equal(null);
91.     });
92. 
93.     it('should not throw error if custom IAM role is set in function', () => {
94.       awsCompileSQSEvents.serverless.service.functions = {
95.         first: {
96.           role: 'arn:aws:iam::account:role/foo',
97.           events: [
98.             {
99.               sqs: 'arn:aws:sqs:region:account:MyQueue',
100.             },
101.           ],
102.         },
103.       };
104. 
105.       // pretend that the default IamRoleLambdaExecution is not in place
106.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
107. 
108.       expect(() => {
109.         awsCompileSQSEvents.compileSQSEvents();
110.       }).to.not.throw(Error);
111.       expect(
112.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
113.           .FirstEventSourceMappingSQSMyQueue.DependsOn
114.       ).to.be.instanceof(Array);
115.       expect(
116.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
117.           .FirstEventSourceMappingSQSMyQueue.DependsOn.length
118.       ).to.equal(0);
119.       expect(
120.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
121.           .IamRoleLambdaExecution
122.       ).to.equal(null);
123.     });
124. 
125.     it('should not throw error if custom IAM role name reference is set in function', () => {
126.       const roleLogicalId = 'RoleLogicalId';
127.       awsCompileSQSEvents.serverless.service.functions = {
128.         first: {
129.           role: roleLogicalId,
130.           events: [
131.             {
132.               sqs: 'arn:aws:sqs:region:account:MyQueue',
133.             },
134.           ],
135.         },
136.       };
137. 
138.       // pretend that the default IamRoleLambdaExecution is not in place
139.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
140. 
141.       expect(() => {
142.         awsCompileSQSEvents.compileSQSEvents();
143.       }).to.not.throw(Error);
144.       expect(
145.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
146.           .FirstEventSourceMappingSQSMyQueue.DependsOn
147.       ).to.equal(roleLogicalId);
148.       expect(
149.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
150.           .IamRoleLambdaExecution
151.       ).to.equal(null);
152.     });
153. 
154.     it('should not throw error if custom IAM role reference is set in function', () => {
155.       const roleLogicalId = 'RoleLogicalId';
156.       awsCompileSQSEvents.serverless.service.functions = {
157.         first: {
158.           role: { 'Fn::GetAtt': [roleLogicalId, 'Arn'] },
159.           events: [
160.             {
161.               sqs: 'arn:aws:sqs:region:account:MyQueue',
162.             },
163.           ],
164.         },
165.       };
166. 
167.       // pretend that the default IamRoleLambdaExecution is not in place
168.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
169. 
170.       expect(() => {
171.         awsCompileSQSEvents.compileSQSEvents();
172.       }).to.not.throw(Error);
173.       expect(
174.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
175.           .FirstEventSourceMappingSQSMyQueue.DependsOn
176.       ).to.equal(roleLogicalId);
177.       expect(
178.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
179.           .IamRoleLambdaExecution
180.       ).to.equal(null);
181.     });
182. 
183.     it('should not throw error if custom IAM role is set in provider', () => {
184.       awsCompileSQSEvents.serverless.service.functions = {
185.         first: {
186.           events: [
187.             {
188.               sqs: 'arn:aws:sqs:region:account:MyQueue',
189.             },
190.           ],
191.         },
192.       };
193. 
194.       // pretend that the default IamRoleLambdaExecution is not in place
195.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
196. 
197.       awsCompileSQSEvents.serverless.service.provider.role = 'arn:aws:iam::account:role/foo';
198. 
199.       expect(() => {
200.         awsCompileSQSEvents.compileSQSEvents();
201.       }).to.not.throw(Error);
202.       expect(
203.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
204.           .FirstEventSourceMappingSQSMyQueue.DependsOn
205.       ).to.be.instanceof(Array);
206.       expect(
207.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
208.           .FirstEventSourceMappingSQSMyQueue.DependsOn.length
209.       ).to.equal(0);
210.       expect(
211.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
212.           .IamRoleLambdaExecution
213.       ).to.equal(null);
214.     });
215. 
216.     it('should not throw error if IAM role is imported', () => {
217.       awsCompileSQSEvents.serverless.service.functions = {
218.         first: {
219.           role: { 'Fn::ImportValue': 'ExportedRoleId' },
220.           events: [
221.             {
222.               sqs: 'arn:aws:sqs:region:account:MyQueue',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       // pretend that the default IamRoleLambdaExecution is not in place
229.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
230. 
231.       expect(() => {
232.         awsCompileSQSEvents.compileSQSEvents();
233.       }).to.not.throw(Error);
234.       expect(
235.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
236.           .FirstEventSourceMappingSQSMyQueue.DependsOn.length
237.       ).to.equal(0);
238.       expect(
239.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
240.           .IamRoleLambdaExecution
241.       ).to.equal(null);
242.     });
243. 
244.     it('should not throw error if custom IAM role reference is set in provider', () => {
245.       const roleLogicalId = 'RoleLogicalId';
246.       awsCompileSQSEvents.serverless.service.functions = {
247.         first: {
248.           events: [
249.             {
250.               sqs: 'arn:aws:sqs:region:account:MyQueue',
251.             },
252.           ],
253.         },
254.       };
255. 
256.       // pretend that the default IamRoleLambdaExecution is not in place
257.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
258. 
259.       awsCompileSQSEvents.serverless.service.provider.role = {
260.         'Fn::GetAtt': [roleLogicalId, 'Arn'],
261.       };
262. 
263.       expect(() => {
264.         awsCompileSQSEvents.compileSQSEvents();
265.       }).to.not.throw(Error);
266.       expect(
267.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
268.           .FirstEventSourceMappingSQSMyQueue.DependsOn
269.       ).to.equal(roleLogicalId);
270.       expect(
271.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
272.           .IamRoleLambdaExecution
273.       ).to.equal(null);
274.     });
275. 
276.     it('should not throw error if custom IAM role name reference is set in provider', () => {
277.       const roleLogicalId = 'RoleLogicalId';
278.       awsCompileSQSEvents.serverless.service.functions = {
279.         first: {
280.           events: [
281.             {
282.               sqs: 'arn:aws:sqs:region:account:MyQueue',
283.             },
284.           ],
285.         },
286.       };
287. 
288.       // pretend that the default IamRoleLambdaExecution is not in place
289.       awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources.IamRoleLambdaExecution = null;
290. 
291.       awsCompileSQSEvents.serverless.service.provider.role = roleLogicalId;
292. 
293.       expect(() => {
294.         awsCompileSQSEvents.compileSQSEvents();
295.       }).to.not.throw(Error);
296.       expect(
297.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
298.           .FirstEventSourceMappingSQSMyQueue.DependsOn
299.       ).to.equal(roleLogicalId);
300.       expect(
301.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
302.           .IamRoleLambdaExecution
303.       ).to.equal(null);
304.     });
305. 
306.     describe('when a queue ARN is given', () => {
307.       it('should create event source mappings when a queue ARN is given', () => {
308.         awsCompileSQSEvents.serverless.service.functions = {
309.           first: {
310.             events: [
311.               {
312.                 sqs: {
313.                   arn: 'arn:aws:sqs:region:account:MyFirstQueue',
314.                   batchSize: 1,
315.                   enabled: false,
316.                 },
317.               },
318.               {
319.                 sqs: {
320.                   arn: 'arn:aws:sqs:region:account:MySecondQueue',
321.                 },
322.               },
323.               {
324.                 sqs: 'arn:aws:sqs:region:account:MyThirdQueue',
325.               },
326.             ],
327.           },
328.         };
329. 
330.         awsCompileSQSEvents.compileSQSEvents();
331. 
332.         // event 1
333.         expect(
334.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
335.             .FirstEventSourceMappingSQSMyFirstQueue.Type
336.         ).to.equal('AWS::Lambda::EventSourceMapping');
337.         expect(
338.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
339.             .FirstEventSourceMappingSQSMyFirstQueue.DependsOn
340.         ).to.equal('IamRoleLambdaExecution');
341.         expect(
342.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
343.             .FirstEventSourceMappingSQSMyFirstQueue.Properties.EventSourceArn
344.         ).to.equal(awsCompileSQSEvents.serverless.service.functions.first.events[0].sqs.arn);
345.         expect(
346.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
347.             .FirstEventSourceMappingSQSMyFirstQueue.Properties.BatchSize
348.         ).to.equal(awsCompileSQSEvents.serverless.service.functions.first.events[0].sqs.batchSize);
349.         expect(
350.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
351.             .FirstEventSourceMappingSQSMyFirstQueue.Properties.Enabled
352.         ).to.equal('False');
353. 
354.         // event 2
355.         expect(
356.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
357.             .FirstEventSourceMappingSQSMySecondQueue.Type
358.         ).to.equal('AWS::Lambda::EventSourceMapping');
359.         expect(
360.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
361.             .FirstEventSourceMappingSQSMySecondQueue.DependsOn
362.         ).to.equal('IamRoleLambdaExecution');
363.         expect(
364.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
365.             .FirstEventSourceMappingSQSMySecondQueue.Properties.EventSourceArn
366.         ).to.equal(awsCompileSQSEvents.serverless.service.functions.first.events[1].sqs.arn);
367.         expect(
368.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
369.             .FirstEventSourceMappingSQSMySecondQueue.Properties.BatchSize
370.         ).to.equal(10);
371.         expect(
372.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
373.             .FirstEventSourceMappingSQSMySecondQueue.Properties.Enabled
374.         ).to.equal('True');
375. 
376.         // event 3
377.         expect(
378.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
379.             .FirstEventSourceMappingSQSMyThirdQueue.Type
380.         ).to.equal('AWS::Lambda::EventSourceMapping');
381.         expect(
382.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
383.             .FirstEventSourceMappingSQSMyThirdQueue.DependsOn
384.         ).to.equal('IamRoleLambdaExecution');
385.         expect(
386.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
387.             .FirstEventSourceMappingSQSMyThirdQueue.Properties.EventSourceArn
388.         ).to.equal(awsCompileSQSEvents.serverless.service.functions.first.events[2].sqs);
389.         expect(
390.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
391.             .FirstEventSourceMappingSQSMyThirdQueue.Properties.BatchSize
392.         ).to.equal(10);
393.         expect(
394.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
395.             .FirstEventSourceMappingSQSMyThirdQueue.Properties.Enabled
396.         ).to.equal('True');
397.       });
398. 
399.       it('should allow specifying SQS Queues as CFN reference types', () => {
400.         awsCompileSQSEvents.serverless.service.functions = {
401.           first: {
402.             events: [
403.               {
404.                 sqs: {
405.                   arn: { 'Fn::GetAtt': ['SomeQueue', 'Arn'] },
406.                 },
407.               },
408.               {
409.                 sqs: {
410.                   arn: { 'Fn::ImportValue': 'ForeignQueue' },
411.                 },
412.               },
413.               {
414.                 sqs: {
415.                   arn: {
416.                     'Fn::Join': [
417.                       ':',
418.                       [
419.                         'arn',
420.                         'aws',
421.                         'sqs',
422.                         {
423.                           Ref: 'AWS::Region',
424.                         },
425.                         {
426.                           Ref: 'AWS::AccountId',
427.                         },
428.                         'MyQueue',
429.                       ],
430.                     ],
431.                   },
432.                 },
433.               },
434.             ],
435.           },
436.         };
437. 
438.         awsCompileSQSEvents.compileSQSEvents();
439. 
440.         expect(
441.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
442.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement[0]
443.         ).to.deep.equal({
444.           Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
445.           Effect: 'Allow',
446.           Resource: [
447.             {
448.               'Fn::GetAtt': ['SomeQueue', 'Arn'],
449.             },
450.             {
451.               'Fn::ImportValue': 'ForeignQueue',
452.             },
453.             {
454.               'Fn::Join': [
455.                 ':',
456.                 [
457.                   'arn',
458.                   'aws',
459.                   'sqs',
460.                   {
461.                     Ref: 'AWS::Region',
462.                   },
463.                   {
464.                     Ref: 'AWS::AccountId',
465.                   },
466.                   'MyQueue',
467.                 ],
468.               ],
469.             },
470.           ],
471.         });
472.         expect(
473.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
474.             .FirstEventSourceMappingSQSSomeQueue.Properties.EventSourceArn
475.         ).to.deep.equal({ 'Fn::GetAtt': ['SomeQueue', 'Arn'] });
476.         expect(
477.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
478.             .FirstEventSourceMappingSQSForeignQueue.Properties.EventSourceArn
479.         ).to.deep.equal({ 'Fn::ImportValue': 'ForeignQueue' });
480.         expect(
481.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
482.             .FirstEventSourceMappingSQSMyQueue.Properties.EventSourceArn
483.         ).to.deep.equal({
484.           'Fn::Join': [
485.             ':',
486.             [
487.               'arn',
488.               'aws',
489.               'sqs',
490.               {
491.                 Ref: 'AWS::Region',
492.               },
493.               {
494.                 Ref: 'AWS::AccountId',
495.               },
496.               'MyQueue',
497.             ],
498.           ],
499.         });
500.       });


File: lib/plugins/aws/package/compile/events/sqs/index.test.js
Line number range: 500 - 2000
Content:
500.       });
501. 
502.       it('fails if keys other than Fn::GetAtt/ImportValue/Join are used for dynamic ARNs', () => {
503.         awsCompileSQSEvents.serverless.service.functions = {
504.           first: {
505.             events: [
506.               {
507.                 sqs: {
508.                   arn: {
509.                     'Fn::GetAtt': ['SomeQueue', 'Arn'],
510.                     'batchSize': 1,
511.                   },
512.                 },
513.               },
514.             ],
515.           },
516.         };
517. 
518.         expect(() => awsCompileSQSEvents.compileSQSEvents()).to.throw(Error);
519.       });
520. 
521.       it('should add the necessary IAM role statements', () => {
522.         awsCompileSQSEvents.serverless.service.functions = {
523.           first: {
524.             events: [
525.               {
526.                 sqs: 'arn:aws:sqs:region:account:MyFirstQueue',
527.               },
528.               {
529.                 sqs: 'arn:aws:sqs:region:account:MySecondQueue',
530.               },
531.             ],
532.           },
533.         };
534. 
535.         const iamRoleStatements = [
536.           {
537.             Effect: 'Allow',
538.             Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
539.             Resource: [
540.               'arn:aws:sqs:region:account:MyFirstQueue',
541.               'arn:aws:sqs:region:account:MySecondQueue',
542.             ],
543.           },
544.         ];
545. 
546.         awsCompileSQSEvents.compileSQSEvents();
547. 
548.         expect(
549.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
550.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement
551.         ).to.deep.equal(iamRoleStatements);
552.       });
553.     });
554. 
555.     it('should not create event source mapping when sqs events are not given', () => {
556.       awsCompileSQSEvents.serverless.service.functions = {
557.         first: {
558.           events: [],
559.         },
560.       };
561. 
562.       awsCompileSQSEvents.compileSQSEvents();
563. 
564.       // should be 1 because we've mocked the IamRoleLambdaExecution above
565.       expect(
566.         Object.keys(
567.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
568.         ).length
569.       ).to.equal(1);
570.     });
571. 
572.     it('should not add the IAM role statements when sqs events are not given', () => {
573.       awsCompileSQSEvents.serverless.service.functions = {
574.         first: {
575.           events: [],
576.         },
577.       };
578. 
579.       awsCompileSQSEvents.compileSQSEvents();
580. 
581.       expect(
582.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
583.           .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement.length
584.       ).to.equal(0);
585.     });
586. 
587.     it('should remove all non-alphanumerics from queue names for the resource logical ids', () => {
588.       awsCompileSQSEvents.serverless.service.functions = {
589.         first: {
590.           events: [
591.             {
592.               sqs: 'arn:aws:sqs:region:account:some-queue-name',
593.             },
594.           ],
595.         },
596.       };
597. 
598.       awsCompileSQSEvents.compileSQSEvents();
599. 
600.       expect(
601.         awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
602.       ).to.have.any.keys('FirstEventSourceMappingSQSSomequeuename');
603.     });
604.   });
605. });


File: lib/plugins/aws/package/index.test.js
Line number range: 1 - 167
Content:
1. 'use strict';
2. 
3. const AwsProvider = require('../provider/awsProvider');
4. const AwsPackage = require('./index');
5. const Serverless = require('../../../Serverless');
6. const CLI = require('../../../classes/CLI');
7. const expect = require('chai').expect;
8. const sinon = require('sinon');
9. const path = require('path');
10. 
11. describe('AwsPackage', () => {
12.   let awsPackage;
13.   let serverless;
14.   let options;
15. 
16.   beforeEach(() => {
17.     serverless = new Serverless();
18.     options = {
19.       stage: 'dev',
20.       region: 'us-east-1',
21.     };
22.     serverless.setProvider('aws', new AwsProvider(serverless, options));
23.     serverless.config.servicePath = 'foo';
24.     serverless.cli = new CLI(serverless);
25.     awsPackage = new AwsPackage(serverless, options);
26.   });
27. 
28.   describe('#constructor()', () => {
29.     it('should set the serverless instance', () => {
30.       expect(awsPackage.serverless).to.equal(serverless);
31.     });
32. 
33.     it('should set options', () => {
34.       expect(awsPackage.options).to.equal(options);
35.     });
36. 
37.     it('should set the service path if provided', () => {
38.       expect(awsPackage.servicePath).to.equal('foo');
39.     });
40. 
41.     it('should default to an empty service path if not provided', () => {
42.       serverless.config.servicePath = false;
43.       awsPackage = new AwsPackage(serverless, options);
44. 
45.       expect(awsPackage.servicePath).to.equal('');
46.     });
47. 
48.     it('should use the options package path if provided', () => {
49.       options.package = 'package-options';
50.       awsPackage = new AwsPackage(serverless, options);
51. 
52.       expect(awsPackage.packagePath).to.equal('package-options');
53.     });
54. 
55.     it('should use the services package path if provided', () => {
56.       serverless.service = {
57.         package: {
58.           path: 'package-service',
59.         },
60.       };
61.       awsPackage = new AwsPackage(serverless, options);
62. 
63.       expect(awsPackage.packagePath).to.equal('package-service');
64.     });
65. 
66.     it('should default to the .serverless directory as the package path', () => {
67.       expect(awsPackage.packagePath).to.equal(path.join('foo', '.serverless'));
68.     });
69. 
70.     it('should set the provider variable to an instance of AwsProvider', () =>
71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));
72. 
73.     it('should have commands', () => expect(awsPackage.commands).to.be.not.empty);
74. 
75.     it('should have hooks', () => expect(awsPackage.hooks).to.be.not.empty);
76.   });
77. 
78.   describe('hooks', () => {
79.     let spawnStub;
80.     let generateCoreTemplateStub;
81.     let mergeIamTemplatesStub;
82.     let generateArtifactDirectoryNameStub;
83.     let mergeCustomProviderResourcesStub;
84.     let saveCompiledTemplateStub;
85.     let saveServiceStateStub;
86. 
87.     beforeEach(() => {
88.       spawnStub = sinon.stub(serverless.pluginManager, 'spawn');
89.       generateCoreTemplateStub = sinon.stub(awsPackage, 'generateCoreTemplate').resolves();
90.       mergeIamTemplatesStub = sinon.stub(awsPackage, 'mergeIamTemplates').resolves();
91.       generateArtifactDirectoryNameStub = sinon
92.         .stub(awsPackage, 'generateArtifactDirectoryName')
93.         .resolves();
94.       mergeCustomProviderResourcesStub = sinon
95.         .stub(awsPackage, 'mergeCustomProviderResources')
96.         .resolves();
97.       saveCompiledTemplateStub = sinon.stub(awsPackage, 'saveCompiledTemplate').resolves();
98.       saveServiceStateStub = sinon.stub(awsPackage, 'saveServiceState').resolves();
99.     });
100. 
101.     afterEach(() => {
102.       serverless.pluginManager.spawn.restore();
103.       awsPackage.generateCoreTemplate.restore();
104.       awsPackage.mergeIamTemplates.restore();
105.       awsPackage.generateArtifactDirectoryName.restore();
106.       awsPackage.mergeCustomProviderResources.restore();
107.       awsPackage.saveCompiledTemplate.restore();
108.       awsPackage.saveServiceState.restore();
109.     });
110. 
111.     it('should run "package:cleanup" hook', () => {
112.       const spawnAwsCommonValidateStub = spawnStub.withArgs('aws:common:validate').resolves();
113.       const spawnAwsCommonCleanupTempDirStub = spawnStub
114.         .withArgs('aws:common:cleanupTempDir')
115.         .resolves();
116. 
117.       return awsPackage.hooks['package:cleanup']().then(() => {
118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);
119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(
120.           true
121.         );
122.       });
123.     });
124. 
125.     it('should run "package:initialize" hook', () =>
126.       awsPackage.hooks['package:initialize']().then(() => {
127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);
128.       }));
129. 
130.     it('should run "package:setupProviderConfiguration" hook', () =>
131.       awsPackage.hooks['package:setupProviderConfiguration']().then(() => {
132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);
133.       }));
134. 
135.     it('should run "before:package:compileFunctions" hook', () =>
136.       awsPackage.hooks['before:package:compileFunctions']().then(() => {
137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);
138.       }));
139. 
140.     it('should run "package:finalize" hook', () => {
141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs('aws:package:finalize').resolves();
142. 
143.       return awsPackage.hooks['package:finalize']().then(() => {
144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);
145.       });
146.     });
147. 
148.     it('should run "aws:package:finalize:mergeCustomProviderResources" hook', () =>
149.       awsPackage.hooks['aws:package:finalize:mergeCustomProviderResources']().then(() => {
150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);
151.       }));
152. 
153.     it('should run "aws:package:finalize:saveServiceState" hook', () => {
154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub
155.         .withArgs('aws:common:moveArtifactsToPackage')
156.         .resolves();
157. 
158.       return awsPackage.hooks['aws:package:finalize:saveServiceState']().then(() => {
159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);
160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);
161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(
162.           true
163.         );
164.       });
165.     });
166.   });
167. });

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 20:35:23,531 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requirement analysis:\n   - The user explicitly requests the full content (with line numbers) of lib/plugins/aws/lib/naming.test.js.\n2. Extended relevance:\n   - Providing the entire file range (as available) satisfies the request for this file exactly.\n   - This file does not cover SNS redrive policy/SQS QueuePolicy, thus triggers the extra requirement to include unit tests that compile SNS events or generate SQS policies (handled in separate contexts).', relative_path='lib/plugins/aws/lib/naming.test.js', start_line=1, end_line=930), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user explicitly requests the full content (with line numbers) of lib/plugins/aws/package/index.test.js.\n2. Extended relevance:\n   - Providing the entire file range satisfies the request for this file exactly.\n   - This file does not cover SNS redrive policy/SQS QueuePolicy, thus extra unit tests are included separately.', relative_path='lib/plugins/aws/package/index.test.js', start_line=1, end_line=167), ContextOutput(reasoning='1. Query requirement analysis:\n   - Extra requirement asks for unit tests that compile SNS events and cover SNS redrive policy/SQS QueuePolicy if the requested files lack such coverage.\n   - This exact test validates redrivePolicy handling for SNS (linking to DLQ and generating an SQS QueuePolicy resource).\n2. Extended relevance:\n   - Critical implementation verification of SNS redrivePolicy to DLQ linkage and presence of AWS::SQS::QueuePolicy resource.\n   - Necessary to demonstrate functionality similar to the reported bug.', relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', start_line=600, end_line=653), ContextOutput(reasoning='1. Query requirement analysis:\n   - Extra requirement also asks for unit tests that generate SQS policies if direct coverage is missing in requested files.\n   - This test verifies allowing CFN reference types for SQS ARNs and asserts the generated IAM policy resources array accordingly.\n2. Extended relevance:\n   - Shows how SQS-related permissions (policy statements) are compiled, which is essential when investigating SQS policy generation issues.', relative_path='lib/plugins/aws/package/compile/events/sqs/index.test.js', start_line=399, end_line=500), ContextOutput(reasoning='1. Query requirement analysis:\n   - Extra requirement calls for tests that generate SQS policies.\n   - This specific test asserts the necessary IAM role statements for SQS access are added.\n2. Extended relevance:\n   - Provides a concise, direct assertion of the resulting SQS-related IAM policy statements, demonstrating the policy generation logic.', relative_path='lib/plugins/aws/package/compile/events/sqs/index.test.js', start_line=521, end_line=552)]
2025-11-13 20:35:23,537 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 5 contexts to memory for query: Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.
2025-11-13 20:35:27,833 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 20:35:27,835 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 5 new contexts to 0 existing contexts
2025-11-13 20:35:27,835 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 5 total contexts (removed 0 duplicates)
2025-11-13 20:35:27,837 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


OBJECTIVE: Find 5 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 5 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 5 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.
Extra Requirements: If any file lacks direct coverage of SNS redrive policy/SQS QueuePolicy, please also include any unit tests that compile SNS events or generate SQS policies (with exact paths and line numbers).
Purpose: I need the exact test implementations and their line numbers to return 5 complete, relevant test cases demonstrating similar functionality to the reported bug.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/lib/naming.test.js
Line number range: 1 - 930
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. 
5. const SDK = require('../provider/awsProvider');
6. const Serverless = require('../../../Serverless');
7. 
8. describe('#naming()', () => {
9.   let options;
10.   let serverless;
11.   let sdk;
12. 
13.   beforeEach(() => {
14.     options = {
15.       stage: 'dev',
16.       region: 'us-east-1',
17.     };
18.     serverless = new Serverless(options);
19.     sdk = new SDK(serverless, options);
20.   });
21. 
22.   describe('#normalizeName()', () => {
23.     it('should capitalize the first letter', () => {
24.       expect(sdk.naming.normalizeName('name')).to.equal('Name');
25.     });
26. 
27.     it('should have no effect on caps', () => {
28.       expect(sdk.naming.normalizeName('Name')).to.equal('Name');
29.     });
30. 
31.     it('should have no effect on the rest of the name', () => {
32.       expect(sdk.naming.normalizeName('nAME')).to.equal('NAME');
33.     });
34.   });
35. 
36.   describe('#normalizeNameToAlphaNumericOnly()', () => {
37.     it('should strip non-alpha-numeric characters', () => {
38.       expect(
39.         sdk.naming.normalizeNameToAlphaNumericOnly('`!@#$%^&*()-={}|[]\\:";\'<>?,./')
40.       ).to.equal('');
41.     });
42. 
43.     it('should apply normalizeName to the remaining characters', () => {
44.       expect(sdk.naming.normalizeNameToAlphaNumericOnly('a-b-c')).to.equal('Abc');
45.     });
46.   });
47. 
48.   describe('#normalizePathPart()', () => {
49.     it('converts `-` to `Dash`', () => {
50.       expect(sdk.naming.normalizePathPart('a-path')).to.equal('ADashpath');
51.     });
52. 
53.     it('converts variable declarations (`${var}`) to `VariableVar`', () => {
54.       expect(sdk.naming.normalizePathPart('${variable}')).to.equal('VariableVar');
55.     });
56. 
57.     it('converts variable declarations prefixes to `VariableVarpath`', () => {
58.       expect(sdk.naming.normalizePathPart('${variable}Path')).to.equal('VariableVarpath');
59.     });
60. 
61.     it('converts variable declarations suffixes to `PathvariableVar`', () => {
62.       expect(sdk.naming.normalizePathPart('path${variable}')).to.equal('PathvariableVar');
63.     });
64. 
65.     it('converts variable declarations in center to `PathvariableVardir`', () => {
66.       expect(sdk.naming.normalizePathPart('path${variable}Dir')).to.equal('PathvariableVardir');
67.     });
68.   });
69. 
70.   describe('#getServiceEndpointRegex()', () => {
71.     it('should match the prefix', () => {
72.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpoint')).to.equal(true);
73.     });
74. 
75.     it('should not match a name without the prefix', () => {
76.       expect(sdk.naming.getServiceEndpointRegex().test('NotThePrefixServiceEndpoint')).to.equal(
77.         false
78.       );
79.     });
80. 
81.     it('should match a name with the prefix', () => {
82.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpointForAService')).to.equal(
83.         true
84.       );
85.     });
86.   });
87. 
88.   describe('#getStackName()', () => {
89.     it('should use the service name & stage if custom stack name not provided', () => {
90.       serverless.service.service = 'myService';
91.       expect(sdk.naming.getStackName()).to.equal(
92.         `${serverless.service.service}-${sdk.naming.provider.getStage()}`
93.       );
94.     });
95. 
96.     it('should use the custom stack name if provided', () => {
97.       serverless.service.provider.stackName = 'app-dev-testApp';
98.       serverless.service.service = 'myService';
99.       serverless.service.provider.stage = sdk.naming.provider.getStage();
100.       expect(sdk.naming.getStackName()).to.equal('app-dev-testApp');
101.     });
102.   });
103. 
104.   describe('#getRolePath()', () => {
105.     it('should return `/`', () => {
106.       expect(sdk.naming.getRolePath()).to.equal('/');
107.     });
108.   });
109. 
110.   describe('#getRoleName()', () => {
111.     it('uses the service name, stage, and region to generate a role name', () => {
112.       serverless.service.service = 'myService';
113.       expect(sdk.naming.getRoleName()).to.eql({
114.         'Fn::Join': [
115.           '-',
116.           [
117.             serverless.service.service,
118.             sdk.naming.provider.getStage(),
119.             { Ref: 'AWS::Region' },
120.             'lambdaRole',
121.           ],
122.         ],
123.       });
124.     });
125.   });
126. 
127.   describe('#getRoleLogicalId()', () => {
128.     it('should return the expected role name (IamRoleLambdaExecution)', () => {
129.       expect(sdk.naming.getRoleLogicalId()).to.equal('IamRoleLambdaExecution');
130.     });
131.   });
132. 
133.   describe('#getPolicyName()', () => {
134.     it('should use the stage and service name', () => {
135.       serverless.service.service = 'myService';
136.       expect(sdk.naming.getPolicyName()).to.eql({
137.         'Fn::Join': ['-', [sdk.naming.provider.getStage(), serverless.service.service, 'lambda']],
138.       });
139.     });
140.   });
141. 
142.   describe('#getLogicalLogGroupName()', () => {
143.     it('should prefix the normalized function name to "LogGroup"', () => {
144.       expect(sdk.naming.getLogGroupLogicalId('functionName')).to.equal('FunctionNameLogGroup');
145.     });
146.   });
147. 
148.   describe('#getLogGroupName()', () => {
149.     it('should add the function name to the log group name', () => {
150.       expect(sdk.naming.getLogGroupName('functionName')).to.equal('/aws/lambda/functionName');
151.     });
152.   });
153. 
154.   describe('#getNormalizedFunctionName()', () => {
155.     it('should normalize the given functionName', () => {
156.       expect(sdk.naming.getNormalizedFunctionName('functionName')).to.equal('FunctionName');
157.     });
158. 
159.     it('should normalize the given functionName with an underscore', () => {
160.       expect(sdk.naming.getNormalizedFunctionName('hello_world')).to.equal('HelloUnderscoreworld');
161.     });
162. 
163.     it('should normalize the given functionName with a dash', () => {
164.       expect(sdk.naming.getNormalizedFunctionName('hello-world')).to.equal('HelloDashworld');
165.     });
166.   });
167. 
168.   describe('#extractAuthorizerNameFromArn()', () => {
169.     it('should extract everything after the last colon and dash', () => {
170.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
171.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
172.     });
173.   });
174. 
175.   describe('#extractLambdaNameFromArn()', () => {
176.     it('should extract everything after the last colon', () => {
177.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
178.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal('my-dev-lambda');
179.     });
180.   });
181. 
182.   describe('#getLambdaLogicalId()', () => {
183.     it('should normalize the function name and add the logical suffix', () => {
184.       expect(sdk.naming.getLambdaLogicalId('functionName')).to.equal('FunctionNameLambdaFunction');
185.     });
186.   });
187. 
188.   describe('#getLambdaLogicalIdRegex()', () => {
189.     it('should match the suffix', () => {
190.       expect(sdk.naming.getLambdaLogicalIdRegex().test('LambdaFunction')).to.equal(true);
191.     });
192. 
193.     it('should not match a name without the suffix', () => {
194.       expect(sdk.naming.getLambdaLogicalIdRegex().test('LambdaFunctionNotTheSuffix')).to.equal(
195.         false
196.       );
197.     });
198. 
199.     it('should match a name with the suffix', () => {
200.       expect(sdk.naming.getLambdaLogicalIdRegex().test('AFunctionNameLambdaFunction')).to.equal(
201.         true
202.       );
203.     });
204.   });
205. 
206.   describe('#getWebsocketsApiName()', () => {
207.     it('should return the composition of stage & service name if custom name not provided', () => {
208.       serverless.service.service = 'myService';
209.       expect(sdk.naming.getWebsocketsApiName()).to.equal(
210.         `${sdk.naming.provider.getStage()}-${serverless.service.service}-websockets`
211.       );
212.     });
213. 
214.     it('should return the custom api name if provided', () => {
215.       serverless.service.provider.websocketsApiName = 'app-dev-websockets-testApi';
216.       serverless.service.service = 'myService';
217.       serverless.service.provider.stage = sdk.naming.provider.getStage();
218.       expect(sdk.naming.getWebsocketsApiName()).to.equal('app-dev-websockets-testApi');
219.     });
220.   });
221. 
222.   describe('#getWebsocketsApiLogicalId()', () => {
223.     it('should return the websocket API logical id', () => {
224.       expect(sdk.naming.getWebsocketsApiLogicalId()).to.equal('WebsocketsApi');
225.     });
226.   });
227. 
228.   describe('#getWebsocketsIntegrationLogicalId()', () => {
229.     it('should return the integrations logical id', () => {
230.       expect(sdk.naming.getWebsocketsIntegrationLogicalId('myFunc')).to.equal(
231.         'MyFuncWebsocketsIntegration'
232.       );
233.     });
234.   });
235. 
236.   describe('#getLambdaWebsocketsPermissionLogicalId()', () => {
237.     it('should return the lambda websocket permission logical id', () => {
238.       expect(sdk.naming.getLambdaWebsocketsPermissionLogicalId('myFunc')).to.equal(
239.         'MyFuncLambdaPermissionWebsockets'
240.       );
241.     });
242.   });
243. 
244.   describe('#getNormalizedWebsocketsRouteKey()', () => {
245.     it('should return a normalized version of the route key', () => {
246.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('$connect')).to.equal('Sconnect');
247. 
248.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo/bar')).to.equal('fooSlashbar');
249. 
250.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo-bar')).to.equal('fooDashbar');
251. 
252.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo_bar')).to.equal('fooUnderscorebar');
253. 
254.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo.bar')).to.equal('fooPeriodbar');
255.     });
256. 
257.     it('converts multiple `-` correctly', () => {
258.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('a-longer-path')).to.equal(
259.         'aDashlongerDashpath'
260.       );
261.     });
262. 
263.     it('converts multiple `-` and `_` correctly', () => {
264.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('a-long_er-path_still')).to.equal(
265.         'aDashlongUnderscoreerDashpathUnderscorestill'
266.       );
267.     });
268.   });
269. 
270.   describe('#getWebsocketsRouteLogicalId()', () => {
271.     it('should return the websockets route logical id', () => {
272.       expect(sdk.naming.getWebsocketsRouteLogicalId('$connect')).to.equal(
273.         'SconnectWebsocketsRoute'
274.       );
275.     });
276.   });
277. 
278.   describe('#getWebsocketsDeploymentLogicalId()', () => {
279.     it('should return the websockets deployment logical id', () => {
280.       expect(sdk.naming.getWebsocketsDeploymentLogicalId('Abc+123=')).to.equal(
281.         'WebsocketsDeploymentAbc123'
282.       );
283.     });
284.   });
285. 
286.   describe('#getWebsocketsStageLogicalId()', () => {
287.     it('should return the websockets stage logical id', () => {
288.       expect(sdk.naming.getWebsocketsStageLogicalId()).to.equal('WebsocketsDeploymentStage');
289.     });
290.   });
291. 
292.   describe('#getWebsocketsAuthorizerLogicalId()', () => {
293.     it('should return the websockets authorizer logical id', () => {
294.       expect(sdk.naming.getWebsocketsAuthorizerLogicalId('auth')).to.equal(
295.         'AuthWebsocketsAuthorizer'
296.       );
297.     });
298.   });
299. 
300.   describe('#getWebsocketsLogGroupLogicalId()', () => {
301.     it('should return the Websockets log group logical id', () => {
302.       expect(sdk.naming.getWebsocketsLogGroupLogicalId()).to.equal('WebsocketsLogGroup');
303.     });
304.   });
305. 
306.   describe('#getApiGatewayName()', () => {
307.     it('should return the composition of stage & service name if custom name not provided', () => {
308.       serverless.service.service = 'myService';
309.       expect(sdk.naming.getApiGatewayName()).to.equal(
310.         `${sdk.naming.provider.getStage()}-${serverless.service.service}`
311.       );
312.     });
313. 
314.     it('should return the custom api name if provided', () => {
315.       serverless.service.provider.apiName = 'app-dev-testApi';
316.       serverless.service.service = 'myService';
317.       serverless.service.provider.stage = sdk.naming.provider.getStage();
318.       expect(sdk.naming.getApiGatewayName()).to.equal('app-dev-testApi');
319.     });
320.   });
321. 
322.   describe('#generateApiGatewayDeploymentLogicalId()', () => {
323.     it('should return ApiGatewayDeployment with a suffix', () => {
324.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId(1234)).to.equal(
325.         'ApiGatewayDeployment1234'
326.       );
327.     });
328.   });
329. 
330.   describe('#getRestApiLogicalId()', () => {
331.     it('should return ApiGatewayRestApi', () => {
332.       expect(sdk.naming.getRestApiLogicalId()).to.equal('ApiGatewayRestApi');
333.     });
334.   });
335. 
336.   describe('#getNormalizedAuthorizerName()', () => {
337.     it('normalize the authorizer name', () => {
338.       expect(sdk.naming.getNormalizedAuthorizerName('authorizerName')).to.equal('AuthorizerName');
339.     });
340.   });
341. 
342.   describe('#getAuthorizerLogicalId()', () => {
343.     it('should normalize the authorizer name and add the standard suffix', () => {
344.       expect(sdk.naming.getAuthorizerLogicalId('authorizerName')).to.equal(
345.         'AuthorizerNameApiGatewayAuthorizer'
346.       );
347.     });
348.   });
349. 
350.   describe('#extractAuthorizerNameFromArn()', () => {
351.     it('should extract the authorizer name from an ARN', () => {
352.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
353.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
354.     });
355.   });
356. 
357.   describe('#normalizePath()', () => {
358.     it('should normalize each part of the resource path and remove non-alpha-numeric characters', () => {
359.       expect(sdk.naming.normalizePath('my/path/to/a-${var}-resource')).to.equal(
360.         'MyPathToADashvarVarDashresource'
361.       );
362.     });
363.   });
364. 
365.   describe('#getResourceLogicalId()', () => {
366.     it('should normalize the resource and add the standard suffix', () => {
367.       expect(sdk.naming.getResourceLogicalId('my/path/to/a-${var}-resource')).to.equal(
368.         'ApiGatewayResourceMyPathToADashvarVarDashresource'
369.       );
370.     });
371.   });
372. 
373.   describe('#extractResourceId()', () => {
374.     it('should extract the normalized resource name', () => {
375.       expect(
376.         sdk.naming.extractResourceId('ApiGatewayResourceMyPathToADashvarVarDashResource')
377.       ).to.equal('MyPathToADashvarVarDashResource');
378.     });
379.   });
380. 
381.   describe('#normalizeMethodName()', () => {
382.     it('should capitalize the first letter and lowercase any other characters', () => {
383.       expect(sdk.naming.normalizeMethodName('gET')).to.equal('Get');
384.     });
385.   });
386. 
387.   describe('#getMethodLogicalId()', () => {
388.     it('', () => {
389.       expect(sdk.naming.getMethodLogicalId('ResourceId', 'get')).to.equal(
390.         'ApiGatewayMethodResourceIdGet'
391.       );
392.     });
393.   });
394. 
395.   describe('#getValidatorLogicalId()', () => {
396.     it('', () => {
397.       expect(sdk.naming.getValidatorLogicalId('ResourceId', 'get')).to.equal(
398.         'ApiGatewayMethodResourceIdGetValidator'
399.       );
400.     });
401.   });
402. 
403.   describe('#getModelLogicalId()', () => {
404.     it('', () => {
405.       expect(sdk.naming.getModelLogicalId('ResourceId', 'get', 'application/json')).to.equal(
406.         'ApiGatewayMethodResourceIdGetApplicationJsonModel'
407.       );
408.     });
409.   });
410. 
411.   describe('#getApiKeyLogicalId(keyIndex)', () => {
412.     it('should produce the given index with ApiGatewayApiKey as a prefix', () => {
413.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal('ApiGatewayApiKey1');
414.     });
415. 
416.     it('should support API Key names', () => {
417.       expect(sdk.naming.getApiKeyLogicalId(1, 'free')).to.equal('ApiGatewayApiKeyFree1');
418.     });
419.   });
420. 
421.   describe('#getApiKeyLogicalIdRegex()', () => {
422.     it('should match the prefix', () => {
423.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('ApiGatewayApiKey')).to.equal(true);
424.     });
425. 
426.     it('should not match a name without the prefix', () => {
427.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('NotThePrefixApiGatewayApiKey')).to.equal(
428.         false
429.       );
430.     });
431. 
432.     it('should match a name with the prefix', () => {
433.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('ApiGatewayApiKeySuffix')).to.equal(true);
434.     });
435.   });
436. 
437.   describe('#getUsagePlanLogicalId()', () => {
438.     it('should return the default ApiGateway usage plan logical id', () => {
439.       expect(sdk.naming.getUsagePlanLogicalId()).to.equal('ApiGatewayUsagePlan');
440.     });
441. 
442.     it('should return the named ApiGateway usage plan logical id', () => {
443.       expect(sdk.naming.getUsagePlanLogicalId('free')).to.equal('ApiGatewayUsagePlanFree');
444.     });
445.   });
446. 
447.   describe('#getUsagePlanKeyLogicalId()', () => {
448.     it('should produce the given index with ApiGatewayUsagePlanKey as a prefix', () => {
449.       expect(sdk.naming.getUsagePlanKeyLogicalId(1)).to.equal('ApiGatewayUsagePlanKey1');
450.     });
451. 
452.     it('should support API Key names', () => {
453.       expect(sdk.naming.getUsagePlanKeyLogicalId(1, 'free')).to.equal(
454.         'ApiGatewayUsagePlanKeyFree1'
455.       );
456.     });
457.   });
458. 
459.   describe('#getStageLogicalId()', () => {
460.     it('should return the API Gateway stage logical id', () => {
461.       expect(sdk.naming.getStageLogicalId()).to.equal('ApiGatewayStage');
462.     });
463.   });
464. 
465.   describe('#getApiGatewayLogGroupLogicalId()', () => {
466.     it('should return the API Gateway log group logical id', () => {
467.       expect(sdk.naming.getApiGatewayLogGroupLogicalId()).to.equal('ApiGatewayLogGroup');
468.     });
469.   });
470. 
471.   describe('#getDeploymentBucketLogicalId()', () => {
472.     it('should return "ServerlessDeploymentBucket"', () => {
473.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal('ServerlessDeploymentBucket');
474.     });
475.   });
476. 
477.   describe('#getDeploymentBucketOutputLogicalId()', () => {
478.     it('should return "ServerlessDeploymentBucketName"', () => {
479.       expect(sdk.naming.getDeploymentBucketOutputLogicalId()).to.equal(
480.         'ServerlessDeploymentBucketName'
481.       );
482.     });
483.   });
484. 
485.   describe('#getDeploymentBucketPolicyLogicalId()', () => {
486.     it('should return "ServerlessDeploymentBucketPolicy"', () => {
487.       expect(sdk.naming.getDeploymentBucketPolicyLogicalId()).to.equal(
488.         'ServerlessDeploymentBucketPolicy'
489.       );
490.     });
491.   });
492. 
493.   describe('#normalizeBucketName()', () => {
494.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
495.       expect(sdk.naming.normalizeBucketName('b!u@c#k$e%t^N&a*m(e')).to.equal('BucketName');
496.     });
497.   });
498. 
499.   describe('#getBucketLogicalId()', () => {
500.     it('should normalize the bucket name and add the standard prefix', () => {
501.       expect(sdk.naming.getBucketLogicalId('b!u@c#k$e%t^N&a*m(e')).to.equal('S3BucketBucketName');
502.     });
503.   });
504. 
505.   describe('#normalizeTopicName()', () => {
506.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
507.       expect(sdk.naming.normalizeTopicName('t!o@p#i$c%N^a&m*e')).to.equal('TopicName');
508.     });
509.   });
510. 
511.   describe('#getTopicLogicalId()', () => {
512.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
513.       expect(sdk.naming.getTopicLogicalId('t!o@p#i$c%N^a&m*e')).to.equal('SNSTopicTopicName');
514.     });
515.   });
516. 
517.   describe('#getScheduleId()', () => {
518.     it('should add the standard suffix', () => {
519.       expect(sdk.naming.getScheduleId('functionName')).to.equal('functionNameSchedule');
520.     });
521.   });
522. 
523.   describe('#getScheduleLogicalId()', () => {
524.     it('should normalize the function name and add the standard suffix including the index', () => {
525.       expect(sdk.naming.getScheduleLogicalId('functionName', 0)).to.equal(
526.         'FunctionNameEventsRuleSchedule0'
527.       );
528.     });
529.   });
530. 
531.   describe('#getStreamConsumerName()', () => {
532.     it('should add the standard suffix', () => {
533.       expect(sdk.naming.getStreamConsumerName('functionName', 'streamName')).to.equal(
534.         'functionNamestreamNameConsumer'
535.       );
536.     });
537.   });
538. 
539.   describe('#getStreamConsumerLogicalId()', () => {
540.     it('should normalize the stream consumer name and add the standard suffix', () => {
541.       expect(sdk.naming.getStreamConsumerLogicalId('streamConsumerName')).to.equal(
542.         'StreamConsumerNameStreamConsumer'
543.       );
544.     });
545.   });
546. 
547.   describe('#getCloudWatchEventId()', () => {
548.     it('should add the standard suffix', () => {
549.       expect(sdk.naming.getCloudWatchEventId('functionName')).to.equal(
550.         'functionNameCloudWatchEvent'
551.       );
552.     });
553.   });
554. 
555.   describe('#getCloudWatchEventLogicalId()', () => {
556.     it('should normalize the function name and add the standard suffix including the index', () => {
557.       expect(sdk.naming.getCloudWatchEventLogicalId('functionName', 0)).to.equal(
558.         'FunctionNameEventsRuleCloudWatchEvent0'
559.       );
560.     });
561.   });
562. 
563.   describe('#getCloudWatchLogLogicalId()', () => {
564.     it('should normalize the function name and add the standard suffix including the index', () => {
565.       expect(sdk.naming.getCloudWatchLogLogicalId('functionName', 0)).to.equal(
566.         'FunctionNameLogsSubscriptionFilterCloudWatchLog0'
567.       );
568.     });
569.   });
570. 
571.   describe('#getCognitoUserPoolLogicalId()', () => {
572.     it('should normalize the user pool name and add the standard prefix', () => {
573.       expect(sdk.naming.getCognitoUserPoolLogicalId('us-east-1_v123sDAS1')).to.equal(
574.         'CognitoUserPoolUseast1v123sDAS1'
575.       );
576.     });
577.   });
578. 
579.   describe('#getLambdaS3PermissionLogicalId()', () => {
580.     it('should normalize the function name and add the standard suffix', () => {
581.       expect(sdk.naming.getLambdaS3PermissionLogicalId('functionName', 'bucket')).to.equal(
582.         'FunctionNameLambdaPermissionBucketS3'
583.       );
584.     });
585.   });
586. 
587.   describe('#getLambdaSnsPermissionLogicalId()', () => {
588.     it(
589.       'should normalize the function and topic names and add them as prefix and suffix to the ' +
590.         'standard permission center',
591.       () => {
592.         expect(sdk.naming.getLambdaSnsPermissionLogicalId('functionName', 'topic')).to.equal(
593.           'FunctionNameLambdaPermissionTopicSNS'
594.         );
595.       }
596.     );
597.   });
598. 
599.   describe('#getLambdaSchedulePermissionLogicalId()', () => {
600.     it('should normalize the function name and add the standard suffix including event index', () => {
601.       expect(sdk.naming.getLambdaSchedulePermissionLogicalId('functionName', 0)).to.equal(
602.         'FunctionNameLambdaPermissionEventsRuleSchedule0'
603.       );
604.     });
605.   });
606. 
607.   describe('#getLambdaCloudWatchEventPermissionLogicalId()', () => {
608.     it('should normalize the function name and add the standard suffix including event index', () => {
609.       expect(sdk.naming.getLambdaCloudWatchEventPermissionLogicalId('functionName', 0)).to.equal(
610.         'FunctionNameLambdaPermissionEventsRuleCloudWatchEvent0'
611.       );
612.     });
613.   });
614. 
615.   describe('#getLambdaApiGatewayPermissionLogicalId()', () => {
616.     it('should normalize the function name and append the standard suffix', () => {
617.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId('functionName')).to.equal(
618.         'FunctionNameLambdaPermissionApiGateway'
619.       );
620.     });
621.   });
622. 
623.   describe('#getIotLogicalId()', () => {
624.     it('should normalize the function name and add the standard suffix including the index', () => {
625.       expect(sdk.naming.getIotLogicalId('functionName', 0)).to.equal('FunctionNameIotTopicRule0');
626.     });
627.   });
628. 
629.   describe('#getLambdaIotPermissionLogicalId()', () => {
630.     it('should normalize the function name and add the standard suffix including event index', () => {
631.       expect(sdk.naming.getLambdaIotPermissionLogicalId('functionName', 0)).to.equal(
632.         'FunctionNameLambdaPermissionIotTopicRule0'
633.       );
634.     });
635.   });
636. 
637.   describe('#getLambdaAlexaSkillPermissionLogicalId()', () => {
638.     it('should normalize the function name and append the standard suffix', () => {
639.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName', 2)).to.equal(
640.         'FunctionNameLambdaPermissionAlexaSkill2'
641.       );
642.     });
643. 
644.     it('should normalize the function name and append a default suffix if not defined', () => {
645.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName')).to.equal(
646.         'FunctionNameLambdaPermissionAlexaSkill0'
647.       );
648.     });
649.   });
650. 
651.   describe('#getLambdaAlexaSmartHomePermissionLogicalId()', () => {
652.     it('should normalize the function name and append the standard suffix', () => {
653.       expect(sdk.naming.getLambdaAlexaSmartHomePermissionLogicalId('functionName', 0)).to.equal(
654.         'FunctionNameLambdaPermissionAlexaSmartHome0'
655.       );
656.     });
657.   });
658. 
659.   describe('#getLambdaSnsSubscriptionLogicalId()', () => {
660.     it('should normalize the function name and append the standard suffix', () => {
661.       expect(sdk.naming.getLambdaSnsSubscriptionLogicalId('functionName', 'topicName')).to.equal(
662.         'FunctionNameSnsSubscriptionTopicName'
663.       );
664.     });
665.   });
666. 
667.   describe('#getLambdaCloudWatchLogPermissionLogicalId()', () => {
668.     it('should normalize the function name and add the standard suffix including event index', () => {
669.       expect(sdk.naming.getLambdaCloudWatchLogPermissionLogicalId('functionName')).to.equal(
670.         'FunctionNameLambdaPermissionLogsSubscriptionFilterCloudWatchLog'
671.       );
672.     });
673.   });
674. 
675.   describe('#getLambdaCognitoUserPoolPermissionLogicalId()', () => {
676.     it('should normalize the function name and add the standard suffix', () => {
677.       expect(
678.         sdk.naming.getLambdaCognitoUserPoolPermissionLogicalId(
679.           'functionName',
680.           'Pool1',
681.           'CustomMessage'
682.         )
683.       ).to.equal('FunctionNameLambdaPermissionCognitoUserPoolPool1TriggerSourceCustomMessage');
684.     });
685. 
686.     describe('#getLambdaAlbPermissionLogicalId()', () => {
687.       it('should normalize the function name', () => {
688.         expect(sdk.naming.getLambdaAlbPermissionLogicalId('functionName')).to.equal(
689.           'FunctionNameLambdaPermissionAlb'
690.         );
691.       });
692.     });
693. 
694.     describe('#getLambdaRegisterTargetPermissionLogicalId()', () => {
695.       it('should normalize the function name and add the correct suffix', () => {
696.         expect(sdk.naming.getLambdaRegisterTargetPermissionLogicalId('functionName')).to.equal(
697.           'FunctionNameLambdaPermissionRegisterTarget'
698.         );
699.       });
700.     });
701.   });
702. 
703.   describe('#getQueueLogicalId()', () => {
704.     it('should normalize the function name and add the standard suffix', () => {
705.       expect(sdk.naming.getQueueLogicalId('functionName', 'MyQueue')).to.equal(
706.         'FunctionNameEventSourceMappingSQSMyQueue'
707.       );
708.     });
709.   });
710. 
711.   describe('#getAlbTargetGroupLogicalId()', () => {
712.     it('should normalize the function name', () => {
713.       expect(sdk.naming.getAlbTargetGroupLogicalId('functionName', 'abc123')).to.equal(
714.         'FunctionNameAlbTargetGroupabc123'
715.       );
716.     });
717. 
718.     it('should normalize the function name and add MultiValue prefix if multiValueHeader is true', () => {
719.       expect(sdk.naming.getAlbTargetGroupLogicalId('functionName', 'abc123', true)).to.equal(
720.         'FunctionNameAlbMultiValueTargetGroupabc123'
721.       );
722.     });
723.   });
724. 
725.   describe('#getAlbListenerRuleLogicalId()', () => {
726.     it('should normalize the function name and add an index', () => {
727.       expect(sdk.naming.getAlbListenerRuleLogicalId('functionName', 0)).to.equal(
728.         'FunctionNameAlbListenerRule0'
729.       );
730.     });
731.   });
732. 
733.   describe('#getAlbTargetGroupName()', () => {
734.     it('should return a unique identifier based on the service name, function name, alb id, multi-value attribute and stage', () => {
735.       serverless.service.service = 'myService';
736.       expect(sdk.naming.getAlbTargetGroupName('functionName', 'abc123', true)).to.equal(
737.         '79039bd239ac0b3f6ff6d9296f23e27c'
738.       );
739.     });
740. 
741.     it('should return a prefixed unique identifer of not longer than 32 characters if alb.targetGroupPrefix is set', () => {
742.       serverless.service.service = 'myService';
743.       serverless.service.provider.alb = {};
744.       serverless.service.provider.alb.targetGroupPrefix = 'myPrefix-';
745.       expect(sdk.naming.getAlbTargetGroupName('functionName', 'abc123', true)).to.equal(
746.         'myPrefix-79039bd239ac0b3f6ff6d92'
747.       );
748.     });
749.   });
750. 
751.   describe('#getAlbTargetGroupNameTagValue()', () => {
752.     it('should return the composition of service name, function name, alb id, multi-value attribute and stage', () => {
753.       serverless.service.service = 'myService';
754.       expect(sdk.naming.getAlbTargetGroupNameTagValue('functionName', 'abc123', true)).to.equal(
755.         `${
756.           serverless.service.service
757.         }-functionName-abc123-multi-value-${sdk.naming.provider.getStage()}`
758.       );
759.     });
760.   });
761. 
762.   describe('#getCustomResourcesArtifactName()', () => {
763.     it('should return the custom resources artifact directory name', () => {
764.       expect(sdk.naming.getCustomResourcesArtifactName()).to.equal('custom-resources.zip');
765.     });
766.   });
767. 
768.   describe('#getCustomResourcesRoleLogicalId()', () => {
769.     it('should return the custom resources role logical id', () => {
770.       expect(sdk.naming.getCustomResourcesRoleLogicalId()).to.equal(
771.         'IamRoleCustomResourcesLambdaExecution'
772.       );
773.     });
774.   });
775. 
776.   describe('#getCustomResourceS3HandlerFunctionName()', () => {
777.     it('should return the name of the S3 custom resource handler function', () => {
778.       expect(sdk.naming.getCustomResourceS3HandlerFunctionName()).to.equal(
779.         'custom-resource-existing-s3'
780.       );
781.     });
782.   });
783. 
784.   describe('#getCustomResourceS3HandlerFunctionLogicalId()', () => {
785.     it('should return the logical id of the S3 custom resource handler function', () => {
786.       expect(sdk.naming.getCustomResourceS3HandlerFunctionLogicalId()).to.equal(
787.         'CustomDashresourceDashexistingDashs3LambdaFunction'
788.       );
789.     });
790.   });
791. 
792.   describe('#getCustomResourceS3ResourceLogicalId()', () => {
793.     it('should return the logical id of the S3 custom resource', () => {
794.       const functionName = 'my-function';
795.       expect(sdk.naming.getCustomResourceS3ResourceLogicalId(functionName)).to.equal(
796.         'MyDashfunctionCustomS31'
797.       );
798.     });
799.   });
800. 
801.   describe('#getCustomResourceCognitoUserPoolHandlerFunctionName()', () => {
802.     it('should return the name of the Cognito User Pool custom resource handler function', () => {
803.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionName()).to.equal(
804.         'custom-resource-existing-cup'
805.       );
806.     });
807.   });
808. 
809.   describe('#getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()', () => {
810.     it('should return the logical id of the Cognito User Pool custom resource handler function', () => {
811.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()).to.equal(
812.         'CustomDashresourceDashexistingDashcupLambdaFunction'
813.       );
814.     });
815.   });
816. 
817.   describe('#getCustomResourceCognitoUserPoolResourceLogicalId()', () => {
818.     it('should return the logical id of the Cognito User Pool custom resource', () => {
819.       const functionName = 'my-function';
820.       expect(sdk.naming.getCustomResourceCognitoUserPoolResourceLogicalId(functionName)).to.equal(
821.         'MyDashfunctionCustomCognitoUserPool1'
822.       );
823.     });
824.   });
825. 
826.   describe('#getCustomResourceEventBridgeHandlerFunctionName()', () => {
827.     it('should return the name of the Event Bridge custom resource handler function', () => {
828.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionName()).to.equal(
829.         'custom-resource-event-bridge'
830.       );
831.     });
832.   });
833. 
834.   describe('#getCustomResourceEventBridgeHandlerFunctionLogicalId()', () => {
835.     it('should return the logical id of the Event Bridge custom resource handler function', () => {
836.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId()).to.equal(
837.         'CustomDashresourceDasheventDashbridgeLambdaFunction'
838.       );
839.     });
840.   });
841. 
842.   describe('#getCustomResourceEventBridgeResourceLogicalId()', () => {
843.     it('should return the logical id of the Event Bridge custom resource', () => {
844.       const functionName = 'my-function';
845.       const index = 1;
846.       expect(
847.         sdk.naming.getCustomResourceEventBridgeResourceLogicalId(functionName, index)
848.       ).to.equal('MyDashfunctionCustomEventBridge1');
849.     });
850.   });
851. 
852.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()', () => {
853.     it('should return the name of the APIGW Account CloudWatch role custom resource handler function', () => {
854.       expect(
855.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()
856.       ).to.equal('custom-resource-apigw-cw-role');
857.     });
858.   });
859. 
860.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()', () => {
861.     it('should return the logical id of the APIGW Account CloudWatch role custom resource handler function', () => {
862.       expect(
863.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()
864.       ).to.equal('CustomDashresourceDashapigwDashcwDashroleLambdaFunction');
865.     });
866.   });
867. 
868.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()', () => {
869.     it('should return the logical id of the APIGW Account CloudWatch role custom resource', () => {
870.       expect(
871.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()
872.       ).to.equal('CustomApiGatewayAccountCloudWatchRole');
873.     });
874.   });
875. 
876.   describe('#getCloudFrontDistributionLogicalId()', () => {
877.     it('should return CloudFront distribution logical id', () => {
878.       expect(sdk.naming.getCloudFrontDistributionLogicalId()).to.equal('CloudFrontDistribution');
879.     });
880.   });
881. 
882.   describe('#getCloudFrontDistributionDomainNameLogicalId()', () => {
883.     it('should return CloudFront distribution domain name logical id', () => {
884.       expect(sdk.naming.getCloudFrontDistributionDomainNameLogicalId()).to.equal(
885.         'CloudFrontDistributionDomainName'
886.       );
887.     });
888.   });
889. 
890.   describe('#getLambdaAtEdgeInvokePermissionLogicalId()', () => {
891.     it('should return lambda@edge invoke permission logical id', () => {
892.       expect(sdk.naming.getLambdaAtEdgeInvokePermissionLogicalId('functionName')).to.equal(
893.         'FunctionNameLambdaFunctionInvokePermission'
894.       );
895.     });
896.   });
897. 
898.   describe('#getCloudFrontOriginId()', () => {
899.     it('should return CloudFront origin id for s3 origin', () => {
900.       expect(
901.         sdk.naming.getCloudFrontOriginId({
902.           S3OriginConfig: {},
903.           DomainName: 'domain.name',
904.           OriginPath: '/path',
905.         })
906.       ).to.equal('s3/domain.name/path');
907.     });
908. 
909.     it('should return CloudFront origin id for custom origin', () => {
910.       expect(
911.         sdk.naming.getCloudFrontOriginId({
912.           CustomOriginConfig: {},
913.           DomainName: 'domain.name',
914.           OriginPath: '/path',
915.         })
916.       ).to.equal('custom/domain.name/path');
917.     });
918. 
919.     it('should return CloudFront origin id from domain as a object', () => {
920.       expect(
921.         sdk.naming.getCloudFrontOriginId({
922.           CustomOriginConfig: {},
923.           DomainName: {
924.             'Fn::Join': ['', ['Ref: ApiGatewayRestApi', '.execute-api.']],
925.           },
926.         })
927.       ).to.equal('custom/FnJoinRefApiGatewayRestApiexecuteapi');
928.     });
929.   });
930. });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 600 - 653
Content:
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });


File: lib/plugins/aws/package/compile/events/sqs/index.test.js
Line number range: 399 - 500
Content:
399.       it('should allow specifying SQS Queues as CFN reference types', () => {
400.         awsCompileSQSEvents.serverless.service.functions = {
401.           first: {
402.             events: [
403.               {
404.                 sqs: {
405.                   arn: { 'Fn::GetAtt': ['SomeQueue', 'Arn'] },
406.                 },
407.               },
408.               {
409.                 sqs: {
410.                   arn: { 'Fn::ImportValue': 'ForeignQueue' },
411.                 },
412.               },
413.               {
414.                 sqs: {
415.                   arn: {
416.                     'Fn::Join': [
417.                       ':',
418.                       [
419.                         'arn',
420.                         'aws',
421.                         'sqs',
422.                         {
423.                           Ref: 'AWS::Region',
424.                         },
425.                         {
426.                           Ref: 'AWS::AccountId',
427.                         },
428.                         'MyQueue',
429.                       ],
430.                     ],
431.                   },
432.                 },
433.               },
434.             ],
435.           },
436.         };
437. 
438.         awsCompileSQSEvents.compileSQSEvents();
439. 
440.         expect(
441.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
442.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement[0]
443.         ).to.deep.equal({
444.           Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
445.           Effect: 'Allow',
446.           Resource: [
447.             {
448.               'Fn::GetAtt': ['SomeQueue', 'Arn'],
449.             },
450.             {
451.               'Fn::ImportValue': 'ForeignQueue',
452.             },
453.             {
454.               'Fn::Join': [
455.                 ':',
456.                 [
457.                   'arn',
458.                   'aws',
459.                   'sqs',
460.                   {
461.                     Ref: 'AWS::Region',
462.                   },
463.                   {
464.                     Ref: 'AWS::AccountId',
465.                   },
466.                   'MyQueue',
467.                 ],
468.               ],
469.             },
470.           ],
471.         });
472.         expect(
473.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
474.             .FirstEventSourceMappingSQSSomeQueue.Properties.EventSourceArn
475.         ).to.deep.equal({ 'Fn::GetAtt': ['SomeQueue', 'Arn'] });
476.         expect(
477.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
478.             .FirstEventSourceMappingSQSForeignQueue.Properties.EventSourceArn
479.         ).to.deep.equal({ 'Fn::ImportValue': 'ForeignQueue' });
480.         expect(
481.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
482.             .FirstEventSourceMappingSQSMyQueue.Properties.EventSourceArn
483.         ).to.deep.equal({
484.           'Fn::Join': [
485.             ':',
486.             [
487.               'arn',
488.               'aws',
489.               'sqs',
490.               {
491.                 Ref: 'AWS::Region',
492.               },
493.               {
494.                 Ref: 'AWS::AccountId',
495.               },
496.               'MyQueue',
497.             ],
498.           ],
499.         });
500.       });


File: lib/plugins/aws/package/compile/events/sqs/index.test.js
Line number range: 521 - 552
Content:
521.       it('should add the necessary IAM role statements', () => {
522.         awsCompileSQSEvents.serverless.service.functions = {
523.           first: {
524.             events: [
525.               {
526.                 sqs: 'arn:aws:sqs:region:account:MyFirstQueue',
527.               },
528.               {
529.                 sqs: 'arn:aws:sqs:region:account:MySecondQueue',
530.               },
531.             ],
532.           },
533.         };
534. 
535.         const iamRoleStatements = [
536.           {
537.             Effect: 'Allow',
538.             Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
539.             Resource: [
540.               'arn:aws:sqs:region:account:MyFirstQueue',
541.               'arn:aws:sqs:region:account:MySecondQueue',
542.             ],
543.           },
544.         ];
545. 
546.         awsCompileSQSEvents.compileSQSEvents();
547. 
548.         expect(
549.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
550.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement
551.         ).to.deep.equal(iamRoleStatements);
552.       });


File: lib/plugins/aws/package/index.test.js
Line number range: 1 - 167
Content:
1. 'use strict';
2. 
3. const AwsProvider = require('../provider/awsProvider');
4. const AwsPackage = require('./index');
5. const Serverless = require('../../../Serverless');
6. const CLI = require('../../../classes/CLI');
7. const expect = require('chai').expect;
8. const sinon = require('sinon');
9. const path = require('path');
10. 
11. describe('AwsPackage', () => {
12.   let awsPackage;
13.   let serverless;
14.   let options;
15. 
16.   beforeEach(() => {
17.     serverless = new Serverless();
18.     options = {
19.       stage: 'dev',
20.       region: 'us-east-1',
21.     };
22.     serverless.setProvider('aws', new AwsProvider(serverless, options));
23.     serverless.config.servicePath = 'foo';
24.     serverless.cli = new CLI(serverless);
25.     awsPackage = new AwsPackage(serverless, options);
26.   });
27. 
28.   describe('#constructor()', () => {
29.     it('should set the serverless instance', () => {
30.       expect(awsPackage.serverless).to.equal(serverless);
31.     });
32. 
33.     it('should set options', () => {
34.       expect(awsPackage.options).to.equal(options);
35.     });
36. 
37.     it('should set the service path if provided', () => {
38.       expect(awsPackage.servicePath).to.equal('foo');
39.     });
40. 
41.     it('should default to an empty service path if not provided', () => {
42.       serverless.config.servicePath = false;
43.       awsPackage = new AwsPackage(serverless, options);
44. 
45.       expect(awsPackage.servicePath).to.equal('');
46.     });
47. 
48.     it('should use the options package path if provided', () => {
49.       options.package = 'package-options';
50.       awsPackage = new AwsPackage(serverless, options);
51. 
52.       expect(awsPackage.packagePath).to.equal('package-options');
53.     });
54. 
55.     it('should use the services package path if provided', () => {
56.       serverless.service = {
57.         package: {
58.           path: 'package-service',
59.         },
60.       };
61.       awsPackage = new AwsPackage(serverless, options);
62. 
63.       expect(awsPackage.packagePath).to.equal('package-service');
64.     });
65. 
66.     it('should default to the .serverless directory as the package path', () => {
67.       expect(awsPackage.packagePath).to.equal(path.join('foo', '.serverless'));
68.     });
69. 
70.     it('should set the provider variable to an instance of AwsProvider', () =>
71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));
72. 
73.     it('should have commands', () => expect(awsPackage.commands).to.be.not.empty);
74. 
75.     it('should have hooks', () => expect(awsPackage.hooks).to.be.not.empty);
76.   });
77. 
78.   describe('hooks', () => {
79.     let spawnStub;
80.     let generateCoreTemplateStub;
81.     let mergeIamTemplatesStub;
82.     let generateArtifactDirectoryNameStub;
83.     let mergeCustomProviderResourcesStub;
84.     let saveCompiledTemplateStub;
85.     let saveServiceStateStub;
86. 
87.     beforeEach(() => {
88.       spawnStub = sinon.stub(serverless.pluginManager, 'spawn');
89.       generateCoreTemplateStub = sinon.stub(awsPackage, 'generateCoreTemplate').resolves();
90.       mergeIamTemplatesStub = sinon.stub(awsPackage, 'mergeIamTemplates').resolves();
91.       generateArtifactDirectoryNameStub = sinon
92.         .stub(awsPackage, 'generateArtifactDirectoryName')
93.         .resolves();
94.       mergeCustomProviderResourcesStub = sinon
95.         .stub(awsPackage, 'mergeCustomProviderResources')
96.         .resolves();
97.       saveCompiledTemplateStub = sinon.stub(awsPackage, 'saveCompiledTemplate').resolves();
98.       saveServiceStateStub = sinon.stub(awsPackage, 'saveServiceState').resolves();
99.     });
100. 
101.     afterEach(() => {
102.       serverless.pluginManager.spawn.restore();
103.       awsPackage.generateCoreTemplate.restore();
104.       awsPackage.mergeIamTemplates.restore();
105.       awsPackage.generateArtifactDirectoryName.restore();
106.       awsPackage.mergeCustomProviderResources.restore();
107.       awsPackage.saveCompiledTemplate.restore();
108.       awsPackage.saveServiceState.restore();
109.     });
110. 
111.     it('should run "package:cleanup" hook', () => {
112.       const spawnAwsCommonValidateStub = spawnStub.withArgs('aws:common:validate').resolves();
113.       const spawnAwsCommonCleanupTempDirStub = spawnStub
114.         .withArgs('aws:common:cleanupTempDir')
115.         .resolves();
116. 
117.       return awsPackage.hooks['package:cleanup']().then(() => {
118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);
119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(
120.           true
121.         );
122.       });
123.     });
124. 
125.     it('should run "package:initialize" hook', () =>
126.       awsPackage.hooks['package:initialize']().then(() => {
127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);
128.       }));
129. 
130.     it('should run "package:setupProviderConfiguration" hook', () =>
131.       awsPackage.hooks['package:setupProviderConfiguration']().then(() => {
132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);
133.       }));
134. 
135.     it('should run "before:package:compileFunctions" hook', () =>
136.       awsPackage.hooks['before:package:compileFunctions']().then(() => {
137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);
138.       }));
139. 
140.     it('should run "package:finalize" hook', () => {
141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs('aws:package:finalize').resolves();
142. 
143.       return awsPackage.hooks['package:finalize']().then(() => {
144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);
145.       });
146.     });
147. 
148.     it('should run "aws:package:finalize:mergeCustomProviderResources" hook', () =>
149.       awsPackage.hooks['aws:package:finalize:mergeCustomProviderResources']().then(() => {
150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);
151.       }));
152. 
153.     it('should run "aws:package:finalize:saveServiceState" hook', () => {
154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub
155.         .withArgs('aws:common:moveArtifactsToPackage')
156.         .resolves();
157. 
158.       return awsPackage.hooks['aws:package:finalize:saveServiceState']().then(() => {
159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);
160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);
161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(
162.           true
163.         );
164.       });
165.     });
166.   });
167. });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:35:43,851 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The task requires returning 5 complete, self-contained tests with all imports, setup, mocks, assertions, file paths, and exact line numbers. Currently, we only have partial snippets from sns/index.test.js and sqs/index.test.js without their imports or full setups, and no integration tests were provided. To extract complete test cases and preserve exact line numbers, the full content of these test files is essential. Additionally, we may need any other tests that assert SQS QueuePolicy properties (Queues vs Resource ARN/Ref) for SNS redrivePolicy to ensure relevance.' query='Please provide the full content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and lib/plugins/aws/package/compile/events/sqs/index.test.js.' extra_requirements='If these files lack assertions for SQS QueuePolicy properties under SNS redrivePolicy, please also include any other test files that validate QueuePolicy generation for SNS redrivePolicy, with exact paths and line numbers.' purpose='I need complete test implementations to extract 5 relevant, self-contained test cases demonstrating SNS redrivePolicy and SQS policy handling, preserving imports and exact line numbers.'
2025-11-13 20:35:43,853 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and lib/plugins/aws/package/compile/events/sqs/index.test.js.
2025-11-13 20:35:48,285 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.', 'query_extra_requirements': 'If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.', 'query_purpose': 'I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. ", 'start_line_number': 1, 'end_line_number': 7}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });", 'start_line_number': 600, 'end_line_number': 653}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });", 'start_line_number': 42, 'end_line_number': 88}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });", 'start_line_number': 90, 'end_line_number': 149}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });", 'start_line_number': 151, 'end_line_number': 183}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });", 'start_line_number': 217, 'end_line_number': 247}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });", 'start_line_number': 249, 'end_line_number': 277}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });", 'start_line_number': 279, 'end_line_number': 310}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });", 'start_line_number': 562, 'end_line_number': 598}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "1. 'use strict';\n2. \n3. const path = require('path');\n4. const BbPromise = require('bluebird');\n5. const { expect } = require('chai');\n6. \n7. const { getTmpDirPath } = require('../../utils/fs');\n8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');\n9. const {\n10.   createTestService,\n11.   deployService,\n12.   removeService,\n13.   waitForFunctionLogs,\n14. } = require('../../utils/integration');\n15. const { getMarkers } = require('../shared/utils');\n16. ", 'start_line_number': 1, 'end_line_number': 16}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '27.   before(async () => {\n28.     tmpDirPath = getTmpDirPath();\n29.     console.info(`Temporary path: ${tmpDirPath}`);\n30.     const serverlessConfig = await createTestService(tmpDirPath, {\n31.       templateDir: path.join(__dirname, \'service\'),\n32.       filesToAdd: [path.join(__dirname, \'..\', \'shared\')],\n33.       serverlessConfigHook:\n34.         // Ensure unique topics (to avoid collision among concurrent CI runs)\n35.         config => {\n36.           minimalTopicName = `${config.service}-minimal`;\n37.           filteredTopicName = `${config.service}-filtered`;\n38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;\n39.           existingTopicName = `${config.service}-existing`;\n40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;\n41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;\n42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;\n43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;\n44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;\n45.           config.functions.snsExisting.events[0].sns.arn[\'Fn::Join\'][1][3] = existingTopicName;\n46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;\n47.         },\n48.     });\n49.     serviceName = serverlessConfig.service;\n50.     stackName = `${serviceName}-${stage}`;\n51.     // create "existing" SNS topics\n52.     // NOTE: deployment can only be done once the SNS topics are created\n53.     console.info(`Creating SNS topic "${existingTopicName}"...`);\n54.     return createSnsTopic(existingTopicName).then(() => {\n55.       console.info(`Deploying "${stackName}" service...`);\n56.       return deployService(tmpDirPath);\n57.     });\n58.   });', 'start_line_number': 27, 'end_line_number': 58}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "67.   describe('Minimal Setup', () => {\n68.     it('should invoke on a topic message', () => {\n69.       const functionName = 'snsMinimal';\n70.       const markers = getMarkers(functionName);\n71.       const message = 'Hello from SNS!';\n72. \n73.       return publishSnsMessage(minimalTopicName, message)\n74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n75.         .then(logs => {\n76.           expect(logs).to.include(functionName);\n77.           expect(logs).to.include(message);\n78.         });\n79.     });\n80.   });", 'start_line_number': 67, 'end_line_number': 80}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '82.   describe(\'Multiple and Filtered Setup\', () => {\n83.     it(\'should invoke on a topic message that matches filter\', () => {\n84.       const leftFunctionName = \'snsMultipleFilteredLeft\';\n85.       const leftMarkers = getMarkers(leftFunctionName);\n86.       const rightFunctionName = \'snsMultipleFilteredRight\';\n87.       const rightMarkers = getMarkers(rightFunctionName);\n88.       const leftMessage = \'Hello to the left-side from SNS!\';\n89.       const rightMessage = \'Hello to the right-side from SNS!\';\n90.       const middleMessage = \'Hello to the middle-side from SNS!\';\n91.       const leftAttributes = { side: { DataType: \'String\', StringValue: \'left\' } };\n92.       const middleAttributes = { side: { DataType: \'String\', StringValue: \'middle\' } };\n93.       const rightAttributes = { side: { DataType: \'String\', StringValue: \'right\' } };\n94. \n95.       return BbPromise.all([\n96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),\n97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),\n98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),\n99.       ])\n100.         .then(() =>\n101.           BbPromise.all([\n102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),\n103.             waitForFunctionLogs(\n104.               tmpDirPath,\n105.               rightFunctionName,\n106.               rightMarkers.start,\n107.               rightMarkers.end\n108.             ),\n109.           ])\n110.         )\n111.         .then(logs => {\n112.           const leftLogs = logs[0];\n113.           const rightLogs = logs[1];\n114.           // left side is filtered to only get "left" messages from topic:\n115.           expect(leftLogs).to.include(leftFunctionName);\n116.           expect(leftLogs).to.include(leftMessage);\n117.           expect(leftLogs).not.to.include(middleMessage);\n118.           expect(leftLogs).not.to.include(rightMessage);\n119.           // right side is filtered to only get "right" messages from topic:\n120.           expect(rightLogs).to.include(rightFunctionName);\n121.           expect(rightLogs).not.to.include(leftMessage);\n122.           expect(rightLogs).not.to.include(middleMessage);\n123.           expect(rightLogs).to.include(rightMessage);\n124.           // "middle" messages will not cause an invocation.\n125.         });\n126.     });\n127.   });', 'start_line_number': 82, 'end_line_number': 127}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "129.   describe('Existing Setup', () => {\n130.     it('should invoke on an existing topic message', () => {\n131.       const functionName = 'snsExisting';\n132.       const markers = getMarkers(functionName);\n133.       const message = 'Hello from an existing SNS!';\n134. \n135.       return publishSnsMessage(existingTopicName, message)\n136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n137.         .then(logs => {\n138.           expect(logs).to.include(functionName);\n139.           expect(logs).to.include(message);\n140.         });\n141.     });\n142.   });", 'start_line_number': 129, 'end_line_number': 142}]}]
2025-11-13 20:35:48,285 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 1 memories from memory
2025-11-13 20:35:48,285 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 14 contexts from memory
2025-11-13 20:35:48,286 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 14 contexts from memory
2025-11-13 20:35:48,288 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 14 new contexts to 5 existing contexts
2025-11-13 20:35:48,289 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 18 total contexts (removed 1 duplicates)
2025-11-13 20:35:48,291 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


OBJECTIVE: Find 5 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 5 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 5 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.
Extra Requirements: If any file lacks direct coverage of SNS redrive policy/SQS QueuePolicy, please also include any unit tests that compile SNS events or generate SQS policies (with exact paths and line numbers).
Purpose: I need the exact test implementations and their line numbers to return 5 complete, relevant test cases demonstrating similar functionality to the reported bug.

Previous refined query 2:
Essential Query: Please provide the full content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js and lib/plugins/aws/package/compile/events/sqs/index.test.js.
Extra Requirements: If these files lack assertions for SQS QueuePolicy properties under SNS redrivePolicy, please also include any other test files that validate QueuePolicy generation for SNS redrivePolicy, with exact paths and line numbers.
Purpose: I need complete test implementations to extract 5 relevant, self-contained test cases demonstrating SNS redrivePolicy and SQS policy handling, preserving imports and exact line numbers.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/lib/naming.test.js
Line number range: 1 - 930
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. 
5. const SDK = require('../provider/awsProvider');
6. const Serverless = require('../../../Serverless');
7. 
8. describe('#naming()', () => {
9.   let options;
10.   let serverless;
11.   let sdk;
12. 
13.   beforeEach(() => {
14.     options = {
15.       stage: 'dev',
16.       region: 'us-east-1',
17.     };
18.     serverless = new Serverless(options);
19.     sdk = new SDK(serverless, options);
20.   });
21. 
22.   describe('#normalizeName()', () => {
23.     it('should capitalize the first letter', () => {
24.       expect(sdk.naming.normalizeName('name')).to.equal('Name');
25.     });
26. 
27.     it('should have no effect on caps', () => {
28.       expect(sdk.naming.normalizeName('Name')).to.equal('Name');
29.     });
30. 
31.     it('should have no effect on the rest of the name', () => {
32.       expect(sdk.naming.normalizeName('nAME')).to.equal('NAME');
33.     });
34.   });
35. 
36.   describe('#normalizeNameToAlphaNumericOnly()', () => {
37.     it('should strip non-alpha-numeric characters', () => {
38.       expect(
39.         sdk.naming.normalizeNameToAlphaNumericOnly('`!@#$%^&*()-={}|[]\\:";\'<>?,./')
40.       ).to.equal('');
41.     });
42. 
43.     it('should apply normalizeName to the remaining characters', () => {
44.       expect(sdk.naming.normalizeNameToAlphaNumericOnly('a-b-c')).to.equal('Abc');
45.     });
46.   });
47. 
48.   describe('#normalizePathPart()', () => {
49.     it('converts `-` to `Dash`', () => {
50.       expect(sdk.naming.normalizePathPart('a-path')).to.equal('ADashpath');
51.     });
52. 
53.     it('converts variable declarations (`${var}`) to `VariableVar`', () => {
54.       expect(sdk.naming.normalizePathPart('${variable}')).to.equal('VariableVar');
55.     });
56. 
57.     it('converts variable declarations prefixes to `VariableVarpath`', () => {
58.       expect(sdk.naming.normalizePathPart('${variable}Path')).to.equal('VariableVarpath');
59.     });
60. 
61.     it('converts variable declarations suffixes to `PathvariableVar`', () => {
62.       expect(sdk.naming.normalizePathPart('path${variable}')).to.equal('PathvariableVar');
63.     });
64. 
65.     it('converts variable declarations in center to `PathvariableVardir`', () => {
66.       expect(sdk.naming.normalizePathPart('path${variable}Dir')).to.equal('PathvariableVardir');
67.     });
68.   });
69. 
70.   describe('#getServiceEndpointRegex()', () => {
71.     it('should match the prefix', () => {
72.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpoint')).to.equal(true);
73.     });
74. 
75.     it('should not match a name without the prefix', () => {
76.       expect(sdk.naming.getServiceEndpointRegex().test('NotThePrefixServiceEndpoint')).to.equal(
77.         false
78.       );
79.     });
80. 
81.     it('should match a name with the prefix', () => {
82.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpointForAService')).to.equal(
83.         true
84.       );
85.     });
86.   });
87. 
88.   describe('#getStackName()', () => {
89.     it('should use the service name & stage if custom stack name not provided', () => {
90.       serverless.service.service = 'myService';
91.       expect(sdk.naming.getStackName()).to.equal(
92.         `${serverless.service.service}-${sdk.naming.provider.getStage()}`
93.       );
94.     });
95. 
96.     it('should use the custom stack name if provided', () => {
97.       serverless.service.provider.stackName = 'app-dev-testApp';
98.       serverless.service.service = 'myService';
99.       serverless.service.provider.stage = sdk.naming.provider.getStage();
100.       expect(sdk.naming.getStackName()).to.equal('app-dev-testApp');
101.     });
102.   });
103. 
104.   describe('#getRolePath()', () => {
105.     it('should return `/`', () => {
106.       expect(sdk.naming.getRolePath()).to.equal('/');
107.     });
108.   });
109. 
110.   describe('#getRoleName()', () => {
111.     it('uses the service name, stage, and region to generate a role name', () => {
112.       serverless.service.service = 'myService';
113.       expect(sdk.naming.getRoleName()).to.eql({
114.         'Fn::Join': [
115.           '-',
116.           [
117.             serverless.service.service,
118.             sdk.naming.provider.getStage(),
119.             { Ref: 'AWS::Region' },
120.             'lambdaRole',
121.           ],
122.         ],
123.       });
124.     });
125.   });
126. 
127.   describe('#getRoleLogicalId()', () => {
128.     it('should return the expected role name (IamRoleLambdaExecution)', () => {
129.       expect(sdk.naming.getRoleLogicalId()).to.equal('IamRoleLambdaExecution');
130.     });
131.   });
132. 
133.   describe('#getPolicyName()', () => {
134.     it('should use the stage and service name', () => {
135.       serverless.service.service = 'myService';
136.       expect(sdk.naming.getPolicyName()).to.eql({
137.         'Fn::Join': ['-', [sdk.naming.provider.getStage(), serverless.service.service, 'lambda']],
138.       });
139.     });
140.   });
141. 
142.   describe('#getLogicalLogGroupName()', () => {
143.     it('should prefix the normalized function name to "LogGroup"', () => {
144.       expect(sdk.naming.getLogGroupLogicalId('functionName')).to.equal('FunctionNameLogGroup');
145.     });
146.   });
147. 
148.   describe('#getLogGroupName()', () => {
149.     it('should add the function name to the log group name', () => {
150.       expect(sdk.naming.getLogGroupName('functionName')).to.equal('/aws/lambda/functionName');
151.     });
152.   });
153. 
154.   describe('#getNormalizedFunctionName()', () => {
155.     it('should normalize the given functionName', () => {
156.       expect(sdk.naming.getNormalizedFunctionName('functionName')).to.equal('FunctionName');
157.     });
158. 
159.     it('should normalize the given functionName with an underscore', () => {
160.       expect(sdk.naming.getNormalizedFunctionName('hello_world')).to.equal('HelloUnderscoreworld');
161.     });
162. 
163.     it('should normalize the given functionName with a dash', () => {
164.       expect(sdk.naming.getNormalizedFunctionName('hello-world')).to.equal('HelloDashworld');
165.     });
166.   });
167. 
168.   describe('#extractAuthorizerNameFromArn()', () => {
169.     it('should extract everything after the last colon and dash', () => {
170.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
171.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
172.     });
173.   });
174. 
175.   describe('#extractLambdaNameFromArn()', () => {
176.     it('should extract everything after the last colon', () => {
177.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
178.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal('my-dev-lambda');
179.     });
180.   });
181. 
182.   describe('#getLambdaLogicalId()', () => {
183.     it('should normalize the function name and add the logical suffix', () => {
184.       expect(sdk.naming.getLambdaLogicalId('functionName')).to.equal('FunctionNameLambdaFunction');
185.     });
186.   });
187. 
188.   describe('#getLambdaLogicalIdRegex()', () => {
189.     it('should match the suffix', () => {
190.       expect(sdk.naming.getLambdaLogicalIdRegex().test('LambdaFunction')).to.equal(true);
191.     });
192. 
193.     it('should not match a name without the suffix', () => {
194.       expect(sdk.naming.getLambdaLogicalIdRegex().test('LambdaFunctionNotTheSuffix')).to.equal(
195.         false
196.       );
197.     });
198. 
199.     it('should match a name with the suffix', () => {
200.       expect(sdk.naming.getLambdaLogicalIdRegex().test('AFunctionNameLambdaFunction')).to.equal(
201.         true
202.       );
203.     });
204.   });
205. 
206.   describe('#getWebsocketsApiName()', () => {
207.     it('should return the composition of stage & service name if custom name not provided', () => {
208.       serverless.service.service = 'myService';
209.       expect(sdk.naming.getWebsocketsApiName()).to.equal(
210.         `${sdk.naming.provider.getStage()}-${serverless.service.service}-websockets`
211.       );
212.     });
213. 
214.     it('should return the custom api name if provided', () => {
215.       serverless.service.provider.websocketsApiName = 'app-dev-websockets-testApi';
216.       serverless.service.service = 'myService';
217.       serverless.service.provider.stage = sdk.naming.provider.getStage();
218.       expect(sdk.naming.getWebsocketsApiName()).to.equal('app-dev-websockets-testApi');
219.     });
220.   });
221. 
222.   describe('#getWebsocketsApiLogicalId()', () => {
223.     it('should return the websocket API logical id', () => {
224.       expect(sdk.naming.getWebsocketsApiLogicalId()).to.equal('WebsocketsApi');
225.     });
226.   });
227. 
228.   describe('#getWebsocketsIntegrationLogicalId()', () => {
229.     it('should return the integrations logical id', () => {
230.       expect(sdk.naming.getWebsocketsIntegrationLogicalId('myFunc')).to.equal(
231.         'MyFuncWebsocketsIntegration'
232.       );
233.     });
234.   });
235. 
236.   describe('#getLambdaWebsocketsPermissionLogicalId()', () => {
237.     it('should return the lambda websocket permission logical id', () => {
238.       expect(sdk.naming.getLambdaWebsocketsPermissionLogicalId('myFunc')).to.equal(
239.         'MyFuncLambdaPermissionWebsockets'
240.       );
241.     });
242.   });
243. 
244.   describe('#getNormalizedWebsocketsRouteKey()', () => {
245.     it('should return a normalized version of the route key', () => {
246.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('$connect')).to.equal('Sconnect');
247. 
248.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo/bar')).to.equal('fooSlashbar');
249. 
250.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo-bar')).to.equal('fooDashbar');
251. 
252.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo_bar')).to.equal('fooUnderscorebar');
253. 
254.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('foo.bar')).to.equal('fooPeriodbar');
255.     });
256. 
257.     it('converts multiple `-` correctly', () => {
258.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('a-longer-path')).to.equal(
259.         'aDashlongerDashpath'
260.       );
261.     });
262. 
263.     it('converts multiple `-` and `_` correctly', () => {
264.       expect(sdk.naming.getNormalizedWebsocketsRouteKey('a-long_er-path_still')).to.equal(
265.         'aDashlongUnderscoreerDashpathUnderscorestill'
266.       );
267.     });
268.   });
269. 
270.   describe('#getWebsocketsRouteLogicalId()', () => {
271.     it('should return the websockets route logical id', () => {
272.       expect(sdk.naming.getWebsocketsRouteLogicalId('$connect')).to.equal(
273.         'SconnectWebsocketsRoute'
274.       );
275.     });
276.   });
277. 
278.   describe('#getWebsocketsDeploymentLogicalId()', () => {
279.     it('should return the websockets deployment logical id', () => {
280.       expect(sdk.naming.getWebsocketsDeploymentLogicalId('Abc+123=')).to.equal(
281.         'WebsocketsDeploymentAbc123'
282.       );
283.     });
284.   });
285. 
286.   describe('#getWebsocketsStageLogicalId()', () => {
287.     it('should return the websockets stage logical id', () => {
288.       expect(sdk.naming.getWebsocketsStageLogicalId()).to.equal('WebsocketsDeploymentStage');
289.     });
290.   });
291. 
292.   describe('#getWebsocketsAuthorizerLogicalId()', () => {
293.     it('should return the websockets authorizer logical id', () => {
294.       expect(sdk.naming.getWebsocketsAuthorizerLogicalId('auth')).to.equal(
295.         'AuthWebsocketsAuthorizer'
296.       );
297.     });
298.   });
299. 
300.   describe('#getWebsocketsLogGroupLogicalId()', () => {
301.     it('should return the Websockets log group logical id', () => {
302.       expect(sdk.naming.getWebsocketsLogGroupLogicalId()).to.equal('WebsocketsLogGroup');
303.     });
304.   });
305. 
306.   describe('#getApiGatewayName()', () => {
307.     it('should return the composition of stage & service name if custom name not provided', () => {
308.       serverless.service.service = 'myService';
309.       expect(sdk.naming.getApiGatewayName()).to.equal(
310.         `${sdk.naming.provider.getStage()}-${serverless.service.service}`
311.       );
312.     });
313. 
314.     it('should return the custom api name if provided', () => {
315.       serverless.service.provider.apiName = 'app-dev-testApi';
316.       serverless.service.service = 'myService';
317.       serverless.service.provider.stage = sdk.naming.provider.getStage();
318.       expect(sdk.naming.getApiGatewayName()).to.equal('app-dev-testApi');
319.     });
320.   });
321. 
322.   describe('#generateApiGatewayDeploymentLogicalId()', () => {
323.     it('should return ApiGatewayDeployment with a suffix', () => {
324.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId(1234)).to.equal(
325.         'ApiGatewayDeployment1234'
326.       );
327.     });
328.   });
329. 
330.   describe('#getRestApiLogicalId()', () => {
331.     it('should return ApiGatewayRestApi', () => {
332.       expect(sdk.naming.getRestApiLogicalId()).to.equal('ApiGatewayRestApi');
333.     });
334.   });
335. 
336.   describe('#getNormalizedAuthorizerName()', () => {
337.     it('normalize the authorizer name', () => {
338.       expect(sdk.naming.getNormalizedAuthorizerName('authorizerName')).to.equal('AuthorizerName');
339.     });
340.   });
341. 
342.   describe('#getAuthorizerLogicalId()', () => {
343.     it('should normalize the authorizer name and add the standard suffix', () => {
344.       expect(sdk.naming.getAuthorizerLogicalId('authorizerName')).to.equal(
345.         'AuthorizerNameApiGatewayAuthorizer'
346.       );
347.     });
348.   });
349. 
350.   describe('#extractAuthorizerNameFromArn()', () => {
351.     it('should extract the authorizer name from an ARN', () => {
352.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
353.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
354.     });
355.   });
356. 
357.   describe('#normalizePath()', () => {
358.     it('should normalize each part of the resource path and remove non-alpha-numeric characters', () => {
359.       expect(sdk.naming.normalizePath('my/path/to/a-${var}-resource')).to.equal(
360.         'MyPathToADashvarVarDashresource'
361.       );
362.     });
363.   });
364. 
365.   describe('#getResourceLogicalId()', () => {
366.     it('should normalize the resource and add the standard suffix', () => {
367.       expect(sdk.naming.getResourceLogicalId('my/path/to/a-${var}-resource')).to.equal(
368.         'ApiGatewayResourceMyPathToADashvarVarDashresource'
369.       );
370.     });
371.   });
372. 
373.   describe('#extractResourceId()', () => {
374.     it('should extract the normalized resource name', () => {
375.       expect(
376.         sdk.naming.extractResourceId('ApiGatewayResourceMyPathToADashvarVarDashResource')
377.       ).to.equal('MyPathToADashvarVarDashResource');
378.     });
379.   });
380. 
381.   describe('#normalizeMethodName()', () => {
382.     it('should capitalize the first letter and lowercase any other characters', () => {
383.       expect(sdk.naming.normalizeMethodName('gET')).to.equal('Get');
384.     });
385.   });
386. 
387.   describe('#getMethodLogicalId()', () => {
388.     it('', () => {
389.       expect(sdk.naming.getMethodLogicalId('ResourceId', 'get')).to.equal(
390.         'ApiGatewayMethodResourceIdGet'
391.       );
392.     });
393.   });
394. 
395.   describe('#getValidatorLogicalId()', () => {
396.     it('', () => {
397.       expect(sdk.naming.getValidatorLogicalId('ResourceId', 'get')).to.equal(
398.         'ApiGatewayMethodResourceIdGetValidator'
399.       );
400.     });
401.   });
402. 
403.   describe('#getModelLogicalId()', () => {
404.     it('', () => {
405.       expect(sdk.naming.getModelLogicalId('ResourceId', 'get', 'application/json')).to.equal(
406.         'ApiGatewayMethodResourceIdGetApplicationJsonModel'
407.       );
408.     });
409.   });
410. 
411.   describe('#getApiKeyLogicalId(keyIndex)', () => {
412.     it('should produce the given index with ApiGatewayApiKey as a prefix', () => {
413.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal('ApiGatewayApiKey1');
414.     });
415. 
416.     it('should support API Key names', () => {
417.       expect(sdk.naming.getApiKeyLogicalId(1, 'free')).to.equal('ApiGatewayApiKeyFree1');
418.     });
419.   });
420. 
421.   describe('#getApiKeyLogicalIdRegex()', () => {
422.     it('should match the prefix', () => {
423.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('ApiGatewayApiKey')).to.equal(true);
424.     });
425. 
426.     it('should not match a name without the prefix', () => {
427.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('NotThePrefixApiGatewayApiKey')).to.equal(
428.         false
429.       );
430.     });
431. 
432.     it('should match a name with the prefix', () => {
433.       expect(sdk.naming.getApiKeyLogicalIdRegex().test('ApiGatewayApiKeySuffix')).to.equal(true);
434.     });
435.   });
436. 
437.   describe('#getUsagePlanLogicalId()', () => {
438.     it('should return the default ApiGateway usage plan logical id', () => {
439.       expect(sdk.naming.getUsagePlanLogicalId()).to.equal('ApiGatewayUsagePlan');
440.     });
441. 
442.     it('should return the named ApiGateway usage plan logical id', () => {
443.       expect(sdk.naming.getUsagePlanLogicalId('free')).to.equal('ApiGatewayUsagePlanFree');
444.     });
445.   });
446. 
447.   describe('#getUsagePlanKeyLogicalId()', () => {
448.     it('should produce the given index with ApiGatewayUsagePlanKey as a prefix', () => {
449.       expect(sdk.naming.getUsagePlanKeyLogicalId(1)).to.equal('ApiGatewayUsagePlanKey1');
450.     });
451. 
452.     it('should support API Key names', () => {
453.       expect(sdk.naming.getUsagePlanKeyLogicalId(1, 'free')).to.equal(
454.         'ApiGatewayUsagePlanKeyFree1'
455.       );
456.     });
457.   });
458. 
459.   describe('#getStageLogicalId()', () => {
460.     it('should return the API Gateway stage logical id', () => {
461.       expect(sdk.naming.getStageLogicalId()).to.equal('ApiGatewayStage');
462.     });
463.   });
464. 
465.   describe('#getApiGatewayLogGroupLogicalId()', () => {
466.     it('should return the API Gateway log group logical id', () => {
467.       expect(sdk.naming.getApiGatewayLogGroupLogicalId()).to.equal('ApiGatewayLogGroup');
468.     });
469.   });
470. 
471.   describe('#getDeploymentBucketLogicalId()', () => {
472.     it('should return "ServerlessDeploymentBucket"', () => {
473.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal('ServerlessDeploymentBucket');
474.     });
475.   });
476. 
477.   describe('#getDeploymentBucketOutputLogicalId()', () => {
478.     it('should return "ServerlessDeploymentBucketName"', () => {
479.       expect(sdk.naming.getDeploymentBucketOutputLogicalId()).to.equal(
480.         'ServerlessDeploymentBucketName'
481.       );
482.     });
483.   });
484. 
485.   describe('#getDeploymentBucketPolicyLogicalId()', () => {
486.     it('should return "ServerlessDeploymentBucketPolicy"', () => {
487.       expect(sdk.naming.getDeploymentBucketPolicyLogicalId()).to.equal(
488.         'ServerlessDeploymentBucketPolicy'
489.       );
490.     });
491.   });
492. 
493.   describe('#normalizeBucketName()', () => {
494.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
495.       expect(sdk.naming.normalizeBucketName('b!u@c#k$e%t^N&a*m(e')).to.equal('BucketName');
496.     });
497.   });
498. 
499.   describe('#getBucketLogicalId()', () => {
500.     it('should normalize the bucket name and add the standard prefix', () => {
501.       expect(sdk.naming.getBucketLogicalId('b!u@c#k$e%t^N&a*m(e')).to.equal('S3BucketBucketName');
502.     });
503.   });
504. 
505.   describe('#normalizeTopicName()', () => {
506.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
507.       expect(sdk.naming.normalizeTopicName('t!o@p#i$c%N^a&m*e')).to.equal('TopicName');
508.     });
509.   });
510. 
511.   describe('#getTopicLogicalId()', () => {
512.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
513.       expect(sdk.naming.getTopicLogicalId('t!o@p#i$c%N^a&m*e')).to.equal('SNSTopicTopicName');
514.     });
515.   });
516. 
517.   describe('#getScheduleId()', () => {
518.     it('should add the standard suffix', () => {
519.       expect(sdk.naming.getScheduleId('functionName')).to.equal('functionNameSchedule');
520.     });
521.   });
522. 
523.   describe('#getScheduleLogicalId()', () => {
524.     it('should normalize the function name and add the standard suffix including the index', () => {
525.       expect(sdk.naming.getScheduleLogicalId('functionName', 0)).to.equal(
526.         'FunctionNameEventsRuleSchedule0'
527.       );
528.     });
529.   });
530. 
531.   describe('#getStreamConsumerName()', () => {
532.     it('should add the standard suffix', () => {
533.       expect(sdk.naming.getStreamConsumerName('functionName', 'streamName')).to.equal(
534.         'functionNamestreamNameConsumer'
535.       );
536.     });
537.   });
538. 
539.   describe('#getStreamConsumerLogicalId()', () => {
540.     it('should normalize the stream consumer name and add the standard suffix', () => {
541.       expect(sdk.naming.getStreamConsumerLogicalId('streamConsumerName')).to.equal(
542.         'StreamConsumerNameStreamConsumer'
543.       );
544.     });
545.   });
546. 
547.   describe('#getCloudWatchEventId()', () => {
548.     it('should add the standard suffix', () => {
549.       expect(sdk.naming.getCloudWatchEventId('functionName')).to.equal(
550.         'functionNameCloudWatchEvent'
551.       );
552.     });
553.   });
554. 
555.   describe('#getCloudWatchEventLogicalId()', () => {
556.     it('should normalize the function name and add the standard suffix including the index', () => {
557.       expect(sdk.naming.getCloudWatchEventLogicalId('functionName', 0)).to.equal(
558.         'FunctionNameEventsRuleCloudWatchEvent0'
559.       );
560.     });
561.   });
562. 
563.   describe('#getCloudWatchLogLogicalId()', () => {
564.     it('should normalize the function name and add the standard suffix including the index', () => {
565.       expect(sdk.naming.getCloudWatchLogLogicalId('functionName', 0)).to.equal(
566.         'FunctionNameLogsSubscriptionFilterCloudWatchLog0'
567.       );
568.     });
569.   });
570. 
571.   describe('#getCognitoUserPoolLogicalId()', () => {
572.     it('should normalize the user pool name and add the standard prefix', () => {
573.       expect(sdk.naming.getCognitoUserPoolLogicalId('us-east-1_v123sDAS1')).to.equal(
574.         'CognitoUserPoolUseast1v123sDAS1'
575.       );
576.     });
577.   });
578. 
579.   describe('#getLambdaS3PermissionLogicalId()', () => {
580.     it('should normalize the function name and add the standard suffix', () => {
581.       expect(sdk.naming.getLambdaS3PermissionLogicalId('functionName', 'bucket')).to.equal(
582.         'FunctionNameLambdaPermissionBucketS3'
583.       );
584.     });
585.   });
586. 
587.   describe('#getLambdaSnsPermissionLogicalId()', () => {
588.     it(
589.       'should normalize the function and topic names and add them as prefix and suffix to the ' +
590.         'standard permission center',
591.       () => {
592.         expect(sdk.naming.getLambdaSnsPermissionLogicalId('functionName', 'topic')).to.equal(
593.           'FunctionNameLambdaPermissionTopicSNS'
594.         );
595.       }
596.     );
597.   });
598. 
599.   describe('#getLambdaSchedulePermissionLogicalId()', () => {
600.     it('should normalize the function name and add the standard suffix including event index', () => {
601.       expect(sdk.naming.getLambdaSchedulePermissionLogicalId('functionName', 0)).to.equal(
602.         'FunctionNameLambdaPermissionEventsRuleSchedule0'
603.       );
604.     });
605.   });
606. 
607.   describe('#getLambdaCloudWatchEventPermissionLogicalId()', () => {
608.     it('should normalize the function name and add the standard suffix including event index', () => {
609.       expect(sdk.naming.getLambdaCloudWatchEventPermissionLogicalId('functionName', 0)).to.equal(
610.         'FunctionNameLambdaPermissionEventsRuleCloudWatchEvent0'
611.       );
612.     });
613.   });
614. 
615.   describe('#getLambdaApiGatewayPermissionLogicalId()', () => {
616.     it('should normalize the function name and append the standard suffix', () => {
617.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId('functionName')).to.equal(
618.         'FunctionNameLambdaPermissionApiGateway'
619.       );
620.     });
621.   });
622. 
623.   describe('#getIotLogicalId()', () => {
624.     it('should normalize the function name and add the standard suffix including the index', () => {
625.       expect(sdk.naming.getIotLogicalId('functionName', 0)).to.equal('FunctionNameIotTopicRule0');
626.     });
627.   });
628. 
629.   describe('#getLambdaIotPermissionLogicalId()', () => {
630.     it('should normalize the function name and add the standard suffix including event index', () => {
631.       expect(sdk.naming.getLambdaIotPermissionLogicalId('functionName', 0)).to.equal(
632.         'FunctionNameLambdaPermissionIotTopicRule0'
633.       );
634.     });
635.   });
636. 
637.   describe('#getLambdaAlexaSkillPermissionLogicalId()', () => {
638.     it('should normalize the function name and append the standard suffix', () => {
639.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName', 2)).to.equal(
640.         'FunctionNameLambdaPermissionAlexaSkill2'
641.       );
642.     });
643. 
644.     it('should normalize the function name and append a default suffix if not defined', () => {
645.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName')).to.equal(
646.         'FunctionNameLambdaPermissionAlexaSkill0'
647.       );
648.     });
649.   });
650. 
651.   describe('#getLambdaAlexaSmartHomePermissionLogicalId()', () => {
652.     it('should normalize the function name and append the standard suffix', () => {
653.       expect(sdk.naming.getLambdaAlexaSmartHomePermissionLogicalId('functionName', 0)).to.equal(
654.         'FunctionNameLambdaPermissionAlexaSmartHome0'
655.       );
656.     });
657.   });
658. 
659.   describe('#getLambdaSnsSubscriptionLogicalId()', () => {
660.     it('should normalize the function name and append the standard suffix', () => {
661.       expect(sdk.naming.getLambdaSnsSubscriptionLogicalId('functionName', 'topicName')).to.equal(
662.         'FunctionNameSnsSubscriptionTopicName'
663.       );
664.     });
665.   });
666. 
667.   describe('#getLambdaCloudWatchLogPermissionLogicalId()', () => {
668.     it('should normalize the function name and add the standard suffix including event index', () => {
669.       expect(sdk.naming.getLambdaCloudWatchLogPermissionLogicalId('functionName')).to.equal(
670.         'FunctionNameLambdaPermissionLogsSubscriptionFilterCloudWatchLog'
671.       );
672.     });
673.   });
674. 
675.   describe('#getLambdaCognitoUserPoolPermissionLogicalId()', () => {
676.     it('should normalize the function name and add the standard suffix', () => {
677.       expect(
678.         sdk.naming.getLambdaCognitoUserPoolPermissionLogicalId(
679.           'functionName',
680.           'Pool1',
681.           'CustomMessage'
682.         )
683.       ).to.equal('FunctionNameLambdaPermissionCognitoUserPoolPool1TriggerSourceCustomMessage');
684.     });
685. 
686.     describe('#getLambdaAlbPermissionLogicalId()', () => {
687.       it('should normalize the function name', () => {
688.         expect(sdk.naming.getLambdaAlbPermissionLogicalId('functionName')).to.equal(
689.           'FunctionNameLambdaPermissionAlb'
690.         );
691.       });
692.     });
693. 
694.     describe('#getLambdaRegisterTargetPermissionLogicalId()', () => {
695.       it('should normalize the function name and add the correct suffix', () => {
696.         expect(sdk.naming.getLambdaRegisterTargetPermissionLogicalId('functionName')).to.equal(
697.           'FunctionNameLambdaPermissionRegisterTarget'
698.         );
699.       });
700.     });
701.   });
702. 
703.   describe('#getQueueLogicalId()', () => {
704.     it('should normalize the function name and add the standard suffix', () => {
705.       expect(sdk.naming.getQueueLogicalId('functionName', 'MyQueue')).to.equal(
706.         'FunctionNameEventSourceMappingSQSMyQueue'
707.       );
708.     });
709.   });
710. 
711.   describe('#getAlbTargetGroupLogicalId()', () => {
712.     it('should normalize the function name', () => {
713.       expect(sdk.naming.getAlbTargetGroupLogicalId('functionName', 'abc123')).to.equal(
714.         'FunctionNameAlbTargetGroupabc123'
715.       );
716.     });
717. 
718.     it('should normalize the function name and add MultiValue prefix if multiValueHeader is true', () => {
719.       expect(sdk.naming.getAlbTargetGroupLogicalId('functionName', 'abc123', true)).to.equal(
720.         'FunctionNameAlbMultiValueTargetGroupabc123'
721.       );
722.     });
723.   });
724. 
725.   describe('#getAlbListenerRuleLogicalId()', () => {
726.     it('should normalize the function name and add an index', () => {
727.       expect(sdk.naming.getAlbListenerRuleLogicalId('functionName', 0)).to.equal(
728.         'FunctionNameAlbListenerRule0'
729.       );
730.     });
731.   });
732. 
733.   describe('#getAlbTargetGroupName()', () => {
734.     it('should return a unique identifier based on the service name, function name, alb id, multi-value attribute and stage', () => {
735.       serverless.service.service = 'myService';
736.       expect(sdk.naming.getAlbTargetGroupName('functionName', 'abc123', true)).to.equal(
737.         '79039bd239ac0b3f6ff6d9296f23e27c'
738.       );
739.     });
740. 
741.     it('should return a prefixed unique identifer of not longer than 32 characters if alb.targetGroupPrefix is set', () => {
742.       serverless.service.service = 'myService';
743.       serverless.service.provider.alb = {};
744.       serverless.service.provider.alb.targetGroupPrefix = 'myPrefix-';
745.       expect(sdk.naming.getAlbTargetGroupName('functionName', 'abc123', true)).to.equal(
746.         'myPrefix-79039bd239ac0b3f6ff6d92'
747.       );
748.     });
749.   });
750. 
751.   describe('#getAlbTargetGroupNameTagValue()', () => {
752.     it('should return the composition of service name, function name, alb id, multi-value attribute and stage', () => {
753.       serverless.service.service = 'myService';
754.       expect(sdk.naming.getAlbTargetGroupNameTagValue('functionName', 'abc123', true)).to.equal(
755.         `${
756.           serverless.service.service
757.         }-functionName-abc123-multi-value-${sdk.naming.provider.getStage()}`
758.       );
759.     });
760.   });
761. 
762.   describe('#getCustomResourcesArtifactName()', () => {
763.     it('should return the custom resources artifact directory name', () => {
764.       expect(sdk.naming.getCustomResourcesArtifactName()).to.equal('custom-resources.zip');
765.     });
766.   });
767. 
768.   describe('#getCustomResourcesRoleLogicalId()', () => {
769.     it('should return the custom resources role logical id', () => {
770.       expect(sdk.naming.getCustomResourcesRoleLogicalId()).to.equal(
771.         'IamRoleCustomResourcesLambdaExecution'
772.       );
773.     });
774.   });
775. 
776.   describe('#getCustomResourceS3HandlerFunctionName()', () => {
777.     it('should return the name of the S3 custom resource handler function', () => {
778.       expect(sdk.naming.getCustomResourceS3HandlerFunctionName()).to.equal(
779.         'custom-resource-existing-s3'
780.       );
781.     });
782.   });
783. 
784.   describe('#getCustomResourceS3HandlerFunctionLogicalId()', () => {
785.     it('should return the logical id of the S3 custom resource handler function', () => {
786.       expect(sdk.naming.getCustomResourceS3HandlerFunctionLogicalId()).to.equal(
787.         'CustomDashresourceDashexistingDashs3LambdaFunction'
788.       );
789.     });
790.   });
791. 
792.   describe('#getCustomResourceS3ResourceLogicalId()', () => {
793.     it('should return the logical id of the S3 custom resource', () => {
794.       const functionName = 'my-function';
795.       expect(sdk.naming.getCustomResourceS3ResourceLogicalId(functionName)).to.equal(
796.         'MyDashfunctionCustomS31'
797.       );
798.     });
799.   });
800. 
801.   describe('#getCustomResourceCognitoUserPoolHandlerFunctionName()', () => {
802.     it('should return the name of the Cognito User Pool custom resource handler function', () => {
803.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionName()).to.equal(
804.         'custom-resource-existing-cup'
805.       );
806.     });
807.   });
808. 
809.   describe('#getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()', () => {
810.     it('should return the logical id of the Cognito User Pool custom resource handler function', () => {
811.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()).to.equal(
812.         'CustomDashresourceDashexistingDashcupLambdaFunction'
813.       );
814.     });
815.   });
816. 
817.   describe('#getCustomResourceCognitoUserPoolResourceLogicalId()', () => {
818.     it('should return the logical id of the Cognito User Pool custom resource', () => {
819.       const functionName = 'my-function';
820.       expect(sdk.naming.getCustomResourceCognitoUserPoolResourceLogicalId(functionName)).to.equal(
821.         'MyDashfunctionCustomCognitoUserPool1'
822.       );
823.     });
824.   });
825. 
826.   describe('#getCustomResourceEventBridgeHandlerFunctionName()', () => {
827.     it('should return the name of the Event Bridge custom resource handler function', () => {
828.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionName()).to.equal(
829.         'custom-resource-event-bridge'
830.       );
831.     });
832.   });
833. 
834.   describe('#getCustomResourceEventBridgeHandlerFunctionLogicalId()', () => {
835.     it('should return the logical id of the Event Bridge custom resource handler function', () => {
836.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId()).to.equal(
837.         'CustomDashresourceDasheventDashbridgeLambdaFunction'
838.       );
839.     });
840.   });
841. 
842.   describe('#getCustomResourceEventBridgeResourceLogicalId()', () => {
843.     it('should return the logical id of the Event Bridge custom resource', () => {
844.       const functionName = 'my-function';
845.       const index = 1;
846.       expect(
847.         sdk.naming.getCustomResourceEventBridgeResourceLogicalId(functionName, index)
848.       ).to.equal('MyDashfunctionCustomEventBridge1');
849.     });
850.   });
851. 
852.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()', () => {
853.     it('should return the name of the APIGW Account CloudWatch role custom resource handler function', () => {
854.       expect(
855.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()
856.       ).to.equal('custom-resource-apigw-cw-role');
857.     });
858.   });
859. 
860.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()', () => {
861.     it('should return the logical id of the APIGW Account CloudWatch role custom resource handler function', () => {
862.       expect(
863.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()
864.       ).to.equal('CustomDashresourceDashapigwDashcwDashroleLambdaFunction');
865.     });
866.   });
867. 
868.   describe('#getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()', () => {
869.     it('should return the logical id of the APIGW Account CloudWatch role custom resource', () => {
870.       expect(
871.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()
872.       ).to.equal('CustomApiGatewayAccountCloudWatchRole');
873.     });
874.   });
875. 
876.   describe('#getCloudFrontDistributionLogicalId()', () => {
877.     it('should return CloudFront distribution logical id', () => {
878.       expect(sdk.naming.getCloudFrontDistributionLogicalId()).to.equal('CloudFrontDistribution');
879.     });
880.   });
881. 
882.   describe('#getCloudFrontDistributionDomainNameLogicalId()', () => {
883.     it('should return CloudFront distribution domain name logical id', () => {
884.       expect(sdk.naming.getCloudFrontDistributionDomainNameLogicalId()).to.equal(
885.         'CloudFrontDistributionDomainName'
886.       );
887.     });
888.   });
889. 
890.   describe('#getLambdaAtEdgeInvokePermissionLogicalId()', () => {
891.     it('should return lambda@edge invoke permission logical id', () => {
892.       expect(sdk.naming.getLambdaAtEdgeInvokePermissionLogicalId('functionName')).to.equal(
893.         'FunctionNameLambdaFunctionInvokePermission'
894.       );
895.     });
896.   });
897. 
898.   describe('#getCloudFrontOriginId()', () => {
899.     it('should return CloudFront origin id for s3 origin', () => {
900.       expect(
901.         sdk.naming.getCloudFrontOriginId({
902.           S3OriginConfig: {},
903.           DomainName: 'domain.name',
904.           OriginPath: '/path',
905.         })
906.       ).to.equal('s3/domain.name/path');
907.     });
908. 
909.     it('should return CloudFront origin id for custom origin', () => {
910.       expect(
911.         sdk.naming.getCloudFrontOriginId({
912.           CustomOriginConfig: {},
913.           DomainName: 'domain.name',
914.           OriginPath: '/path',
915.         })
916.       ).to.equal('custom/domain.name/path');
917.     });
918. 
919.     it('should return CloudFront origin id from domain as a object', () => {
920.       expect(
921.         sdk.naming.getCloudFrontOriginId({
922.           CustomOriginConfig: {},
923.           DomainName: {
924.             'Fn::Join': ['', ['Ref: ApiGatewayRestApi', '.execute-api.']],
925.           },
926.         })
927.       ).to.equal('custom/FnJoinRefApiGatewayRestApiexecuteapi');
928.     });
929.   });
930. });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 7
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 42 - 88
Content:
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 90 - 149
Content:
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 151 - 183
Content:
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 217 - 247
Content:
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 249 - 277
Content:
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 279 - 310
Content:
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 562 - 598
Content:
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 600 - 653
Content:
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });


File: lib/plugins/aws/package/compile/events/sqs/index.test.js
Line number range: 399 - 500
Content:
399.       it('should allow specifying SQS Queues as CFN reference types', () => {
400.         awsCompileSQSEvents.serverless.service.functions = {
401.           first: {
402.             events: [
403.               {
404.                 sqs: {
405.                   arn: { 'Fn::GetAtt': ['SomeQueue', 'Arn'] },
406.                 },
407.               },
408.               {
409.                 sqs: {
410.                   arn: { 'Fn::ImportValue': 'ForeignQueue' },
411.                 },
412.               },
413.               {
414.                 sqs: {
415.                   arn: {
416.                     'Fn::Join': [
417.                       ':',
418.                       [
419.                         'arn',
420.                         'aws',
421.                         'sqs',
422.                         {
423.                           Ref: 'AWS::Region',
424.                         },
425.                         {
426.                           Ref: 'AWS::AccountId',
427.                         },
428.                         'MyQueue',
429.                       ],
430.                     ],
431.                   },
432.                 },
433.               },
434.             ],
435.           },
436.         };
437. 
438.         awsCompileSQSEvents.compileSQSEvents();
439. 
440.         expect(
441.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
442.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement[0]
443.         ).to.deep.equal({
444.           Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
445.           Effect: 'Allow',
446.           Resource: [
447.             {
448.               'Fn::GetAtt': ['SomeQueue', 'Arn'],
449.             },
450.             {
451.               'Fn::ImportValue': 'ForeignQueue',
452.             },
453.             {
454.               'Fn::Join': [
455.                 ':',
456.                 [
457.                   'arn',
458.                   'aws',
459.                   'sqs',
460.                   {
461.                     Ref: 'AWS::Region',
462.                   },
463.                   {
464.                     Ref: 'AWS::AccountId',
465.                   },
466.                   'MyQueue',
467.                 ],
468.               ],
469.             },
470.           ],
471.         });
472.         expect(
473.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
474.             .FirstEventSourceMappingSQSSomeQueue.Properties.EventSourceArn
475.         ).to.deep.equal({ 'Fn::GetAtt': ['SomeQueue', 'Arn'] });
476.         expect(
477.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
478.             .FirstEventSourceMappingSQSForeignQueue.Properties.EventSourceArn
479.         ).to.deep.equal({ 'Fn::ImportValue': 'ForeignQueue' });
480.         expect(
481.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
482.             .FirstEventSourceMappingSQSMyQueue.Properties.EventSourceArn
483.         ).to.deep.equal({
484.           'Fn::Join': [
485.             ':',
486.             [
487.               'arn',
488.               'aws',
489.               'sqs',
490.               {
491.                 Ref: 'AWS::Region',
492.               },
493.               {
494.                 Ref: 'AWS::AccountId',
495.               },
496.               'MyQueue',
497.             ],
498.           ],
499.         });
500.       });


File: lib/plugins/aws/package/compile/events/sqs/index.test.js
Line number range: 521 - 552
Content:
521.       it('should add the necessary IAM role statements', () => {
522.         awsCompileSQSEvents.serverless.service.functions = {
523.           first: {
524.             events: [
525.               {
526.                 sqs: 'arn:aws:sqs:region:account:MyFirstQueue',
527.               },
528.               {
529.                 sqs: 'arn:aws:sqs:region:account:MySecondQueue',
530.               },
531.             ],
532.           },
533.         };
534. 
535.         const iamRoleStatements = [
536.           {
537.             Effect: 'Allow',
538.             Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],
539.             Resource: [
540.               'arn:aws:sqs:region:account:MyFirstQueue',
541.               'arn:aws:sqs:region:account:MySecondQueue',
542.             ],
543.           },
544.         ];
545. 
546.         awsCompileSQSEvents.compileSQSEvents();
547. 
548.         expect(
549.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
550.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement
551.         ).to.deep.equal(iamRoleStatements);
552.       });


File: lib/plugins/aws/package/index.test.js
Line number range: 1 - 167
Content:
1. 'use strict';
2. 
3. const AwsProvider = require('../provider/awsProvider');
4. const AwsPackage = require('./index');
5. const Serverless = require('../../../Serverless');
6. const CLI = require('../../../classes/CLI');
7. const expect = require('chai').expect;
8. const sinon = require('sinon');
9. const path = require('path');
10. 
11. describe('AwsPackage', () => {
12.   let awsPackage;
13.   let serverless;
14.   let options;
15. 
16.   beforeEach(() => {
17.     serverless = new Serverless();
18.     options = {
19.       stage: 'dev',
20.       region: 'us-east-1',
21.     };
22.     serverless.setProvider('aws', new AwsProvider(serverless, options));
23.     serverless.config.servicePath = 'foo';
24.     serverless.cli = new CLI(serverless);
25.     awsPackage = new AwsPackage(serverless, options);
26.   });
27. 
28.   describe('#constructor()', () => {
29.     it('should set the serverless instance', () => {
30.       expect(awsPackage.serverless).to.equal(serverless);
31.     });
32. 
33.     it('should set options', () => {
34.       expect(awsPackage.options).to.equal(options);
35.     });
36. 
37.     it('should set the service path if provided', () => {
38.       expect(awsPackage.servicePath).to.equal('foo');
39.     });
40. 
41.     it('should default to an empty service path if not provided', () => {
42.       serverless.config.servicePath = false;
43.       awsPackage = new AwsPackage(serverless, options);
44. 
45.       expect(awsPackage.servicePath).to.equal('');
46.     });
47. 
48.     it('should use the options package path if provided', () => {
49.       options.package = 'package-options';
50.       awsPackage = new AwsPackage(serverless, options);
51. 
52.       expect(awsPackage.packagePath).to.equal('package-options');
53.     });
54. 
55.     it('should use the services package path if provided', () => {
56.       serverless.service = {
57.         package: {
58.           path: 'package-service',
59.         },
60.       };
61.       awsPackage = new AwsPackage(serverless, options);
62. 
63.       expect(awsPackage.packagePath).to.equal('package-service');
64.     });
65. 
66.     it('should default to the .serverless directory as the package path', () => {
67.       expect(awsPackage.packagePath).to.equal(path.join('foo', '.serverless'));
68.     });
69. 
70.     it('should set the provider variable to an instance of AwsProvider', () =>
71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));
72. 
73.     it('should have commands', () => expect(awsPackage.commands).to.be.not.empty);
74. 
75.     it('should have hooks', () => expect(awsPackage.hooks).to.be.not.empty);
76.   });
77. 
78.   describe('hooks', () => {
79.     let spawnStub;
80.     let generateCoreTemplateStub;
81.     let mergeIamTemplatesStub;
82.     let generateArtifactDirectoryNameStub;
83.     let mergeCustomProviderResourcesStub;
84.     let saveCompiledTemplateStub;
85.     let saveServiceStateStub;
86. 
87.     beforeEach(() => {
88.       spawnStub = sinon.stub(serverless.pluginManager, 'spawn');
89.       generateCoreTemplateStub = sinon.stub(awsPackage, 'generateCoreTemplate').resolves();
90.       mergeIamTemplatesStub = sinon.stub(awsPackage, 'mergeIamTemplates').resolves();
91.       generateArtifactDirectoryNameStub = sinon
92.         .stub(awsPackage, 'generateArtifactDirectoryName')
93.         .resolves();
94.       mergeCustomProviderResourcesStub = sinon
95.         .stub(awsPackage, 'mergeCustomProviderResources')
96.         .resolves();
97.       saveCompiledTemplateStub = sinon.stub(awsPackage, 'saveCompiledTemplate').resolves();
98.       saveServiceStateStub = sinon.stub(awsPackage, 'saveServiceState').resolves();
99.     });
100. 
101.     afterEach(() => {
102.       serverless.pluginManager.spawn.restore();
103.       awsPackage.generateCoreTemplate.restore();
104.       awsPackage.mergeIamTemplates.restore();
105.       awsPackage.generateArtifactDirectoryName.restore();
106.       awsPackage.mergeCustomProviderResources.restore();
107.       awsPackage.saveCompiledTemplate.restore();
108.       awsPackage.saveServiceState.restore();
109.     });
110. 
111.     it('should run "package:cleanup" hook', () => {
112.       const spawnAwsCommonValidateStub = spawnStub.withArgs('aws:common:validate').resolves();
113.       const spawnAwsCommonCleanupTempDirStub = spawnStub
114.         .withArgs('aws:common:cleanupTempDir')
115.         .resolves();
116. 
117.       return awsPackage.hooks['package:cleanup']().then(() => {
118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);
119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(
120.           true
121.         );
122.       });
123.     });
124. 
125.     it('should run "package:initialize" hook', () =>
126.       awsPackage.hooks['package:initialize']().then(() => {
127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);
128.       }));
129. 
130.     it('should run "package:setupProviderConfiguration" hook', () =>
131.       awsPackage.hooks['package:setupProviderConfiguration']().then(() => {
132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);
133.       }));
134. 
135.     it('should run "before:package:compileFunctions" hook', () =>
136.       awsPackage.hooks['before:package:compileFunctions']().then(() => {
137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);
138.       }));
139. 
140.     it('should run "package:finalize" hook', () => {
141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs('aws:package:finalize').resolves();
142. 
143.       return awsPackage.hooks['package:finalize']().then(() => {
144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);
145.       });
146.     });
147. 
148.     it('should run "aws:package:finalize:mergeCustomProviderResources" hook', () =>
149.       awsPackage.hooks['aws:package:finalize:mergeCustomProviderResources']().then(() => {
150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);
151.       }));
152. 
153.     it('should run "aws:package:finalize:saveServiceState" hook', () => {
154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub
155.         .withArgs('aws:common:moveArtifactsToPackage')
156.         .resolves();
157. 
158.       return awsPackage.hooks['aws:package:finalize:saveServiceState']().then(() => {
159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);
160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);
161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(
162.           true
163.         );
164.       });
165.     });
166.   });
167. });


File: tests/integration-all/sns/tests.js
Line number range: 1 - 16
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const BbPromise = require('bluebird');
5. const { expect } = require('chai');
6. 
7. const { getTmpDirPath } = require('../../utils/fs');
8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');
9. const {
10.   createTestService,
11.   deployService,
12.   removeService,
13.   waitForFunctionLogs,
14. } = require('../../utils/integration');
15. const { getMarkers } = require('../shared/utils');
16. 


File: tests/integration-all/sns/tests.js
Line number range: 27 - 58
Content:
27.   before(async () => {
28.     tmpDirPath = getTmpDirPath();
29.     console.info(`Temporary path: ${tmpDirPath}`);
30.     const serverlessConfig = await createTestService(tmpDirPath, {
31.       templateDir: path.join(__dirname, 'service'),
32.       filesToAdd: [path.join(__dirname, '..', 'shared')],
33.       serverlessConfigHook:
34.         // Ensure unique topics (to avoid collision among concurrent CI runs)
35.         config => {
36.           minimalTopicName = `${config.service}-minimal`;
37.           filteredTopicName = `${config.service}-filtered`;
38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;
39.           existingTopicName = `${config.service}-existing`;
40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;
41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;
42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;
43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;
44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;
45.           config.functions.snsExisting.events[0].sns.arn['Fn::Join'][1][3] = existingTopicName;
46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;
47.         },
48.     });
49.     serviceName = serverlessConfig.service;
50.     stackName = `${serviceName}-${stage}`;
51.     // create "existing" SNS topics
52.     // NOTE: deployment can only be done once the SNS topics are created
53.     console.info(`Creating SNS topic "${existingTopicName}"...`);
54.     return createSnsTopic(existingTopicName).then(() => {
55.       console.info(`Deploying "${stackName}" service...`);
56.       return deployService(tmpDirPath);
57.     });
58.   });


File: tests/integration-all/sns/tests.js
Line number range: 67 - 80
Content:
67.   describe('Minimal Setup', () => {
68.     it('should invoke on a topic message', () => {
69.       const functionName = 'snsMinimal';
70.       const markers = getMarkers(functionName);
71.       const message = 'Hello from SNS!';
72. 
73.       return publishSnsMessage(minimalTopicName, message)
74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
75.         .then(logs => {
76.           expect(logs).to.include(functionName);
77.           expect(logs).to.include(message);
78.         });
79.     });
80.   });


File: tests/integration-all/sns/tests.js
Line number range: 82 - 127
Content:
82.   describe('Multiple and Filtered Setup', () => {
83.     it('should invoke on a topic message that matches filter', () => {
84.       const leftFunctionName = 'snsMultipleFilteredLeft';
85.       const leftMarkers = getMarkers(leftFunctionName);
86.       const rightFunctionName = 'snsMultipleFilteredRight';
87.       const rightMarkers = getMarkers(rightFunctionName);
88.       const leftMessage = 'Hello to the left-side from SNS!';
89.       const rightMessage = 'Hello to the right-side from SNS!';
90.       const middleMessage = 'Hello to the middle-side from SNS!';
91.       const leftAttributes = { side: { DataType: 'String', StringValue: 'left' } };
92.       const middleAttributes = { side: { DataType: 'String', StringValue: 'middle' } };
93.       const rightAttributes = { side: { DataType: 'String', StringValue: 'right' } };
94. 
95.       return BbPromise.all([
96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),
97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),
98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),
99.       ])
100.         .then(() =>
101.           BbPromise.all([
102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),
103.             waitForFunctionLogs(
104.               tmpDirPath,
105.               rightFunctionName,
106.               rightMarkers.start,
107.               rightMarkers.end
108.             ),
109.           ])
110.         )
111.         .then(logs => {
112.           const leftLogs = logs[0];
113.           const rightLogs = logs[1];
114.           // left side is filtered to only get "left" messages from topic:
115.           expect(leftLogs).to.include(leftFunctionName);
116.           expect(leftLogs).to.include(leftMessage);
117.           expect(leftLogs).not.to.include(middleMessage);
118.           expect(leftLogs).not.to.include(rightMessage);
119.           // right side is filtered to only get "right" messages from topic:
120.           expect(rightLogs).to.include(rightFunctionName);
121.           expect(rightLogs).not.to.include(leftMessage);
122.           expect(rightLogs).not.to.include(middleMessage);
123.           expect(rightLogs).to.include(rightMessage);
124.           // "middle" messages will not cause an invocation.
125.         });
126.     });
127.   });


File: tests/integration-all/sns/tests.js
Line number range: 129 - 142
Content:
129.   describe('Existing Setup', () => {
130.     it('should invoke on an existing topic message', () => {
131.       const functionName = 'snsExisting';
132.       const markers = getMarkers(functionName);
133.       const message = 'Hello from an existing SNS!';
134. 
135.       return publishSnsMessage(existingTopicName, message)
136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))
137.         .then(logs => {
138.           expect(logs).to.include(functionName);
139.           expect(logs).to.include(message);
140.         });
141.     });
142.   });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:36:16,501 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The user needs 5 complete, self-contained test cases with imports, setup, and assertions closely related to SNS redrivePolicy and SQS QueuePolicy/queue references. Current context provides only partial snippets of lib/plugins/aws/package/compile/events/sns/index.test.js and lib/plugins/aws/package/compile/events/sqs/index.test.js, and partial integration SNS tests; crucial parts like the full beforeEach/setup, and any assertions on QueuePolicy properties are missing. Additionally, tests/integration-all/sqs/tests.js and tests/integration-package/cloudformation.tests.js were requested previously but not provided, and are likely to contain relevant end-to-end or CloudFormation assertions. Therefore, more context (full file contents with line numbers) is essential to return 5 complete test cases that meet the requirements.' query='Please provide the full content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js, lib/plugins/aws/package/compile/events/sqs/index.test.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, and the complete tests/integration-all/sns/tests.js.' extra_requirements='If sending all files is too large, include at minimum imports and beforeEach/setup blocks plus any tests asserting SNS redrivePolicy and SQS QueuePolicy properties (showing Fn::GetAtt Arn vs Ref URL), with exact line numbers.' purpose='I need complete test implementations to extract 5 relevant, self-contained cases demonstrating SNS redrivePolicy and SQS queue/policy handling, preserving imports and exact line numbers.'
2025-11-13 20:36:16,503 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content (with line numbers) of lib/plugins/aws/package/compile/events/sns/index.test.js, lib/plugins/aws/package/compile/events/sqs/index.test.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, and the complete tests/integration-all/sns/tests.js.
2025-11-13 20:36:19,322 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full content (with line numbers) of tests/integration-all/sns/tests.js and lib/plugins/aws/package/compile/events/sns/index.test.js (or the closest existing test file for SNS event packaging), plus any tests that explicitly cover SNS redrivePolicy or queue policy behavior.', 'query_extra_requirements': 'If some requested files do not exist, share the most relevant tests that exercise SNS event configuration, redrivePolicy, and SQS/DLQ integration, including their paths and line numbers.', 'query_purpose': 'I need to extract 8 precise test cases that are impacted by fixing SNS redrivePolicy references, ensuring they include all necessary imports and assertions.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. ", 'start_line_number': 1, 'end_line_number': 7}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });", 'start_line_number': 600, 'end_line_number': 653}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });", 'start_line_number': 42, 'end_line_number': 88}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });", 'start_line_number': 90, 'end_line_number': 149}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });", 'start_line_number': 151, 'end_line_number': 183}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });", 'start_line_number': 217, 'end_line_number': 247}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });", 'start_line_number': 249, 'end_line_number': 277}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });", 'start_line_number': 279, 'end_line_number': 310}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });", 'start_line_number': 562, 'end_line_number': 598}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "1. 'use strict';\n2. \n3. const path = require('path');\n4. const BbPromise = require('bluebird');\n5. const { expect } = require('chai');\n6. \n7. const { getTmpDirPath } = require('../../utils/fs');\n8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');\n9. const {\n10.   createTestService,\n11.   deployService,\n12.   removeService,\n13.   waitForFunctionLogs,\n14. } = require('../../utils/integration');\n15. const { getMarkers } = require('../shared/utils');\n16. ", 'start_line_number': 1, 'end_line_number': 16}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '27.   before(async () => {\n28.     tmpDirPath = getTmpDirPath();\n29.     console.info(`Temporary path: ${tmpDirPath}`);\n30.     const serverlessConfig = await createTestService(tmpDirPath, {\n31.       templateDir: path.join(__dirname, \'service\'),\n32.       filesToAdd: [path.join(__dirname, \'..\', \'shared\')],\n33.       serverlessConfigHook:\n34.         // Ensure unique topics (to avoid collision among concurrent CI runs)\n35.         config => {\n36.           minimalTopicName = `${config.service}-minimal`;\n37.           filteredTopicName = `${config.service}-filtered`;\n38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;\n39.           existingTopicName = `${config.service}-existing`;\n40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;\n41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;\n42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;\n43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;\n44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;\n45.           config.functions.snsExisting.events[0].sns.arn[\'Fn::Join\'][1][3] = existingTopicName;\n46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;\n47.         },\n48.     });\n49.     serviceName = serverlessConfig.service;\n50.     stackName = `${serviceName}-${stage}`;\n51.     // create "existing" SNS topics\n52.     // NOTE: deployment can only be done once the SNS topics are created\n53.     console.info(`Creating SNS topic "${existingTopicName}"...`);\n54.     return createSnsTopic(existingTopicName).then(() => {\n55.       console.info(`Deploying "${stackName}" service...`);\n56.       return deployService(tmpDirPath);\n57.     });\n58.   });', 'start_line_number': 27, 'end_line_number': 58}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "67.   describe('Minimal Setup', () => {\n68.     it('should invoke on a topic message', () => {\n69.       const functionName = 'snsMinimal';\n70.       const markers = getMarkers(functionName);\n71.       const message = 'Hello from SNS!';\n72. \n73.       return publishSnsMessage(minimalTopicName, message)\n74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n75.         .then(logs => {\n76.           expect(logs).to.include(functionName);\n77.           expect(logs).to.include(message);\n78.         });\n79.     });\n80.   });", 'start_line_number': 67, 'end_line_number': 80}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': '82.   describe(\'Multiple and Filtered Setup\', () => {\n83.     it(\'should invoke on a topic message that matches filter\', () => {\n84.       const leftFunctionName = \'snsMultipleFilteredLeft\';\n85.       const leftMarkers = getMarkers(leftFunctionName);\n86.       const rightFunctionName = \'snsMultipleFilteredRight\';\n87.       const rightMarkers = getMarkers(rightFunctionName);\n88.       const leftMessage = \'Hello to the left-side from SNS!\';\n89.       const rightMessage = \'Hello to the right-side from SNS!\';\n90.       const middleMessage = \'Hello to the middle-side from SNS!\';\n91.       const leftAttributes = { side: { DataType: \'String\', StringValue: \'left\' } };\n92.       const middleAttributes = { side: { DataType: \'String\', StringValue: \'middle\' } };\n93.       const rightAttributes = { side: { DataType: \'String\', StringValue: \'right\' } };\n94. \n95.       return BbPromise.all([\n96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),\n97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),\n98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),\n99.       ])\n100.         .then(() =>\n101.           BbPromise.all([\n102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),\n103.             waitForFunctionLogs(\n104.               tmpDirPath,\n105.               rightFunctionName,\n106.               rightMarkers.start,\n107.               rightMarkers.end\n108.             ),\n109.           ])\n110.         )\n111.         .then(logs => {\n112.           const leftLogs = logs[0];\n113.           const rightLogs = logs[1];\n114.           // left side is filtered to only get "left" messages from topic:\n115.           expect(leftLogs).to.include(leftFunctionName);\n116.           expect(leftLogs).to.include(leftMessage);\n117.           expect(leftLogs).not.to.include(middleMessage);\n118.           expect(leftLogs).not.to.include(rightMessage);\n119.           // right side is filtered to only get "right" messages from topic:\n120.           expect(rightLogs).to.include(rightFunctionName);\n121.           expect(rightLogs).not.to.include(leftMessage);\n122.           expect(rightLogs).not.to.include(middleMessage);\n123.           expect(rightLogs).to.include(rightMessage);\n124.           // "middle" messages will not cause an invocation.\n125.         });\n126.     });\n127.   });', 'start_line_number': 82, 'end_line_number': 127}, {'relative_path': 'tests/integration-all/sns/tests.js', 'content': "129.   describe('Existing Setup', () => {\n130.     it('should invoke on an existing topic message', () => {\n131.       const functionName = 'snsExisting';\n132.       const markers = getMarkers(functionName);\n133.       const message = 'Hello from an existing SNS!';\n134. \n135.       return publishSnsMessage(existingTopicName, message)\n136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n137.         .then(logs => {\n138.           expect(logs).to.include(functionName);\n139.           expect(logs).to.include(message);\n140.         });\n141.     });\n142.   });", 'start_line_number': 129, 'end_line_number': 142}]}, {'query_essential_query': 'Please provide the full content (with line numbers) of these test files: tests/integration-all/sns/tests.js, tests/integration-all/sqs/tests.js, tests/integration-package/cloudformation.tests.js, lib/plugins/aws/lib/naming.test.js, and lib/plugins/aws/package/index.test.js.', 'query_extra_requirements': 'If any file lacks direct coverage of SNS redrive policy/SQS QueuePolicy, please also include any unit tests that compile SNS events or generate SQS policies (with exact paths and line numbers).', 'query_purpose': 'I need the exact test implementations and their line numbers to return 5 complete, relevant test cases demonstrating similar functionality to the reported bug.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/lib/naming.test.js', 'content': '1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. \n5. const SDK = require(\'../provider/awsProvider\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. describe(\'#naming()\', () => {\n9.   let options;\n10.   let serverless;\n11.   let sdk;\n12. \n13.   beforeEach(() => {\n14.     options = {\n15.       stage: \'dev\',\n16.       region: \'us-east-1\',\n17.     };\n18.     serverless = new Serverless(options);\n19.     sdk = new SDK(serverless, options);\n20.   });\n21. \n22.   describe(\'#normalizeName()\', () => {\n23.     it(\'should capitalize the first letter\', () => {\n24.       expect(sdk.naming.normalizeName(\'name\')).to.equal(\'Name\');\n25.     });\n26. \n27.     it(\'should have no effect on caps\', () => {\n28.       expect(sdk.naming.normalizeName(\'Name\')).to.equal(\'Name\');\n29.     });\n30. \n31.     it(\'should have no effect on the rest of the name\', () => {\n32.       expect(sdk.naming.normalizeName(\'nAME\')).to.equal(\'NAME\');\n33.     });\n34.   });\n35. \n36.   describe(\'#normalizeNameToAlphaNumericOnly()\', () => {\n37.     it(\'should strip non-alpha-numeric characters\', () => {\n38.       expect(\n39.         sdk.naming.normalizeNameToAlphaNumericOnly(\'`!@#$%^&*()-={}|[]\\\\:";\\\'<>?,./\')\n40.       ).to.equal(\'\');\n41.     });\n42. \n43.     it(\'should apply normalizeName to the remaining characters\', () => {\n44.       expect(sdk.naming.normalizeNameToAlphaNumericOnly(\'a-b-c\')).to.equal(\'Abc\');\n45.     });\n46.   });\n47. \n48.   describe(\'#normalizePathPart()\', () => {\n49.     it(\'converts `-` to `Dash`\', () => {\n50.       expect(sdk.naming.normalizePathPart(\'a-path\')).to.equal(\'ADashpath\');\n51.     });\n52. \n53.     it(\'converts variable declarations (`${var}`) to `VariableVar`\', () => {\n54.       expect(sdk.naming.normalizePathPart(\'${variable}\')).to.equal(\'VariableVar\');\n55.     });\n56. \n57.     it(\'converts variable declarations prefixes to `VariableVarpath`\', () => {\n58.       expect(sdk.naming.normalizePathPart(\'${variable}Path\')).to.equal(\'VariableVarpath\');\n59.     });\n60. \n61.     it(\'converts variable declarations suffixes to `PathvariableVar`\', () => {\n62.       expect(sdk.naming.normalizePathPart(\'path${variable}\')).to.equal(\'PathvariableVar\');\n63.     });\n64. \n65.     it(\'converts variable declarations in center to `PathvariableVardir`\', () => {\n66.       expect(sdk.naming.normalizePathPart(\'path${variable}Dir\')).to.equal(\'PathvariableVardir\');\n67.     });\n68.   });\n69. \n70.   describe(\'#getServiceEndpointRegex()\', () => {\n71.     it(\'should match the prefix\', () => {\n72.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpoint\')).to.equal(true);\n73.     });\n74. \n75.     it(\'should not match a name without the prefix\', () => {\n76.       expect(sdk.naming.getServiceEndpointRegex().test(\'NotThePrefixServiceEndpoint\')).to.equal(\n77.         false\n78.       );\n79.     });\n80. \n81.     it(\'should match a name with the prefix\', () => {\n82.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpointForAService\')).to.equal(\n83.         true\n84.       );\n85.     });\n86.   });\n87. \n88.   describe(\'#getStackName()\', () => {\n89.     it(\'should use the service name & stage if custom stack name not provided\', () => {\n90.       serverless.service.service = \'myService\';\n91.       expect(sdk.naming.getStackName()).to.equal(\n92.         `${serverless.service.service}-${sdk.naming.provider.getStage()}`\n93.       );\n94.     });\n95. \n96.     it(\'should use the custom stack name if provided\', () => {\n97.       serverless.service.provider.stackName = \'app-dev-testApp\';\n98.       serverless.service.service = \'myService\';\n99.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n100.       expect(sdk.naming.getStackName()).to.equal(\'app-dev-testApp\');\n101.     });\n102.   });\n103. \n104.   describe(\'#getRolePath()\', () => {\n105.     it(\'should return `/`\', () => {\n106.       expect(sdk.naming.getRolePath()).to.equal(\'/\');\n107.     });\n108.   });\n109. \n110.   describe(\'#getRoleName()\', () => {\n111.     it(\'uses the service name, stage, and region to generate a role name\', () => {\n112.       serverless.service.service = \'myService\';\n113.       expect(sdk.naming.getRoleName()).to.eql({\n114.         \'Fn::Join\': [\n115.           \'-\',\n116.           [\n117.             serverless.service.service,\n118.             sdk.naming.provider.getStage(),\n119.             { Ref: \'AWS::Region\' },\n120.             \'lambdaRole\',\n121.           ],\n122.         ],\n123.       });\n124.     });\n125.   });\n126. \n127.   describe(\'#getRoleLogicalId()\', () => {\n128.     it(\'should return the expected role name (IamRoleLambdaExecution)\', () => {\n129.       expect(sdk.naming.getRoleLogicalId()).to.equal(\'IamRoleLambdaExecution\');\n130.     });\n131.   });\n132. \n133.   describe(\'#getPolicyName()\', () => {\n134.     it(\'should use the stage and service name\', () => {\n135.       serverless.service.service = \'myService\';\n136.       expect(sdk.naming.getPolicyName()).to.eql({\n137.         \'Fn::Join\': [\'-\', [sdk.naming.provider.getStage(), serverless.service.service, \'lambda\']],\n138.       });\n139.     });\n140.   });\n141. \n142.   describe(\'#getLogicalLogGroupName()\', () => {\n143.     it(\'should prefix the normalized function name to "LogGroup"\', () => {\n144.       expect(sdk.naming.getLogGroupLogicalId(\'functionName\')).to.equal(\'FunctionNameLogGroup\');\n145.     });\n146.   });\n147. \n148.   describe(\'#getLogGroupName()\', () => {\n149.     it(\'should add the function name to the log group name\', () => {\n150.       expect(sdk.naming.getLogGroupName(\'functionName\')).to.equal(\'/aws/lambda/functionName\');\n151.     });\n152.   });\n153. \n154.   describe(\'#getNormalizedFunctionName()\', () => {\n155.     it(\'should normalize the given functionName\', () => {\n156.       expect(sdk.naming.getNormalizedFunctionName(\'functionName\')).to.equal(\'FunctionName\');\n157.     });\n158. \n159.     it(\'should normalize the given functionName with an underscore\', () => {\n160.       expect(sdk.naming.getNormalizedFunctionName(\'hello_world\')).to.equal(\'HelloUnderscoreworld\');\n161.     });\n162. \n163.     it(\'should normalize the given functionName with a dash\', () => {\n164.       expect(sdk.naming.getNormalizedFunctionName(\'hello-world\')).to.equal(\'HelloDashworld\');\n165.     });\n166.   });\n167. \n168.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n169.     it(\'should extract everything after the last colon and dash\', () => {\n170.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n171.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n172.     });\n173.   });\n174. \n175.   describe(\'#extractLambdaNameFromArn()\', () => {\n176.     it(\'should extract everything after the last colon\', () => {\n177.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n178.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal(\'my-dev-lambda\');\n179.     });\n180.   });\n181. \n182.   describe(\'#getLambdaLogicalId()\', () => {\n183.     it(\'should normalize the function name and add the logical suffix\', () => {\n184.       expect(sdk.naming.getLambdaLogicalId(\'functionName\')).to.equal(\'FunctionNameLambdaFunction\');\n185.     });\n186.   });\n187. \n188.   describe(\'#getLambdaLogicalIdRegex()\', () => {\n189.     it(\'should match the suffix\', () => {\n190.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'LambdaFunction\')).to.equal(true);\n191.     });\n192. \n193.     it(\'should not match a name without the suffix\', () => {\n194.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'LambdaFunctionNotTheSuffix\')).to.equal(\n195.         false\n196.       );\n197.     });\n198. \n199.     it(\'should match a name with the suffix\', () => {\n200.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'AFunctionNameLambdaFunction\')).to.equal(\n201.         true\n202.       );\n203.     });\n204.   });\n205. \n206.   describe(\'#getWebsocketsApiName()\', () => {\n207.     it(\'should return the composition of stage & service name if custom name not provided\', () => {\n208.       serverless.service.service = \'myService\';\n209.       expect(sdk.naming.getWebsocketsApiName()).to.equal(\n210.         `${sdk.naming.provider.getStage()}-${serverless.service.service}-websockets`\n211.       );\n212.     });\n213. \n214.     it(\'should return the custom api name if provided\', () => {\n215.       serverless.service.provider.websocketsApiName = \'app-dev-websockets-testApi\';\n216.       serverless.service.service = \'myService\';\n217.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n218.       expect(sdk.naming.getWebsocketsApiName()).to.equal(\'app-dev-websockets-testApi\');\n219.     });\n220.   });\n221. \n222.   describe(\'#getWebsocketsApiLogicalId()\', () => {\n223.     it(\'should return the websocket API logical id\', () => {\n224.       expect(sdk.naming.getWebsocketsApiLogicalId()).to.equal(\'WebsocketsApi\');\n225.     });\n226.   });\n227. \n228.   describe(\'#getWebsocketsIntegrationLogicalId()\', () => {\n229.     it(\'should return the integrations logical id\', () => {\n230.       expect(sdk.naming.getWebsocketsIntegrationLogicalId(\'myFunc\')).to.equal(\n231.         \'MyFuncWebsocketsIntegration\'\n232.       );\n233.     });\n234.   });\n235. \n236.   describe(\'#getLambdaWebsocketsPermissionLogicalId()\', () => {\n237.     it(\'should return the lambda websocket permission logical id\', () => {\n238.       expect(sdk.naming.getLambdaWebsocketsPermissionLogicalId(\'myFunc\')).to.equal(\n239.         \'MyFuncLambdaPermissionWebsockets\'\n240.       );\n241.     });\n242.   });\n243. \n244.   describe(\'#getNormalizedWebsocketsRouteKey()\', () => {\n245.     it(\'should return a normalized version of the route key\', () => {\n246.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'$connect\')).to.equal(\'Sconnect\');\n247. \n248.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo/bar\')).to.equal(\'fooSlashbar\');\n249. \n250.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo-bar\')).to.equal(\'fooDashbar\');\n251. \n252.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo_bar\')).to.equal(\'fooUnderscorebar\');\n253. \n254.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo.bar\')).to.equal(\'fooPeriodbar\');\n255.     });\n256. \n257.     it(\'converts multiple `-` correctly\', () => {\n258.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'a-longer-path\')).to.equal(\n259.         \'aDashlongerDashpath\'\n260.       );\n261.     });\n262. \n263.     it(\'converts multiple `-` and `_` correctly\', () => {\n264.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'a-long_er-path_still\')).to.equal(\n265.         \'aDashlongUnderscoreerDashpathUnderscorestill\'\n266.       );\n267.     });\n268.   });\n269. \n270.   describe(\'#getWebsocketsRouteLogicalId()\', () => {\n271.     it(\'should return the websockets route logical id\', () => {\n272.       expect(sdk.naming.getWebsocketsRouteLogicalId(\'$connect\')).to.equal(\n273.         \'SconnectWebsocketsRoute\'\n274.       );\n275.     });\n276.   });\n277. \n278.   describe(\'#getWebsocketsDeploymentLogicalId()\', () => {\n279.     it(\'should return the websockets deployment logical id\', () => {\n280.       expect(sdk.naming.getWebsocketsDeploymentLogicalId(\'Abc+123=\')).to.equal(\n281.         \'WebsocketsDeploymentAbc123\'\n282.       );\n283.     });\n284.   });\n285. \n286.   describe(\'#getWebsocketsStageLogicalId()\', () => {\n287.     it(\'should return the websockets stage logical id\', () => {\n288.       expect(sdk.naming.getWebsocketsStageLogicalId()).to.equal(\'WebsocketsDeploymentStage\');\n289.     });\n290.   });\n291. \n292.   describe(\'#getWebsocketsAuthorizerLogicalId()\', () => {\n293.     it(\'should return the websockets authorizer logical id\', () => {\n294.       expect(sdk.naming.getWebsocketsAuthorizerLogicalId(\'auth\')).to.equal(\n295.         \'AuthWebsocketsAuthorizer\'\n296.       );\n297.     });\n298.   });\n299. \n300.   describe(\'#getWebsocketsLogGroupLogicalId()\', () => {\n301.     it(\'should return the Websockets log group logical id\', () => {\n302.       expect(sdk.naming.getWebsocketsLogGroupLogicalId()).to.equal(\'WebsocketsLogGroup\');\n303.     });\n304.   });\n305. \n306.   describe(\'#getApiGatewayName()\', () => {\n307.     it(\'should return the composition of stage & service name if custom name not provided\', () => {\n308.       serverless.service.service = \'myService\';\n309.       expect(sdk.naming.getApiGatewayName()).to.equal(\n310.         `${sdk.naming.provider.getStage()}-${serverless.service.service}`\n311.       );\n312.     });\n313. \n314.     it(\'should return the custom api name if provided\', () => {\n315.       serverless.service.provider.apiName = \'app-dev-testApi\';\n316.       serverless.service.service = \'myService\';\n317.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n318.       expect(sdk.naming.getApiGatewayName()).to.equal(\'app-dev-testApi\');\n319.     });\n320.   });\n321. \n322.   describe(\'#generateApiGatewayDeploymentLogicalId()\', () => {\n323.     it(\'should return ApiGatewayDeployment with a suffix\', () => {\n324.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId(1234)).to.equal(\n325.         \'ApiGatewayDeployment1234\'\n326.       );\n327.     });\n328.   });\n329. \n330.   describe(\'#getRestApiLogicalId()\', () => {\n331.     it(\'should return ApiGatewayRestApi\', () => {\n332.       expect(sdk.naming.getRestApiLogicalId()).to.equal(\'ApiGatewayRestApi\');\n333.     });\n334.   });\n335. \n336.   describe(\'#getNormalizedAuthorizerName()\', () => {\n337.     it(\'normalize the authorizer name\', () => {\n338.       expect(sdk.naming.getNormalizedAuthorizerName(\'authorizerName\')).to.equal(\'AuthorizerName\');\n339.     });\n340.   });\n341. \n342.   describe(\'#getAuthorizerLogicalId()\', () => {\n343.     it(\'should normalize the authorizer name and add the standard suffix\', () => {\n344.       expect(sdk.naming.getAuthorizerLogicalId(\'authorizerName\')).to.equal(\n345.         \'AuthorizerNameApiGatewayAuthorizer\'\n346.       );\n347.     });\n348.   });\n349. \n350.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n351.     it(\'should extract the authorizer name from an ARN\', () => {\n352.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n353.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n354.     });\n355.   });\n356. \n357.   describe(\'#normalizePath()\', () => {\n358.     it(\'should normalize each part of the resource path and remove non-alpha-numeric characters\', () => {\n359.       expect(sdk.naming.normalizePath(\'my/path/to/a-${var}-resource\')).to.equal(\n360.         \'MyPathToADashvarVarDashresource\'\n361.       );\n362.     });\n363.   });\n364. \n365.   describe(\'#getResourceLogicalId()\', () => {\n366.     it(\'should normalize the resource and add the standard suffix\', () => {\n367.       expect(sdk.naming.getResourceLogicalId(\'my/path/to/a-${var}-resource\')).to.equal(\n368.         \'ApiGatewayResourceMyPathToADashvarVarDashresource\'\n369.       );\n370.     });\n371.   });\n372. \n373.   describe(\'#extractResourceId()\', () => {\n374.     it(\'should extract the normalized resource name\', () => {\n375.       expect(\n376.         sdk.naming.extractResourceId(\'ApiGatewayResourceMyPathToADashvarVarDashResource\')\n377.       ).to.equal(\'MyPathToADashvarVarDashResource\');\n378.     });\n379.   });\n380. \n381.   describe(\'#normalizeMethodName()\', () => {\n382.     it(\'should capitalize the first letter and lowercase any other characters\', () => {\n383.       expect(sdk.naming.normalizeMethodName(\'gET\')).to.equal(\'Get\');\n384.     });\n385.   });\n386. \n387.   describe(\'#getMethodLogicalId()\', () => {\n388.     it(\'\', () => {\n389.       expect(sdk.naming.getMethodLogicalId(\'ResourceId\', \'get\')).to.equal(\n390.         \'ApiGatewayMethodResourceIdGet\'\n391.       );\n392.     });\n393.   });\n394. \n395.   describe(\'#getValidatorLogicalId()\', () => {\n396.     it(\'\', () => {\n397.       expect(sdk.naming.getValidatorLogicalId(\'ResourceId\', \'get\')).to.equal(\n398.         \'ApiGatewayMethodResourceIdGetValidator\'\n399.       );\n400.     });\n401.   });\n402. \n403.   describe(\'#getModelLogicalId()\', () => {\n404.     it(\'\', () => {\n405.       expect(sdk.naming.getModelLogicalId(\'ResourceId\', \'get\', \'application/json\')).to.equal(\n406.         \'ApiGatewayMethodResourceIdGetApplicationJsonModel\'\n407.       );\n408.     });\n409.   });\n410. \n411.   describe(\'#getApiKeyLogicalId(keyIndex)\', () => {\n412.     it(\'should produce the given index with ApiGatewayApiKey as a prefix\', () => {\n413.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal(\'ApiGatewayApiKey1\');\n414.     });\n415. \n416.     it(\'should support API Key names\', () => {\n417.       expect(sdk.naming.getApiKeyLogicalId(1, \'free\')).to.equal(\'ApiGatewayApiKeyFree1\');\n418.     });\n419.   });\n420. \n421.   describe(\'#getApiKeyLogicalIdRegex()\', () => {\n422.     it(\'should match the prefix\', () => {\n423.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'ApiGatewayApiKey\')).to.equal(true);\n424.     });\n425. \n426.     it(\'should not match a name without the prefix\', () => {\n427.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'NotThePrefixApiGatewayApiKey\')).to.equal(\n428.         false\n429.       );\n430.     });\n431. \n432.     it(\'should match a name with the prefix\', () => {\n433.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'ApiGatewayApiKeySuffix\')).to.equal(true);\n434.     });\n435.   });\n436. \n437.   describe(\'#getUsagePlanLogicalId()\', () => {\n438.     it(\'should return the default ApiGateway usage plan logical id\', () => {\n439.       expect(sdk.naming.getUsagePlanLogicalId()).to.equal(\'ApiGatewayUsagePlan\');\n440.     });\n441. \n442.     it(\'should return the named ApiGateway usage plan logical id\', () => {\n443.       expect(sdk.naming.getUsagePlanLogicalId(\'free\')).to.equal(\'ApiGatewayUsagePlanFree\');\n444.     });\n445.   });\n446. \n447.   describe(\'#getUsagePlanKeyLogicalId()\', () => {\n448.     it(\'should produce the given index with ApiGatewayUsagePlanKey as a prefix\', () => {\n449.       expect(sdk.naming.getUsagePlanKeyLogicalId(1)).to.equal(\'ApiGatewayUsagePlanKey1\');\n450.     });\n451. \n452.     it(\'should support API Key names\', () => {\n453.       expect(sdk.naming.getUsagePlanKeyLogicalId(1, \'free\')).to.equal(\n454.         \'ApiGatewayUsagePlanKeyFree1\'\n455.       );\n456.     });\n457.   });\n458. \n459.   describe(\'#getStageLogicalId()\', () => {\n460.     it(\'should return the API Gateway stage logical id\', () => {\n461.       expect(sdk.naming.getStageLogicalId()).to.equal(\'ApiGatewayStage\');\n462.     });\n463.   });\n464. \n465.   describe(\'#getApiGatewayLogGroupLogicalId()\', () => {\n466.     it(\'should return the API Gateway log group logical id\', () => {\n467.       expect(sdk.naming.getApiGatewayLogGroupLogicalId()).to.equal(\'ApiGatewayLogGroup\');\n468.     });\n469.   });\n470. \n471.   describe(\'#getDeploymentBucketLogicalId()\', () => {\n472.     it(\'should return "ServerlessDeploymentBucket"\', () => {\n473.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal(\'ServerlessDeploymentBucket\');\n474.     });\n475.   });\n476. \n477.   describe(\'#getDeploymentBucketOutputLogicalId()\', () => {\n478.     it(\'should return "ServerlessDeploymentBucketName"\', () => {\n479.       expect(sdk.naming.getDeploymentBucketOutputLogicalId()).to.equal(\n480.         \'ServerlessDeploymentBucketName\'\n481.       );\n482.     });\n483.   });\n484. \n485.   describe(\'#getDeploymentBucketPolicyLogicalId()\', () => {\n486.     it(\'should return "ServerlessDeploymentBucketPolicy"\', () => {\n487.       expect(sdk.naming.getDeploymentBucketPolicyLogicalId()).to.equal(\n488.         \'ServerlessDeploymentBucketPolicy\'\n489.       );\n490.     });\n491.   });\n492. \n493.   describe(\'#normalizeBucketName()\', () => {\n494.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n495.       expect(sdk.naming.normalizeBucketName(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'BucketName\');\n496.     });\n497.   });\n498. \n499.   describe(\'#getBucketLogicalId()\', () => {\n500.     it(\'should normalize the bucket name and add the standard prefix\', () => {\n501.       expect(sdk.naming.getBucketLogicalId(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'S3BucketBucketName\');\n502.     });\n503.   });\n504. \n505.   describe(\'#normalizeTopicName()\', () => {\n506.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n507.       expect(sdk.naming.normalizeTopicName(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'TopicName\');\n508.     });\n509.   });\n510. \n511.   describe(\'#getTopicLogicalId()\', () => {\n512.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n513.       expect(sdk.naming.getTopicLogicalId(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'SNSTopicTopicName\');\n514.     });\n515.   });\n516. \n517.   describe(\'#getScheduleId()\', () => {\n518.     it(\'should add the standard suffix\', () => {\n519.       expect(sdk.naming.getScheduleId(\'functionName\')).to.equal(\'functionNameSchedule\');\n520.     });\n521.   });\n522. \n523.   describe(\'#getScheduleLogicalId()\', () => {\n524.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n525.       expect(sdk.naming.getScheduleLogicalId(\'functionName\', 0)).to.equal(\n526.         \'FunctionNameEventsRuleSchedule0\'\n527.       );\n528.     });\n529.   });\n530. \n531.   describe(\'#getStreamConsumerName()\', () => {\n532.     it(\'should add the standard suffix\', () => {\n533.       expect(sdk.naming.getStreamConsumerName(\'functionName\', \'streamName\')).to.equal(\n534.         \'functionNamestreamNameConsumer\'\n535.       );\n536.     });\n537.   });\n538. \n539.   describe(\'#getStreamConsumerLogicalId()\', () => {\n540.     it(\'should normalize the stream consumer name and add the standard suffix\', () => {\n541.       expect(sdk.naming.getStreamConsumerLogicalId(\'streamConsumerName\')).to.equal(\n542.         \'StreamConsumerNameStreamConsumer\'\n543.       );\n544.     });\n545.   });\n546. \n547.   describe(\'#getCloudWatchEventId()\', () => {\n548.     it(\'should add the standard suffix\', () => {\n549.       expect(sdk.naming.getCloudWatchEventId(\'functionName\')).to.equal(\n550.         \'functionNameCloudWatchEvent\'\n551.       );\n552.     });\n553.   });\n554. \n555.   describe(\'#getCloudWatchEventLogicalId()\', () => {\n556.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n557.       expect(sdk.naming.getCloudWatchEventLogicalId(\'functionName\', 0)).to.equal(\n558.         \'FunctionNameEventsRuleCloudWatchEvent0\'\n559.       );\n560.     });\n561.   });\n562. \n563.   describe(\'#getCloudWatchLogLogicalId()\', () => {\n564.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n565.       expect(sdk.naming.getCloudWatchLogLogicalId(\'functionName\', 0)).to.equal(\n566.         \'FunctionNameLogsSubscriptionFilterCloudWatchLog0\'\n567.       );\n568.     });\n569.   });\n570. \n571.   describe(\'#getCognitoUserPoolLogicalId()\', () => {\n572.     it(\'should normalize the user pool name and add the standard prefix\', () => {\n573.       expect(sdk.naming.getCognitoUserPoolLogicalId(\'us-east-1_v123sDAS1\')).to.equal(\n574.         \'CognitoUserPoolUseast1v123sDAS1\'\n575.       );\n576.     });\n577.   });\n578. \n579.   describe(\'#getLambdaS3PermissionLogicalId()\', () => {\n580.     it(\'should normalize the function name and add the standard suffix\', () => {\n581.       expect(sdk.naming.getLambdaS3PermissionLogicalId(\'functionName\', \'bucket\')).to.equal(\n582.         \'FunctionNameLambdaPermissionBucketS3\'\n583.       );\n584.     });\n585.   });\n586. \n587.   describe(\'#getLambdaSnsPermissionLogicalId()\', () => {\n588.     it(\n589.       \'should normalize the function and topic names and add them as prefix and suffix to the \' +\n590.         \'standard permission center\',\n591.       () => {\n592.         expect(sdk.naming.getLambdaSnsPermissionLogicalId(\'functionName\', \'topic\')).to.equal(\n593.           \'FunctionNameLambdaPermissionTopicSNS\'\n594.         );\n595.       }\n596.     );\n597.   });\n598. \n599.   describe(\'#getLambdaSchedulePermissionLogicalId()\', () => {\n600.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n601.       expect(sdk.naming.getLambdaSchedulePermissionLogicalId(\'functionName\', 0)).to.equal(\n602.         \'FunctionNameLambdaPermissionEventsRuleSchedule0\'\n603.       );\n604.     });\n605.   });\n606. \n607.   describe(\'#getLambdaCloudWatchEventPermissionLogicalId()\', () => {\n608.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n609.       expect(sdk.naming.getLambdaCloudWatchEventPermissionLogicalId(\'functionName\', 0)).to.equal(\n610.         \'FunctionNameLambdaPermissionEventsRuleCloudWatchEvent0\'\n611.       );\n612.     });\n613.   });\n614. \n615.   describe(\'#getLambdaApiGatewayPermissionLogicalId()\', () => {\n616.     it(\'should normalize the function name and append the standard suffix\', () => {\n617.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId(\'functionName\')).to.equal(\n618.         \'FunctionNameLambdaPermissionApiGateway\'\n619.       );\n620.     });\n621.   });\n622. \n623.   describe(\'#getIotLogicalId()\', () => {\n624.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n625.       expect(sdk.naming.getIotLogicalId(\'functionName\', 0)).to.equal(\'FunctionNameIotTopicRule0\');\n626.     });\n627.   });\n628. \n629.   describe(\'#getLambdaIotPermissionLogicalId()\', () => {\n630.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n631.       expect(sdk.naming.getLambdaIotPermissionLogicalId(\'functionName\', 0)).to.equal(\n632.         \'FunctionNameLambdaPermissionIotTopicRule0\'\n633.       );\n634.     });\n635.   });\n636. \n637.   describe(\'#getLambdaAlexaSkillPermissionLogicalId()\', () => {\n638.     it(\'should normalize the function name and append the standard suffix\', () => {\n639.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\', 2)).to.equal(\n640.         \'FunctionNameLambdaPermissionAlexaSkill2\'\n641.       );\n642.     });\n643. \n644.     it(\'should normalize the function name and append a default suffix if not defined\', () => {\n645.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\')).to.equal(\n646.         \'FunctionNameLambdaPermissionAlexaSkill0\'\n647.       );\n648.     });\n649.   });\n650. \n651.   describe(\'#getLambdaAlexaSmartHomePermissionLogicalId()\', () => {\n652.     it(\'should normalize the function name and append the standard suffix\', () => {\n653.       expect(sdk.naming.getLambdaAlexaSmartHomePermissionLogicalId(\'functionName\', 0)).to.equal(\n654.         \'FunctionNameLambdaPermissionAlexaSmartHome0\'\n655.       );\n656.     });\n657.   });\n658. \n659.   describe(\'#getLambdaSnsSubscriptionLogicalId()\', () => {\n660.     it(\'should normalize the function name and append the standard suffix\', () => {\n661.       expect(sdk.naming.getLambdaSnsSubscriptionLogicalId(\'functionName\', \'topicName\')).to.equal(\n662.         \'FunctionNameSnsSubscriptionTopicName\'\n663.       );\n664.     });\n665.   });\n666. \n667.   describe(\'#getLambdaCloudWatchLogPermissionLogicalId()\', () => {\n668.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n669.       expect(sdk.naming.getLambdaCloudWatchLogPermissionLogicalId(\'functionName\')).to.equal(\n670.         \'FunctionNameLambdaPermissionLogsSubscriptionFilterCloudWatchLog\'\n671.       );\n672.     });\n673.   });\n674. \n675.   describe(\'#getLambdaCognitoUserPoolPermissionLogicalId()\', () => {\n676.     it(\'should normalize the function name and add the standard suffix\', () => {\n677.       expect(\n678.         sdk.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n679.           \'functionName\',\n680.           \'Pool1\',\n681.           \'CustomMessage\'\n682.         )\n683.       ).to.equal(\'FunctionNameLambdaPermissionCognitoUserPoolPool1TriggerSourceCustomMessage\');\n684.     });\n685. \n686.     describe(\'#getLambdaAlbPermissionLogicalId()\', () => {\n687.       it(\'should normalize the function name\', () => {\n688.         expect(sdk.naming.getLambdaAlbPermissionLogicalId(\'functionName\')).to.equal(\n689.           \'FunctionNameLambdaPermissionAlb\'\n690.         );\n691.       });\n692.     });\n693. \n694.     describe(\'#getLambdaRegisterTargetPermissionLogicalId()\', () => {\n695.       it(\'should normalize the function name and add the correct suffix\', () => {\n696.         expect(sdk.naming.getLambdaRegisterTargetPermissionLogicalId(\'functionName\')).to.equal(\n697.           \'FunctionNameLambdaPermissionRegisterTarget\'\n698.         );\n699.       });\n700.     });\n701.   });\n702. \n703.   describe(\'#getQueueLogicalId()\', () => {\n704.     it(\'should normalize the function name and add the standard suffix\', () => {\n705.       expect(sdk.naming.getQueueLogicalId(\'functionName\', \'MyQueue\')).to.equal(\n706.         \'FunctionNameEventSourceMappingSQSMyQueue\'\n707.       );\n708.     });\n709.   });\n710. \n711.   describe(\'#getAlbTargetGroupLogicalId()\', () => {\n712.     it(\'should normalize the function name\', () => {\n713.       expect(sdk.naming.getAlbTargetGroupLogicalId(\'functionName\', \'abc123\')).to.equal(\n714.         \'FunctionNameAlbTargetGroupabc123\'\n715.       );\n716.     });\n717. \n718.     it(\'should normalize the function name and add MultiValue prefix if multiValueHeader is true\', () => {\n719.       expect(sdk.naming.getAlbTargetGroupLogicalId(\'functionName\', \'abc123\', true)).to.equal(\n720.         \'FunctionNameAlbMultiValueTargetGroupabc123\'\n721.       );\n722.     });\n723.   });\n724. \n725.   describe(\'#getAlbListenerRuleLogicalId()\', () => {\n726.     it(\'should normalize the function name and add an index\', () => {\n727.       expect(sdk.naming.getAlbListenerRuleLogicalId(\'functionName\', 0)).to.equal(\n728.         \'FunctionNameAlbListenerRule0\'\n729.       );\n730.     });\n731.   });\n732. \n733.   describe(\'#getAlbTargetGroupName()\', () => {\n734.     it(\'should return a unique identifier based on the service name, function name, alb id, multi-value attribute and stage\', () => {\n735.       serverless.service.service = \'myService\';\n736.       expect(sdk.naming.getAlbTargetGroupName(\'functionName\', \'abc123\', true)).to.equal(\n737.         \'79039bd239ac0b3f6ff6d9296f23e27c\'\n738.       );\n739.     });\n740. \n741.     it(\'should return a prefixed unique identifer of not longer than 32 characters if alb.targetGroupPrefix is set\', () => {\n742.       serverless.service.service = \'myService\';\n743.       serverless.service.provider.alb = {};\n744.       serverless.service.provider.alb.targetGroupPrefix = \'myPrefix-\';\n745.       expect(sdk.naming.getAlbTargetGroupName(\'functionName\', \'abc123\', true)).to.equal(\n746.         \'myPrefix-79039bd239ac0b3f6ff6d92\'\n747.       );\n748.     });\n749.   });\n750. \n751.   describe(\'#getAlbTargetGroupNameTagValue()\', () => {\n752.     it(\'should return the composition of service name, function name, alb id, multi-value attribute and stage\', () => {\n753.       serverless.service.service = \'myService\';\n754.       expect(sdk.naming.getAlbTargetGroupNameTagValue(\'functionName\', \'abc123\', true)).to.equal(\n755.         `${\n756.           serverless.service.service\n757.         }-functionName-abc123-multi-value-${sdk.naming.provider.getStage()}`\n758.       );\n759.     });\n760.   });\n761. \n762.   describe(\'#getCustomResourcesArtifactName()\', () => {\n763.     it(\'should return the custom resources artifact directory name\', () => {\n764.       expect(sdk.naming.getCustomResourcesArtifactName()).to.equal(\'custom-resources.zip\');\n765.     });\n766.   });\n767. \n768.   describe(\'#getCustomResourcesRoleLogicalId()\', () => {\n769.     it(\'should return the custom resources role logical id\', () => {\n770.       expect(sdk.naming.getCustomResourcesRoleLogicalId()).to.equal(\n771.         \'IamRoleCustomResourcesLambdaExecution\'\n772.       );\n773.     });\n774.   });\n775. \n776.   describe(\'#getCustomResourceS3HandlerFunctionName()\', () => {\n777.     it(\'should return the name of the S3 custom resource handler function\', () => {\n778.       expect(sdk.naming.getCustomResourceS3HandlerFunctionName()).to.equal(\n779.         \'custom-resource-existing-s3\'\n780.       );\n781.     });\n782.   });\n783. \n784.   describe(\'#getCustomResourceS3HandlerFunctionLogicalId()\', () => {\n785.     it(\'should return the logical id of the S3 custom resource handler function\', () => {\n786.       expect(sdk.naming.getCustomResourceS3HandlerFunctionLogicalId()).to.equal(\n787.         \'CustomDashresourceDashexistingDashs3LambdaFunction\'\n788.       );\n789.     });\n790.   });\n791. \n792.   describe(\'#getCustomResourceS3ResourceLogicalId()\', () => {\n793.     it(\'should return the logical id of the S3 custom resource\', () => {\n794.       const functionName = \'my-function\';\n795.       expect(sdk.naming.getCustomResourceS3ResourceLogicalId(functionName)).to.equal(\n796.         \'MyDashfunctionCustomS31\'\n797.       );\n798.     });\n799.   });\n800. \n801.   describe(\'#getCustomResourceCognitoUserPoolHandlerFunctionName()\', () => {\n802.     it(\'should return the name of the Cognito User Pool custom resource handler function\', () => {\n803.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionName()).to.equal(\n804.         \'custom-resource-existing-cup\'\n805.       );\n806.     });\n807.   });\n808. \n809.   describe(\'#getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()\', () => {\n810.     it(\'should return the logical id of the Cognito User Pool custom resource handler function\', () => {\n811.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()).to.equal(\n812.         \'CustomDashresourceDashexistingDashcupLambdaFunction\'\n813.       );\n814.     });\n815.   });\n816. \n817.   describe(\'#getCustomResourceCognitoUserPoolResourceLogicalId()\', () => {\n818.     it(\'should return the logical id of the Cognito User Pool custom resource\', () => {\n819.       const functionName = \'my-function\';\n820.       expect(sdk.naming.getCustomResourceCognitoUserPoolResourceLogicalId(functionName)).to.equal(\n821.         \'MyDashfunctionCustomCognitoUserPool1\'\n822.       );\n823.     });\n824.   });\n825. \n826.   describe(\'#getCustomResourceEventBridgeHandlerFunctionName()\', () => {\n827.     it(\'should return the name of the Event Bridge custom resource handler function\', () => {\n828.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionName()).to.equal(\n829.         \'custom-resource-event-bridge\'\n830.       );\n831.     });\n832.   });\n833. \n834.   describe(\'#getCustomResourceEventBridgeHandlerFunctionLogicalId()\', () => {\n835.     it(\'should return the logical id of the Event Bridge custom resource handler function\', () => {\n836.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId()).to.equal(\n837.         \'CustomDashresourceDasheventDashbridgeLambdaFunction\'\n838.       );\n839.     });\n840.   });\n841. \n842.   describe(\'#getCustomResourceEventBridgeResourceLogicalId()\', () => {\n843.     it(\'should return the logical id of the Event Bridge custom resource\', () => {\n844.       const functionName = \'my-function\';\n845.       const index = 1;\n846.       expect(\n847.         sdk.naming.getCustomResourceEventBridgeResourceLogicalId(functionName, index)\n848.       ).to.equal(\'MyDashfunctionCustomEventBridge1\');\n849.     });\n850.   });\n851. \n852.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()\', () => {\n853.     it(\'should return the name of the APIGW Account CloudWatch role custom resource handler function\', () => {\n854.       expect(\n855.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()\n856.       ).to.equal(\'custom-resource-apigw-cw-role\');\n857.     });\n858.   });\n859. \n860.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()\', () => {\n861.     it(\'should return the logical id of the APIGW Account CloudWatch role custom resource handler function\', () => {\n862.       expect(\n863.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()\n864.       ).to.equal(\'CustomDashresourceDashapigwDashcwDashroleLambdaFunction\');\n865.     });\n866.   });\n867. \n868.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()\', () => {\n869.     it(\'should return the logical id of the APIGW Account CloudWatch role custom resource\', () => {\n870.       expect(\n871.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()\n872.       ).to.equal(\'CustomApiGatewayAccountCloudWatchRole\');\n873.     });\n874.   });\n875. \n876.   describe(\'#getCloudFrontDistributionLogicalId()\', () => {\n877.     it(\'should return CloudFront distribution logical id\', () => {\n878.       expect(sdk.naming.getCloudFrontDistributionLogicalId()).to.equal(\'CloudFrontDistribution\');\n879.     });\n880.   });\n881. \n882.   describe(\'#getCloudFrontDistributionDomainNameLogicalId()\', () => {\n883.     it(\'should return CloudFront distribution domain name logical id\', () => {\n884.       expect(sdk.naming.getCloudFrontDistributionDomainNameLogicalId()).to.equal(\n885.         \'CloudFrontDistributionDomainName\'\n886.       );\n887.     });\n888.   });\n889. \n890.   describe(\'#getLambdaAtEdgeInvokePermissionLogicalId()\', () => {\n891.     it(\'should return lambda@edge invoke permission logical id\', () => {\n892.       expect(sdk.naming.getLambdaAtEdgeInvokePermissionLogicalId(\'functionName\')).to.equal(\n893.         \'FunctionNameLambdaFunctionInvokePermission\'\n894.       );\n895.     });\n896.   });\n897. \n898.   describe(\'#getCloudFrontOriginId()\', () => {\n899.     it(\'should return CloudFront origin id for s3 origin\', () => {\n900.       expect(\n901.         sdk.naming.getCloudFrontOriginId({\n902.           S3OriginConfig: {},\n903.           DomainName: \'domain.name\',\n904.           OriginPath: \'/path\',\n905.         })\n906.       ).to.equal(\'s3/domain.name/path\');\n907.     });\n908. \n909.     it(\'should return CloudFront origin id for custom origin\', () => {\n910.       expect(\n911.         sdk.naming.getCloudFrontOriginId({\n912.           CustomOriginConfig: {},\n913.           DomainName: \'domain.name\',\n914.           OriginPath: \'/path\',\n915.         })\n916.       ).to.equal(\'custom/domain.name/path\');\n917.     });\n918. \n919.     it(\'should return CloudFront origin id from domain as a object\', () => {\n920.       expect(\n921.         sdk.naming.getCloudFrontOriginId({\n922.           CustomOriginConfig: {},\n923.           DomainName: {\n924.             \'Fn::Join\': [\'\', [\'Ref: ApiGatewayRestApi\', \'.execute-api.\']],\n925.           },\n926.         })\n927.       ).to.equal(\'custom/FnJoinRefApiGatewayRestApiexecuteapi\');\n928.     });\n929.   });\n930. });', 'start_line_number': 1, 'end_line_number': 930}, {'relative_path': 'lib/plugins/aws/package/index.test.js', 'content': '1. \'use strict\';\n2. \n3. const AwsProvider = require(\'../provider/awsProvider\');\n4. const AwsPackage = require(\'./index\');\n5. const Serverless = require(\'../../../Serverless\');\n6. const CLI = require(\'../../../classes/CLI\');\n7. const expect = require(\'chai\').expect;\n8. const sinon = require(\'sinon\');\n9. const path = require(\'path\');\n10. \n11. describe(\'AwsPackage\', () => {\n12.   let awsPackage;\n13.   let serverless;\n14.   let options;\n15. \n16.   beforeEach(() => {\n17.     serverless = new Serverless();\n18.     options = {\n19.       stage: \'dev\',\n20.       region: \'us-east-1\',\n21.     };\n22.     serverless.setProvider(\'aws\', new AwsProvider(serverless, options));\n23.     serverless.config.servicePath = \'foo\';\n24.     serverless.cli = new CLI(serverless);\n25.     awsPackage = new AwsPackage(serverless, options);\n26.   });\n27. \n28.   describe(\'#constructor()\', () => {\n29.     it(\'should set the serverless instance\', () => {\n30.       expect(awsPackage.serverless).to.equal(serverless);\n31.     });\n32. \n33.     it(\'should set options\', () => {\n34.       expect(awsPackage.options).to.equal(options);\n35.     });\n36. \n37.     it(\'should set the service path if provided\', () => {\n38.       expect(awsPackage.servicePath).to.equal(\'foo\');\n39.     });\n40. \n41.     it(\'should default to an empty service path if not provided\', () => {\n42.       serverless.config.servicePath = false;\n43.       awsPackage = new AwsPackage(serverless, options);\n44. \n45.       expect(awsPackage.servicePath).to.equal(\'\');\n46.     });\n47. \n48.     it(\'should use the options package path if provided\', () => {\n49.       options.package = \'package-options\';\n50.       awsPackage = new AwsPackage(serverless, options);\n51. \n52.       expect(awsPackage.packagePath).to.equal(\'package-options\');\n53.     });\n54. \n55.     it(\'should use the services package path if provided\', () => {\n56.       serverless.service = {\n57.         package: {\n58.           path: \'package-service\',\n59.         },\n60.       };\n61.       awsPackage = new AwsPackage(serverless, options);\n62. \n63.       expect(awsPackage.packagePath).to.equal(\'package-service\');\n64.     });\n65. \n66.     it(\'should default to the .serverless directory as the package path\', () => {\n67.       expect(awsPackage.packagePath).to.equal(path.join(\'foo\', \'.serverless\'));\n68.     });\n69. \n70.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));\n72. \n73.     it(\'should have commands\', () => expect(awsPackage.commands).to.be.not.empty);\n74. \n75.     it(\'should have hooks\', () => expect(awsPackage.hooks).to.be.not.empty);\n76.   });\n77. \n78.   describe(\'hooks\', () => {\n79.     let spawnStub;\n80.     let generateCoreTemplateStub;\n81.     let mergeIamTemplatesStub;\n82.     let generateArtifactDirectoryNameStub;\n83.     let mergeCustomProviderResourcesStub;\n84.     let saveCompiledTemplateStub;\n85.     let saveServiceStateStub;\n86. \n87.     beforeEach(() => {\n88.       spawnStub = sinon.stub(serverless.pluginManager, \'spawn\');\n89.       generateCoreTemplateStub = sinon.stub(awsPackage, \'generateCoreTemplate\').resolves();\n90.       mergeIamTemplatesStub = sinon.stub(awsPackage, \'mergeIamTemplates\').resolves();\n91.       generateArtifactDirectoryNameStub = sinon\n92.         .stub(awsPackage, \'generateArtifactDirectoryName\')\n93.         .resolves();\n94.       mergeCustomProviderResourcesStub = sinon\n95.         .stub(awsPackage, \'mergeCustomProviderResources\')\n96.         .resolves();\n97.       saveCompiledTemplateStub = sinon.stub(awsPackage, \'saveCompiledTemplate\').resolves();\n98.       saveServiceStateStub = sinon.stub(awsPackage, \'saveServiceState\').resolves();\n99.     });\n100. \n101.     afterEach(() => {\n102.       serverless.pluginManager.spawn.restore();\n103.       awsPackage.generateCoreTemplate.restore();\n104.       awsPackage.mergeIamTemplates.restore();\n105.       awsPackage.generateArtifactDirectoryName.restore();\n106.       awsPackage.mergeCustomProviderResources.restore();\n107.       awsPackage.saveCompiledTemplate.restore();\n108.       awsPackage.saveServiceState.restore();\n109.     });\n110. \n111.     it(\'should run "package:cleanup" hook\', () => {\n112.       const spawnAwsCommonValidateStub = spawnStub.withArgs(\'aws:common:validate\').resolves();\n113.       const spawnAwsCommonCleanupTempDirStub = spawnStub\n114.         .withArgs(\'aws:common:cleanupTempDir\')\n115.         .resolves();\n116. \n117.       return awsPackage.hooks[\'package:cleanup\']().then(() => {\n118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);\n119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(\n120.           true\n121.         );\n122.       });\n123.     });\n124. \n125.     it(\'should run "package:initialize" hook\', () =>\n126.       awsPackage.hooks[\'package:initialize\']().then(() => {\n127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);\n128.       }));\n129. \n130.     it(\'should run "package:setupProviderConfiguration" hook\', () =>\n131.       awsPackage.hooks[\'package:setupProviderConfiguration\']().then(() => {\n132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);\n133.       }));\n134. \n135.     it(\'should run "before:package:compileFunctions" hook\', () =>\n136.       awsPackage.hooks[\'before:package:compileFunctions\']().then(() => {\n137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);\n138.       }));\n139. \n140.     it(\'should run "package:finalize" hook\', () => {\n141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs(\'aws:package:finalize\').resolves();\n142. \n143.       return awsPackage.hooks[\'package:finalize\']().then(() => {\n144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);\n145.       });\n146.     });\n147. \n148.     it(\'should run "aws:package:finalize:mergeCustomProviderResources" hook\', () =>\n149.       awsPackage.hooks[\'aws:package:finalize:mergeCustomProviderResources\']().then(() => {\n150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);\n151.       }));\n152. \n153.     it(\'should run "aws:package:finalize:saveServiceState" hook\', () => {\n154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub\n155.         .withArgs(\'aws:common:moveArtifactsToPackage\')\n156.         .resolves();\n157. \n158.       return awsPackage.hooks[\'aws:package:finalize:saveServiceState\']().then(() => {\n159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);\n160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);\n161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(\n162.           true\n163.         );\n164.       });\n165.     });\n166.   });\n167. });', 'start_line_number': 1, 'end_line_number': 167}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });", 'start_line_number': 600, 'end_line_number': 653}, {'relative_path': 'lib/plugins/aws/package/compile/events/sqs/index.test.js', 'content': "399.       it('should allow specifying SQS Queues as CFN reference types', () => {\n400.         awsCompileSQSEvents.serverless.service.functions = {\n401.           first: {\n402.             events: [\n403.               {\n404.                 sqs: {\n405.                   arn: { 'Fn::GetAtt': ['SomeQueue', 'Arn'] },\n406.                 },\n407.               },\n408.               {\n409.                 sqs: {\n410.                   arn: { 'Fn::ImportValue': 'ForeignQueue' },\n411.                 },\n412.               },\n413.               {\n414.                 sqs: {\n415.                   arn: {\n416.                     'Fn::Join': [\n417.                       ':',\n418.                       [\n419.                         'arn',\n420.                         'aws',\n421.                         'sqs',\n422.                         {\n423.                           Ref: 'AWS::Region',\n424.                         },\n425.                         {\n426.                           Ref: 'AWS::AccountId',\n427.                         },\n428.                         'MyQueue',\n429.                       ],\n430.                     ],\n431.                   },\n432.                 },\n433.               },\n434.             ],\n435.           },\n436.         };\n437. \n438.         awsCompileSQSEvents.compileSQSEvents();\n439. \n440.         expect(\n441.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n442.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement[0]\n443.         ).to.deep.equal({\n444.           Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],\n445.           Effect: 'Allow',\n446.           Resource: [\n447.             {\n448.               'Fn::GetAtt': ['SomeQueue', 'Arn'],\n449.             },\n450.             {\n451.               'Fn::ImportValue': 'ForeignQueue',\n452.             },\n453.             {\n454.               'Fn::Join': [\n455.                 ':',\n456.                 [\n457.                   'arn',\n458.                   'aws',\n459.                   'sqs',\n460.                   {\n461.                     Ref: 'AWS::Region',\n462.                   },\n463.                   {\n464.                     Ref: 'AWS::AccountId',\n465.                   },\n466.                   'MyQueue',\n467.                 ],\n468.               ],\n469.             },\n470.           ],\n471.         });\n472.         expect(\n473.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n474.             .FirstEventSourceMappingSQSSomeQueue.Properties.EventSourceArn\n475.         ).to.deep.equal({ 'Fn::GetAtt': ['SomeQueue', 'Arn'] });\n476.         expect(\n477.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n478.             .FirstEventSourceMappingSQSForeignQueue.Properties.EventSourceArn\n479.         ).to.deep.equal({ 'Fn::ImportValue': 'ForeignQueue' });\n480.         expect(\n481.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n482.             .FirstEventSourceMappingSQSMyQueue.Properties.EventSourceArn\n483.         ).to.deep.equal({\n484.           'Fn::Join': [\n485.             ':',\n486.             [\n487.               'arn',\n488.               'aws',\n489.               'sqs',\n490.               {\n491.                 Ref: 'AWS::Region',\n492.               },\n493.               {\n494.                 Ref: 'AWS::AccountId',\n495.               },\n496.               'MyQueue',\n497.             ],\n498.           ],\n499.         });\n500.       });", 'start_line_number': 399, 'end_line_number': 500}, {'relative_path': 'lib/plugins/aws/package/compile/events/sqs/index.test.js', 'content': "521.       it('should add the necessary IAM role statements', () => {\n522.         awsCompileSQSEvents.serverless.service.functions = {\n523.           first: {\n524.             events: [\n525.               {\n526.                 sqs: 'arn:aws:sqs:region:account:MyFirstQueue',\n527.               },\n528.               {\n529.                 sqs: 'arn:aws:sqs:region:account:MySecondQueue',\n530.               },\n531.             ],\n532.           },\n533.         };\n534. \n535.         const iamRoleStatements = [\n536.           {\n537.             Effect: 'Allow',\n538.             Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],\n539.             Resource: [\n540.               'arn:aws:sqs:region:account:MyFirstQueue',\n541.               'arn:aws:sqs:region:account:MySecondQueue',\n542.             ],\n543.           },\n544.         ];\n545. \n546.         awsCompileSQSEvents.compileSQSEvents();\n547. \n548.         expect(\n549.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n550.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement\n551.         ).to.deep.equal(iamRoleStatements);\n552.       });", 'start_line_number': 521, 'end_line_number': 552}]}]
2025-11-13 20:36:19,322 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 2 memories from memory
2025-11-13 20:36:19,322 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 19 contexts from memory
2025-11-13 20:36:19,323 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 18 contexts from memory
2025-11-13 20:36:19,325 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 18 new contexts to 18 existing contexts
2025-11-13 20:36:19,327 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 18 total contexts (removed 18 duplicates)
2025-11-13 20:36:19,328 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - INFO - Reached max_refined_query_loop, not asking for more context
2025-11-13 20:36:19,331 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='lib/plugins/aws/lib/naming.test.js', content='1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. \n5. const SDK = require(\'../provider/awsProvider\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. describe(\'#naming()\', () => {\n9.   let options;\n10.   let serverless;\n11.   let sdk;\n12. \n13.   beforeEach(() => {\n14.     options = {\n15.       stage: \'dev\',\n16.       region: \'us-east-1\',\n17.     };\n18.     serverless = new Serverless(options);\n19.     sdk = new SDK(serverless, options);\n20.   });\n21. \n22.   describe(\'#normalizeName()\', () => {\n23.     it(\'should capitalize the first letter\', () => {\n24.       expect(sdk.naming.normalizeName(\'name\')).to.equal(\'Name\');\n25.     });\n26. \n27.     it(\'should have no effect on caps\', () => {\n28.       expect(sdk.naming.normalizeName(\'Name\')).to.equal(\'Name\');\n29.     });\n30. \n31.     it(\'should have no effect on the rest of the name\', () => {\n32.       expect(sdk.naming.normalizeName(\'nAME\')).to.equal(\'NAME\');\n33.     });\n34.   });\n35. \n36.   describe(\'#normalizeNameToAlphaNumericOnly()\', () => {\n37.     it(\'should strip non-alpha-numeric characters\', () => {\n38.       expect(\n39.         sdk.naming.normalizeNameToAlphaNumericOnly(\'`!@#$%^&*()-={}|[]\\\\:";\\\'<>?,./\')\n40.       ).to.equal(\'\');\n41.     });\n42. \n43.     it(\'should apply normalizeName to the remaining characters\', () => {\n44.       expect(sdk.naming.normalizeNameToAlphaNumericOnly(\'a-b-c\')).to.equal(\'Abc\');\n45.     });\n46.   });\n47. \n48.   describe(\'#normalizePathPart()\', () => {\n49.     it(\'converts `-` to `Dash`\', () => {\n50.       expect(sdk.naming.normalizePathPart(\'a-path\')).to.equal(\'ADashpath\');\n51.     });\n52. \n53.     it(\'converts variable declarations (`${var}`) to `VariableVar`\', () => {\n54.       expect(sdk.naming.normalizePathPart(\'${variable}\')).to.equal(\'VariableVar\');\n55.     });\n56. \n57.     it(\'converts variable declarations prefixes to `VariableVarpath`\', () => {\n58.       expect(sdk.naming.normalizePathPart(\'${variable}Path\')).to.equal(\'VariableVarpath\');\n59.     });\n60. \n61.     it(\'converts variable declarations suffixes to `PathvariableVar`\', () => {\n62.       expect(sdk.naming.normalizePathPart(\'path${variable}\')).to.equal(\'PathvariableVar\');\n63.     });\n64. \n65.     it(\'converts variable declarations in center to `PathvariableVardir`\', () => {\n66.       expect(sdk.naming.normalizePathPart(\'path${variable}Dir\')).to.equal(\'PathvariableVardir\');\n67.     });\n68.   });\n69. \n70.   describe(\'#getServiceEndpointRegex()\', () => {\n71.     it(\'should match the prefix\', () => {\n72.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpoint\')).to.equal(true);\n73.     });\n74. \n75.     it(\'should not match a name without the prefix\', () => {\n76.       expect(sdk.naming.getServiceEndpointRegex().test(\'NotThePrefixServiceEndpoint\')).to.equal(\n77.         false\n78.       );\n79.     });\n80. \n81.     it(\'should match a name with the prefix\', () => {\n82.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpointForAService\')).to.equal(\n83.         true\n84.       );\n85.     });\n86.   });\n87. \n88.   describe(\'#getStackName()\', () => {\n89.     it(\'should use the service name & stage if custom stack name not provided\', () => {\n90.       serverless.service.service = \'myService\';\n91.       expect(sdk.naming.getStackName()).to.equal(\n92.         `${serverless.service.service}-${sdk.naming.provider.getStage()}`\n93.       );\n94.     });\n95. \n96.     it(\'should use the custom stack name if provided\', () => {\n97.       serverless.service.provider.stackName = \'app-dev-testApp\';\n98.       serverless.service.service = \'myService\';\n99.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n100.       expect(sdk.naming.getStackName()).to.equal(\'app-dev-testApp\');\n101.     });\n102.   });\n103. \n104.   describe(\'#getRolePath()\', () => {\n105.     it(\'should return `/`\', () => {\n106.       expect(sdk.naming.getRolePath()).to.equal(\'/\');\n107.     });\n108.   });\n109. \n110.   describe(\'#getRoleName()\', () => {\n111.     it(\'uses the service name, stage, and region to generate a role name\', () => {\n112.       serverless.service.service = \'myService\';\n113.       expect(sdk.naming.getRoleName()).to.eql({\n114.         \'Fn::Join\': [\n115.           \'-\',\n116.           [\n117.             serverless.service.service,\n118.             sdk.naming.provider.getStage(),\n119.             { Ref: \'AWS::Region\' },\n120.             \'lambdaRole\',\n121.           ],\n122.         ],\n123.       });\n124.     });\n125.   });\n126. \n127.   describe(\'#getRoleLogicalId()\', () => {\n128.     it(\'should return the expected role name (IamRoleLambdaExecution)\', () => {\n129.       expect(sdk.naming.getRoleLogicalId()).to.equal(\'IamRoleLambdaExecution\');\n130.     });\n131.   });\n132. \n133.   describe(\'#getPolicyName()\', () => {\n134.     it(\'should use the stage and service name\', () => {\n135.       serverless.service.service = \'myService\';\n136.       expect(sdk.naming.getPolicyName()).to.eql({\n137.         \'Fn::Join\': [\'-\', [sdk.naming.provider.getStage(), serverless.service.service, \'lambda\']],\n138.       });\n139.     });\n140.   });\n141. \n142.   describe(\'#getLogicalLogGroupName()\', () => {\n143.     it(\'should prefix the normalized function name to "LogGroup"\', () => {\n144.       expect(sdk.naming.getLogGroupLogicalId(\'functionName\')).to.equal(\'FunctionNameLogGroup\');\n145.     });\n146.   });\n147. \n148.   describe(\'#getLogGroupName()\', () => {\n149.     it(\'should add the function name to the log group name\', () => {\n150.       expect(sdk.naming.getLogGroupName(\'functionName\')).to.equal(\'/aws/lambda/functionName\');\n151.     });\n152.   });\n153. \n154.   describe(\'#getNormalizedFunctionName()\', () => {\n155.     it(\'should normalize the given functionName\', () => {\n156.       expect(sdk.naming.getNormalizedFunctionName(\'functionName\')).to.equal(\'FunctionName\');\n157.     });\n158. \n159.     it(\'should normalize the given functionName with an underscore\', () => {\n160.       expect(sdk.naming.getNormalizedFunctionName(\'hello_world\')).to.equal(\'HelloUnderscoreworld\');\n161.     });\n162. \n163.     it(\'should normalize the given functionName with a dash\', () => {\n164.       expect(sdk.naming.getNormalizedFunctionName(\'hello-world\')).to.equal(\'HelloDashworld\');\n165.     });\n166.   });\n167. \n168.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n169.     it(\'should extract everything after the last colon and dash\', () => {\n170.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n171.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n172.     });\n173.   });\n174. \n175.   describe(\'#extractLambdaNameFromArn()\', () => {\n176.     it(\'should extract everything after the last colon\', () => {\n177.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n178.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal(\'my-dev-lambda\');\n179.     });\n180.   });\n181. \n182.   describe(\'#getLambdaLogicalId()\', () => {\n183.     it(\'should normalize the function name and add the logical suffix\', () => {\n184.       expect(sdk.naming.getLambdaLogicalId(\'functionName\')).to.equal(\'FunctionNameLambdaFunction\');\n185.     });\n186.   });\n187. \n188.   describe(\'#getLambdaLogicalIdRegex()\', () => {\n189.     it(\'should match the suffix\', () => {\n190.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'LambdaFunction\')).to.equal(true);\n191.     });\n192. \n193.     it(\'should not match a name without the suffix\', () => {\n194.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'LambdaFunctionNotTheSuffix\')).to.equal(\n195.         false\n196.       );\n197.     });\n198. \n199.     it(\'should match a name with the suffix\', () => {\n200.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'AFunctionNameLambdaFunction\')).to.equal(\n201.         true\n202.       );\n203.     });\n204.   });\n205. \n206.   describe(\'#getWebsocketsApiName()\', () => {\n207.     it(\'should return the composition of stage & service name if custom name not provided\', () => {\n208.       serverless.service.service = \'myService\';\n209.       expect(sdk.naming.getWebsocketsApiName()).to.equal(\n210.         `${sdk.naming.provider.getStage()}-${serverless.service.service}-websockets`\n211.       );\n212.     });\n213. \n214.     it(\'should return the custom api name if provided\', () => {\n215.       serverless.service.provider.websocketsApiName = \'app-dev-websockets-testApi\';\n216.       serverless.service.service = \'myService\';\n217.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n218.       expect(sdk.naming.getWebsocketsApiName()).to.equal(\'app-dev-websockets-testApi\');\n219.     });\n220.   });\n221. \n222.   describe(\'#getWebsocketsApiLogicalId()\', () => {\n223.     it(\'should return the websocket API logical id\', () => {\n224.       expect(sdk.naming.getWebsocketsApiLogicalId()).to.equal(\'WebsocketsApi\');\n225.     });\n226.   });\n227. \n228.   describe(\'#getWebsocketsIntegrationLogicalId()\', () => {\n229.     it(\'should return the integrations logical id\', () => {\n230.       expect(sdk.naming.getWebsocketsIntegrationLogicalId(\'myFunc\')).to.equal(\n231.         \'MyFuncWebsocketsIntegration\'\n232.       );\n233.     });\n234.   });\n235. \n236.   describe(\'#getLambdaWebsocketsPermissionLogicalId()\', () => {\n237.     it(\'should return the lambda websocket permission logical id\', () => {\n238.       expect(sdk.naming.getLambdaWebsocketsPermissionLogicalId(\'myFunc\')).to.equal(\n239.         \'MyFuncLambdaPermissionWebsockets\'\n240.       );\n241.     });\n242.   });\n243. \n244.   describe(\'#getNormalizedWebsocketsRouteKey()\', () => {\n245.     it(\'should return a normalized version of the route key\', () => {\n246.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'$connect\')).to.equal(\'Sconnect\');\n247. \n248.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo/bar\')).to.equal(\'fooSlashbar\');\n249. \n250.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo-bar\')).to.equal(\'fooDashbar\');\n251. \n252.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo_bar\')).to.equal(\'fooUnderscorebar\');\n253. \n254.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo.bar\')).to.equal(\'fooPeriodbar\');\n255.     });\n256. \n257.     it(\'converts multiple `-` correctly\', () => {\n258.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'a-longer-path\')).to.equal(\n259.         \'aDashlongerDashpath\'\n260.       );\n261.     });\n262. \n263.     it(\'converts multiple `-` and `_` correctly\', () => {\n264.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'a-long_er-path_still\')).to.equal(\n265.         \'aDashlongUnderscoreerDashpathUnderscorestill\'\n266.       );\n267.     });\n268.   });\n269. \n270.   describe(\'#getWebsocketsRouteLogicalId()\', () => {\n271.     it(\'should return the websockets route logical id\', () => {\n272.       expect(sdk.naming.getWebsocketsRouteLogicalId(\'$connect\')).to.equal(\n273.         \'SconnectWebsocketsRoute\'\n274.       );\n275.     });\n276.   });\n277. \n278.   describe(\'#getWebsocketsDeploymentLogicalId()\', () => {\n279.     it(\'should return the websockets deployment logical id\', () => {\n280.       expect(sdk.naming.getWebsocketsDeploymentLogicalId(\'Abc+123=\')).to.equal(\n281.         \'WebsocketsDeploymentAbc123\'\n282.       );\n283.     });\n284.   });\n285. \n286.   describe(\'#getWebsocketsStageLogicalId()\', () => {\n287.     it(\'should return the websockets stage logical id\', () => {\n288.       expect(sdk.naming.getWebsocketsStageLogicalId()).to.equal(\'WebsocketsDeploymentStage\');\n289.     });\n290.   });\n291. \n292.   describe(\'#getWebsocketsAuthorizerLogicalId()\', () => {\n293.     it(\'should return the websockets authorizer logical id\', () => {\n294.       expect(sdk.naming.getWebsocketsAuthorizerLogicalId(\'auth\')).to.equal(\n295.         \'AuthWebsocketsAuthorizer\'\n296.       );\n297.     });\n298.   });\n299. \n300.   describe(\'#getWebsocketsLogGroupLogicalId()\', () => {\n301.     it(\'should return the Websockets log group logical id\', () => {\n302.       expect(sdk.naming.getWebsocketsLogGroupLogicalId()).to.equal(\'WebsocketsLogGroup\');\n303.     });\n304.   });\n305. \n306.   describe(\'#getApiGatewayName()\', () => {\n307.     it(\'should return the composition of stage & service name if custom name not provided\', () => {\n308.       serverless.service.service = \'myService\';\n309.       expect(sdk.naming.getApiGatewayName()).to.equal(\n310.         `${sdk.naming.provider.getStage()}-${serverless.service.service}`\n311.       );\n312.     });\n313. \n314.     it(\'should return the custom api name if provided\', () => {\n315.       serverless.service.provider.apiName = \'app-dev-testApi\';\n316.       serverless.service.service = \'myService\';\n317.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n318.       expect(sdk.naming.getApiGatewayName()).to.equal(\'app-dev-testApi\');\n319.     });\n320.   });\n321. \n322.   describe(\'#generateApiGatewayDeploymentLogicalId()\', () => {\n323.     it(\'should return ApiGatewayDeployment with a suffix\', () => {\n324.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId(1234)).to.equal(\n325.         \'ApiGatewayDeployment1234\'\n326.       );\n327.     });\n328.   });\n329. \n330.   describe(\'#getRestApiLogicalId()\', () => {\n331.     it(\'should return ApiGatewayRestApi\', () => {\n332.       expect(sdk.naming.getRestApiLogicalId()).to.equal(\'ApiGatewayRestApi\');\n333.     });\n334.   });\n335. \n336.   describe(\'#getNormalizedAuthorizerName()\', () => {\n337.     it(\'normalize the authorizer name\', () => {\n338.       expect(sdk.naming.getNormalizedAuthorizerName(\'authorizerName\')).to.equal(\'AuthorizerName\');\n339.     });\n340.   });\n341. \n342.   describe(\'#getAuthorizerLogicalId()\', () => {\n343.     it(\'should normalize the authorizer name and add the standard suffix\', () => {\n344.       expect(sdk.naming.getAuthorizerLogicalId(\'authorizerName\')).to.equal(\n345.         \'AuthorizerNameApiGatewayAuthorizer\'\n346.       );\n347.     });\n348.   });\n349. \n350.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n351.     it(\'should extract the authorizer name from an ARN\', () => {\n352.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n353.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n354.     });\n355.   });\n356. \n357.   describe(\'#normalizePath()\', () => {\n358.     it(\'should normalize each part of the resource path and remove non-alpha-numeric characters\', () => {\n359.       expect(sdk.naming.normalizePath(\'my/path/to/a-${var}-resource\')).to.equal(\n360.         \'MyPathToADashvarVarDashresource\'\n361.       );\n362.     });\n363.   });\n364. \n365.   describe(\'#getResourceLogicalId()\', () => {\n366.     it(\'should normalize the resource and add the standard suffix\', () => {\n367.       expect(sdk.naming.getResourceLogicalId(\'my/path/to/a-${var}-resource\')).to.equal(\n368.         \'ApiGatewayResourceMyPathToADashvarVarDashresource\'\n369.       );\n370.     });\n371.   });\n372. \n373.   describe(\'#extractResourceId()\', () => {\n374.     it(\'should extract the normalized resource name\', () => {\n375.       expect(\n376.         sdk.naming.extractResourceId(\'ApiGatewayResourceMyPathToADashvarVarDashResource\')\n377.       ).to.equal(\'MyPathToADashvarVarDashResource\');\n378.     });\n379.   });\n380. \n381.   describe(\'#normalizeMethodName()\', () => {\n382.     it(\'should capitalize the first letter and lowercase any other characters\', () => {\n383.       expect(sdk.naming.normalizeMethodName(\'gET\')).to.equal(\'Get\');\n384.     });\n385.   });\n386. \n387.   describe(\'#getMethodLogicalId()\', () => {\n388.     it(\'\', () => {\n389.       expect(sdk.naming.getMethodLogicalId(\'ResourceId\', \'get\')).to.equal(\n390.         \'ApiGatewayMethodResourceIdGet\'\n391.       );\n392.     });\n393.   });\n394. \n395.   describe(\'#getValidatorLogicalId()\', () => {\n396.     it(\'\', () => {\n397.       expect(sdk.naming.getValidatorLogicalId(\'ResourceId\', \'get\')).to.equal(\n398.         \'ApiGatewayMethodResourceIdGetValidator\'\n399.       );\n400.     });\n401.   });\n402. \n403.   describe(\'#getModelLogicalId()\', () => {\n404.     it(\'\', () => {\n405.       expect(sdk.naming.getModelLogicalId(\'ResourceId\', \'get\', \'application/json\')).to.equal(\n406.         \'ApiGatewayMethodResourceIdGetApplicationJsonModel\'\n407.       );\n408.     });\n409.   });\n410. \n411.   describe(\'#getApiKeyLogicalId(keyIndex)\', () => {\n412.     it(\'should produce the given index with ApiGatewayApiKey as a prefix\', () => {\n413.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal(\'ApiGatewayApiKey1\');\n414.     });\n415. \n416.     it(\'should support API Key names\', () => {\n417.       expect(sdk.naming.getApiKeyLogicalId(1, \'free\')).to.equal(\'ApiGatewayApiKeyFree1\');\n418.     });\n419.   });\n420. \n421.   describe(\'#getApiKeyLogicalIdRegex()\', () => {\n422.     it(\'should match the prefix\', () => {\n423.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'ApiGatewayApiKey\')).to.equal(true);\n424.     });\n425. \n426.     it(\'should not match a name without the prefix\', () => {\n427.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'NotThePrefixApiGatewayApiKey\')).to.equal(\n428.         false\n429.       );\n430.     });\n431. \n432.     it(\'should match a name with the prefix\', () => {\n433.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'ApiGatewayApiKeySuffix\')).to.equal(true);\n434.     });\n435.   });\n436. \n437.   describe(\'#getUsagePlanLogicalId()\', () => {\n438.     it(\'should return the default ApiGateway usage plan logical id\', () => {\n439.       expect(sdk.naming.getUsagePlanLogicalId()).to.equal(\'ApiGatewayUsagePlan\');\n440.     });\n441. \n442.     it(\'should return the named ApiGateway usage plan logical id\', () => {\n443.       expect(sdk.naming.getUsagePlanLogicalId(\'free\')).to.equal(\'ApiGatewayUsagePlanFree\');\n444.     });\n445.   });\n446. \n447.   describe(\'#getUsagePlanKeyLogicalId()\', () => {\n448.     it(\'should produce the given index with ApiGatewayUsagePlanKey as a prefix\', () => {\n449.       expect(sdk.naming.getUsagePlanKeyLogicalId(1)).to.equal(\'ApiGatewayUsagePlanKey1\');\n450.     });\n451. \n452.     it(\'should support API Key names\', () => {\n453.       expect(sdk.naming.getUsagePlanKeyLogicalId(1, \'free\')).to.equal(\n454.         \'ApiGatewayUsagePlanKeyFree1\'\n455.       );\n456.     });\n457.   });\n458. \n459.   describe(\'#getStageLogicalId()\', () => {\n460.     it(\'should return the API Gateway stage logical id\', () => {\n461.       expect(sdk.naming.getStageLogicalId()).to.equal(\'ApiGatewayStage\');\n462.     });\n463.   });\n464. \n465.   describe(\'#getApiGatewayLogGroupLogicalId()\', () => {\n466.     it(\'should return the API Gateway log group logical id\', () => {\n467.       expect(sdk.naming.getApiGatewayLogGroupLogicalId()).to.equal(\'ApiGatewayLogGroup\');\n468.     });\n469.   });\n470. \n471.   describe(\'#getDeploymentBucketLogicalId()\', () => {\n472.     it(\'should return "ServerlessDeploymentBucket"\', () => {\n473.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal(\'ServerlessDeploymentBucket\');\n474.     });\n475.   });\n476. \n477.   describe(\'#getDeploymentBucketOutputLogicalId()\', () => {\n478.     it(\'should return "ServerlessDeploymentBucketName"\', () => {\n479.       expect(sdk.naming.getDeploymentBucketOutputLogicalId()).to.equal(\n480.         \'ServerlessDeploymentBucketName\'\n481.       );\n482.     });\n483.   });\n484. \n485.   describe(\'#getDeploymentBucketPolicyLogicalId()\', () => {\n486.     it(\'should return "ServerlessDeploymentBucketPolicy"\', () => {\n487.       expect(sdk.naming.getDeploymentBucketPolicyLogicalId()).to.equal(\n488.         \'ServerlessDeploymentBucketPolicy\'\n489.       );\n490.     });\n491.   });\n492. \n493.   describe(\'#normalizeBucketName()\', () => {\n494.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n495.       expect(sdk.naming.normalizeBucketName(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'BucketName\');\n496.     });\n497.   });\n498. \n499.   describe(\'#getBucketLogicalId()\', () => {\n500.     it(\'should normalize the bucket name and add the standard prefix\', () => {\n501.       expect(sdk.naming.getBucketLogicalId(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'S3BucketBucketName\');\n502.     });\n503.   });\n504. \n505.   describe(\'#normalizeTopicName()\', () => {\n506.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n507.       expect(sdk.naming.normalizeTopicName(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'TopicName\');\n508.     });\n509.   });\n510. \n511.   describe(\'#getTopicLogicalId()\', () => {\n512.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n513.       expect(sdk.naming.getTopicLogicalId(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'SNSTopicTopicName\');\n514.     });\n515.   });\n516. \n517.   describe(\'#getScheduleId()\', () => {\n518.     it(\'should add the standard suffix\', () => {\n519.       expect(sdk.naming.getScheduleId(\'functionName\')).to.equal(\'functionNameSchedule\');\n520.     });\n521.   });\n522. \n523.   describe(\'#getScheduleLogicalId()\', () => {\n524.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n525.       expect(sdk.naming.getScheduleLogicalId(\'functionName\', 0)).to.equal(\n526.         \'FunctionNameEventsRuleSchedule0\'\n527.       );\n528.     });\n529.   });\n530. \n531.   describe(\'#getStreamConsumerName()\', () => {\n532.     it(\'should add the standard suffix\', () => {\n533.       expect(sdk.naming.getStreamConsumerName(\'functionName\', \'streamName\')).to.equal(\n534.         \'functionNamestreamNameConsumer\'\n535.       );\n536.     });\n537.   });\n538. \n539.   describe(\'#getStreamConsumerLogicalId()\', () => {\n540.     it(\'should normalize the stream consumer name and add the standard suffix\', () => {\n541.       expect(sdk.naming.getStreamConsumerLogicalId(\'streamConsumerName\')).to.equal(\n542.         \'StreamConsumerNameStreamConsumer\'\n543.       );\n544.     });\n545.   });\n546. \n547.   describe(\'#getCloudWatchEventId()\', () => {\n548.     it(\'should add the standard suffix\', () => {\n549.       expect(sdk.naming.getCloudWatchEventId(\'functionName\')).to.equal(\n550.         \'functionNameCloudWatchEvent\'\n551.       );\n552.     });\n553.   });\n554. \n555.   describe(\'#getCloudWatchEventLogicalId()\', () => {\n556.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n557.       expect(sdk.naming.getCloudWatchEventLogicalId(\'functionName\', 0)).to.equal(\n558.         \'FunctionNameEventsRuleCloudWatchEvent0\'\n559.       );\n560.     });\n561.   });\n562. \n563.   describe(\'#getCloudWatchLogLogicalId()\', () => {\n564.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n565.       expect(sdk.naming.getCloudWatchLogLogicalId(\'functionName\', 0)).to.equal(\n566.         \'FunctionNameLogsSubscriptionFilterCloudWatchLog0\'\n567.       );\n568.     });\n569.   });\n570. \n571.   describe(\'#getCognitoUserPoolLogicalId()\', () => {\n572.     it(\'should normalize the user pool name and add the standard prefix\', () => {\n573.       expect(sdk.naming.getCognitoUserPoolLogicalId(\'us-east-1_v123sDAS1\')).to.equal(\n574.         \'CognitoUserPoolUseast1v123sDAS1\'\n575.       );\n576.     });\n577.   });\n578. \n579.   describe(\'#getLambdaS3PermissionLogicalId()\', () => {\n580.     it(\'should normalize the function name and add the standard suffix\', () => {\n581.       expect(sdk.naming.getLambdaS3PermissionLogicalId(\'functionName\', \'bucket\')).to.equal(\n582.         \'FunctionNameLambdaPermissionBucketS3\'\n583.       );\n584.     });\n585.   });\n586. \n587.   describe(\'#getLambdaSnsPermissionLogicalId()\', () => {\n588.     it(\n589.       \'should normalize the function and topic names and add them as prefix and suffix to the \' +\n590.         \'standard permission center\',\n591.       () => {\n592.         expect(sdk.naming.getLambdaSnsPermissionLogicalId(\'functionName\', \'topic\')).to.equal(\n593.           \'FunctionNameLambdaPermissionTopicSNS\'\n594.         );\n595.       }\n596.     );\n597.   });\n598. \n599.   describe(\'#getLambdaSchedulePermissionLogicalId()\', () => {\n600.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n601.       expect(sdk.naming.getLambdaSchedulePermissionLogicalId(\'functionName\', 0)).to.equal(\n602.         \'FunctionNameLambdaPermissionEventsRuleSchedule0\'\n603.       );\n604.     });\n605.   });\n606. \n607.   describe(\'#getLambdaCloudWatchEventPermissionLogicalId()\', () => {\n608.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n609.       expect(sdk.naming.getLambdaCloudWatchEventPermissionLogicalId(\'functionName\', 0)).to.equal(\n610.         \'FunctionNameLambdaPermissionEventsRuleCloudWatchEvent0\'\n611.       );\n612.     });\n613.   });\n614. \n615.   describe(\'#getLambdaApiGatewayPermissionLogicalId()\', () => {\n616.     it(\'should normalize the function name and append the standard suffix\', () => {\n617.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId(\'functionName\')).to.equal(\n618.         \'FunctionNameLambdaPermissionApiGateway\'\n619.       );\n620.     });\n621.   });\n622. \n623.   describe(\'#getIotLogicalId()\', () => {\n624.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n625.       expect(sdk.naming.getIotLogicalId(\'functionName\', 0)).to.equal(\'FunctionNameIotTopicRule0\');\n626.     });\n627.   });\n628. \n629.   describe(\'#getLambdaIotPermissionLogicalId()\', () => {\n630.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n631.       expect(sdk.naming.getLambdaIotPermissionLogicalId(\'functionName\', 0)).to.equal(\n632.         \'FunctionNameLambdaPermissionIotTopicRule0\'\n633.       );\n634.     });\n635.   });\n636. \n637.   describe(\'#getLambdaAlexaSkillPermissionLogicalId()\', () => {\n638.     it(\'should normalize the function name and append the standard suffix\', () => {\n639.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\', 2)).to.equal(\n640.         \'FunctionNameLambdaPermissionAlexaSkill2\'\n641.       );\n642.     });\n643. \n644.     it(\'should normalize the function name and append a default suffix if not defined\', () => {\n645.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\')).to.equal(\n646.         \'FunctionNameLambdaPermissionAlexaSkill0\'\n647.       );\n648.     });\n649.   });\n650. \n651.   describe(\'#getLambdaAlexaSmartHomePermissionLogicalId()\', () => {\n652.     it(\'should normalize the function name and append the standard suffix\', () => {\n653.       expect(sdk.naming.getLambdaAlexaSmartHomePermissionLogicalId(\'functionName\', 0)).to.equal(\n654.         \'FunctionNameLambdaPermissionAlexaSmartHome0\'\n655.       );\n656.     });\n657.   });\n658. \n659.   describe(\'#getLambdaSnsSubscriptionLogicalId()\', () => {\n660.     it(\'should normalize the function name and append the standard suffix\', () => {\n661.       expect(sdk.naming.getLambdaSnsSubscriptionLogicalId(\'functionName\', \'topicName\')).to.equal(\n662.         \'FunctionNameSnsSubscriptionTopicName\'\n663.       );\n664.     });\n665.   });\n666. \n667.   describe(\'#getLambdaCloudWatchLogPermissionLogicalId()\', () => {\n668.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n669.       expect(sdk.naming.getLambdaCloudWatchLogPermissionLogicalId(\'functionName\')).to.equal(\n670.         \'FunctionNameLambdaPermissionLogsSubscriptionFilterCloudWatchLog\'\n671.       );\n672.     });\n673.   });\n674. \n675.   describe(\'#getLambdaCognitoUserPoolPermissionLogicalId()\', () => {\n676.     it(\'should normalize the function name and add the standard suffix\', () => {\n677.       expect(\n678.         sdk.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n679.           \'functionName\',\n680.           \'Pool1\',\n681.           \'CustomMessage\'\n682.         )\n683.       ).to.equal(\'FunctionNameLambdaPermissionCognitoUserPoolPool1TriggerSourceCustomMessage\');\n684.     });\n685. \n686.     describe(\'#getLambdaAlbPermissionLogicalId()\', () => {\n687.       it(\'should normalize the function name\', () => {\n688.         expect(sdk.naming.getLambdaAlbPermissionLogicalId(\'functionName\')).to.equal(\n689.           \'FunctionNameLambdaPermissionAlb\'\n690.         );\n691.       });\n692.     });\n693. \n694.     describe(\'#getLambdaRegisterTargetPermissionLogicalId()\', () => {\n695.       it(\'should normalize the function name and add the correct suffix\', () => {\n696.         expect(sdk.naming.getLambdaRegisterTargetPermissionLogicalId(\'functionName\')).to.equal(\n697.           \'FunctionNameLambdaPermissionRegisterTarget\'\n698.         );\n699.       });\n700.     });\n701.   });\n702. \n703.   describe(\'#getQueueLogicalId()\', () => {\n704.     it(\'should normalize the function name and add the standard suffix\', () => {\n705.       expect(sdk.naming.getQueueLogicalId(\'functionName\', \'MyQueue\')).to.equal(\n706.         \'FunctionNameEventSourceMappingSQSMyQueue\'\n707.       );\n708.     });\n709.   });\n710. \n711.   describe(\'#getAlbTargetGroupLogicalId()\', () => {\n712.     it(\'should normalize the function name\', () => {\n713.       expect(sdk.naming.getAlbTargetGroupLogicalId(\'functionName\', \'abc123\')).to.equal(\n714.         \'FunctionNameAlbTargetGroupabc123\'\n715.       );\n716.     });\n717. \n718.     it(\'should normalize the function name and add MultiValue prefix if multiValueHeader is true\', () => {\n719.       expect(sdk.naming.getAlbTargetGroupLogicalId(\'functionName\', \'abc123\', true)).to.equal(\n720.         \'FunctionNameAlbMultiValueTargetGroupabc123\'\n721.       );\n722.     });\n723.   });\n724. \n725.   describe(\'#getAlbListenerRuleLogicalId()\', () => {\n726.     it(\'should normalize the function name and add an index\', () => {\n727.       expect(sdk.naming.getAlbListenerRuleLogicalId(\'functionName\', 0)).to.equal(\n728.         \'FunctionNameAlbListenerRule0\'\n729.       );\n730.     });\n731.   });\n732. \n733.   describe(\'#getAlbTargetGroupName()\', () => {\n734.     it(\'should return a unique identifier based on the service name, function name, alb id, multi-value attribute and stage\', () => {\n735.       serverless.service.service = \'myService\';\n736.       expect(sdk.naming.getAlbTargetGroupName(\'functionName\', \'abc123\', true)).to.equal(\n737.         \'79039bd239ac0b3f6ff6d9296f23e27c\'\n738.       );\n739.     });\n740. \n741.     it(\'should return a prefixed unique identifer of not longer than 32 characters if alb.targetGroupPrefix is set\', () => {\n742.       serverless.service.service = \'myService\';\n743.       serverless.service.provider.alb = {};\n744.       serverless.service.provider.alb.targetGroupPrefix = \'myPrefix-\';\n745.       expect(sdk.naming.getAlbTargetGroupName(\'functionName\', \'abc123\', true)).to.equal(\n746.         \'myPrefix-79039bd239ac0b3f6ff6d92\'\n747.       );\n748.     });\n749.   });\n750. \n751.   describe(\'#getAlbTargetGroupNameTagValue()\', () => {\n752.     it(\'should return the composition of service name, function name, alb id, multi-value attribute and stage\', () => {\n753.       serverless.service.service = \'myService\';\n754.       expect(sdk.naming.getAlbTargetGroupNameTagValue(\'functionName\', \'abc123\', true)).to.equal(\n755.         `${\n756.           serverless.service.service\n757.         }-functionName-abc123-multi-value-${sdk.naming.provider.getStage()}`\n758.       );\n759.     });\n760.   });\n761. \n762.   describe(\'#getCustomResourcesArtifactName()\', () => {\n763.     it(\'should return the custom resources artifact directory name\', () => {\n764.       expect(sdk.naming.getCustomResourcesArtifactName()).to.equal(\'custom-resources.zip\');\n765.     });\n766.   });\n767. \n768.   describe(\'#getCustomResourcesRoleLogicalId()\', () => {\n769.     it(\'should return the custom resources role logical id\', () => {\n770.       expect(sdk.naming.getCustomResourcesRoleLogicalId()).to.equal(\n771.         \'IamRoleCustomResourcesLambdaExecution\'\n772.       );\n773.     });\n774.   });\n775. \n776.   describe(\'#getCustomResourceS3HandlerFunctionName()\', () => {\n777.     it(\'should return the name of the S3 custom resource handler function\', () => {\n778.       expect(sdk.naming.getCustomResourceS3HandlerFunctionName()).to.equal(\n779.         \'custom-resource-existing-s3\'\n780.       );\n781.     });\n782.   });\n783. \n784.   describe(\'#getCustomResourceS3HandlerFunctionLogicalId()\', () => {\n785.     it(\'should return the logical id of the S3 custom resource handler function\', () => {\n786.       expect(sdk.naming.getCustomResourceS3HandlerFunctionLogicalId()).to.equal(\n787.         \'CustomDashresourceDashexistingDashs3LambdaFunction\'\n788.       );\n789.     });\n790.   });\n791. \n792.   describe(\'#getCustomResourceS3ResourceLogicalId()\', () => {\n793.     it(\'should return the logical id of the S3 custom resource\', () => {\n794.       const functionName = \'my-function\';\n795.       expect(sdk.naming.getCustomResourceS3ResourceLogicalId(functionName)).to.equal(\n796.         \'MyDashfunctionCustomS31\'\n797.       );\n798.     });\n799.   });\n800. \n801.   describe(\'#getCustomResourceCognitoUserPoolHandlerFunctionName()\', () => {\n802.     it(\'should return the name of the Cognito User Pool custom resource handler function\', () => {\n803.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionName()).to.equal(\n804.         \'custom-resource-existing-cup\'\n805.       );\n806.     });\n807.   });\n808. \n809.   describe(\'#getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()\', () => {\n810.     it(\'should return the logical id of the Cognito User Pool custom resource handler function\', () => {\n811.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()).to.equal(\n812.         \'CustomDashresourceDashexistingDashcupLambdaFunction\'\n813.       );\n814.     });\n815.   });\n816. \n817.   describe(\'#getCustomResourceCognitoUserPoolResourceLogicalId()\', () => {\n818.     it(\'should return the logical id of the Cognito User Pool custom resource\', () => {\n819.       const functionName = \'my-function\';\n820.       expect(sdk.naming.getCustomResourceCognitoUserPoolResourceLogicalId(functionName)).to.equal(\n821.         \'MyDashfunctionCustomCognitoUserPool1\'\n822.       );\n823.     });\n824.   });\n825. \n826.   describe(\'#getCustomResourceEventBridgeHandlerFunctionName()\', () => {\n827.     it(\'should return the name of the Event Bridge custom resource handler function\', () => {\n828.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionName()).to.equal(\n829.         \'custom-resource-event-bridge\'\n830.       );\n831.     });\n832.   });\n833. \n834.   describe(\'#getCustomResourceEventBridgeHandlerFunctionLogicalId()\', () => {\n835.     it(\'should return the logical id of the Event Bridge custom resource handler function\', () => {\n836.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId()).to.equal(\n837.         \'CustomDashresourceDasheventDashbridgeLambdaFunction\'\n838.       );\n839.     });\n840.   });\n841. \n842.   describe(\'#getCustomResourceEventBridgeResourceLogicalId()\', () => {\n843.     it(\'should return the logical id of the Event Bridge custom resource\', () => {\n844.       const functionName = \'my-function\';\n845.       const index = 1;\n846.       expect(\n847.         sdk.naming.getCustomResourceEventBridgeResourceLogicalId(functionName, index)\n848.       ).to.equal(\'MyDashfunctionCustomEventBridge1\');\n849.     });\n850.   });\n851. \n852.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()\', () => {\n853.     it(\'should return the name of the APIGW Account CloudWatch role custom resource handler function\', () => {\n854.       expect(\n855.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()\n856.       ).to.equal(\'custom-resource-apigw-cw-role\');\n857.     });\n858.   });\n859. \n860.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()\', () => {\n861.     it(\'should return the logical id of the APIGW Account CloudWatch role custom resource handler function\', () => {\n862.       expect(\n863.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()\n864.       ).to.equal(\'CustomDashresourceDashapigwDashcwDashroleLambdaFunction\');\n865.     });\n866.   });\n867. \n868.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()\', () => {\n869.     it(\'should return the logical id of the APIGW Account CloudWatch role custom resource\', () => {\n870.       expect(\n871.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()\n872.       ).to.equal(\'CustomApiGatewayAccountCloudWatchRole\');\n873.     });\n874.   });\n875. \n876.   describe(\'#getCloudFrontDistributionLogicalId()\', () => {\n877.     it(\'should return CloudFront distribution logical id\', () => {\n878.       expect(sdk.naming.getCloudFrontDistributionLogicalId()).to.equal(\'CloudFrontDistribution\');\n879.     });\n880.   });\n881. \n882.   describe(\'#getCloudFrontDistributionDomainNameLogicalId()\', () => {\n883.     it(\'should return CloudFront distribution domain name logical id\', () => {\n884.       expect(sdk.naming.getCloudFrontDistributionDomainNameLogicalId()).to.equal(\n885.         \'CloudFrontDistributionDomainName\'\n886.       );\n887.     });\n888.   });\n889. \n890.   describe(\'#getLambdaAtEdgeInvokePermissionLogicalId()\', () => {\n891.     it(\'should return lambda@edge invoke permission logical id\', () => {\n892.       expect(sdk.naming.getLambdaAtEdgeInvokePermissionLogicalId(\'functionName\')).to.equal(\n893.         \'FunctionNameLambdaFunctionInvokePermission\'\n894.       );\n895.     });\n896.   });\n897. \n898.   describe(\'#getCloudFrontOriginId()\', () => {\n899.     it(\'should return CloudFront origin id for s3 origin\', () => {\n900.       expect(\n901.         sdk.naming.getCloudFrontOriginId({\n902.           S3OriginConfig: {},\n903.           DomainName: \'domain.name\',\n904.           OriginPath: \'/path\',\n905.         })\n906.       ).to.equal(\'s3/domain.name/path\');\n907.     });\n908. \n909.     it(\'should return CloudFront origin id for custom origin\', () => {\n910.       expect(\n911.         sdk.naming.getCloudFrontOriginId({\n912.           CustomOriginConfig: {},\n913.           DomainName: \'domain.name\',\n914.           OriginPath: \'/path\',\n915.         })\n916.       ).to.equal(\'custom/domain.name/path\');\n917.     });\n918. \n919.     it(\'should return CloudFront origin id from domain as a object\', () => {\n920.       expect(\n921.         sdk.naming.getCloudFrontOriginId({\n922.           CustomOriginConfig: {},\n923.           DomainName: {\n924.             \'Fn::Join\': [\'\', [\'Ref: ApiGatewayRestApi\', \'.execute-api.\']],\n925.           },\n926.         })\n927.       ).to.equal(\'custom/FnJoinRefApiGatewayRestApiexecuteapi\');\n928.     });\n929.   });\n930. });', start_line_number=1, end_line_number=930), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. ", start_line_number=1, end_line_number=7), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });", start_line_number=42, end_line_number=88), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });", start_line_number=90, end_line_number=149), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });", start_line_number=151, end_line_number=183), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });", start_line_number=217, end_line_number=247), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });", start_line_number=249, end_line_number=277), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });", start_line_number=279, end_line_number=310), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });", start_line_number=562, end_line_number=598), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });", start_line_number=600, end_line_number=653), Context(relative_path='lib/plugins/aws/package/compile/events/sqs/index.test.js', content="399.       it('should allow specifying SQS Queues as CFN reference types', () => {\n400.         awsCompileSQSEvents.serverless.service.functions = {\n401.           first: {\n402.             events: [\n403.               {\n404.                 sqs: {\n405.                   arn: { 'Fn::GetAtt': ['SomeQueue', 'Arn'] },\n406.                 },\n407.               },\n408.               {\n409.                 sqs: {\n410.                   arn: { 'Fn::ImportValue': 'ForeignQueue' },\n411.                 },\n412.               },\n413.               {\n414.                 sqs: {\n415.                   arn: {\n416.                     'Fn::Join': [\n417.                       ':',\n418.                       [\n419.                         'arn',\n420.                         'aws',\n421.                         'sqs',\n422.                         {\n423.                           Ref: 'AWS::Region',\n424.                         },\n425.                         {\n426.                           Ref: 'AWS::AccountId',\n427.                         },\n428.                         'MyQueue',\n429.                       ],\n430.                     ],\n431.                   },\n432.                 },\n433.               },\n434.             ],\n435.           },\n436.         };\n437. \n438.         awsCompileSQSEvents.compileSQSEvents();\n439. \n440.         expect(\n441.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n442.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement[0]\n443.         ).to.deep.equal({\n444.           Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],\n445.           Effect: 'Allow',\n446.           Resource: [\n447.             {\n448.               'Fn::GetAtt': ['SomeQueue', 'Arn'],\n449.             },\n450.             {\n451.               'Fn::ImportValue': 'ForeignQueue',\n452.             },\n453.             {\n454.               'Fn::Join': [\n455.                 ':',\n456.                 [\n457.                   'arn',\n458.                   'aws',\n459.                   'sqs',\n460.                   {\n461.                     Ref: 'AWS::Region',\n462.                   },\n463.                   {\n464.                     Ref: 'AWS::AccountId',\n465.                   },\n466.                   'MyQueue',\n467.                 ],\n468.               ],\n469.             },\n470.           ],\n471.         });\n472.         expect(\n473.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n474.             .FirstEventSourceMappingSQSSomeQueue.Properties.EventSourceArn\n475.         ).to.deep.equal({ 'Fn::GetAtt': ['SomeQueue', 'Arn'] });\n476.         expect(\n477.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n478.             .FirstEventSourceMappingSQSForeignQueue.Properties.EventSourceArn\n479.         ).to.deep.equal({ 'Fn::ImportValue': 'ForeignQueue' });\n480.         expect(\n481.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n482.             .FirstEventSourceMappingSQSMyQueue.Properties.EventSourceArn\n483.         ).to.deep.equal({\n484.           'Fn::Join': [\n485.             ':',\n486.             [\n487.               'arn',\n488.               'aws',\n489.               'sqs',\n490.               {\n491.                 Ref: 'AWS::Region',\n492.               },\n493.               {\n494.                 Ref: 'AWS::AccountId',\n495.               },\n496.               'MyQueue',\n497.             ],\n498.           ],\n499.         });\n500.       });", start_line_number=399, end_line_number=500), Context(relative_path='lib/plugins/aws/package/compile/events/sqs/index.test.js', content="521.       it('should add the necessary IAM role statements', () => {\n522.         awsCompileSQSEvents.serverless.service.functions = {\n523.           first: {\n524.             events: [\n525.               {\n526.                 sqs: 'arn:aws:sqs:region:account:MyFirstQueue',\n527.               },\n528.               {\n529.                 sqs: 'arn:aws:sqs:region:account:MySecondQueue',\n530.               },\n531.             ],\n532.           },\n533.         };\n534. \n535.         const iamRoleStatements = [\n536.           {\n537.             Effect: 'Allow',\n538.             Action: ['sqs:ReceiveMessage', 'sqs:DeleteMessage', 'sqs:GetQueueAttributes'],\n539.             Resource: [\n540.               'arn:aws:sqs:region:account:MyFirstQueue',\n541.               'arn:aws:sqs:region:account:MySecondQueue',\n542.             ],\n543.           },\n544.         ];\n545. \n546.         awsCompileSQSEvents.compileSQSEvents();\n547. \n548.         expect(\n549.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n550.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement\n551.         ).to.deep.equal(iamRoleStatements);\n552.       });", start_line_number=521, end_line_number=552), Context(relative_path='lib/plugins/aws/package/index.test.js', content='1. \'use strict\';\n2. \n3. const AwsProvider = require(\'../provider/awsProvider\');\n4. const AwsPackage = require(\'./index\');\n5. const Serverless = require(\'../../../Serverless\');\n6. const CLI = require(\'../../../classes/CLI\');\n7. const expect = require(\'chai\').expect;\n8. const sinon = require(\'sinon\');\n9. const path = require(\'path\');\n10. \n11. describe(\'AwsPackage\', () => {\n12.   let awsPackage;\n13.   let serverless;\n14.   let options;\n15. \n16.   beforeEach(() => {\n17.     serverless = new Serverless();\n18.     options = {\n19.       stage: \'dev\',\n20.       region: \'us-east-1\',\n21.     };\n22.     serverless.setProvider(\'aws\', new AwsProvider(serverless, options));\n23.     serverless.config.servicePath = \'foo\';\n24.     serverless.cli = new CLI(serverless);\n25.     awsPackage = new AwsPackage(serverless, options);\n26.   });\n27. \n28.   describe(\'#constructor()\', () => {\n29.     it(\'should set the serverless instance\', () => {\n30.       expect(awsPackage.serverless).to.equal(serverless);\n31.     });\n32. \n33.     it(\'should set options\', () => {\n34.       expect(awsPackage.options).to.equal(options);\n35.     });\n36. \n37.     it(\'should set the service path if provided\', () => {\n38.       expect(awsPackage.servicePath).to.equal(\'foo\');\n39.     });\n40. \n41.     it(\'should default to an empty service path if not provided\', () => {\n42.       serverless.config.servicePath = false;\n43.       awsPackage = new AwsPackage(serverless, options);\n44. \n45.       expect(awsPackage.servicePath).to.equal(\'\');\n46.     });\n47. \n48.     it(\'should use the options package path if provided\', () => {\n49.       options.package = \'package-options\';\n50.       awsPackage = new AwsPackage(serverless, options);\n51. \n52.       expect(awsPackage.packagePath).to.equal(\'package-options\');\n53.     });\n54. \n55.     it(\'should use the services package path if provided\', () => {\n56.       serverless.service = {\n57.         package: {\n58.           path: \'package-service\',\n59.         },\n60.       };\n61.       awsPackage = new AwsPackage(serverless, options);\n62. \n63.       expect(awsPackage.packagePath).to.equal(\'package-service\');\n64.     });\n65. \n66.     it(\'should default to the .serverless directory as the package path\', () => {\n67.       expect(awsPackage.packagePath).to.equal(path.join(\'foo\', \'.serverless\'));\n68.     });\n69. \n70.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));\n72. \n73.     it(\'should have commands\', () => expect(awsPackage.commands).to.be.not.empty);\n74. \n75.     it(\'should have hooks\', () => expect(awsPackage.hooks).to.be.not.empty);\n76.   });\n77. \n78.   describe(\'hooks\', () => {\n79.     let spawnStub;\n80.     let generateCoreTemplateStub;\n81.     let mergeIamTemplatesStub;\n82.     let generateArtifactDirectoryNameStub;\n83.     let mergeCustomProviderResourcesStub;\n84.     let saveCompiledTemplateStub;\n85.     let saveServiceStateStub;\n86. \n87.     beforeEach(() => {\n88.       spawnStub = sinon.stub(serverless.pluginManager, \'spawn\');\n89.       generateCoreTemplateStub = sinon.stub(awsPackage, \'generateCoreTemplate\').resolves();\n90.       mergeIamTemplatesStub = sinon.stub(awsPackage, \'mergeIamTemplates\').resolves();\n91.       generateArtifactDirectoryNameStub = sinon\n92.         .stub(awsPackage, \'generateArtifactDirectoryName\')\n93.         .resolves();\n94.       mergeCustomProviderResourcesStub = sinon\n95.         .stub(awsPackage, \'mergeCustomProviderResources\')\n96.         .resolves();\n97.       saveCompiledTemplateStub = sinon.stub(awsPackage, \'saveCompiledTemplate\').resolves();\n98.       saveServiceStateStub = sinon.stub(awsPackage, \'saveServiceState\').resolves();\n99.     });\n100. \n101.     afterEach(() => {\n102.       serverless.pluginManager.spawn.restore();\n103.       awsPackage.generateCoreTemplate.restore();\n104.       awsPackage.mergeIamTemplates.restore();\n105.       awsPackage.generateArtifactDirectoryName.restore();\n106.       awsPackage.mergeCustomProviderResources.restore();\n107.       awsPackage.saveCompiledTemplate.restore();\n108.       awsPackage.saveServiceState.restore();\n109.     });\n110. \n111.     it(\'should run "package:cleanup" hook\', () => {\n112.       const spawnAwsCommonValidateStub = spawnStub.withArgs(\'aws:common:validate\').resolves();\n113.       const spawnAwsCommonCleanupTempDirStub = spawnStub\n114.         .withArgs(\'aws:common:cleanupTempDir\')\n115.         .resolves();\n116. \n117.       return awsPackage.hooks[\'package:cleanup\']().then(() => {\n118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);\n119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(\n120.           true\n121.         );\n122.       });\n123.     });\n124. \n125.     it(\'should run "package:initialize" hook\', () =>\n126.       awsPackage.hooks[\'package:initialize\']().then(() => {\n127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);\n128.       }));\n129. \n130.     it(\'should run "package:setupProviderConfiguration" hook\', () =>\n131.       awsPackage.hooks[\'package:setupProviderConfiguration\']().then(() => {\n132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);\n133.       }));\n134. \n135.     it(\'should run "before:package:compileFunctions" hook\', () =>\n136.       awsPackage.hooks[\'before:package:compileFunctions\']().then(() => {\n137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);\n138.       }));\n139. \n140.     it(\'should run "package:finalize" hook\', () => {\n141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs(\'aws:package:finalize\').resolves();\n142. \n143.       return awsPackage.hooks[\'package:finalize\']().then(() => {\n144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);\n145.       });\n146.     });\n147. \n148.     it(\'should run "aws:package:finalize:mergeCustomProviderResources" hook\', () =>\n149.       awsPackage.hooks[\'aws:package:finalize:mergeCustomProviderResources\']().then(() => {\n150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);\n151.       }));\n152. \n153.     it(\'should run "aws:package:finalize:saveServiceState" hook\', () => {\n154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub\n155.         .withArgs(\'aws:common:moveArtifactsToPackage\')\n156.         .resolves();\n157. \n158.       return awsPackage.hooks[\'aws:package:finalize:saveServiceState\']().then(() => {\n159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);\n160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);\n161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(\n162.           true\n163.         );\n164.       });\n165.     });\n166.   });\n167. });', start_line_number=1, end_line_number=167), Context(relative_path='tests/integration-all/sns/tests.js', content="1. 'use strict';\n2. \n3. const path = require('path');\n4. const BbPromise = require('bluebird');\n5. const { expect } = require('chai');\n6. \n7. const { getTmpDirPath } = require('../../utils/fs');\n8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require('../../utils/sns');\n9. const {\n10.   createTestService,\n11.   deployService,\n12.   removeService,\n13.   waitForFunctionLogs,\n14. } = require('../../utils/integration');\n15. const { getMarkers } = require('../shared/utils');\n16. ", start_line_number=1, end_line_number=16), Context(relative_path='tests/integration-all/sns/tests.js', content='27.   before(async () => {\n28.     tmpDirPath = getTmpDirPath();\n29.     console.info(`Temporary path: ${tmpDirPath}`);\n30.     const serverlessConfig = await createTestService(tmpDirPath, {\n31.       templateDir: path.join(__dirname, \'service\'),\n32.       filesToAdd: [path.join(__dirname, \'..\', \'shared\')],\n33.       serverlessConfigHook:\n34.         // Ensure unique topics (to avoid collision among concurrent CI runs)\n35.         config => {\n36.           minimalTopicName = `${config.service}-minimal`;\n37.           filteredTopicName = `${config.service}-filtered`;\n38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;\n39.           existingTopicName = `${config.service}-existing`;\n40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;\n41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;\n42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;\n43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;\n44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;\n45.           config.functions.snsExisting.events[0].sns.arn[\'Fn::Join\'][1][3] = existingTopicName;\n46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;\n47.         },\n48.     });\n49.     serviceName = serverlessConfig.service;\n50.     stackName = `${serviceName}-${stage}`;\n51.     // create "existing" SNS topics\n52.     // NOTE: deployment can only be done once the SNS topics are created\n53.     console.info(`Creating SNS topic "${existingTopicName}"...`);\n54.     return createSnsTopic(existingTopicName).then(() => {\n55.       console.info(`Deploying "${stackName}" service...`);\n56.       return deployService(tmpDirPath);\n57.     });\n58.   });', start_line_number=27, end_line_number=58), Context(relative_path='tests/integration-all/sns/tests.js', content="67.   describe('Minimal Setup', () => {\n68.     it('should invoke on a topic message', () => {\n69.       const functionName = 'snsMinimal';\n70.       const markers = getMarkers(functionName);\n71.       const message = 'Hello from SNS!';\n72. \n73.       return publishSnsMessage(minimalTopicName, message)\n74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n75.         .then(logs => {\n76.           expect(logs).to.include(functionName);\n77.           expect(logs).to.include(message);\n78.         });\n79.     });\n80.   });", start_line_number=67, end_line_number=80), Context(relative_path='tests/integration-all/sns/tests.js', content='82.   describe(\'Multiple and Filtered Setup\', () => {\n83.     it(\'should invoke on a topic message that matches filter\', () => {\n84.       const leftFunctionName = \'snsMultipleFilteredLeft\';\n85.       const leftMarkers = getMarkers(leftFunctionName);\n86.       const rightFunctionName = \'snsMultipleFilteredRight\';\n87.       const rightMarkers = getMarkers(rightFunctionName);\n88.       const leftMessage = \'Hello to the left-side from SNS!\';\n89.       const rightMessage = \'Hello to the right-side from SNS!\';\n90.       const middleMessage = \'Hello to the middle-side from SNS!\';\n91.       const leftAttributes = { side: { DataType: \'String\', StringValue: \'left\' } };\n92.       const middleAttributes = { side: { DataType: \'String\', StringValue: \'middle\' } };\n93.       const rightAttributes = { side: { DataType: \'String\', StringValue: \'right\' } };\n94. \n95.       return BbPromise.all([\n96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),\n97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),\n98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),\n99.       ])\n100.         .then(() =>\n101.           BbPromise.all([\n102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),\n103.             waitForFunctionLogs(\n104.               tmpDirPath,\n105.               rightFunctionName,\n106.               rightMarkers.start,\n107.               rightMarkers.end\n108.             ),\n109.           ])\n110.         )\n111.         .then(logs => {\n112.           const leftLogs = logs[0];\n113.           const rightLogs = logs[1];\n114.           // left side is filtered to only get "left" messages from topic:\n115.           expect(leftLogs).to.include(leftFunctionName);\n116.           expect(leftLogs).to.include(leftMessage);\n117.           expect(leftLogs).not.to.include(middleMessage);\n118.           expect(leftLogs).not.to.include(rightMessage);\n119.           // right side is filtered to only get "right" messages from topic:\n120.           expect(rightLogs).to.include(rightFunctionName);\n121.           expect(rightLogs).not.to.include(leftMessage);\n122.           expect(rightLogs).not.to.include(middleMessage);\n123.           expect(rightLogs).to.include(rightMessage);\n124.           // "middle" messages will not cause an invocation.\n125.         });\n126.     });\n127.   });', start_line_number=82, end_line_number=127), Context(relative_path='tests/integration-all/sns/tests.js', content="129.   describe('Existing Setup', () => {\n130.     it('should invoke on an existing topic message', () => {\n131.       const functionName = 'snsExisting';\n132.       const markers = getMarkers(functionName);\n133.       const message = 'Hello from an existing SNS!';\n134. \n135.       return publishSnsMessage(existingTopicName, message)\n136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n137.         .then(logs => {\n138.           expect(logs).to.include(functionName);\n139.           expect(logs).to.include(message);\n140.         });\n141.     });\n142.   });", start_line_number=129, end_line_number=142)]
2025-11-13 20:36:19,334 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_message_node - DEBUG - Sending message to BugReproducingWriteNode:
content='Issue title:\nRedrive Policy not properly referencing queue\n\nIssue description: \n\n\n## Description\n\nRecentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.\n````\nResource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]\n````\n\n````\nQueues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget\n````\n\nThis translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.\n\nIn this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.\nOther solutions would involve more complex things like trying to generate the url from the Arn. I\'m open to whatever you think is best and will start a PR as soon as there\'s consensus\n\n#7239 \n\n\nIssue comments:\n\n\nBug reproducing context:\nFile: lib/plugins/aws/lib/naming.test.js\nLine number range: 1 - 930\nContent:\n1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. \n5. const SDK = require(\'../provider/awsProvider\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. describe(\'#naming()\', () => {\n9.   let options;\n10.   let serverless;\n11.   let sdk;\n12. \n13.   beforeEach(() => {\n14.     options = {\n15.       stage: \'dev\',\n16.       region: \'us-east-1\',\n17.     };\n18.     serverless = new Serverless(options);\n19.     sdk = new SDK(serverless, options);\n20.   });\n21. \n22.   describe(\'#normalizeName()\', () => {\n23.     it(\'should capitalize the first letter\', () => {\n24.       expect(sdk.naming.normalizeName(\'name\')).to.equal(\'Name\');\n25.     });\n26. \n27.     it(\'should have no effect on caps\', () => {\n28.       expect(sdk.naming.normalizeName(\'Name\')).to.equal(\'Name\');\n29.     });\n30. \n31.     it(\'should have no effect on the rest of the name\', () => {\n32.       expect(sdk.naming.normalizeName(\'nAME\')).to.equal(\'NAME\');\n33.     });\n34.   });\n35. \n36.   describe(\'#normalizeNameToAlphaNumericOnly()\', () => {\n37.     it(\'should strip non-alpha-numeric characters\', () => {\n38.       expect(\n39.         sdk.naming.normalizeNameToAlphaNumericOnly(\'`!@#$%^&*()-={}|[]\\\\:";\\\'<>?,./\')\n40.       ).to.equal(\'\');\n41.     });\n42. \n43.     it(\'should apply normalizeName to the remaining characters\', () => {\n44.       expect(sdk.naming.normalizeNameToAlphaNumericOnly(\'a-b-c\')).to.equal(\'Abc\');\n45.     });\n46.   });\n47. \n48.   describe(\'#normalizePathPart()\', () => {\n49.     it(\'converts `-` to `Dash`\', () => {\n50.       expect(sdk.naming.normalizePathPart(\'a-path\')).to.equal(\'ADashpath\');\n51.     });\n52. \n53.     it(\'converts variable declarations (`${var}`) to `VariableVar`\', () => {\n54.       expect(sdk.naming.normalizePathPart(\'${variable}\')).to.equal(\'VariableVar\');\n55.     });\n56. \n57.     it(\'converts variable declarations prefixes to `VariableVarpath`\', () => {\n58.       expect(sdk.naming.normalizePathPart(\'${variable}Path\')).to.equal(\'VariableVarpath\');\n59.     });\n60. \n61.     it(\'converts variable declarations suffixes to `PathvariableVar`\', () => {\n62.       expect(sdk.naming.normalizePathPart(\'path${variable}\')).to.equal(\'PathvariableVar\');\n63.     });\n64. \n65.     it(\'converts variable declarations in center to `PathvariableVardir`\', () => {\n66.       expect(sdk.naming.normalizePathPart(\'path${variable}Dir\')).to.equal(\'PathvariableVardir\');\n67.     });\n68.   });\n69. \n70.   describe(\'#getServiceEndpointRegex()\', () => {\n71.     it(\'should match the prefix\', () => {\n72.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpoint\')).to.equal(true);\n73.     });\n74. \n75.     it(\'should not match a name without the prefix\', () => {\n76.       expect(sdk.naming.getServiceEndpointRegex().test(\'NotThePrefixServiceEndpoint\')).to.equal(\n77.         false\n78.       );\n79.     });\n80. \n81.     it(\'should match a name with the prefix\', () => {\n82.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpointForAService\')).to.equal(\n83.         true\n84.       );\n85.     });\n86.   });\n87. \n88.   describe(\'#getStackName()\', () => {\n89.     it(\'should use the service name & stage if custom stack name not provided\', () => {\n90.       serverless.service.service = \'myService\';\n91.       expect(sdk.naming.getStackName()).to.equal(\n92.         `${serverless.service.service}-${sdk.naming.provider.getStage()}`\n93.       );\n94.     });\n95. \n96.     it(\'should use the custom stack name if provided\', () => {\n97.       serverless.service.provider.stackName = \'app-dev-testApp\';\n98.       serverless.service.service = \'myService\';\n99.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n100.       expect(sdk.naming.getStackName()).to.equal(\'app-dev-testApp\');\n101.     });\n102.   });\n103. \n104.   describe(\'#getRolePath()\', () => {\n105.     it(\'should return `/`\', () => {\n106.       expect(sdk.naming.getRolePath()).to.equal(\'/\');\n107.     });\n108.   });\n109. \n110.   describe(\'#getRoleName()\', () => {\n111.     it(\'uses the service name, stage, and region to generate a role name\', () => {\n112.       serverless.service.service = \'myService\';\n113.       expect(sdk.naming.getRoleName()).to.eql({\n114.         \'Fn::Join\': [\n115.           \'-\',\n116.           [\n117.             serverless.service.service,\n118.             sdk.naming.provider.getStage(),\n119.             { Ref: \'AWS::Region\' },\n120.             \'lambdaRole\',\n121.           ],\n122.         ],\n123.       });\n124.     });\n125.   });\n126. \n127.   describe(\'#getRoleLogicalId()\', () => {\n128.     it(\'should return the expected role name (IamRoleLambdaExecution)\', () => {\n129.       expect(sdk.naming.getRoleLogicalId()).to.equal(\'IamRoleLambdaExecution\');\n130.     });\n131.   });\n132. \n133.   describe(\'#getPolicyName()\', () => {\n134.     it(\'should use the stage and service name\', () => {\n135.       serverless.service.service = \'myService\';\n136.       expect(sdk.naming.getPolicyName()).to.eql({\n137.         \'Fn::Join\': [\'-\', [sdk.naming.provider.getStage(), serverless.service.service, \'lambda\']],\n138.       });\n139.     });\n140.   });\n141. \n142.   describe(\'#getLogicalLogGroupName()\', () => {\n143.     it(\'should prefix the normalized function name to "LogGroup"\', () => {\n144.       expect(sdk.naming.getLogGroupLogicalId(\'functionName\')).to.equal(\'FunctionNameLogGroup\');\n145.     });\n146.   });\n147. \n148.   describe(\'#getLogGroupName()\', () => {\n149.     it(\'should add the function name to the log group name\', () => {\n150.       expect(sdk.naming.getLogGroupName(\'functionName\')).to.equal(\'/aws/lambda/functionName\');\n151.     });\n152.   });\n153. \n154.   describe(\'#getNormalizedFunctionName()\', () => {\n155.     it(\'should normalize the given functionName\', () => {\n156.       expect(sdk.naming.getNormalizedFunctionName(\'functionName\')).to.equal(\'FunctionName\');\n157.     });\n158. \n159.     it(\'should normalize the given functionName with an underscore\', () => {\n160.       expect(sdk.naming.getNormalizedFunctionName(\'hello_world\')).to.equal(\'HelloUnderscoreworld\');\n161.     });\n162. \n163.     it(\'should normalize the given functionName with a dash\', () => {\n164.       expect(sdk.naming.getNormalizedFunctionName(\'hello-world\')).to.equal(\'HelloDashworld\');\n165.     });\n166.   });\n167. \n168.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n169.     it(\'should extract everything after the last colon and dash\', () => {\n170.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n171.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n172.     });\n173.   });\n174. \n175.   describe(\'#extractLambdaNameFromArn()\', () => {\n176.     it(\'should extract everything after the last colon\', () => {\n177.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n178.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal(\'my-dev-lambda\');\n179.     });\n180.   });\n181. \n182.   describe(\'#getLambdaLogicalId()\', () => {\n183.     it(\'should normalize the function name and add the logical suffix\', () => {\n184.       expect(sdk.naming.getLambdaLogicalId(\'functionName\')).to.equal(\'FunctionNameLambdaFunction\');\n185.     });\n186.   });\n187. \n188.   describe(\'#getLambdaLogicalIdRegex()\', () => {\n189.     it(\'should match the suffix\', () => {\n190.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'LambdaFunction\')).to.equal(true);\n191.     });\n192. \n193.     it(\'should not match a name without the suffix\', () => {\n194.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'LambdaFunctionNotTheSuffix\')).to.equal(\n195.         false\n196.       );\n197.     });\n198. \n199.     it(\'should match a name with the suffix\', () => {\n200.       expect(sdk.naming.getLambdaLogicalIdRegex().test(\'AFunctionNameLambdaFunction\')).to.equal(\n201.         true\n202.       );\n203.     });\n204.   });\n205. \n206.   describe(\'#getWebsocketsApiName()\', () => {\n207.     it(\'should return the composition of stage & service name if custom name not provided\', () => {\n208.       serverless.service.service = \'myService\';\n209.       expect(sdk.naming.getWebsocketsApiName()).to.equal(\n210.         `${sdk.naming.provider.getStage()}-${serverless.service.service}-websockets`\n211.       );\n212.     });\n213. \n214.     it(\'should return the custom api name if provided\', () => {\n215.       serverless.service.provider.websocketsApiName = \'app-dev-websockets-testApi\';\n216.       serverless.service.service = \'myService\';\n217.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n218.       expect(sdk.naming.getWebsocketsApiName()).to.equal(\'app-dev-websockets-testApi\');\n219.     });\n220.   });\n221. \n222.   describe(\'#getWebsocketsApiLogicalId()\', () => {\n223.     it(\'should return the websocket API logical id\', () => {\n224.       expect(sdk.naming.getWebsocketsApiLogicalId()).to.equal(\'WebsocketsApi\');\n225.     });\n226.   });\n227. \n228.   describe(\'#getWebsocketsIntegrationLogicalId()\', () => {\n229.     it(\'should return the integrations logical id\', () => {\n230.       expect(sdk.naming.getWebsocketsIntegrationLogicalId(\'myFunc\')).to.equal(\n231.         \'MyFuncWebsocketsIntegration\'\n232.       );\n233.     });\n234.   });\n235. \n236.   describe(\'#getLambdaWebsocketsPermissionLogicalId()\', () => {\n237.     it(\'should return the lambda websocket permission logical id\', () => {\n238.       expect(sdk.naming.getLambdaWebsocketsPermissionLogicalId(\'myFunc\')).to.equal(\n239.         \'MyFuncLambdaPermissionWebsockets\'\n240.       );\n241.     });\n242.   });\n243. \n244.   describe(\'#getNormalizedWebsocketsRouteKey()\', () => {\n245.     it(\'should return a normalized version of the route key\', () => {\n246.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'$connect\')).to.equal(\'Sconnect\');\n247. \n248.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo/bar\')).to.equal(\'fooSlashbar\');\n249. \n250.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo-bar\')).to.equal(\'fooDashbar\');\n251. \n252.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo_bar\')).to.equal(\'fooUnderscorebar\');\n253. \n254.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'foo.bar\')).to.equal(\'fooPeriodbar\');\n255.     });\n256. \n257.     it(\'converts multiple `-` correctly\', () => {\n258.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'a-longer-path\')).to.equal(\n259.         \'aDashlongerDashpath\'\n260.       );\n261.     });\n262. \n263.     it(\'converts multiple `-` and `_` correctly\', () => {\n264.       expect(sdk.naming.getNormalizedWebsocketsRouteKey(\'a-long_er-path_still\')).to.equal(\n265.         \'aDashlongUnderscoreerDashpathUnderscorestill\'\n266.       );\n267.     });\n268.   });\n269. \n270.   describe(\'#getWebsocketsRouteLogicalId()\', () => {\n271.     it(\'should return the websockets route logical id\', () => {\n272.       expect(sdk.naming.getWebsocketsRouteLogicalId(\'$connect\')).to.equal(\n273.         \'SconnectWebsocketsRoute\'\n274.       );\n275.     });\n276.   });\n277. \n278.   describe(\'#getWebsocketsDeploymentLogicalId()\', () => {\n279.     it(\'should return the websockets deployment logical id\', () => {\n280.       expect(sdk.naming.getWebsocketsDeploymentLogicalId(\'Abc+123=\')).to.equal(\n281.         \'WebsocketsDeploymentAbc123\'\n282.       );\n283.     });\n284.   });\n285. \n286.   describe(\'#getWebsocketsStageLogicalId()\', () => {\n287.     it(\'should return the websockets stage logical id\', () => {\n288.       expect(sdk.naming.getWebsocketsStageLogicalId()).to.equal(\'WebsocketsDeploymentStage\');\n289.     });\n290.   });\n291. \n292.   describe(\'#getWebsocketsAuthorizerLogicalId()\', () => {\n293.     it(\'should return the websockets authorizer logical id\', () => {\n294.       expect(sdk.naming.getWebsocketsAuthorizerLogicalId(\'auth\')).to.equal(\n295.         \'AuthWebsocketsAuthorizer\'\n296.       );\n297.     });\n298.   });\n299. \n300.   describe(\'#getWebsocketsLogGroupLogicalId()\', () => {\n301.     it(\'should return the Websockets log group logical id\', () => {\n302.       expect(sdk.naming.getWebsocketsLogGroupLogicalId()).to.equal(\'WebsocketsLogGroup\');\n303.     });\n304.   });\n305. \n306.   describe(\'#getApiGatewayName()\', () => {\n307.     it(\'should return the composition of stage & service name if custom name not provided\', () => {\n308.       serverless.service.service = \'myService\';\n309.       expect(sdk.naming.getApiGatewayName()).to.equal(\n310.         `${sdk.naming.provider.getStage()}-${serverless.service.service}`\n311.       );\n312.     });\n313. \n314.     it(\'should return the custom api name if provided\', () => {\n315.       serverless.service.provider.apiName = \'app-dev-testApi\';\n316.       serverless.service.service = \'myService\';\n317.       serverless.service.provider.stage = sdk.naming.provider.getStage();\n318.       expect(sdk.naming.getApiGatewayName()).to.equal(\'app-dev-testApi\');\n319.     });\n320.   });\n321. \n322.   describe(\'#generateApiGatewayDeploymentLogicalId()\', () => {\n323.     it(\'should return ApiGatewayDeployment with a suffix\', () => {\n324.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId(1234)).to.equal(\n325.         \'ApiGatewayDeployment1234\'\n326.       );\n327.     });\n328.   });\n329. \n330.   describe(\'#getRestApiLogicalId()\', () => {\n331.     it(\'should return ApiGatewayRestApi\', () => {\n332.       expect(sdk.naming.getRestApiLogicalId()).to.equal(\'ApiGatewayRestApi\');\n333.     });\n334.   });\n335. \n336.   describe(\'#getNormalizedAuthorizerName()\', () => {\n337.     it(\'normalize the authorizer name\', () => {\n338.       expect(sdk.naming.getNormalizedAuthorizerName(\'authorizerName\')).to.equal(\'AuthorizerName\');\n339.     });\n340.   });\n341. \n342.   describe(\'#getAuthorizerLogicalId()\', () => {\n343.     it(\'should normalize the authorizer name and add the standard suffix\', () => {\n344.       expect(sdk.naming.getAuthorizerLogicalId(\'authorizerName\')).to.equal(\n345.         \'AuthorizerNameApiGatewayAuthorizer\'\n346.       );\n347.     });\n348.   });\n349. \n350.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n351.     it(\'should extract the authorizer name from an ARN\', () => {\n352.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n353.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n354.     });\n355.   });\n356. \n357.   describe(\'#normalizePath()\', () => {\n358.     it(\'should normalize each part of the resource path and remove non-alpha-numeric characters\', () => {\n359.       expect(sdk.naming.normalizePath(\'my/path/to/a-${var}-resource\')).to.equal(\n360.         \'MyPathToADashvarVarDashresource\'\n361.       );\n362.     });\n363.   });\n364. \n365.   describe(\'#getResourceLogicalId()\', () => {\n366.     it(\'should normalize the resource and add the standard suffix\', () => {\n367.       expect(sdk.naming.getResourceLogicalId(\'my/path/to/a-${var}-resource\')).to.equal(\n368.         \'ApiGatewayResourceMyPathToADashvarVarDashresource\'\n369.       );\n370.     });\n371.   });\n372. \n373.   describe(\'#extractResourceId()\', () => {\n374.     it(\'should extract the normalized resource name\', () => {\n375.       expect(\n376.         sdk.naming.extractResourceId(\'ApiGatewayResourceMyPathToADashvarVarDashResource\')\n377.       ).to.equal(\'MyPathToADashvarVarDashResource\');\n378.     });\n379.   });\n380. \n381.   describe(\'#normalizeMethodName()\', () => {\n382.     it(\'should capitalize the first letter and lowercase any other characters\', () => {\n383.       expect(sdk.naming.normalizeMethodName(\'gET\')).to.equal(\'Get\');\n384.     });\n385.   });\n386. \n387.   describe(\'#getMethodLogicalId()\', () => {\n388.     it(\'\', () => {\n389.       expect(sdk.naming.getMethodLogicalId(\'ResourceId\', \'get\')).to.equal(\n390.         \'ApiGatewayMethodResourceIdGet\'\n391.       );\n392.     });\n393.   });\n394. \n395.   describe(\'#getValidatorLogicalId()\', () => {\n396.     it(\'\', () => {\n397.       expect(sdk.naming.getValidatorLogicalId(\'ResourceId\', \'get\')).to.equal(\n398.         \'ApiGatewayMethodResourceIdGetValidator\'\n399.       );\n400.     });\n401.   });\n402. \n403.   describe(\'#getModelLogicalId()\', () => {\n404.     it(\'\', () => {\n405.       expect(sdk.naming.getModelLogicalId(\'ResourceId\', \'get\', \'application/json\')).to.equal(\n406.         \'ApiGatewayMethodResourceIdGetApplicationJsonModel\'\n407.       );\n408.     });\n409.   });\n410. \n411.   describe(\'#getApiKeyLogicalId(keyIndex)\', () => {\n412.     it(\'should produce the given index with ApiGatewayApiKey as a prefix\', () => {\n413.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal(\'ApiGatewayApiKey1\');\n414.     });\n415. \n416.     it(\'should support API Key names\', () => {\n417.       expect(sdk.naming.getApiKeyLogicalId(1, \'free\')).to.equal(\'ApiGatewayApiKeyFree1\');\n418.     });\n419.   });\n420. \n421.   describe(\'#getApiKeyLogicalIdRegex()\', () => {\n422.     it(\'should match the prefix\', () => {\n423.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'ApiGatewayApiKey\')).to.equal(true);\n424.     });\n425. \n426.     it(\'should not match a name without the prefix\', () => {\n427.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'NotThePrefixApiGatewayApiKey\')).to.equal(\n428.         false\n429.       );\n430.     });\n431. \n432.     it(\'should match a name with the prefix\', () => {\n433.       expect(sdk.naming.getApiKeyLogicalIdRegex().test(\'ApiGatewayApiKeySuffix\')).to.equal(true);\n434.     });\n435.   });\n436. \n437.   describe(\'#getUsagePlanLogicalId()\', () => {\n438.     it(\'should return the default ApiGateway usage plan logical id\', () => {\n439.       expect(sdk.naming.getUsagePlanLogicalId()).to.equal(\'ApiGatewayUsagePlan\');\n440.     });\n441. \n442.     it(\'should return the named ApiGateway usage plan logical id\', () => {\n443.       expect(sdk.naming.getUsagePlanLogicalId(\'free\')).to.equal(\'ApiGatewayUsagePlanFree\');\n444.     });\n445.   });\n446. \n447.   describe(\'#getUsagePlanKeyLogicalId()\', () => {\n448.     it(\'should produce the given index with ApiGatewayUsagePlanKey as a prefix\', () => {\n449.       expect(sdk.naming.getUsagePlanKeyLogicalId(1)).to.equal(\'ApiGatewayUsagePlanKey1\');\n450.     });\n451. \n452.     it(\'should support API Key names\', () => {\n453.       expect(sdk.naming.getUsagePlanKeyLogicalId(1, \'free\')).to.equal(\n454.         \'ApiGatewayUsagePlanKeyFree1\'\n455.       );\n456.     });\n457.   });\n458. \n459.   describe(\'#getStageLogicalId()\', () => {\n460.     it(\'should return the API Gateway stage logical id\', () => {\n461.       expect(sdk.naming.getStageLogicalId()).to.equal(\'ApiGatewayStage\');\n462.     });\n463.   });\n464. \n465.   describe(\'#getApiGatewayLogGroupLogicalId()\', () => {\n466.     it(\'should return the API Gateway log group logical id\', () => {\n467.       expect(sdk.naming.getApiGatewayLogGroupLogicalId()).to.equal(\'ApiGatewayLogGroup\');\n468.     });\n469.   });\n470. \n471.   describe(\'#getDeploymentBucketLogicalId()\', () => {\n472.     it(\'should return "ServerlessDeploymentBucket"\', () => {\n473.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal(\'ServerlessDeploymentBucket\');\n474.     });\n475.   });\n476. \n477.   describe(\'#getDeploymentBucketOutputLogicalId()\', () => {\n478.     it(\'should return "ServerlessDeploymentBucketName"\', () => {\n479.       expect(sdk.naming.getDeploymentBucketOutputLogicalId()).to.equal(\n480.         \'ServerlessDeploymentBucketName\'\n481.       );\n482.     });\n483.   });\n484. \n485.   describe(\'#getDeploymentBucketPolicyLogicalId()\', () => {\n486.     it(\'should return "ServerlessDeploymentBucketPolicy"\', () => {\n487.       expect(sdk.naming.getDeploymentBucketPolicyLogicalId()).to.equal(\n488.         \'ServerlessDeploymentBucketPolicy\'\n489.       );\n490.     });\n491.   });\n492. \n493.   describe(\'#normalizeBucketName()\', () => {\n494.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n495.       expect(sdk.naming.normalizeBucketName(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'BucketName\');\n496.     });\n497.   });\n498. \n499.   describe(\'#getBucketLogicalId()\', () => {\n500.     it(\'should normalize the bucket name and add the standard prefix\', () => {\n501.       expect(sdk.naming.getBucketLogicalId(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'S3BucketBucketName\');\n502.     });\n503.   });\n504. \n505.   describe(\'#normalizeTopicName()\', () => {\n506.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n507.       expect(sdk.naming.normalizeTopicName(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'TopicName\');\n508.     });\n509.   });\n510. \n511.   describe(\'#getTopicLogicalId()\', () => {\n512.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n513.       expect(sdk.naming.getTopicLogicalId(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'SNSTopicTopicName\');\n514.     });\n515.   });\n516. \n517.   describe(\'#getScheduleId()\', () => {\n518.     it(\'should add the standard suffix\', () => {\n519.       expect(sdk.naming.getScheduleId(\'functionName\')).to.equal(\'functionNameSchedule\');\n520.     });\n521.   });\n522. \n523.   describe(\'#getScheduleLogicalId()\', () => {\n524.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n525.       expect(sdk.naming.getScheduleLogicalId(\'functionName\', 0)).to.equal(\n526.         \'FunctionNameEventsRuleSchedule0\'\n527.       );\n528.     });\n529.   });\n530. \n531.   describe(\'#getStreamConsumerName()\', () => {\n532.     it(\'should add the standard suffix\', () => {\n533.       expect(sdk.naming.getStreamConsumerName(\'functionName\', \'streamName\')).to.equal(\n534.         \'functionNamestreamNameConsumer\'\n535.       );\n536.     });\n537.   });\n538. \n539.   describe(\'#getStreamConsumerLogicalId()\', () => {\n540.     it(\'should normalize the stream consumer name and add the standard suffix\', () => {\n541.       expect(sdk.naming.getStreamConsumerLogicalId(\'streamConsumerName\')).to.equal(\n542.         \'StreamConsumerNameStreamConsumer\'\n543.       );\n544.     });\n545.   });\n546. \n547.   describe(\'#getCloudWatchEventId()\', () => {\n548.     it(\'should add the standard suffix\', () => {\n549.       expect(sdk.naming.getCloudWatchEventId(\'functionName\')).to.equal(\n550.         \'functionNameCloudWatchEvent\'\n551.       );\n552.     });\n553.   });\n554. \n555.   describe(\'#getCloudWatchEventLogicalId()\', () => {\n556.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n557.       expect(sdk.naming.getCloudWatchEventLogicalId(\'functionName\', 0)).to.equal(\n558.         \'FunctionNameEventsRuleCloudWatchEvent0\'\n559.       );\n560.     });\n561.   });\n562. \n563.   describe(\'#getCloudWatchLogLogicalId()\', () => {\n564.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n565.       expect(sdk.naming.getCloudWatchLogLogicalId(\'functionName\', 0)).to.equal(\n566.         \'FunctionNameLogsSubscriptionFilterCloudWatchLog0\'\n567.       );\n568.     });\n569.   });\n570. \n571.   describe(\'#getCognitoUserPoolLogicalId()\', () => {\n572.     it(\'should normalize the user pool name and add the standard prefix\', () => {\n573.       expect(sdk.naming.getCognitoUserPoolLogicalId(\'us-east-1_v123sDAS1\')).to.equal(\n574.         \'CognitoUserPoolUseast1v123sDAS1\'\n575.       );\n576.     });\n577.   });\n578. \n579.   describe(\'#getLambdaS3PermissionLogicalId()\', () => {\n580.     it(\'should normalize the function name and add the standard suffix\', () => {\n581.       expect(sdk.naming.getLambdaS3PermissionLogicalId(\'functionName\', \'bucket\')).to.equal(\n582.         \'FunctionNameLambdaPermissionBucketS3\'\n583.       );\n584.     });\n585.   });\n586. \n587.   describe(\'#getLambdaSnsPermissionLogicalId()\', () => {\n588.     it(\n589.       \'should normalize the function and topic names and add them as prefix and suffix to the \' +\n590.         \'standard permission center\',\n591.       () => {\n592.         expect(sdk.naming.getLambdaSnsPermissionLogicalId(\'functionName\', \'topic\')).to.equal(\n593.           \'FunctionNameLambdaPermissionTopicSNS\'\n594.         );\n595.       }\n596.     );\n597.   });\n598. \n599.   describe(\'#getLambdaSchedulePermissionLogicalId()\', () => {\n600.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n601.       expect(sdk.naming.getLambdaSchedulePermissionLogicalId(\'functionName\', 0)).to.equal(\n602.         \'FunctionNameLambdaPermissionEventsRuleSchedule0\'\n603.       );\n604.     });\n605.   });\n606. \n607.   describe(\'#getLambdaCloudWatchEventPermissionLogicalId()\', () => {\n608.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n609.       expect(sdk.naming.getLambdaCloudWatchEventPermissionLogicalId(\'functionName\', 0)).to.equal(\n610.         \'FunctionNameLambdaPermissionEventsRuleCloudWatchEvent0\'\n611.       );\n612.     });\n613.   });\n614. \n615.   describe(\'#getLambdaApiGatewayPermissionLogicalId()\', () => {\n616.     it(\'should normalize the function name and append the standard suffix\', () => {\n617.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId(\'functionName\')).to.equal(\n618.         \'FunctionNameLambdaPermissionApiGateway\'\n619.       );\n620.     });\n621.   });\n622. \n623.   describe(\'#getIotLogicalId()\', () => {\n624.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n625.       expect(sdk.naming.getIotLogicalId(\'functionName\', 0)).to.equal(\'FunctionNameIotTopicRule0\');\n626.     });\n627.   });\n628. \n629.   describe(\'#getLambdaIotPermissionLogicalId()\', () => {\n630.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n631.       expect(sdk.naming.getLambdaIotPermissionLogicalId(\'functionName\', 0)).to.equal(\n632.         \'FunctionNameLambdaPermissionIotTopicRule0\'\n633.       );\n634.     });\n635.   });\n636. \n637.   describe(\'#getLambdaAlexaSkillPermissionLogicalId()\', () => {\n638.     it(\'should normalize the function name and append the standard suffix\', () => {\n639.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\', 2)).to.equal(\n640.         \'FunctionNameLambdaPermissionAlexaSkill2\'\n641.       );\n642.     });\n643. \n644.     it(\'should normalize the function name and append a default suffix if not defined\', () => {\n645.       expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\')).to.equal(\n646.         \'FunctionNameLambdaPermissionAlexaSkill0\'\n647.       );\n648.     });\n649.   });\n650. \n651.   describe(\'#getLambdaAlexaSmartHomePermissionLogicalId()\', () => {\n652.     it(\'should normalize the function name and append the standard suffix\', () => {\n653.       expect(sdk.naming.getLambdaAlexaSmartHomePermissionLogicalId(\'functionName\', 0)).to.equal(\n654.         \'FunctionNameLambdaPermissionAlexaSmartHome0\'\n655.       );\n656.     });\n657.   });\n658. \n659.   describe(\'#getLambdaSnsSubscriptionLogicalId()\', () => {\n660.     it(\'should normalize the function name and append the standard suffix\', () => {\n661.       expect(sdk.naming.getLambdaSnsSubscriptionLogicalId(\'functionName\', \'topicName\')).to.equal(\n662.         \'FunctionNameSnsSubscriptionTopicName\'\n663.       );\n664.     });\n665.   });\n666. \n667.   describe(\'#getLambdaCloudWatchLogPermissionLogicalId()\', () => {\n668.     it(\'should normalize the function name and add the standard suffix including event index\', () => {\n669.       expect(sdk.naming.getLambdaCloudWatchLogPermissionLogicalId(\'functionName\')).to.equal(\n670.         \'FunctionNameLambdaPermissionLogsSubscriptionFilterCloudWatchLog\'\n671.       );\n672.     });\n673.   });\n674. \n675.   describe(\'#getLambdaCognitoUserPoolPermissionLogicalId()\', () => {\n676.     it(\'should normalize the function name and add the standard suffix\', () => {\n677.       expect(\n678.         sdk.naming.getLambdaCognitoUserPoolPermissionLogicalId(\n679.           \'functionName\',\n680.           \'Pool1\',\n681.           \'CustomMessage\'\n682.         )\n683.       ).to.equal(\'FunctionNameLambdaPermissionCognitoUserPoolPool1TriggerSourceCustomMessage\');\n684.     });\n685. \n686.     describe(\'#getLambdaAlbPermissionLogicalId()\', () => {\n687.       it(\'should normalize the function name\', () => {\n688.         expect(sdk.naming.getLambdaAlbPermissionLogicalId(\'functionName\')).to.equal(\n689.           \'FunctionNameLambdaPermissionAlb\'\n690.         );\n691.       });\n692.     });\n693. \n694.     describe(\'#getLambdaRegisterTargetPermissionLogicalId()\', () => {\n695.       it(\'should normalize the function name and add the correct suffix\', () => {\n696.         expect(sdk.naming.getLambdaRegisterTargetPermissionLogicalId(\'functionName\')).to.equal(\n697.           \'FunctionNameLambdaPermissionRegisterTarget\'\n698.         );\n699.       });\n700.     });\n701.   });\n702. \n703.   describe(\'#getQueueLogicalId()\', () => {\n704.     it(\'should normalize the function name and add the standard suffix\', () => {\n705.       expect(sdk.naming.getQueueLogicalId(\'functionName\', \'MyQueue\')).to.equal(\n706.         \'FunctionNameEventSourceMappingSQSMyQueue\'\n707.       );\n708.     });\n709.   });\n710. \n711.   describe(\'#getAlbTargetGroupLogicalId()\', () => {\n712.     it(\'should normalize the function name\', () => {\n713.       expect(sdk.naming.getAlbTargetGroupLogicalId(\'functionName\', \'abc123\')).to.equal(\n714.         \'FunctionNameAlbTargetGroupabc123\'\n715.       );\n716.     });\n717. \n718.     it(\'should normalize the function name and add MultiValue prefix if multiValueHeader is true\', () => {\n719.       expect(sdk.naming.getAlbTargetGroupLogicalId(\'functionName\', \'abc123\', true)).to.equal(\n720.         \'FunctionNameAlbMultiValueTargetGroupabc123\'\n721.       );\n722.     });\n723.   });\n724. \n725.   describe(\'#getAlbListenerRuleLogicalId()\', () => {\n726.     it(\'should normalize the function name and add an index\', () => {\n727.       expect(sdk.naming.getAlbListenerRuleLogicalId(\'functionName\', 0)).to.equal(\n728.         \'FunctionNameAlbListenerRule0\'\n729.       );\n730.     });\n731.   });\n732. \n733.   describe(\'#getAlbTargetGroupName()\', () => {\n734.     it(\'should return a unique identifier based on the service name, function name, alb id, multi-value attribute and stage\', () => {\n735.       serverless.service.service = \'myService\';\n736.       expect(sdk.naming.getAlbTargetGroupName(\'functionName\', \'abc123\', true)).to.equal(\n737.         \'79039bd239ac0b3f6ff6d9296f23e27c\'\n738.       );\n739.     });\n740. \n741.     it(\'should return a prefixed unique identifer of not longer than 32 characters if alb.targetGroupPrefix is set\', () => {\n742.       serverless.service.service = \'myService\';\n743.       serverless.service.provider.alb = {};\n744.       serverless.service.provider.alb.targetGroupPrefix = \'myPrefix-\';\n745.       expect(sdk.naming.getAlbTargetGroupName(\'functionName\', \'abc123\', true)).to.equal(\n746.         \'myPrefix-79039bd239ac0b3f6ff6d92\'\n747.       );\n748.     });\n749.   });\n750. \n751.   describe(\'#getAlbTargetGroupNameTagValue()\', () => {\n752.     it(\'should return the composition of service name, function name, alb id, multi-value attribute and stage\', () => {\n753.       serverless.service.service = \'myService\';\n754.       expect(sdk.naming.getAlbTargetGroupNameTagValue(\'functionName\', \'abc123\', true)).to.equal(\n755.         `${\n756.           serverless.service.service\n757.         }-functionName-abc123-multi-value-${sdk.naming.provider.getStage()}`\n758.       );\n759.     });\n760.   });\n761. \n762.   describe(\'#getCustomResourcesArtifactName()\', () => {\n763.     it(\'should return the custom resources artifact directory name\', () => {\n764.       expect(sdk.naming.getCustomResourcesArtifactName()).to.equal(\'custom-resources.zip\');\n765.     });\n766.   });\n767. \n768.   describe(\'#getCustomResourcesRoleLogicalId()\', () => {\n769.     it(\'should return the custom resources role logical id\', () => {\n770.       expect(sdk.naming.getCustomResourcesRoleLogicalId()).to.equal(\n771.         \'IamRoleCustomResourcesLambdaExecution\'\n772.       );\n773.     });\n774.   });\n775. \n776.   describe(\'#getCustomResourceS3HandlerFunctionName()\', () => {\n777.     it(\'should return the name of the S3 custom resource handler function\', () => {\n778.       expect(sdk.naming.getCustomResourceS3HandlerFunctionName()).to.equal(\n779.         \'custom-resource-existing-s3\'\n780.       );\n781.     });\n782.   });\n783. \n784.   describe(\'#getCustomResourceS3HandlerFunctionLogicalId()\', () => {\n785.     it(\'should return the logical id of the S3 custom resource handler function\', () => {\n786.       expect(sdk.naming.getCustomResourceS3HandlerFunctionLogicalId()).to.equal(\n787.         \'CustomDashresourceDashexistingDashs3LambdaFunction\'\n788.       );\n789.     });\n790.   });\n791. \n792.   describe(\'#getCustomResourceS3ResourceLogicalId()\', () => {\n793.     it(\'should return the logical id of the S3 custom resource\', () => {\n794.       const functionName = \'my-function\';\n795.       expect(sdk.naming.getCustomResourceS3ResourceLogicalId(functionName)).to.equal(\n796.         \'MyDashfunctionCustomS31\'\n797.       );\n798.     });\n799.   });\n800. \n801.   describe(\'#getCustomResourceCognitoUserPoolHandlerFunctionName()\', () => {\n802.     it(\'should return the name of the Cognito User Pool custom resource handler function\', () => {\n803.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionName()).to.equal(\n804.         \'custom-resource-existing-cup\'\n805.       );\n806.     });\n807.   });\n808. \n809.   describe(\'#getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()\', () => {\n810.     it(\'should return the logical id of the Cognito User Pool custom resource handler function\', () => {\n811.       expect(sdk.naming.getCustomResourceCognitoUserPoolHandlerFunctionLogicalId()).to.equal(\n812.         \'CustomDashresourceDashexistingDashcupLambdaFunction\'\n813.       );\n814.     });\n815.   });\n816. \n817.   describe(\'#getCustomResourceCognitoUserPoolResourceLogicalId()\', () => {\n818.     it(\'should return the logical id of the Cognito User Pool custom resource\', () => {\n819.       const functionName = \'my-function\';\n820.       expect(sdk.naming.getCustomResourceCognitoUserPoolResourceLogicalId(functionName)).to.equal(\n821.         \'MyDashfunctionCustomCognitoUserPool1\'\n822.       );\n823.     });\n824.   });\n825. \n826.   describe(\'#getCustomResourceEventBridgeHandlerFunctionName()\', () => {\n827.     it(\'should return the name of the Event Bridge custom resource handler function\', () => {\n828.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionName()).to.equal(\n829.         \'custom-resource-event-bridge\'\n830.       );\n831.     });\n832.   });\n833. \n834.   describe(\'#getCustomResourceEventBridgeHandlerFunctionLogicalId()\', () => {\n835.     it(\'should return the logical id of the Event Bridge custom resource handler function\', () => {\n836.       expect(sdk.naming.getCustomResourceEventBridgeHandlerFunctionLogicalId()).to.equal(\n837.         \'CustomDashresourceDasheventDashbridgeLambdaFunction\'\n838.       );\n839.     });\n840.   });\n841. \n842.   describe(\'#getCustomResourceEventBridgeResourceLogicalId()\', () => {\n843.     it(\'should return the logical id of the Event Bridge custom resource\', () => {\n844.       const functionName = \'my-function\';\n845.       const index = 1;\n846.       expect(\n847.         sdk.naming.getCustomResourceEventBridgeResourceLogicalId(functionName, index)\n848.       ).to.equal(\'MyDashfunctionCustomEventBridge1\');\n849.     });\n850.   });\n851. \n852.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()\', () => {\n853.     it(\'should return the name of the APIGW Account CloudWatch role custom resource handler function\', () => {\n854.       expect(\n855.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionName()\n856.       ).to.equal(\'custom-resource-apigw-cw-role\');\n857.     });\n858.   });\n859. \n860.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()\', () => {\n861.     it(\'should return the logical id of the APIGW Account CloudWatch role custom resource handler function\', () => {\n862.       expect(\n863.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleHandlerFunctionLogicalId()\n864.       ).to.equal(\'CustomDashresourceDashapigwDashcwDashroleLambdaFunction\');\n865.     });\n866.   });\n867. \n868.   describe(\'#getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()\', () => {\n869.     it(\'should return the logical id of the APIGW Account CloudWatch role custom resource\', () => {\n870.       expect(\n871.         sdk.naming.getCustomResourceApiGatewayAccountCloudWatchRoleResourceLogicalId()\n872.       ).to.equal(\'CustomApiGatewayAccountCloudWatchRole\');\n873.     });\n874.   });\n875. \n876.   describe(\'#getCloudFrontDistributionLogicalId()\', () => {\n877.     it(\'should return CloudFront distribution logical id\', () => {\n878.       expect(sdk.naming.getCloudFrontDistributionLogicalId()).to.equal(\'CloudFrontDistribution\');\n879.     });\n880.   });\n881. \n882.   describe(\'#getCloudFrontDistributionDomainNameLogicalId()\', () => {\n883.     it(\'should return CloudFront distribution domain name logical id\', () => {\n884.       expect(sdk.naming.getCloudFrontDistributionDomainNameLogicalId()).to.equal(\n885.         \'CloudFrontDistributionDomainName\'\n886.       );\n887.     });\n888.   });\n889. \n890.   describe(\'#getLambdaAtEdgeInvokePermissionLogicalId()\', () => {\n891.     it(\'should return lambda@edge invoke permission logical id\', () => {\n892.       expect(sdk.naming.getLambdaAtEdgeInvokePermissionLogicalId(\'functionName\')).to.equal(\n893.         \'FunctionNameLambdaFunctionInvokePermission\'\n894.       );\n895.     });\n896.   });\n897. \n898.   describe(\'#getCloudFrontOriginId()\', () => {\n899.     it(\'should return CloudFront origin id for s3 origin\', () => {\n900.       expect(\n901.         sdk.naming.getCloudFrontOriginId({\n902.           S3OriginConfig: {},\n903.           DomainName: \'domain.name\',\n904.           OriginPath: \'/path\',\n905.         })\n906.       ).to.equal(\'s3/domain.name/path\');\n907.     });\n908. \n909.     it(\'should return CloudFront origin id for custom origin\', () => {\n910.       expect(\n911.         sdk.naming.getCloudFrontOriginId({\n912.           CustomOriginConfig: {},\n913.           DomainName: \'domain.name\',\n914.           OriginPath: \'/path\',\n915.         })\n916.       ).to.equal(\'custom/domain.name/path\');\n917.     });\n918. \n919.     it(\'should return CloudFront origin id from domain as a object\', () => {\n920.       expect(\n921.         sdk.naming.getCloudFrontOriginId({\n922.           CustomOriginConfig: {},\n923.           DomainName: {\n924.             \'Fn::Join\': [\'\', [\'Ref: ApiGatewayRestApi\', \'.execute-api.\']],\n925.           },\n926.         })\n927.       ).to.equal(\'custom/FnJoinRefApiGatewayRestApiexecuteapi\');\n928.     });\n929.   });\n930. });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 1 - 7\nContent:\n1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsProvider = require(\'../../../../provider/awsProvider\');\n5. const AwsCompileSNSEvents = require(\'./index\');\n6. const Serverless = require(\'../../../../../../Serverless\');\n7. \n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 42 - 88\nContent:\n42.     it(\'should create corresponding resources when SNS events are given\', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: \'Topic 1\',\n49.                 displayName: \'Display name for topic 1\',\n50.                 filterPolicy: {\n51.                   pet: [\'dog\', \'cat\'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: \'Topic 2\',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal(\'AWS::SNS::Topic\');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal(\'AWS::SNS::Topic\');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal(\'AWS::Lambda::Permission\');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal(\'AWS::Lambda::Permission\');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal(\'AWS::SNS::Subscription\');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n88.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 90 - 149\nContent:\n90.     it(\'should create corresponding resources when topic is defined in resources\', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: \'Topic 1\',\n97.                 displayName: \'Display name for topic 1\',\n98.                 filterPolicy: {\n99.                   pet: [\'dog\', \'cat\'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: \'Topic 2\',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: \'AWS::SNS::Topic\',\n115.             Properties: {\n116.               TopicName: \'Topic 2\',\n117.               DisplayName: \'Display name for topic 2\',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal(\'AWS::SNS::Topic\');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal(\'AWS::SNS::Topic\');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal(\'AWS::Lambda::Permission\');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal(\'AWS::Lambda::Permission\');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal(\'AWS::SNS::Subscription\');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n149.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 151 - 183\nContent:\n151.     it(\'should create single SNS topic when the same topic is referenced repeatedly\', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: \'Topic 1\',\n158.                 displayName: \'Display name for topic 1\',\n159.               },\n160.             },\n161.             {\n162.               sns: \'Topic 1\',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal(\'AWS::SNS::Topic\');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal(\'AWS::Lambda::Permission\');\n183.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 217 - 247\nContent:\n217.     it(\'should create SNS topic when arn is given as a string\', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: \'arn:aws:foo\',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal(\'AWS::SNS::Subscription\');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal(\'AWS::Lambda::Permission\');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 249 - 277\nContent:\n249.     it(\'should create SNS topic when only arn is given as an object property\', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: \'arn:aws:sns:region:accountid:foo\',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal(\'AWS::SNS::Subscription\');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal(\'AWS::Lambda::Permission\');\n277.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 279 - 310\nContent:\n279.     it(\'should create a cross region subscription when SNS topic arn in a different region than provider\', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: \'arn:aws:sns:some-other-region:accountid:foo\',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal(\'AWS::SNS::Subscription\');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal(\'some-other-region\');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal(\'AWS::Lambda::Permission\');\n310.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 562 - 598\nContent:\n562.     it(\'should create SNS topic when arn, topicName, and filterPolicy are given as object\', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: \'bar\',\n569.                 arn: \'arn:aws:sns:region:accountid:bar\',\n570.                 filterPolicy: {\n571.                   pet: [\'dog\', \'cat\'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal(\'AWS::SNS::Subscription\');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal(\'AWS::Lambda::Permission\');\n598.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 600 - 653\nContent:\n600.     it(\'should link topic to corresponding dlq when redrivePolicy is defined\', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: \'Topic 1\',\n607.                 displayName: \'Display name for topic 1\',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     \'Fn::GetAtt\': [\'SNSDLQ\', \'Arn\'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: \'AWS::SQS::Queue\',\n624.             Properties: {\n625.               QueueName: \'SNSDLQ\',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal(\'AWS::SNS::Topic\');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal(\'AWS::Lambda::Permission\');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal(\'AWS::SNS::Subscription\');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { \'Fn::GetAtt\': [\'SNSDLQ\', \'Arn\'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal(\'AWS::SQS::QueuePolicy\');\n653.     });\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.test.js\nLine number range: 399 - 500\nContent:\n399.       it(\'should allow specifying SQS Queues as CFN reference types\', () => {\n400.         awsCompileSQSEvents.serverless.service.functions = {\n401.           first: {\n402.             events: [\n403.               {\n404.                 sqs: {\n405.                   arn: { \'Fn::GetAtt\': [\'SomeQueue\', \'Arn\'] },\n406.                 },\n407.               },\n408.               {\n409.                 sqs: {\n410.                   arn: { \'Fn::ImportValue\': \'ForeignQueue\' },\n411.                 },\n412.               },\n413.               {\n414.                 sqs: {\n415.                   arn: {\n416.                     \'Fn::Join\': [\n417.                       \':\',\n418.                       [\n419.                         \'arn\',\n420.                         \'aws\',\n421.                         \'sqs\',\n422.                         {\n423.                           Ref: \'AWS::Region\',\n424.                         },\n425.                         {\n426.                           Ref: \'AWS::AccountId\',\n427.                         },\n428.                         \'MyQueue\',\n429.                       ],\n430.                     ],\n431.                   },\n432.                 },\n433.               },\n434.             ],\n435.           },\n436.         };\n437. \n438.         awsCompileSQSEvents.compileSQSEvents();\n439. \n440.         expect(\n441.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n442.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement[0]\n443.         ).to.deep.equal({\n444.           Action: [\'sqs:ReceiveMessage\', \'sqs:DeleteMessage\', \'sqs:GetQueueAttributes\'],\n445.           Effect: \'Allow\',\n446.           Resource: [\n447.             {\n448.               \'Fn::GetAtt\': [\'SomeQueue\', \'Arn\'],\n449.             },\n450.             {\n451.               \'Fn::ImportValue\': \'ForeignQueue\',\n452.             },\n453.             {\n454.               \'Fn::Join\': [\n455.                 \':\',\n456.                 [\n457.                   \'arn\',\n458.                   \'aws\',\n459.                   \'sqs\',\n460.                   {\n461.                     Ref: \'AWS::Region\',\n462.                   },\n463.                   {\n464.                     Ref: \'AWS::AccountId\',\n465.                   },\n466.                   \'MyQueue\',\n467.                 ],\n468.               ],\n469.             },\n470.           ],\n471.         });\n472.         expect(\n473.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n474.             .FirstEventSourceMappingSQSSomeQueue.Properties.EventSourceArn\n475.         ).to.deep.equal({ \'Fn::GetAtt\': [\'SomeQueue\', \'Arn\'] });\n476.         expect(\n477.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n478.             .FirstEventSourceMappingSQSForeignQueue.Properties.EventSourceArn\n479.         ).to.deep.equal({ \'Fn::ImportValue\': \'ForeignQueue\' });\n480.         expect(\n481.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n482.             .FirstEventSourceMappingSQSMyQueue.Properties.EventSourceArn\n483.         ).to.deep.equal({\n484.           \'Fn::Join\': [\n485.             \':\',\n486.             [\n487.               \'arn\',\n488.               \'aws\',\n489.               \'sqs\',\n490.               {\n491.                 Ref: \'AWS::Region\',\n492.               },\n493.               {\n494.                 Ref: \'AWS::AccountId\',\n495.               },\n496.               \'MyQueue\',\n497.             ],\n498.           ],\n499.         });\n500.       });\n\n\nFile: lib/plugins/aws/package/compile/events/sqs/index.test.js\nLine number range: 521 - 552\nContent:\n521.       it(\'should add the necessary IAM role statements\', () => {\n522.         awsCompileSQSEvents.serverless.service.functions = {\n523.           first: {\n524.             events: [\n525.               {\n526.                 sqs: \'arn:aws:sqs:region:account:MyFirstQueue\',\n527.               },\n528.               {\n529.                 sqs: \'arn:aws:sqs:region:account:MySecondQueue\',\n530.               },\n531.             ],\n532.           },\n533.         };\n534. \n535.         const iamRoleStatements = [\n536.           {\n537.             Effect: \'Allow\',\n538.             Action: [\'sqs:ReceiveMessage\', \'sqs:DeleteMessage\', \'sqs:GetQueueAttributes\'],\n539.             Resource: [\n540.               \'arn:aws:sqs:region:account:MyFirstQueue\',\n541.               \'arn:aws:sqs:region:account:MySecondQueue\',\n542.             ],\n543.           },\n544.         ];\n545. \n546.         awsCompileSQSEvents.compileSQSEvents();\n547. \n548.         expect(\n549.           awsCompileSQSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n550.             .IamRoleLambdaExecution.Properties.Policies[0].PolicyDocument.Statement\n551.         ).to.deep.equal(iamRoleStatements);\n552.       });\n\n\nFile: lib/plugins/aws/package/index.test.js\nLine number range: 1 - 167\nContent:\n1. \'use strict\';\n2. \n3. const AwsProvider = require(\'../provider/awsProvider\');\n4. const AwsPackage = require(\'./index\');\n5. const Serverless = require(\'../../../Serverless\');\n6. const CLI = require(\'../../../classes/CLI\');\n7. const expect = require(\'chai\').expect;\n8. const sinon = require(\'sinon\');\n9. const path = require(\'path\');\n10. \n11. describe(\'AwsPackage\', () => {\n12.   let awsPackage;\n13.   let serverless;\n14.   let options;\n15. \n16.   beforeEach(() => {\n17.     serverless = new Serverless();\n18.     options = {\n19.       stage: \'dev\',\n20.       region: \'us-east-1\',\n21.     };\n22.     serverless.setProvider(\'aws\', new AwsProvider(serverless, options));\n23.     serverless.config.servicePath = \'foo\';\n24.     serverless.cli = new CLI(serverless);\n25.     awsPackage = new AwsPackage(serverless, options);\n26.   });\n27. \n28.   describe(\'#constructor()\', () => {\n29.     it(\'should set the serverless instance\', () => {\n30.       expect(awsPackage.serverless).to.equal(serverless);\n31.     });\n32. \n33.     it(\'should set options\', () => {\n34.       expect(awsPackage.options).to.equal(options);\n35.     });\n36. \n37.     it(\'should set the service path if provided\', () => {\n38.       expect(awsPackage.servicePath).to.equal(\'foo\');\n39.     });\n40. \n41.     it(\'should default to an empty service path if not provided\', () => {\n42.       serverless.config.servicePath = false;\n43.       awsPackage = new AwsPackage(serverless, options);\n44. \n45.       expect(awsPackage.servicePath).to.equal(\'\');\n46.     });\n47. \n48.     it(\'should use the options package path if provided\', () => {\n49.       options.package = \'package-options\';\n50.       awsPackage = new AwsPackage(serverless, options);\n51. \n52.       expect(awsPackage.packagePath).to.equal(\'package-options\');\n53.     });\n54. \n55.     it(\'should use the services package path if provided\', () => {\n56.       serverless.service = {\n57.         package: {\n58.           path: \'package-service\',\n59.         },\n60.       };\n61.       awsPackage = new AwsPackage(serverless, options);\n62. \n63.       expect(awsPackage.packagePath).to.equal(\'package-service\');\n64.     });\n65. \n66.     it(\'should default to the .serverless directory as the package path\', () => {\n67.       expect(awsPackage.packagePath).to.equal(path.join(\'foo\', \'.serverless\'));\n68.     });\n69. \n70.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n71.       expect(awsPackage.provider).to.be.instanceof(AwsProvider));\n72. \n73.     it(\'should have commands\', () => expect(awsPackage.commands).to.be.not.empty);\n74. \n75.     it(\'should have hooks\', () => expect(awsPackage.hooks).to.be.not.empty);\n76.   });\n77. \n78.   describe(\'hooks\', () => {\n79.     let spawnStub;\n80.     let generateCoreTemplateStub;\n81.     let mergeIamTemplatesStub;\n82.     let generateArtifactDirectoryNameStub;\n83.     let mergeCustomProviderResourcesStub;\n84.     let saveCompiledTemplateStub;\n85.     let saveServiceStateStub;\n86. \n87.     beforeEach(() => {\n88.       spawnStub = sinon.stub(serverless.pluginManager, \'spawn\');\n89.       generateCoreTemplateStub = sinon.stub(awsPackage, \'generateCoreTemplate\').resolves();\n90.       mergeIamTemplatesStub = sinon.stub(awsPackage, \'mergeIamTemplates\').resolves();\n91.       generateArtifactDirectoryNameStub = sinon\n92.         .stub(awsPackage, \'generateArtifactDirectoryName\')\n93.         .resolves();\n94.       mergeCustomProviderResourcesStub = sinon\n95.         .stub(awsPackage, \'mergeCustomProviderResources\')\n96.         .resolves();\n97.       saveCompiledTemplateStub = sinon.stub(awsPackage, \'saveCompiledTemplate\').resolves();\n98.       saveServiceStateStub = sinon.stub(awsPackage, \'saveServiceState\').resolves();\n99.     });\n100. \n101.     afterEach(() => {\n102.       serverless.pluginManager.spawn.restore();\n103.       awsPackage.generateCoreTemplate.restore();\n104.       awsPackage.mergeIamTemplates.restore();\n105.       awsPackage.generateArtifactDirectoryName.restore();\n106.       awsPackage.mergeCustomProviderResources.restore();\n107.       awsPackage.saveCompiledTemplate.restore();\n108.       awsPackage.saveServiceState.restore();\n109.     });\n110. \n111.     it(\'should run "package:cleanup" hook\', () => {\n112.       const spawnAwsCommonValidateStub = spawnStub.withArgs(\'aws:common:validate\').resolves();\n113.       const spawnAwsCommonCleanupTempDirStub = spawnStub\n114.         .withArgs(\'aws:common:cleanupTempDir\')\n115.         .resolves();\n116. \n117.       return awsPackage.hooks[\'package:cleanup\']().then(() => {\n118.         expect(spawnAwsCommonValidateStub.calledOnce).to.equal(true);\n119.         expect(spawnAwsCommonCleanupTempDirStub.calledAfter(spawnAwsCommonValidateStub)).to.equal(\n120.           true\n121.         );\n122.       });\n123.     });\n124. \n125.     it(\'should run "package:initialize" hook\', () =>\n126.       awsPackage.hooks[\'package:initialize\']().then(() => {\n127.         expect(generateCoreTemplateStub.calledOnce).to.equal(true);\n128.       }));\n129. \n130.     it(\'should run "package:setupProviderConfiguration" hook\', () =>\n131.       awsPackage.hooks[\'package:setupProviderConfiguration\']().then(() => {\n132.         expect(mergeIamTemplatesStub.calledOnce).to.equal(true);\n133.       }));\n134. \n135.     it(\'should run "before:package:compileFunctions" hook\', () =>\n136.       awsPackage.hooks[\'before:package:compileFunctions\']().then(() => {\n137.         expect(generateArtifactDirectoryNameStub.calledOnce).to.equal(true);\n138.       }));\n139. \n140.     it(\'should run "package:finalize" hook\', () => {\n141.       const spawnAwsPackageFinalzeStub = spawnStub.withArgs(\'aws:package:finalize\').resolves();\n142. \n143.       return awsPackage.hooks[\'package:finalize\']().then(() => {\n144.         expect(spawnAwsPackageFinalzeStub.calledOnce).to.equal(true);\n145.       });\n146.     });\n147. \n148.     it(\'should run "aws:package:finalize:mergeCustomProviderResources" hook\', () =>\n149.       awsPackage.hooks[\'aws:package:finalize:mergeCustomProviderResources\']().then(() => {\n150.         expect(mergeCustomProviderResourcesStub.calledOnce).to.equal(true);\n151.       }));\n152. \n153.     it(\'should run "aws:package:finalize:saveServiceState" hook\', () => {\n154.       const spawnAwsCommonMoveArtifactsToPackageStub = spawnStub\n155.         .withArgs(\'aws:common:moveArtifactsToPackage\')\n156.         .resolves();\n157. \n158.       return awsPackage.hooks[\'aws:package:finalize:saveServiceState\']().then(() => {\n159.         expect(saveCompiledTemplateStub.calledOnce).to.equal(true);\n160.         expect(saveServiceStateStub.calledAfter(saveCompiledTemplateStub)).to.equal(true);\n161.         expect(spawnAwsCommonMoveArtifactsToPackageStub.calledAfter(saveServiceStateStub)).to.equal(\n162.           true\n163.         );\n164.       });\n165.     });\n166.   });\n167. });\n\n\nFile: tests/integration-all/sns/tests.js\nLine number range: 1 - 16\nContent:\n1. \'use strict\';\n2. \n3. const path = require(\'path\');\n4. const BbPromise = require(\'bluebird\');\n5. const { expect } = require(\'chai\');\n6. \n7. const { getTmpDirPath } = require(\'../../utils/fs\');\n8. const { createSnsTopic, removeSnsTopic, publishSnsMessage } = require(\'../../utils/sns\');\n9. const {\n10.   createTestService,\n11.   deployService,\n12.   removeService,\n13.   waitForFunctionLogs,\n14. } = require(\'../../utils/integration\');\n15. const { getMarkers } = require(\'../shared/utils\');\n16. \n\n\nFile: tests/integration-all/sns/tests.js\nLine number range: 27 - 58\nContent:\n27.   before(async () => {\n28.     tmpDirPath = getTmpDirPath();\n29.     console.info(`Temporary path: ${tmpDirPath}`);\n30.     const serverlessConfig = await createTestService(tmpDirPath, {\n31.       templateDir: path.join(__dirname, \'service\'),\n32.       filesToAdd: [path.join(__dirname, \'..\', \'shared\')],\n33.       serverlessConfigHook:\n34.         // Ensure unique topics (to avoid collision among concurrent CI runs)\n35.         config => {\n36.           minimalTopicName = `${config.service}-minimal`;\n37.           filteredTopicName = `${config.service}-filtered`;\n38.           const filteredDisplayName = `Integration Test: ${config.service}-filtered`;\n39.           existingTopicName = `${config.service}-existing`;\n40.           config.functions.snsMinimal.events[0].sns = minimalTopicName;\n41.           config.functions.snsMultipleFilteredLeft.events[0].sns.topicName = filteredTopicName;\n42.           config.functions.snsMultipleFilteredRight.events[0].sns.topicName = filteredTopicName;\n43.           config.functions.snsMultipleFilteredLeft.events[0].sns.displayName = filteredDisplayName;\n44.           config.functions.snsMultipleFilteredRight.events[0].sns.displayName = filteredDisplayName;\n45.           config.functions.snsExisting.events[0].sns.arn[\'Fn::Join\'][1][3] = existingTopicName;\n46.           config.functions.snsExisting.events[0].sns.topicName = existingTopicName;\n47.         },\n48.     });\n49.     serviceName = serverlessConfig.service;\n50.     stackName = `${serviceName}-${stage}`;\n51.     // create "existing" SNS topics\n52.     // NOTE: deployment can only be done once the SNS topics are created\n53.     console.info(`Creating SNS topic "${existingTopicName}"...`);\n54.     return createSnsTopic(existingTopicName).then(() => {\n55.       console.info(`Deploying "${stackName}" service...`);\n56.       return deployService(tmpDirPath);\n57.     });\n58.   });\n\n\nFile: tests/integration-all/sns/tests.js\nLine number range: 67 - 80\nContent:\n67.   describe(\'Minimal Setup\', () => {\n68.     it(\'should invoke on a topic message\', () => {\n69.       const functionName = \'snsMinimal\';\n70.       const markers = getMarkers(functionName);\n71.       const message = \'Hello from SNS!\';\n72. \n73.       return publishSnsMessage(minimalTopicName, message)\n74.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n75.         .then(logs => {\n76.           expect(logs).to.include(functionName);\n77.           expect(logs).to.include(message);\n78.         });\n79.     });\n80.   });\n\n\nFile: tests/integration-all/sns/tests.js\nLine number range: 82 - 127\nContent:\n82.   describe(\'Multiple and Filtered Setup\', () => {\n83.     it(\'should invoke on a topic message that matches filter\', () => {\n84.       const leftFunctionName = \'snsMultipleFilteredLeft\';\n85.       const leftMarkers = getMarkers(leftFunctionName);\n86.       const rightFunctionName = \'snsMultipleFilteredRight\';\n87.       const rightMarkers = getMarkers(rightFunctionName);\n88.       const leftMessage = \'Hello to the left-side from SNS!\';\n89.       const rightMessage = \'Hello to the right-side from SNS!\';\n90.       const middleMessage = \'Hello to the middle-side from SNS!\';\n91.       const leftAttributes = { side: { DataType: \'String\', StringValue: \'left\' } };\n92.       const middleAttributes = { side: { DataType: \'String\', StringValue: \'middle\' } };\n93.       const rightAttributes = { side: { DataType: \'String\', StringValue: \'right\' } };\n94. \n95.       return BbPromise.all([\n96.         publishSnsMessage(filteredTopicName, leftMessage, leftAttributes),\n97.         publishSnsMessage(filteredTopicName, middleMessage, middleAttributes),\n98.         publishSnsMessage(filteredTopicName, rightMessage, rightAttributes),\n99.       ])\n100.         .then(() =>\n101.           BbPromise.all([\n102.             waitForFunctionLogs(tmpDirPath, leftFunctionName, leftMarkers.start, leftMarkers.end),\n103.             waitForFunctionLogs(\n104.               tmpDirPath,\n105.               rightFunctionName,\n106.               rightMarkers.start,\n107.               rightMarkers.end\n108.             ),\n109.           ])\n110.         )\n111.         .then(logs => {\n112.           const leftLogs = logs[0];\n113.           const rightLogs = logs[1];\n114.           // left side is filtered to only get "left" messages from topic:\n115.           expect(leftLogs).to.include(leftFunctionName);\n116.           expect(leftLogs).to.include(leftMessage);\n117.           expect(leftLogs).not.to.include(middleMessage);\n118.           expect(leftLogs).not.to.include(rightMessage);\n119.           // right side is filtered to only get "right" messages from topic:\n120.           expect(rightLogs).to.include(rightFunctionName);\n121.           expect(rightLogs).not.to.include(leftMessage);\n122.           expect(rightLogs).not.to.include(middleMessage);\n123.           expect(rightLogs).to.include(rightMessage);\n124.           // "middle" messages will not cause an invocation.\n125.         });\n126.     });\n127.   });\n\n\nFile: tests/integration-all/sns/tests.js\nLine number range: 129 - 142\nContent:\n129.   describe(\'Existing Setup\', () => {\n130.     it(\'should invoke on an existing topic message\', () => {\n131.       const functionName = \'snsExisting\';\n132.       const markers = getMarkers(functionName);\n133.       const message = \'Hello from an existing SNS!\';\n134. \n135.       return publishSnsMessage(existingTopicName, message)\n136.         .then(() => waitForFunctionLogs(tmpDirPath, functionName, markers.start, markers.end))\n137.         .then(logs => {\n138.           expect(logs).to.include(functionName);\n139.           expect(logs).to.include(message);\n140.         });\n141.     });\n142.   });\n\n\nNow generate the complete self-contained test case that reproduces the bug with the same error/exception.\n' additional_kwargs={} response_metadata={}
2025-11-13 20:36:26,323 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_z71Br0KOgfLuv24GOUu7ReTu', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 420, 'prompt_tokens': 18924, 'total_tokens': 19344, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--652abba4-a556-4feb-944c-eed6ef403f7f-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_z71Br0KOgfLuv24GOUu7ReTu', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18924, 'output_tokens': 420, 'total_tokens': 19344, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 20:36:28,527 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_KpCaZ1egFrccmaDMzJQyPFG3', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 23461, 'total_tokens': 23491, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9b86565e-731a-4a83-ae70-b575872f0933-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_KpCaZ1egFrccmaDMzJQyPFG3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23461, 'output_tokens': 30, 'total_tokens': 23491, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:30,772 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Dq7CrDb781wsBSPg0MvZznkH', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 27998, 'total_tokens': 28028, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--91f30991-863e-4190-b710-d4031ae592be-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_Dq7CrDb781wsBSPg0MvZznkH', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27998, 'output_tokens': 30, 'total_tokens': 28028, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:34,101 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HWnhvf9Bw2yx2Rqj2Ilm6PBO', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 32535, 'total_tokens': 32565, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--13e4189b-dbb6-4e9e-901b-e5e5b909ba78-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_HWnhvf9Bw2yx2Rqj2Ilm6PBO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 32535, 'output_tokens': 30, 'total_tokens': 32565, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:35,930 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_d3Fux43kVLw8IuYEVjQdWo35', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 37072, 'total_tokens': 37102, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18816}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4870a3de-fd47-4aff-816e-1a61b152c560-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_d3Fux43kVLw8IuYEVjQdWo35', 'type': 'tool_call'}] usage_metadata={'input_tokens': 37072, 'output_tokens': 30, 'total_tokens': 37102, 'input_token_details': {'audio': 0, 'cache_read': 18816}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:41,869 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_M1ObAmo49mtSkPmkhYUyZBSM', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 355, 'prompt_tokens': 41609, 'total_tokens': 41964, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ad2466f7-339a-4f9e-809c-b49c40f9b9ac-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js'}, 'id': 'call_M1ObAmo49mtSkPmkhYUyZBSM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 41609, 'output_tokens': 355, 'total_tokens': 41964, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:36:59,851 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content="'use strict';\n\nconst expect = require('chai').expect;\nconst AwsProvider = require('../../../../provider/awsProvider');\nconst AwsCompileSNSEvents = require('./index');\nconst Serverless = require('../../../../../../Serverless');\n\ndescribe('AwsCompileSNSEvents - redrivePolicy QueuePolicy', () => {\n  let serverless;\n  let awsCompileSNSEvents;\n\n  beforeEach(() => {\n    serverless = new Serverless();\n    const options = { region: 'some-region' };\n    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n    serverless.setProvider('aws', new AwsProvider(serverless));\n    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\n  });\n\n  it('should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined', () => {\n    awsCompileSNSEvents.serverless.service.functions = {\n      first: {\n        events: [\n          {\n            sns: {\n              topicName: 'Topic 1',\n              displayName: 'Display name for topic 1',\n              redrivePolicy: {\n                deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] },\n              },\n            },\n          },\n        ],\n      },\n    };\n\n    Object.assign(\n      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n      {\n        SNSDLQ: {\n          Type: 'AWS::SQS::Queue',\n          Properties: { QueueName: 'SNSDLQ' },\n        },\n      }\n    );\n\n    awsCompileSNSEvents.compileSNSEvents();\n\n    expect(\n      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n        .FirstEventSourceMappingSQSTopic1DLQ.Properties.Queues\n    ).to.deep.equal([{ Ref: 'SNSDLQ' }]);\n  });\n})" additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2063, 'prompt_tokens': 44008, 'total_tokens': 46071, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1664, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 32512}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--2d690e40-8b0f-44fd-bc9f-7d5b22bacc0f-0' usage_metadata={'input_tokens': 44008, 'output_tokens': 2063, 'total_tokens': 46071, 'input_token_details': {'audio': 0, 'cache_read': 32512}, 'output_token_details': {'audio': 0, 'reasoning': 1664}}
2025-11-13 20:37:17,535 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xAapu3azwv7z893R31aJcnDC', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/common/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1055, 'prompt_tokens': 11817, 'total_tokens': 12872, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1024, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fc2e79b9-54b2-4aeb-b213-f5462903cd29-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/common/index.test.js'}, 'id': 'call_xAapu3azwv7z893R31aJcnDC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11817, 'output_tokens': 1055, 'total_tokens': 12872, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1024}}
2025-11-13 20:37:20,734 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_YTledD0Rj1CZ9c9sTkJAjZBk', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 96, 'prompt_tokens': 12954, 'total_tokens': 13050, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8fd366a1-f7e4-4153-bca5-2d8e9f6b6227-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/index.js'}, 'id': 'call_YTledD0Rj1CZ9c9sTkJAjZBk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12954, 'output_tokens': 96, 'total_tokens': 13050, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:37:22,093 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OLUosIBXnLHy0Dht2pM9ijRG', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 24, 'prompt_tokens': 13004, 'total_tokens': 13028, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c162ca67-cf4d-4ef1-acdc-6ffaaa4178d2-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/index.js'}, 'id': 'call_OLUosIBXnLHy0Dht2pM9ijRG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13004, 'output_tokens': 24, 'total_tokens': 13028, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:24,723 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ZGBdLntSzSOZoZ3rIYdkgre6', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 99, 'prompt_tokens': 13827, 'total_tokens': 13926, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12928}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--36063732-442f-4312-8821-ae10ae0b87ad-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js'}, 'id': 'call_ZGBdLntSzSOZoZ3rIYdkgre6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13827, 'output_tokens': 99, 'total_tokens': 13926, 'input_token_details': {'audio': 0, 'cache_read': 12928}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:37:33,418 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5DzhotJS3PkWQM9LHP8dwgDp', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 868, 'prompt_tokens': 16226, 'total_tokens': 17094, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4979be79-18e4-48fc-9369-8443e9cd9ef3-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_5DzhotJS3PkWQM9LHP8dwgDp', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16226, 'output_tokens': 868, 'total_tokens': 17094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 20:37:35,327 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0kko1QMIqqtmy8uGjwDb8bQC', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 20763, 'total_tokens': 20793, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f4b3321b-4891-42e4-a71a-9961ee6455c8-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_0kko1QMIqqtmy8uGjwDb8bQC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 20763, 'output_tokens': 30, 'total_tokens': 20793, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:37,077 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nssuw0WVOzsn0nmO0BVseivd', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 25300, 'total_tokens': 25330, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0f802f4a-1ca6-409a-ad04-550f4a4cc82b-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_nssuw0WVOzsn0nmO0BVseivd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25300, 'output_tokens': 30, 'total_tokens': 25330, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:38,604 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_lLRdAJb9ySmLe64Gynvy5NnC', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 29837, 'total_tokens': 29867, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 20736}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c64e30fe-5b56-4358-ad13-da022d1a6b05-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_lLRdAJb9ySmLe64Gynvy5NnC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29837, 'output_tokens': 30, 'total_tokens': 29867, 'input_token_details': {'audio': 0, 'cache_read': 20736}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:42,363 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JOTYtI0yrBSPHtjpGzSewrgu', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 34374, 'total_tokens': 34404, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d32143be-e857-4635-ae59-5f3b112fd953-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js'}, 'id': 'call_JOTYtI0yrBSPHtjpGzSewrgu', 'type': 'tool_call'}] usage_metadata={'input_tokens': 34374, 'output_tokens': 30, 'total_tokens': 34404, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:50,154 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_jMDpKhmDNAlVL1GRnTGxKmSr', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 543, 'prompt_tokens': 38911, 'total_tokens': 39454, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 13824}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5764dcb5-5aed-44c2-8440-575b2b152cf9-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.js'}, 'id': 'call_jMDpKhmDNAlVL1GRnTGxKmSr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 38911, 'output_tokens': 543, 'total_tokens': 39454, 'input_token_details': {'audio': 0, 'cache_read': 13824}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:38:07,554 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XLH2aAoBj7uCjVp9noiPLZWz', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js","content":"\'use strict\';\\n\\nconst expect = require(\'chai\').expect;\\nconst AwsProvider = require(\'../../../../provider/awsProvider\');\\nconst AwsCompileSNSEvents = require(\'./index\');\\nconst Serverless = require(\'../../../../../../Serverless\');\\n\\ndescribe(\'AwsCompileSNSEvents - redrivePolicy QueuePolicy\', () => {\\n  let serverless;\\n  let awsCompileSNSEvents;\\n\\n  beforeEach(() => {\\n    serverless = new Serverless();\\n    const options = { region: \'some-region\' };\\n    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\\n    serverless.setProvider(\'aws\', new AwsProvider(serverless));\\n    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\\n  });\\n\\n  it(\'should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined\', () => {\\n    awsCompileSNSEvents.serverless.service.functions = {\\n      first: {\\n        events: [\\n          {\\n            sns: {\\n              topicName: \'Topic 1\',\\n              displayName: \'Display name for topic 1\',\\n              redrivePolicy: {\\n                deadLetterTargetArn: { \'Fn::GetAtt\': [\'SNSDLQ\', \'Arn\'] },\\n              },\\n            },\\n          },\\n        ],\\n      },\\n    };\\n\\n    Object.assign(\\n      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\\n      {\\n        SNSDLQ: {\\n          Type: \'AWS::SQS::Queue\',\\n          Properties: { QueueName: \'SNSDLQ\' },\\n        },\\n      }\\n    );\\n\\n    awsCompileSNSEvents.compileSNSEvents();\\n\\n    expect(\\n      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\\n        .FirstEventSourceMappingSQSTopic1DLQ.Properties.Queues\\n    ).to.deep.equal([{ Ref: \'SNSDLQ\' }]);\\n  });\\n})\\n"}', 'name': 'create_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1983, 'prompt_tokens': 43923, 'total_tokens': 45906, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b05f7642-e25c-47f0-a05f-e0af19a1ad99-0' tool_calls=[{'name': 'create_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js', 'content': "'use strict';\n\nconst expect = require('chai').expect;\nconst AwsProvider = require('../../../../provider/awsProvider');\nconst AwsCompileSNSEvents = require('./index');\nconst Serverless = require('../../../../../../Serverless');\n\ndescribe('AwsCompileSNSEvents - redrivePolicy QueuePolicy', () => {\n  let serverless;\n  let awsCompileSNSEvents;\n\n  beforeEach(() => {\n    serverless = new Serverless();\n    const options = { region: 'some-region' };\n    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n    serverless.setProvider('aws', new AwsProvider(serverless));\n    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\n  });\n\n  it('should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined', () => {\n    awsCompileSNSEvents.serverless.service.functions = {\n      first: {\n        events: [\n          {\n            sns: {\n              topicName: 'Topic 1',\n              displayName: 'Display name for topic 1',\n              redrivePolicy: {\n                deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] },\n              },\n            },\n          },\n        ],\n      },\n    };\n\n    Object.assign(\n      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n      {\n        SNSDLQ: {\n          Type: 'AWS::SQS::Queue',\n          Properties: { QueueName: 'SNSDLQ' },\n        },\n      }\n    );\n\n    awsCompileSNSEvents.compileSNSEvents();\n\n    expect(\n      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n        .FirstEventSourceMappingSQSTopic1DLQ.Properties.Queues\n    ).to.deep.equal([{ Ref: 'SNSDLQ' }]);\n  });\n})\n"}, 'id': 'call_XLH2aAoBj7uCjVp9noiPLZWz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 43923, 'output_tokens': 1983, 'total_tokens': 45906, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-13 20:38:09,482 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 18, 'prompt_tokens': 44458, 'total_tokens': 44476, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 16128}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--f99cb3e5-560d-4273-8223-58914d69ac7d-0' usage_metadata={'input_tokens': 44458, 'output_tokens': 18, 'total_tokens': 44476, 'input_token_details': {'audio': 0, 'cache_read': 16128}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:38:09,557 - thread-135845298308800.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
new file mode 100644
index 000000000..b181704ad
--- /dev/null
+++ b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
@@ -0,0 +1,54 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileSNSEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileSNSEvents - redrivePolicy QueuePolicy', () => {
+  let serverless;
+  let awsCompileSNSEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    const options = { region: 'some-region' };
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
+  });
+
+  it('should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined', () => {
+    awsCompileSNSEvents.serverless.service.functions = {
+      first: {
+        events: [
+          {
+            sns: {
+              topicName: 'Topic 1',
+              displayName: 'Display name for topic 1',
+              redrivePolicy: {
+                deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] },
+              },
+            },
+          },
+        ],
+      },
+    };
+
+    Object.assign(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
+      {
+        SNSDLQ: {
+          Type: 'AWS::SQS::Queue',
+          Properties: { QueueName: 'SNSDLQ' },
+        },
+      }
+    );
+
+    awsCompileSNSEvents.compileSNSEvents();
+
+    expect(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
+        .FirstEventSourceMappingSQSTopic1DLQ.Properties.Queues
+    ).to.deep.equal([{ Ref: 'SNSDLQ' }]);
+  });
+})

2025-11-13 20:38:09,559 - thread-135845298308800.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:38:09,593 - thread-135845298308800.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:38:09,593 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:38:09,832 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:09,832 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at c09f71897 fix: Ensure AWS env vars in local invocation made with docker (#7349)
[?2004l
2025-11-13 20:38:09,832 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:38:09,933 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:09,934 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:38:09,934 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:38:09,934 - thread-135845298308800.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/sns in the container
2025-11-13 20:38:09,934 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/sns
2025-11-13 20:38:10,036 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:10,036 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:38:10,036 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js in the container
2025-11-13 20:38:10,045 - thread-135845298308800.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:38:13,563 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PuX8UxgOfhqUfFCORNNiQ9oY', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 282, 'prompt_tokens': 624, 'total_tokens': 906, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ed71bbb2-0a61-4804-8229-692e558fc638-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_PuX8UxgOfhqUfFCORNNiQ9oY', 'type': 'tool_call'}] usage_metadata={'input_tokens': 624, 'output_tokens': 282, 'total_tokens': 906, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:38:13,567 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:38:13,668 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:13,668 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1348
drwxr-xr-x   1 root root    4096 Nov 13 20:38 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:38 [01;34m..[0m
-rw-r--r--   1 root root      35 Nov 13 20:38 .codecov.yml
-rw-r--r--   1 root root     273 Nov 13 20:38 .editorconfig
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34m.git[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34m.github[0m
-rwxr-xr-x   1 root root      90 Nov 13 20:38 [01;32m.gitignore[0m
-rw-r--r--   1 root root   13275 Nov 13 20:38 .travis.yml
-rw-r--r--   1 root root    5152 Nov 13 20:38 0.5.x-RESOURCES.md
-rw-r--r--   1 root root  124479 Nov 13 20:38 CHANGELOG.md
-rw-r--r--   1 root root    3292 Nov 13 20:38 CODE_OF_CONDUCT.md
-rw-r--r--   1 root root    4867 Nov 13 20:38 CONTRIBUTING.md
-rw-r--r--   1 root root     324 Nov 13 20:38 Dockerfile
-rw-r--r--   1 root root    1086 Nov 13 20:38 LICENSE.txt
-rw-r--r--   1 root root   13197 Nov 13 20:38 README.md
-rw-r--r--   1 root root    7651 Nov 13 20:38 README_CN.md
-rw-r--r--   1 root root    5539 Nov 13 20:38 RELEASE_PROCESS.md
-rw-r--r--   1 root root    3896 Nov 13 20:38 VERSIONING.md
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34massets[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mbin[0m
-rw-r--r--   1 root root     924 Nov 13 20:38 commitlint.config.js
-rw-r--r--   1 root root    3970 Nov 13 20:38 docker-compose.yml
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mdocs[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mlib[0m
drwxr-xr-x 829 root root   28672 Aug 28 02:06 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1042361 Aug 28 02:06 package-lock.json
-rw-r--r--   1 root root    6325 Nov 13 20:38 package.json
-rw-r--r--   1 root root      86 Nov 13 20:38 prettier.config.js
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mscripts[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mtests[0m
[?2004l
2025-11-13 20:38:15,633 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_c6PSC6uPmnMjev7yCW2NdQzC', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 154, 'prompt_tokens': 1566, 'total_tokens': 1720, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 128, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--15bf464c-831f-406c-9cdd-7a8e4643162d-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_c6PSC6uPmnMjev7yCW2NdQzC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1566, 'output_tokens': 154, 'total_tokens': 1720, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 128}}
2025-11-13 20:38:15,636 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:38:15,737 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:15,737 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.64.0",
  "engines": {
    "node": ">=6.0"
  },
  "engineStrict": true,
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "author": "serverless.com",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/serverless/serverless"
  },
  "keywords": [
    "serverless",
    "serverless framework",
    "serverless applications",
    "serverless modules",
    "api gateway",
    "lambda",
    "aws",
    "aws lambda",
    "amazon",
    "amazon web services",
    "azure",
    "azure functions",
    "google cloud functions",
    "apache open whisk",
    "iot",
    "internet of things",
    "serverless.com"
  ],
  "files": [
    "bin",
    "lib",
    "scripts/postinstall.js",
    "scripts/preuninstall.js",
    "scripts/pre-release.js",
    "package.json",
    "README.md",
    "LICENSE.txt",
    "CHANGELOG.md"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "commitlint:pull-request": "commitlint -f HEAD~1",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node tests/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 tests/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha tests/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check tests/integration-package/**/*.tests.js",
    "lint": "eslint . --cache",
    "lint:fix": "npm run lint -- --fix",
    "lint:updated": "pipe-git-updated --ext=js -- eslint --cache",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c --ignore-path .gitignore \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write --ignore-path .gitignore \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/*"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "lib/plugins/create/templates/**",
    "lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./tests/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "tests/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    }
  },
  "devDependencies": {
    "@commitlint/cli": "^8.3.5",
    "@serverless/eslint-config": "^1.2.1",
    "@serverless/test": "^3.5.2",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "eslint": "^6.8.0",
    "eslint-plugin-import": "^2.20.1",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "log": "^6.0.0",
    "mocha": "^6.2.2",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^14.1.1",
    "pkg": "^4.4.3",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^7.5.0",
    "sinon-chai": "^3.4.0",
    "standard-version": "^7.1.0",
    "strip-ansi": "^5.2.0",
    "ws": "^7.2.1",
    "xml2js": "^0.4.23"
  },
  "dependencies": {
    "@serverless/cli": "^1.4.0",
    "@serverless/enterprise-plugin": "^3.4.0",
    "archiver": "^1.3.0",
    "async": "^1.5.2",
    "aws-sdk": "^2.620.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.0",
    "ci-info": "^1.6.0",
    "d": "^1.0.1",
    "dayjs": "^1.8.20",
    "decompress": "^4.2.0",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^0.30.0",
    "get-stdin": "^5.0.1",
    "globby": "^6.1.0",
    "graceful-fs": "^4.2.3",
    "https-proxy-agent": "^4.0.0",
    "inquirer": "^6.5.2",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.1.1",
    "js-yaml": "^3.13.1",
    "json-cycle": "^1.3.0",
    "json-refs": "^2.1.7",
    "jszip": "^3.2.2",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.15",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.1",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.0.1",
    "node-fetch": "^1.7.3",
    "object-hash": "^1.3.1",
    "p-limit": "^2.2.2",
    "promise-queue": "^2.2.5",
    "raven": "^1.2.1",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^5.7.1",
    "semver-regex": "^1.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^2.0.3",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^16.1.0"
  }
}
[?2004l
2025-11-13 20:38:22,421 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_huuGROgv957WwxoybomrPh34', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 296, 'prompt_tokens': 3770, 'total_tokens': 4066, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fc9a673a-0241-4244-b2a3-c1e1199ed74e-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js'}, 'id': 'call_huuGROgv957WwxoybomrPh34', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3770, 'output_tokens': 296, 'total_tokens': 4066, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:38:22,425 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
2025-11-13 20:38:23,822 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 1
2025-11-13 20:38:23,822 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/sns/
/redrivePolicy.test.js
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents - redrivePolicy QueuePolicy[0m
  [31m  1) should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined[0m


[92m [0m[32m 0 passing[0m[90m (20ms)[0m
[31m  1 failing[0m

[0m  1) AwsCompileSNSEvents - redrivePolicy QueuePolicy
       should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined:

      [31mAssertionError: expected [ Array(1) ] to deeply equal [ { Ref: 'SNSDLQ' } ][0m
      [32m+ expected[0m [31m- actual[0m

       [
         {
      [31m-    "Fn::GetAtt": [[0m
      [31m-      "SNSDLQ"[0m
      [31m-      "Arn"[0m
      [31m-    ][0m
      [32m+    "Ref": "SNSDLQ"[0m
         }
       ]
      [0m[90m
      at Context.<anonymous> (lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js:52:15)
      at processTicksAndRejections (node:internal/process/task_queues:78:11)
[0m


(node:298) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m 
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m New [31mmajor[39m version of npm available! [31m8.19.4[39m -> [32m11.6.2[39m
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m Changelog: [36mhttps://github.com/npm/cli/releases/tag/v11.6.2[39m
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m Run [32mnpm install -g npm@11.6.2[39m to update!
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m 
[?2004l
2025-11-13 20:38:32,158 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content=' npx mocha lib/plugins/aws/package/compile/events/sns/\n/redrivePolicy.test.js\n\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileSNSEvents - redrivePolicy QueuePolicy\x1b[0m\n  \x1b[31m  1) should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 0 passing\x1b[0m\x1b[90m (20ms)\x1b[0m\n\x1b[31m  1 failing\x1b[0m\n\n\x1b[0m  1) AwsCompileSNSEvents - redrivePolicy QueuePolicy\n       should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined:\n\n      \x1b[31mAssertionError: expected [ Array(1) ] to deeply equal [ { Ref: \'SNSDLQ\' } ]\x1b[0m\n      \x1b[32m+ expected\x1b[0m \x1b[31m- actual\x1b[0m\n\n       [\n         {\n      \x1b[31m-    "Fn::GetAtt": [\x1b[0m\n      \x1b[31m-      "SNSDLQ"\x1b[0m\n      \x1b[31m-      "Arn"\x1b[0m\n      \x1b[31m-    ]\x1b[0m\n      \x1b[32m+    "Ref": "SNSDLQ"\x1b[0m\n         }\n       ]\n      \x1b[0m\x1b[90m\n      at Context.<anonymous> (lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js:52:15)\n      at processTicksAndRejections (node:internal/process/task_queues:78:11)\n\x1b[0m\n\n\n(node:298) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n\x1b[37;40mnpm\x1b[0m \x1b[0m\x1b[36;40mnotice\x1b[0m\x1b[35m\x1b[0m \n\x1b[0m\x1b[37;40mnpm\x1b[0m \x1b[0m\x1b[36;40mnotice\x1b[0m\x1b[35m\x1b[0m New \x1b[31mmajor\x1b[39m version of npm available! \x1b[31m8.19.4\x1b[39m -> \x1b[32m11.6.2\x1b[39m\n\x1b[0m\x1b[37;40mnpm\x1b[0m \x1b[0m\x1b[36;40mnotice\x1b[0m\x1b[35m\x1b[0m Changelog: \x1b[36mhttps://github.com/npm/cli/releases/tag/v11.6.2\x1b[39m\n\x1b[0m\x1b[37;40mnpm\x1b[0m \x1b[0m\x1b[36;40mnotice\x1b[0m\x1b[35m\x1b[0m Run \x1b[32mnpm install -g npm@11.6.2\x1b[39m to update!\n\x1b[0m\x1b[37;40mnpm\x1b[0m \x1b[0m\x1b[36;40mnotice\x1b[0m\x1b[35m\x1b[0m' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1096, 'prompt_tokens': 4594, 'total_tokens': 5690, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--0fc81ba8-47b3-47d0-9077-33e9667a51d4-0' usage_metadata={'input_tokens': 4594, 'output_tokens': 1096, 'total_tokens': 5690, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:38:54,954 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproducing_structured_node - DEBUG - reproduced_bug=True reproduced_bug_failure_log='npx mocha lib/plugins/aws/package/compile/events/sns/\n/redrivePolicy.test.js\n\n\n  AwsCompileSNSEvents - redrivePolicy QueuePolicy\n    1) should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined\n\n\n  0 passing (20ms)\n  1 failing\n\n  1) AwsCompileSNSEvents - redrivePolicy QueuePolicy\n       should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined:\n\n      AssertionError: expected [ Array(1) ] to deeply equal [ { Ref: \'SNSDLQ\' } ]\n      + expected - actual\n\n       [\n         {\n-    "Fn::GetAtt": [\n-      "SNSDLQ"\n-      "Arn"\n-    ]\n+    "Ref": "SNSDLQ"\n         }\n       ]\n\n      at Context.<anonymous> (lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js:52:15)\n      at processTicksAndRejections (node:internal/process/task_queues:78:11)\n\n\n(node:298) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\nnpm notice \nnpm notice New major version of npm available! 8.19.4 -> 11.6.2\nnpm notice Changelog: https://github.com/npm/cli/releases/tag/v11.6.2\nnpm notice Run npm install -g npm@11.6.2 to update!\nnpm notice ' reproduced_bug_commands=['npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js']
2025-11-13 20:38:54,986 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug: True
2025-11-13 20:38:54,986 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug_file: lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
2025-11-13 20:38:54,986 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug_commands: ['npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js']
2025-11-13 20:38:54,986 - thread-135845298308800.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug_patch: diff --git a/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
new file mode 100644
index 000000000..b181704ad
--- /dev/null
+++ b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
@@ -0,0 +1,54 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileSNSEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileSNSEvents - redrivePolicy QueuePolicy', () => {
+  let serverless;
+  let awsCompileSNSEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    const options = { region: 'some-region' };
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
+  });
+
+  it('should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined', () => {
+    awsCompileSNSEvents.serverless.service.functions = {
+      first: {
+        events: [
+          {
+            sns: {
+              topicName: 'Topic 1',
+              displayName: 'Display name for topic 1',
+              redrivePolicy: {
+                deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] },
+              },
+            },
+          },
+        ],
+      },
+    };
+
+    Object.assign(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
+      {
+        SNSDLQ: {
+          Type: 'AWS::SQS::Queue',
+          Properties: { QueueName: 'SNSDLQ' },
+        },
+      }
+    );
+
+    awsCompileSNSEvents.compileSNSEvents();
+
+    expect(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
+        .FirstEventSourceMappingSQSTopic1DLQ.Properties.Queues
+    ).to.deep.equal([{ Ref: 'SNSDLQ' }]);
+  });
+})

2025-11-13 20:38:54,988 - thread-135845298308800.prometheus.lang_graph.nodes.issue_verified_bug_subgraph_node - INFO - Enter IssueVerifiedBugSubgraphNode
2025-11-13 20:38:54,991 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

2025-11-13 20:38:54,993 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 20:38:54,995 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:39:10,578 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The file tree shows the AWS packaging plugins but not their contents. The issue is about SNS event redrivePolicy incorrectly using the DLQ ARN for both the QueuePolicy Resource and Queues. To analyze and fix it, I need the production code that compiles SNS subscriptions and generates the related SQS QueuePolicy, along with naming utilities and the SNS event documentation.' query='Please provide the full content of lib/plugins/aws/package/compile/events/sns/index.js and any helper modules it imports.' extra_requirements='If that path doesn’t exist, please share the files responsible for compiling SNS event subscriptions and creating SQS QueuePolicy for redrivePolicy, plus lib/plugins/aws/lib/naming.js and docs/providers/aws/events/sns.md.' purpose='I need to trace how deadLetterTargetArn is used to build CloudFormation resources so I can correct it to use GetAtt for Resource and Ref for Queues.'
2025-11-13 20:39:10,580 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of lib/plugins/aws/package/compile/events/sns/index.js and any helper modules it imports.
2025-11-13 20:39:16,043 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 20:39:16,043 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 20:39:16,044 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 20:39:16,044 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 20:39:16,045 - thread-135845298308800.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 20:39:16,046 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 20:39:16,046 - thread-135845298308800.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of lib/plugins/aws/package/compile/events/sns/index.js and any helper modules it imports.
Extra requirements: If that path doesn’t exist, please share the files responsible for compiling SNS event subscriptions and creating SQS QueuePolicy for redrivePolicy, plus lib/plugins/aws/lib/naming.js and docs/providers/aws/events/sns.md.
Purpose: I need to trace how deadLetterTargetArn is used to build CloudFormation resources so I can correct it to use GetAtt for Resource and Ref for Queues.
2025-11-13 20:39:19,336 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pHTD7znlfwiVAYevLUQ1L9d3', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 231, 'prompt_tokens': 2287, 'total_tokens': 2518, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f5690fb1-098a-4ef7-a9a8-9007be9b2cde-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js'}, 'id': 'call_pHTD7znlfwiVAYevLUQ1L9d3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2287, 'output_tokens': 231, 'total_tokens': 2518, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:39:20,401 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9V4zbhSFHgG3ksCx4TBazhth', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 2373, 'total_tokens': 2407, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1b053988-b3a9-4436-86e4-7af7fa62db17-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js'}, 'id': 'call_9V4zbhSFHgG3ksCx4TBazhth', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2373, 'output_tokens': 34, 'total_tokens': 2407, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:39:32,436 - thread-135845298308800.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I located and read the full content of lib/plugins/aws/package/compile/events/sns/index.js. The file only imports lodash and otherwise relies on provider.naming methods (not imported locally) and serverless classes for errors. I confirmed how deadLetterTargetArn is used: it’s passed directly into RedrivePolicy and then used as both the QueuePolicy Resource and the Queues array value. No additional helper modules are imported by this file, so there was nothing else to fetch.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1066, 'prompt_tokens': 5257, 'total_tokens': 6323, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--96fce17a-b116-4838-8fba-339147dc1304-0' usage_metadata={'input_tokens': 5257, 'output_tokens': 1066, 'total_tokens': 6323, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 20:39:32,439 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of lib/plugins/aws/package/compile/events/sns/index.js and any helper modules it imports.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If that path doesn’t exist, please share the files responsible for compiling SNS event subscriptions and creating SQS QueuePolicy for redrivePolicy, plus lib/plugins/aws/lib/naming.js and docs/providers/aws/events/sns.md.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need to trace how deadLetterTargetArn is used to build CloudFormation resources so I can correct it to use GetAtt for Resource and Ref for Queues.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 1 - 267
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileSNSEvents {
6.   constructor(serverless, options) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9.     this.options = options;
10.     this.hooks = {
11.       'package:compileEvents': this.compileSNSEvents.bind(this),
12.     };
13.   }
14. 
15.   invalidPropertyErrorMessage(functionName, property) {
16.     return [
17.       `Missing or invalid ${property} property for sns event`,
18.       ` in function "${functionName}"`,
19.       ' The correct syntax is: sns: topic-name-or-arn',
20.       ' OR an object with ',
21.       ' arn and topicName OR',
22.       ' topicName and displayName.',
23.       ' Please check the docs for more info.',
24.     ].join('');
25.   }
26. 
27.   isValidStackImport(variable) {
28.     if (Object.keys(variable).length !== 1) {
29.       return false;
30.     }
31.     if (
32.       _.has(variable, 'Fn::ImportValue') &&
33.       (_.has(variable, 'Fn::ImportValue.Fn::GetAtt') || _.has(variable, 'Fn::ImportValue.Ref'))
34.     ) {
35.       return false;
36.     }
37.     const intrinsicFunctions = ['Fn::ImportValue', 'Ref', 'Fn::GetAtt', 'Fn::Sub', 'Fn::Join'];
38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));
39.   }
40. 
41.   compileSNSEvents() {
42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;
43. 
44.     this.serverless.service.getAllFunctions().forEach(functionName => {
45.       const functionObj = this.serverless.service.getFunction(functionName);
46. 
47.       if (functionObj.events) {
48.         functionObj.events.forEach(event => {
49.           if (event.sns) {
50.             let topicArn;
51.             let topicName;
52.             let region;
53.             let displayName = '';
54.             if (typeof event.sns === 'object') {
55.               if (event.sns.arn) {
56.                 topicArn = event.sns.arn;
57.                 if (typeof topicArn === 'object') {
58.                   if (!this.isValidStackImport(topicArn)) {
59.                     throw new this.serverless.classes.Error(
60.                       this.invalidPropertyErrorMessage(functionName, 'arn')
61.                     );
62.                   }
63.                 } else if (typeof topicArn === 'string') {
64.                   if (topicArn.indexOf('arn:') === 0) {
65.                     // NOTE: we need to process the topic ARN that way due to lacking
66.                     // support of regex lookbehind in Node.js 6.
67.                     // Once Node.js 6 support is dropped we can change this to:
68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`
69.                     const splitArn = topicArn
70.                       .replace(/::/g, '@@')
71.                       .split(':')
72.                       .map(s => s.replace(/@@/g, '::'));
73.                     topicName = splitArn[splitArn.length - 1];
74.                     if (splitArn[3] !== this.options.region) {
75.                       region = splitArn[3];
76.                     }
77.                   } else {
78.                     throw new this.serverless.classes.Error(
79.                       this.invalidPropertyErrorMessage(functionName, 'arn')
80.                     );
81.                   }
82.                 } else {
83.                   throw new this.serverless.classes.Error(
84.                     this.invalidPropertyErrorMessage(functionName, 'arn')
85.                   );
86.                 }
87.                 topicName = event.sns.topicName || topicName;
88.                 if (!topicName || typeof topicName !== 'string') {
89.                   throw new this.serverless.classes.Error(
90.                     this.invalidPropertyErrorMessage(functionName, 'topicName')
91.                   );
92.                 }
93.               } else {
94.                 ['topicName', 'displayName'].forEach(property => {
95.                   if (typeof event.sns[property] === 'string') {
96.                     return;
97.                   }
98.                   throw new this.serverless.classes.Error(
99.                     this.invalidPropertyErrorMessage(functionName, property)
100.                   );
101.                 });
102.                 displayName = event.sns.displayName;
103.                 topicName = event.sns.topicName;
104.               }
105.             } else if (typeof event.sns === 'string') {
106.               if (event.sns.indexOf('arn:') === 0) {
107.                 topicArn = event.sns;
108.                 const splitArn = topicArn.split(':');
109.                 topicName = splitArn[splitArn.length - 1];
110.               } else {
111.                 topicName = event.sns;
112.               }
113.             } else {
114.               const errorMessage = [
115.                 `SNS event of function ${functionName} is not an object nor a string`,
116.                 ' The correct syntax is: sns: topic-name-or-arn',
117.                 ' OR an object with ',
118.                 ' arn and topicName OR',
119.                 ' topicName and displayName.',
120.                 ' Please check the docs for more info.',
121.               ].join('');
122.               throw new this.serverless.classes.Error(errorMessage);
123.             }
124. 
125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
126. 
127.             const endpoint = {
128.               'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
129.             };
130. 
131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(
132.               functionName,
133.               topicName
134.             );
135. 
136.             if (topicArn) {
137.               _.merge(template.Resources, {
138.                 [subscriptionLogicalId]: {
139.                   Type: 'AWS::SNS::Subscription',
140.                   Properties: {
141.                     TopicArn: topicArn,
142.                     Protocol: 'lambda',
143.                     Endpoint: endpoint,
144.                     FilterPolicy: event.sns.filterPolicy,
145.                     RedrivePolicy: event.sns.redrivePolicy,
146.                     Region: region,
147.                   },
148.                 },
149.               });
150.             } else {
151.               topicArn = {
152.                 'Fn::Join': [
153.                   '',
154.                   [
155.                     'arn:',
156.                     { Ref: 'AWS::Partition' },
157.                     ':sns:',
158.                     { Ref: 'AWS::Region' },
159.                     ':',
160.                     { Ref: 'AWS::AccountId' },
161.                     ':',
162.                     topicName,
163.                   ],
164.                 ],
165.               };
166. 
167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);
168. 
169.               const subscription = {
170.                 Endpoint: endpoint,
171.                 Protocol: 'lambda',
172.               };
173. 
174.               if (!(topicLogicalId in template.Resources)) {
175.                 _.merge(template.Resources, {
176.                   [topicLogicalId]: {
177.                     Type: 'AWS::SNS::Topic',
178.                     Properties: {
179.                       TopicName: topicName,
180.                       DisplayName: displayName,
181.                     },
182.                   },
183.                 });
184.               }
185. 
186.               if (
187.                 event.sns.filterPolicy ||
188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)
189.               ) {
190.                 _.merge(template.Resources, {
191.                   [subscriptionLogicalId]: {
192.                     Type: 'AWS::SNS::Subscription',
193.                     Properties: _.merge(subscription, {
194.                       TopicArn: {
195.                         Ref: topicLogicalId,
196.                       },
197.                       FilterPolicy: event.sns.filterPolicy,
198.                       RedrivePolicy: event.sns.redrivePolicy,
199.                     }),
200.                   },
201.                 });
202.               } else {
203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {
204.                   template.Resources[topicLogicalId].Properties.Subscription = [];
205.                 }
206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);
207.               }
208.             }
209. 
210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(
211.               functionName,
212.               topicName
213.             );
214. 
215.             _.merge(template.Resources, {
216.               [lambdaPermissionLogicalId]: {
217.                 Type: 'AWS::Lambda::Permission',
218.                 Properties: {
219.                   FunctionName: endpoint,
220.                   Action: 'lambda:InvokeFunction',
221.                   Principal: 'sns.amazonaws.com',
222.                   SourceArn: topicArn,
223.                 },
224.               },
225.             });
226. 
227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
229.                 functionName,
230.                 `${topicName}DLQ`
231.               );
232.               Object.assign(template.Resources, {
233.                 [queuePolicyLogicalId]: {
234.                   Type: 'AWS::SQS::QueuePolicy',
235.                   Properties: {
236.                     PolicyDocument: {
237.                       Version: '2012-10-17',
238.                       Id: queuePolicyLogicalId,
239.                       Statement: [
240.                         {
241.                           Effect: 'Allow',
242.                           Principal: {
243.                             Service: 'sns.amazonaws.com',
244.                           },
245.                           Action: 'sqs:SendMessage',
246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,
247.                           Condition: {
248.                             ArnEquals: {
249.                               'aws:SourceArn': topicArn,
250.                             },
251.                           },
252.                         },
253.                       ],
254.                     },
255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
256.                   },
257.                 },
258.               });
259.             }
260.           }
261.         });
262.       }
263.     });
264.   }
265. }
266. 
267. module.exports = AwsCompileSNSEvents;

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 20:40:12,531 - thread-135845298308800.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='Query requirement analysis: The user asks for full content of the SNS compile module and helpers. This line shows the only direct import used by the module (lodash), satisfying the "helper modules it imports" part. Extended relevance: Identifies external dependency; no other internal helper is imported directly in this file.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=3, end_line=3), ContextOutput(reasoning='Query requirement analysis: Introduces the main function that compiles SNS events and the conditional branch that processes only events with an sns definition. Extended relevance: Establishes the entry point and loop over functions/events where the subsequent redrivePolicy and deadLetterTargetArn handling occurs.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=41, end_line=49), ContextOutput(reasoning='Query requirement analysis: Handles the case where event.sns is an object with an arn, extracting topicArn/topicName/region, which are later used when building Subscription and QueuePolicy resources. Extended relevance: Validates intrinsic references and parses the ARN needed for SourceArn in QueuePolicy condition.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=54, end_line=87), ContextOutput(reasoning='Query requirement analysis: Handles the object syntax without an arn, requiring topicName and displayName. Extended relevance: Ensures topicName is set, which is used to derive logical IDs and to name DLQ queue policy logical ID.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=94, end_line=104), ContextOutput(reasoning='Query requirement analysis: Handles the string syntax (either plain topic name or full ARN), setting topicArn/topicName. Extended relevance: Provides alternative path for defining topicArn/topicName which affect subsequent resource construction.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=105, end_line=112), ContextOutput(reasoning='Query requirement analysis: Derives Lambda function ARN endpoint and the logical ID for the SNS subscription. Extended relevance: These identifiers are used when creating the SNS::Subscription and Lambda::Permission resources tied to the SNS topic.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=125, end_line=135), ContextOutput(reasoning='Query requirement analysis: Builds an explicit AWS::SNS::Subscription when a topicArn is provided, including FilterPolicy and RedrivePolicy properties. Extended relevance: Directly shows where event.sns.redrivePolicy is passed into CloudFormation for the subscription.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=136, end_line=149), ContextOutput(reasoning='Query requirement analysis: When no external ARN is provided, creates a standalone AWS::SNS::Subscription resource if either filterPolicy or redrivePolicy with deadLetterTargetArn is present; includes RedrivePolicy in properties. Extended relevance: Shows the logic that forces a separate Subscription resource in presence of redrivePolicy and how RedrivePolicy is set.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=186, end_line=201), ContextOutput(reasoning='Query requirement analysis: Creates an AWS::SQS::QueuePolicy when redrivePolicy.deadLetterTargetArn is specified, setting PolicyDocument.Resource and Queues to event.sns.redrivePolicy.deadLetterTargetArn and using the topicArn in the condition. Extended relevance: This is the critical block showing how deadLetterTargetArn is used for both the Resource and Queues fields, which the user wants to correct to use GetAtt for Resource and Ref for Queues.', relative_path='lib/plugins/aws/package/compile/events/sns/index.js', start_line=227, end_line=259)]
2025-11-13 20:40:12,535 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 9 contexts to memory for query: Please provide the full content of lib/plugins/aws/package/compile/events/sns/index.js and any helper modules it imports.
2025-11-13 20:40:16,050 - thread-135845298308800.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 20:40:16,052 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 9 new contexts to 0 existing contexts
2025-11-13 20:40:16,052 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 9 total contexts (removed 0 duplicates)
2025-11-13 20:40:16,054 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/package/compile/events/sns/index.js and any helper modules it imports.
Extra Requirements: If that path doesn’t exist, please share the files responsible for compiling SNS event subscriptions and creating SQS QueuePolicy for redrivePolicy, plus lib/plugins/aws/lib/naming.js and docs/providers/aws/events/sns.md.
Purpose: I need to trace how deadLetterTargetArn is used to build CloudFormation resources so I can correct it to use GetAtt for Resource and Ref for Queues.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 3 - 3
Content:
3. const _ = require('lodash');


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 41 - 49
Content:
41.   compileSNSEvents() {
42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;
43. 
44.     this.serverless.service.getAllFunctions().forEach(functionName => {
45.       const functionObj = this.serverless.service.getFunction(functionName);
46. 
47.       if (functionObj.events) {
48.         functionObj.events.forEach(event => {
49.           if (event.sns) {


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 54 - 87
Content:
54.             if (typeof event.sns === 'object') {
55.               if (event.sns.arn) {
56.                 topicArn = event.sns.arn;
57.                 if (typeof topicArn === 'object') {
58.                   if (!this.isValidStackImport(topicArn)) {
59.                     throw new this.serverless.classes.Error(
60.                       this.invalidPropertyErrorMessage(functionName, 'arn')
61.                     );
62.                   }
63.                 } else if (typeof topicArn === 'string') {
64.                   if (topicArn.indexOf('arn:') === 0) {
65.                     // NOTE: we need to process the topic ARN that way due to lacking
66.                     // support of regex lookbehind in Node.js 6.
67.                     // Once Node.js 6 support is dropped we can change this to:
68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`
69.                     const splitArn = topicArn
70.                       .replace(/::/g, '@@')
71.                       .split(':')
72.                       .map(s => s.replace(/@@/g, '::'));
73.                     topicName = splitArn[splitArn.length - 1];
74.                     if (splitArn[3] !== this.options.region) {
75.                       region = splitArn[3];
76.                     }
77.                   } else {
78.                     throw new this.serverless.classes.Error(
79.                       this.invalidPropertyErrorMessage(functionName, 'arn')
80.                     );
81.                   }
82.                 } else {
83.                   throw new this.serverless.classes.Error(
84.                     this.invalidPropertyErrorMessage(functionName, 'arn')
85.                   );
86.                 }
87.                 topicName = event.sns.topicName || topicName;


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 94 - 104
Content:
94.                 ['topicName', 'displayName'].forEach(property => {
95.                   if (typeof event.sns[property] === 'string') {
96.                     return;
97.                   }
98.                   throw new this.serverless.classes.Error(
99.                     this.invalidPropertyErrorMessage(functionName, property)
100.                   );
101.                 });
102.                 displayName = event.sns.displayName;
103.                 topicName = event.sns.topicName;
104.               }


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 105 - 112
Content:
105.             } else if (typeof event.sns === 'string') {
106.               if (event.sns.indexOf('arn:') === 0) {
107.                 topicArn = event.sns;
108.                 const splitArn = topicArn.split(':');
109.                 topicName = splitArn[splitArn.length - 1];
110.               } else {
111.                 topicName = event.sns;
112.               }


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 125 - 135
Content:
125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
126. 
127.             const endpoint = {
128.               'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
129.             };
130. 
131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(
132.               functionName,
133.               topicName
134.             );
135. 


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 136 - 149
Content:
136.             if (topicArn) {
137.               _.merge(template.Resources, {
138.                 [subscriptionLogicalId]: {
139.                   Type: 'AWS::SNS::Subscription',
140.                   Properties: {
141.                     TopicArn: topicArn,
142.                     Protocol: 'lambda',
143.                     Endpoint: endpoint,
144.                     FilterPolicy: event.sns.filterPolicy,
145.                     RedrivePolicy: event.sns.redrivePolicy,
146.                     Region: region,
147.                   },
148.                 },
149.               });


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 186 - 201
Content:
186.               if (
187.                 event.sns.filterPolicy ||
188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)
189.               ) {
190.                 _.merge(template.Resources, {
191.                   [subscriptionLogicalId]: {
192.                     Type: 'AWS::SNS::Subscription',
193.                     Properties: _.merge(subscription, {
194.                       TopicArn: {
195.                         Ref: topicLogicalId,
196.                       },
197.                       FilterPolicy: event.sns.filterPolicy,
198.                       RedrivePolicy: event.sns.redrivePolicy,
199.                     }),
200.                   },
201.                 });


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 227 - 259
Content:
227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
229.                 functionName,
230.                 `${topicName}DLQ`
231.               );
232.               Object.assign(template.Resources, {
233.                 [queuePolicyLogicalId]: {
234.                   Type: 'AWS::SQS::QueuePolicy',
235.                   Properties: {
236.                     PolicyDocument: {
237.                       Version: '2012-10-17',
238.                       Id: queuePolicyLogicalId,
239.                       Statement: [
240.                         {
241.                           Effect: 'Allow',
242.                           Principal: {
243.                             Service: 'sns.amazonaws.com',
244.                           },
245.                           Action: 'sqs:SendMessage',
246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,
247.                           Condition: {
248.                             ArnEquals: {
249.                               'aws:SourceArn': topicArn,
250.                             },
251.                           },
252.                         },
253.                       ],
254.                     },
255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
256.                   },
257.                 },
258.               });
259.             }

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:40:35,244 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The aggregated context only shows fragments of lib/plugins/aws/package/compile/events/sns/index.js, and it lacks the helper methods (e.g., isValidStackImport, invalidPropertyErrorMessage) and the provider naming implementations used to construct logical IDs. The issue requires correcting how RedrivePolicy builds CloudFormation for SQS QueuePolicy (using GetAtt Arn for Resource and Ref for Queues) and aligning documentation. To confidently fix this, I need the full SNS compile module and the relevant naming methods, plus the SNS event documentation to verify the expected configuration syntax.' query='Please provide the complete content of lib/plugins/aws/package/compile/events/sns/index.js, along with the implementations of getQueueLogicalId and getLambdaSnsSubscriptionLogicalId in lib/plugins/aws/lib/naming.js, and docs/providers/aws/events/sns.md.' extra_requirements='If providing full files is not possible, include at minimum the definitions of isValidStackImport and invalidPropertyErrorMessage in the SNS compile module and the code block that creates the SQS QueuePolicy for redrivePolicy.' purpose='I need to trace and adjust how RedrivePolicy constructs CloudFormation (Resource vs. Queues) and ensure the documentation reflects the correct references.'
2025-11-13 20:40:35,246 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the complete content of lib/plugins/aws/package/compile/events/sns/index.js, along with the implementations of getQueueLogicalId and getLambdaSnsSubscriptionLogicalId in lib/plugins/aws/lib/naming.js, and docs/providers/aws/events/sns.md.
2025-11-13 20:40:38,799 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/sns/index.js, lib/plugins/aws/package/compile/events/sns/index.test.js, and docs/providers/aws/events/sns.md.', 'query_extra_requirements': 'If sns/index.js uses helper functions (e.g., from naming.js or validate.js) to construct the QueuePolicy or redrive policy, please include those specific helper function implementations with line numbers.', 'query_purpose': 'To verify how redrivePolicy and QueuePolicy are compiled (ARN vs Ref usage) and compare with documentation, enabling accurate classification of the issue as a bug or documentation update.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'content': '1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileSNSEvents {\n6.   constructor(serverless, options) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9.     this.options = options;\n10.     this.hooks = {\n11.       \'package:compileEvents\': this.compileSNSEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   invalidPropertyErrorMessage(functionName, property) {\n16.     return [\n17.       `Missing or invalid ${property} property for sns event`,\n18.       ` in function "${functionName}"`,\n19.       \' The correct syntax is: sns: topic-name-or-arn\',\n20.       \' OR an object with \',\n21.       \' arn and topicName OR\',\n22.       \' topicName and displayName.\',\n23.       \' Please check the docs for more info.\',\n24.     ].join(\'\');\n25.   }\n26. \n27.   isValidStackImport(variable) {\n28.     if (Object.keys(variable).length !== 1) {\n29.       return false;\n30.     }\n31.     if (\n32.       _.has(variable, \'Fn::ImportValue\') &&\n33.       (_.has(variable, \'Fn::ImportValue.Fn::GetAtt\') || _.has(variable, \'Fn::ImportValue.Ref\'))\n34.     ) {\n35.       return false;\n36.     }\n37.     const intrinsicFunctions = [\'Fn::ImportValue\', \'Ref\', \'Fn::GetAtt\', \'Fn::Sub\', \'Fn::Join\'];\n38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));\n39.   }\n40. \n41.   compileSNSEvents() {\n42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;\n43. \n44.     this.serverless.service.getAllFunctions().forEach(functionName => {\n45.       const functionObj = this.serverless.service.getFunction(functionName);\n46. \n47.       if (functionObj.events) {\n48.         functionObj.events.forEach(event => {\n49.           if (event.sns) {\n50.             let topicArn;\n51.             let topicName;\n52.             let region;\n53.             let displayName = \'\';\n54.             if (typeof event.sns === \'object\') {\n55.               if (event.sns.arn) {\n56.                 topicArn = event.sns.arn;\n57.                 if (typeof topicArn === \'object\') {\n58.                   if (!this.isValidStackImport(topicArn)) {\n59.                     throw new this.serverless.classes.Error(\n60.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n61.                     );\n62.                   }\n63.                 } else if (typeof topicArn === \'string\') {\n64.                   if (topicArn.indexOf(\'arn:\') === 0) {\n65.                     // NOTE: we need to process the topic ARN that way due to lacking\n66.                     // support of regex lookbehind in Node.js 6.\n67.                     // Once Node.js 6 support is dropped we can change this to:\n68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`\n69.                     const splitArn = topicArn\n70.                       .replace(/::/g, \'@@\')\n71.                       .split(\':\')\n72.                       .map(s => s.replace(/@@/g, \'::\'));\n73.                     topicName = splitArn[splitArn.length - 1];\n74.                     if (splitArn[3] !== this.options.region) {\n75.                       region = splitArn[3];\n76.                     }\n77.                   } else {\n78.                     throw new this.serverless.classes.Error(\n79.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n80.                     );\n81.                   }\n82.                 } else {\n83.                   throw new this.serverless.classes.Error(\n84.                     this.invalidPropertyErrorMessage(functionName, \'arn\')\n85.                   );\n86.                 }\n87.                 topicName = event.sns.topicName || topicName;\n88.                 if (!topicName || typeof topicName !== \'string\') {\n89.                   throw new this.serverless.classes.Error(\n90.                     this.invalidPropertyErrorMessage(functionName, \'topicName\')\n91.                   );\n92.                 }\n93.               } else {\n94.                 [\'topicName\', \'displayName\'].forEach(property => {\n95.                   if (typeof event.sns[property] === \'string\') {\n96.                     return;\n97.                   }\n98.                   throw new this.serverless.classes.Error(\n99.                     this.invalidPropertyErrorMessage(functionName, property)\n100.                   );\n101.                 });\n102.                 displayName = event.sns.displayName;\n103.                 topicName = event.sns.topicName;\n104.               }\n105.             } else if (typeof event.sns === \'string\') {\n106.               if (event.sns.indexOf(\'arn:\') === 0) {\n107.                 topicArn = event.sns;\n108.                 const splitArn = topicArn.split(\':\');\n109.                 topicName = splitArn[splitArn.length - 1];\n110.               } else {\n111.                 topicName = event.sns;\n112.               }\n113.             } else {\n114.               const errorMessage = [\n115.                 `SNS event of function ${functionName} is not an object nor a string`,\n116.                 \' The correct syntax is: sns: topic-name-or-arn\',\n117.                 \' OR an object with \',\n118.                 \' arn and topicName OR\',\n119.                 \' topicName and displayName.\',\n120.                 \' Please check the docs for more info.\',\n121.               ].join(\'\');\n122.               throw new this.serverless.classes.Error(errorMessage);\n123.             }\n124. \n125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n126. \n127.             const endpoint = {\n128.               \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n129.             };\n130. \n131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\n132.               functionName,\n133.               topicName\n134.             );\n135. \n136.             if (topicArn) {\n137.               _.merge(template.Resources, {\n138.                 [subscriptionLogicalId]: {\n139.                   Type: \'AWS::SNS::Subscription\',\n140.                   Properties: {\n141.                     TopicArn: topicArn,\n142.                     Protocol: \'lambda\',\n143.                     Endpoint: endpoint,\n144.                     FilterPolicy: event.sns.filterPolicy,\n145.                     RedrivePolicy: event.sns.redrivePolicy,\n146.                     Region: region,\n147.                   },\n148.                 },\n149.               });\n150.             } else {\n151.               topicArn = {\n152.                 \'Fn::Join\': [\n153.                   \'\',\n154.                   [\n155.                     \'arn:\',\n156.                     { Ref: \'AWS::Partition\' },\n157.                     \':sns:\',\n158.                     { Ref: \'AWS::Region\' },\n159.                     \':\',\n160.                     { Ref: \'AWS::AccountId\' },\n161.                     \':\',\n162.                     topicName,\n163.                   ],\n164.                 ],\n165.               };\n166. \n167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);\n168. \n169.               const subscription = {\n170.                 Endpoint: endpoint,\n171.                 Protocol: \'lambda\',\n172.               };\n173. \n174.               if (!(topicLogicalId in template.Resources)) {\n175.                 _.merge(template.Resources, {\n176.                   [topicLogicalId]: {\n177.                     Type: \'AWS::SNS::Topic\',\n178.                     Properties: {\n179.                       TopicName: topicName,\n180.                       DisplayName: displayName,\n181.                     },\n182.                   },\n183.                 });\n184.               }\n185. \n186.               if (\n187.                 event.sns.filterPolicy ||\n188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)\n189.               ) {\n190.                 _.merge(template.Resources, {\n191.                   [subscriptionLogicalId]: {\n192.                     Type: \'AWS::SNS::Subscription\',\n193.                     Properties: _.merge(subscription, {\n194.                       TopicArn: {\n195.                         Ref: topicLogicalId,\n196.                       },\n197.                       FilterPolicy: event.sns.filterPolicy,\n198.                       RedrivePolicy: event.sns.redrivePolicy,\n199.                     }),\n200.                   },\n201.                 });\n202.               } else {\n203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {\n204.                   template.Resources[topicLogicalId].Properties.Subscription = [];\n205.                 }\n206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);\n207.               }\n208.             }\n209. \n210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(\n211.               functionName,\n212.               topicName\n213.             );\n214. \n215.             _.merge(template.Resources, {\n216.               [lambdaPermissionLogicalId]: {\n217.                 Type: \'AWS::Lambda::Permission\',\n218.                 Properties: {\n219.                   FunctionName: endpoint,\n220.                   Action: \'lambda:InvokeFunction\',\n221.                   Principal: \'sns.amazonaws.com\',\n222.                   SourceArn: topicArn,\n223.                 },\n224.               },\n225.             });\n226. \n227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n229.                 functionName,\n230.                 `${topicName}DLQ`\n231.               );\n232.               Object.assign(template.Resources, {\n233.                 [queuePolicyLogicalId]: {\n234.                   Type: \'AWS::SQS::QueuePolicy\',\n235.                   Properties: {\n236.                     PolicyDocument: {\n237.                       Version: \'2012-10-17\',\n238.                       Id: queuePolicyLogicalId,\n239.                       Statement: [\n240.                         {\n241.                           Effect: \'Allow\',\n242.                           Principal: {\n243.                             Service: \'sns.amazonaws.com\',\n244.                           },\n245.                           Action: \'sqs:SendMessage\',\n246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,\n247.                           Condition: {\n248.                             ArnEquals: {\n249.                               \'aws:SourceArn\': topicArn,\n250.                             },\n251.                           },\n252.                         },\n253.                       ],\n254.                     },\n255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\n256.                   },\n257.                 },\n258.               });\n259.             }\n260.           }\n261.         });\n262.       }\n263.     });\n264.   }\n265. }\n266. \n267. module.exports = AwsCompileSNSEvents;', 'start_line_number': 1, 'end_line_number': 267}, {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.test.js', 'content': "1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. \n8. describe('AwsCompileSNSEvents', () => {\n9.   let serverless;\n10.   let awsCompileSNSEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     const options = {\n15.       region: 'some-region',\n16.     };\n17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n18.     serverless.setProvider('aws', new AwsProvider(serverless));\n19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\n20.   });\n21. \n22.   describe('#constructor()', () => {\n23.     it('should set the provider variable to an instance of AwsProvider', () =>\n24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));\n25.   });\n26. \n27.   describe('#compileSNSEvents()', () => {\n28.     it('should throw an error if SNS event type is not a string or an object', () => {\n29.       awsCompileSNSEvents.serverless.service.functions = {\n30.         first: {\n31.           events: [\n32.             {\n33.               sns: 42,\n34.             },\n35.           ],\n36.         },\n37.       };\n38. \n39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);\n40.     });\n41. \n42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });\n89. \n90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });\n150. \n151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });\n184. \n185.     it('should throw an error when the event an object and the displayName is not given', () => {\n186.       awsCompileSNSEvents.serverless.service.functions = {\n187.         first: {\n188.           events: [\n189.             {\n190.               sns: {\n191.                 displayName: 'Display name for topic 1',\n192.               },\n193.             },\n194.           ],\n195.         },\n196.       };\n197. \n198.       expect(() => {\n199.         awsCompileSNSEvents.compileSNSEvents();\n200.       }).to.throw(Error);\n201.     });\n202. \n203.     it('should not create corresponding resources when SNS events are not given', () => {\n204.       awsCompileSNSEvents.serverless.service.functions = {\n205.         first: {\n206.           events: [],\n207.         },\n208.       };\n209. \n210.       awsCompileSNSEvents.compileSNSEvents();\n211. \n212.       expect(\n213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.       ).to.deep.equal({});\n215.     });\n216. \n217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });\n248. \n249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });\n278. \n279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });\n311. \n312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {\n313.       awsCompileSNSEvents.serverless.service.functions = {\n314.         first: {\n315.           events: [\n316.             {\n317.               sns: {\n318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',\n319.               },\n320.             },\n321.           ],\n322.         },\n323.       };\n324. \n325.       awsCompileSNSEvents.compileSNSEvents();\n326.       expect(\n327.         Object.keys(\n328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n329.         )\n330.       ).to.have.length(2);\n331.       expect(\n332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n333.           .FirstSnsSubscriptionFoo.Type\n334.       ).to.equal('AWS::SNS::Subscription');\n335.       expect(\n336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n337.           .FirstSnsSubscriptionFoo.Properties.Region\n338.       ).to.equal('${AWS::Region}');\n339.       expect(\n340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n341.           .FirstLambdaPermissionFooSNS.Type\n342.       ).to.equal('AWS::Lambda::Permission');\n343.     });\n344. \n345.     it('should throw an error when the arn an object and the value is not a string', () => {\n346.       awsCompileSNSEvents.serverless.service.functions = {\n347.         first: {\n348.           events: [\n349.             {\n350.               sns: {\n351.                 arn: 123,\n352.               },\n353.             },\n354.           ],\n355.         },\n356.       };\n357. \n358.       expect(() => {\n359.         awsCompileSNSEvents.compileSNSEvents();\n360.       }).to.throw(Error);\n361.     });\n362. \n363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {\n364.       awsCompileSNSEvents.serverless.service.functions = {\n365.         first: {\n366.           events: [\n367.             {\n368.               sns: {\n369.                 topicName: 'bar',\n370.                 arn: 'arn:aws:sns:region:accountid:bar',\n371.               },\n372.             },\n373.           ],\n374.         },\n375.       };\n376. \n377.       awsCompileSNSEvents.compileSNSEvents();\n378. \n379.       expect(\n380.         Object.keys(\n381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n382.         )\n383.       ).to.have.length(2);\n384.       expect(\n385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n386.           .FirstSnsSubscriptionBar.Type\n387.       ).to.equal('AWS::SNS::Subscription');\n388.       expect(\n389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n390.           .FirstLambdaPermissionBarSNS.Type\n391.       ).to.equal('AWS::Lambda::Permission');\n392.     });\n393. \n394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {\n395.       awsCompileSNSEvents.serverless.service.functions = {\n396.         first: {\n397.           events: [\n398.             {\n399.               sns: {\n400.                 topicName: 'first',\n401.                 arn: 'arn:aws:sns:region-1:accountid:bar',\n402.               },\n403.             },\n404.             {\n405.               sns: {\n406.                 topicName: 'second',\n407.                 arn: 'arn:aws:sns:region-2:accountid:bar',\n408.               },\n409.             },\n410.           ],\n411.         },\n412.       };\n413. \n414.       awsCompileSNSEvents.compileSNSEvents();\n415. \n416.       expect(\n417.         Object.keys(\n418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n419.         )\n420.       ).to.have.length(4);\n421.       expect(\n422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n423.           .FirstSnsSubscriptionFirst.Type\n424.       ).to.equal('AWS::SNS::Subscription');\n425.       expect(\n426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n427.           .FirstSnsSubscriptionSecond.Type\n428.       ).to.equal('AWS::SNS::Subscription');\n429.     });\n430. \n431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {\n432.       awsCompileSNSEvents.serverless.service.functions = {\n433.         first: {\n434.           events: [\n435.             {\n436.               sns: {\n437.                 topicName: 'foo',\n438.                 arn: 'arn:aws:sns:region:accountid:bar',\n439.               },\n440.             },\n441.           ],\n442.         },\n443.       };\n444. \n445.       awsCompileSNSEvents.compileSNSEvents();\n446. \n447.       expect(\n448.         Object.keys(\n449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n450.         )\n451.       ).to.have.length(2);\n452.       expect(\n453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n454.           .FirstSnsSubscriptionFoo.Type\n455.       ).to.equal('AWS::SNS::Subscription');\n456.       expect(\n457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n458.           .FirstLambdaPermissionFooSNS.Type\n459.       ).to.equal('AWS::Lambda::Permission');\n460.     });\n461. \n462.     // eslint-disable-next-line max-len\n463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {\n464.       awsCompileSNSEvents.serverless.service.functions = {\n465.         first: {\n466.           events: [\n467.             {\n468.               sns: {\n469.                 topicName: 'bar',\n470.                 arn: {\n471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],\n472.                 },\n473.               },\n474.             },\n475.           ],\n476.         },\n477.       };\n478. \n479.       awsCompileSNSEvents.compileSNSEvents();\n480. \n481.       expect(\n482.         Object.keys(\n483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n484.         )\n485.       ).to.have.length(2);\n486.       expect(\n487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n488.           .FirstSnsSubscriptionBar.Type\n489.       ).to.equal('AWS::SNS::Subscription');\n490.       expect(\n491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n492.           .FirstLambdaPermissionBarSNS.Type\n493.       ).to.equal('AWS::Lambda::Permission');\n494.     });\n495. \n496.     // eslint-disable-next-line max-len\n497.     it('should throw an error when arn object and no topicName are given as object properties', () => {\n498.       awsCompileSNSEvents.serverless.service.functions = {\n499.         first: {\n500.           events: [\n501.             {\n502.               sns: {\n503.                 arn: {\n504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],\n505.                 },\n506.               },\n507.             },\n508.           ],\n509.         },\n510.       };\n511. \n512.       expect(() => {\n513.         awsCompileSNSEvents.compileSNSEvents();\n514.       }).to.throw(Error);\n515.     });\n516. \n517.     // eslint-disable-next-line max-len\n518.     it('should throw an error when invalid imported arn object is given as object properties', () => {\n519.       awsCompileSNSEvents.serverless.service.functions = {\n520.         first: {\n521.           events: [\n522.             {\n523.               sns: {\n524.                 topicName: 'bar',\n525.                 arn: {\n526.                   'Fn::ImportValue': {\n527.                     Ref: 'BarTopic',\n528.                   },\n529.                 },\n530.               },\n531.             },\n532.           ],\n533.         },\n534.       };\n535. \n536.       expect(() => {\n537.         awsCompileSNSEvents.compileSNSEvents();\n538.       }).to.throw(Error);\n539. \n540.       awsCompileSNSEvents.serverless.service.functions = {\n541.         first: {\n542.           events: [\n543.             {\n544.               sns: {\n545.                 topicName: 'bar',\n546.                 arn: {\n547.                   'Fn::ImportValue': {\n548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],\n549.                   },\n550.                 },\n551.               },\n552.             },\n553.           ],\n554.         },\n555.       };\n556. \n557.       expect(() => {\n558.         awsCompileSNSEvents.compileSNSEvents();\n559.       }).to.throw(Error);\n560.     });\n561. \n562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });\n599. \n600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });\n654.   });\n655. });", 'start_line_number': 1, 'end_line_number': 655}, {'relative_path': 'docs/providers/aws/events/sns.md', 'content': "1. <!--\n2. title: Serverless Framework - AWS Lambda Events - SNS\n3. menuText: SNS\n4. menuOrder: 7\n5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. \n11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)\n12. \n13. <!-- DOCS-SITE-LINK:END -->\n14. \n15. # SNS\n16. \n17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.\n18. \n19. ```yml\n20. functions:\n21.   dispatcher:\n22.     handler: dispatcher.dispatch\n23.     events:\n24.       - sns: dispatch\n25. ```\n26. \n27. You're also able to add the same SNS topic to multiple functions:\n28. \n29. ```yml\n30. functions:\n31.   dispatcher:\n32.     handler: dispatcher.dispatch\n33.     events:\n34.       - sns: dispatch\n35.   dispatcher2:\n36.     handler: dispatcher2.dispatch\n37.     events:\n38.       - sns: dispatch\n39. ```\n40. \n41. This will run both functions for a message sent to the dispatch topic.\n42. \n43. ## Using a pre-existing topic\n44. \n45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.\n46. \n47. ```yml\n48. functions:\n49.   dispatcher:\n50.     handler: dispatcher.dispatch\n51.     events:\n52.       - sns: arn:xxx\n53. ```\n54. \n55. ```yml\n56. functions:\n57.   dispatcher:\n58.     handler: dispatcher.dispatch\n59.     events:\n60.       - sns:\n61.           arn: arn:xxx\n62. ```\n63. \n64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).\n65. **Note:** The arn can be in a different region to enable cross region invocation\n66. \n67. ```yml\n68. functions:\n69.   dispatcher:\n70.     handler: dispatcher.dispatch\n71.     events:\n72.       - sns:\n73.           arn:\n74.             Fn::Join:\n75.               - ':'\n76.               - - 'arn:aws:sns'\n77.                 - Ref: 'AWS::Region'\n78.                 - Ref: 'AWS::AccountId'\n79.                 - 'MyCustomTopic'\n80.           topicName: MyCustomTopic\n81. ```\n82. \n83. If your SNS topic doesn't yet exist but is defined in the serverless.yml file you're editing, you'll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!\n84. \n85. ```yml\n86. functions:\n87.   dispatcher:\n88.     handler: dispatcher.dispatch\n89.     events:\n90.       - sns:\n91.           arn: !Ref SuperTopic\n92.           topicName: MyCustomTopic\n93. \n94. resources:\n95.   Resources:\n96.     SuperTopic:\n97.       Type: AWS::SNS::Topic\n98.       Properties:\n99.         TopicName: MyCustomTopic\n100. ```\n101. \n102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.\n103. \n104. ```yml\n105. functions:\n106.   hello:\n107.     handler: handler.run\n108.     events:\n109.       - sns:\n110.           arn: arn:aws:sns:us-east-1:00000000000:topicname\n111.           topicName: topicname-account-1-us-east-1\n112.       - sns:\n113.           arn: arn:aws:sns:us-east-1:11111111111:topicname\n114.           topicName: topicname-account-2-us-east-1\n115. ```\n116. \n117. ## Setting a display name\n118. \n119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the\n120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the\n121. SNS topic is used for.\n122. \n123. ```yml\n124. functions:\n125.   aggregator:\n126.     handler: aggregator.handler\n127.     events:\n128.       - sns:\n129.           topicName: aggregate\n130.           displayName: Data aggregation pipeline\n131. ```\n132. \n133. ## Setting a filter policy\n134. \n135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don't have attribute key `pet` with value `dog` or `cat`.\n136. \n137. ```yml\n138. functions:\n139.   pets:\n140.     handler: pets.handler\n141.     events:\n142.       - sns:\n143.           topicName: pets\n144.           filterPolicy:\n145.             pet:\n146.               - dog\n147.               - cat\n148. ```\n149. \n150. ## Setting a redrive policy\n151. \n152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\n153. \n154. ```yml\n155. functions:\n156.   dispatcher:\n157.     handler: dispatcher.handler\n158.     events:\n159.       - sns:\n160.           topicName: dispatcher\n161.           redrivePolicy:\n162.             deadLetterTargetArn: !Ref myDLQ\n163. \n164. resources:\n165.   Resources:\n166.     myDLQ:\n167.       Type: AWS::SQS::Queue\n168.       Properties:\n169.         QueueName: myDLQ\n170. ```", 'start_line_number': 1, 'end_line_number': 170}, {'relative_path': 'lib/plugins/aws/lib/naming.js', 'content': '391.   getQueueLogicalId(functionName, queueName) {\n392.     return `${this.getNormalizedFunctionName(\n393.       functionName\n394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;\n395.   },', 'start_line_number': 391, 'end_line_number': 395}, {'relative_path': 'lib/plugins/aws/lib/naming.js', 'content': '432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {\n433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(\n434.       topicName\n435.     )}`;\n436.   },', 'start_line_number': 432, 'end_line_number': 436}, {'relative_path': 'lib/plugins/aws/lib/naming.js', 'content': '335.   getTopicLogicalId(topicName) {\n336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;\n337.   },', 'start_line_number': 335, 'end_line_number': 337}]}]
2025-11-13 20:40:38,799 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 1 memories from memory
2025-11-13 20:40:38,799 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 6 contexts from memory
2025-11-13 20:40:38,799 - thread-135845298308800.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 6 contexts from memory
2025-11-13 20:40:38,801 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 6 new contexts to 9 existing contexts
2025-11-13 20:40:38,802 - thread-135845298308800.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 6 total contexts (removed 9 duplicates)
2025-11-13 20:40:38,803 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .codecov.yml
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── feature_request.md
|   |   └── questions.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── assets
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           ├── cli-reference
|   |           ├── components
|   |           └── events
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards
|   |   |   ├── README.md
|   |   |   ├── available.md
|   |   |   └── custom.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── resources
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── invoke.py
|   |   |   |   ├── invoke.rb
|   |   |   |   └── java
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       └── getS3ObjectsFromStacks.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── executable
|   |   |   └── index.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── inquirer.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   ├── logs.js
|   |   |   └── logs.test.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   └── slstats
|   |       ├── slstats.js
|   |       └── slstats.test.js
|   └── utils
|       ├── autocomplete.js
|       ├── config
|       |   ├── config.test.js
|       |   ├── index.js
|       |   └── initialSetup.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── fse.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── isTrackingDisabled.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── sentry.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── tracking.js
|       ├── tracking.test.js
|       ├── userStats.js
|       ├── userStatsValidation.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload.js
|   ├── postinstall.js
|   ├── pre-release.js
|   ├── preuninstall.js
|   └── update-sfe-dep.js
└── tests
    ├── .eslintrc.js
    ├── fixtures
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   └── index.js
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Redrive Policy not properly referencing queue

Issue description: 


## Description

Recentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.
````
Resource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]
````

````
Queues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget
````

This translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.

In this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.
Other solutions would involve more complex things like trying to generate the url from the Arn. I'm open to whatever you think is best and will start a PR as soon as there's consensus

#7239 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/package/compile/events/sns/index.js and any helper modules it imports.
Extra Requirements: If that path doesn’t exist, please share the files responsible for compiling SNS event subscriptions and creating SQS QueuePolicy for redrivePolicy, plus lib/plugins/aws/lib/naming.js and docs/providers/aws/events/sns.md.
Purpose: I need to trace how deadLetterTargetArn is used to build CloudFormation resources so I can correct it to use GetAtt for Resource and Ref for Queues.

Previous refined query 2:
Essential Query: Please provide the complete content of lib/plugins/aws/package/compile/events/sns/index.js, along with the implementations of getQueueLogicalId and getLambdaSnsSubscriptionLogicalId in lib/plugins/aws/lib/naming.js, and docs/providers/aws/events/sns.md.
Extra Requirements: If providing full files is not possible, include at minimum the definitions of isValidStackImport and invalidPropertyErrorMessage in the SNS compile module and the code block that creates the SQS QueuePolicy for redrivePolicy.
Purpose: I need to trace and adjust how RedrivePolicy constructs CloudFormation (Resource vs. Queues) and ensure the documentation reflects the correct references.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/sns.md
Line number range: 1 - 170
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - SNS
3. menuText: SNS
4. menuOrder: 7
5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # SNS
16. 
17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.
18. 
19. ```yml
20. functions:
21.   dispatcher:
22.     handler: dispatcher.dispatch
23.     events:
24.       - sns: dispatch
25. ```
26. 
27. You're also able to add the same SNS topic to multiple functions:
28. 
29. ```yml
30. functions:
31.   dispatcher:
32.     handler: dispatcher.dispatch
33.     events:
34.       - sns: dispatch
35.   dispatcher2:
36.     handler: dispatcher2.dispatch
37.     events:
38.       - sns: dispatch
39. ```
40. 
41. This will run both functions for a message sent to the dispatch topic.
42. 
43. ## Using a pre-existing topic
44. 
45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.
46. 
47. ```yml
48. functions:
49.   dispatcher:
50.     handler: dispatcher.dispatch
51.     events:
52.       - sns: arn:xxx
53. ```
54. 
55. ```yml
56. functions:
57.   dispatcher:
58.     handler: dispatcher.dispatch
59.     events:
60.       - sns:
61.           arn: arn:xxx
62. ```
63. 
64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).
65. **Note:** The arn can be in a different region to enable cross region invocation
66. 
67. ```yml
68. functions:
69.   dispatcher:
70.     handler: dispatcher.dispatch
71.     events:
72.       - sns:
73.           arn:
74.             Fn::Join:
75.               - ':'
76.               - - 'arn:aws:sns'
77.                 - Ref: 'AWS::Region'
78.                 - Ref: 'AWS::AccountId'
79.                 - 'MyCustomTopic'
80.           topicName: MyCustomTopic
81. ```
82. 
83. If your SNS topic doesn't yet exist but is defined in the serverless.yml file you're editing, you'll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!
84. 
85. ```yml
86. functions:
87.   dispatcher:
88.     handler: dispatcher.dispatch
89.     events:
90.       - sns:
91.           arn: !Ref SuperTopic
92.           topicName: MyCustomTopic
93. 
94. resources:
95.   Resources:
96.     SuperTopic:
97.       Type: AWS::SNS::Topic
98.       Properties:
99.         TopicName: MyCustomTopic
100. ```
101. 
102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.
103. 
104. ```yml
105. functions:
106.   hello:
107.     handler: handler.run
108.     events:
109.       - sns:
110.           arn: arn:aws:sns:us-east-1:00000000000:topicname
111.           topicName: topicname-account-1-us-east-1
112.       - sns:
113.           arn: arn:aws:sns:us-east-1:11111111111:topicname
114.           topicName: topicname-account-2-us-east-1
115. ```
116. 
117. ## Setting a display name
118. 
119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the
120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the
121. SNS topic is used for.
122. 
123. ```yml
124. functions:
125.   aggregator:
126.     handler: aggregator.handler
127.     events:
128.       - sns:
129.           topicName: aggregate
130.           displayName: Data aggregation pipeline
131. ```
132. 
133. ## Setting a filter policy
134. 
135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don't have attribute key `pet` with value `dog` or `cat`.
136. 
137. ```yml
138. functions:
139.   pets:
140.     handler: pets.handler
141.     events:
142.       - sns:
143.           topicName: pets
144.           filterPolicy:
145.             pet:
146.               - dog
147.               - cat
148. ```
149. 
150. ## Setting a redrive policy
151. 
152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`
153. 
154. ```yml
155. functions:
156.   dispatcher:
157.     handler: dispatcher.handler
158.     events:
159.       - sns:
160.           topicName: dispatcher
161.           redrivePolicy:
162.             deadLetterTargetArn: !Ref myDLQ
163. 
164. resources:
165.   Resources:
166.     myDLQ:
167.       Type: AWS::SQS::Queue
168.       Properties:
169.         QueueName: myDLQ
170. ```


File: lib/plugins/aws/lib/naming.js
Line number range: 335 - 337
Content:
335.   getTopicLogicalId(topicName) {
336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;
337.   },


File: lib/plugins/aws/lib/naming.js
Line number range: 391 - 395
Content:
391.   getQueueLogicalId(functionName, queueName) {
392.     return `${this.getNormalizedFunctionName(
393.       functionName
394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;
395.   },


File: lib/plugins/aws/lib/naming.js
Line number range: 432 - 436
Content:
432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {
433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(
434.       topicName
435.     )}`;
436.   },


File: lib/plugins/aws/package/compile/events/sns/index.js
Line number range: 1 - 267
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileSNSEvents {
6.   constructor(serverless, options) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9.     this.options = options;
10.     this.hooks = {
11.       'package:compileEvents': this.compileSNSEvents.bind(this),
12.     };
13.   }
14. 
15.   invalidPropertyErrorMessage(functionName, property) {
16.     return [
17.       `Missing or invalid ${property} property for sns event`,
18.       ` in function "${functionName}"`,
19.       ' The correct syntax is: sns: topic-name-or-arn',
20.       ' OR an object with ',
21.       ' arn and topicName OR',
22.       ' topicName and displayName.',
23.       ' Please check the docs for more info.',
24.     ].join('');
25.   }
26. 
27.   isValidStackImport(variable) {
28.     if (Object.keys(variable).length !== 1) {
29.       return false;
30.     }
31.     if (
32.       _.has(variable, 'Fn::ImportValue') &&
33.       (_.has(variable, 'Fn::ImportValue.Fn::GetAtt') || _.has(variable, 'Fn::ImportValue.Ref'))
34.     ) {
35.       return false;
36.     }
37.     const intrinsicFunctions = ['Fn::ImportValue', 'Ref', 'Fn::GetAtt', 'Fn::Sub', 'Fn::Join'];
38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));
39.   }
40. 
41.   compileSNSEvents() {
42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;
43. 
44.     this.serverless.service.getAllFunctions().forEach(functionName => {
45.       const functionObj = this.serverless.service.getFunction(functionName);
46. 
47.       if (functionObj.events) {
48.         functionObj.events.forEach(event => {
49.           if (event.sns) {
50.             let topicArn;
51.             let topicName;
52.             let region;
53.             let displayName = '';
54.             if (typeof event.sns === 'object') {
55.               if (event.sns.arn) {
56.                 topicArn = event.sns.arn;
57.                 if (typeof topicArn === 'object') {
58.                   if (!this.isValidStackImport(topicArn)) {
59.                     throw new this.serverless.classes.Error(
60.                       this.invalidPropertyErrorMessage(functionName, 'arn')
61.                     );
62.                   }
63.                 } else if (typeof topicArn === 'string') {
64.                   if (topicArn.indexOf('arn:') === 0) {
65.                     // NOTE: we need to process the topic ARN that way due to lacking
66.                     // support of regex lookbehind in Node.js 6.
67.                     // Once Node.js 6 support is dropped we can change this to:
68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`
69.                     const splitArn = topicArn
70.                       .replace(/::/g, '@@')
71.                       .split(':')
72.                       .map(s => s.replace(/@@/g, '::'));
73.                     topicName = splitArn[splitArn.length - 1];
74.                     if (splitArn[3] !== this.options.region) {
75.                       region = splitArn[3];
76.                     }
77.                   } else {
78.                     throw new this.serverless.classes.Error(
79.                       this.invalidPropertyErrorMessage(functionName, 'arn')
80.                     );
81.                   }
82.                 } else {
83.                   throw new this.serverless.classes.Error(
84.                     this.invalidPropertyErrorMessage(functionName, 'arn')
85.                   );
86.                 }
87.                 topicName = event.sns.topicName || topicName;
88.                 if (!topicName || typeof topicName !== 'string') {
89.                   throw new this.serverless.classes.Error(
90.                     this.invalidPropertyErrorMessage(functionName, 'topicName')
91.                   );
92.                 }
93.               } else {
94.                 ['topicName', 'displayName'].forEach(property => {
95.                   if (typeof event.sns[property] === 'string') {
96.                     return;
97.                   }
98.                   throw new this.serverless.classes.Error(
99.                     this.invalidPropertyErrorMessage(functionName, property)
100.                   );
101.                 });
102.                 displayName = event.sns.displayName;
103.                 topicName = event.sns.topicName;
104.               }
105.             } else if (typeof event.sns === 'string') {
106.               if (event.sns.indexOf('arn:') === 0) {
107.                 topicArn = event.sns;
108.                 const splitArn = topicArn.split(':');
109.                 topicName = splitArn[splitArn.length - 1];
110.               } else {
111.                 topicName = event.sns;
112.               }
113.             } else {
114.               const errorMessage = [
115.                 `SNS event of function ${functionName} is not an object nor a string`,
116.                 ' The correct syntax is: sns: topic-name-or-arn',
117.                 ' OR an object with ',
118.                 ' arn and topicName OR',
119.                 ' topicName and displayName.',
120.                 ' Please check the docs for more info.',
121.               ].join('');
122.               throw new this.serverless.classes.Error(errorMessage);
123.             }
124. 
125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
126. 
127.             const endpoint = {
128.               'Fn::GetAtt': [lambdaLogicalId, 'Arn'],
129.             };
130. 
131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(
132.               functionName,
133.               topicName
134.             );
135. 
136.             if (topicArn) {
137.               _.merge(template.Resources, {
138.                 [subscriptionLogicalId]: {
139.                   Type: 'AWS::SNS::Subscription',
140.                   Properties: {
141.                     TopicArn: topicArn,
142.                     Protocol: 'lambda',
143.                     Endpoint: endpoint,
144.                     FilterPolicy: event.sns.filterPolicy,
145.                     RedrivePolicy: event.sns.redrivePolicy,
146.                     Region: region,
147.                   },
148.                 },
149.               });
150.             } else {
151.               topicArn = {
152.                 'Fn::Join': [
153.                   '',
154.                   [
155.                     'arn:',
156.                     { Ref: 'AWS::Partition' },
157.                     ':sns:',
158.                     { Ref: 'AWS::Region' },
159.                     ':',
160.                     { Ref: 'AWS::AccountId' },
161.                     ':',
162.                     topicName,
163.                   ],
164.                 ],
165.               };
166. 
167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);
168. 
169.               const subscription = {
170.                 Endpoint: endpoint,
171.                 Protocol: 'lambda',
172.               };
173. 
174.               if (!(topicLogicalId in template.Resources)) {
175.                 _.merge(template.Resources, {
176.                   [topicLogicalId]: {
177.                     Type: 'AWS::SNS::Topic',
178.                     Properties: {
179.                       TopicName: topicName,
180.                       DisplayName: displayName,
181.                     },
182.                   },
183.                 });
184.               }
185. 
186.               if (
187.                 event.sns.filterPolicy ||
188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)
189.               ) {
190.                 _.merge(template.Resources, {
191.                   [subscriptionLogicalId]: {
192.                     Type: 'AWS::SNS::Subscription',
193.                     Properties: _.merge(subscription, {
194.                       TopicArn: {
195.                         Ref: topicLogicalId,
196.                       },
197.                       FilterPolicy: event.sns.filterPolicy,
198.                       RedrivePolicy: event.sns.redrivePolicy,
199.                     }),
200.                   },
201.                 });
202.               } else {
203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {
204.                   template.Resources[topicLogicalId].Properties.Subscription = [];
205.                 }
206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);
207.               }
208.             }
209. 
210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(
211.               functionName,
212.               topicName
213.             );
214. 
215.             _.merge(template.Resources, {
216.               [lambdaPermissionLogicalId]: {
217.                 Type: 'AWS::Lambda::Permission',
218.                 Properties: {
219.                   FunctionName: endpoint,
220.                   Action: 'lambda:InvokeFunction',
221.                   Principal: 'sns.amazonaws.com',
222.                   SourceArn: topicArn,
223.                 },
224.               },
225.             });
226. 
227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
229.                 functionName,
230.                 `${topicName}DLQ`
231.               );
232.               Object.assign(template.Resources, {
233.                 [queuePolicyLogicalId]: {
234.                   Type: 'AWS::SQS::QueuePolicy',
235.                   Properties: {
236.                     PolicyDocument: {
237.                       Version: '2012-10-17',
238.                       Id: queuePolicyLogicalId,
239.                       Statement: [
240.                         {
241.                           Effect: 'Allow',
242.                           Principal: {
243.                             Service: 'sns.amazonaws.com',
244.                           },
245.                           Action: 'sqs:SendMessage',
246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,
247.                           Condition: {
248.                             ArnEquals: {
249.                               'aws:SourceArn': topicArn,
250.                             },
251.                           },
252.                         },
253.                       ],
254.                     },
255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
256.                   },
257.                 },
258.               });
259.             }
260.           }
261.         });
262.       }
263.     });
264.   }
265. }
266. 
267. module.exports = AwsCompileSNSEvents;


File: lib/plugins/aws/package/compile/events/sns/index.test.js
Line number range: 1 - 655
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileSNSEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileSNSEvents', () => {
9.   let serverless;
10.   let awsCompileSNSEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     const options = {
15.       region: 'some-region',
16.     };
17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
18.     serverless.setProvider('aws', new AwsProvider(serverless));
19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
20.   });
21. 
22.   describe('#constructor()', () => {
23.     it('should set the provider variable to an instance of AwsProvider', () =>
24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));
25.   });
26. 
27.   describe('#compileSNSEvents()', () => {
28.     it('should throw an error if SNS event type is not a string or an object', () => {
29.       awsCompileSNSEvents.serverless.service.functions = {
30.         first: {
31.           events: [
32.             {
33.               sns: 42,
34.             },
35.           ],
36.         },
37.       };
38. 
39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);
40.     });
41. 
42.     it('should create corresponding resources when SNS events are given', () => {
43.       awsCompileSNSEvents.serverless.service.functions = {
44.         first: {
45.           events: [
46.             {
47.               sns: {
48.                 topicName: 'Topic 1',
49.                 displayName: 'Display name for topic 1',
50.                 filterPolicy: {
51.                   pet: ['dog', 'cat'],
52.                 },
53.               },
54.             },
55.             {
56.               sns: 'Topic 2',
57.             },
58.           ],
59.         },
60.       };
61. 
62.       awsCompileSNSEvents.compileSNSEvents();
63. 
64.       expect(
65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
66.           .SNSTopicTopic1.Type
67.       ).to.equal('AWS::SNS::Topic');
68.       expect(
69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
70.           .SNSTopicTopic2.Type
71.       ).to.equal('AWS::SNS::Topic');
72.       expect(
73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
74.           .FirstLambdaPermissionTopic1SNS.Type
75.       ).to.equal('AWS::Lambda::Permission');
76.       expect(
77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .FirstLambdaPermissionTopic2SNS.Type
79.       ).to.equal('AWS::Lambda::Permission');
80.       expect(
81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
82.           .FirstSnsSubscriptionTopic1.Type
83.       ).to.equal('AWS::SNS::Subscription');
84.       expect(
85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
87.       ).to.eql({ pet: ['dog', 'cat'] });
88.     });
89. 
90.     it('should create corresponding resources when topic is defined in resources', () => {
91.       awsCompileSNSEvents.serverless.service.functions = {
92.         first: {
93.           events: [
94.             {
95.               sns: {
96.                 topicName: 'Topic 1',
97.                 displayName: 'Display name for topic 1',
98.                 filterPolicy: {
99.                   pet: ['dog', 'cat'],
100.                 },
101.               },
102.             },
103.             {
104.               sns: 'Topic 2',
105.             },
106.           ],
107.         },
108.       };
109. 
110.       Object.assign(
111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
112.         {
113.           SNSTopicTopic2: {
114.             Type: 'AWS::SNS::Topic',
115.             Properties: {
116.               TopicName: 'Topic 2',
117.               DisplayName: 'Display name for topic 2',
118.             },
119.           },
120.         }
121.       );
122. 
123.       awsCompileSNSEvents.compileSNSEvents();
124. 
125.       expect(
126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
127.           .SNSTopicTopic1.Type
128.       ).to.equal('AWS::SNS::Topic');
129.       expect(
130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
131.           .SNSTopicTopic2.Type
132.       ).to.equal('AWS::SNS::Topic');
133.       expect(
134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
135.           .FirstLambdaPermissionTopic1SNS.Type
136.       ).to.equal('AWS::Lambda::Permission');
137.       expect(
138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
139.           .FirstLambdaPermissionTopic2SNS.Type
140.       ).to.equal('AWS::Lambda::Permission');
141.       expect(
142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
143.           .FirstSnsSubscriptionTopic1.Type
144.       ).to.equal('AWS::SNS::Subscription');
145.       expect(
146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy
148.       ).to.eql({ pet: ['dog', 'cat'] });
149.     });
150. 
151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {
152.       awsCompileSNSEvents.serverless.service.functions = {
153.         first: {
154.           events: [
155.             {
156.               sns: {
157.                 topicName: 'Topic 1',
158.                 displayName: 'Display name for topic 1',
159.               },
160.             },
161.             {
162.               sns: 'Topic 1',
163.             },
164.           ],
165.         },
166.       };
167. 
168.       awsCompileSNSEvents.compileSNSEvents();
169. 
170.       expect(
171.         Object.keys(
172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
173.         )
174.       ).to.have.length(2);
175.       expect(
176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
177.           .SNSTopicTopic1.Type
178.       ).to.equal('AWS::SNS::Topic');
179.       expect(
180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
181.           .FirstLambdaPermissionTopic1SNS.Type
182.       ).to.equal('AWS::Lambda::Permission');
183.     });
184. 
185.     it('should throw an error when the event an object and the displayName is not given', () => {
186.       awsCompileSNSEvents.serverless.service.functions = {
187.         first: {
188.           events: [
189.             {
190.               sns: {
191.                 displayName: 'Display name for topic 1',
192.               },
193.             },
194.           ],
195.         },
196.       };
197. 
198.       expect(() => {
199.         awsCompileSNSEvents.compileSNSEvents();
200.       }).to.throw(Error);
201.     });
202. 
203.     it('should not create corresponding resources when SNS events are not given', () => {
204.       awsCompileSNSEvents.serverless.service.functions = {
205.         first: {
206.           events: [],
207.         },
208.       };
209. 
210.       awsCompileSNSEvents.compileSNSEvents();
211. 
212.       expect(
213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
214.       ).to.deep.equal({});
215.     });
216. 
217.     it('should create SNS topic when arn is given as a string', () => {
218.       awsCompileSNSEvents.serverless.service.functions = {
219.         first: {
220.           events: [
221.             {
222.               sns: 'arn:aws:foo',
223.             },
224.           ],
225.         },
226.       };
227. 
228.       awsCompileSNSEvents.compileSNSEvents();
229. 
230.       expect(
231.         Object.keys(
232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
233.         )
234.       ).to.have.length(2);
235.       expect(
236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
237.           .FirstSnsSubscriptionFoo.Type
238.       ).to.equal('AWS::SNS::Subscription');
239.       expect(
240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
241.           .FirstLambdaPermissionFooSNS.Type
242.       ).to.equal('AWS::Lambda::Permission');
243.       expect(
244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy
246.       ).to.equal(undefined);
247.     });
248. 
249.     it('should create SNS topic when only arn is given as an object property', () => {
250.       awsCompileSNSEvents.serverless.service.functions = {
251.         first: {
252.           events: [
253.             {
254.               sns: {
255.                 arn: 'arn:aws:sns:region:accountid:foo',
256.               },
257.             },
258.           ],
259.         },
260.       };
261. 
262.       awsCompileSNSEvents.compileSNSEvents();
263. 
264.       expect(
265.         Object.keys(
266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
267.         )
268.       ).to.have.length(2);
269.       expect(
270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
271.           .FirstSnsSubscriptionFoo.Type
272.       ).to.equal('AWS::SNS::Subscription');
273.       expect(
274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
275.           .FirstLambdaPermissionFooSNS.Type
276.       ).to.equal('AWS::Lambda::Permission');
277.     });
278. 
279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {
280.       awsCompileSNSEvents.serverless.service.functions = {
281.         first: {
282.           events: [
283.             {
284.               sns: {
285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',
286.               },
287.             },
288.           ],
289.         },
290.       };
291. 
292.       awsCompileSNSEvents.compileSNSEvents();
293.       expect(
294.         Object.keys(
295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.         )
297.       ).to.have.length(2);
298.       expect(
299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
300.           .FirstSnsSubscriptionFoo.Type
301.       ).to.equal('AWS::SNS::Subscription');
302.       expect(
303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
304.           .FirstSnsSubscriptionFoo.Properties.Region
305.       ).to.equal('some-other-region');
306.       expect(
307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
308.           .FirstLambdaPermissionFooSNS.Type
309.       ).to.equal('AWS::Lambda::Permission');
310.     });
311. 
312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {
313.       awsCompileSNSEvents.serverless.service.functions = {
314.         first: {
315.           events: [
316.             {
317.               sns: {
318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',
319.               },
320.             },
321.           ],
322.         },
323.       };
324. 
325.       awsCompileSNSEvents.compileSNSEvents();
326.       expect(
327.         Object.keys(
328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
329.         )
330.       ).to.have.length(2);
331.       expect(
332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
333.           .FirstSnsSubscriptionFoo.Type
334.       ).to.equal('AWS::SNS::Subscription');
335.       expect(
336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
337.           .FirstSnsSubscriptionFoo.Properties.Region
338.       ).to.equal('${AWS::Region}');
339.       expect(
340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
341.           .FirstLambdaPermissionFooSNS.Type
342.       ).to.equal('AWS::Lambda::Permission');
343.     });
344. 
345.     it('should throw an error when the arn an object and the value is not a string', () => {
346.       awsCompileSNSEvents.serverless.service.functions = {
347.         first: {
348.           events: [
349.             {
350.               sns: {
351.                 arn: 123,
352.               },
353.             },
354.           ],
355.         },
356.       };
357. 
358.       expect(() => {
359.         awsCompileSNSEvents.compileSNSEvents();
360.       }).to.throw(Error);
361.     });
362. 
363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {
364.       awsCompileSNSEvents.serverless.service.functions = {
365.         first: {
366.           events: [
367.             {
368.               sns: {
369.                 topicName: 'bar',
370.                 arn: 'arn:aws:sns:region:accountid:bar',
371.               },
372.             },
373.           ],
374.         },
375.       };
376. 
377.       awsCompileSNSEvents.compileSNSEvents();
378. 
379.       expect(
380.         Object.keys(
381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
382.         )
383.       ).to.have.length(2);
384.       expect(
385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
386.           .FirstSnsSubscriptionBar.Type
387.       ).to.equal('AWS::SNS::Subscription');
388.       expect(
389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
390.           .FirstLambdaPermissionBarSNS.Type
391.       ).to.equal('AWS::Lambda::Permission');
392.     });
393. 
394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {
395.       awsCompileSNSEvents.serverless.service.functions = {
396.         first: {
397.           events: [
398.             {
399.               sns: {
400.                 topicName: 'first',
401.                 arn: 'arn:aws:sns:region-1:accountid:bar',
402.               },
403.             },
404.             {
405.               sns: {
406.                 topicName: 'second',
407.                 arn: 'arn:aws:sns:region-2:accountid:bar',
408.               },
409.             },
410.           ],
411.         },
412.       };
413. 
414.       awsCompileSNSEvents.compileSNSEvents();
415. 
416.       expect(
417.         Object.keys(
418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
419.         )
420.       ).to.have.length(4);
421.       expect(
422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
423.           .FirstSnsSubscriptionFirst.Type
424.       ).to.equal('AWS::SNS::Subscription');
425.       expect(
426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
427.           .FirstSnsSubscriptionSecond.Type
428.       ).to.equal('AWS::SNS::Subscription');
429.     });
430. 
431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {
432.       awsCompileSNSEvents.serverless.service.functions = {
433.         first: {
434.           events: [
435.             {
436.               sns: {
437.                 topicName: 'foo',
438.                 arn: 'arn:aws:sns:region:accountid:bar',
439.               },
440.             },
441.           ],
442.         },
443.       };
444. 
445.       awsCompileSNSEvents.compileSNSEvents();
446. 
447.       expect(
448.         Object.keys(
449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
450.         )
451.       ).to.have.length(2);
452.       expect(
453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
454.           .FirstSnsSubscriptionFoo.Type
455.       ).to.equal('AWS::SNS::Subscription');
456.       expect(
457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
458.           .FirstLambdaPermissionFooSNS.Type
459.       ).to.equal('AWS::Lambda::Permission');
460.     });
461. 
462.     // eslint-disable-next-line max-len
463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {
464.       awsCompileSNSEvents.serverless.service.functions = {
465.         first: {
466.           events: [
467.             {
468.               sns: {
469.                 topicName: 'bar',
470.                 arn: {
471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
472.                 },
473.               },
474.             },
475.           ],
476.         },
477.       };
478. 
479.       awsCompileSNSEvents.compileSNSEvents();
480. 
481.       expect(
482.         Object.keys(
483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
484.         )
485.       ).to.have.length(2);
486.       expect(
487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
488.           .FirstSnsSubscriptionBar.Type
489.       ).to.equal('AWS::SNS::Subscription');
490.       expect(
491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
492.           .FirstLambdaPermissionBarSNS.Type
493.       ).to.equal('AWS::Lambda::Permission');
494.     });
495. 
496.     // eslint-disable-next-line max-len
497.     it('should throw an error when arn object and no topicName are given as object properties', () => {
498.       awsCompileSNSEvents.serverless.service.functions = {
499.         first: {
500.           events: [
501.             {
502.               sns: {
503.                 arn: {
504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],
505.                 },
506.               },
507.             },
508.           ],
509.         },
510.       };
511. 
512.       expect(() => {
513.         awsCompileSNSEvents.compileSNSEvents();
514.       }).to.throw(Error);
515.     });
516. 
517.     // eslint-disable-next-line max-len
518.     it('should throw an error when invalid imported arn object is given as object properties', () => {
519.       awsCompileSNSEvents.serverless.service.functions = {
520.         first: {
521.           events: [
522.             {
523.               sns: {
524.                 topicName: 'bar',
525.                 arn: {
526.                   'Fn::ImportValue': {
527.                     Ref: 'BarTopic',
528.                   },
529.                 },
530.               },
531.             },
532.           ],
533.         },
534.       };
535. 
536.       expect(() => {
537.         awsCompileSNSEvents.compileSNSEvents();
538.       }).to.throw(Error);
539. 
540.       awsCompileSNSEvents.serverless.service.functions = {
541.         first: {
542.           events: [
543.             {
544.               sns: {
545.                 topicName: 'bar',
546.                 arn: {
547.                   'Fn::ImportValue': {
548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],
549.                   },
550.                 },
551.               },
552.             },
553.           ],
554.         },
555.       };
556. 
557.       expect(() => {
558.         awsCompileSNSEvents.compileSNSEvents();
559.       }).to.throw(Error);
560.     });
561. 
562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {
563.       awsCompileSNSEvents.serverless.service.functions = {
564.         first: {
565.           events: [
566.             {
567.               sns: {
568.                 topicName: 'bar',
569.                 arn: 'arn:aws:sns:region:accountid:bar',
570.                 filterPolicy: {
571.                   pet: ['dog', 'cat'],
572.                 },
573.               },
574.             },
575.           ],
576.         },
577.       };
578. 
579.       awsCompileSNSEvents.compileSNSEvents();
580. 
581.       expect(
582.         Object.keys(
583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
584.         )
585.       ).to.have.length(2);
586.       expect(
587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
588.           .FirstSnsSubscriptionBar.Type
589.       ).to.equal('AWS::SNS::Subscription');
590.       expect(
591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy
593.       ).to.eql({ pet: ['dog', 'cat'] });
594.       expect(
595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
596.           .FirstLambdaPermissionBarSNS.Type
597.       ).to.equal('AWS::Lambda::Permission');
598.     });
599. 
600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {
601.       awsCompileSNSEvents.serverless.service.functions = {
602.         first: {
603.           events: [
604.             {
605.               sns: {
606.                 topicName: 'Topic 1',
607.                 displayName: 'Display name for topic 1',
608.                 redrivePolicy: {
609.                   deadLetterTargetArn: {
610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],
611.                   },
612.                 },
613.               },
614.             },
615.           ],
616.         },
617.       };
618. 
619.       Object.assign(
620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
621.         {
622.           SNSDLQ: {
623.             Type: 'AWS::SQS::Queue',
624.             Properties: {
625.               QueueName: 'SNSDLQ',
626.             },
627.           },
628.         }
629.       );
630. 
631.       awsCompileSNSEvents.compileSNSEvents();
632. 
633.       expect(
634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
635.           .SNSTopicTopic1.Type
636.       ).to.equal('AWS::SNS::Topic');
637.       expect(
638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
639.           .FirstLambdaPermissionTopic1SNS.Type
640.       ).to.equal('AWS::Lambda::Permission');
641.       expect(
642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
643.           .FirstSnsSubscriptionTopic1.Type
644.       ).to.equal('AWS::SNS::Subscription');
645.       expect(
646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy
648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });
649.       expect(
650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
651.           .FirstEventSourceMappingSQSTopic1DLQ.Type
652.       ).to.equal('AWS::SQS::QueuePolicy');
653.     });
654.   });
655. });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:40:58,007 - thread-135845298308800.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We have the full implementation of the SNS events compiler (lib/plugins/aws/package/compile/events/sns/index.js), which contains the logic constructing RedrivePolicy and the SQS QueuePolicy with current incorrect references. We also have the relevant documentation page (docs/providers/aws/events/sns.md) that shows the incorrect example, and the needed naming helpers (getTopicLogicalId, getLambdaSnsSubscriptionLogicalId, getQueueLogicalId). No other modules directly impact this behavior, and class definitions or provider internals aren’t necessary to understand or change the RedrivePolicy/QueuePolicy construction. Therefore, no additional context is required to identify and fix the issue.' query='' extra_requirements='' purpose=''
2025-11-13 20:40:58,010 - thread-135845298308800.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/events/sns.md', content="1. <!--\n2. title: Serverless Framework - AWS Lambda Events - SNS\n3. menuText: SNS\n4. menuOrder: 7\n5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. \n11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)\n12. \n13. <!-- DOCS-SITE-LINK:END -->\n14. \n15. # SNS\n16. \n17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.\n18. \n19. ```yml\n20. functions:\n21.   dispatcher:\n22.     handler: dispatcher.dispatch\n23.     events:\n24.       - sns: dispatch\n25. ```\n26. \n27. You're also able to add the same SNS topic to multiple functions:\n28. \n29. ```yml\n30. functions:\n31.   dispatcher:\n32.     handler: dispatcher.dispatch\n33.     events:\n34.       - sns: dispatch\n35.   dispatcher2:\n36.     handler: dispatcher2.dispatch\n37.     events:\n38.       - sns: dispatch\n39. ```\n40. \n41. This will run both functions for a message sent to the dispatch topic.\n42. \n43. ## Using a pre-existing topic\n44. \n45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.\n46. \n47. ```yml\n48. functions:\n49.   dispatcher:\n50.     handler: dispatcher.dispatch\n51.     events:\n52.       - sns: arn:xxx\n53. ```\n54. \n55. ```yml\n56. functions:\n57.   dispatcher:\n58.     handler: dispatcher.dispatch\n59.     events:\n60.       - sns:\n61.           arn: arn:xxx\n62. ```\n63. \n64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).\n65. **Note:** The arn can be in a different region to enable cross region invocation\n66. \n67. ```yml\n68. functions:\n69.   dispatcher:\n70.     handler: dispatcher.dispatch\n71.     events:\n72.       - sns:\n73.           arn:\n74.             Fn::Join:\n75.               - ':'\n76.               - - 'arn:aws:sns'\n77.                 - Ref: 'AWS::Region'\n78.                 - Ref: 'AWS::AccountId'\n79.                 - 'MyCustomTopic'\n80.           topicName: MyCustomTopic\n81. ```\n82. \n83. If your SNS topic doesn't yet exist but is defined in the serverless.yml file you're editing, you'll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!\n84. \n85. ```yml\n86. functions:\n87.   dispatcher:\n88.     handler: dispatcher.dispatch\n89.     events:\n90.       - sns:\n91.           arn: !Ref SuperTopic\n92.           topicName: MyCustomTopic\n93. \n94. resources:\n95.   Resources:\n96.     SuperTopic:\n97.       Type: AWS::SNS::Topic\n98.       Properties:\n99.         TopicName: MyCustomTopic\n100. ```\n101. \n102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.\n103. \n104. ```yml\n105. functions:\n106.   hello:\n107.     handler: handler.run\n108.     events:\n109.       - sns:\n110.           arn: arn:aws:sns:us-east-1:00000000000:topicname\n111.           topicName: topicname-account-1-us-east-1\n112.       - sns:\n113.           arn: arn:aws:sns:us-east-1:11111111111:topicname\n114.           topicName: topicname-account-2-us-east-1\n115. ```\n116. \n117. ## Setting a display name\n118. \n119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the\n120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the\n121. SNS topic is used for.\n122. \n123. ```yml\n124. functions:\n125.   aggregator:\n126.     handler: aggregator.handler\n127.     events:\n128.       - sns:\n129.           topicName: aggregate\n130.           displayName: Data aggregation pipeline\n131. ```\n132. \n133. ## Setting a filter policy\n134. \n135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don't have attribute key `pet` with value `dog` or `cat`.\n136. \n137. ```yml\n138. functions:\n139.   pets:\n140.     handler: pets.handler\n141.     events:\n142.       - sns:\n143.           topicName: pets\n144.           filterPolicy:\n145.             pet:\n146.               - dog\n147.               - cat\n148. ```\n149. \n150. ## Setting a redrive policy\n151. \n152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\n153. \n154. ```yml\n155. functions:\n156.   dispatcher:\n157.     handler: dispatcher.handler\n158.     events:\n159.       - sns:\n160.           topicName: dispatcher\n161.           redrivePolicy:\n162.             deadLetterTargetArn: !Ref myDLQ\n163. \n164. resources:\n165.   Resources:\n166.     myDLQ:\n167.       Type: AWS::SQS::Queue\n168.       Properties:\n169.         QueueName: myDLQ\n170. ```", start_line_number=1, end_line_number=170), Context(relative_path='lib/plugins/aws/lib/naming.js', content='335.   getTopicLogicalId(topicName) {\n336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;\n337.   },', start_line_number=335, end_line_number=337), Context(relative_path='lib/plugins/aws/lib/naming.js', content='391.   getQueueLogicalId(functionName, queueName) {\n392.     return `${this.getNormalizedFunctionName(\n393.       functionName\n394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;\n395.   },', start_line_number=391, end_line_number=395), Context(relative_path='lib/plugins/aws/lib/naming.js', content='432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {\n433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(\n434.       topicName\n435.     )}`;\n436.   },', start_line_number=432, end_line_number=436), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.js', content='1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileSNSEvents {\n6.   constructor(serverless, options) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9.     this.options = options;\n10.     this.hooks = {\n11.       \'package:compileEvents\': this.compileSNSEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   invalidPropertyErrorMessage(functionName, property) {\n16.     return [\n17.       `Missing or invalid ${property} property for sns event`,\n18.       ` in function "${functionName}"`,\n19.       \' The correct syntax is: sns: topic-name-or-arn\',\n20.       \' OR an object with \',\n21.       \' arn and topicName OR\',\n22.       \' topicName and displayName.\',\n23.       \' Please check the docs for more info.\',\n24.     ].join(\'\');\n25.   }\n26. \n27.   isValidStackImport(variable) {\n28.     if (Object.keys(variable).length !== 1) {\n29.       return false;\n30.     }\n31.     if (\n32.       _.has(variable, \'Fn::ImportValue\') &&\n33.       (_.has(variable, \'Fn::ImportValue.Fn::GetAtt\') || _.has(variable, \'Fn::ImportValue.Ref\'))\n34.     ) {\n35.       return false;\n36.     }\n37.     const intrinsicFunctions = [\'Fn::ImportValue\', \'Ref\', \'Fn::GetAtt\', \'Fn::Sub\', \'Fn::Join\'];\n38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));\n39.   }\n40. \n41.   compileSNSEvents() {\n42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;\n43. \n44.     this.serverless.service.getAllFunctions().forEach(functionName => {\n45.       const functionObj = this.serverless.service.getFunction(functionName);\n46. \n47.       if (functionObj.events) {\n48.         functionObj.events.forEach(event => {\n49.           if (event.sns) {\n50.             let topicArn;\n51.             let topicName;\n52.             let region;\n53.             let displayName = \'\';\n54.             if (typeof event.sns === \'object\') {\n55.               if (event.sns.arn) {\n56.                 topicArn = event.sns.arn;\n57.                 if (typeof topicArn === \'object\') {\n58.                   if (!this.isValidStackImport(topicArn)) {\n59.                     throw new this.serverless.classes.Error(\n60.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n61.                     );\n62.                   }\n63.                 } else if (typeof topicArn === \'string\') {\n64.                   if (topicArn.indexOf(\'arn:\') === 0) {\n65.                     // NOTE: we need to process the topic ARN that way due to lacking\n66.                     // support of regex lookbehind in Node.js 6.\n67.                     // Once Node.js 6 support is dropped we can change this to:\n68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`\n69.                     const splitArn = topicArn\n70.                       .replace(/::/g, \'@@\')\n71.                       .split(\':\')\n72.                       .map(s => s.replace(/@@/g, \'::\'));\n73.                     topicName = splitArn[splitArn.length - 1];\n74.                     if (splitArn[3] !== this.options.region) {\n75.                       region = splitArn[3];\n76.                     }\n77.                   } else {\n78.                     throw new this.serverless.classes.Error(\n79.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n80.                     );\n81.                   }\n82.                 } else {\n83.                   throw new this.serverless.classes.Error(\n84.                     this.invalidPropertyErrorMessage(functionName, \'arn\')\n85.                   );\n86.                 }\n87.                 topicName = event.sns.topicName || topicName;\n88.                 if (!topicName || typeof topicName !== \'string\') {\n89.                   throw new this.serverless.classes.Error(\n90.                     this.invalidPropertyErrorMessage(functionName, \'topicName\')\n91.                   );\n92.                 }\n93.               } else {\n94.                 [\'topicName\', \'displayName\'].forEach(property => {\n95.                   if (typeof event.sns[property] === \'string\') {\n96.                     return;\n97.                   }\n98.                   throw new this.serverless.classes.Error(\n99.                     this.invalidPropertyErrorMessage(functionName, property)\n100.                   );\n101.                 });\n102.                 displayName = event.sns.displayName;\n103.                 topicName = event.sns.topicName;\n104.               }\n105.             } else if (typeof event.sns === \'string\') {\n106.               if (event.sns.indexOf(\'arn:\') === 0) {\n107.                 topicArn = event.sns;\n108.                 const splitArn = topicArn.split(\':\');\n109.                 topicName = splitArn[splitArn.length - 1];\n110.               } else {\n111.                 topicName = event.sns;\n112.               }\n113.             } else {\n114.               const errorMessage = [\n115.                 `SNS event of function ${functionName} is not an object nor a string`,\n116.                 \' The correct syntax is: sns: topic-name-or-arn\',\n117.                 \' OR an object with \',\n118.                 \' arn and topicName OR\',\n119.                 \' topicName and displayName.\',\n120.                 \' Please check the docs for more info.\',\n121.               ].join(\'\');\n122.               throw new this.serverless.classes.Error(errorMessage);\n123.             }\n124. \n125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n126. \n127.             const endpoint = {\n128.               \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n129.             };\n130. \n131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\n132.               functionName,\n133.               topicName\n134.             );\n135. \n136.             if (topicArn) {\n137.               _.merge(template.Resources, {\n138.                 [subscriptionLogicalId]: {\n139.                   Type: \'AWS::SNS::Subscription\',\n140.                   Properties: {\n141.                     TopicArn: topicArn,\n142.                     Protocol: \'lambda\',\n143.                     Endpoint: endpoint,\n144.                     FilterPolicy: event.sns.filterPolicy,\n145.                     RedrivePolicy: event.sns.redrivePolicy,\n146.                     Region: region,\n147.                   },\n148.                 },\n149.               });\n150.             } else {\n151.               topicArn = {\n152.                 \'Fn::Join\': [\n153.                   \'\',\n154.                   [\n155.                     \'arn:\',\n156.                     { Ref: \'AWS::Partition\' },\n157.                     \':sns:\',\n158.                     { Ref: \'AWS::Region\' },\n159.                     \':\',\n160.                     { Ref: \'AWS::AccountId\' },\n161.                     \':\',\n162.                     topicName,\n163.                   ],\n164.                 ],\n165.               };\n166. \n167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);\n168. \n169.               const subscription = {\n170.                 Endpoint: endpoint,\n171.                 Protocol: \'lambda\',\n172.               };\n173. \n174.               if (!(topicLogicalId in template.Resources)) {\n175.                 _.merge(template.Resources, {\n176.                   [topicLogicalId]: {\n177.                     Type: \'AWS::SNS::Topic\',\n178.                     Properties: {\n179.                       TopicName: topicName,\n180.                       DisplayName: displayName,\n181.                     },\n182.                   },\n183.                 });\n184.               }\n185. \n186.               if (\n187.                 event.sns.filterPolicy ||\n188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)\n189.               ) {\n190.                 _.merge(template.Resources, {\n191.                   [subscriptionLogicalId]: {\n192.                     Type: \'AWS::SNS::Subscription\',\n193.                     Properties: _.merge(subscription, {\n194.                       TopicArn: {\n195.                         Ref: topicLogicalId,\n196.                       },\n197.                       FilterPolicy: event.sns.filterPolicy,\n198.                       RedrivePolicy: event.sns.redrivePolicy,\n199.                     }),\n200.                   },\n201.                 });\n202.               } else {\n203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {\n204.                   template.Resources[topicLogicalId].Properties.Subscription = [];\n205.                 }\n206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);\n207.               }\n208.             }\n209. \n210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(\n211.               functionName,\n212.               topicName\n213.             );\n214. \n215.             _.merge(template.Resources, {\n216.               [lambdaPermissionLogicalId]: {\n217.                 Type: \'AWS::Lambda::Permission\',\n218.                 Properties: {\n219.                   FunctionName: endpoint,\n220.                   Action: \'lambda:InvokeFunction\',\n221.                   Principal: \'sns.amazonaws.com\',\n222.                   SourceArn: topicArn,\n223.                 },\n224.               },\n225.             });\n226. \n227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n229.                 functionName,\n230.                 `${topicName}DLQ`\n231.               );\n232.               Object.assign(template.Resources, {\n233.                 [queuePolicyLogicalId]: {\n234.                   Type: \'AWS::SQS::QueuePolicy\',\n235.                   Properties: {\n236.                     PolicyDocument: {\n237.                       Version: \'2012-10-17\',\n238.                       Id: queuePolicyLogicalId,\n239.                       Statement: [\n240.                         {\n241.                           Effect: \'Allow\',\n242.                           Principal: {\n243.                             Service: \'sns.amazonaws.com\',\n244.                           },\n245.                           Action: \'sqs:SendMessage\',\n246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,\n247.                           Condition: {\n248.                             ArnEquals: {\n249.                               \'aws:SourceArn\': topicArn,\n250.                             },\n251.                           },\n252.                         },\n253.                       ],\n254.                     },\n255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\n256.                   },\n257.                 },\n258.               });\n259.             }\n260.           }\n261.         });\n262.       }\n263.     });\n264.   }\n265. }\n266. \n267. module.exports = AwsCompileSNSEvents;', start_line_number=1, end_line_number=267), Context(relative_path='lib/plugins/aws/package/compile/events/sns/index.test.js', content="1. 'use strict';\n2. \n3. const expect = require('chai').expect;\n4. const AwsProvider = require('../../../../provider/awsProvider');\n5. const AwsCompileSNSEvents = require('./index');\n6. const Serverless = require('../../../../../../Serverless');\n7. \n8. describe('AwsCompileSNSEvents', () => {\n9.   let serverless;\n10.   let awsCompileSNSEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     const options = {\n15.       region: 'some-region',\n16.     };\n17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n18.     serverless.setProvider('aws', new AwsProvider(serverless));\n19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\n20.   });\n21. \n22.   describe('#constructor()', () => {\n23.     it('should set the provider variable to an instance of AwsProvider', () =>\n24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));\n25.   });\n26. \n27.   describe('#compileSNSEvents()', () => {\n28.     it('should throw an error if SNS event type is not a string or an object', () => {\n29.       awsCompileSNSEvents.serverless.service.functions = {\n30.         first: {\n31.           events: [\n32.             {\n33.               sns: 42,\n34.             },\n35.           ],\n36.         },\n37.       };\n38. \n39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);\n40.     });\n41. \n42.     it('should create corresponding resources when SNS events are given', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: 'Topic 1',\n49.                 displayName: 'Display name for topic 1',\n50.                 filterPolicy: {\n51.                   pet: ['dog', 'cat'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: 'Topic 2',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal('AWS::SNS::Topic');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal('AWS::SNS::Topic');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal('AWS::Lambda::Permission');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal('AWS::Lambda::Permission');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal('AWS::SNS::Subscription');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: ['dog', 'cat'] });\n88.     });\n89. \n90.     it('should create corresponding resources when topic is defined in resources', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: 'Topic 1',\n97.                 displayName: 'Display name for topic 1',\n98.                 filterPolicy: {\n99.                   pet: ['dog', 'cat'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: 'Topic 2',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: 'AWS::SNS::Topic',\n115.             Properties: {\n116.               TopicName: 'Topic 2',\n117.               DisplayName: 'Display name for topic 2',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal('AWS::SNS::Topic');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal('AWS::SNS::Topic');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal('AWS::Lambda::Permission');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal('AWS::Lambda::Permission');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal('AWS::SNS::Subscription');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: ['dog', 'cat'] });\n149.     });\n150. \n151.     it('should create single SNS topic when the same topic is referenced repeatedly', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: 'Topic 1',\n158.                 displayName: 'Display name for topic 1',\n159.               },\n160.             },\n161.             {\n162.               sns: 'Topic 1',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal('AWS::SNS::Topic');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal('AWS::Lambda::Permission');\n183.     });\n184. \n185.     it('should throw an error when the event an object and the displayName is not given', () => {\n186.       awsCompileSNSEvents.serverless.service.functions = {\n187.         first: {\n188.           events: [\n189.             {\n190.               sns: {\n191.                 displayName: 'Display name for topic 1',\n192.               },\n193.             },\n194.           ],\n195.         },\n196.       };\n197. \n198.       expect(() => {\n199.         awsCompileSNSEvents.compileSNSEvents();\n200.       }).to.throw(Error);\n201.     });\n202. \n203.     it('should not create corresponding resources when SNS events are not given', () => {\n204.       awsCompileSNSEvents.serverless.service.functions = {\n205.         first: {\n206.           events: [],\n207.         },\n208.       };\n209. \n210.       awsCompileSNSEvents.compileSNSEvents();\n211. \n212.       expect(\n213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.       ).to.deep.equal({});\n215.     });\n216. \n217.     it('should create SNS topic when arn is given as a string', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: 'arn:aws:foo',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal('AWS::SNS::Subscription');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal('AWS::Lambda::Permission');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });\n248. \n249.     it('should create SNS topic when only arn is given as an object property', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: 'arn:aws:sns:region:accountid:foo',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal('AWS::SNS::Subscription');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal('AWS::Lambda::Permission');\n277.     });\n278. \n279.     it('should create a cross region subscription when SNS topic arn in a different region than provider', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: 'arn:aws:sns:some-other-region:accountid:foo',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal('AWS::SNS::Subscription');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal('some-other-region');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal('AWS::Lambda::Permission');\n310.     });\n311. \n312.     it('should create a cross region subscription when SNS topic arn in a different region is using pseudo params', () => {\n313.       awsCompileSNSEvents.serverless.service.functions = {\n314.         first: {\n315.           events: [\n316.             {\n317.               sns: {\n318.                 arn: 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo',\n319.               },\n320.             },\n321.           ],\n322.         },\n323.       };\n324. \n325.       awsCompileSNSEvents.compileSNSEvents();\n326.       expect(\n327.         Object.keys(\n328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n329.         )\n330.       ).to.have.length(2);\n331.       expect(\n332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n333.           .FirstSnsSubscriptionFoo.Type\n334.       ).to.equal('AWS::SNS::Subscription');\n335.       expect(\n336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n337.           .FirstSnsSubscriptionFoo.Properties.Region\n338.       ).to.equal('${AWS::Region}');\n339.       expect(\n340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n341.           .FirstLambdaPermissionFooSNS.Type\n342.       ).to.equal('AWS::Lambda::Permission');\n343.     });\n344. \n345.     it('should throw an error when the arn an object and the value is not a string', () => {\n346.       awsCompileSNSEvents.serverless.service.functions = {\n347.         first: {\n348.           events: [\n349.             {\n350.               sns: {\n351.                 arn: 123,\n352.               },\n353.             },\n354.           ],\n355.         },\n356.       };\n357. \n358.       expect(() => {\n359.         awsCompileSNSEvents.compileSNSEvents();\n360.       }).to.throw(Error);\n361.     });\n362. \n363.     it('should create SNS topic when both arn and topicName are given as object properties', () => {\n364.       awsCompileSNSEvents.serverless.service.functions = {\n365.         first: {\n366.           events: [\n367.             {\n368.               sns: {\n369.                 topicName: 'bar',\n370.                 arn: 'arn:aws:sns:region:accountid:bar',\n371.               },\n372.             },\n373.           ],\n374.         },\n375.       };\n376. \n377.       awsCompileSNSEvents.compileSNSEvents();\n378. \n379.       expect(\n380.         Object.keys(\n381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n382.         )\n383.       ).to.have.length(2);\n384.       expect(\n385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n386.           .FirstSnsSubscriptionBar.Type\n387.       ).to.equal('AWS::SNS::Subscription');\n388.       expect(\n389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n390.           .FirstLambdaPermissionBarSNS.Type\n391.       ).to.equal('AWS::Lambda::Permission');\n392.     });\n393. \n394.     it('should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified', () => {\n395.       awsCompileSNSEvents.serverless.service.functions = {\n396.         first: {\n397.           events: [\n398.             {\n399.               sns: {\n400.                 topicName: 'first',\n401.                 arn: 'arn:aws:sns:region-1:accountid:bar',\n402.               },\n403.             },\n404.             {\n405.               sns: {\n406.                 topicName: 'second',\n407.                 arn: 'arn:aws:sns:region-2:accountid:bar',\n408.               },\n409.             },\n410.           ],\n411.         },\n412.       };\n413. \n414.       awsCompileSNSEvents.compileSNSEvents();\n415. \n416.       expect(\n417.         Object.keys(\n418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n419.         )\n420.       ).to.have.length(4);\n421.       expect(\n422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n423.           .FirstSnsSubscriptionFirst.Type\n424.       ).to.equal('AWS::SNS::Subscription');\n425.       expect(\n426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n427.           .FirstSnsSubscriptionSecond.Type\n428.       ).to.equal('AWS::SNS::Subscription');\n429.     });\n430. \n431.     it('should override SNS topic subsription CF resource name when arn and topicName are given as object properties', () => {\n432.       awsCompileSNSEvents.serverless.service.functions = {\n433.         first: {\n434.           events: [\n435.             {\n436.               sns: {\n437.                 topicName: 'foo',\n438.                 arn: 'arn:aws:sns:region:accountid:bar',\n439.               },\n440.             },\n441.           ],\n442.         },\n443.       };\n444. \n445.       awsCompileSNSEvents.compileSNSEvents();\n446. \n447.       expect(\n448.         Object.keys(\n449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n450.         )\n451.       ).to.have.length(2);\n452.       expect(\n453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n454.           .FirstSnsSubscriptionFoo.Type\n455.       ).to.equal('AWS::SNS::Subscription');\n456.       expect(\n457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n458.           .FirstLambdaPermissionFooSNS.Type\n459.       ).to.equal('AWS::Lambda::Permission');\n460.     });\n461. \n462.     // eslint-disable-next-line max-len\n463.     it('should create SNS topic when arn object and topicName are given as object properties', () => {\n464.       awsCompileSNSEvents.serverless.service.functions = {\n465.         first: {\n466.           events: [\n467.             {\n468.               sns: {\n469.                 topicName: 'bar',\n470.                 arn: {\n471.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],\n472.                 },\n473.               },\n474.             },\n475.           ],\n476.         },\n477.       };\n478. \n479.       awsCompileSNSEvents.compileSNSEvents();\n480. \n481.       expect(\n482.         Object.keys(\n483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n484.         )\n485.       ).to.have.length(2);\n486.       expect(\n487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n488.           .FirstSnsSubscriptionBar.Type\n489.       ).to.equal('AWS::SNS::Subscription');\n490.       expect(\n491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n492.           .FirstLambdaPermissionBarSNS.Type\n493.       ).to.equal('AWS::Lambda::Permission');\n494.     });\n495. \n496.     // eslint-disable-next-line max-len\n497.     it('should throw an error when arn object and no topicName are given as object properties', () => {\n498.       awsCompileSNSEvents.serverless.service.functions = {\n499.         first: {\n500.           events: [\n501.             {\n502.               sns: {\n503.                 arn: {\n504.                   'Fn::Join': [':', ['arn:aws:sns', '${AWS::Region}', '${AWS::AccountId}', 'bar']],\n505.                 },\n506.               },\n507.             },\n508.           ],\n509.         },\n510.       };\n511. \n512.       expect(() => {\n513.         awsCompileSNSEvents.compileSNSEvents();\n514.       }).to.throw(Error);\n515.     });\n516. \n517.     // eslint-disable-next-line max-len\n518.     it('should throw an error when invalid imported arn object is given as object properties', () => {\n519.       awsCompileSNSEvents.serverless.service.functions = {\n520.         first: {\n521.           events: [\n522.             {\n523.               sns: {\n524.                 topicName: 'bar',\n525.                 arn: {\n526.                   'Fn::ImportValue': {\n527.                     Ref: 'BarTopic',\n528.                   },\n529.                 },\n530.               },\n531.             },\n532.           ],\n533.         },\n534.       };\n535. \n536.       expect(() => {\n537.         awsCompileSNSEvents.compileSNSEvents();\n538.       }).to.throw(Error);\n539. \n540.       awsCompileSNSEvents.serverless.service.functions = {\n541.         first: {\n542.           events: [\n543.             {\n544.               sns: {\n545.                 topicName: 'bar',\n546.                 arn: {\n547.                   'Fn::ImportValue': {\n548.                     'Fn::GetAtt': ['BarTopic', 'Arn'],\n549.                   },\n550.                 },\n551.               },\n552.             },\n553.           ],\n554.         },\n555.       };\n556. \n557.       expect(() => {\n558.         awsCompileSNSEvents.compileSNSEvents();\n559.       }).to.throw(Error);\n560.     });\n561. \n562.     it('should create SNS topic when arn, topicName, and filterPolicy are given as object', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: 'bar',\n569.                 arn: 'arn:aws:sns:region:accountid:bar',\n570.                 filterPolicy: {\n571.                   pet: ['dog', 'cat'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal('AWS::SNS::Subscription');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: ['dog', 'cat'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal('AWS::Lambda::Permission');\n598.     });\n599. \n600.     it('should link topic to corresponding dlq when redrivePolicy is defined', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: 'Topic 1',\n607.                 displayName: 'Display name for topic 1',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     'Fn::GetAtt': ['SNSDLQ', 'Arn'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: 'AWS::SQS::Queue',\n624.             Properties: {\n625.               QueueName: 'SNSDLQ',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal('AWS::SNS::Topic');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal('AWS::Lambda::Permission');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal('AWS::SNS::Subscription');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal('AWS::SQS::QueuePolicy');\n653.     });\n654.   });\n655. });", start_line_number=1, end_line_number=655)]
2025-11-13 20:40:58,013 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_analyzer_message_node - DEBUG - Sending message to IssueBugAnalyzerNode:
content='I am going to share details about an issue reported to a codebase and its related bug context.\nPlease analyze this bug and provide a high-level description of what needs to be changed:\n\n1. Issue Understanding:\n- Analyze the issue title, description, and comments provided\n- Identify the reported symptoms and unexpected behaviors\n\n2. Code Analysis:\n- Identify which files, functions, or code blocks are involved\n- Explain what the problematic code is currently doing\n\n3. Root Cause:\n- Explain why the current behavior is incorrect\n- Identify which specific parts of the code are causing the issue\n\n4. Fix Suggestion:\nFor each needed change, describe in plain English:\n- Which file needs to be modified\n- Which function or code block needs changes\n- What needs to be changed (e.g., "rename variable x to y", "add null check for parameter z")\n- Why this change would fix the issue\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be changed.\n\nHere are the details for analysis:\n\nIssue title:\nRedrive Policy not properly referencing queue\n\nIssue description: \n\n\n## Description\n\nRecentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.\n````\nResource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]\n````\n\n````\nQueues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget\n````\n\nThis translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.\n\nIn this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.\nOther solutions would involve more complex things like trying to generate the url from the Arn. I\'m open to whatever you think is best and will start a PR as soon as there\'s consensus\n\n#7239 \n\n\nIssue comments:\n\n\nBug Context:\nFile: docs/providers/aws/events/sns.md\nLine number range: 1 - 170\nContent:\n1. <!--\n2. title: Serverless Framework - AWS Lambda Events - SNS\n3. menuText: SNS\n4. menuOrder: 7\n5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. \n11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)\n12. \n13. <!-- DOCS-SITE-LINK:END -->\n14. \n15. # SNS\n16. \n17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.\n18. \n19. ```yml\n20. functions:\n21.   dispatcher:\n22.     handler: dispatcher.dispatch\n23.     events:\n24.       - sns: dispatch\n25. ```\n26. \n27. You\'re also able to add the same SNS topic to multiple functions:\n28. \n29. ```yml\n30. functions:\n31.   dispatcher:\n32.     handler: dispatcher.dispatch\n33.     events:\n34.       - sns: dispatch\n35.   dispatcher2:\n36.     handler: dispatcher2.dispatch\n37.     events:\n38.       - sns: dispatch\n39. ```\n40. \n41. This will run both functions for a message sent to the dispatch topic.\n42. \n43. ## Using a pre-existing topic\n44. \n45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.\n46. \n47. ```yml\n48. functions:\n49.   dispatcher:\n50.     handler: dispatcher.dispatch\n51.     events:\n52.       - sns: arn:xxx\n53. ```\n54. \n55. ```yml\n56. functions:\n57.   dispatcher:\n58.     handler: dispatcher.dispatch\n59.     events:\n60.       - sns:\n61.           arn: arn:xxx\n62. ```\n63. \n64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).\n65. **Note:** The arn can be in a different region to enable cross region invocation\n66. \n67. ```yml\n68. functions:\n69.   dispatcher:\n70.     handler: dispatcher.dispatch\n71.     events:\n72.       - sns:\n73.           arn:\n74.             Fn::Join:\n75.               - \':\'\n76.               - - \'arn:aws:sns\'\n77.                 - Ref: \'AWS::Region\'\n78.                 - Ref: \'AWS::AccountId\'\n79.                 - \'MyCustomTopic\'\n80.           topicName: MyCustomTopic\n81. ```\n82. \n83. If your SNS topic doesn\'t yet exist but is defined in the serverless.yml file you\'re editing, you\'ll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!\n84. \n85. ```yml\n86. functions:\n87.   dispatcher:\n88.     handler: dispatcher.dispatch\n89.     events:\n90.       - sns:\n91.           arn: !Ref SuperTopic\n92.           topicName: MyCustomTopic\n93. \n94. resources:\n95.   Resources:\n96.     SuperTopic:\n97.       Type: AWS::SNS::Topic\n98.       Properties:\n99.         TopicName: MyCustomTopic\n100. ```\n101. \n102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.\n103. \n104. ```yml\n105. functions:\n106.   hello:\n107.     handler: handler.run\n108.     events:\n109.       - sns:\n110.           arn: arn:aws:sns:us-east-1:00000000000:topicname\n111.           topicName: topicname-account-1-us-east-1\n112.       - sns:\n113.           arn: arn:aws:sns:us-east-1:11111111111:topicname\n114.           topicName: topicname-account-2-us-east-1\n115. ```\n116. \n117. ## Setting a display name\n118. \n119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the\n120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the\n121. SNS topic is used for.\n122. \n123. ```yml\n124. functions:\n125.   aggregator:\n126.     handler: aggregator.handler\n127.     events:\n128.       - sns:\n129.           topicName: aggregate\n130.           displayName: Data aggregation pipeline\n131. ```\n132. \n133. ## Setting a filter policy\n134. \n135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don\'t have attribute key `pet` with value `dog` or `cat`.\n136. \n137. ```yml\n138. functions:\n139.   pets:\n140.     handler: pets.handler\n141.     events:\n142.       - sns:\n143.           topicName: pets\n144.           filterPolicy:\n145.             pet:\n146.               - dog\n147.               - cat\n148. ```\n149. \n150. ## Setting a redrive policy\n151. \n152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren\'t delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\n153. \n154. ```yml\n155. functions:\n156.   dispatcher:\n157.     handler: dispatcher.handler\n158.     events:\n159.       - sns:\n160.           topicName: dispatcher\n161.           redrivePolicy:\n162.             deadLetterTargetArn: !Ref myDLQ\n163. \n164. resources:\n165.   Resources:\n166.     myDLQ:\n167.       Type: AWS::SQS::Queue\n168.       Properties:\n169.         QueueName: myDLQ\n170. ```\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 335 - 337\nContent:\n335.   getTopicLogicalId(topicName) {\n336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;\n337.   },\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 391 - 395\nContent:\n391.   getQueueLogicalId(functionName, queueName) {\n392.     return `${this.getNormalizedFunctionName(\n393.       functionName\n394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;\n395.   },\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 432 - 436\nContent:\n432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {\n433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(\n434.       topicName\n435.     )}`;\n436.   },\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.js\nLine number range: 1 - 267\nContent:\n1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileSNSEvents {\n6.   constructor(serverless, options) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9.     this.options = options;\n10.     this.hooks = {\n11.       \'package:compileEvents\': this.compileSNSEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   invalidPropertyErrorMessage(functionName, property) {\n16.     return [\n17.       `Missing or invalid ${property} property for sns event`,\n18.       ` in function "${functionName}"`,\n19.       \' The correct syntax is: sns: topic-name-or-arn\',\n20.       \' OR an object with \',\n21.       \' arn and topicName OR\',\n22.       \' topicName and displayName.\',\n23.       \' Please check the docs for more info.\',\n24.     ].join(\'\');\n25.   }\n26. \n27.   isValidStackImport(variable) {\n28.     if (Object.keys(variable).length !== 1) {\n29.       return false;\n30.     }\n31.     if (\n32.       _.has(variable, \'Fn::ImportValue\') &&\n33.       (_.has(variable, \'Fn::ImportValue.Fn::GetAtt\') || _.has(variable, \'Fn::ImportValue.Ref\'))\n34.     ) {\n35.       return false;\n36.     }\n37.     const intrinsicFunctions = [\'Fn::ImportValue\', \'Ref\', \'Fn::GetAtt\', \'Fn::Sub\', \'Fn::Join\'];\n38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));\n39.   }\n40. \n41.   compileSNSEvents() {\n42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;\n43. \n44.     this.serverless.service.getAllFunctions().forEach(functionName => {\n45.       const functionObj = this.serverless.service.getFunction(functionName);\n46. \n47.       if (functionObj.events) {\n48.         functionObj.events.forEach(event => {\n49.           if (event.sns) {\n50.             let topicArn;\n51.             let topicName;\n52.             let region;\n53.             let displayName = \'\';\n54.             if (typeof event.sns === \'object\') {\n55.               if (event.sns.arn) {\n56.                 topicArn = event.sns.arn;\n57.                 if (typeof topicArn === \'object\') {\n58.                   if (!this.isValidStackImport(topicArn)) {\n59.                     throw new this.serverless.classes.Error(\n60.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n61.                     );\n62.                   }\n63.                 } else if (typeof topicArn === \'string\') {\n64.                   if (topicArn.indexOf(\'arn:\') === 0) {\n65.                     // NOTE: we need to process the topic ARN that way due to lacking\n66.                     // support of regex lookbehind in Node.js 6.\n67.                     // Once Node.js 6 support is dropped we can change this to:\n68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`\n69.                     const splitArn = topicArn\n70.                       .replace(/::/g, \'@@\')\n71.                       .split(\':\')\n72.                       .map(s => s.replace(/@@/g, \'::\'));\n73.                     topicName = splitArn[splitArn.length - 1];\n74.                     if (splitArn[3] !== this.options.region) {\n75.                       region = splitArn[3];\n76.                     }\n77.                   } else {\n78.                     throw new this.serverless.classes.Error(\n79.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n80.                     );\n81.                   }\n82.                 } else {\n83.                   throw new this.serverless.classes.Error(\n84.                     this.invalidPropertyErrorMessage(functionName, \'arn\')\n85.                   );\n86.                 }\n87.                 topicName = event.sns.topicName || topicName;\n88.                 if (!topicName || typeof topicName !== \'string\') {\n89.                   throw new this.serverless.classes.Error(\n90.                     this.invalidPropertyErrorMessage(functionName, \'topicName\')\n91.                   );\n92.                 }\n93.               } else {\n94.                 [\'topicName\', \'displayName\'].forEach(property => {\n95.                   if (typeof event.sns[property] === \'string\') {\n96.                     return;\n97.                   }\n98.                   throw new this.serverless.classes.Error(\n99.                     this.invalidPropertyErrorMessage(functionName, property)\n100.                   );\n101.                 });\n102.                 displayName = event.sns.displayName;\n103.                 topicName = event.sns.topicName;\n104.               }\n105.             } else if (typeof event.sns === \'string\') {\n106.               if (event.sns.indexOf(\'arn:\') === 0) {\n107.                 topicArn = event.sns;\n108.                 const splitArn = topicArn.split(\':\');\n109.                 topicName = splitArn[splitArn.length - 1];\n110.               } else {\n111.                 topicName = event.sns;\n112.               }\n113.             } else {\n114.               const errorMessage = [\n115.                 `SNS event of function ${functionName} is not an object nor a string`,\n116.                 \' The correct syntax is: sns: topic-name-or-arn\',\n117.                 \' OR an object with \',\n118.                 \' arn and topicName OR\',\n119.                 \' topicName and displayName.\',\n120.                 \' Please check the docs for more info.\',\n121.               ].join(\'\');\n122.               throw new this.serverless.classes.Error(errorMessage);\n123.             }\n124. \n125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n126. \n127.             const endpoint = {\n128.               \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n129.             };\n130. \n131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\n132.               functionName,\n133.               topicName\n134.             );\n135. \n136.             if (topicArn) {\n137.               _.merge(template.Resources, {\n138.                 [subscriptionLogicalId]: {\n139.                   Type: \'AWS::SNS::Subscription\',\n140.                   Properties: {\n141.                     TopicArn: topicArn,\n142.                     Protocol: \'lambda\',\n143.                     Endpoint: endpoint,\n144.                     FilterPolicy: event.sns.filterPolicy,\n145.                     RedrivePolicy: event.sns.redrivePolicy,\n146.                     Region: region,\n147.                   },\n148.                 },\n149.               });\n150.             } else {\n151.               topicArn = {\n152.                 \'Fn::Join\': [\n153.                   \'\',\n154.                   [\n155.                     \'arn:\',\n156.                     { Ref: \'AWS::Partition\' },\n157.                     \':sns:\',\n158.                     { Ref: \'AWS::Region\' },\n159.                     \':\',\n160.                     { Ref: \'AWS::AccountId\' },\n161.                     \':\',\n162.                     topicName,\n163.                   ],\n164.                 ],\n165.               };\n166. \n167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);\n168. \n169.               const subscription = {\n170.                 Endpoint: endpoint,\n171.                 Protocol: \'lambda\',\n172.               };\n173. \n174.               if (!(topicLogicalId in template.Resources)) {\n175.                 _.merge(template.Resources, {\n176.                   [topicLogicalId]: {\n177.                     Type: \'AWS::SNS::Topic\',\n178.                     Properties: {\n179.                       TopicName: topicName,\n180.                       DisplayName: displayName,\n181.                     },\n182.                   },\n183.                 });\n184.               }\n185. \n186.               if (\n187.                 event.sns.filterPolicy ||\n188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)\n189.               ) {\n190.                 _.merge(template.Resources, {\n191.                   [subscriptionLogicalId]: {\n192.                     Type: \'AWS::SNS::Subscription\',\n193.                     Properties: _.merge(subscription, {\n194.                       TopicArn: {\n195.                         Ref: topicLogicalId,\n196.                       },\n197.                       FilterPolicy: event.sns.filterPolicy,\n198.                       RedrivePolicy: event.sns.redrivePolicy,\n199.                     }),\n200.                   },\n201.                 });\n202.               } else {\n203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {\n204.                   template.Resources[topicLogicalId].Properties.Subscription = [];\n205.                 }\n206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);\n207.               }\n208.             }\n209. \n210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(\n211.               functionName,\n212.               topicName\n213.             );\n214. \n215.             _.merge(template.Resources, {\n216.               [lambdaPermissionLogicalId]: {\n217.                 Type: \'AWS::Lambda::Permission\',\n218.                 Properties: {\n219.                   FunctionName: endpoint,\n220.                   Action: \'lambda:InvokeFunction\',\n221.                   Principal: \'sns.amazonaws.com\',\n222.                   SourceArn: topicArn,\n223.                 },\n224.               },\n225.             });\n226. \n227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n229.                 functionName,\n230.                 `${topicName}DLQ`\n231.               );\n232.               Object.assign(template.Resources, {\n233.                 [queuePolicyLogicalId]: {\n234.                   Type: \'AWS::SQS::QueuePolicy\',\n235.                   Properties: {\n236.                     PolicyDocument: {\n237.                       Version: \'2012-10-17\',\n238.                       Id: queuePolicyLogicalId,\n239.                       Statement: [\n240.                         {\n241.                           Effect: \'Allow\',\n242.                           Principal: {\n243.                             Service: \'sns.amazonaws.com\',\n244.                           },\n245.                           Action: \'sqs:SendMessage\',\n246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,\n247.                           Condition: {\n248.                             ArnEquals: {\n249.                               \'aws:SourceArn\': topicArn,\n250.                             },\n251.                           },\n252.                         },\n253.                       ],\n254.                     },\n255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\n256.                   },\n257.                 },\n258.               });\n259.             }\n260.           }\n261.         });\n262.       }\n263.     });\n264.   }\n265. }\n266. \n267. module.exports = AwsCompileSNSEvents;\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 1 - 655\nContent:\n1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsProvider = require(\'../../../../provider/awsProvider\');\n5. const AwsCompileSNSEvents = require(\'./index\');\n6. const Serverless = require(\'../../../../../../Serverless\');\n7. \n8. describe(\'AwsCompileSNSEvents\', () => {\n9.   let serverless;\n10.   let awsCompileSNSEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     const options = {\n15.       region: \'some-region\',\n16.     };\n17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n18.     serverless.setProvider(\'aws\', new AwsProvider(serverless));\n19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\n20.   });\n21. \n22.   describe(\'#constructor()\', () => {\n23.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));\n25.   });\n26. \n27.   describe(\'#compileSNSEvents()\', () => {\n28.     it(\'should throw an error if SNS event type is not a string or an object\', () => {\n29.       awsCompileSNSEvents.serverless.service.functions = {\n30.         first: {\n31.           events: [\n32.             {\n33.               sns: 42,\n34.             },\n35.           ],\n36.         },\n37.       };\n38. \n39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);\n40.     });\n41. \n42.     it(\'should create corresponding resources when SNS events are given\', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: \'Topic 1\',\n49.                 displayName: \'Display name for topic 1\',\n50.                 filterPolicy: {\n51.                   pet: [\'dog\', \'cat\'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: \'Topic 2\',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal(\'AWS::SNS::Topic\');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal(\'AWS::SNS::Topic\');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal(\'AWS::Lambda::Permission\');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal(\'AWS::Lambda::Permission\');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal(\'AWS::SNS::Subscription\');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n88.     });\n89. \n90.     it(\'should create corresponding resources when topic is defined in resources\', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: \'Topic 1\',\n97.                 displayName: \'Display name for topic 1\',\n98.                 filterPolicy: {\n99.                   pet: [\'dog\', \'cat\'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: \'Topic 2\',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: \'AWS::SNS::Topic\',\n115.             Properties: {\n116.               TopicName: \'Topic 2\',\n117.               DisplayName: \'Display name for topic 2\',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal(\'AWS::SNS::Topic\');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal(\'AWS::SNS::Topic\');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal(\'AWS::Lambda::Permission\');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal(\'AWS::Lambda::Permission\');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal(\'AWS::SNS::Subscription\');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n149.     });\n150. \n151.     it(\'should create single SNS topic when the same topic is referenced repeatedly\', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: \'Topic 1\',\n158.                 displayName: \'Display name for topic 1\',\n159.               },\n160.             },\n161.             {\n162.               sns: \'Topic 1\',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal(\'AWS::SNS::Topic\');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal(\'AWS::Lambda::Permission\');\n183.     });\n184. \n185.     it(\'should throw an error when the event an object and the displayName is not given\', () => {\n186.       awsCompileSNSEvents.serverless.service.functions = {\n187.         first: {\n188.           events: [\n189.             {\n190.               sns: {\n191.                 displayName: \'Display name for topic 1\',\n192.               },\n193.             },\n194.           ],\n195.         },\n196.       };\n197. \n198.       expect(() => {\n199.         awsCompileSNSEvents.compileSNSEvents();\n200.       }).to.throw(Error);\n201.     });\n202. \n203.     it(\'should not create corresponding resources when SNS events are not given\', () => {\n204.       awsCompileSNSEvents.serverless.service.functions = {\n205.         first: {\n206.           events: [],\n207.         },\n208.       };\n209. \n210.       awsCompileSNSEvents.compileSNSEvents();\n211. \n212.       expect(\n213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.       ).to.deep.equal({});\n215.     });\n216. \n217.     it(\'should create SNS topic when arn is given as a string\', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: \'arn:aws:foo\',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal(\'AWS::SNS::Subscription\');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal(\'AWS::Lambda::Permission\');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });\n248. \n249.     it(\'should create SNS topic when only arn is given as an object property\', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: \'arn:aws:sns:region:accountid:foo\',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal(\'AWS::SNS::Subscription\');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal(\'AWS::Lambda::Permission\');\n277.     });\n278. \n279.     it(\'should create a cross region subscription when SNS topic arn in a different region than provider\', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: \'arn:aws:sns:some-other-region:accountid:foo\',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal(\'AWS::SNS::Subscription\');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal(\'some-other-region\');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal(\'AWS::Lambda::Permission\');\n310.     });\n311. \n312.     it(\'should create a cross region subscription when SNS topic arn in a different region is using pseudo params\', () => {\n313.       awsCompileSNSEvents.serverless.service.functions = {\n314.         first: {\n315.           events: [\n316.             {\n317.               sns: {\n318.                 arn: \'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo\',\n319.               },\n320.             },\n321.           ],\n322.         },\n323.       };\n324. \n325.       awsCompileSNSEvents.compileSNSEvents();\n326.       expect(\n327.         Object.keys(\n328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n329.         )\n330.       ).to.have.length(2);\n331.       expect(\n332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n333.           .FirstSnsSubscriptionFoo.Type\n334.       ).to.equal(\'AWS::SNS::Subscription\');\n335.       expect(\n336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n337.           .FirstSnsSubscriptionFoo.Properties.Region\n338.       ).to.equal(\'${AWS::Region}\');\n339.       expect(\n340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n341.           .FirstLambdaPermissionFooSNS.Type\n342.       ).to.equal(\'AWS::Lambda::Permission\');\n343.     });\n344. \n345.     it(\'should throw an error when the arn an object and the value is not a string\', () => {\n346.       awsCompileSNSEvents.serverless.service.functions = {\n347.         first: {\n348.           events: [\n349.             {\n350.               sns: {\n351.                 arn: 123,\n352.               },\n353.             },\n354.           ],\n355.         },\n356.       };\n357. \n358.       expect(() => {\n359.         awsCompileSNSEvents.compileSNSEvents();\n360.       }).to.throw(Error);\n361.     });\n362. \n363.     it(\'should create SNS topic when both arn and topicName are given as object properties\', () => {\n364.       awsCompileSNSEvents.serverless.service.functions = {\n365.         first: {\n366.           events: [\n367.             {\n368.               sns: {\n369.                 topicName: \'bar\',\n370.                 arn: \'arn:aws:sns:region:accountid:bar\',\n371.               },\n372.             },\n373.           ],\n374.         },\n375.       };\n376. \n377.       awsCompileSNSEvents.compileSNSEvents();\n378. \n379.       expect(\n380.         Object.keys(\n381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n382.         )\n383.       ).to.have.length(2);\n384.       expect(\n385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n386.           .FirstSnsSubscriptionBar.Type\n387.       ).to.equal(\'AWS::SNS::Subscription\');\n388.       expect(\n389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n390.           .FirstLambdaPermissionBarSNS.Type\n391.       ).to.equal(\'AWS::Lambda::Permission\');\n392.     });\n393. \n394.     it(\'should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified\', () => {\n395.       awsCompileSNSEvents.serverless.service.functions = {\n396.         first: {\n397.           events: [\n398.             {\n399.               sns: {\n400.                 topicName: \'first\',\n401.                 arn: \'arn:aws:sns:region-1:accountid:bar\',\n402.               },\n403.             },\n404.             {\n405.               sns: {\n406.                 topicName: \'second\',\n407.                 arn: \'arn:aws:sns:region-2:accountid:bar\',\n408.               },\n409.             },\n410.           ],\n411.         },\n412.       };\n413. \n414.       awsCompileSNSEvents.compileSNSEvents();\n415. \n416.       expect(\n417.         Object.keys(\n418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n419.         )\n420.       ).to.have.length(4);\n421.       expect(\n422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n423.           .FirstSnsSubscriptionFirst.Type\n424.       ).to.equal(\'AWS::SNS::Subscription\');\n425.       expect(\n426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n427.           .FirstSnsSubscriptionSecond.Type\n428.       ).to.equal(\'AWS::SNS::Subscription\');\n429.     });\n430. \n431.     it(\'should override SNS topic subsription CF resource name when arn and topicName are given as object properties\', () => {\n432.       awsCompileSNSEvents.serverless.service.functions = {\n433.         first: {\n434.           events: [\n435.             {\n436.               sns: {\n437.                 topicName: \'foo\',\n438.                 arn: \'arn:aws:sns:region:accountid:bar\',\n439.               },\n440.             },\n441.           ],\n442.         },\n443.       };\n444. \n445.       awsCompileSNSEvents.compileSNSEvents();\n446. \n447.       expect(\n448.         Object.keys(\n449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n450.         )\n451.       ).to.have.length(2);\n452.       expect(\n453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n454.           .FirstSnsSubscriptionFoo.Type\n455.       ).to.equal(\'AWS::SNS::Subscription\');\n456.       expect(\n457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n458.           .FirstLambdaPermissionFooSNS.Type\n459.       ).to.equal(\'AWS::Lambda::Permission\');\n460.     });\n461. \n462.     // eslint-disable-next-line max-len\n463.     it(\'should create SNS topic when arn object and topicName are given as object properties\', () => {\n464.       awsCompileSNSEvents.serverless.service.functions = {\n465.         first: {\n466.           events: [\n467.             {\n468.               sns: {\n469.                 topicName: \'bar\',\n470.                 arn: {\n471.                   \'Fn::Join\': [\':\', [\'arn:aws:sns\', \'${AWS::Region}\', \'${AWS::AccountId}\', \'bar\']],\n472.                 },\n473.               },\n474.             },\n475.           ],\n476.         },\n477.       };\n478. \n479.       awsCompileSNSEvents.compileSNSEvents();\n480. \n481.       expect(\n482.         Object.keys(\n483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n484.         )\n485.       ).to.have.length(2);\n486.       expect(\n487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n488.           .FirstSnsSubscriptionBar.Type\n489.       ).to.equal(\'AWS::SNS::Subscription\');\n490.       expect(\n491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n492.           .FirstLambdaPermissionBarSNS.Type\n493.       ).to.equal(\'AWS::Lambda::Permission\');\n494.     });\n495. \n496.     // eslint-disable-next-line max-len\n497.     it(\'should throw an error when arn object and no topicName are given as object properties\', () => {\n498.       awsCompileSNSEvents.serverless.service.functions = {\n499.         first: {\n500.           events: [\n501.             {\n502.               sns: {\n503.                 arn: {\n504.                   \'Fn::Join\': [\':\', [\'arn:aws:sns\', \'${AWS::Region}\', \'${AWS::AccountId}\', \'bar\']],\n505.                 },\n506.               },\n507.             },\n508.           ],\n509.         },\n510.       };\n511. \n512.       expect(() => {\n513.         awsCompileSNSEvents.compileSNSEvents();\n514.       }).to.throw(Error);\n515.     });\n516. \n517.     // eslint-disable-next-line max-len\n518.     it(\'should throw an error when invalid imported arn object is given as object properties\', () => {\n519.       awsCompileSNSEvents.serverless.service.functions = {\n520.         first: {\n521.           events: [\n522.             {\n523.               sns: {\n524.                 topicName: \'bar\',\n525.                 arn: {\n526.                   \'Fn::ImportValue\': {\n527.                     Ref: \'BarTopic\',\n528.                   },\n529.                 },\n530.               },\n531.             },\n532.           ],\n533.         },\n534.       };\n535. \n536.       expect(() => {\n537.         awsCompileSNSEvents.compileSNSEvents();\n538.       }).to.throw(Error);\n539. \n540.       awsCompileSNSEvents.serverless.service.functions = {\n541.         first: {\n542.           events: [\n543.             {\n544.               sns: {\n545.                 topicName: \'bar\',\n546.                 arn: {\n547.                   \'Fn::ImportValue\': {\n548.                     \'Fn::GetAtt\': [\'BarTopic\', \'Arn\'],\n549.                   },\n550.                 },\n551.               },\n552.             },\n553.           ],\n554.         },\n555.       };\n556. \n557.       expect(() => {\n558.         awsCompileSNSEvents.compileSNSEvents();\n559.       }).to.throw(Error);\n560.     });\n561. \n562.     it(\'should create SNS topic when arn, topicName, and filterPolicy are given as object\', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: \'bar\',\n569.                 arn: \'arn:aws:sns:region:accountid:bar\',\n570.                 filterPolicy: {\n571.                   pet: [\'dog\', \'cat\'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal(\'AWS::SNS::Subscription\');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal(\'AWS::Lambda::Permission\');\n598.     });\n599. \n600.     it(\'should link topic to corresponding dlq when redrivePolicy is defined\', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: \'Topic 1\',\n607.                 displayName: \'Display name for topic 1\',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     \'Fn::GetAtt\': [\'SNSDLQ\', \'Arn\'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: \'AWS::SQS::Queue\',\n624.             Properties: {\n625.               QueueName: \'SNSDLQ\',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal(\'AWS::SNS::Topic\');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal(\'AWS::Lambda::Permission\');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal(\'AWS::SNS::Subscription\');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { \'Fn::GetAtt\': [\'SNSDLQ\', \'Arn\'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal(\'AWS::SQS::QueuePolicy\');\n653.     });\n654.   });\n655. });\n\n' additional_kwargs={} response_metadata={}
2025-11-13 20:41:54,974 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_analyzer_node - DEBUG - content="1) Issue Understanding\n\n- Reported symptom: Deployments fail when using SNS redrivePolicy because the generated SQS QueuePolicy references the DLQ incorrectly. Specifically:\n  - The QueuePolicy PolicyDocument.Statement[].Resource must be the SQS queue ARN.\n  - The QueuePolicy Queues property must be the SQS queue URL (Ref of the queue resource).\n- Current behavior uses the same value (whatever is provided as deadLetterTargetArn) for both Resource and Queues, which is incorrect. The docs also incorrectly show using Ref for deadLetterTargetArn, which is a URL, not an ARN, causing mismatches.\n- Consequences: CloudFormation errors during deployment due to type mismatches and/or SNS not being granted permission to send to the DLQ.\n\n2) Code Analysis\n\n- Affected implementation:\n  - File: lib/plugins/aws/package/compile/events/sns/index.js\n    - Function: compileSNSEvents()\n    - Block lines ~227–259: Creation of the AWS::SQS::QueuePolicy when event.sns.redrivePolicy.deadLetterTargetArn is provided.\n      - It currently sets:\n        - PolicyDocument.Statement[0].Resource = event.sns.redrivePolicy.deadLetterTargetArn\n        - Queues = [event.sns.redrivePolicy.deadLetterTargetArn]\n      - This assumes the same value can serve both as ARN and URL, which is wrong.\n    - Earlier in the same function, RedrivePolicy is passed through unchanged to AWS::SNS::Subscription.\n\n- Affected docs:\n  - File: docs/providers/aws/events/sns.md\n    - Section “Setting a redrive policy” (lines 150–170): The example shows deadLetterTargetArn: !Ref myDLQ, which returns a queue URL, not an ARN, and is therefore incorrect for the property named deadLetterTargetArn.\n\n- Tests:\n  - File: lib/plugins/aws/package/compile/events/sns/index.test.js\n    - Test “should link topic to corresponding dlq when redrivePolicy is defined” (lines ~600–653) asserts creation of QueuePolicy but does not verify that:\n      - PolicyDocument.Statement[].Resource is an ARN (GetAtt ... Arn)\n      - Queues uses a Ref (URL)\n    - Missing tests for cases where deadLetterTargetArn is provided as Ref (URL) vs as GetAtt (ARN) and for the case of external queues where QueuePolicy cannot be created from ARN alone.\n\n3) Root Cause\n\n- The compiler uses the same deadLetterTargetArn value for both ARN and URL contexts in the generated AWS::SQS::QueuePolicy:\n  - Resource expects an ARN.\n  - Queues expects a URL (Ref of the queue resource).\n- Documentation instructs users to provide deadLetterTargetArn using Ref, which returns a URL; that is incompatible with the “Arn” requirement and also makes it impossible to generate the URL and ARN pair correctly.\n- There is no normalization step to interpret a provided Ref (to a local SQS queue) and convert it to the proper Arn (GetAtt) for the subscription RedrivePolicy and to proper Ref for the QueuePolicy’s Queues.\n\n4) Fix Suggestion\n\nA) Implementation changes in lib/plugins/aws/package/compile/events/sns/index.js\n\n- Function: compileSNSEvents()\n- Add a normalization step for redrivePolicy before resources are created:\n  - If event.sns.redrivePolicy and event.sns.redrivePolicy.deadLetterTargetArn are present:\n    - If deadLetterTargetArn is a Ref to a local SQS queue resource (i.e., an object with Ref pointing to a logical ID defined in template.Resources of type AWS::SQS::Queue):\n      - Replace event.sns.redrivePolicy.deadLetterTargetArn with a GetAtt on that logical ID’s Arn (i.e., create an Arn expression), so the subscription RedrivePolicy gets a proper ARN.\n      - Keep track of the queue logical ID for use in QueuePolicy (see next bullet).\n    - If deadLetterTargetArn is a GetAtt on [localQueueLogicalId, 'Arn']:\n      - Keep it as-is for the subscription RedrivePolicy.\n      - Keep track of localQueueLogicalId.\n    - Otherwise (deadLetterTargetArn provided as a raw ARN string, import, or other non-local expression):\n      - Do not attempt to create an AWS::SQS::QueuePolicy since the queue URL (Ref) cannot be derived. The queue policy must be managed in the external stack owning the queue. Optionally, emit a warning in logs.\n\n- Adjust the QueuePolicy creation block (lines ~227–259):\n  - Only create AWS::SQS::QueuePolicy if a localQueueLogicalId has been determined via the normalization step above.\n  - Set PolicyDocument.Statement[0].Resource to the queue ARN using GetAtt on localQueueLogicalId (do not use the raw event value).\n  - Set Queues to an array containing a Ref to localQueueLogicalId (Ref returns the URL).\n  - Keep the SourceArn condition using topicArn as currently done.\n\n- Rationale:\n  - Ensures the RedrivePolicy on the subscription receives an ARN, as required.\n  - Ensures QueuePolicy uses the correct ARN for Resource and URL (Ref) for Queues.\n  - Avoids generating invalid QueuePolicy when the queue is external and only an ARN is known.\n\nB) Documentation changes in docs/providers/aws/events/sns.md\n\n- Section: “Setting a redrive policy” (lines 150–170).\n- Change the example to use an ARN for deadLetterTargetArn via GetAtt, not Ref:\n  - deadLetterTargetArn: !GetAtt myDLQ.Arn (or the long-form Fn::GetAtt)\n- Add a note:\n  - If the DLQ is defined in the same serverless.yml (same stack), the framework will also attach a policy to the queue to allow SNS to send messages to it.\n  - If you reference a DLQ ARN from an external stack/account, the framework will not be able to create a QueuePolicy (as it cannot compute the queue URL). Ensure that the external queue has an appropriate policy allowing sns:SendMessage from your SNS topic.\n- Remove/adjust any language suggesting that Ref can be used for deadLetterTargetArn (Ref returns a URL, not an ARN, and is not suitable for the Arn field).\n\nC) Test updates in lib/plugins/aws/package/compile/events/sns/index.test.js\n\n- In the test “should link topic to corresponding dlq when redrivePolicy is defined”:\n  - Add assertions that:\n    - The generated QueuePolicy Properties.Queues equals an array with a Ref to the queue logical ID (e.g., [{ Ref: 'SNSDLQ' }]).\n    - The PolicyDocument.Statement[0].Resource equals a GetAtt on the same queue logical ID’s Arn.\n- Add a test covering the case when deadLetterTargetArn is mistakenly provided as a Ref to a local queue:\n  - Expect the compiler to normalize it to a GetAtt for the subscription’s RedrivePolicy and to create a QueuePolicy with Queues as Ref and Resource as GetAtt.\n- Add a test for deadLetterTargetArn provided as a raw ARN (external queue):\n  - Expect that no QueuePolicy is created in the stack, and possibly verify a logged warning if applicable.\n\nWhy these changes fix the issue\n\n- They ensure CloudFormation types are correct:\n  - RedrivePolicy.deadLetterTargetArn receives an ARN.\n  - QueuePolicy.Resource uses ARN.\n  - QueuePolicy.Queues uses URL (Ref).\n- They prevent invalid QueuePolicy creation when the DLQ is not part of the same stack and its URL cannot be obtained.\n- They correct the documentation so users provide the appropriate intrinsic function, avoiding future misconfigurations." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5456, 'prompt_tokens': 11221, 'total_tokens': 16677, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3840, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--64467d26-a3a5-420e-afa2-8a2d60107992-0' usage_metadata={'input_tokens': 11221, 'output_tokens': 5456, 'total_tokens': 16677, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3840}}
2025-11-13 20:41:54,979 - thread-135845298308800.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nRedrive Policy not properly referencing queue\n\nIssue description: \n\n\n## Description\n\nRecentely, I have been able to test serverless 1.62 which includes the option to use redriverPolicy for sns events. However, when I submited a PR for that feature, I overlooked the param specificacion format on the queuePolicy that is created. To be more specific, the Resource part needs to be an ARN but the Queue needs to be defined by URL.\n````\nResource: event.sns.redrivePolicy.deadLetterTargetArn -> should be a Fn::GetAtt [deadLetterTarget, Arn]\n````\n\n````\nQueues: [event.sns.redrivePolicy.deadLetterTargetArn], -> should be a Ref: deadLetterTarget\n````\n\nThis translates in using GetAtt Arn for one thing and Ref for the other, while now both use the ARN (which leads to deployment errors). Also, the documentation says that Ref can be used which is wrong since it would only provide one of the needed values.\n\nIn this case, what I think would be easier is just to pass the queue resource name to the sns event redrivepolicy section (like myDLQ), and build the GetAtt and Ref inside.\nOther solutions would involve more complex things like trying to generate the url from the Arn. I\'m open to whatever you think is best and will start a PR as soon as there\'s consensus\n\n#7239 \n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/sns.md\nLine number range: 1 - 170\nContent:\n1. <!--\n2. title: Serverless Framework - AWS Lambda Events - SNS\n3. menuText: SNS\n4. menuOrder: 7\n5. description:  Setting up AWS SNS Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. \n11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/sns)\n12. \n13. <!-- DOCS-SITE-LINK:END -->\n14. \n15. # SNS\n16. \n17. In the following example we create a new SNS topic with the name `dispatch` which is bound to the `dispatcher` function. The function will be called every time a message is sent to the `dispatch` topic.\n18. \n19. ```yml\n20. functions:\n21.   dispatcher:\n22.     handler: dispatcher.dispatch\n23.     events:\n24.       - sns: dispatch\n25. ```\n26. \n27. You\'re also able to add the same SNS topic to multiple functions:\n28. \n29. ```yml\n30. functions:\n31.   dispatcher:\n32.     handler: dispatcher.dispatch\n33.     events:\n34.       - sns: dispatch\n35.   dispatcher2:\n36.     handler: dispatcher2.dispatch\n37.     events:\n38.       - sns: dispatch\n39. ```\n40. \n41. This will run both functions for a message sent to the dispatch topic.\n42. \n43. ## Using a pre-existing topic\n44. \n45. If an `arn:` is specified, the framework will give permission to the topic to invoke the function and subscribe the function to the topic.\n46. \n47. ```yml\n48. functions:\n49.   dispatcher:\n50.     handler: dispatcher.dispatch\n51.     events:\n52.       - sns: arn:xxx\n53. ```\n54. \n55. ```yml\n56. functions:\n57.   dispatcher:\n58.     handler: dispatcher.dispatch\n59.     events:\n60.       - sns:\n61.           arn: arn:xxx\n62. ```\n63. \n64. Or with intrinsic CloudFormation function like `Fn::Join`, `Fn::GetAtt`, or `Fn::Ref` (or their shorthand counterparts).\n65. **Note:** The arn can be in a different region to enable cross region invocation\n66. \n67. ```yml\n68. functions:\n69.   dispatcher:\n70.     handler: dispatcher.dispatch\n71.     events:\n72.       - sns:\n73.           arn:\n74.             Fn::Join:\n75.               - \':\'\n76.               - - \'arn:aws:sns\'\n77.                 - Ref: \'AWS::Region\'\n78.                 - Ref: \'AWS::AccountId\'\n79.                 - \'MyCustomTopic\'\n80.           topicName: MyCustomTopic\n81. ```\n82. \n83. If your SNS topic doesn\'t yet exist but is defined in the serverless.yml file you\'re editing, you\'ll need to use `Fn::Ref` or `!Ref` to get the ARN. Do not build a string as in the above example!\n84. \n85. ```yml\n86. functions:\n87.   dispatcher:\n88.     handler: dispatcher.dispatch\n89.     events:\n90.       - sns:\n91.           arn: !Ref SuperTopic\n92.           topicName: MyCustomTopic\n93. \n94. resources:\n95.   Resources:\n96.     SuperTopic:\n97.       Type: AWS::SNS::Topic\n98.       Properties:\n99.         TopicName: MyCustomTopic\n100. ```\n101. \n102. **Note:** If an `arn` string is specified but not a `topicName`, the last substring starting with `:` will be extracted as the `topicName`. If an `arn` object is specified, `topicName` must be specified as a string, used only to name the underlying Cloudformation mapping resources. You can take advantage of this behavior when subscribing to multiple topics with the same name in different regions/accounts to avoid collisions between Cloudformation resource names.\n103. \n104. ```yml\n105. functions:\n106.   hello:\n107.     handler: handler.run\n108.     events:\n109.       - sns:\n110.           arn: arn:aws:sns:us-east-1:00000000000:topicname\n111.           topicName: topicname-account-1-us-east-1\n112.       - sns:\n113.           arn: arn:aws:sns:us-east-1:11111111111:topicname\n114.           topicName: topicname-account-2-us-east-1\n115. ```\n116. \n117. ## Setting a display name\n118. \n119. This event definition ensures that the `aggregator` function gets called every time a message is sent to the\n120. `aggregate` topic. `Data aggregation pipeline` will be shown in the AWS console so that the user can understand what the\n121. SNS topic is used for.\n122. \n123. ```yml\n124. functions:\n125.   aggregator:\n126.     handler: aggregator.handler\n127.     events:\n128.       - sns:\n129.           topicName: aggregate\n130.           displayName: Data aggregation pipeline\n131. ```\n132. \n133. ## Setting a filter policy\n134. \n135. This event definition creates an SNS topic which subscription uses a filter policy. The filter policy filters out messages that don\'t have attribute key `pet` with value `dog` or `cat`.\n136. \n137. ```yml\n138. functions:\n139.   pets:\n140.     handler: pets.handler\n141.     events:\n142.       - sns:\n143.           topicName: pets\n144.           filterPolicy:\n145.             pet:\n146.               - dog\n147.               - cat\n148. ```\n149. \n150. ## Setting a redrive policy\n151. \n152. This event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren\'t delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\n153. \n154. ```yml\n155. functions:\n156.   dispatcher:\n157.     handler: dispatcher.handler\n158.     events:\n159.       - sns:\n160.           topicName: dispatcher\n161.           redrivePolicy:\n162.             deadLetterTargetArn: !Ref myDLQ\n163. \n164. resources:\n165.   Resources:\n166.     myDLQ:\n167.       Type: AWS::SQS::Queue\n168.       Properties:\n169.         QueueName: myDLQ\n170. ```\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 335 - 337\nContent:\n335.   getTopicLogicalId(topicName) {\n336.     return `SNSTopic${this.normalizeTopicName(topicName)}`;\n337.   },\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 391 - 395\nContent:\n391.   getQueueLogicalId(functionName, queueName) {\n392.     return `${this.getNormalizedFunctionName(\n393.       functionName\n394.     )}EventSourceMappingSQS${this.normalizeNameToAlphaNumericOnly(queueName)}`;\n395.   },\n\n\nFile: lib/plugins/aws/lib/naming.js\nLine number range: 432 - 436\nContent:\n432.   getLambdaSnsSubscriptionLogicalId(functionName, topicName) {\n433.     return `${this.getNormalizedFunctionName(functionName)}SnsSubscription${this.normalizeTopicName(\n434.       topicName\n435.     )}`;\n436.   },\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.js\nLine number range: 1 - 267\nContent:\n1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileSNSEvents {\n6.   constructor(serverless, options) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9.     this.options = options;\n10.     this.hooks = {\n11.       \'package:compileEvents\': this.compileSNSEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   invalidPropertyErrorMessage(functionName, property) {\n16.     return [\n17.       `Missing or invalid ${property} property for sns event`,\n18.       ` in function "${functionName}"`,\n19.       \' The correct syntax is: sns: topic-name-or-arn\',\n20.       \' OR an object with \',\n21.       \' arn and topicName OR\',\n22.       \' topicName and displayName.\',\n23.       \' Please check the docs for more info.\',\n24.     ].join(\'\');\n25.   }\n26. \n27.   isValidStackImport(variable) {\n28.     if (Object.keys(variable).length !== 1) {\n29.       return false;\n30.     }\n31.     if (\n32.       _.has(variable, \'Fn::ImportValue\') &&\n33.       (_.has(variable, \'Fn::ImportValue.Fn::GetAtt\') || _.has(variable, \'Fn::ImportValue.Ref\'))\n34.     ) {\n35.       return false;\n36.     }\n37.     const intrinsicFunctions = [\'Fn::ImportValue\', \'Ref\', \'Fn::GetAtt\', \'Fn::Sub\', \'Fn::Join\'];\n38.     return !!_.find(intrinsicFunctions, func => _.has(variable, func));\n39.   }\n40. \n41.   compileSNSEvents() {\n42.     const template = this.serverless.service.provider.compiledCloudFormationTemplate;\n43. \n44.     this.serverless.service.getAllFunctions().forEach(functionName => {\n45.       const functionObj = this.serverless.service.getFunction(functionName);\n46. \n47.       if (functionObj.events) {\n48.         functionObj.events.forEach(event => {\n49.           if (event.sns) {\n50.             let topicArn;\n51.             let topicName;\n52.             let region;\n53.             let displayName = \'\';\n54.             if (typeof event.sns === \'object\') {\n55.               if (event.sns.arn) {\n56.                 topicArn = event.sns.arn;\n57.                 if (typeof topicArn === \'object\') {\n58.                   if (!this.isValidStackImport(topicArn)) {\n59.                     throw new this.serverless.classes.Error(\n60.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n61.                     );\n62.                   }\n63.                 } else if (typeof topicArn === \'string\') {\n64.                   if (topicArn.indexOf(\'arn:\') === 0) {\n65.                     // NOTE: we need to process the topic ARN that way due to lacking\n66.                     // support of regex lookbehind in Node.js 6.\n67.                     // Once Node.js 6 support is dropped we can change this to:\n68.                     // `const splitArn = topicArn.split(/(?<!:):(?!:)/);`\n69.                     const splitArn = topicArn\n70.                       .replace(/::/g, \'@@\')\n71.                       .split(\':\')\n72.                       .map(s => s.replace(/@@/g, \'::\'));\n73.                     topicName = splitArn[splitArn.length - 1];\n74.                     if (splitArn[3] !== this.options.region) {\n75.                       region = splitArn[3];\n76.                     }\n77.                   } else {\n78.                     throw new this.serverless.classes.Error(\n79.                       this.invalidPropertyErrorMessage(functionName, \'arn\')\n80.                     );\n81.                   }\n82.                 } else {\n83.                   throw new this.serverless.classes.Error(\n84.                     this.invalidPropertyErrorMessage(functionName, \'arn\')\n85.                   );\n86.                 }\n87.                 topicName = event.sns.topicName || topicName;\n88.                 if (!topicName || typeof topicName !== \'string\') {\n89.                   throw new this.serverless.classes.Error(\n90.                     this.invalidPropertyErrorMessage(functionName, \'topicName\')\n91.                   );\n92.                 }\n93.               } else {\n94.                 [\'topicName\', \'displayName\'].forEach(property => {\n95.                   if (typeof event.sns[property] === \'string\') {\n96.                     return;\n97.                   }\n98.                   throw new this.serverless.classes.Error(\n99.                     this.invalidPropertyErrorMessage(functionName, property)\n100.                   );\n101.                 });\n102.                 displayName = event.sns.displayName;\n103.                 topicName = event.sns.topicName;\n104.               }\n105.             } else if (typeof event.sns === \'string\') {\n106.               if (event.sns.indexOf(\'arn:\') === 0) {\n107.                 topicArn = event.sns;\n108.                 const splitArn = topicArn.split(\':\');\n109.                 topicName = splitArn[splitArn.length - 1];\n110.               } else {\n111.                 topicName = event.sns;\n112.               }\n113.             } else {\n114.               const errorMessage = [\n115.                 `SNS event of function ${functionName} is not an object nor a string`,\n116.                 \' The correct syntax is: sns: topic-name-or-arn\',\n117.                 \' OR an object with \',\n118.                 \' arn and topicName OR\',\n119.                 \' topicName and displayName.\',\n120.                 \' Please check the docs for more info.\',\n121.               ].join(\'\');\n122.               throw new this.serverless.classes.Error(errorMessage);\n123.             }\n124. \n125.             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n126. \n127.             const endpoint = {\n128.               \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\n129.             };\n130. \n131.             const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\n132.               functionName,\n133.               topicName\n134.             );\n135. \n136.             if (topicArn) {\n137.               _.merge(template.Resources, {\n138.                 [subscriptionLogicalId]: {\n139.                   Type: \'AWS::SNS::Subscription\',\n140.                   Properties: {\n141.                     TopicArn: topicArn,\n142.                     Protocol: \'lambda\',\n143.                     Endpoint: endpoint,\n144.                     FilterPolicy: event.sns.filterPolicy,\n145.                     RedrivePolicy: event.sns.redrivePolicy,\n146.                     Region: region,\n147.                   },\n148.                 },\n149.               });\n150.             } else {\n151.               topicArn = {\n152.                 \'Fn::Join\': [\n153.                   \'\',\n154.                   [\n155.                     \'arn:\',\n156.                     { Ref: \'AWS::Partition\' },\n157.                     \':sns:\',\n158.                     { Ref: \'AWS::Region\' },\n159.                     \':\',\n160.                     { Ref: \'AWS::AccountId\' },\n161.                     \':\',\n162.                     topicName,\n163.                   ],\n164.                 ],\n165.               };\n166. \n167.               const topicLogicalId = this.provider.naming.getTopicLogicalId(topicName);\n168. \n169.               const subscription = {\n170.                 Endpoint: endpoint,\n171.                 Protocol: \'lambda\',\n172.               };\n173. \n174.               if (!(topicLogicalId in template.Resources)) {\n175.                 _.merge(template.Resources, {\n176.                   [topicLogicalId]: {\n177.                     Type: \'AWS::SNS::Topic\',\n178.                     Properties: {\n179.                       TopicName: topicName,\n180.                       DisplayName: displayName,\n181.                     },\n182.                   },\n183.                 });\n184.               }\n185. \n186.               if (\n187.                 event.sns.filterPolicy ||\n188.                 (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn)\n189.               ) {\n190.                 _.merge(template.Resources, {\n191.                   [subscriptionLogicalId]: {\n192.                     Type: \'AWS::SNS::Subscription\',\n193.                     Properties: _.merge(subscription, {\n194.                       TopicArn: {\n195.                         Ref: topicLogicalId,\n196.                       },\n197.                       FilterPolicy: event.sns.filterPolicy,\n198.                       RedrivePolicy: event.sns.redrivePolicy,\n199.                     }),\n200.                   },\n201.                 });\n202.               } else {\n203.                 if (!template.Resources[topicLogicalId].Properties.Subscription) {\n204.                   template.Resources[topicLogicalId].Properties.Subscription = [];\n205.                 }\n206.                 template.Resources[topicLogicalId].Properties.Subscription.push(subscription);\n207.               }\n208.             }\n209. \n210.             const lambdaPermissionLogicalId = this.provider.naming.getLambdaSnsPermissionLogicalId(\n211.               functionName,\n212.               topicName\n213.             );\n214. \n215.             _.merge(template.Resources, {\n216.               [lambdaPermissionLogicalId]: {\n217.                 Type: \'AWS::Lambda::Permission\',\n218.                 Properties: {\n219.                   FunctionName: endpoint,\n220.                   Action: \'lambda:InvokeFunction\',\n221.                   Principal: \'sns.amazonaws.com\',\n222.                   SourceArn: topicArn,\n223.                 },\n224.               },\n225.             });\n226. \n227.             if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n228.               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n229.                 functionName,\n230.                 `${topicName}DLQ`\n231.               );\n232.               Object.assign(template.Resources, {\n233.                 [queuePolicyLogicalId]: {\n234.                   Type: \'AWS::SQS::QueuePolicy\',\n235.                   Properties: {\n236.                     PolicyDocument: {\n237.                       Version: \'2012-10-17\',\n238.                       Id: queuePolicyLogicalId,\n239.                       Statement: [\n240.                         {\n241.                           Effect: \'Allow\',\n242.                           Principal: {\n243.                             Service: \'sns.amazonaws.com\',\n244.                           },\n245.                           Action: \'sqs:SendMessage\',\n246.                           Resource: event.sns.redrivePolicy.deadLetterTargetArn,\n247.                           Condition: {\n248.                             ArnEquals: {\n249.                               \'aws:SourceArn\': topicArn,\n250.                             },\n251.                           },\n252.                         },\n253.                       ],\n254.                     },\n255.                     Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\n256.                   },\n257.                 },\n258.               });\n259.             }\n260.           }\n261.         });\n262.       }\n263.     });\n264.   }\n265. }\n266. \n267. module.exports = AwsCompileSNSEvents;\n\n\nFile: lib/plugins/aws/package/compile/events/sns/index.test.js\nLine number range: 1 - 655\nContent:\n1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsProvider = require(\'../../../../provider/awsProvider\');\n5. const AwsCompileSNSEvents = require(\'./index\');\n6. const Serverless = require(\'../../../../../../Serverless\');\n7. \n8. describe(\'AwsCompileSNSEvents\', () => {\n9.   let serverless;\n10.   let awsCompileSNSEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     const options = {\n15.       region: \'some-region\',\n16.     };\n17.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n18.     serverless.setProvider(\'aws\', new AwsProvider(serverless));\n19.     awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);\n20.   });\n21. \n22.   describe(\'#constructor()\', () => {\n23.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n24.       expect(awsCompileSNSEvents.provider).to.be.instanceof(AwsProvider));\n25.   });\n26. \n27.   describe(\'#compileSNSEvents()\', () => {\n28.     it(\'should throw an error if SNS event type is not a string or an object\', () => {\n29.       awsCompileSNSEvents.serverless.service.functions = {\n30.         first: {\n31.           events: [\n32.             {\n33.               sns: 42,\n34.             },\n35.           ],\n36.         },\n37.       };\n38. \n39.       expect(() => awsCompileSNSEvents.compileSNSEvents()).to.throw(Error);\n40.     });\n41. \n42.     it(\'should create corresponding resources when SNS events are given\', () => {\n43.       awsCompileSNSEvents.serverless.service.functions = {\n44.         first: {\n45.           events: [\n46.             {\n47.               sns: {\n48.                 topicName: \'Topic 1\',\n49.                 displayName: \'Display name for topic 1\',\n50.                 filterPolicy: {\n51.                   pet: [\'dog\', \'cat\'],\n52.                 },\n53.               },\n54.             },\n55.             {\n56.               sns: \'Topic 2\',\n57.             },\n58.           ],\n59.         },\n60.       };\n61. \n62.       awsCompileSNSEvents.compileSNSEvents();\n63. \n64.       expect(\n65.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n66.           .SNSTopicTopic1.Type\n67.       ).to.equal(\'AWS::SNS::Topic\');\n68.       expect(\n69.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n70.           .SNSTopicTopic2.Type\n71.       ).to.equal(\'AWS::SNS::Topic\');\n72.       expect(\n73.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n74.           .FirstLambdaPermissionTopic1SNS.Type\n75.       ).to.equal(\'AWS::Lambda::Permission\');\n76.       expect(\n77.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .FirstLambdaPermissionTopic2SNS.Type\n79.       ).to.equal(\'AWS::Lambda::Permission\');\n80.       expect(\n81.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n82.           .FirstSnsSubscriptionTopic1.Type\n83.       ).to.equal(\'AWS::SNS::Subscription\');\n84.       expect(\n85.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n86.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n87.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n88.     });\n89. \n90.     it(\'should create corresponding resources when topic is defined in resources\', () => {\n91.       awsCompileSNSEvents.serverless.service.functions = {\n92.         first: {\n93.           events: [\n94.             {\n95.               sns: {\n96.                 topicName: \'Topic 1\',\n97.                 displayName: \'Display name for topic 1\',\n98.                 filterPolicy: {\n99.                   pet: [\'dog\', \'cat\'],\n100.                 },\n101.               },\n102.             },\n103.             {\n104.               sns: \'Topic 2\',\n105.             },\n106.           ],\n107.         },\n108.       };\n109. \n110.       Object.assign(\n111.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n112.         {\n113.           SNSTopicTopic2: {\n114.             Type: \'AWS::SNS::Topic\',\n115.             Properties: {\n116.               TopicName: \'Topic 2\',\n117.               DisplayName: \'Display name for topic 2\',\n118.             },\n119.           },\n120.         }\n121.       );\n122. \n123.       awsCompileSNSEvents.compileSNSEvents();\n124. \n125.       expect(\n126.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n127.           .SNSTopicTopic1.Type\n128.       ).to.equal(\'AWS::SNS::Topic\');\n129.       expect(\n130.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n131.           .SNSTopicTopic2.Type\n132.       ).to.equal(\'AWS::SNS::Topic\');\n133.       expect(\n134.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n135.           .FirstLambdaPermissionTopic1SNS.Type\n136.       ).to.equal(\'AWS::Lambda::Permission\');\n137.       expect(\n138.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n139.           .FirstLambdaPermissionTopic2SNS.Type\n140.       ).to.equal(\'AWS::Lambda::Permission\');\n141.       expect(\n142.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n143.           .FirstSnsSubscriptionTopic1.Type\n144.       ).to.equal(\'AWS::SNS::Subscription\');\n145.       expect(\n146.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n147.           .FirstSnsSubscriptionTopic1.Properties.FilterPolicy\n148.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n149.     });\n150. \n151.     it(\'should create single SNS topic when the same topic is referenced repeatedly\', () => {\n152.       awsCompileSNSEvents.serverless.service.functions = {\n153.         first: {\n154.           events: [\n155.             {\n156.               sns: {\n157.                 topicName: \'Topic 1\',\n158.                 displayName: \'Display name for topic 1\',\n159.               },\n160.             },\n161.             {\n162.               sns: \'Topic 1\',\n163.             },\n164.           ],\n165.         },\n166.       };\n167. \n168.       awsCompileSNSEvents.compileSNSEvents();\n169. \n170.       expect(\n171.         Object.keys(\n172.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n173.         )\n174.       ).to.have.length(2);\n175.       expect(\n176.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n177.           .SNSTopicTopic1.Type\n178.       ).to.equal(\'AWS::SNS::Topic\');\n179.       expect(\n180.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n181.           .FirstLambdaPermissionTopic1SNS.Type\n182.       ).to.equal(\'AWS::Lambda::Permission\');\n183.     });\n184. \n185.     it(\'should throw an error when the event an object and the displayName is not given\', () => {\n186.       awsCompileSNSEvents.serverless.service.functions = {\n187.         first: {\n188.           events: [\n189.             {\n190.               sns: {\n191.                 displayName: \'Display name for topic 1\',\n192.               },\n193.             },\n194.           ],\n195.         },\n196.       };\n197. \n198.       expect(() => {\n199.         awsCompileSNSEvents.compileSNSEvents();\n200.       }).to.throw(Error);\n201.     });\n202. \n203.     it(\'should not create corresponding resources when SNS events are not given\', () => {\n204.       awsCompileSNSEvents.serverless.service.functions = {\n205.         first: {\n206.           events: [],\n207.         },\n208.       };\n209. \n210.       awsCompileSNSEvents.compileSNSEvents();\n211. \n212.       expect(\n213.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n214.       ).to.deep.equal({});\n215.     });\n216. \n217.     it(\'should create SNS topic when arn is given as a string\', () => {\n218.       awsCompileSNSEvents.serverless.service.functions = {\n219.         first: {\n220.           events: [\n221.             {\n222.               sns: \'arn:aws:foo\',\n223.             },\n224.           ],\n225.         },\n226.       };\n227. \n228.       awsCompileSNSEvents.compileSNSEvents();\n229. \n230.       expect(\n231.         Object.keys(\n232.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n233.         )\n234.       ).to.have.length(2);\n235.       expect(\n236.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n237.           .FirstSnsSubscriptionFoo.Type\n238.       ).to.equal(\'AWS::SNS::Subscription\');\n239.       expect(\n240.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n241.           .FirstLambdaPermissionFooSNS.Type\n242.       ).to.equal(\'AWS::Lambda::Permission\');\n243.       expect(\n244.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n245.           .FirstSnsSubscriptionFoo.Properties.FilterPolicy\n246.       ).to.equal(undefined);\n247.     });\n248. \n249.     it(\'should create SNS topic when only arn is given as an object property\', () => {\n250.       awsCompileSNSEvents.serverless.service.functions = {\n251.         first: {\n252.           events: [\n253.             {\n254.               sns: {\n255.                 arn: \'arn:aws:sns:region:accountid:foo\',\n256.               },\n257.             },\n258.           ],\n259.         },\n260.       };\n261. \n262.       awsCompileSNSEvents.compileSNSEvents();\n263. \n264.       expect(\n265.         Object.keys(\n266.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n267.         )\n268.       ).to.have.length(2);\n269.       expect(\n270.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n271.           .FirstSnsSubscriptionFoo.Type\n272.       ).to.equal(\'AWS::SNS::Subscription\');\n273.       expect(\n274.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n275.           .FirstLambdaPermissionFooSNS.Type\n276.       ).to.equal(\'AWS::Lambda::Permission\');\n277.     });\n278. \n279.     it(\'should create a cross region subscription when SNS topic arn in a different region than provider\', () => {\n280.       awsCompileSNSEvents.serverless.service.functions = {\n281.         first: {\n282.           events: [\n283.             {\n284.               sns: {\n285.                 arn: \'arn:aws:sns:some-other-region:accountid:foo\',\n286.               },\n287.             },\n288.           ],\n289.         },\n290.       };\n291. \n292.       awsCompileSNSEvents.compileSNSEvents();\n293.       expect(\n294.         Object.keys(\n295.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.         )\n297.       ).to.have.length(2);\n298.       expect(\n299.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n300.           .FirstSnsSubscriptionFoo.Type\n301.       ).to.equal(\'AWS::SNS::Subscription\');\n302.       expect(\n303.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n304.           .FirstSnsSubscriptionFoo.Properties.Region\n305.       ).to.equal(\'some-other-region\');\n306.       expect(\n307.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n308.           .FirstLambdaPermissionFooSNS.Type\n309.       ).to.equal(\'AWS::Lambda::Permission\');\n310.     });\n311. \n312.     it(\'should create a cross region subscription when SNS topic arn in a different region is using pseudo params\', () => {\n313.       awsCompileSNSEvents.serverless.service.functions = {\n314.         first: {\n315.           events: [\n316.             {\n317.               sns: {\n318.                 arn: \'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:foo\',\n319.               },\n320.             },\n321.           ],\n322.         },\n323.       };\n324. \n325.       awsCompileSNSEvents.compileSNSEvents();\n326.       expect(\n327.         Object.keys(\n328.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n329.         )\n330.       ).to.have.length(2);\n331.       expect(\n332.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n333.           .FirstSnsSubscriptionFoo.Type\n334.       ).to.equal(\'AWS::SNS::Subscription\');\n335.       expect(\n336.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n337.           .FirstSnsSubscriptionFoo.Properties.Region\n338.       ).to.equal(\'${AWS::Region}\');\n339.       expect(\n340.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n341.           .FirstLambdaPermissionFooSNS.Type\n342.       ).to.equal(\'AWS::Lambda::Permission\');\n343.     });\n344. \n345.     it(\'should throw an error when the arn an object and the value is not a string\', () => {\n346.       awsCompileSNSEvents.serverless.service.functions = {\n347.         first: {\n348.           events: [\n349.             {\n350.               sns: {\n351.                 arn: 123,\n352.               },\n353.             },\n354.           ],\n355.         },\n356.       };\n357. \n358.       expect(() => {\n359.         awsCompileSNSEvents.compileSNSEvents();\n360.       }).to.throw(Error);\n361.     });\n362. \n363.     it(\'should create SNS topic when both arn and topicName are given as object properties\', () => {\n364.       awsCompileSNSEvents.serverless.service.functions = {\n365.         first: {\n366.           events: [\n367.             {\n368.               sns: {\n369.                 topicName: \'bar\',\n370.                 arn: \'arn:aws:sns:region:accountid:bar\',\n371.               },\n372.             },\n373.           ],\n374.         },\n375.       };\n376. \n377.       awsCompileSNSEvents.compileSNSEvents();\n378. \n379.       expect(\n380.         Object.keys(\n381.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n382.         )\n383.       ).to.have.length(2);\n384.       expect(\n385.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n386.           .FirstSnsSubscriptionBar.Type\n387.       ).to.equal(\'AWS::SNS::Subscription\');\n388.       expect(\n389.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n390.           .FirstLambdaPermissionBarSNS.Type\n391.       ).to.equal(\'AWS::Lambda::Permission\');\n392.     });\n393. \n394.     it(\'should create two SNS topic subsriptions for ARNs with the same topic name in two regions when different topicName parameters are specified\', () => {\n395.       awsCompileSNSEvents.serverless.service.functions = {\n396.         first: {\n397.           events: [\n398.             {\n399.               sns: {\n400.                 topicName: \'first\',\n401.                 arn: \'arn:aws:sns:region-1:accountid:bar\',\n402.               },\n403.             },\n404.             {\n405.               sns: {\n406.                 topicName: \'second\',\n407.                 arn: \'arn:aws:sns:region-2:accountid:bar\',\n408.               },\n409.             },\n410.           ],\n411.         },\n412.       };\n413. \n414.       awsCompileSNSEvents.compileSNSEvents();\n415. \n416.       expect(\n417.         Object.keys(\n418.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n419.         )\n420.       ).to.have.length(4);\n421.       expect(\n422.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n423.           .FirstSnsSubscriptionFirst.Type\n424.       ).to.equal(\'AWS::SNS::Subscription\');\n425.       expect(\n426.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n427.           .FirstSnsSubscriptionSecond.Type\n428.       ).to.equal(\'AWS::SNS::Subscription\');\n429.     });\n430. \n431.     it(\'should override SNS topic subsription CF resource name when arn and topicName are given as object properties\', () => {\n432.       awsCompileSNSEvents.serverless.service.functions = {\n433.         first: {\n434.           events: [\n435.             {\n436.               sns: {\n437.                 topicName: \'foo\',\n438.                 arn: \'arn:aws:sns:region:accountid:bar\',\n439.               },\n440.             },\n441.           ],\n442.         },\n443.       };\n444. \n445.       awsCompileSNSEvents.compileSNSEvents();\n446. \n447.       expect(\n448.         Object.keys(\n449.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n450.         )\n451.       ).to.have.length(2);\n452.       expect(\n453.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n454.           .FirstSnsSubscriptionFoo.Type\n455.       ).to.equal(\'AWS::SNS::Subscription\');\n456.       expect(\n457.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n458.           .FirstLambdaPermissionFooSNS.Type\n459.       ).to.equal(\'AWS::Lambda::Permission\');\n460.     });\n461. \n462.     // eslint-disable-next-line max-len\n463.     it(\'should create SNS topic when arn object and topicName are given as object properties\', () => {\n464.       awsCompileSNSEvents.serverless.service.functions = {\n465.         first: {\n466.           events: [\n467.             {\n468.               sns: {\n469.                 topicName: \'bar\',\n470.                 arn: {\n471.                   \'Fn::Join\': [\':\', [\'arn:aws:sns\', \'${AWS::Region}\', \'${AWS::AccountId}\', \'bar\']],\n472.                 },\n473.               },\n474.             },\n475.           ],\n476.         },\n477.       };\n478. \n479.       awsCompileSNSEvents.compileSNSEvents();\n480. \n481.       expect(\n482.         Object.keys(\n483.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n484.         )\n485.       ).to.have.length(2);\n486.       expect(\n487.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n488.           .FirstSnsSubscriptionBar.Type\n489.       ).to.equal(\'AWS::SNS::Subscription\');\n490.       expect(\n491.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n492.           .FirstLambdaPermissionBarSNS.Type\n493.       ).to.equal(\'AWS::Lambda::Permission\');\n494.     });\n495. \n496.     // eslint-disable-next-line max-len\n497.     it(\'should throw an error when arn object and no topicName are given as object properties\', () => {\n498.       awsCompileSNSEvents.serverless.service.functions = {\n499.         first: {\n500.           events: [\n501.             {\n502.               sns: {\n503.                 arn: {\n504.                   \'Fn::Join\': [\':\', [\'arn:aws:sns\', \'${AWS::Region}\', \'${AWS::AccountId}\', \'bar\']],\n505.                 },\n506.               },\n507.             },\n508.           ],\n509.         },\n510.       };\n511. \n512.       expect(() => {\n513.         awsCompileSNSEvents.compileSNSEvents();\n514.       }).to.throw(Error);\n515.     });\n516. \n517.     // eslint-disable-next-line max-len\n518.     it(\'should throw an error when invalid imported arn object is given as object properties\', () => {\n519.       awsCompileSNSEvents.serverless.service.functions = {\n520.         first: {\n521.           events: [\n522.             {\n523.               sns: {\n524.                 topicName: \'bar\',\n525.                 arn: {\n526.                   \'Fn::ImportValue\': {\n527.                     Ref: \'BarTopic\',\n528.                   },\n529.                 },\n530.               },\n531.             },\n532.           ],\n533.         },\n534.       };\n535. \n536.       expect(() => {\n537.         awsCompileSNSEvents.compileSNSEvents();\n538.       }).to.throw(Error);\n539. \n540.       awsCompileSNSEvents.serverless.service.functions = {\n541.         first: {\n542.           events: [\n543.             {\n544.               sns: {\n545.                 topicName: \'bar\',\n546.                 arn: {\n547.                   \'Fn::ImportValue\': {\n548.                     \'Fn::GetAtt\': [\'BarTopic\', \'Arn\'],\n549.                   },\n550.                 },\n551.               },\n552.             },\n553.           ],\n554.         },\n555.       };\n556. \n557.       expect(() => {\n558.         awsCompileSNSEvents.compileSNSEvents();\n559.       }).to.throw(Error);\n560.     });\n561. \n562.     it(\'should create SNS topic when arn, topicName, and filterPolicy are given as object\', () => {\n563.       awsCompileSNSEvents.serverless.service.functions = {\n564.         first: {\n565.           events: [\n566.             {\n567.               sns: {\n568.                 topicName: \'bar\',\n569.                 arn: \'arn:aws:sns:region:accountid:bar\',\n570.                 filterPolicy: {\n571.                   pet: [\'dog\', \'cat\'],\n572.                 },\n573.               },\n574.             },\n575.           ],\n576.         },\n577.       };\n578. \n579.       awsCompileSNSEvents.compileSNSEvents();\n580. \n581.       expect(\n582.         Object.keys(\n583.           awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n584.         )\n585.       ).to.have.length(2);\n586.       expect(\n587.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n588.           .FirstSnsSubscriptionBar.Type\n589.       ).to.equal(\'AWS::SNS::Subscription\');\n590.       expect(\n591.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n592.           .FirstSnsSubscriptionBar.Properties.FilterPolicy\n593.       ).to.eql({ pet: [\'dog\', \'cat\'] });\n594.       expect(\n595.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n596.           .FirstLambdaPermissionBarSNS.Type\n597.       ).to.equal(\'AWS::Lambda::Permission\');\n598.     });\n599. \n600.     it(\'should link topic to corresponding dlq when redrivePolicy is defined\', () => {\n601.       awsCompileSNSEvents.serverless.service.functions = {\n602.         first: {\n603.           events: [\n604.             {\n605.               sns: {\n606.                 topicName: \'Topic 1\',\n607.                 displayName: \'Display name for topic 1\',\n608.                 redrivePolicy: {\n609.                   deadLetterTargetArn: {\n610.                     \'Fn::GetAtt\': [\'SNSDLQ\', \'Arn\'],\n611.                   },\n612.                 },\n613.               },\n614.             },\n615.           ],\n616.         },\n617.       };\n618. \n619.       Object.assign(\n620.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n621.         {\n622.           SNSDLQ: {\n623.             Type: \'AWS::SQS::Queue\',\n624.             Properties: {\n625.               QueueName: \'SNSDLQ\',\n626.             },\n627.           },\n628.         }\n629.       );\n630. \n631.       awsCompileSNSEvents.compileSNSEvents();\n632. \n633.       expect(\n634.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n635.           .SNSTopicTopic1.Type\n636.       ).to.equal(\'AWS::SNS::Topic\');\n637.       expect(\n638.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n639.           .FirstLambdaPermissionTopic1SNS.Type\n640.       ).to.equal(\'AWS::Lambda::Permission\');\n641.       expect(\n642.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n643.           .FirstSnsSubscriptionTopic1.Type\n644.       ).to.equal(\'AWS::SNS::Subscription\');\n645.       expect(\n646.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n647.           .FirstSnsSubscriptionTopic1.Properties.RedrivePolicy\n648.       ).to.eql({ deadLetterTargetArn: { \'Fn::GetAtt\': [\'SNSDLQ\', \'Arn\'] } });\n649.       expect(\n650.         awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n651.           .FirstEventSourceMappingSQSTopic1DLQ.Type\n652.       ).to.equal(\'AWS::SQS::QueuePolicy\');\n653.     });\n654.   });\n655. });\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\n1) Issue Understanding\n\n- Reported symptom: Deployments fail when using SNS redrivePolicy because the generated SQS QueuePolicy references the DLQ incorrectly. Specifically:\n  - The QueuePolicy PolicyDocument.Statement[].Resource must be the SQS queue ARN.\n  - The QueuePolicy Queues property must be the SQS queue URL (Ref of the queue resource).\n- Current behavior uses the same value (whatever is provided as deadLetterTargetArn) for both Resource and Queues, which is incorrect. The docs also incorrectly show using Ref for deadLetterTargetArn, which is a URL, not an ARN, causing mismatches.\n- Consequences: CloudFormation errors during deployment due to type mismatches and/or SNS not being granted permission to send to the DLQ.\n\n2) Code Analysis\n\n- Affected implementation:\n  - File: lib/plugins/aws/package/compile/events/sns/index.js\n    - Function: compileSNSEvents()\n    - Block lines ~227–259: Creation of the AWS::SQS::QueuePolicy when event.sns.redrivePolicy.deadLetterTargetArn is provided.\n      - It currently sets:\n        - PolicyDocument.Statement[0].Resource = event.sns.redrivePolicy.deadLetterTargetArn\n        - Queues = [event.sns.redrivePolicy.deadLetterTargetArn]\n      - This assumes the same value can serve both as ARN and URL, which is wrong.\n    - Earlier in the same function, RedrivePolicy is passed through unchanged to AWS::SNS::Subscription.\n\n- Affected docs:\n  - File: docs/providers/aws/events/sns.md\n    - Section “Setting a redrive policy” (lines 150–170): The example shows deadLetterTargetArn: !Ref myDLQ, which returns a queue URL, not an ARN, and is therefore incorrect for the property named deadLetterTargetArn.\n\n- Tests:\n  - File: lib/plugins/aws/package/compile/events/sns/index.test.js\n    - Test “should link topic to corresponding dlq when redrivePolicy is defined” (lines ~600–653) asserts creation of QueuePolicy but does not verify that:\n      - PolicyDocument.Statement[].Resource is an ARN (GetAtt ... Arn)\n      - Queues uses a Ref (URL)\n    - Missing tests for cases where deadLetterTargetArn is provided as Ref (URL) vs as GetAtt (ARN) and for the case of external queues where QueuePolicy cannot be created from ARN alone.\n\n3) Root Cause\n\n- The compiler uses the same deadLetterTargetArn value for both ARN and URL contexts in the generated AWS::SQS::QueuePolicy:\n  - Resource expects an ARN.\n  - Queues expects a URL (Ref of the queue resource).\n- Documentation instructs users to provide deadLetterTargetArn using Ref, which returns a URL; that is incompatible with the “Arn” requirement and also makes it impossible to generate the URL and ARN pair correctly.\n- There is no normalization step to interpret a provided Ref (to a local SQS queue) and convert it to the proper Arn (GetAtt) for the subscription RedrivePolicy and to proper Ref for the QueuePolicy’s Queues.\n\n4) Fix Suggestion\n\nA) Implementation changes in lib/plugins/aws/package/compile/events/sns/index.js\n\n- Function: compileSNSEvents()\n- Add a normalization step for redrivePolicy before resources are created:\n  - If event.sns.redrivePolicy and event.sns.redrivePolicy.deadLetterTargetArn are present:\n    - If deadLetterTargetArn is a Ref to a local SQS queue resource (i.e., an object with Ref pointing to a logical ID defined in template.Resources of type AWS::SQS::Queue):\n      - Replace event.sns.redrivePolicy.deadLetterTargetArn with a GetAtt on that logical ID’s Arn (i.e., create an Arn expression), so the subscription RedrivePolicy gets a proper ARN.\n      - Keep track of the queue logical ID for use in QueuePolicy (see next bullet).\n    - If deadLetterTargetArn is a GetAtt on [localQueueLogicalId, \'Arn\']:\n      - Keep it as-is for the subscription RedrivePolicy.\n      - Keep track of localQueueLogicalId.\n    - Otherwise (deadLetterTargetArn provided as a raw ARN string, import, or other non-local expression):\n      - Do not attempt to create an AWS::SQS::QueuePolicy since the queue URL (Ref) cannot be derived. The queue policy must be managed in the external stack owning the queue. Optionally, emit a warning in logs.\n\n- Adjust the QueuePolicy creation block (lines ~227–259):\n  - Only create AWS::SQS::QueuePolicy if a localQueueLogicalId has been determined via the normalization step above.\n  - Set PolicyDocument.Statement[0].Resource to the queue ARN using GetAtt on localQueueLogicalId (do not use the raw event value).\n  - Set Queues to an array containing a Ref to localQueueLogicalId (Ref returns the URL).\n  - Keep the SourceArn condition using topicArn as currently done.\n\n- Rationale:\n  - Ensures the RedrivePolicy on the subscription receives an ARN, as required.\n  - Ensures QueuePolicy uses the correct ARN for Resource and URL (Ref) for Queues.\n  - Avoids generating invalid QueuePolicy when the queue is external and only an ARN is known.\n\nB) Documentation changes in docs/providers/aws/events/sns.md\n\n- Section: “Setting a redrive policy” (lines 150–170).\n- Change the example to use an ARN for deadLetterTargetArn via GetAtt, not Ref:\n  - deadLetterTargetArn: !GetAtt myDLQ.Arn (or the long-form Fn::GetAtt)\n- Add a note:\n  - If the DLQ is defined in the same serverless.yml (same stack), the framework will also attach a policy to the queue to allow SNS to send messages to it.\n  - If you reference a DLQ ARN from an external stack/account, the framework will not be able to create a QueuePolicy (as it cannot compute the queue URL). Ensure that the external queue has an appropriate policy allowing sns:SendMessage from your SNS topic.\n- Remove/adjust any language suggesting that Ref can be used for deadLetterTargetArn (Ref returns a URL, not an ARN, and is not suitable for the Arn field).\n\nC) Test updates in lib/plugins/aws/package/compile/events/sns/index.test.js\n\n- In the test “should link topic to corresponding dlq when redrivePolicy is defined”:\n  - Add assertions that:\n    - The generated QueuePolicy Properties.Queues equals an array with a Ref to the queue logical ID (e.g., [{ Ref: \'SNSDLQ\' }]).\n    - The PolicyDocument.Statement[0].Resource equals a GetAtt on the same queue logical ID’s Arn.\n- Add a test covering the case when deadLetterTargetArn is mistakenly provided as a Ref to a local queue:\n  - Expect the compiler to normalize it to a GetAtt for the subscription’s RedrivePolicy and to create a QueuePolicy with Queues as Ref and Resource as GetAtt.\n- Add a test for deadLetterTargetArn provided as a raw ARN (external queue):\n  - Expect that no QueuePolicy is created in the stack, and possibly verify a logged warning if applicable.\n\nWhy these changes fix the issue\n\n- They ensure CloudFormation types are correct:\n  - RedrivePolicy.deadLetterTargetArn receives an ARN.\n  - QueuePolicy.Resource uses ARN.\n  - QueuePolicy.Queues uses URL (Ref).\n- They prevent invalid QueuePolicy creation when the DLQ is not part of the same stack and its URL cannot be obtained.\n- They correct the documentation so users provide the appropriate intrinsic function, avoiding future misconfigurations.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 20:42:25,984 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_RdohAqtMpadorNPvPyz9Nmhz', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3747, 'prompt_tokens': 13291, 'total_tokens': 17038, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3712, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--13148c11-f2f4-4016-96d7-165223f953c7-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js'}, 'id': 'call_RdohAqtMpadorNPvPyz9Nmhz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13291, 'output_tokens': 3747, 'total_tokens': 17038, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 3712}}
2025-11-13 20:42:44,528 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xXyM178nHuwTmLTrvtxULbBh', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js","start_line":120,"end_line":210}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2032, 'prompt_tokens': 15690, 'total_tokens': 17722, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1984, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 13184}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--871be798-08a7-4d4f-ac36-f7515191189c-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'start_line': 120, 'end_line': 210}, 'id': 'call_xXyM178nHuwTmLTrvtxULbBh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15690, 'output_tokens': 2032, 'total_tokens': 17722, 'input_token_details': {'audio': 0, 'cache_read': 13184}, 'output_token_details': {'audio': 0, 'reasoning': 1984}}
2025-11-13 20:43:02,215 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Sl1QHVEOML5gXVkQNg9q0Mee', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js","start_line":131,"end_line":260}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1904, 'prompt_tokens': 16438, 'total_tokens': 18342, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1856, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--adfa5f31-abcc-4ddd-950d-d88d1ee272e3-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'start_line': 131, 'end_line': 260}, 'id': 'call_Sl1QHVEOML5gXVkQNg9q0Mee', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16438, 'output_tokens': 1904, 'total_tokens': 18342, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 1856}}
2025-11-13 20:43:22,921 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ieWPEezduskkNM3SJwe9Airq', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js","start_line":41,"end_line":265}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2416, 'prompt_tokens': 17500, 'total_tokens': 19916, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2368, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8650787f-d59a-48ea-8681-cb71c9b1288d-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'start_line': 41, 'end_line': 265}, 'id': 'call_ieWPEezduskkNM3SJwe9Airq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17500, 'output_tokens': 2416, 'total_tokens': 19916, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 2368}}
2025-11-13 20:43:33,087 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_q222hcaZVZdiUgna3cF8Y9Nd', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/sns.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 927, 'prompt_tokens': 19517, 'total_tokens': 20444, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6609eda0-9444-49f5-a5e6-5e2f5de703cd-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/events/sns.md'}, 'id': 'call_q222hcaZVZdiUgna3cF8Y9Nd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19517, 'output_tokens': 927, 'total_tokens': 20444, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 20:44:00,763 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_g5MrZ7GU9hqiw4RSMg7DbF2s', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js","old_content":"            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\\n\\n            const endpoint = {\\n              \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\\n            };\\n\\n            const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\\n              functionName,\\n              topicName\\n            );","new_content":"            let normalizedRedrivePolicy = event.sns.redrivePolicy;\\n            let dlqLogicalId;\\n            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\\n              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;\\n              if (typeof dlqTarget === \'object\') {\\n                if (_.has(dlqTarget, \'Ref\')) {\\n                  dlqLogicalId = dlqTarget.Ref;\\n                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {\\n                    deadLetterTargetArn: { \'Fn::GetAtt\': [dlqLogicalId, \'Arn\'] },\\n                  });\\n                } else if (_.has(dlqTarget, \'Fn::GetAtt\')) {\\n                  const getAtt = dlqTarget[\'Fn::GetAtt\'];\\n                  if (Array.isArray(getAtt) && getAtt[1] === \'Arn\') {\\n                    dlqLogicalId = getAtt[0];\\n                  }\\n                }\\n              }\\n            }\\n\\n            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\\n\\n            const endpoint = {\\n              \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'],\\n            };\\n\\n            const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\\n              functionName,\\n              topicName\\n            );"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3623, 'prompt_tokens': 21020, 'total_tokens': 24643, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3200, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19456}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--848cd8f2-e9ab-47f0-90ff-856a6061f8f0-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'old_content': "            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n\n            const endpoint = {\n              'Fn::GetAtt': [lambdaLogicalId, 'Arn'],\n            };\n\n            const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\n              functionName,\n              topicName\n            );", 'new_content': "            let normalizedRedrivePolicy = event.sns.redrivePolicy;\n            let dlqLogicalId;\n            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;\n              if (typeof dlqTarget === 'object') {\n                if (_.has(dlqTarget, 'Ref')) {\n                  dlqLogicalId = dlqTarget.Ref;\n                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {\n                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },\n                  });\n                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {\n                  const getAtt = dlqTarget['Fn::GetAtt'];\n                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {\n                    dlqLogicalId = getAtt[0];\n                  }\n                }\n              }\n            }\n\n            const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n\n            const endpoint = {\n              'Fn::GetAtt': [lambdaLogicalId, 'Arn'],\n            };\n\n            const subscriptionLogicalId = this.provider.naming.getLambdaSnsSubscriptionLogicalId(\n              functionName,\n              topicName\n            );"}, 'id': 'call_g5MrZ7GU9hqiw4RSMg7DbF2s', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21020, 'output_tokens': 3623, 'total_tokens': 24643, 'input_token_details': {'audio': 0, 'cache_read': 19456}, 'output_token_details': {'audio': 0, 'reasoning': 3200}}
2025-11-13 20:44:03,267 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Z53yfjpJ4wVddWVuaAX9dqBW', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js","old_content":"            if (topicArn) {\\n              _.merge(template.Resources, {\\n                [subscriptionLogicalId]: {\\n                  Type: \'AWS::SNS::Subscription\',\\n                  Properties: {\\n                    TopicArn: topicArn,\\n                    Protocol: \'lambda\',\\n                    Endpoint: endpoint,\\n                    FilterPolicy: event.sns.filterPolicy,\\n                    RedrivePolicy: event.sns.redrivePolicy,\\n                    Region: region,\\n                  },\\n                },\\n              });\\n            } else {","new_content":"            if (topicArn) {\\n              _.merge(template.Resources, {\\n                [subscriptionLogicalId]: {\\n                  Type: \'AWS::SNS::Subscription\',\\n                  Properties: {\\n                    TopicArn: topicArn,\\n                    Protocol: \'lambda\',\\n                    Endpoint: endpoint,\\n                    FilterPolicy: event.sns.filterPolicy,\\n                    RedrivePolicy: normalizedRedrivePolicy,\\n                    Region: region,\\n                  },\\n                },\\n              });\\n            } else {"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 253, 'prompt_tokens': 21461, 'total_tokens': 21714, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 16384}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9ed8cfd5-737d-4438-8345-902fb7bf6f84-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'old_content': "            if (topicArn) {\n              _.merge(template.Resources, {\n                [subscriptionLogicalId]: {\n                  Type: 'AWS::SNS::Subscription',\n                  Properties: {\n                    TopicArn: topicArn,\n                    Protocol: 'lambda',\n                    Endpoint: endpoint,\n                    FilterPolicy: event.sns.filterPolicy,\n                    RedrivePolicy: event.sns.redrivePolicy,\n                    Region: region,\n                  },\n                },\n              });\n            } else {", 'new_content': "            if (topicArn) {\n              _.merge(template.Resources, {\n                [subscriptionLogicalId]: {\n                  Type: 'AWS::SNS::Subscription',\n                  Properties: {\n                    TopicArn: topicArn,\n                    Protocol: 'lambda',\n                    Endpoint: endpoint,\n                    FilterPolicy: event.sns.filterPolicy,\n                    RedrivePolicy: normalizedRedrivePolicy,\n                    Region: region,\n                  },\n                },\n              });\n            } else {"}, 'id': 'call_Z53yfjpJ4wVddWVuaAX9dqBW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21461, 'output_tokens': 253, 'total_tokens': 21714, 'input_token_details': {'audio': 0, 'cache_read': 16384}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:06,087 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_fxURGTS0KCUBbuLSlI4Mo9O5', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js","old_content":"                _.merge(template.Resources, {\\n                  [subscriptionLogicalId]: {\\n                    Type: \'AWS::SNS::Subscription\',\\n                    Properties: _.merge(subscription, {\\n                      TopicArn: {\\n                        Ref: topicLogicalId,\\n                      },\\n                      FilterPolicy: event.sns.filterPolicy,\\n                      RedrivePolicy: event.sns.redrivePolicy,\\n                    }),\\n                  },\\n                });","new_content":"                _.merge(template.Resources, {\\n                  [subscriptionLogicalId]: {\\n                    Type: \'AWS::SNS::Subscription\',\\n                    Properties: _.merge(subscription, {\\n                      TopicArn: {\\n                        Ref: topicLogicalId,\\n                      },\\n                      FilterPolicy: event.sns.filterPolicy,\\n                      RedrivePolicy: normalizedRedrivePolicy,\\n                    }),\\n                  },\\n                });"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 213, 'prompt_tokens': 21738, 'total_tokens': 21951, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ede904a4-b909-4227-85ca-7fc589766f63-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'old_content': "                _.merge(template.Resources, {\n                  [subscriptionLogicalId]: {\n                    Type: 'AWS::SNS::Subscription',\n                    Properties: _.merge(subscription, {\n                      TopicArn: {\n                        Ref: topicLogicalId,\n                      },\n                      FilterPolicy: event.sns.filterPolicy,\n                      RedrivePolicy: event.sns.redrivePolicy,\n                    }),\n                  },\n                });", 'new_content': "                _.merge(template.Resources, {\n                  [subscriptionLogicalId]: {\n                    Type: 'AWS::SNS::Subscription',\n                    Properties: _.merge(subscription, {\n                      TopicArn: {\n                        Ref: topicLogicalId,\n                      },\n                      FilterPolicy: event.sns.filterPolicy,\n                      RedrivePolicy: normalizedRedrivePolicy,\n                    }),\n                  },\n                });"}, 'id': 'call_fxURGTS0KCUBbuLSlI4Mo9O5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21738, 'output_tokens': 213, 'total_tokens': 21951, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:10,047 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JIiICab5dEtiUzKGpBcX90iN', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js","old_content":"            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\\n              const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\\n                functionName,\\n                `${topicName}DLQ`\\n              );\\n              Object.assign(template.Resources, {\\n                [queuePolicyLogicalId]: {\\n                  Type: \'AWS::SQS::QueuePolicy\',\\n                  Properties: {\\n                    PolicyDocument: {\\n                      Version: \'2012-10-17\',\\n                      Id: queuePolicyLogicalId,\\n                      Statement: [\\n                        {\\n                          Effect: \'Allow\',\\n                          Principal: {\\n                            Service: \'sns.amazonaws.com\',\\n                          },\\n                          Action: \'sqs:SendMessage\',\\n                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,\\n                          Condition: {\\n                            ArnEquals: {\\n                              \'aws:SourceArn\': topicArn,\\n                            },\\n                          },\\n                        },\\n                      ],\\n                    },\\n                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\\n                  },\\n                },\\n              });\\n            }","new_content":"            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {\\n              const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\\n                functionName,\\n                `${topicName}DLQ`\\n              );\\n              Object.assign(template.Resources, {\\n                [queuePolicyLogicalId]: {\\n                  Type: \'AWS::SQS::QueuePolicy\',\\n                  Properties: {\\n                    PolicyDocument: {\\n                      Version: \'2012-10-17\',\\n                      Id: queuePolicyLogicalId,\\n                      Statement: [\\n                        {\\n                          Effect: \'Allow\',\\n                          Principal: {\\n                            Service: \'sns.amazonaws.com\',\\n                          },\\n                          Action: \'sqs:SendMessage\',\\n                          Resource: { \'Fn::GetAtt\': [dlqLogicalId, \'Arn\'] },\\n                          Condition: {\\n                            ArnEquals: {\\n                              \'aws:SourceArn\': topicArn,\\n                            },\\n                          },\\n                        },\\n                      ],\\n                    },\\n                    Queues: [{ Ref: dlqLogicalId }],\\n                  },\\n                },\\n              });\\n            }"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 558, 'prompt_tokens': 21975, 'total_tokens': 22533, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5d52f780-f6e1-4962-a50e-9ab84ce207a7-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js', 'old_content': "            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n              const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n                functionName,\n                `${topicName}DLQ`\n              );\n              Object.assign(template.Resources, {\n                [queuePolicyLogicalId]: {\n                  Type: 'AWS::SQS::QueuePolicy',\n                  Properties: {\n                    PolicyDocument: {\n                      Version: '2012-10-17',\n                      Id: queuePolicyLogicalId,\n                      Statement: [\n                        {\n                          Effect: 'Allow',\n                          Principal: {\n                            Service: 'sns.amazonaws.com',\n                          },\n                          Action: 'sqs:SendMessage',\n                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,\n                          Condition: {\n                            ArnEquals: {\n                              'aws:SourceArn': topicArn,\n                            },\n                          },\n                        },\n                      ],\n                    },\n                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\n                  },\n                },\n              });\n            }", 'new_content': "            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {\n              const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n                functionName,\n                `${topicName}DLQ`\n              );\n              Object.assign(template.Resources, {\n                [queuePolicyLogicalId]: {\n                  Type: 'AWS::SQS::QueuePolicy',\n                  Properties: {\n                    PolicyDocument: {\n                      Version: '2012-10-17',\n                      Id: queuePolicyLogicalId,\n                      Statement: [\n                        {\n                          Effect: 'Allow',\n                          Principal: {\n                            Service: 'sns.amazonaws.com',\n                          },\n                          Action: 'sqs:SendMessage',\n                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },\n                          Condition: {\n                            ArnEquals: {\n                              'aws:SourceArn': topicArn,\n                            },\n                          },\n                        },\n                      ],\n                    },\n                    Queues: [{ Ref: dlqLogicalId }],\n                  },\n                },\n              });\n            }"}, 'id': 'call_JIiICab5dEtiUzKGpBcX90iN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21975, 'output_tokens': 558, 'total_tokens': 22533, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:11,992 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_LGCwPNGOAm1rFH4BVjqbEQtL', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/sns/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 29, 'prompt_tokens': 22557, 'total_tokens': 22586, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 20992}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--63187ff7-9c9e-4aa0-9076-4ead8194133b-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/sns/index.js'}, 'id': 'call_LGCwPNGOAm1rFH4BVjqbEQtL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 22557, 'output_tokens': 29, 'total_tokens': 22586, 'input_token_details': {'audio': 0, 'cache_read': 20992}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:15,950 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_MwK8gHIsttUERoMAZ8rlfSXf', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/sns.md","old_content":"## Setting a redrive policy\\n\\nThis event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren\'t delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\\n\\n```yml\\nfunctions:\\n  dispatcher:\\n    handler: dispatcher.handler\\n    events:\\n      - sns:\\n          topicName: dispatcher\\n          redrivePolicy:\\n            deadLetterTargetArn: !Ref myDLQ\\n\\nresources:\\n  Resources:\\n    myDLQ:\\n      Type: AWS::SQS::Queue\\n      Properties:\\n        QueueName: myDLQ\\n```","new_content":"## Setting a redrive policy\\n\\nThis event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren\'t delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\\n\\n```yml\\nfunctions:\\n  dispatcher:\\n    handler: dispatcher.handler\\n    events:\\n      - sns:\\n          topicName: dispatcher\\n          redrivePolicy:\\n            deadLetterTargetArn: !GetAtt myDLQ.Arn\\n\\nresources:\\n  Resources:\\n    myDLQ:\\n      Type: AWS::SQS::Queue\\n      Properties:\\n        QueueName: myDLQ\\n```\\n\\nNote: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic."}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 425, 'prompt_tokens': 25201, 'total_tokens': 25626, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 22528}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7a5bb056-d49e-4a8a-afb7-59b023c6fc08-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/sns.md', 'old_content': "## Setting a redrive policy\n\nThis event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\n\n```yml\nfunctions:\n  dispatcher:\n    handler: dispatcher.handler\n    events:\n      - sns:\n          topicName: dispatcher\n          redrivePolicy:\n            deadLetterTargetArn: !Ref myDLQ\n\nresources:\n  Resources:\n    myDLQ:\n      Type: AWS::SQS::Queue\n      Properties:\n        QueueName: myDLQ\n```", 'new_content': "## Setting a redrive policy\n\nThis event definition creates an SNS topic that sends messages to a Dead Letter Queue (defined by its ARN) when the associated lambda is not available. In this example, messages that aren't delivered to the `dispatcher` Lambda (because the lambda service is down or irresponsive) will end in `myDLQ`\n\n```yml\nfunctions:\n  dispatcher:\n    handler: dispatcher.handler\n    events:\n      - sns:\n          topicName: dispatcher\n          redrivePolicy:\n            deadLetterTargetArn: !GetAtt myDLQ.Arn\n\nresources:\n  Resources:\n    myDLQ:\n      Type: AWS::SQS::Queue\n      Properties:\n        QueueName: myDLQ\n```\n\nNote: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic."}, 'id': 'call_MwK8gHIsttUERoMAZ8rlfSXf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25201, 'output_tokens': 425, 'total_tokens': 25626, 'input_token_details': {'audio': 0, 'cache_read': 22528}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:17,702 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_FSyiZrPbS45j7KIMQ1jQARRc', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/sns.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 25646, 'total_tokens': 25671, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8e3e0648-c726-4c64-a48e-5d298617e113-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/events/sns.md'}, 'id': 'call_FSyiZrPbS45j7KIMQ1jQARRc', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25646, 'output_tokens': 25, 'total_tokens': 25671, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:31,342 - thread-135845298308800.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I implemented the fix to correctly handle SNS redrivePolicy DLQ references and updated the documentation.\n\nCode changes in lib/plugins/aws/package/compile/events/sns/index.js:\n- Normalize redrivePolicy:\n  - If deadLetterTargetArn is provided as Ref to a local SQS queue, convert it to GetAtt [QueueLogicalId, Arn] for the subscription’s RedrivePolicy and track the queue’s logical ID.\n  - If deadLetterTargetArn is provided as GetAtt [QueueLogicalId, Arn], use it as-is and track the queue’s logical ID.\n  - If it’s a raw ARN or import (external queue), leave it as-is and do not create a QueuePolicy since the queue URL cannot be derived.\n- Use normalizedRedrivePolicy in SNS Subscription (both when topicArn is given and when it’s created locally).\n- Create AWS::SQS::QueuePolicy only when the DLQ is part of the same stack (dlqLogicalId is known):\n  - Set PolicyDocument.Statement[].Resource to GetAtt [dlqLogicalId, Arn] (queue ARN).\n  - Set Queues to [Ref dlqLogicalId] (queue URL).\n\nDocumentation update in docs/providers/aws/events/sns.md:\n- Updated the “Setting a redrive policy” example to use deadLetterTargetArn: !GetAtt myDLQ.Arn instead of !Ref.\n- Added a note indicating that when the DLQ is defined in the same stack, a policy will be attached to the queue, and if referencing an external DLQ ARN, an appropriate policy must be managed externally.\n\nThese changes ensure the QueuePolicy uses the correct ARN for Resource and URL for Queues, preventing deployment errors.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1189, 'prompt_tokens': 27225, 'total_tokens': 28414, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--d47cd31c-c98d-45b9-9c81-3f1643013a11-0' usage_metadata={'input_tokens': 27225, 'output_tokens': 1189, 'total_tokens': 28414, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 20:44:31,386 - thread-135845298308800.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/sns.md b/docs/providers/aws/events/sns.md
index 556153b77..ab9a2f180 100644
--- a/docs/providers/aws/events/sns.md
+++ b/docs/providers/aws/events/sns.md
@@ -159,7 +159,7 @@ functions:
       - sns:
           topicName: dispatcher
           redrivePolicy:
-            deadLetterTargetArn: !Ref myDLQ
+            deadLetterTargetArn: !GetAtt myDLQ.Arn
 
 resources:
   Resources:
@@ -168,3 +168,5 @@ resources:
       Properties:
         QueueName: myDLQ
 ```
+
+Note: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic.
diff --git a/lib/plugins/aws/package/compile/events/sns/index.js b/lib/plugins/aws/package/compile/events/sns/index.js
index 3b62dc379..109ab42f1 100644
--- a/lib/plugins/aws/package/compile/events/sns/index.js
+++ b/lib/plugins/aws/package/compile/events/sns/index.js
@@ -122,6 +122,25 @@ class AwsCompileSNSEvents {
               throw new this.serverless.classes.Error(errorMessage);
             }
 
+            let normalizedRedrivePolicy = event.sns.redrivePolicy;
+            let dlqLogicalId;
+            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;
+              if (typeof dlqTarget === 'object') {
+                if (_.has(dlqTarget, 'Ref')) {
+                  dlqLogicalId = dlqTarget.Ref;
+                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {
+                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
+                  });
+                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {
+                  const getAtt = dlqTarget['Fn::GetAtt'];
+                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {
+                    dlqLogicalId = getAtt[0];
+                  }
+                }
+              }
+            }
+
             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
 
             const endpoint = {
@@ -142,7 +161,7 @@ class AwsCompileSNSEvents {
                     Protocol: 'lambda',
                     Endpoint: endpoint,
                     FilterPolicy: event.sns.filterPolicy,
-                    RedrivePolicy: event.sns.redrivePolicy,
+                    RedrivePolicy: normalizedRedrivePolicy,
                     Region: region,
                   },
                 },
@@ -195,7 +214,7 @@ class AwsCompileSNSEvents {
                         Ref: topicLogicalId,
                       },
                       FilterPolicy: event.sns.filterPolicy,
-                      RedrivePolicy: event.sns.redrivePolicy,
+                      RedrivePolicy: normalizedRedrivePolicy,
                     }),
                   },
                 });
@@ -224,7 +243,7 @@ class AwsCompileSNSEvents {
               },
             });
 
-            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {
               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
                 functionName,
                 `${topicName}DLQ`
@@ -243,7 +262,7 @@ class AwsCompileSNSEvents {
                             Service: 'sns.amazonaws.com',
                           },
                           Action: 'sqs:SendMessage',
-                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,
+                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
                           Condition: {
                             ArnEquals: {
                               'aws:SourceArn': topicArn,
@@ -252,7 +271,7 @@ class AwsCompileSNSEvents {
                         },
                       ],
                     },
-                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
+                    Queues: [{ Ref: dlqLogicalId }],
                   },
                 },
               });

2025-11-13 20:44:31,388 - thread-135845298308800.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 20:44:31,416 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - INFO - Enter bug_fix_verification_subgraph_node
2025-11-13 20:44:31,416 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_file: lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
2025-11-13 20:44:31,416 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_commands: ['npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js']
2025-11-13 20:44:31,416 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_patch: diff --git a/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
new file mode 100644
index 000000000..b181704ad
--- /dev/null
+++ b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
@@ -0,0 +1,54 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileSNSEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileSNSEvents - redrivePolicy QueuePolicy', () => {
+  let serverless;
+  let awsCompileSNSEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    const options = { region: 'some-region' };
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
+  });
+
+  it('should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined', () => {
+    awsCompileSNSEvents.serverless.service.functions = {
+      first: {
+        events: [
+          {
+            sns: {
+              topicName: 'Topic 1',
+              displayName: 'Display name for topic 1',
+              redrivePolicy: {
+                deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] },
+              },
+            },
+          },
+        ],
+      },
+    };
+
+    Object.assign(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
+      {
+        SNSDLQ: {
+          Type: 'AWS::SQS::Queue',
+          Properties: { QueueName: 'SNSDLQ' },
+        },
+      }
+    );
+
+    awsCompileSNSEvents.compileSNSEvents();
+
+    expect(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
+        .FirstEventSourceMappingSQSTopic1DLQ.Properties.Queues
+    ).to.deep.equal([{ Ref: 'SNSDLQ' }]);
+  });
+})

2025-11-13 20:44:31,416 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - edit_patch: diff --git a/docs/providers/aws/events/sns.md b/docs/providers/aws/events/sns.md
index 556153b77..ab9a2f180 100644
--- a/docs/providers/aws/events/sns.md
+++ b/docs/providers/aws/events/sns.md
@@ -159,7 +159,7 @@ functions:
       - sns:
           topicName: dispatcher
           redrivePolicy:
-            deadLetterTargetArn: !Ref myDLQ
+            deadLetterTargetArn: !GetAtt myDLQ.Arn
 
 resources:
   Resources:
@@ -168,3 +168,5 @@ resources:
       Properties:
         QueueName: myDLQ
 ```
+
+Note: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic.
diff --git a/lib/plugins/aws/package/compile/events/sns/index.js b/lib/plugins/aws/package/compile/events/sns/index.js
index 3b62dc379..109ab42f1 100644
--- a/lib/plugins/aws/package/compile/events/sns/index.js
+++ b/lib/plugins/aws/package/compile/events/sns/index.js
@@ -122,6 +122,25 @@ class AwsCompileSNSEvents {
               throw new this.serverless.classes.Error(errorMessage);
             }
 
+            let normalizedRedrivePolicy = event.sns.redrivePolicy;
+            let dlqLogicalId;
+            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;
+              if (typeof dlqTarget === 'object') {
+                if (_.has(dlqTarget, 'Ref')) {
+                  dlqLogicalId = dlqTarget.Ref;
+                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {
+                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
+                  });
+                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {
+                  const getAtt = dlqTarget['Fn::GetAtt'];
+                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {
+                    dlqLogicalId = getAtt[0];
+                  }
+                }
+              }
+            }
+
             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
 
             const endpoint = {
@@ -142,7 +161,7 @@ class AwsCompileSNSEvents {
                     Protocol: 'lambda',
                     Endpoint: endpoint,
                     FilterPolicy: event.sns.filterPolicy,
-                    RedrivePolicy: event.sns.redrivePolicy,
+                    RedrivePolicy: normalizedRedrivePolicy,
                     Region: region,
                   },
                 },
@@ -195,7 +214,7 @@ class AwsCompileSNSEvents {
                         Ref: topicLogicalId,
                       },
                       FilterPolicy: event.sns.filterPolicy,
-                      RedrivePolicy: event.sns.redrivePolicy,
+                      RedrivePolicy: normalizedRedrivePolicy,
                     }),
                   },
                 });
@@ -224,7 +243,7 @@ class AwsCompileSNSEvents {
               },
             });
 
-            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {
               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
                 functionName,
                 `${topicName}DLQ`
@@ -243,7 +262,7 @@ class AwsCompileSNSEvents {
                             Service: 'sns.amazonaws.com',
                           },
                           Action: 'sqs:SendMessage',
-                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,
+                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
                           Condition: {
                             ArnEquals: {
                               'aws:SourceArn': topicArn,
@@ -252,7 +271,7 @@ class AwsCompileSNSEvents {
                         },
                       ],
                     },
-                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
+                    Queues: [{ Ref: dlqLogicalId }],
                   },
                 },
               });

2025-11-13 20:44:31,419 - thread-135845298308800.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Applying patch: diff --git a/docs/providers/aws/events/sns.md b/docs/providers/aws/events/sns.md
index 556153b77..ab9a2f180 100644
--- a/docs/providers/aws/events/sns.md
+++ b/docs/providers/aws/events/sns.md
@@ -159,7 +159,7 @@ functions:
       - sns:
           topicName: dispatcher
           redrivePolicy:
-            deadLetterTargetArn: !Ref myDLQ
+            deadLetterTargetArn: !GetAtt myDLQ.Arn
 
 resources:
   Resources:
@@ -168,3 +168,5 @@ resources:
       Properties:
         QueueName: myDLQ
 ```
+
+Note: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic.
diff --git a/lib/plugins/aws/package/compile/events/sns/index.js b/lib/plugins/aws/package/compile/events/sns/index.js
index 3b62dc379..109ab42f1 100644
--- a/lib/plugins/aws/package/compile/events/sns/index.js
+++ b/lib/plugins/aws/package/compile/events/sns/index.js
@@ -122,6 +122,25 @@ class AwsCompileSNSEvents {
               throw new this.serverless.classes.Error(errorMessage);
             }
 
+            let normalizedRedrivePolicy = event.sns.redrivePolicy;
+            let dlqLogicalId;
+            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;
+              if (typeof dlqTarget === 'object') {
+                if (_.has(dlqTarget, 'Ref')) {
+                  dlqLogicalId = dlqTarget.Ref;
+                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {
+                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
+                  });
+                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {
+                  const getAtt = dlqTarget['Fn::GetAtt'];
+                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {
+                    dlqLogicalId = getAtt[0];
+                  }
+                }
+              }
+            }
+
             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
 
             const endpoint = {
@@ -142,7 +161,7 @@ class AwsCompileSNSEvents {
                     Protocol: 'lambda',
                     Endpoint: endpoint,
                     FilterPolicy: event.sns.filterPolicy,
-                    RedrivePolicy: event.sns.redrivePolicy,
+                    RedrivePolicy: normalizedRedrivePolicy,
                     Region: region,
                   },
                 },
@@ -195,7 +214,7 @@ class AwsCompileSNSEvents {
                         Ref: topicLogicalId,
                       },
                       FilterPolicy: event.sns.filterPolicy,
-                      RedrivePolicy: event.sns.redrivePolicy,
+                      RedrivePolicy: normalizedRedrivePolicy,
                     }),
                   },
                 });
@@ -224,7 +243,7 @@ class AwsCompileSNSEvents {
               },
             });
 
-            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {
               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
                 functionName,
                 `${topicName}DLQ`
@@ -243,7 +262,7 @@ class AwsCompileSNSEvents {
                             Service: 'sns.amazonaws.com',
                           },
                           Action: 'sqs:SendMessage',
-                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,
+                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
                           Condition: {
                             ArnEquals: {
                               'aws:SourceArn': topicArn,
@@ -252,7 +271,7 @@ class AwsCompileSNSEvents {
                         },
                       ],
                     },
-                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
+                    Queues: [{ Ref: dlqLogicalId }],
                   },
                 },
               });

2025-11-13 20:44:31,423 - thread-135845298308800.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Patch applied successfully.
2025-11-13 20:44:31,424 - thread-135845298308800.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Applying patch: diff --git a/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
new file mode 100644
index 000000000..b181704ad
--- /dev/null
+++ b/lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
@@ -0,0 +1,54 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileSNSEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileSNSEvents - redrivePolicy QueuePolicy', () => {
+  let serverless;
+  let awsCompileSNSEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    const options = { region: 'some-region' };
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileSNSEvents = new AwsCompileSNSEvents(serverless, options);
+  });
+
+  it('should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined', () => {
+    awsCompileSNSEvents.serverless.service.functions = {
+      first: {
+        events: [
+          {
+            sns: {
+              topicName: 'Topic 1',
+              displayName: 'Display name for topic 1',
+              redrivePolicy: {
+                deadLetterTargetArn: { 'Fn::GetAtt': ['SNSDLQ', 'Arn'] },
+              },
+            },
+          },
+        ],
+      },
+    };
+
+    Object.assign(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources,
+      {
+        SNSDLQ: {
+          Type: 'AWS::SQS::Queue',
+          Properties: { QueueName: 'SNSDLQ' },
+        },
+      }
+    );
+
+    awsCompileSNSEvents.compileSNSEvents();
+
+    expect(
+      awsCompileSNSEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
+        .FirstEventSourceMappingSQSTopic1DLQ.Properties.Queues
+    ).to.deep.equal([{ Ref: 'SNSDLQ' }]);
+  });
+})

2025-11-13 20:44:31,427 - thread-135845298308800.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Patch applied successfully.
2025-11-13 20:44:31,428 - thread-135845298308800.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:44:31,459 - thread-135845298308800.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:44:31,459 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:44:31,600 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:31,600 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at c09f71897 fix: Ensure AWS env vars in local invocation made with docker (#7349)
[?2004l
2025-11-13 20:44:31,600 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:44:31,702 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:31,702 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
Removing lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
[?2004l
2025-11-13 20:44:31,703 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:44:31,703 - thread-135845298308800.prometheus.docker.base_container - INFO - Creating directory docs/providers/aws/events in the container
2025-11-13 20:44:31,703 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p docs/providers/aws/events
2025-11-13 20:44:31,805 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:31,805 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:44:31,805 - thread-135845298308800.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/sns in the container
2025-11-13 20:44:31,805 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/sns
2025-11-13 20:44:31,907 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:31,907 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:44:31,907 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js in the container
2025-11-13 20:44:31,908 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating docs/providers/aws/events/sns.md in the container
2025-11-13 20:44:31,909 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/sns/index.js in the container
2025-11-13 20:44:31,917 - thread-135845298308800.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:44:33,681 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verify_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_IvVHgzG5BSaNRhJTi8z2f6Dz', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 457, 'total_tokens': 497, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--88f61a40-b2ce-4400-8f18-9cff4052453e-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js'}, 'id': 'call_IvVHgzG5BSaNRhJTi8z2f6Dz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 457, 'output_tokens': 40, 'total_tokens': 497, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:33,686 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
2025-11-13 20:44:35,030 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:35,031 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/sns/
/redrivePolicy.test.js
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents - redrivePolicy QueuePolicy[0m
  [32m  ✓[0m[90m should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined[0m


[92m [0m[32m 1 passing[0m[90m (11ms)[0m

(node:325) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:44:36,821 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verify_node - DEBUG - content='Result:\nnpx mocha lib/plugins/aws/package/compile/events/sns/\nredrivePolicy.test.js\n\n  AwsCompileSNSEvents - redrivePolicy QueuePolicy\n    ✓ should reference DLQ by URL (Ref) in QueuePolicy Queues when redrivePolicy is defined\n\n  1 passing (11ms)\n\n(node:325) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 155, 'prompt_tokens': 723, 'total_tokens': 878, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--748250db-5d59-4613-ada0-a407f62e2bbf-0' usage_metadata={'input_tokens': 723, 'output_tokens': 155, 'total_tokens': 878, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:41,147 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verify_structured_node - DEBUG - reproducing_test_fail_log=''
2025-11-13 20:44:41,179 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - INFO - Passing bug reproducing test: True
2025-11-13 20:44:41,179 - thread-135845298308800.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproducing_test_fail_log: 
2025-11-13 20:44:41,181 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-13 20:44:41,182 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-13 20:44:41,182 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-13 20:44:41,182 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-13 20:44:41,184 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-13 20:44:41,184 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-13 20:44:41,185 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-13 20:44:41,185 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-13 20:44:41,186 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - INFO - Enter get_pass_regression_test_patch_subgraph_node
2025-11-13 20:44:41,187 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:44:41,190 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/docs/providers/aws/events/sns.md b/docs/providers/aws/events/sns.md
index 556153b77..ab9a2f180 100644
--- a/docs/providers/aws/events/sns.md
+++ b/docs/providers/aws/events/sns.md
@@ -159,7 +159,7 @@ functions:
       - sns:
           topicName: dispatcher
           redrivePolicy:
-            deadLetterTargetArn: !Ref myDLQ
+            deadLetterTargetArn: !GetAtt myDLQ.Arn
 
 resources:
   Resources:
@@ -168,3 +168,5 @@ resources:
       Properties:
         QueueName: myDLQ
 ```
+
+Note: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic.
diff --git a/lib/plugins/aws/package/compile/events/sns/index.js b/lib/plugins/aws/package/compile/events/sns/index.js
index 3b62dc379..109ab42f1 100644
--- a/lib/plugins/aws/package/compile/events/sns/index.js
+++ b/lib/plugins/aws/package/compile/events/sns/index.js
@@ -122,6 +122,25 @@ class AwsCompileSNSEvents {
               throw new this.serverless.classes.Error(errorMessage);
             }
 
+            let normalizedRedrivePolicy = event.sns.redrivePolicy;
+            let dlqLogicalId;
+            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;
+              if (typeof dlqTarget === 'object') {
+                if (_.has(dlqTarget, 'Ref')) {
+                  dlqLogicalId = dlqTarget.Ref;
+                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {
+                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
+                  });
+                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {
+                  const getAtt = dlqTarget['Fn::GetAtt'];
+                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {
+                    dlqLogicalId = getAtt[0];
+                  }
+                }
+              }
+            }
+
             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
 
             const endpoint = {
@@ -142,7 +161,7 @@ class AwsCompileSNSEvents {
                     Protocol: 'lambda',
                     Endpoint: endpoint,
                     FilterPolicy: event.sns.filterPolicy,
-                    RedrivePolicy: event.sns.redrivePolicy,
+                    RedrivePolicy: normalizedRedrivePolicy,
                     Region: region,
                   },
                 },
@@ -195,7 +214,7 @@ class AwsCompileSNSEvents {
                         Ref: topicLogicalId,
                       },
                       FilterPolicy: event.sns.filterPolicy,
-                      RedrivePolicy: event.sns.redrivePolicy,
+                      RedrivePolicy: normalizedRedrivePolicy,
                     }),
                   },
                 });
@@ -224,7 +243,7 @@ class AwsCompileSNSEvents {
               },
             });
 
-            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {
               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
                 functionName,
                 `${topicName}DLQ`
@@ -243,7 +262,7 @@ class AwsCompileSNSEvents {
                             Service: 'sns.amazonaws.com',
                           },
                           Action: 'sqs:SendMessage',
-                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,
+                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
                           Condition: {
                             ArnEquals: {
                               'aws:SourceArn': topicArn,
@@ -252,7 +271,7 @@ class AwsCompileSNSEvents {
                         },
                       ],
                     },
-                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
+                    Queues: [{ Ref: dlqLogicalId }],
                   },
                 },
               });

2025-11-13 20:44:41,225 - thread-135845298308800.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:44:41,263 - thread-135845298308800.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:44:41,263 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:44:41,366 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:41,366 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at c09f71897 fix: Ensure AWS env vars in local invocation made with docker (#7349)
[?2004l
2025-11-13 20:44:41,366 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:44:41,468 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:41,468 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
Removing lib/plugins/aws/package/compile/events/sns/redrivePolicy.test.js
[?2004l
2025-11-13 20:44:41,469 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:44:41,469 - thread-135845298308800.prometheus.docker.base_container - INFO - Creating directory docs/providers/aws/events in the container
2025-11-13 20:44:41,470 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p docs/providers/aws/events
2025-11-13 20:44:41,572 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:41,572 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:44:41,572 - thread-135845298308800.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/sns in the container
2025-11-13 20:44:41,572 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/sns
2025-11-13 20:44:41,674 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:41,674 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:44:41,675 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating docs/providers/aws/events/sns.md in the container
2025-11-13 20:44:41,677 - thread-135845298308800.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/sns/index.js in the container
2025-11-13 20:44:41,687 - thread-135845298308800.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:44:41,688 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:44:41,689 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:44:45,971 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_q2MykRgGhgI9VyXK8luwUvxy', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 154, 'prompt_tokens': 675, 'total_tokens': 829, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 128, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4dc721ac-aa52-4a2a-8081-8a39abbca0ab-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_q2MykRgGhgI9VyXK8luwUvxy', 'type': 'tool_call'}] usage_metadata={'input_tokens': 675, 'output_tokens': 154, 'total_tokens': 829, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 128}}
2025-11-13 20:44:45,975 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:44:46,077 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:46,077 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1348
drwxr-xr-x   1 root root    4096 Nov 13 20:38 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:44 [01;34m..[0m
-rw-r--r--   1 root root      35 Nov 13 20:38 .codecov.yml
-rw-r--r--   1 root root     273 Nov 13 20:38 .editorconfig
drwxrwxr-x   1 root root    4096 Nov 13 20:44 [01;34m.git[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34m.github[0m
-rwxr-xr-x   1 root root      90 Nov 13 20:38 [01;32m.gitignore[0m
-rw-r--r--   1 root root   13275 Nov 13 20:38 .travis.yml
-rw-r--r--   1 root root    5152 Nov 13 20:38 0.5.x-RESOURCES.md
-rw-r--r--   1 root root  124479 Nov 13 20:38 CHANGELOG.md
-rw-r--r--   1 root root    3292 Nov 13 20:38 CODE_OF_CONDUCT.md
-rw-r--r--   1 root root    4867 Nov 13 20:38 CONTRIBUTING.md
-rw-r--r--   1 root root     324 Nov 13 20:38 Dockerfile
-rw-r--r--   1 root root    1086 Nov 13 20:38 LICENSE.txt
-rw-r--r--   1 root root   13197 Nov 13 20:38 README.md
-rw-r--r--   1 root root    7651 Nov 13 20:38 README_CN.md
-rw-r--r--   1 root root    5539 Nov 13 20:38 RELEASE_PROCESS.md
-rw-r--r--   1 root root    3896 Nov 13 20:38 VERSIONING.md
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34massets[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mbin[0m
-rw-r--r--   1 root root     924 Nov 13 20:38 commitlint.config.js
-rw-r--r--   1 root root    3970 Nov 13 20:38 docker-compose.yml
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mdocs[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mlib[0m
drwxr-xr-x 829 root root   28672 Aug 28 02:06 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1042361 Aug 28 02:06 package-lock.json
-rw-r--r--   1 root root    6325 Nov 13 20:38 package.json
-rw-r--r--   1 root root      86 Nov 13 20:38 prettier.config.js
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mscripts[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34mtests[0m
[?2004l
2025-11-13 20:44:47,652 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pj4lo7OYVRcoxeMRg535QYvh', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 1617, 'total_tokens': 1643, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--229e97e0-7b82-418a-8ae0-e3411ae9fa97-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_pj4lo7OYVRcoxeMRg535QYvh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1617, 'output_tokens': 26, 'total_tokens': 1643, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:44:47,656 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:44:47,758 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:47,758 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.64.0",
  "engines": {
    "node": ">=6.0"
  },
  "engineStrict": true,
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "author": "serverless.com",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/serverless/serverless"
  },
  "keywords": [
    "serverless",
    "serverless framework",
    "serverless applications",
    "serverless modules",
    "api gateway",
    "lambda",
    "aws",
    "aws lambda",
    "amazon",
    "amazon web services",
    "azure",
    "azure functions",
    "google cloud functions",
    "apache open whisk",
    "iot",
    "internet of things",
    "serverless.com"
  ],
  "files": [
    "bin",
    "lib",
    "scripts/postinstall.js",
    "scripts/preuninstall.js",
    "scripts/pre-release.js",
    "package.json",
    "README.md",
    "LICENSE.txt",
    "CHANGELOG.md"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "commitlint:pull-request": "commitlint -f HEAD~1",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node tests/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 tests/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha tests/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check tests/integration-package/**/*.tests.js",
    "lint": "eslint . --cache",
    "lint:fix": "npm run lint -- --fix",
    "lint:updated": "pipe-git-updated --ext=js -- eslint --cache",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c --ignore-path .gitignore \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write --ignore-path .gitignore \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/*"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "lib/plugins/create/templates/**",
    "lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./tests/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "tests/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    }
  },
  "devDependencies": {
    "@commitlint/cli": "^8.3.5",
    "@serverless/eslint-config": "^1.2.1",
    "@serverless/test": "^3.5.2",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "eslint": "^6.8.0",
    "eslint-plugin-import": "^2.20.1",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "log": "^6.0.0",
    "mocha": "^6.2.2",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^14.1.1",
    "pkg": "^4.4.3",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^7.5.0",
    "sinon-chai": "^3.4.0",
    "standard-version": "^7.1.0",
    "strip-ansi": "^5.2.0",
    "ws": "^7.2.1",
    "xml2js": "^0.4.23"
  },
  "dependencies": {
    "@serverless/cli": "^1.4.0",
    "@serverless/enterprise-plugin": "^3.4.0",
    "archiver": "^1.3.0",
    "async": "^1.5.2",
    "aws-sdk": "^2.620.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.0",
    "ci-info": "^1.6.0",
    "d": "^1.0.1",
    "dayjs": "^1.8.20",
    "decompress": "^4.2.0",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^0.30.0",
    "get-stdin": "^5.0.1",
    "globby": "^6.1.0",
    "graceful-fs": "^4.2.3",
    "https-proxy-agent": "^4.0.0",
    "inquirer": "^6.5.2",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.1.1",
    "js-yaml": "^3.13.1",
    "json-cycle": "^1.3.0",
    "json-refs": "^2.1.7",
    "jszip": "^3.2.2",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.15",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.1",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.0.1",
    "node-fetch": "^1.7.3",
    "object-hash": "^1.3.1",
    "p-limit": "^2.2.2",
    "promise-queue": "^2.2.5",
    "raven": "^1.2.1",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^5.7.1",
    "semver-regex": "^1.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^2.0.3",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^16.1.0"
  }
}
[?2004l
2025-11-13 20:44:55,277 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0WIn9x0lqni5uedB7yXgmYjz', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g \\"should link topic to corresponding dlq when redrivePolicy is defined\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 635, 'prompt_tokens': 3821, 'total_tokens': 4456, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--741c5ae9-554a-4a22-ab52-5e2ecbe0853a-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should link topic to corresponding dlq when redrivePolicy is defined"'}, 'id': 'call_0WIn9x0lqni5uedB7yXgmYjz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3821, 'output_tokens': 635, 'total_tokens': 4456, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 20:44:55,281 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should link topic to corresponding dlq when redrivePolicy is defined"
2025-11-13 20:44:56,278 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:44:56,278 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should link topic to corresponding dlq when re
edrivePolicy is defined"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should link topic to corresponding dlq when redrivePolicy is defined[0m


[92m [0m[32m 1 passing[0m[90m (13ms)[0m

(node:342) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:45:00,771 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_EjjcCzElbEuOnExjK9fWBIcs', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g \\"should create corresponding resources when SNS events are given\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 311, 'prompt_tokens': 4130, 'total_tokens': 4441, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1536}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--12842824-2c27-4c44-9286-10fd807b8f4d-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create corresponding resources when SNS events are given"'}, 'id': 'call_EjjcCzElbEuOnExjK9fWBIcs', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4130, 'output_tokens': 311, 'total_tokens': 4441, 'input_token_details': {'audio': 0, 'cache_read': 1536}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:45:00,774 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create corresponding resources when SNS events are given"
2025-11-13 20:45:01,873 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:45:01,873 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create corresponding resources when SNS
S events are given"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when SNS events are given[0m


[92m [0m[32m 1 passing[0m[90m (15ms)[0m

(node:353) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:45:02,877 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3lwp66mKAAfLq08WRfBkgcJK', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g \\"should create corresponding resources when topic is defined in resources\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 50, 'prompt_tokens': 4427, 'total_tokens': 4477, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7bacd819-67c3-49b3-b5fa-bcd16b79d32c-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create corresponding resources when topic is defined in resources"'}, 'id': 'call_3lwp66mKAAfLq08WRfBkgcJK', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4427, 'output_tokens': 50, 'total_tokens': 4477, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:45:02,882 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create corresponding resources when topic is defined in resources"
2025-11-13 20:45:03,840 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:45:03,840 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create corresponding resources when top
pic is defined in resources"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when topic is defined in resources[0m


[92m [0m[32m 1 passing[0m[90m (17ms)[0m

(node:364) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:45:05,033 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_YG9nWdft9PidLYtzfU4R72iT', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g \\"should create single SNS topic when the same topic is referenced repeatedly\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 52, 'prompt_tokens': 4727, 'total_tokens': 4779, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b04df9c4-70a1-4af2-ab41-f8a184ca2ea1-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create single SNS topic when the same topic is referenced repeatedly"'}, 'id': 'call_YG9nWdft9PidLYtzfU4R72iT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4727, 'output_tokens': 52, 'total_tokens': 4779, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:45:05,037 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create single SNS topic when the same topic is referenced repeatedly"
2025-11-13 20:45:06,009 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:45:06,009 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create single SNS topic when the same t
topic is referenced repeatedly"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create single SNS topic when the same topic is referenced repeatedly[0m


[92m [0m[32m 1 passing[0m[90m (17ms)[0m

(node:375) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:45:07,455 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_o9vxpI41bQAVLVg0qnPKBmVT', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g \\"should create SNS topic when arn, topicName, and filterPolicy are given as object\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 57, 'prompt_tokens': 5033, 'total_tokens': 5090, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--936b74b4-5ea7-4116-bb30-ccf49caa2e74-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create SNS topic when arn, topicName, and filterPolicy are given as object"'}, 'id': 'call_o9vxpI41bQAVLVg0qnPKBmVT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5033, 'output_tokens': 57, 'total_tokens': 5090, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:45:07,458 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/sns/index.test.js -g "should create SNS topic when arn, topicName, and filterPolicy are given as object"
2025-11-13 20:45:08,423 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:45:08,423 - thread-135845298308800.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create SNS topic when arn, topicName, a
and filterPolicy are given as object"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create SNS topic when arn, topicName, and filterPolicy are given as object[0m


[92m [0m[32m 1 passing[0m[90m (17ms)[0m

(node:386) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:45:28,527 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/sns/index.test.js -g "should link topic to corresponding dlq when re\nedrivePolicy is defined"\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileSNSEvents\x1b[0m\n\x1b[0m    #compileSNSEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should link topic to corresponding dlq when redrivePolicy is defined\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (13ms)\x1b[0m\n\n(node:342) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n\x1b[?2004l\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/sns/index.test.js -g "should create corresponding resources when SNS\nS events are given"\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileSNSEvents\x1b[0m\n\x1b[0m    #compileSNSEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should create corresponding resources when SNS events are given\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (15ms)\x1b[0m\n\n(node:353) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n\x1b[?2004l\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/sns/index.test.js -g "should create corresponding resources when top\npic is defined in resources"\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileSNSEvents\x1b[0m\n\x1b[0m    #compileSNSEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should create corresponding resources when topic is defined in resources\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (17ms)\x1b[0m\n\n(node:364) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n\x1b[?2004l\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/sns/index.test.js -g "should create single SNS topic when the same t\ntopic is referenced repeatedly"\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileSNSEvents\x1b[0m\n\x1b[0m    #compileSNSEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should create single SNS topic when the same topic is referenced repeatedly\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (17ms)\x1b[0m\n\n(node:375) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n\x1b[?2004l\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/sns/index.test.js -g "should create SNS topic when arn, topicName, a\nand filterPolicy are given as object"\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileSNSEvents\x1b[0m\n\x1b[0m    #compileSNSEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should create SNS topic when arn, topicName, and filterPolicy are given as object\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (17ms)\x1b[0m\n\n(node:386) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n\x1b[?2004l\n\nTotal tests run: 5\nOverall result: PASS' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2530, 'prompt_tokens': 5354, 'total_tokens': 7884, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1280, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4096}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--932072c6-6a44-4054-aae2-9b3a1fb86a26-0' usage_metadata={'input_tokens': 5354, 'output_tokens': 2530, 'total_tokens': 7884, 'input_token_details': {'audio': 0, 'cache_read': 4096}, 'output_token_details': {'audio': 0, 'reasoning': 1280}}
2025-11-13 20:45:28,533 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined
lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given
lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources
lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly
lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should link topic to corresponding dlq when re
edrivePolicy is defined"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should link topic to corresponding dlq when redrivePolicy is defined[0m


[92m [0m[32m 1 passing[0m[90m (13ms)[0m

(node:342) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create corresponding resources when SNS
S events are given"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when SNS events are given[0m


[92m [0m[32m 1 passing[0m[90m (15ms)[0m

(node:353) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create corresponding resources when top
pic is defined in resources"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when topic is defined in resources[0m


[92m [0m[32m 1 passing[0m[90m (17ms)[0m

(node:364) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create single SNS topic when the same t
topic is referenced repeatedly"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create single SNS topic when the same topic is referenced repeatedly[0m


[92m [0m[32m 1 passing[0m[90m (17ms)[0m

(node:375) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/sns/index.test.js -g "should create SNS topic when arn, topicName, a
and filterPolicy are given as object"
[?2004l

[0m[0m
[0m  AwsCompileSNSEvents[0m
[0m    #compileSNSEvents()[0m
    [32m  ✓[0m[90m should create SNS topic when arn, topicName, and filterPolicy are given as object[0m


[92m [0m[32m 1 passing[0m[90m (17ms)[0m

(node:386) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l

Total tests run: 5
Overall result: PASS
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:45:41,078 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object'] regression_test_fail_log='' total_tests_run=5
2025-11-13 20:45:41,083 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:45:41,083 - thread-135845298308800.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:45:41,085 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:45:41,085 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/package/compile/events/sns/index.test.js::should link topic to corresponding dlq when redrivePolicy is defined', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when SNS events are given', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create corresponding resources when topic is defined in resources', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create single SNS topic when the same topic is referenced repeatedly', 'lib/plugins/aws/package/compile/events/sns/index.test.js::should create SNS topic when arn, topicName, and filterPolicy are given as object']
2025-11-13 20:45:41,085 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - True
2025-11-13 20:45:41,087 - thread-135845298308800.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - tested_patch_result: [TestedPatchResult(patch="diff --git a/docs/providers/aws/events/sns.md b/docs/providers/aws/events/sns.md\nindex 556153b77..ab9a2f180 100644\n--- a/docs/providers/aws/events/sns.md\n+++ b/docs/providers/aws/events/sns.md\n@@ -159,7 +159,7 @@ functions:\n       - sns:\n           topicName: dispatcher\n           redrivePolicy:\n-            deadLetterTargetArn: !Ref myDLQ\n+            deadLetterTargetArn: !GetAtt myDLQ.Arn\n \n resources:\n   Resources:\n@@ -168,3 +168,5 @@ resources:\n       Properties:\n         QueueName: myDLQ\n ```\n+\n+Note: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic.\ndiff --git a/lib/plugins/aws/package/compile/events/sns/index.js b/lib/plugins/aws/package/compile/events/sns/index.js\nindex 3b62dc379..109ab42f1 100644\n--- a/lib/plugins/aws/package/compile/events/sns/index.js\n+++ b/lib/plugins/aws/package/compile/events/sns/index.js\n@@ -122,6 +122,25 @@ class AwsCompileSNSEvents {\n               throw new this.serverless.classes.Error(errorMessage);\n             }\n \n+            let normalizedRedrivePolicy = event.sns.redrivePolicy;\n+            let dlqLogicalId;\n+            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n+              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;\n+              if (typeof dlqTarget === 'object') {\n+                if (_.has(dlqTarget, 'Ref')) {\n+                  dlqLogicalId = dlqTarget.Ref;\n+                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {\n+                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },\n+                  });\n+                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {\n+                  const getAtt = dlqTarget['Fn::GetAtt'];\n+                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {\n+                    dlqLogicalId = getAtt[0];\n+                  }\n+                }\n+              }\n+            }\n+\n             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);\n \n             const endpoint = {\n@@ -142,7 +161,7 @@ class AwsCompileSNSEvents {\n                     Protocol: 'lambda',\n                     Endpoint: endpoint,\n                     FilterPolicy: event.sns.filterPolicy,\n-                    RedrivePolicy: event.sns.redrivePolicy,\n+                    RedrivePolicy: normalizedRedrivePolicy,\n                     Region: region,\n                   },\n                 },\n@@ -195,7 +214,7 @@ class AwsCompileSNSEvents {\n                         Ref: topicLogicalId,\n                       },\n                       FilterPolicy: event.sns.filterPolicy,\n-                      RedrivePolicy: event.sns.redrivePolicy,\n+                      RedrivePolicy: normalizedRedrivePolicy,\n                     }),\n                   },\n                 });\n@@ -224,7 +243,7 @@ class AwsCompileSNSEvents {\n               },\n             });\n \n-            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {\n+            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {\n               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(\n                 functionName,\n                 `${topicName}DLQ`\n@@ -243,7 +262,7 @@ class AwsCompileSNSEvents {\n                             Service: 'sns.amazonaws.com',\n                           },\n                           Action: 'sqs:SendMessage',\n-                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,\n+                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },\n                           Condition: {\n                             ArnEquals: {\n                               'aws:SourceArn': topicArn,\n@@ -252,7 +271,7 @@ class AwsCompileSNSEvents {\n                         },\n                       ],\n                     },\n-                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],\n+                    Queues: [{ Ref: dlqLogicalId }],\n                   },\n                 },\n               });\n", passed=True, regression_test_failure_log='')]
2025-11-13 20:45:41,118 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-13 20:45:41,118 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-13 20:45:41,118 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-13 20:45:41,118 - thread-135845298308800.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-13 20:45:41,144 - thread-135845298308800.prometheus.lang_graph.nodes.issue_verified_bug_subgraph_node - INFO - edit_patch: diff --git a/docs/providers/aws/events/sns.md b/docs/providers/aws/events/sns.md
index 556153b77..ab9a2f180 100644
--- a/docs/providers/aws/events/sns.md
+++ b/docs/providers/aws/events/sns.md
@@ -159,7 +159,7 @@ functions:
       - sns:
           topicName: dispatcher
           redrivePolicy:
-            deadLetterTargetArn: !Ref myDLQ
+            deadLetterTargetArn: !GetAtt myDLQ.Arn
 
 resources:
   Resources:
@@ -168,3 +168,5 @@ resources:
       Properties:
         QueueName: myDLQ
 ```
+
+Note: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic.
diff --git a/lib/plugins/aws/package/compile/events/sns/index.js b/lib/plugins/aws/package/compile/events/sns/index.js
index 3b62dc379..109ab42f1 100644
--- a/lib/plugins/aws/package/compile/events/sns/index.js
+++ b/lib/plugins/aws/package/compile/events/sns/index.js
@@ -122,6 +122,25 @@ class AwsCompileSNSEvents {
               throw new this.serverless.classes.Error(errorMessage);
             }
 
+            let normalizedRedrivePolicy = event.sns.redrivePolicy;
+            let dlqLogicalId;
+            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;
+              if (typeof dlqTarget === 'object') {
+                if (_.has(dlqTarget, 'Ref')) {
+                  dlqLogicalId = dlqTarget.Ref;
+                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {
+                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
+                  });
+                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {
+                  const getAtt = dlqTarget['Fn::GetAtt'];
+                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {
+                    dlqLogicalId = getAtt[0];
+                  }
+                }
+              }
+            }
+
             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
 
             const endpoint = {
@@ -142,7 +161,7 @@ class AwsCompileSNSEvents {
                     Protocol: 'lambda',
                     Endpoint: endpoint,
                     FilterPolicy: event.sns.filterPolicy,
-                    RedrivePolicy: event.sns.redrivePolicy,
+                    RedrivePolicy: normalizedRedrivePolicy,
                     Region: region,
                   },
                 },
@@ -195,7 +214,7 @@ class AwsCompileSNSEvents {
                         Ref: topicLogicalId,
                       },
                       FilterPolicy: event.sns.filterPolicy,
-                      RedrivePolicy: event.sns.redrivePolicy,
+                      RedrivePolicy: normalizedRedrivePolicy,
                     }),
                   },
                 });
@@ -224,7 +243,7 @@ class AwsCompileSNSEvents {
               },
             });
 
-            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {
               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
                 functionName,
                 `${topicName}DLQ`
@@ -243,7 +262,7 @@ class AwsCompileSNSEvents {
                             Service: 'sns.amazonaws.com',
                           },
                           Action: 'sqs:SendMessage',
-                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,
+                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
                           Condition: {
                             ArnEquals: {
                               'aws:SourceArn': topicArn,
@@ -252,7 +271,7 @@ class AwsCompileSNSEvents {
                         },
                       ],
                     },
-                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
+                    Queues: [{ Ref: dlqLogicalId }],
                   },
                 },
               });

2025-11-13 20:45:51,579 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_responder_node - DEBUG - content='Thanks for the detailed report and the suggested approach.\n\nWhat we understood:\n- In the QueuePolicy created for SNS redrive, Resource must be the queue ARN, while Queues must be the queue URL (Ref).\n- The current behavior used the ARN in both places, leading to deployment errors, and the docs example incorrectly showed using Ref for deadLetterTargetArn.\n\nWhat we changed:\n- Updated the implementation to normalize redrivePolicy.deadLetterTargetArn:\n  - If a Ref to the DLQ is provided, it is converted to Fn::GetAtt [DLQ, Arn] for the subscription.\n  - If Fn::GetAtt [DLQ, Arn] is already provided, it is used as-is.\n- When generating the QueuePolicy, we now:\n  - Set Resource to Fn::GetAtt [<DLQ logical id>, Arn].\n  - Set Queues to Ref <DLQ logical id>.\n- Applied the normalized RedrivePolicy consistently to the SNS subscription resources.\n- Updated the documentation example to use !GetAtt myDLQ.Arn for deadLetterTargetArn and added a note clarifying that:\n  - When the DLQ is in the same stack, the framework attaches a policy allowing SNS to send messages to it.\n  - If you reference a DLQ from another stack/account (by providing a raw ARN), ensure the external queue policy permits sns:SendMessage from your SNS topic.\n\nVerification:\n- The bug reproduction test now passes.\n- All selected regression tests pass successfully.\n\nThis aligns the policy generation with CloudFormation expectations and prevents the deployment error you reported. Thanks again for raising this—your suggestion directly informed the fix.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 984, 'prompt_tokens': 1516, 'total_tokens': 2500, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--98a58e3d-91c1-4def-b20f-b97749caa2c3-0' usage_metadata={'input_tokens': 1516, 'output_tokens': 984, 'total_tokens': 2500, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:45:51,581 - thread-135845298308800.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-13 20:45:51,581 - thread-135845298308800.prometheus.docker.base_container - INFO - Closing persistent shell...
2025-11-13 20:45:51,682 - thread-135845298308800.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-13 20:46:02,015 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/sns.md b/docs/providers/aws/events/sns.md
index 556153b77..ab9a2f180 100644
--- a/docs/providers/aws/events/sns.md
+++ b/docs/providers/aws/events/sns.md
@@ -159,7 +159,7 @@ functions:
       - sns:
           topicName: dispatcher
           redrivePolicy:
-            deadLetterTargetArn: !Ref myDLQ
+            deadLetterTargetArn: !GetAtt myDLQ.Arn
 
 resources:
   Resources:
@@ -168,3 +168,5 @@ resources:
       Properties:
         QueueName: myDLQ
 ```
+
+Note: When the DLQ is defined in the same stack, the framework will also attach a policy to that queue allowing SNS to send messages to it. If you reference a DLQ from another stack or account (by providing a raw ARN), ensure that the external queue has an appropriate policy permitting sns:SendMessage from your SNS topic.
diff --git a/lib/plugins/aws/package/compile/events/sns/index.js b/lib/plugins/aws/package/compile/events/sns/index.js
index 3b62dc379..109ab42f1 100644
--- a/lib/plugins/aws/package/compile/events/sns/index.js
+++ b/lib/plugins/aws/package/compile/events/sns/index.js
@@ -122,6 +122,25 @@ class AwsCompileSNSEvents {
               throw new this.serverless.classes.Error(errorMessage);
             }
 
+            let normalizedRedrivePolicy = event.sns.redrivePolicy;
+            let dlqLogicalId;
+            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+              const dlqTarget = event.sns.redrivePolicy.deadLetterTargetArn;
+              if (typeof dlqTarget === 'object') {
+                if (_.has(dlqTarget, 'Ref')) {
+                  dlqLogicalId = dlqTarget.Ref;
+                  normalizedRedrivePolicy = _.assign({}, event.sns.redrivePolicy, {
+                    deadLetterTargetArn: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
+                  });
+                } else if (_.has(dlqTarget, 'Fn::GetAtt')) {
+                  const getAtt = dlqTarget['Fn::GetAtt'];
+                  if (Array.isArray(getAtt) && getAtt[1] === 'Arn') {
+                    dlqLogicalId = getAtt[0];
+                  }
+                }
+              }
+            }
+
             const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(functionName);
 
             const endpoint = {
@@ -142,7 +161,7 @@ class AwsCompileSNSEvents {
                     Protocol: 'lambda',
                     Endpoint: endpoint,
                     FilterPolicy: event.sns.filterPolicy,
-                    RedrivePolicy: event.sns.redrivePolicy,
+                    RedrivePolicy: normalizedRedrivePolicy,
                     Region: region,
                   },
                 },
@@ -195,7 +214,7 @@ class AwsCompileSNSEvents {
                         Ref: topicLogicalId,
                       },
                       FilterPolicy: event.sns.filterPolicy,
-                      RedrivePolicy: event.sns.redrivePolicy,
+                      RedrivePolicy: normalizedRedrivePolicy,
                     }),
                   },
                 });
@@ -224,7 +243,7 @@ class AwsCompileSNSEvents {
               },
             });
 
-            if (event.sns.redrivePolicy && event.sns.redrivePolicy.deadLetterTargetArn) {
+            if (normalizedRedrivePolicy && normalizedRedrivePolicy.deadLetterTargetArn && dlqLogicalId) {
               const queuePolicyLogicalId = this.provider.naming.getQueueLogicalId(
                 functionName,
                 `${topicName}DLQ`
@@ -243,7 +262,7 @@ class AwsCompileSNSEvents {
                             Service: 'sns.amazonaws.com',
                           },
                           Action: 'sqs:SendMessage',
-                          Resource: event.sns.redrivePolicy.deadLetterTargetArn,
+                          Resource: { 'Fn::GetAtt': [dlqLogicalId, 'Arn'] },
                           Condition: {
                             ArnEquals: {
                               'aws:SourceArn': topicArn,
@@ -252,7 +271,7 @@ class AwsCompileSNSEvents {
                         },
                       ],
                     },
-                    Queues: [event.sns.redrivePolicy.deadLetterTargetArn],
+                    Queues: [{ Ref: dlqLogicalId }],
                   },
                 },
               });

2025-11-13 20:46:02,015 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - passed_reproducing_test: True
2025-11-13 20:46:02,015 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - passed_regression_test: True
2025-11-13 20:46:02,015 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - passed_existing_test: False
2025-11-13 20:46:02,015 - thread-135845298308800.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - issue_response:
Thanks for the detailed report and the suggested approach.

What we understood:
- In the QueuePolicy created for SNS redrive, Resource must be the queue ARN, while Queues must be the queue URL (Ref).
- The current behavior used the ARN in both places, leading to deployment errors, and the docs example incorrectly showed using Ref for deadLetterTargetArn.

What we changed:
- Updated the implementation to normalize redrivePolicy.deadLetterTargetArn:
  - If a Ref to the DLQ is provided, it is converted to Fn::GetAtt [DLQ, Arn] for the subscription.
  - If Fn::GetAtt [DLQ, Arn] is already provided, it is used as-is.
- When generating the QueuePolicy, we now:
  - Set Resource to Fn::GetAtt [<DLQ logical id>, Arn].
  - Set Queues to Ref <DLQ logical id>.
- Applied the normalized RedrivePolicy consistently to the SNS subscription resources.
- Updated the documentation example to use !GetAtt myDLQ.Arn for deadLetterTargetArn and added a note clarifying that:
  - When the DLQ is in the same stack, the framework attaches a policy allowing SNS to send messages to it.
  - If you reference a DLQ from another stack/account (by providing a raw ARN), ensure the external queue policy permits sns:SendMessage from your SNS topic.

Verification:
- The bug reproduction test now passes.
- All selected regression tests pass successfully.

This aligns the policy generation with CloudFormation expectations and prevents the deployment error you reported. Thanks again for raising this—your suggestion directly informed the fix.

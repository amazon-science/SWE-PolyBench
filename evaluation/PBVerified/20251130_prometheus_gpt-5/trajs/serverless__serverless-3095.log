2025-11-14 00:23:23,197 - thread-135845308794560.prometheus.docker.base_container - INFO - Created temporary project directory: /tmp/tmpgeetlvgd/serverless
2025-11-14 00:23:23,198 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Using workdir: /testbed
2025-11-14 00:23:23,559 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_build: False
2025-11-14 00:23:23,559 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-14 00:23:23,559 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-14 00:23:23,559 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_reproduce_test: True
2025-11-14 00:23:23,559 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 5
2025-11-14 00:23:23,559 - thread-135845308794560.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - Enter IssueClassificationSubgraphNode
2025-11-14 00:23:23,560 - thread-135845308794560.prometheus.lang_graph.nodes.issue_classification_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

2025-11-14 00:23:23,560 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-14 00:23:23,561 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:23:40,090 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The issue points to a specific implementation file (lib/plugins/aws/deploy/compile/events/iot/index.js) and a variable (iotTemplate) causing JSON.parse errors due to trailing newlines from YAML folded scalars. The provided file tree does not include the content of this iot compile plugin, nor related helper code or documentation examples for IoT events. To accurately classify whether this is a bug or a usage/documentation issue, we need the exact implementation of the IoT compile plugin (including how iotTemplate is constructed and parsed), and the official IoT event documentation to verify expected YAML behavior. Optionally, any tests covering IoT event compilation would help determine intended handling.' query='Please provide the full content (with line numbers) of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md.' extra_requirements='If available, also include any related helper files used by the IoT compile plugin and any tests that reference IoT events; at minimum, include the sections where iotTemplate is built and where JSON.parse is called.' purpose='This context enables verification of the implementation and expected configuration to classify the report as a bug vs. documentation/usage issue.'
2025-11-14 00:23:40,091 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content (with line numbers) of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md.
2025-11-14 00:23:40,390 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-14 00:23:40,390 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-14 00:23:40,390 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-14 00:23:40,390 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-14 00:23:40,391 - thread-135845308794560.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-14 00:23:40,392 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-14 00:23:40,392 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content (with line numbers) of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md.
Extra requirements: If available, also include any related helper files used by the IoT compile plugin and any tests that reference IoT events; at minimum, include the sections where iotTemplate is built and where JSON.parse is called.
Purpose: This context enables verification of the implementation and expected configuration to classify the report as a bug vs. documentation/usage issue.
2025-11-14 00:23:45,206 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_6Tr0A5R00W5LpOYFqhBOIqvO', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 489, 'prompt_tokens': 2197, 'total_tokens': 2686, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a5af4a9d-bd36-41d6-99b2-7b172ad86bf0-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_6Tr0A5R00W5LpOYFqhBOIqvO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2197, 'output_tokens': 489, 'total_tokens': 2686, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-14 00:24:04,757 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dfEKJxM8Bj1LNMZCb0JgF0tM', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/iot.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1508, 'prompt_tokens': 3462, 'total_tokens': 4970, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--776f3a55-bb91-4df9-993f-cab6ee27443a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/events/iot.md'}, 'id': 'call_dfEKJxM8Bj1LNMZCb0JgF0tM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3462, 'output_tokens': 1508, 'total_tokens': 4970, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-14 00:24:11,475 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_eVfVVqqtxpbKA5ZnetODjI6u', 'function': {'arguments': '{"basename":"naming.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 542, 'prompt_tokens': 4210, 'total_tokens': 4752, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cb3ab88c-6ddc-4ee9-81b1-cf2d03b85c11-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'naming.js'}, 'id': 'call_eVfVVqqtxpbKA5ZnetODjI6u', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4210, 'output_tokens': 542, 'total_tokens': 4752, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-14 00:24:12,615 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_o9JbCMVR4K0hx4tvoe2o2SKF', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 4284, 'total_tokens': 4314, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3456}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4d137e8a-91d9-4951-96e9-995019ea0f75-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.js'}, 'id': 'call_o9JbCMVR4K0hx4tvoe2o2SKF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4284, 'output_tokens': 30, 'total_tokens': 4314, 'input_token_details': {'audio': 0, 'cache_read': 3456}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:24:20,460 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_luSjNur7MxbE12GzkWEH48xk', 'function': {'arguments': '{"basename":"iot.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 606, 'prompt_tokens': 7098, 'total_tokens': 7704, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4096}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e0abe2f1-33b2-47a4-b797-b674f1c05401-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iot.test.js'}, 'id': 'call_luSjNur7MxbE12GzkWEH48xk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7098, 'output_tokens': 606, 'total_tokens': 7704, 'input_token_details': {'audio': 0, 'cache_read': 4096}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-14 00:24:29,481 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PDX5WfqxpfsmpKdxqdHpEWjC', 'function': {'arguments': '{"relative_path":"test/unit/lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 747, 'prompt_tokens': 7148, 'total_tokens': 7895, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cc9e0a8e-486c-4a9d-81ab-357a49d3c428-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'test/unit/lib/plugins/aws/deploy/compile/events/iot/index.test.js'}, 'id': 'call_PDX5WfqxpfsmpKdxqdHpEWjC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7148, 'output_tokens': 747, 'total_tokens': 7895, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-14 00:24:35,801 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_P0d1j2NMClmfgjVmW8axHMZm', 'function': {'arguments': '{"basename":"iot"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 540, 'prompt_tokens': 7211, 'total_tokens': 7751, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--88c270d9-d317-458a-aaad-b3d4f4a2fc9e-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iot'}, 'id': 'call_P0d1j2NMClmfgjVmW8axHMZm', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7211, 'output_tokens': 540, 'total_tokens': 7751, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-14 00:24:41,732 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_tc9eeHOtpcbsYCp6fyhJuJlW', 'function': {'arguments': '{"basename":"index.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 478, 'prompt_tokens': 7284, 'total_tokens': 7762, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2c76a3d2-4506-4603-b9cb-18000570ead7-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'index.test.js'}, 'id': 'call_tc9eeHOtpcbsYCp6fyhJuJlW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7284, 'output_tokens': 478, 'total_tokens': 7762, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-14 00:24:53,872 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_B6cGoPPyARKNbly7UglKTtPk', 'function': {'arguments': '{"basename":"iot.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1117, 'prompt_tokens': 7504, 'total_tokens': 8621, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1088, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 7168}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4313c38f-1274-43ef-ac04-333cf793111d-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'iot.js'}, 'id': 'call_B6cGoPPyARKNbly7UglKTtPk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7504, 'output_tokens': 1117, 'total_tokens': 8621, 'input_token_details': {'audio': 0, 'cache_read': 7168}, 'output_token_details': {'audio': 0, 'reasoning': 1088}}
2025-11-14 00:25:10,777 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I retrieved the full contents (with line numbers) of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md. I also pulled in the related helper file lib/plugins/aws/lib/naming.js used by the IoT compile plugin (for getIotLogicalId and getLambdaIotPermissionLogicalId). In the IoT compiler file, the iotTemplate construction and JSON.parse calls are included in the output (iotTemplate at lines ~54–74 and JSON.parse at lines ~98–103). I searched for tests referencing IoT events but did not find any in this codebase.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1610, 'prompt_tokens': 7553, 'total_tokens': 9163, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 7424}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--8b0ac009-e7e8-4bcd-9967-e44173f7422b-0' usage_metadata={'input_tokens': 7553, 'output_tokens': 1610, 'total_tokens': 9163, 'input_token_details': {'audio': 0, 'cache_read': 7424}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-14 00:25:10,781 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content (with line numbers) of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If available, also include any related helper files used by the IoT compile plugin and any tests that reference IoT events; at minimum, include the sections where iotTemplate is built and where JSON.parse is called.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
This context enables verification of the implementation and expected configuration to classify the report as a bug vs. documentation/usage issue.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: docs/providers/aws/events/iot.md
Line number range: 1 - 71
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - IoT
3. menuText: IoT
4. menuOrder: 7
5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)
11. <!-- DOCS-SITE-LINK:END -->
12. 
13. # IoT
14. 
15. ## Simple event definition
16. 
17. This will enable your Lambda function to be called by an AWS IoT rule.
18. 
19. ```yml
20. functions:
21.   myIoT:
22.     handler: myIoT.handler
23.     events:
24.       - iot:
25.           sql: "SELECT * FROM 'some_topic'"
26. ```
27. 
28. ## Enabling / Disabling
29. 
30. **Note:** `iot` events are enabled by default.
31. 
32. This will create and attach a disabled `iot` event for the `myIoT` function.
33. 
34. ```yml
35. functions:
36.   myIoT:
37.     handler: myIoT.handler
38.     events:
39.       - iot:
40.           sql: "SELECT * FROM 'some_topic'"
41.           enabled: false
42. ```
43. 
44. ## Specify Name and Description
45. 
46. Name and Description can be specified with the help of the `name` and `description` properties.
47. 
48. ```yml
49. functions:
50.   myIoT:
51.     handler: myIoT.handler
52.     events:
53.       - iot:
54.           name: "myIotEvent"
55.           sql: "SELECT * FROM 'some_topic'"
56.           description: "My IoT Event Description"
57. ```
58. 
59. ## Specify SQL Versions
60. 
61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.
62. 
63. ```yml
64. functions:
65.   myIoT:
66.     handler: myIoT.handler
67.     events:
68.       - iot:
69.           sql: "SELECT * FROM 'some_topic'"
70.           sqlVersion: "beta"
71. ```


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }
14. 
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }
47. 
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;
96. 
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);
107.           }
108.         });
109.       }
110.     });
111.   }
112. }
113. module.exports = AwsCompileIoTEvents;


File: lib/plugins/aws/lib/naming.js
Line number range: 1 - 242
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. /**
6.  * A centralized naming object that provides naming standards for the AWS provider plugin.  The
7.  * intent is for this to enable naming standards to be configured using a custom naming plugin or
8.  * a naming configuration feature, based on which of those is determined to in the best approach.
9.  *
10.  * There are two main concepts:
11.  * 1. normalization - normalization of a name comprises removing any unacceptable characters and
12.  * changing the name to comply with capitalization expectations.
13.  * 2. logicalization - logicalization of a name comprises preparing it for use as an attribute name
14.  * for a resource within the Service's CloudFormation Template.  Notably, a suffix or prefix should
15.  * be added to the name of resources.  These help to disambiguate attributes identifying or
16.  * declaring different aspects or data about the same resource.  (e.g. MyFuncLambdaFunction vs.
17.  * MyFuncLambdaFunctionArn)  Generally, normalization of the name also occurs.
18.  *
19.  * Sometimes, it is important to deconstruct the names that are created via this centralized
20.  * utility.  As a result, the regular expressions used for identifying specific resource types using
21.  * their names or the logic to extract a name components from a logical name are things that must
22.  * also be centralized so that they co-occur and are more correlated spatially within the code base.
23.  * That is to say that they are easier to change together.
24.  */
25. module.exports = {
26. 
27.   // General
28.   normalizeName(name) {
29.     return `${_.upperFirst(name)}`;
30.   },
31.   normalizeNameToAlphaNumericOnly(name) {
32.     return this.normalizeName(name.replace(/[^0-9A-Za-z]/g, ''));
33.   },
34.   normalizePathPart(path) {
35.     return _.upperFirst(
36.       _.capitalize(path)
37.         .replace(/-/g, 'Dash')
38.         .replace(/\{(.*)\}/g, '$1Var')
39.         .replace(/[^0-9A-Za-z]/g, '')
40.     );
41.   },
42. 
43.   getServiceEndpointRegex() {
44.     return /^ServiceEndpoint/;
45.   },
46. 
47.   // Stack
48.   getStackName() {
49.     return `${this.provider.serverless.service.service}-${this.provider.getStage()}`;
50.   },
51. 
52.   // Role
53.   getRolePath() {
54.     return '/';
55.   },
56.   getRoleName() {
57.     return {
58.       'Fn::Join': [
59.         '-',
60.         [
61.           this.provider.serverless.service.service,
62.           this.provider.getStage(),
63.           this.provider.getRegion(),
64.           'lambdaRole',
65.         ],
66.       ],
67.     };
68.   },
69.   getRoleLogicalId() {
70.     return 'IamRoleLambdaExecution';
71.   },
72. 
73.   // Policy
74.   getPolicyName() {
75.     return { // TODO should probably have name ordered and altered as above - see AWS docs
76.       'Fn::Join': [
77.         '-',
78.         [
79.           this.provider.getStage(),
80.           // TODO is it a bug here in that the role is not specific to the region?
81.           this.provider.serverless.service.service,
82.           'lambda',
83.         ],
84.       ],
85.     };
86.   },
87.   getPolicyLogicalId() {
88.     return 'IamPolicyLambdaExecution';
89.   },
90. 
91.   // Log Group
92.   getLogGroupLogicalId(functionName) {
93.     return `${this.getNormalizedFunctionName(functionName)}LogGroup`;
94.   },
95.   getLogGroupName(functionName) {
96.     return `/aws/lambda/${functionName}`;
97.   },
98. 
99.   // Lambda
100.   getNormalizedFunctionName(functionName) {
101.     return this.normalizeName(functionName
102.       .replace(/-/g, 'Dash')
103.       .replace(/_/g, 'Underscore'));
104.   },
105.   extractLambdaNameFromArn(functionArn) {
106.     return functionArn.substring(functionArn.lastIndexOf(':') + 1);
107.   },
108.   extractAuthorizerNameFromArn(functionArn) {
109.     const splitArn = functionArn.split(':');
110.     // TODO the following two lines assumes default function naming?  Is there a better way?
111.     // TODO (see ~/lib/classes/Service.js:~155)
112.     const splitName = splitArn[splitArn.length - 1].split('-');
113.     return splitName[splitName.length - 1];
114.   },
115.   getLambdaLogicalId(functionName) {
116.     return `${this.getNormalizedFunctionName(functionName)}LambdaFunction`;
117.   },
118.   getLambdaLogicalIdRegex() {
119.     return /LambdaFunction$/;
120.   },
121.   getLambdaOutputLogicalId(functionName) {
122.     return `${this.getLambdaLogicalId(functionName)}Arn`;
123.   },
124.   getLambdaOutputLogicalIdRegex() {
125.     return /LambdaFunctionArn$/;
126.   },
127.   getLambdaVersionLogicalId(functionName, sha) {
128.     return `${this.getNormalizedFunctionName(functionName)}LambdaVersion${sha
129.       .replace(/[^0-9a-z]/gi, '')}`;
130.   },
131.   getLambdaVersionOutputLogicalId(functionName) {
132.     return `${this.getLambdaLogicalId(functionName)}QualifiedArn`;
133.   },
134. 
135.   // API Gateway
136.   getApiGatewayName() {
137.     return `${this.provider.getStage()}-${this.provider.serverless.service.service}`;
138.   },
139.   generateApiGatewayDeploymentLogicalId() {
140.     return `ApiGatewayDeployment${(new Date()).getTime().toString()}`;
141.   },
142.   getRestApiLogicalId() {
143.     return 'ApiGatewayRestApi';
144.   },
145.   getNormalizedAuthorizerName(functionName) {
146.     return this.getNormalizedFunctionName(functionName);
147.   },
148.   getAuthorizerLogicalId(functionName) {
149.     return `${this.getNormalizedAuthorizerName(functionName)}ApiGatewayAuthorizer`;
150.   },
151.   normalizePath(resourcePath) {
152.     return resourcePath.split('/').map(
153.       this.normalizePathPart.bind(this)
154.     ).join('');
155.   },
156.   getResourceLogicalId(resourcePath) {
157.     return `ApiGatewayResource${this.normalizePath(resourcePath)}`;
158.   },
159.   extractResourceId(resourceLogicalId) {
160.     return resourceLogicalId.match(/ApiGatewayResource(.*)/)[1];
161.   },
162.   normalizeMethodName(methodName) {
163.     return this.normalizeName(methodName.toLowerCase());
164.   },
165.   getMethodLogicalId(resourceId, methodName) {
166.     return `ApiGatewayMethod${resourceId}${this.normalizeMethodName(methodName)}`;
167.   },
168.   getApiKeyLogicalId(apiKeyNumber) {
169.     return `ApiGatewayApiKey${apiKeyNumber}`;
170.   },
171.   getApiKeyLogicalIdRegex() {
172.     return /^ApiGatewayApiKey/;
173.   },
174. 
175.   // S3
176.   getDeploymentBucketLogicalId() {
177.     return 'ServerlessDeploymentBucket';
178.   },
179.   getDeploymentBucketOutputLogicalId() {
180.     return 'ServerlessDeploymentBucketName';
181.   },
182.   normalizeBucketName(bucketName) {
183.     return this.normalizeNameToAlphaNumericOnly(bucketName);
184.   },
185.   getBucketLogicalId(bucketName) {
186.     return `S3Bucket${this.normalizeBucketName(bucketName)}`;
187.   },
188. 
189.   // SNS
190.   normalizeTopicName(topicName) {
191.     return this.normalizeNameToAlphaNumericOnly(topicName);
192.   },
193.   getTopicLogicalId(topicName) {
194.     return `SNSTopic${this.normalizeTopicName(topicName)}`;
195.   },
196. 
197.   // Schedule
198.   getScheduleId(functionName) {
199.     return `${functionName}Schedule`;
200.   },
201.   getScheduleLogicalId(functionName, scheduleIndex) {
202.     return `${this.getNormalizedFunctionName(functionName)}EventsRuleSchedule${scheduleIndex}`;
203.   },
204. 
205.   // Stream
206.   getStreamLogicalId(functionName, streamType, streamName) {
207.     return `${
208.       this.getNormalizedFunctionName(functionName)
209.     }EventSourceMapping${
210.       this.normalizeName(streamType)
211.     }${this.normalizeNameToAlphaNumericOnly(streamName)}`;
212.   },
213. 
214.   // IoT
215.   getIotLogicalId(functionName, iotIndex) {
216.     return `${this.getNormalizedFunctionName(functionName)}IotTopicRule${iotIndex}`;
217.   },
218.   getLambdaIotPermissionLogicalId(functionName, iotIndex) {
219.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionIotTopicRule${
220.       iotIndex}`;
221.   },
222. 
223.   // Permissions
224.   getLambdaS3PermissionLogicalId(functionName, bucketName) {
225.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermission${this
226.       .normalizeBucketName(bucketName)}S3`;
227.   },
228.   getLambdaSnsPermissionLogicalId(functionName, topicName) {
229.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermission${
230.       this.normalizeTopicName(topicName)}SNS`;
231.   },
232.   getLambdaSchedulePermissionLogicalId(functionName, scheduleIndex) {
233.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionEventsRuleSchedule${
234.       scheduleIndex}`;
235.   },
236.   getLambdaApiGatewayPermissionLogicalId(functionName) {
237.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionApiGateway`;
238.   },
239.   getLambdaAlexaSkillPermissionLogicalId(functionName) {
240.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionAlexaSkill`;
241.   },
242. };

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-14 00:25:27,929 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='The query requests the full content of the IoT compile plugin. Including the entire file provides all implementation details, including where iotTemplate is constructed and JSON.parse is called, satisfying the minimum extra requirement and enabling verification of configuration/implementation.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=1, end_line=113), ContextOutput(reasoning='The query requests the full content of the IoT events documentation to verify expected configuration and usage. Including the entire file is necessary to compare with implementation and classify issues.', relative_path='docs/providers/aws/events/iot.md', start_line=1, end_line=71), ContextOutput(reasoning='Extended relevance: The IoT compile plugin relies on naming helper functions to build logical IDs. Including getLambdaLogicalId clarifies how the Lambda ARN is referenced in the IoT rule and permission templates.', relative_path='lib/plugins/aws/lib/naming.js', start_line=115, end_line=118), ContextOutput(reasoning='Extended relevance: The IoT compile plugin uses IoT-specific naming helpers to create logical IDs for the IoT TopicRule and Lambda permission resources. These are essential for understanding resource naming and dependencies.', relative_path='lib/plugins/aws/lib/naming.js', start_line=214, end_line=221), ContextOutput(reasoning='Extended relevance: The above naming helpers depend on getNormalizedFunctionName, which defines how function names are normalized when constructing logical IDs. Including it provides necessary context for logical ID formation.', relative_path='lib/plugins/aws/lib/naming.js', start_line=100, end_line=104)]
2025-11-14 00:25:27,932 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 5 contexts to memory for query: Please provide the full content (with line numbers) of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md.
2025-11-14 00:25:29,337 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-14 00:25:29,339 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 5 new contexts to 0 existing contexts
2025-11-14 00:25:29,339 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 5 total contexts (removed 0 duplicates)
2025-11-14 00:25:29,341 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content (with line numbers) of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md.
Extra Requirements: If available, also include any related helper files used by the IoT compile plugin and any tests that reference IoT events; at minimum, include the sections where iotTemplate is built and where JSON.parse is called.
Purpose: This context enables verification of the implementation and expected configuration to classify the report as a bug vs. documentation/usage issue.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/iot.md
Line number range: 1 - 71
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - IoT
3. menuText: IoT
4. menuOrder: 7
5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)
11. <!-- DOCS-SITE-LINK:END -->
12. 
13. # IoT
14. 
15. ## Simple event definition
16. 
17. This will enable your Lambda function to be called by an AWS IoT rule.
18. 
19. ```yml
20. functions:
21.   myIoT:
22.     handler: myIoT.handler
23.     events:
24.       - iot:
25.           sql: "SELECT * FROM 'some_topic'"
26. ```
27. 
28. ## Enabling / Disabling
29. 
30. **Note:** `iot` events are enabled by default.
31. 
32. This will create and attach a disabled `iot` event for the `myIoT` function.
33. 
34. ```yml
35. functions:
36.   myIoT:
37.     handler: myIoT.handler
38.     events:
39.       - iot:
40.           sql: "SELECT * FROM 'some_topic'"
41.           enabled: false
42. ```
43. 
44. ## Specify Name and Description
45. 
46. Name and Description can be specified with the help of the `name` and `description` properties.
47. 
48. ```yml
49. functions:
50.   myIoT:
51.     handler: myIoT.handler
52.     events:
53.       - iot:
54.           name: "myIotEvent"
55.           sql: "SELECT * FROM 'some_topic'"
56.           description: "My IoT Event Description"
57. ```
58. 
59. ## Specify SQL Versions
60. 
61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.
62. 
63. ```yml
64. functions:
65.   myIoT:
66.     handler: myIoT.handler
67.     events:
68.       - iot:
69.           sql: "SELECT * FROM 'some_topic'"
70.           sqlVersion: "beta"
71. ```


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }
14. 
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }
47. 
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;
96. 
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);
107.           }
108.         });
109.       }
110.     });
111.   }
112. }
113. module.exports = AwsCompileIoTEvents;


File: lib/plugins/aws/lib/naming.js
Line number range: 100 - 104
Content:
100.   getNormalizedFunctionName(functionName) {
101.     return this.normalizeName(functionName
102.       .replace(/-/g, 'Dash')
103.       .replace(/_/g, 'Underscore'));
104.   },


File: lib/plugins/aws/lib/naming.js
Line number range: 115 - 118
Content:
115.   getLambdaLogicalId(functionName) {
116.     return `${this.getNormalizedFunctionName(functionName)}LambdaFunction`;
117.   },
118.   getLambdaLogicalIdRegex() {


File: lib/plugins/aws/lib/naming.js
Line number range: 214 - 221
Content:
214.   // IoT
215.   getIotLogicalId(functionName, iotIndex) {
216.     return `${this.getNormalizedFunctionName(functionName)}IotTopicRule${iotIndex}`;
217.   },
218.   getLambdaIotPermissionLogicalId(functionName, iotIndex) {
219.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionIotTopicRule${
220.       iotIndex}`;
221.   },

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:25:54,723 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We already have the complete implementation of the IoT compile plugin (lib/plugins/aws/deploy/compile/events/iot/index.js with line numbers) and the related IoT docs (docs/providers/aws/events/iot.md). The error arises from JSON.parse failing due to unescaped newline characters injected via template literals, which is evident in the provided code (string-built JSON with raw values). No additional dependencies or helper functions are involved beyond naming, and tests are not essential to classify the issue. Therefore, the current context is sufficient to accurately classify this as a bug and propose fixes/workarounds.' query='' extra_requirements='' purpose='The available code and docs are enough to determine the root cause and classification without further files.'
2025-11-14 00:25:54,725 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/events/iot.md', content='1. <!--\n2. title: Serverless Framework - AWS Lambda Events - IoT\n3. menuText: IoT\n4. menuOrder: 7\n5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)\n11. <!-- DOCS-SITE-LINK:END -->\n12. \n13. # IoT\n14. \n15. ## Simple event definition\n16. \n17. This will enable your Lambda function to be called by an AWS IoT rule.\n18. \n19. ```yml\n20. functions:\n21.   myIoT:\n22.     handler: myIoT.handler\n23.     events:\n24.       - iot:\n25.           sql: "SELECT * FROM \'some_topic\'"\n26. ```\n27. \n28. ## Enabling / Disabling\n29. \n30. **Note:** `iot` events are enabled by default.\n31. \n32. This will create and attach a disabled `iot` event for the `myIoT` function.\n33. \n34. ```yml\n35. functions:\n36.   myIoT:\n37.     handler: myIoT.handler\n38.     events:\n39.       - iot:\n40.           sql: "SELECT * FROM \'some_topic\'"\n41.           enabled: false\n42. ```\n43. \n44. ## Specify Name and Description\n45. \n46. Name and Description can be specified with the help of the `name` and `description` properties.\n47. \n48. ```yml\n49. functions:\n50.   myIoT:\n51.     handler: myIoT.handler\n52.     events:\n53.       - iot:\n54.           name: "myIotEvent"\n55.           sql: "SELECT * FROM \'some_topic\'"\n56.           description: "My IoT Event Description"\n57. ```\n58. \n59. ## Specify SQL Versions\n60. \n61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.\n62. \n63. ```yml\n64. functions:\n65.   myIoT:\n66.     handler: myIoT.handler\n67.     events:\n68.       - iot:\n69.           sql: "SELECT * FROM \'some_topic\'"\n70.           sqlVersion: "beta"\n71. ```', start_line_number=1, end_line_number=71), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n47. \n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n96. \n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n107.           }\n108.         });\n109.       }\n110.     });\n111.   }\n112. }\n113. module.exports = AwsCompileIoTEvents;', start_line_number=1, end_line_number=113), Context(relative_path='lib/plugins/aws/lib/naming.js', content="100.   getNormalizedFunctionName(functionName) {\n101.     return this.normalizeName(functionName\n102.       .replace(/-/g, 'Dash')\n103.       .replace(/_/g, 'Underscore'));\n104.   },", start_line_number=100, end_line_number=104), Context(relative_path='lib/plugins/aws/lib/naming.js', content='115.   getLambdaLogicalId(functionName) {\n116.     return `${this.getNormalizedFunctionName(functionName)}LambdaFunction`;\n117.   },\n118.   getLambdaLogicalIdRegex() {', start_line_number=115, end_line_number=118), Context(relative_path='lib/plugins/aws/lib/naming.js', content='214.   // IoT\n215.   getIotLogicalId(functionName, iotIndex) {\n216.     return `${this.getNormalizedFunctionName(functionName)}IotTopicRule${iotIndex}`;\n217.   },\n218.   getLambdaIotPermissionLogicalId(functionName, iotIndex) {\n219.     return `${this.getNormalizedFunctionName(functionName)}LambdaPermissionIotTopicRule${\n220.       iotIndex}`;\n221.   },', start_line_number=214, end_line_number=221)]
2025-11-14 00:25:59,372 - thread-135845308794560.prometheus.lang_graph.nodes.issue_classifier_node - INFO - IssueClassifierNode classified the issue as: bug
2025-11-14 00:25:59,373 - thread-135845308794560.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - issue_type: bug
2025-11-14 00:25:59,375 - thread-135845308794560.prometheus.docker.base_container - INFO - Pulling docker image: ghcr.io/timesler/swe-polybench.eval.x86_64.serverless__serverless-3095:latest
2025-11-14 00:26:27,890 - thread-135845308794560.prometheus.docker.base_container - INFO - Tagging pulled image as: prometheus_user_defined_container_932d6fe3a8
2025-11-14 00:26:27,900 - thread-135845308794560.prometheus.docker.base_container - INFO - Starting container from image prometheus_user_defined_container_932d6fe3a8
2025-11-14 00:26:28,486 - thread-135845308794560.prometheus.docker.base_container - INFO - Starting persistent shell for interactive mode...
2025-11-14 00:26:28,818 - thread-135845308794560.prometheus.docker.base_container - INFO - Persistent shell is ready
2025-11-14 00:26:28,818 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - Enter IssueBugSubgraphNode
2025-11-14 00:26:28,820 - thread-135845308794560.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - INFO - Enter bug_get_regression_tests_subgraph_node
2025-11-14 00:26:28,821 - thread-135845308794560.prometheus.lang_graph.nodes.bug_get_regression_context_message_node - DEBUG - Sending query to context provider subgraph:
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

2025-11-14 00:26:28,822 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-14 00:26:28,823 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:26:43,852 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning="The request requires returning 8 complete, self-contained existing test cases with exact file paths and line numbers. While the repository tree is provided, the actual test file contents (and line numbers) are not available in the current context. The issue concerns AWS IoT event compilation and YAML multi-line (folded '>') handling, so tests likely reside in the AWS deploy compile plugin (events/iot), YAML parser, Service parsing, and AWS compile/index tests. Without the test file contents, it is impossible to extract exact test cases, imports, and line ranges." query='Please provide the full contents of the following files: lib/plugins/aws/deploy/compile/events/iot/index.js and any test files under that directory, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/plugins/aws/deploy/compile/index.test.js, and lib/plugins/aws/lib/naming.test.js.' extra_requirements="If some files do not exist or are empty, please share any tests that reference IoT events or YAML folded scalars ('>') and their full content with line numbers." purpose='I need the exact test definitions and line numbers to select 8 relevant existing test cases and include all necessary imports and assertions.'
2025-11-14 00:26:43,854 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full contents of the following files: lib/plugins/aws/deploy/compile/events/iot/index.js and any test files under that directory, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/plugins/aws/deploy/compile/index.test.js, and lib/plugins/aws/lib/naming.test.js.
2025-11-14 00:26:45,842 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-14 00:26:45,842 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-14 00:26:45,842 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-14 00:26:45,842 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-14 00:26:45,843 - thread-135845308794560.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-14 00:26:45,844 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-14 00:26:45,845 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full contents of the following files: lib/plugins/aws/deploy/compile/events/iot/index.js and any test files under that directory, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/plugins/aws/deploy/compile/index.test.js, and lib/plugins/aws/lib/naming.test.js.
Extra requirements: If some files do not exist or are empty, please share any tests that reference IoT events or YAML folded scalars ('>') and their full content with line numbers.
Purpose: I need the exact test definitions and line numbers to select 8 relevant existing test cases and include all necessary imports and assertions.
2025-11-14 00:27:07,759 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9JYkQNeWcwK8L967wvIU45TG', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1641, 'prompt_tokens': 2223, 'total_tokens': 3864, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1600, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--966316c4-2697-47b1-b02d-566c5fb33a14-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_9JYkQNeWcwK8L967wvIU45TG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2223, 'output_tokens': 1641, 'total_tokens': 3864, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1600}}
2025-11-14 00:27:11,887 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hh9zlrdVIUe1mfWhBZk0SpLL', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 297, 'prompt_tokens': 3488, 'total_tokens': 3785, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d3f9faa4-90d9-4a7d-a4fa-08ceaee981cd-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.test.js'}, 'id': 'call_hh9zlrdVIUe1mfWhBZk0SpLL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3488, 'output_tokens': 297, 'total_tokens': 3785, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-14 00:27:13,106 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_V9slpFkz4yWoQUjJ9mxMm5Ng', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 36, 'prompt_tokens': 3579, 'total_tokens': 3615, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3aebbc0e-ad3a-492f-ab2f-faf46555e109-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.test.js'}, 'id': 'call_V9slpFkz4yWoQUjJ9mxMm5Ng', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3579, 'output_tokens': 36, 'total_tokens': 3615, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:27:18,770 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OYkuZuBSeUFeGk3VeVJ6J8lg', 'function': {'arguments': '{"relative_path":"lib/classes/YamlParser.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 484, 'prompt_tokens': 6075, 'total_tokens': 6559, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--852c813d-17cf-434e-8be2-3fb607a88c0d-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/classes/YamlParser.test.js'}, 'id': 'call_OYkuZuBSeUFeGk3VeVJ6J8lg', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6075, 'output_tokens': 484, 'total_tokens': 6559, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-14 00:27:26,892 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_d7sYBGOLY4W7bGyvhxuQWagL', 'function': {'arguments': '{"relative_path":"lib/classes/Service.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 483, 'prompt_tokens': 7260, 'total_tokens': 7743, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b2dfe6cf-ed62-410c-aaa9-dc2683604a68-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/classes/Service.test.js'}, 'id': 'call_d7sYBGOLY4W7bGyvhxuQWagL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7260, 'output_tokens': 483, 'total_tokens': 7743, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-14 00:27:28,779 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gp6ZZg7VG8zLCabUhcs2lXjL', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 12859, 'total_tokens': 12892, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--958988d9-0d2b-4652-ab46-94fee7d81c1c-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/index.test.js'}, 'id': 'call_gp6ZZg7VG8zLCabUhcs2lXjL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12859, 'output_tokens': 33, 'total_tokens': 12892, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:27:38,366 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_avbPyY5MZaYNbh9wKfp4RJBw', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/lib/naming.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 869, 'prompt_tokens': 12923, 'total_tokens': 13792, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a456b28a-ebef-4aab-a04d-f233a5ba9625-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/lib/naming.test.js'}, 'id': 'call_avbPyY5MZaYNbh9wKfp4RJBw', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12923, 'output_tokens': 869, 'total_tokens': 13792, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-14 00:27:59,224 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content="I retrieved the full contents with line numbers for lib/plugins/aws/deploy/compile/events/iot/index.js, its test file lib/plugins/aws/deploy/compile/events/iot/index.test.js, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, and lib/plugins/aws/lib/naming.test.js. I confirmed that lib/plugins/aws/deploy/compile/index.test.js does not exist. To satisfy the extra requirement, I ensured IoT-related tests are included (both the IoT events tests and the naming tests referencing IoT logical IDs). I did not find any tests referencing YAML folded scalars ('>') in the requested scope." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1997, 'prompt_tokens': 18586, 'total_tokens': 20583, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1856, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--63e9752c-0227-4442-bf32-b108d4fab8cb-0' usage_metadata={'input_tokens': 18586, 'output_tokens': 1997, 'total_tokens': 20583, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1856}}
2025-11-14 00:27:59,230 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full contents of the following files: lib/plugins/aws/deploy/compile/events/iot/index.js and any test files under that directory, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/plugins/aws/deploy/compile/index.test.js, and lib/plugins/aws/lib/naming.test.js.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If some files do not exist or are empty, please share any tests that reference IoT events or YAML folded scalars ('>') and their full content with line numbers.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need the exact test definitions and line numbers to select 8 relevant existing test cases and include all necessary imports and assertions.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/classes/Service.test.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const YAML = require('js-yaml');
5. const expect = require('chai').expect;
6. const sinon = require('sinon');
7. const Service = require('../../lib/classes/Service');
8. const Utils = require('../../lib/classes/Utils');
9. const Serverless = require('../../lib/Serverless');
10. const testUtils = require('../../tests/utils');
11. 
12. describe('Service', () => {
13.   describe('#constructor()', () => {
14.     const serverless = new Serverless();
15. 
16.     it('should attach serverless instance', () => {
17.       const serviceInstance = new Service(serverless);
18.       expect(typeof serviceInstance.serverless.version).to.be.equal('string');
19.     });
20. 
21.     it('should construct with defaults', () => {
22.       const serviceInstance = new Service(serverless);
23. 
24.       expect(serviceInstance.service).to.be.equal(null);
25.       expect(serviceInstance.provider).to.deep.equal({});
26.       expect(serviceInstance.defaults).to.deep.equal({
27.         stage: 'dev',
28.         region: 'us-east-1',
29.         variableSyntax: '\\${([ :a-zA-Z0-9._,\\-\\/\\(\\)]+?)}',
30.       });
31.       expect(serviceInstance.custom).to.deep.equal({});
32.       expect(serviceInstance.plugins).to.deep.equal([]);
33.       expect(serviceInstance.functions).to.deep.equal({});
34.       expect(serviceInstance.resources).to.deep.equal({});
35.       expect(serviceInstance.package).to.deep.equal({});
36.     });
37. 
38.     it('should construct with data', () => {
39.       const data = {
40.         service: 'testService',
41.         provider: 'testProvider',
42.         custom: {
43.           customProp: 'value',
44.         },
45.         plugins: ['testPlugin'],
46.         functions: {
47.           functionA: {},
48.         },
49.         resources: {
50.           aws: {
51.             resourcesProp: 'value',
52.           },
53.           azure: {},
54.           google: {},
55.         },
56.         package: {
57.           exclude: ['exclude-me'],
58.           include: ['include-me'],
59.           artifact: 'some/path/foo.zip',
60.         },
61.       };
62. 
63.       const serviceInstance = new Service(serverless, data);
64. 
65.       expect(serviceInstance.service).to.be.equal('testService');
66.       expect(serviceInstance.provider).to.be.equal('testProvider');
67.       expect(serviceInstance.custom).to.deep.equal({ customProp: 'value' });
68.       expect(serviceInstance.plugins).to.deep.equal(['testPlugin']);
69.       expect(serviceInstance.functions).to.deep.equal({ functionA: {} });
70.       expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
71.       expect(serviceInstance.resources.azure).to.deep.equal({});
72.       expect(serviceInstance.resources.google).to.deep.equal({});
73.       expect(serviceInstance.package.exclude.length).to.equal(1);
74.       expect(serviceInstance.package.exclude[0]).to.equal('exclude-me');
75.       expect(serviceInstance.package.include.length).to.equal(1);
76.       expect(serviceInstance.package.include[0]).to.equal('include-me');
77.       expect(serviceInstance.package.artifact).to.equal('some/path/foo.zip');
78.     });
79. 
80.     it('should support string based provider config', () => {
81.       const data = {
82.         provider: 'testProvider',
83.       };
84. 
85.       const serviceInstance = new Service(serverless, data);
86. 
87.       expect(serviceInstance.provider).to.be.equal('testProvider');
88.     });
89. 
90.     it('should support object based provider config', () => {
91.       const data = {
92.         provider: {
93.           name: 'testProvider',
94.           runtime: 'nodejs4.3',
95.         },
96.       };
97. 
98.       const serviceInstance = new Service(serverless, data);
99. 
100.       expect(serviceInstance.provider.name).to.be.equal('testProvider');
101.       expect(serviceInstance.provider.runtime).to.be.equal('nodejs4.3');
102.     });
103.   });
104. 
105.   describe('#load()', () => {
106.     let serviceInstance;
107.     let tmpDirPath;
108. 
109.     beforeEach(() => {
110.       tmpDirPath = testUtils.getTmpDirPath();
111.     });
112. 
113.     it('should resolve if no servicePath is found', () => {
114.       const serverless = new Serverless();
115.       const noService = new Service(serverless);
116. 
117.       return noService.load();
118.     });
119. 
120.     it('should load from filesystem', () => {
121.       const SUtils = new Utils();
122.       const serverlessYml = {
123.         service: 'new-service',
124.         provider: 'aws',
125.         defaults: {
126.           stage: 'dev',
127.           region: 'us-east-1',
128.           variableSyntax: '\\${{([\\s\\S]+?)}}',
129.         },
130.         plugins: ['testPlugin'],
131.         functions: {
132.           functionA: {},
133.         },
134.         resources: {
135.           aws: {
136.             resourcesProp: 'value',
137.           },
138.           azure: {},
139.           google: {},
140.         },
141.         package: {
142.           exclude: ['exclude-me'],
143.           include: ['include-me'],
144.           artifact: 'some/path/foo.zip',
145.         },
146.       };
147. 
148.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
149.         YAML.dump(serverlessYml));
150. 
151.       const serverless = new Serverless();
152.       serverless.init();
153.       serverless.config.update({ servicePath: tmpDirPath });
154.       serviceInstance = new Service(serverless);
155. 
156.       return serviceInstance.load().then(() => {
157.         expect(serviceInstance.service).to.be.equal('new-service');
158.         expect(serviceInstance.provider.name).to.deep.equal('aws');
159.         expect(serviceInstance.defaults.variableSyntax).to.equal('\\${{([\\s\\S]+?)}}');
160.         expect(serviceInstance.plugins).to.deep.equal(['testPlugin']);
161.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
162.         expect(serviceInstance.resources.azure).to.deep.equal({});
163.         expect(serviceInstance.resources.google).to.deep.equal({});
164.         expect(serviceInstance.package.exclude.length).to.equal(1);
165.         expect(serviceInstance.package.exclude[0]).to.equal('exclude-me');
166.         expect(serviceInstance.package.include.length).to.equal(1);
167.         expect(serviceInstance.package.include[0]).to.equal('include-me');
168.         expect(serviceInstance.package.artifact).to.equal('some/path/foo.zip');
169.       });
170.     });
171. 
172.     it('should merge resources given as an array', () => {
173.       const SUtils = new Utils();
174.       const serverlessYml = {
175.         service: 'new-service',
176.         provider: 'aws',
177.         resources: [
178.           {
179.             aws: {
180.               resourcesProp: 'value',
181.             },
182.           },
183.           {
184.             azure: {},
185.           },
186.         ],
187.       };
188. 
189.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
190.         YAML.dump(serverlessYml));
191. 
192.       const serverless = new Serverless();
193.       serverless.init();
194.       serverless.config.update({ servicePath: tmpDirPath });
195.       serviceInstance = new Service(serverless);
196. 
197.       return serviceInstance.load().then(() => {
198.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
199.         expect(serviceInstance.resources.azure).to.deep.equal({});
200.       });
201.     });
202. 
203.     it('should make sure function name contains the default stage', () => {
204.       const SUtils = new Utils();
205.       const serverlessYml = {
206.         service: 'new-service',
207.         provider: 'aws',
208.         defaults: {
209.           stage: 'dev',
210.           region: 'us-east-1',
211.           variableSyntax: '\\${{([\\s\\S]+?)}}',
212.         },
213.         plugins: ['testPlugin'],
214.         functions: {
215.           functionA: {},
216.         },
217.         resources: {
218.           aws: {
219.             resourcesProp: 'value',
220.           },
221.           azure: {},
222.           google: {},
223.         },
224.         package: {
225.           exclude: ['exclude-me'],
226.           include: ['include-me'],
227.           artifact: 'some/path/foo.zip',
228.         },
229.       };
230. 
231.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
232.         YAML.dump(serverlessYml));
233. 
234.       const serverless = new Serverless();
235.       serverless.init();
236.       serverless.config.update({ servicePath: tmpDirPath });
237.       serviceInstance = new Service(serverless);
238. 
239.       return serviceInstance.load().then(() => {
240.         expect(serviceInstance.functions.functionA.name).to.be.equal('new-service-dev-functionA');
241.       });
242.     });
243. 
244.     it('should support Serverless file with a non-aws provider', () => {
245.       const SUtils = new Utils();
246.       const serverlessYaml = {
247.         service: 'my-service',
248.         provider: 'openwhisk',
249.         functions: {
250.           functionA: {
251.             name: 'customFunctionName',
252.           },
253.         },
254.       };
255. 
256.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yaml'),
257.         YAML.dump(serverlessYaml));
258. 
259.       const serverless = new Serverless({ servicePath: tmpDirPath });
260.       serviceInstance = new Service(serverless);
261. 
262.       return serviceInstance.load().then(() => {
263.         const expectedFunc = {
264.           functionA: {
265.             name: 'customFunctionName',
266.             events: [],
267.           },
268.         };
269.         expect(serviceInstance.service).to.be.equal('my-service');
270.         expect(serviceInstance.provider.name).to.deep.equal('openwhisk');
271.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
272.       });
273.     });
274. 
275.     it('should support Serverless file with a .yaml extension', () => {
276.       const SUtils = new Utils();
277.       const serverlessYaml = {
278.         service: 'my-service',
279.         provider: 'aws',
280.         functions: {
281.           functionA: {
282.             name: 'customFunctionName',
283.           },
284.         },
285.       };
286. 
287.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yaml'),
288.         YAML.dump(serverlessYaml));
289. 
290.       const serverless = new Serverless({ servicePath: tmpDirPath });
291.       serviceInstance = new Service(serverless);
292. 
293.       return serviceInstance.load().then(() => {
294.         const expectedFunc = {
295.           functionA: {
296.             name: 'customFunctionName',
297.             events: [],
298.           },
299.         };
300.         expect(serviceInstance.service).to.be.equal('my-service');
301.         expect(serviceInstance.provider.name).to.deep.equal('aws');
302.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
303.       });
304.     });
305. 
306.     it('should support Serverless file with a .yml extension', () => {
307.       const SUtils = new Utils();
308.       const serverlessYml = {
309.         service: 'my-service',
310.         provider: 'aws',
311.         functions: {
312.           functionA: {},
313.         },
314.       };
315. 
316.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
317.         YAML.dump(serverlessYml));
318. 
319.       const serverless = new Serverless({ servicePath: tmpDirPath });
320.       serviceInstance = new Service(serverless);
321. 
322.       return serviceInstance.load({ stage: 'dev' }).then(() => {
323.         const expectedFunc = {
324.           functionA: {
325.             name: 'my-service-dev-functionA',
326.             events: [],
327.           },
328.         };
329.         expect(serviceInstance.service).to.be.equal('my-service');
330.         expect(serviceInstance.provider.name).to.deep.equal('aws');
331.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
332.       });
333.     });
334. 
335.     it('should throw error if service property is missing', () => {
336.       const SUtils = new Utils();
337.       const serverlessYml = {
338.         provider: 'aws',
339.         functions: {},
340.       };
341.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
342.         YAML.dump(serverlessYml));
343. 
344.       const serverless = new Serverless({ servicePath: tmpDirPath });
345.       serviceInstance = new Service(serverless);
346. 
347.       return serviceInstance.load().then(() => {
348.         // if we reach this, then no error was thrown as expected
349.         // so make assertion fail intentionally to let us know something is wrong
350.         expect(1).to.equal(2);
351.       }).catch(e => {
352.         expect(e.name).to.be.equal('ServerlessError');
353.       });
354.     });
355. 
356.     it('should throw error if provider property is missing', () => {
357.       const SUtils = new Utils();
358.       const serverlessYml = {
359.         service: 'service-name',
360.         functions: {},
361.       };
362.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
363.         YAML.dump(serverlessYml));
364. 
365.       const serverless = new Serverless({ servicePath: tmpDirPath });
366.       serviceInstance = new Service(serverless);
367. 
368.       return serviceInstance.load().then(() => {
369.         // if we reach this, then no error was thrown as expected
370.         // so make assertion fail intentionally to let us know something is wrong
371.         expect(1).to.equal(2);
372.       }).catch(e => {
373.         expect(e.name).to.be.equal('ServerlessError');
374.       });
375.     });
376. 
377.     it('should throw error if frameworkVersion is not satisfied', () => {
378.       const SUtils = new Utils();
379.       const serverlessYml = {
380.         service: 'service-name',
381.         frameworkVersion: '=1.0.0',
382.         provider: 'aws',
383.         functions: {},
384.       };
385.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
386.         YAML.dump(serverlessYml));
387. 
388.       const serverless = new Serverless({ servicePath: tmpDirPath });
389.       const getVersion = sinon.stub(serverless.utils, 'getVersion');
390.       getVersion.returns('1.0.2');
391.       serviceInstance = new Service(serverless);
392. 
393.       return serviceInstance.load().then(() => {
394.         // if we reach this, then no error was thrown as expected
395.         // so make assertion fail intentionally to let us know something is wrong
396.         expect(1).to.equal(2);
397.       }).catch(e => {
398.         expect(e.name).to.be.equal('ServerlessError');
399.       });
400.     });
401. 
402.     it('should pass if frameworkVersion is satisfied', () => {
403.       const SUtils = new Utils();
404.       const serverlessYml = {
405.         service: 'service-name',
406.         frameworkVersion: '>=1.0.0',
407.         provider: 'aws',
408.         functions: {},
409.       };
410.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
411.         YAML.dump(serverlessYml));
412. 
413.       const serverless = new Serverless({ servicePath: tmpDirPath });
414.       const getVersion = sinon.stub(serverless.utils, 'getVersion');
415.       getVersion.returns('1.2.2');
416.       serviceInstance = new Service(serverless);
417. 
418.       return serviceInstance.load().then(() => {
419.         // if this callbar is reached, then no error was thrown as expected
420.         expect(1).to.equal(1);
421.       });
422.     });
423. 
424.     it('should not throw error if functions property is missing', () => {
425.       const SUtils = new Utils();
426.       const serverlessYml = {
427.         service: 'service-name',
428.         provider: 'aws',
429.       };
430.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
431.         YAML.dump(serverlessYml));
432. 
433.       const serverless = new Serverless({ servicePath: tmpDirPath });
434.       serviceInstance = new Service(serverless);
435. 
436.       return serviceInstance.load().then(() => {
437.         expect(serverless.service.functions).to.deep.equal({});
438.       });
439.     });
440. 
441.     it("should throw error if a function's event is not an array", () => {
442.       const SUtils = new Utils();
443.       const serverlessYml = {
444.         service: 'service-name',
445.         provider: 'aws',
446.         functions: {
447.           functionA: {
448.             events: {},
449.           },
450.         },
451.       };
452.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
453.         YAML.dump(serverlessYml));
454. 
455.       const serverless = new Serverless({ servicePath: tmpDirPath });
456.       serviceInstance = new Service(serverless);
457. 
458.       return serviceInstance.load().then(() => {
459.         // if we reach this, then no error was thrown as expected
460.         // so make assertion fail intentionally to let us know something is wrong
461.         expect(1).to.equal(2);
462.       }).catch(e => {
463.         expect(e.name).to.be.equal('ServerlessError');
464.       });
465.     });
466. 
467.     it('should throw error if provider property is invalid', () => {
468.       const SUtils = new Utils();
469.       const serverlessYml = {
470.         service: 'service-name',
471.         provider: 'invalid',
472.         functions: {},
473.       };
474. 
475.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
476.         YAML.dump(serverlessYml));
477. 
478.       const serverless = new Serverless({ servicePath: tmpDirPath });
479.       serviceInstance = new Service(serverless);
480. 
481.       return serviceInstance.load().then(() => {
482.         // if we reach this, then no error was thrown as expected
483.         // so make assertion fail intentionally to let us know something is wrong
484.         expect(1).to.equal(2);
485.       }).catch(e => {
486.         expect(e.name).to.be.equal('ServerlessError');
487.       });
488.     });
489.   });
490. 
491.   describe('#update()', () => {
492.     it('should update service instance data', () => {
493.       const serverless = new Serverless();
494.       const serviceInstance = new Service(serverless);
495.       const newData = { service: 'newName' };
496.       const updatedInstance = serviceInstance.update(newData);
497.       expect(updatedInstance.service).to.be.equal('newName');
498.     });
499.   });
500.


File: lib/classes/YamlParser.test.js
Line number range: 1 - 99
Content:
1. 'use strict';
2. 
3. /**
4.  * Test: YamlParser Function Class
5.  */
6. 
7. const expect = require('chai').expect;
8. const YAML = require('js-yaml');
9. const path = require('path');
10. const Serverless = require('../../lib/Serverless');
11. const testUtils = require('../../tests/utils');
12. 
13. const serverless = new Serverless();
14. 
15. describe('YamlParser', () => {
16.   describe('#parse()', () => {
17.     it('should parse a simple .yaml file', () => {
18.       const tmpFilePath = testUtils.getTmpFilePath('simple.yaml');
19. 
20.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));
21. 
22.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {
23.         expect(obj.foo).to.equal('bar');
24.       });
25.     });
26. 
27.     it('should parse a simple .yml file', () => {
28.       const tmpFilePath = testUtils.getTmpFilePath('simple.yml');
29. 
30.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));
31. 
32.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {
33.         expect(obj.foo).to.equal('bar');
34.       });
35.     });
36. 
37.     it('should parse a .yml file with JSON-REF to YAML', () => {
38.       const tmpDirPath = testUtils.getTmpDirPath();
39. 
40.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.yml'), { foo: 'bar' });
41. 
42.       const testYml = {
43.         main: {
44.           $ref: './ref.yml',
45.         },
46.       };
47. 
48.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);
49. 
50.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {
51.         expect(obj.main.foo).to.equal('bar');
52.       });
53.     });
54. 
55.     it('should parse a .yml file with JSON-REF to JSON', () => {
56.       const tmpDirPath = testUtils.getTmpDirPath();
57. 
58.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.json'), { foo: 'bar' });
59. 
60.       const testYml = {
61.         main: {
62.           $ref: './ref.json',
63.         },
64.       };
65. 
66.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);
67. 
68.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {
69.         expect(obj.main.foo).to.equal('bar');
70.       });
71.     });
72. 
73.     it('should parse a .yml file with recursive JSON-REF', () => {
74.       const tmpDirPath = testUtils.getTmpDirPath();
75. 
76.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'three.yml'), { foo: 'bar' });
77. 
78.       const twoYml = {
79.         two: {
80.           $ref: './three.yml',
81.         },
82.       };
83. 
84.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'two.yml'), twoYml);
85. 
86.       const oneYml = {
87.         one: {
88.           $ref: './two.yml',
89.         },
90.       };
91. 
92.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'one.yml'), oneYml);
93. 
94.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'one.yml')).then((obj) => {
95.         expect(obj.one.two.foo).to.equal('bar');
96.       });
97.     });
98.   });
99. });


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }
14. 
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }
47. 
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;
96. 
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);
107.           }
108.         });
109.       }
110.     });
111.   }
112. }
113. module.exports = AwsCompileIoTEvents;


File: lib/plugins/aws/deploy/compile/events/iot/index.test.js
Line number range: 1 - 229
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileIoTEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileIoTEvents', () => {
9.   let serverless;
10.   let awsCompileIoTEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
15.     serverless.setProvider('aws', new AwsProvider(serverless));
16.     awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
17.     awsCompileIoTEvents.serverless.service.service = 'new-service';
18.   });
19. 
20.   describe('#constructor()', () => {
21.     it('should set the provider variable to an instance of AwsProvider', () =>
22.       expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));
23.   });
24. 
25.   describe('#awsCompileIoTEvents()', () => {
26.     it('should throw an error if iot event type is not an object', () => {
27.       awsCompileIoTEvents.serverless.service.functions = {
28.         first: {
29.           events: [
30.             {
31.               iot: 'iot',
32.             },
33.           ],
34.         },
35.       };
36. 
37.       expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);
38.     });
39. 
40.     it('should create corresponding resources when iot events are given', () => {
41.       awsCompileIoTEvents.serverless.service.functions = {
42.         first: {
43.           events: [
44.             {
45.               iot: {
46.                 sql: "SELECT * FROM 'topic_1'",
47.               },
48.             },
49.             {
50.               iot: {
51.                 sql: "SELECT * FROM 'topic_2'",
52.               },
53.             },
54.           ],
55.         },
56.       };
57. 
58.       awsCompileIoTEvents.compileIoTEvents();
59. 
60.       expect(awsCompileIoTEvents.serverless.service
61.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type
62.       ).to.equal('AWS::IoT::TopicRule');
63.       expect(awsCompileIoTEvents.serverless.service
64.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type
65.       ).to.equal('AWS::IoT::TopicRule');
66.       expect(awsCompileIoTEvents.serverless.service
67.         .provider.compiledCloudFormationTemplate.Resources
68.         .FirstIotTopicRule1.Properties.TopicRulePayload.Sql
69.       ).to.equal('SELECT * FROM \'topic_1\'');
70.       expect(awsCompileIoTEvents.serverless.service
71.         .provider.compiledCloudFormationTemplate.Resources
72.         .FirstIotTopicRule2.Properties.TopicRulePayload.Sql
73.       ).to.equal('SELECT * FROM \'topic_2\'');
74.       expect(awsCompileIoTEvents.serverless.service
75.         .provider.compiledCloudFormationTemplate.Resources
76.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
77.       ).to.equal('false');
78.       expect(awsCompileIoTEvents.serverless.service
79.         .provider.compiledCloudFormationTemplate.Resources
80.         .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled
81.       ).to.equal('false');
82.       expect(awsCompileIoTEvents.serverless.service
83.         .provider.compiledCloudFormationTemplate.Resources
84.         .FirstLambdaPermissionIotTopicRule1.Type
85.       ).to.equal('AWS::Lambda::Permission');
86.       expect(awsCompileIoTEvents.serverless.service
87.         .provider.compiledCloudFormationTemplate.Resources
88.         .FirstLambdaPermissionIotTopicRule2.Type
89.       ).to.equal('AWS::Lambda::Permission');
90.     });
91. 
92.     it('should respect "name" variable', () => {
93.       awsCompileIoTEvents.serverless.service.functions = {
94.         first: {
95.           events: [
96.             {
97.               iot: {
98.                 name: 'iotEvantName',
99.                 sql: "SELECT * FROM 'topic_1'",
100.               },
101.             },
102.           ],
103.         },
104.       };
105. 
106.       awsCompileIoTEvents.compileIoTEvents();
107. 
108.       expect(awsCompileIoTEvents.serverless.service
109.         .provider.compiledCloudFormationTemplate.Resources
110.         .FirstIotTopicRule1.Properties.RuleName
111.       ).to.equal('iotEvantName');
112.     });
113. 
114.     it('should respect "enabled" variable', () => {
115.       awsCompileIoTEvents.serverless.service.functions = {
116.         first: {
117.           events: [
118.             {
119.               iot: {
120.                 enabled: false,
121.                 sql: "SELECT * FROM 'topic_1'",
122.               },
123.             },
124.           ],
125.         },
126.         second: {
127.           events: [
128.             {
129.               iot: {
130.                 enabled: true,
131.                 sql: "SELECT * FROM 'topic_1'",
132.               },
133.             },
134.           ],
135.         },
136.       };
137. 
138.       awsCompileIoTEvents.compileIoTEvents();
139. 
140.       expect(awsCompileIoTEvents.serverless.service
141.         .provider.compiledCloudFormationTemplate.Resources
142.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
143.       ).to.equal('true');
144.       expect(awsCompileIoTEvents.serverless.service
145.         .provider.compiledCloudFormationTemplate.Resources
146.         .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
147.       ).to.equal('false');
148.     });
149. 
150.     it('should respect "sqlVersion" variable', () => {
151.       awsCompileIoTEvents.serverless.service.functions = {
152.         first: {
153.           events: [
154.             {
155.               iot: {
156.                 sqlVersion: '2016-03-23',
157.                 sql: "SELECT * FROM 'topic_1'",
158.               },
159.             },
160.           ],
161.         },
162.       };
163. 
164.       awsCompileIoTEvents.compileIoTEvents();
165. 
166.       expect(awsCompileIoTEvents.serverless.service
167.         .provider.compiledCloudFormationTemplate.Resources
168.         .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion
169.       ).to.equal('2016-03-23');
170.     });
171. 
172.     it('should respect "description" variable', () => {
173.       awsCompileIoTEvents.serverless.service.functions = {
174.         first: {
175.           events: [
176.             {
177.               iot: {
178.                 description: 'iot event description',
179.                 sql: "SELECT * FROM 'topic_1'",
180.               },
181.             },
182.           ],
183.         },
184.       };
185. 
186.       awsCompileIoTEvents.compileIoTEvents();
187. 
188.       expect(awsCompileIoTEvents.serverless.service
189.         .provider.compiledCloudFormationTemplate.Resources
190.         .FirstIotTopicRule1.Properties.TopicRulePayload.Description
191.       ).to.equal('iot event description');
192.     });
193. 
194.     it('should respect enabled variable if the "enabled" property is not given', () => {
195.       awsCompileIoTEvents.serverless.service.functions = {
196.         first: {
197.           events: [
198.             {
199.               iot: {
200.                 sql: "SELECT * FROM 'topic_1'",
201.               },
202.             },
203.           ],
204.         },
205.       };
206. 
207.       awsCompileIoTEvents.compileIoTEvents();
208. 
209.       expect(awsCompileIoTEvents.serverless.service
210.         .provider.compiledCloudFormationTemplate.Resources
211.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
212.       ).to.equal('false');
213.     });
214. 
215.     it('should not create corresponding resources when iot events are not given', () => {
216.       awsCompileIoTEvents.serverless.service.functions = {
217.         first: {
218.           events: [],
219.         },
220.       };
221. 
222.       awsCompileIoTEvents.compileIoTEvents();
223. 
224.       expect(awsCompileIoTEvents.serverless.service
225.         .provider.compiledCloudFormationTemplate.Resources
226.       ).to.deep.equal({});
227.     });
228.   });
229. });


File: lib/plugins/aws/lib/naming.test.js
Line number range: 1 - 455
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. 
5. const SDK = require('../provider/awsProvider');
6. const Serverless = require('../../../Serverless');
7. 
8. describe('#naming()', () => {
9.   let options;
10.   let serverless;
11.   let sdk;
12. 
13.   beforeEach(() => {
14.     options = {
15.       stage: 'dev',
16.       region: 'us-east-1',
17.     };
18.     serverless = new Serverless(options);
19.     sdk = new SDK(serverless, options);
20.   });
21. 
22.   describe('#normalizeName()', () => {
23.     it('should capitalize the first letter', () => {
24.       expect(sdk.naming.normalizeName('name')).to.equal('Name');
25.     });
26. 
27.     it('should have no effect on caps', () => {
28.       expect(sdk.naming.normalizeName('Name')).to.equal('Name');
29.     });
30. 
31.     it('should have no effect on the rest of the name', () => {
32.       expect(sdk.naming.normalizeName('nAME')).to.equal('NAME');
33.     });
34.   });
35. 
36.   describe('#normalizeNameToAlphaNumericOnly()', () => {
37.     it('should strip non-alpha-numeric characters', () => {
38.       expect(sdk.naming
39.         .normalizeNameToAlphaNumericOnly('`!@#$%^&*()-={}|[]\\:";\'<>?,./')).to.equal('');
40.     });
41. 
42.     it('should apply normalizeName to the remaining characters', () => {
43.       expect(sdk.naming.normalizeNameToAlphaNumericOnly('a-b-c')).to.equal('Abc');
44.     });
45.   });
46. 
47.   describe('#normalizePathPart()', () => {
48.     it('converts `-` to `Dash`', () => {
49.       expect(sdk.naming.normalizePathPart(
50.         'a-path'
51.       )).to.equal('ADashpath');
52.     });
53. 
54.     it('converts variable declarations (`${var}`) to `VariableVar`', () => {
55.       expect(sdk.naming.normalizePathPart(
56.         '${variable}'
57.       )).to.equal('VariableVar');
58.     });
59. 
60.     it('converts variable declarations prefixes to `VariableVarpath`', () => {
61.       expect(sdk.naming.normalizePathPart(
62.         '${variable}Path'
63.       )).to.equal('VariableVarpath');
64.     });
65. 
66.     it('converts variable declarations suffixes to `PathvariableVar`', () => {
67.       expect(sdk.naming.normalizePathPart(
68.         'path${variable}'
69.       )).to.equal('PathvariableVar');
70.     });
71. 
72.     it('converts variable declarations in center to `PathvariableVardir`', () => {
73.       expect(sdk.naming.normalizePathPart(
74.         'path${variable}Dir'
75.       )).to.equal('PathvariableVardir');
76.     });
77.   });
78. 
79.   describe('#getServiceEndpointRegex()', () => {
80.     it('should match the prefix', () => {
81.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpoint'))
82.         .to.equal(true);
83.     });
84. 
85.     it('should not match a name without the prefix', () => {
86.       expect(sdk.naming.getServiceEndpointRegex()
87.         .test('NotThePrefixServiceEndpoint')).to.equal(false);
88.     });
89. 
90.     it('should match a name with the prefix', () => {
91.       expect(sdk.naming.getServiceEndpointRegex()
92.         .test('ServiceEndpointForAService')).to.equal(true);
93.     });
94.   });
95. 
96.   describe('#getStackName()', () => {
97.     it('should use the service name and stage from the service and config', () => {
98.       serverless.service.service = 'myService';
99.       expect(sdk.naming.getStackName()).to.equal(`${serverless.service.service}-${options.stage}`);
100.     });
101.   });
102. 
103.   describe('#getRolePath()', () => {
104.     it('should return `/`', () => {
105.       expect(sdk.naming.getRolePath()).to.equal('/');
106.     });
107.   });
108. 
109.   describe('#getRoleName()', () => {
110.     it('uses the service name, stage, and region to generate a role name', () => {
111.       serverless.service.service = 'myService';
112.       expect(sdk.naming.getRoleName()).to.eql({
113.         'Fn::Join': [
114.           '-',
115.           [
116.             serverless.service.service,
117.             options.stage,
118.             options.region,
119.             'lambdaRole',
120.           ],
121.         ],
122.       });
123.     });
124.   });
125. 
126.   describe('#getRoleLogicalId()', () => {
127.     it('should return the expected role name (IamRoleLambdaExecution)', () => {
128.       expect(sdk.naming.getRoleLogicalId()).to.equal('IamRoleLambdaExecution');
129.     });
130.   });
131. 
132.   describe('#getPolicyName()', () => {
133.     it('should use the stage and service name', () => {
134.       serverless.service.service = 'myService';
135.       expect(sdk.naming.getPolicyName()).to.eql({
136.         'Fn::Join': [
137.           '-',
138.           [
139.             options.stage,
140.             serverless.service.service,
141.             'lambda',
142.           ],
143.         ],
144.       });
145.     });
146.   });
147. 
148.   describe('#getPolicyLogicalId()', () => {
149.     it('should return the expected policy name (IamPolicyLambdaExecution)', () => {
150.       expect(sdk.naming.getPolicyLogicalId()).to.equal('IamPolicyLambdaExecution');
151.     });
152.   });
153. 
154.   describe('#getLogicalLogGroupName()', () => {
155.     it('should prefix the normalized function name to "LogGroup"', () => {
156.       expect(sdk.naming.getLogGroupLogicalId('functionName')).to.equal('FunctionNameLogGroup');
157.     });
158.   });
159. 
160.   describe('#getLogGroupName()', () => {
161.     it('should add the function name to the log group name', () => {
162.       expect(sdk.naming.getLogGroupName('functionName')).to.equal('/aws/lambda/functionName');
163.     });
164.   });
165. 
166.   describe('#getNormalizedFunctionName()', () => {
167.     it('should normalize the given functionName', () => {
168.       expect(sdk.naming.getNormalizedFunctionName('functionName'))
169.         .to.equal('FunctionName');
170.     });
171. 
172.     it('should normalize the given functionName with an underscore', () => {
173.       expect(sdk.naming.getNormalizedFunctionName('hello_world'))
174.         .to.equal('HelloUnderscoreworld');
175.     });
176. 
177.     it('should normalize the given functionName with a dash', () => {
178.       expect(sdk.naming.getNormalizedFunctionName('hello-world'))
179.         .to.equal('HelloDashworld');
180.     });
181.   });
182. 
183.   describe('#extractAuthorizerNameFromArn()', () => {
184.     it('should extract everything after the last colon and dash', () => {
185.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
186.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
187.     });
188.   });
189. 
190.   describe('#extractLambdaNameFromArn()', () => {
191.     it('should extract everything after the last colon', () => {
192.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
193.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal('my-dev-lambda');
194.     });
195.   });
196. 
197.   describe('#getLambdaLogicalId()', () => {
198.     it('should normalize the function name and add the logical suffix', () => {
199.       expect(sdk.naming.getLambdaLogicalId('functionName'))
200.         .to.equal('FunctionNameLambdaFunction');
201.     });
202.   });
203. 
204.   describe('#getLambdaLogicalIdRegex()', () => {
205.     it('should match the suffix', () => {
206.       expect(sdk.naming.getLambdaLogicalIdRegex()
207.         .test('LambdaFunction')).to.equal(true);
208.     });
209. 
210.     it('should not match a name without the suffix', () => {
211.       expect(sdk.naming.getLambdaLogicalIdRegex()
212.         .test('LambdaFunctionNotTheSuffix')).to.equal(false);
213.     });
214. 
215.     it('should match a name with the suffix', () => {
216.       expect(sdk.naming.getLambdaLogicalIdRegex()
217.         .test('AFunctionNameLambdaFunction')).to.equal(true);
218.     });
219.   });
220. 
221.   describe('#getLambdaOutputLogicalId()', () => {
222.     it('should normalize the function name and add the logical arn suffix', () => {
223.       expect(
224.         sdk.naming.getLambdaOutputLogicalId('functionName')
225.       ).to.equal('FunctionNameLambdaFunctionArn');
226.     });
227.   });
228. 
229.   describe('#getLambdaOutputLogicalIdRegex()', () => {
230.     it('should match the suffix', () => {
231.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
232.         .test('aLambdaFunctionArn')).to.equal(true);
233.     });
234. 
235.     it('should not match a name without the suffix', () => {
236.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
237.         .test('LambdaFunctionArnNotTheSuffix'))
238.         .to.equal(false);
239.     });
240. 
241.     it('should match a name with the suffix', () => {
242.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
243.         .test('AFunctionArnNameLambdaFunctionArn'))
244.         .to.equal(true);
245.     });
246.   });
247. 
248.   describe('#getApiGatewayName()', () => {
249.     it('should return the composition of stage and service name', () => {
250.       serverless.service.service = 'myService';
251.       expect(sdk.naming.getApiGatewayName())
252.         .to.equal(`${options.stage}-${serverless.service.service}`);
253.     });
254.   });
255. 
256.   describe('#generateApiGatewayDeploymentLogicalId()', () => {
257.     it('should return ApiGatewayDeployment with a date based suffix', () => {
258.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId()
259.         .match(/ApiGatewayDeployment(.*)/).length)
260.         .to.be.greaterThan(1);
261.     });
262.   });
263. 
264.   describe('#getRestApiLogicalId()', () => {
265.     it('should return ApiGatewayRestApi', () => {
266.       expect(sdk.naming.getRestApiLogicalId()).to.equal('ApiGatewayRestApi');
267.     });
268.   });
269. 
270.   describe('#getNormalizedAuthorizerName()', () => {
271.     it('normalize the authorizer name', () => {
272.       expect(sdk.naming.getNormalizedAuthorizerName('authorizerName'))
273.         .to.equal('AuthorizerName');
274.     });
275.   });
276. 
277.   describe('#getAuthorizerLogicalId()', () => {
278.     it('should normalize the authorizer name and add the standard suffix', () => {
279.       expect(sdk.naming.getAuthorizerLogicalId('authorizerName'))
280.         .to.equal('AuthorizerNameApiGatewayAuthorizer');
281.     });
282.   });
283. 
284.   describe('#extractAuthorizerNameFromArn()', () => {
285.     it('should extract the authorizer name from an ARN', () => {
286.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
287.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
288.     });
289.   });
290. 
291.   describe('#normalizePath()', () => {
292.     it('should normalize each part of the resource path and remove non-alpha-numeric characters',
293.       () => {
294.         expect(sdk.naming.normalizePath(
295.           'my/path/to/a-${var}-resource'
296.         )).to.equal('MyPathToADashvarVarDashresource');
297.       });
298.   });
299. 
300.   describe('#getResourceLogicalId()', () => {
301.     it('should normalize the resource and add the standard suffix', () => {
302.       expect(sdk.naming.getResourceLogicalId(
303.         'my/path/to/a-${var}-resource'
304.       )).to.equal('ApiGatewayResourceMyPathToADashvarVarDashresource');
305.     });
306.   });
307. 
308.   describe('#extractResourceId()', () => {
309.     it('should extract the normalized resource name', () => {
310.       expect(sdk.naming.extractResourceId(
311.         'ApiGatewayResourceMyPathToADashvarVarDashResource'
312.       )).to.equal('MyPathToADashvarVarDashResource');
313.     });
314.   });
315. 
316.   describe('#normalizeMethodName()', () => {
317.     it('should capitalize the first letter and lowercase any other characters', () => {
318.       expect(sdk.naming.normalizeMethodName('gET')).to.equal('Get');
319.     });
320.   });
321. 
322.   describe('#getMethodLogicalId()', () => {
323.     it('', () => {
324.       expect(sdk.naming.getMethodLogicalId(
325.         'ResourceId', 'get'
326.       )).to.equal('ApiGatewayMethodResourceIdGet');
327.     });
328.   });
329. 
330.   describe('#getApiKeyLogicalId(keyIndex)', () => {
331.     it('should produce the given index with ApiGatewayApiKey as a prefix', () => {
332.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal('ApiGatewayApiKey1');
333.     });
334.   });
335. 
336.   describe('#getApiKeyLogicalIdRegex()', () => {
337.     it('should match the prefix', () => {
338.       expect(sdk.naming.getApiKeyLogicalIdRegex()
339.         .test('ApiGatewayApiKey')).to.equal(true);
340.     });
341. 
342.     it('should not match a name without the prefix', () => {
343.       expect(sdk.naming.getApiKeyLogicalIdRegex()
344.         .test('NotThePrefixApiGatewayApiKey')).to.equal(false);
345.     });
346. 
347.     it('should match a name with the prefix', () => {
348.       expect(sdk.naming.getApiKeyLogicalIdRegex()
349.         .test('ApiGatewayApiKeySuffix')).to.equal(true);
350.     });
351.   });
352. 
353.   describe('#getDeploymentBucketLogicalId()', () => {
354.     it('should return "ServerlessDeploymentBucket"', () => {
355.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal('ServerlessDeploymentBucket');
356.     });
357.   });
358. 
359.   describe('#getDeploymentBucketOutputLogicalId()', () => {
360.     it('should return "ServerlessDeploymentBucketName"', () => {
361.       expect(sdk.naming.getDeploymentBucketOutputLogicalId())
362.         .to.equal('ServerlessDeploymentBucketName');
363.     });
364.   });
365. 
366.   describe('#normalizeBucketName()', () => {
367.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
368.       expect(sdk.naming.normalizeBucketName('b!u@c#k$e%t^N&a*m(e')).to.equal('BucketName');
369.     });
370.   });
371. 
372.   describe('#getBucketLogicalId()', () => {
373.     it('should normalize the bucket name and add the standard prefix', () => {
374.       expect(sdk.naming.getBucketLogicalId('b!u@c#k$e%t^N&a*m(e')).to.equal('S3BucketBucketName');
375.     });
376.   });
377. 
378.   describe('#normalizeTopicName()', () => {
379.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
380.       expect(sdk.naming.normalizeTopicName('t!o@p#i$c%N^a&m*e')).to.equal('TopicName');
381.     });
382.   });
383. 
384.   describe('#getTopicLogicalId()', () => {
385.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
386.       expect(sdk.naming.getTopicLogicalId('t!o@p#i$c%N^a&m*e')).to.equal('SNSTopicTopicName');
387.     });
388.   });
389. 
390.   describe('#getScheduleId()', () => {
391.     it('should add the standard suffix', () => {
392.       expect(sdk.naming.getScheduleId('functionName')).to.equal('functionNameSchedule');
393.     });
394.   });
395. 
396.   describe('#getScheduleLogicalId()', () => {
397.     it('should normalize the function name and add the standard suffix including the index', () => {
398.       expect(sdk.naming.getScheduleLogicalId('functionName', 0))
399.         .to.equal('FunctionNameEventsRuleSchedule0');
400.     });
401.   });
402. 
403.   describe('#getLambdaS3PermissionLogicalId()', () => {
404.     it('should normalize the function name and add the standard suffix', () => {
405.       expect(sdk.naming.getLambdaS3PermissionLogicalId('functionName', 'bucket'))
406.         .to.equal('FunctionNameLambdaPermissionBucketS3');
407.     });
408.   });
409. 
410.   describe('#getLambdaSnsPermissionLogicalId()', () => {
411.     it('should normalize the function and topic names and add them as prefix and suffix to the ' +
412.       'standard permission center', () => {
413.       expect(sdk.naming.getLambdaSnsPermissionLogicalId('functionName', 'topic'))
414.         .to.equal('FunctionNameLambdaPermissionTopicSNS');
415.     });
416.   });
417. 
418.   describe('#getLambdaSchedulePermissionLogicalId()', () => {
419.     it('should normalize the function name and add the standard suffix including event index',
420.       () => {
421.         expect(sdk.naming.getLambdaSchedulePermissionLogicalId('functionName', 0))
422.           .to.equal('FunctionNameLambdaPermissionEventsRuleSchedule0');
423.       });
424.   });
425. 
426.   describe('#getLambdaApiGatewayPermissionLogicalId()', () => {
427.     it('should normalize the function name and append the standard suffix', () => {
428.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId('functionName'))
429.         .to.equal('FunctionNameLambdaPermissionApiGateway');
430.     });
431.   });
432. 
433.   describe('#getIotLogicalId()', () => {
434.     it('should normalize the function name and add the standard suffix including the index', () => {
435.       expect(sdk.naming.getIotLogicalId('functionName', 0))
436.         .to.equal('FunctionNameIotTopicRule0');
437.     });
438.   });
439. 
440.   describe('#getLambdaIotPermissionLogicalId()', () => {
441.     it('should normalize the function name and add the standard suffix including event index',
442.       () => {
443.         expect(sdk.naming.getLambdaIotPermissionLogicalId('functionName', 0))
444.           .to.equal('FunctionNameLambdaPermissionIotTopicRule0');
445.       });
446.   });
447. 
448.   describe('#getLambdaAlexaSkillPermissionLogicalId()', () => {
449.     it('should normalize the function name and append the standard suffix',
450.       () => {
451.         expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName'))
452.           .to.equal('FunctionNameLambdaPermissionAlexaSkill');
453.       });
454.   });
455. });

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-14 00:28:16,437 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requirement analysis: The user requests the full contents of lib/plugins/aws/deploy/compile/events/iot/index.js. 2. Extended relevance: This file implements compilation of AWS IoT events into CloudFormation resources, which is directly relevant and necessary for understanding IoT event handling and naming dependencies used in tests.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=1, end_line=113), ContextOutput(reasoning='1. Query requirement analysis: The user requests any test files under lib/plugins/aws/deploy/compile/events/iot. This test file directly validates IoT event compilation behavior. 2. Extended relevance: It contains specific IoT event tests and assertions needed to select relevant cases, including references to naming and CloudFormation outputs.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.test.js', start_line=1, end_line=229), ContextOutput(reasoning="1. Query requirement analysis: The user requests the full contents of lib/classes/YamlParser.test.js. 2. Extended relevance: This test suite covers YAML parsing functionality, essential for selecting tests related to YAML processing (though it does not include folded scalar '>' cases, it is still the requested file).", relative_path='lib/classes/YamlParser.test.js', start_line=1, end_line=99), ContextOutput(reasoning='1. Query requirement analysis: The user requests the full contents of lib/classes/Service.test.js. 2. Extended relevance: It covers service loading, YAML reading, defaults, and event validation; necessary for understanding how functions and events are processed and for selecting relevant tests.', relative_path='lib/classes/Service.test.js', start_line=1, end_line=500), ContextOutput(reasoning='1. Query requirement analysis: The user requests the full contents of lib/plugins/aws/lib/naming.test.js. 2. Extended relevance: It includes naming conventions used by the IoT compilation and other AWS resources (e.g., getIotLogicalId and getLambdaIotPermissionLogicalId), providing critical context for event resource naming.', relative_path='lib/plugins/aws/lib/naming.test.js', start_line=1, end_line=455)]
2025-11-14 00:28:16,442 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 5 contexts to memory for query: Please provide the full contents of the following files: lib/plugins/aws/deploy/compile/events/iot/index.js and any test files under that directory, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/plugins/aws/deploy/compile/index.test.js, and lib/plugins/aws/lib/naming.test.js.
2025-11-14 00:28:19,279 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-14 00:28:19,280 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 5 new contexts to 0 existing contexts
2025-11-14 00:28:19,280 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 5 total contexts (removed 0 duplicates)
2025-11-14 00:28:19,282 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full contents of the following files: lib/plugins/aws/deploy/compile/events/iot/index.js and any test files under that directory, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/plugins/aws/deploy/compile/index.test.js, and lib/plugins/aws/lib/naming.test.js.
Extra Requirements: If some files do not exist or are empty, please share any tests that reference IoT events or YAML folded scalars ('>') and their full content with line numbers.
Purpose: I need the exact test definitions and line numbers to select 8 relevant existing test cases and include all necessary imports and assertions.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/classes/Service.test.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const YAML = require('js-yaml');
5. const expect = require('chai').expect;
6. const sinon = require('sinon');
7. const Service = require('../../lib/classes/Service');
8. const Utils = require('../../lib/classes/Utils');
9. const Serverless = require('../../lib/Serverless');
10. const testUtils = require('../../tests/utils');
11. 
12. describe('Service', () => {
13.   describe('#constructor()', () => {
14.     const serverless = new Serverless();
15. 
16.     it('should attach serverless instance', () => {
17.       const serviceInstance = new Service(serverless);
18.       expect(typeof serviceInstance.serverless.version).to.be.equal('string');
19.     });
20. 
21.     it('should construct with defaults', () => {
22.       const serviceInstance = new Service(serverless);
23. 
24.       expect(serviceInstance.service).to.be.equal(null);
25.       expect(serviceInstance.provider).to.deep.equal({});
26.       expect(serviceInstance.defaults).to.deep.equal({
27.         stage: 'dev',
28.         region: 'us-east-1',
29.         variableSyntax: '\\${([ :a-zA-Z0-9._,\\-\\/\\(\\)]+?)}',
30.       });
31.       expect(serviceInstance.custom).to.deep.equal({});
32.       expect(serviceInstance.plugins).to.deep.equal([]);
33.       expect(serviceInstance.functions).to.deep.equal({});
34.       expect(serviceInstance.resources).to.deep.equal({});
35.       expect(serviceInstance.package).to.deep.equal({});
36.     });
37. 
38.     it('should construct with data', () => {
39.       const data = {
40.         service: 'testService',
41.         provider: 'testProvider',
42.         custom: {
43.           customProp: 'value',
44.         },
45.         plugins: ['testPlugin'],
46.         functions: {
47.           functionA: {},
48.         },
49.         resources: {
50.           aws: {
51.             resourcesProp: 'value',
52.           },
53.           azure: {},
54.           google: {},
55.         },
56.         package: {
57.           exclude: ['exclude-me'],
58.           include: ['include-me'],
59.           artifact: 'some/path/foo.zip',
60.         },
61.       };
62. 
63.       const serviceInstance = new Service(serverless, data);
64. 
65.       expect(serviceInstance.service).to.be.equal('testService');
66.       expect(serviceInstance.provider).to.be.equal('testProvider');
67.       expect(serviceInstance.custom).to.deep.equal({ customProp: 'value' });
68.       expect(serviceInstance.plugins).to.deep.equal(['testPlugin']);
69.       expect(serviceInstance.functions).to.deep.equal({ functionA: {} });
70.       expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
71.       expect(serviceInstance.resources.azure).to.deep.equal({});
72.       expect(serviceInstance.resources.google).to.deep.equal({});
73.       expect(serviceInstance.package.exclude.length).to.equal(1);
74.       expect(serviceInstance.package.exclude[0]).to.equal('exclude-me');
75.       expect(serviceInstance.package.include.length).to.equal(1);
76.       expect(serviceInstance.package.include[0]).to.equal('include-me');
77.       expect(serviceInstance.package.artifact).to.equal('some/path/foo.zip');
78.     });
79. 
80.     it('should support string based provider config', () => {
81.       const data = {
82.         provider: 'testProvider',
83.       };
84. 
85.       const serviceInstance = new Service(serverless, data);
86. 
87.       expect(serviceInstance.provider).to.be.equal('testProvider');
88.     });
89. 
90.     it('should support object based provider config', () => {
91.       const data = {
92.         provider: {
93.           name: 'testProvider',
94.           runtime: 'nodejs4.3',
95.         },
96.       };
97. 
98.       const serviceInstance = new Service(serverless, data);
99. 
100.       expect(serviceInstance.provider.name).to.be.equal('testProvider');
101.       expect(serviceInstance.provider.runtime).to.be.equal('nodejs4.3');
102.     });
103.   });
104. 
105.   describe('#load()', () => {
106.     let serviceInstance;
107.     let tmpDirPath;
108. 
109.     beforeEach(() => {
110.       tmpDirPath = testUtils.getTmpDirPath();
111.     });
112. 
113.     it('should resolve if no servicePath is found', () => {
114.       const serverless = new Serverless();
115.       const noService = new Service(serverless);
116. 
117.       return noService.load();
118.     });
119. 
120.     it('should load from filesystem', () => {
121.       const SUtils = new Utils();
122.       const serverlessYml = {
123.         service: 'new-service',
124.         provider: 'aws',
125.         defaults: {
126.           stage: 'dev',
127.           region: 'us-east-1',
128.           variableSyntax: '\\${{([\\s\\S]+?)}}',
129.         },
130.         plugins: ['testPlugin'],
131.         functions: {
132.           functionA: {},
133.         },
134.         resources: {
135.           aws: {
136.             resourcesProp: 'value',
137.           },
138.           azure: {},
139.           google: {},
140.         },
141.         package: {
142.           exclude: ['exclude-me'],
143.           include: ['include-me'],
144.           artifact: 'some/path/foo.zip',
145.         },
146.       };
147. 
148.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
149.         YAML.dump(serverlessYml));
150. 
151.       const serverless = new Serverless();
152.       serverless.init();
153.       serverless.config.update({ servicePath: tmpDirPath });
154.       serviceInstance = new Service(serverless);
155. 
156.       return serviceInstance.load().then(() => {
157.         expect(serviceInstance.service).to.be.equal('new-service');
158.         expect(serviceInstance.provider.name).to.deep.equal('aws');
159.         expect(serviceInstance.defaults.variableSyntax).to.equal('\\${{([\\s\\S]+?)}}');
160.         expect(serviceInstance.plugins).to.deep.equal(['testPlugin']);
161.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
162.         expect(serviceInstance.resources.azure).to.deep.equal({});
163.         expect(serviceInstance.resources.google).to.deep.equal({});
164.         expect(serviceInstance.package.exclude.length).to.equal(1);
165.         expect(serviceInstance.package.exclude[0]).to.equal('exclude-me');
166.         expect(serviceInstance.package.include.length).to.equal(1);
167.         expect(serviceInstance.package.include[0]).to.equal('include-me');
168.         expect(serviceInstance.package.artifact).to.equal('some/path/foo.zip');
169.       });
170.     });
171. 
172.     it('should merge resources given as an array', () => {
173.       const SUtils = new Utils();
174.       const serverlessYml = {
175.         service: 'new-service',
176.         provider: 'aws',
177.         resources: [
178.           {
179.             aws: {
180.               resourcesProp: 'value',
181.             },
182.           },
183.           {
184.             azure: {},
185.           },
186.         ],
187.       };
188. 
189.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
190.         YAML.dump(serverlessYml));
191. 
192.       const serverless = new Serverless();
193.       serverless.init();
194.       serverless.config.update({ servicePath: tmpDirPath });
195.       serviceInstance = new Service(serverless);
196. 
197.       return serviceInstance.load().then(() => {
198.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
199.         expect(serviceInstance.resources.azure).to.deep.equal({});
200.       });
201.     });
202. 
203.     it('should make sure function name contains the default stage', () => {
204.       const SUtils = new Utils();
205.       const serverlessYml = {
206.         service: 'new-service',
207.         provider: 'aws',
208.         defaults: {
209.           stage: 'dev',
210.           region: 'us-east-1',
211.           variableSyntax: '\\${{([\\s\\S]+?)}}',
212.         },
213.         plugins: ['testPlugin'],
214.         functions: {
215.           functionA: {},
216.         },
217.         resources: {
218.           aws: {
219.             resourcesProp: 'value',
220.           },
221.           azure: {},
222.           google: {},
223.         },
224.         package: {
225.           exclude: ['exclude-me'],
226.           include: ['include-me'],
227.           artifact: 'some/path/foo.zip',
228.         },
229.       };
230. 
231.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
232.         YAML.dump(serverlessYml));
233. 
234.       const serverless = new Serverless();
235.       serverless.init();
236.       serverless.config.update({ servicePath: tmpDirPath });
237.       serviceInstance = new Service(serverless);
238. 
239.       return serviceInstance.load().then(() => {
240.         expect(serviceInstance.functions.functionA.name).to.be.equal('new-service-dev-functionA');
241.       });
242.     });
243. 
244.     it('should support Serverless file with a non-aws provider', () => {
245.       const SUtils = new Utils();
246.       const serverlessYaml = {
247.         service: 'my-service',
248.         provider: 'openwhisk',
249.         functions: {
250.           functionA: {
251.             name: 'customFunctionName',
252.           },
253.         },
254.       };
255. 
256.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yaml'),
257.         YAML.dump(serverlessYaml));
258. 
259.       const serverless = new Serverless({ servicePath: tmpDirPath });
260.       serviceInstance = new Service(serverless);
261. 
262.       return serviceInstance.load().then(() => {
263.         const expectedFunc = {
264.           functionA: {
265.             name: 'customFunctionName',
266.             events: [],
267.           },
268.         };
269.         expect(serviceInstance.service).to.be.equal('my-service');
270.         expect(serviceInstance.provider.name).to.deep.equal('openwhisk');
271.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
272.       });
273.     });
274. 
275.     it('should support Serverless file with a .yaml extension', () => {
276.       const SUtils = new Utils();
277.       const serverlessYaml = {
278.         service: 'my-service',
279.         provider: 'aws',
280.         functions: {
281.           functionA: {
282.             name: 'customFunctionName',
283.           },
284.         },
285.       };
286. 
287.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yaml'),
288.         YAML.dump(serverlessYaml));
289. 
290.       const serverless = new Serverless({ servicePath: tmpDirPath });
291.       serviceInstance = new Service(serverless);
292. 
293.       return serviceInstance.load().then(() => {
294.         const expectedFunc = {
295.           functionA: {
296.             name: 'customFunctionName',
297.             events: [],
298.           },
299.         };
300.         expect(serviceInstance.service).to.be.equal('my-service');
301.         expect(serviceInstance.provider.name).to.deep.equal('aws');
302.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
303.       });
304.     });
305. 
306.     it('should support Serverless file with a .yml extension', () => {
307.       const SUtils = new Utils();
308.       const serverlessYml = {
309.         service: 'my-service',
310.         provider: 'aws',
311.         functions: {
312.           functionA: {},
313.         },
314.       };
315. 
316.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
317.         YAML.dump(serverlessYml));
318. 
319.       const serverless = new Serverless({ servicePath: tmpDirPath });
320.       serviceInstance = new Service(serverless);
321. 
322.       return serviceInstance.load({ stage: 'dev' }).then(() => {
323.         const expectedFunc = {
324.           functionA: {
325.             name: 'my-service-dev-functionA',
326.             events: [],
327.           },
328.         };
329.         expect(serviceInstance.service).to.be.equal('my-service');
330.         expect(serviceInstance.provider.name).to.deep.equal('aws');
331.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
332.       });
333.     });
334. 
335.     it('should throw error if service property is missing', () => {
336.       const SUtils = new Utils();
337.       const serverlessYml = {
338.         provider: 'aws',
339.         functions: {},
340.       };
341.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
342.         YAML.dump(serverlessYml));
343. 
344.       const serverless = new Serverless({ servicePath: tmpDirPath });
345.       serviceInstance = new Service(serverless);
346. 
347.       return serviceInstance.load().then(() => {
348.         // if we reach this, then no error was thrown as expected
349.         // so make assertion fail intentionally to let us know something is wrong
350.         expect(1).to.equal(2);
351.       }).catch(e => {
352.         expect(e.name).to.be.equal('ServerlessError');
353.       });
354.     });
355. 
356.     it('should throw error if provider property is missing', () => {
357.       const SUtils = new Utils();
358.       const serverlessYml = {
359.         service: 'service-name',
360.         functions: {},
361.       };
362.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
363.         YAML.dump(serverlessYml));
364. 
365.       const serverless = new Serverless({ servicePath: tmpDirPath });
366.       serviceInstance = new Service(serverless);
367. 
368.       return serviceInstance.load().then(() => {
369.         // if we reach this, then no error was thrown as expected
370.         // so make assertion fail intentionally to let us know something is wrong
371.         expect(1).to.equal(2);
372.       }).catch(e => {
373.         expect(e.name).to.be.equal('ServerlessError');
374.       });
375.     });
376. 
377.     it('should throw error if frameworkVersion is not satisfied', () => {
378.       const SUtils = new Utils();
379.       const serverlessYml = {
380.         service: 'service-name',
381.         frameworkVersion: '=1.0.0',
382.         provider: 'aws',
383.         functions: {},
384.       };
385.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
386.         YAML.dump(serverlessYml));
387. 
388.       const serverless = new Serverless({ servicePath: tmpDirPath });
389.       const getVersion = sinon.stub(serverless.utils, 'getVersion');
390.       getVersion.returns('1.0.2');
391.       serviceInstance = new Service(serverless);
392. 
393.       return serviceInstance.load().then(() => {
394.         // if we reach this, then no error was thrown as expected
395.         // so make assertion fail intentionally to let us know something is wrong
396.         expect(1).to.equal(2);
397.       }).catch(e => {
398.         expect(e.name).to.be.equal('ServerlessError');
399.       });
400.     });
401. 
402.     it('should pass if frameworkVersion is satisfied', () => {
403.       const SUtils = new Utils();
404.       const serverlessYml = {
405.         service: 'service-name',
406.         frameworkVersion: '>=1.0.0',
407.         provider: 'aws',
408.         functions: {},
409.       };
410.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
411.         YAML.dump(serverlessYml));
412. 
413.       const serverless = new Serverless({ servicePath: tmpDirPath });
414.       const getVersion = sinon.stub(serverless.utils, 'getVersion');
415.       getVersion.returns('1.2.2');
416.       serviceInstance = new Service(serverless);
417. 
418.       return serviceInstance.load().then(() => {
419.         // if this callbar is reached, then no error was thrown as expected
420.         expect(1).to.equal(1);
421.       });
422.     });
423. 
424.     it('should not throw error if functions property is missing', () => {
425.       const SUtils = new Utils();
426.       const serverlessYml = {
427.         service: 'service-name',
428.         provider: 'aws',
429.       };
430.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
431.         YAML.dump(serverlessYml));
432. 
433.       const serverless = new Serverless({ servicePath: tmpDirPath });
434.       serviceInstance = new Service(serverless);
435. 
436.       return serviceInstance.load().then(() => {
437.         expect(serverless.service.functions).to.deep.equal({});
438.       });
439.     });
440. 
441.     it("should throw error if a function's event is not an array", () => {
442.       const SUtils = new Utils();
443.       const serverlessYml = {
444.         service: 'service-name',
445.         provider: 'aws',
446.         functions: {
447.           functionA: {
448.             events: {},
449.           },
450.         },
451.       };
452.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
453.         YAML.dump(serverlessYml));
454. 
455.       const serverless = new Serverless({ servicePath: tmpDirPath });
456.       serviceInstance = new Service(serverless);
457. 
458.       return serviceInstance.load().then(() => {
459.         // if we reach this, then no error was thrown as expected
460.         // so make assertion fail intentionally to let us know something is wrong
461.         expect(1).to.equal(2);
462.       }).catch(e => {
463.         expect(e.name).to.be.equal('ServerlessError');
464.       });
465.     });
466. 
467.     it('should throw error if provider property is invalid', () => {
468.       const SUtils = new Utils();
469.       const serverlessYml = {
470.         service: 'service-name',
471.         provider: 'invalid',
472.         functions: {},
473.       };
474. 
475.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
476.         YAML.dump(serverlessYml));
477. 
478.       const serverless = new Serverless({ servicePath: tmpDirPath });
479.       serviceInstance = new Service(serverless);
480. 
481.       return serviceInstance.load().then(() => {
482.         // if we reach this, then no error was thrown as expected
483.         // so make assertion fail intentionally to let us know something is wrong
484.         expect(1).to.equal(2);
485.       }).catch(e => {
486.         expect(e.name).to.be.equal('ServerlessError');
487.       });
488.     });
489.   });
490. 
491.   describe('#update()', () => {
492.     it('should update service instance data', () => {
493.       const serverless = new Serverless();
494.       const serviceInstance = new Service(serverless);
495.       const newData = { service: 'newName' };
496.       const updatedInstance = serviceInstance.update(newData);
497.       expect(updatedInstance.service).to.be.equal('newName');
498.     });
499.   });
500. 


File: lib/classes/YamlParser.test.js
Line number range: 1 - 99
Content:
1. 'use strict';
2. 
3. /**
4.  * Test: YamlParser Function Class
5.  */
6. 
7. const expect = require('chai').expect;
8. const YAML = require('js-yaml');
9. const path = require('path');
10. const Serverless = require('../../lib/Serverless');
11. const testUtils = require('../../tests/utils');
12. 
13. const serverless = new Serverless();
14. 
15. describe('YamlParser', () => {
16.   describe('#parse()', () => {
17.     it('should parse a simple .yaml file', () => {
18.       const tmpFilePath = testUtils.getTmpFilePath('simple.yaml');
19. 
20.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));
21. 
22.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {
23.         expect(obj.foo).to.equal('bar');
24.       });
25.     });
26. 
27.     it('should parse a simple .yml file', () => {
28.       const tmpFilePath = testUtils.getTmpFilePath('simple.yml');
29. 
30.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));
31. 
32.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {
33.         expect(obj.foo).to.equal('bar');
34.       });
35.     });
36. 
37.     it('should parse a .yml file with JSON-REF to YAML', () => {
38.       const tmpDirPath = testUtils.getTmpDirPath();
39. 
40.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.yml'), { foo: 'bar' });
41. 
42.       const testYml = {
43.         main: {
44.           $ref: './ref.yml',
45.         },
46.       };
47. 
48.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);
49. 
50.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {
51.         expect(obj.main.foo).to.equal('bar');
52.       });
53.     });
54. 
55.     it('should parse a .yml file with JSON-REF to JSON', () => {
56.       const tmpDirPath = testUtils.getTmpDirPath();
57. 
58.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.json'), { foo: 'bar' });
59. 
60.       const testYml = {
61.         main: {
62.           $ref: './ref.json',
63.         },
64.       };
65. 
66.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);
67. 
68.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {
69.         expect(obj.main.foo).to.equal('bar');
70.       });
71.     });
72. 
73.     it('should parse a .yml file with recursive JSON-REF', () => {
74.       const tmpDirPath = testUtils.getTmpDirPath();
75. 
76.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'three.yml'), { foo: 'bar' });
77. 
78.       const twoYml = {
79.         two: {
80.           $ref: './three.yml',
81.         },
82.       };
83. 
84.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'two.yml'), twoYml);
85. 
86.       const oneYml = {
87.         one: {
88.           $ref: './two.yml',
89.         },
90.       };
91. 
92.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'one.yml'), oneYml);
93. 
94.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'one.yml')).then((obj) => {
95.         expect(obj.one.two.foo).to.equal('bar');
96.       });
97.     });
98.   });
99. });


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }
14. 
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }
47. 
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;
96. 
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);
107.           }
108.         });
109.       }
110.     });
111.   }
112. }
113. module.exports = AwsCompileIoTEvents;


File: lib/plugins/aws/deploy/compile/events/iot/index.test.js
Line number range: 1 - 229
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileIoTEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileIoTEvents', () => {
9.   let serverless;
10.   let awsCompileIoTEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
15.     serverless.setProvider('aws', new AwsProvider(serverless));
16.     awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
17.     awsCompileIoTEvents.serverless.service.service = 'new-service';
18.   });
19. 
20.   describe('#constructor()', () => {
21.     it('should set the provider variable to an instance of AwsProvider', () =>
22.       expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));
23.   });
24. 
25.   describe('#awsCompileIoTEvents()', () => {
26.     it('should throw an error if iot event type is not an object', () => {
27.       awsCompileIoTEvents.serverless.service.functions = {
28.         first: {
29.           events: [
30.             {
31.               iot: 'iot',
32.             },
33.           ],
34.         },
35.       };
36. 
37.       expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);
38.     });
39. 
40.     it('should create corresponding resources when iot events are given', () => {
41.       awsCompileIoTEvents.serverless.service.functions = {
42.         first: {
43.           events: [
44.             {
45.               iot: {
46.                 sql: "SELECT * FROM 'topic_1'",
47.               },
48.             },
49.             {
50.               iot: {
51.                 sql: "SELECT * FROM 'topic_2'",
52.               },
53.             },
54.           ],
55.         },
56.       };
57. 
58.       awsCompileIoTEvents.compileIoTEvents();
59. 
60.       expect(awsCompileIoTEvents.serverless.service
61.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type
62.       ).to.equal('AWS::IoT::TopicRule');
63.       expect(awsCompileIoTEvents.serverless.service
64.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type
65.       ).to.equal('AWS::IoT::TopicRule');
66.       expect(awsCompileIoTEvents.serverless.service
67.         .provider.compiledCloudFormationTemplate.Resources
68.         .FirstIotTopicRule1.Properties.TopicRulePayload.Sql
69.       ).to.equal('SELECT * FROM \'topic_1\'');
70.       expect(awsCompileIoTEvents.serverless.service
71.         .provider.compiledCloudFormationTemplate.Resources
72.         .FirstIotTopicRule2.Properties.TopicRulePayload.Sql
73.       ).to.equal('SELECT * FROM \'topic_2\'');
74.       expect(awsCompileIoTEvents.serverless.service
75.         .provider.compiledCloudFormationTemplate.Resources
76.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
77.       ).to.equal('false');
78.       expect(awsCompileIoTEvents.serverless.service
79.         .provider.compiledCloudFormationTemplate.Resources
80.         .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled
81.       ).to.equal('false');
82.       expect(awsCompileIoTEvents.serverless.service
83.         .provider.compiledCloudFormationTemplate.Resources
84.         .FirstLambdaPermissionIotTopicRule1.Type
85.       ).to.equal('AWS::Lambda::Permission');
86.       expect(awsCompileIoTEvents.serverless.service
87.         .provider.compiledCloudFormationTemplate.Resources
88.         .FirstLambdaPermissionIotTopicRule2.Type
89.       ).to.equal('AWS::Lambda::Permission');
90.     });
91. 
92.     it('should respect "name" variable', () => {
93.       awsCompileIoTEvents.serverless.service.functions = {
94.         first: {
95.           events: [
96.             {
97.               iot: {
98.                 name: 'iotEvantName',
99.                 sql: "SELECT * FROM 'topic_1'",
100.               },
101.             },
102.           ],
103.         },
104.       };
105. 
106.       awsCompileIoTEvents.compileIoTEvents();
107. 
108.       expect(awsCompileIoTEvents.serverless.service
109.         .provider.compiledCloudFormationTemplate.Resources
110.         .FirstIotTopicRule1.Properties.RuleName
111.       ).to.equal('iotEvantName');
112.     });
113. 
114.     it('should respect "enabled" variable', () => {
115.       awsCompileIoTEvents.serverless.service.functions = {
116.         first: {
117.           events: [
118.             {
119.               iot: {
120.                 enabled: false,
121.                 sql: "SELECT * FROM 'topic_1'",
122.               },
123.             },
124.           ],
125.         },
126.         second: {
127.           events: [
128.             {
129.               iot: {
130.                 enabled: true,
131.                 sql: "SELECT * FROM 'topic_1'",
132.               },
133.             },
134.           ],
135.         },
136.       };
137. 
138.       awsCompileIoTEvents.compileIoTEvents();
139. 
140.       expect(awsCompileIoTEvents.serverless.service
141.         .provider.compiledCloudFormationTemplate.Resources
142.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
143.       ).to.equal('true');
144.       expect(awsCompileIoTEvents.serverless.service
145.         .provider.compiledCloudFormationTemplate.Resources
146.         .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
147.       ).to.equal('false');
148.     });
149. 
150.     it('should respect "sqlVersion" variable', () => {
151.       awsCompileIoTEvents.serverless.service.functions = {
152.         first: {
153.           events: [
154.             {
155.               iot: {
156.                 sqlVersion: '2016-03-23',
157.                 sql: "SELECT * FROM 'topic_1'",
158.               },
159.             },
160.           ],
161.         },
162.       };
163. 
164.       awsCompileIoTEvents.compileIoTEvents();
165. 
166.       expect(awsCompileIoTEvents.serverless.service
167.         .provider.compiledCloudFormationTemplate.Resources
168.         .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion
169.       ).to.equal('2016-03-23');
170.     });
171. 
172.     it('should respect "description" variable', () => {
173.       awsCompileIoTEvents.serverless.service.functions = {
174.         first: {
175.           events: [
176.             {
177.               iot: {
178.                 description: 'iot event description',
179.                 sql: "SELECT * FROM 'topic_1'",
180.               },
181.             },
182.           ],
183.         },
184.       };
185. 
186.       awsCompileIoTEvents.compileIoTEvents();
187. 
188.       expect(awsCompileIoTEvents.serverless.service
189.         .provider.compiledCloudFormationTemplate.Resources
190.         .FirstIotTopicRule1.Properties.TopicRulePayload.Description
191.       ).to.equal('iot event description');
192.     });
193. 
194.     it('should respect enabled variable if the "enabled" property is not given', () => {
195.       awsCompileIoTEvents.serverless.service.functions = {
196.         first: {
197.           events: [
198.             {
199.               iot: {
200.                 sql: "SELECT * FROM 'topic_1'",
201.               },
202.             },
203.           ],
204.         },
205.       };
206. 
207.       awsCompileIoTEvents.compileIoTEvents();
208. 
209.       expect(awsCompileIoTEvents.serverless.service
210.         .provider.compiledCloudFormationTemplate.Resources
211.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
212.       ).to.equal('false');
213.     });
214. 
215.     it('should not create corresponding resources when iot events are not given', () => {
216.       awsCompileIoTEvents.serverless.service.functions = {
217.         first: {
218.           events: [],
219.         },
220.       };
221. 
222.       awsCompileIoTEvents.compileIoTEvents();
223. 
224.       expect(awsCompileIoTEvents.serverless.service
225.         .provider.compiledCloudFormationTemplate.Resources
226.       ).to.deep.equal({});
227.     });
228.   });
229. });


File: lib/plugins/aws/lib/naming.test.js
Line number range: 1 - 455
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. 
5. const SDK = require('../provider/awsProvider');
6. const Serverless = require('../../../Serverless');
7. 
8. describe('#naming()', () => {
9.   let options;
10.   let serverless;
11.   let sdk;
12. 
13.   beforeEach(() => {
14.     options = {
15.       stage: 'dev',
16.       region: 'us-east-1',
17.     };
18.     serverless = new Serverless(options);
19.     sdk = new SDK(serverless, options);
20.   });
21. 
22.   describe('#normalizeName()', () => {
23.     it('should capitalize the first letter', () => {
24.       expect(sdk.naming.normalizeName('name')).to.equal('Name');
25.     });
26. 
27.     it('should have no effect on caps', () => {
28.       expect(sdk.naming.normalizeName('Name')).to.equal('Name');
29.     });
30. 
31.     it('should have no effect on the rest of the name', () => {
32.       expect(sdk.naming.normalizeName('nAME')).to.equal('NAME');
33.     });
34.   });
35. 
36.   describe('#normalizeNameToAlphaNumericOnly()', () => {
37.     it('should strip non-alpha-numeric characters', () => {
38.       expect(sdk.naming
39.         .normalizeNameToAlphaNumericOnly('`!@#$%^&*()-={}|[]\\:";\'<>?,./')).to.equal('');
40.     });
41. 
42.     it('should apply normalizeName to the remaining characters', () => {
43.       expect(sdk.naming.normalizeNameToAlphaNumericOnly('a-b-c')).to.equal('Abc');
44.     });
45.   });
46. 
47.   describe('#normalizePathPart()', () => {
48.     it('converts `-` to `Dash`', () => {
49.       expect(sdk.naming.normalizePathPart(
50.         'a-path'
51.       )).to.equal('ADashpath');
52.     });
53. 
54.     it('converts variable declarations (`${var}`) to `VariableVar`', () => {
55.       expect(sdk.naming.normalizePathPart(
56.         '${variable}'
57.       )).to.equal('VariableVar');
58.     });
59. 
60.     it('converts variable declarations prefixes to `VariableVarpath`', () => {
61.       expect(sdk.naming.normalizePathPart(
62.         '${variable}Path'
63.       )).to.equal('VariableVarpath');
64.     });
65. 
66.     it('converts variable declarations suffixes to `PathvariableVar`', () => {
67.       expect(sdk.naming.normalizePathPart(
68.         'path${variable}'
69.       )).to.equal('PathvariableVar');
70.     });
71. 
72.     it('converts variable declarations in center to `PathvariableVardir`', () => {
73.       expect(sdk.naming.normalizePathPart(
74.         'path${variable}Dir'
75.       )).to.equal('PathvariableVardir');
76.     });
77.   });
78. 
79.   describe('#getServiceEndpointRegex()', () => {
80.     it('should match the prefix', () => {
81.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpoint'))
82.         .to.equal(true);
83.     });
84. 
85.     it('should not match a name without the prefix', () => {
86.       expect(sdk.naming.getServiceEndpointRegex()
87.         .test('NotThePrefixServiceEndpoint')).to.equal(false);
88.     });
89. 
90.     it('should match a name with the prefix', () => {
91.       expect(sdk.naming.getServiceEndpointRegex()
92.         .test('ServiceEndpointForAService')).to.equal(true);
93.     });
94.   });
95. 
96.   describe('#getStackName()', () => {
97.     it('should use the service name and stage from the service and config', () => {
98.       serverless.service.service = 'myService';
99.       expect(sdk.naming.getStackName()).to.equal(`${serverless.service.service}-${options.stage}`);
100.     });
101.   });
102. 
103.   describe('#getRolePath()', () => {
104.     it('should return `/`', () => {
105.       expect(sdk.naming.getRolePath()).to.equal('/');
106.     });
107.   });
108. 
109.   describe('#getRoleName()', () => {
110.     it('uses the service name, stage, and region to generate a role name', () => {
111.       serverless.service.service = 'myService';
112.       expect(sdk.naming.getRoleName()).to.eql({
113.         'Fn::Join': [
114.           '-',
115.           [
116.             serverless.service.service,
117.             options.stage,
118.             options.region,
119.             'lambdaRole',
120.           ],
121.         ],
122.       });
123.     });
124.   });
125. 
126.   describe('#getRoleLogicalId()', () => {
127.     it('should return the expected role name (IamRoleLambdaExecution)', () => {
128.       expect(sdk.naming.getRoleLogicalId()).to.equal('IamRoleLambdaExecution');
129.     });
130.   });
131. 
132.   describe('#getPolicyName()', () => {
133.     it('should use the stage and service name', () => {
134.       serverless.service.service = 'myService';
135.       expect(sdk.naming.getPolicyName()).to.eql({
136.         'Fn::Join': [
137.           '-',
138.           [
139.             options.stage,
140.             serverless.service.service,
141.             'lambda',
142.           ],
143.         ],
144.       });
145.     });
146.   });
147. 
148.   describe('#getPolicyLogicalId()', () => {
149.     it('should return the expected policy name (IamPolicyLambdaExecution)', () => {
150.       expect(sdk.naming.getPolicyLogicalId()).to.equal('IamPolicyLambdaExecution');
151.     });
152.   });
153. 
154.   describe('#getLogicalLogGroupName()', () => {
155.     it('should prefix the normalized function name to "LogGroup"', () => {
156.       expect(sdk.naming.getLogGroupLogicalId('functionName')).to.equal('FunctionNameLogGroup');
157.     });
158.   });
159. 
160.   describe('#getLogGroupName()', () => {
161.     it('should add the function name to the log group name', () => {
162.       expect(sdk.naming.getLogGroupName('functionName')).to.equal('/aws/lambda/functionName');
163.     });
164.   });
165. 
166.   describe('#getNormalizedFunctionName()', () => {
167.     it('should normalize the given functionName', () => {
168.       expect(sdk.naming.getNormalizedFunctionName('functionName'))
169.         .to.equal('FunctionName');
170.     });
171. 
172.     it('should normalize the given functionName with an underscore', () => {
173.       expect(sdk.naming.getNormalizedFunctionName('hello_world'))
174.         .to.equal('HelloUnderscoreworld');
175.     });
176. 
177.     it('should normalize the given functionName with a dash', () => {
178.       expect(sdk.naming.getNormalizedFunctionName('hello-world'))
179.         .to.equal('HelloDashworld');
180.     });
181.   });
182. 
183.   describe('#extractAuthorizerNameFromArn()', () => {
184.     it('should extract everything after the last colon and dash', () => {
185.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
186.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
187.     });
188.   });
189. 
190.   describe('#extractLambdaNameFromArn()', () => {
191.     it('should extract everything after the last colon', () => {
192.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
193.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal('my-dev-lambda');
194.     });
195.   });
196. 
197.   describe('#getLambdaLogicalId()', () => {
198.     it('should normalize the function name and add the logical suffix', () => {
199.       expect(sdk.naming.getLambdaLogicalId('functionName'))
200.         .to.equal('FunctionNameLambdaFunction');
201.     });
202.   });
203. 
204.   describe('#getLambdaLogicalIdRegex()', () => {
205.     it('should match the suffix', () => {
206.       expect(sdk.naming.getLambdaLogicalIdRegex()
207.         .test('LambdaFunction')).to.equal(true);
208.     });
209. 
210.     it('should not match a name without the suffix', () => {
211.       expect(sdk.naming.getLambdaLogicalIdRegex()
212.         .test('LambdaFunctionNotTheSuffix')).to.equal(false);
213.     });
214. 
215.     it('should match a name with the suffix', () => {
216.       expect(sdk.naming.getLambdaLogicalIdRegex()
217.         .test('AFunctionNameLambdaFunction')).to.equal(true);
218.     });
219.   });
220. 
221.   describe('#getLambdaOutputLogicalId()', () => {
222.     it('should normalize the function name and add the logical arn suffix', () => {
223.       expect(
224.         sdk.naming.getLambdaOutputLogicalId('functionName')
225.       ).to.equal('FunctionNameLambdaFunctionArn');
226.     });
227.   });
228. 
229.   describe('#getLambdaOutputLogicalIdRegex()', () => {
230.     it('should match the suffix', () => {
231.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
232.         .test('aLambdaFunctionArn')).to.equal(true);
233.     });
234. 
235.     it('should not match a name without the suffix', () => {
236.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
237.         .test('LambdaFunctionArnNotTheSuffix'))
238.         .to.equal(false);
239.     });
240. 
241.     it('should match a name with the suffix', () => {
242.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
243.         .test('AFunctionArnNameLambdaFunctionArn'))
244.         .to.equal(true);
245.     });
246.   });
247. 
248.   describe('#getApiGatewayName()', () => {
249.     it('should return the composition of stage and service name', () => {
250.       serverless.service.service = 'myService';
251.       expect(sdk.naming.getApiGatewayName())
252.         .to.equal(`${options.stage}-${serverless.service.service}`);
253.     });
254.   });
255. 
256.   describe('#generateApiGatewayDeploymentLogicalId()', () => {
257.     it('should return ApiGatewayDeployment with a date based suffix', () => {
258.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId()
259.         .match(/ApiGatewayDeployment(.*)/).length)
260.         .to.be.greaterThan(1);
261.     });
262.   });
263. 
264.   describe('#getRestApiLogicalId()', () => {
265.     it('should return ApiGatewayRestApi', () => {
266.       expect(sdk.naming.getRestApiLogicalId()).to.equal('ApiGatewayRestApi');
267.     });
268.   });
269. 
270.   describe('#getNormalizedAuthorizerName()', () => {
271.     it('normalize the authorizer name', () => {
272.       expect(sdk.naming.getNormalizedAuthorizerName('authorizerName'))
273.         .to.equal('AuthorizerName');
274.     });
275.   });
276. 
277.   describe('#getAuthorizerLogicalId()', () => {
278.     it('should normalize the authorizer name and add the standard suffix', () => {
279.       expect(sdk.naming.getAuthorizerLogicalId('authorizerName'))
280.         .to.equal('AuthorizerNameApiGatewayAuthorizer');
281.     });
282.   });
283. 
284.   describe('#extractAuthorizerNameFromArn()', () => {
285.     it('should extract the authorizer name from an ARN', () => {
286.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
287.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
288.     });
289.   });
290. 
291.   describe('#normalizePath()', () => {
292.     it('should normalize each part of the resource path and remove non-alpha-numeric characters',
293.       () => {
294.         expect(sdk.naming.normalizePath(
295.           'my/path/to/a-${var}-resource'
296.         )).to.equal('MyPathToADashvarVarDashresource');
297.       });
298.   });
299. 
300.   describe('#getResourceLogicalId()', () => {
301.     it('should normalize the resource and add the standard suffix', () => {
302.       expect(sdk.naming.getResourceLogicalId(
303.         'my/path/to/a-${var}-resource'
304.       )).to.equal('ApiGatewayResourceMyPathToADashvarVarDashresource');
305.     });
306.   });
307. 
308.   describe('#extractResourceId()', () => {
309.     it('should extract the normalized resource name', () => {
310.       expect(sdk.naming.extractResourceId(
311.         'ApiGatewayResourceMyPathToADashvarVarDashResource'
312.       )).to.equal('MyPathToADashvarVarDashResource');
313.     });
314.   });
315. 
316.   describe('#normalizeMethodName()', () => {
317.     it('should capitalize the first letter and lowercase any other characters', () => {
318.       expect(sdk.naming.normalizeMethodName('gET')).to.equal('Get');
319.     });
320.   });
321. 
322.   describe('#getMethodLogicalId()', () => {
323.     it('', () => {
324.       expect(sdk.naming.getMethodLogicalId(
325.         'ResourceId', 'get'
326.       )).to.equal('ApiGatewayMethodResourceIdGet');
327.     });
328.   });
329. 
330.   describe('#getApiKeyLogicalId(keyIndex)', () => {
331.     it('should produce the given index with ApiGatewayApiKey as a prefix', () => {
332.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal('ApiGatewayApiKey1');
333.     });
334.   });
335. 
336.   describe('#getApiKeyLogicalIdRegex()', () => {
337.     it('should match the prefix', () => {
338.       expect(sdk.naming.getApiKeyLogicalIdRegex()
339.         .test('ApiGatewayApiKey')).to.equal(true);
340.     });
341. 
342.     it('should not match a name without the prefix', () => {
343.       expect(sdk.naming.getApiKeyLogicalIdRegex()
344.         .test('NotThePrefixApiGatewayApiKey')).to.equal(false);
345.     });
346. 
347.     it('should match a name with the prefix', () => {
348.       expect(sdk.naming.getApiKeyLogicalIdRegex()
349.         .test('ApiGatewayApiKeySuffix')).to.equal(true);
350.     });
351.   });
352. 
353.   describe('#getDeploymentBucketLogicalId()', () => {
354.     it('should return "ServerlessDeploymentBucket"', () => {
355.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal('ServerlessDeploymentBucket');
356.     });
357.   });
358. 
359.   describe('#getDeploymentBucketOutputLogicalId()', () => {
360.     it('should return "ServerlessDeploymentBucketName"', () => {
361.       expect(sdk.naming.getDeploymentBucketOutputLogicalId())
362.         .to.equal('ServerlessDeploymentBucketName');
363.     });
364.   });
365. 
366.   describe('#normalizeBucketName()', () => {
367.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
368.       expect(sdk.naming.normalizeBucketName('b!u@c#k$e%t^N&a*m(e')).to.equal('BucketName');
369.     });
370.   });
371. 
372.   describe('#getBucketLogicalId()', () => {
373.     it('should normalize the bucket name and add the standard prefix', () => {
374.       expect(sdk.naming.getBucketLogicalId('b!u@c#k$e%t^N&a*m(e')).to.equal('S3BucketBucketName');
375.     });
376.   });
377. 
378.   describe('#normalizeTopicName()', () => {
379.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
380.       expect(sdk.naming.normalizeTopicName('t!o@p#i$c%N^a&m*e')).to.equal('TopicName');
381.     });
382.   });
383. 
384.   describe('#getTopicLogicalId()', () => {
385.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
386.       expect(sdk.naming.getTopicLogicalId('t!o@p#i$c%N^a&m*e')).to.equal('SNSTopicTopicName');
387.     });
388.   });
389. 
390.   describe('#getScheduleId()', () => {
391.     it('should add the standard suffix', () => {
392.       expect(sdk.naming.getScheduleId('functionName')).to.equal('functionNameSchedule');
393.     });
394.   });
395. 
396.   describe('#getScheduleLogicalId()', () => {
397.     it('should normalize the function name and add the standard suffix including the index', () => {
398.       expect(sdk.naming.getScheduleLogicalId('functionName', 0))
399.         .to.equal('FunctionNameEventsRuleSchedule0');
400.     });
401.   });
402. 
403.   describe('#getLambdaS3PermissionLogicalId()', () => {
404.     it('should normalize the function name and add the standard suffix', () => {
405.       expect(sdk.naming.getLambdaS3PermissionLogicalId('functionName', 'bucket'))
406.         .to.equal('FunctionNameLambdaPermissionBucketS3');
407.     });
408.   });
409. 
410.   describe('#getLambdaSnsPermissionLogicalId()', () => {
411.     it('should normalize the function and topic names and add them as prefix and suffix to the ' +
412.       'standard permission center', () => {
413.       expect(sdk.naming.getLambdaSnsPermissionLogicalId('functionName', 'topic'))
414.         .to.equal('FunctionNameLambdaPermissionTopicSNS');
415.     });
416.   });
417. 
418.   describe('#getLambdaSchedulePermissionLogicalId()', () => {
419.     it('should normalize the function name and add the standard suffix including event index',
420.       () => {
421.         expect(sdk.naming.getLambdaSchedulePermissionLogicalId('functionName', 0))
422.           .to.equal('FunctionNameLambdaPermissionEventsRuleSchedule0');
423.       });
424.   });
425. 
426.   describe('#getLambdaApiGatewayPermissionLogicalId()', () => {
427.     it('should normalize the function name and append the standard suffix', () => {
428.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId('functionName'))
429.         .to.equal('FunctionNameLambdaPermissionApiGateway');
430.     });
431.   });
432. 
433.   describe('#getIotLogicalId()', () => {
434.     it('should normalize the function name and add the standard suffix including the index', () => {
435.       expect(sdk.naming.getIotLogicalId('functionName', 0))
436.         .to.equal('FunctionNameIotTopicRule0');
437.     });
438.   });
439. 
440.   describe('#getLambdaIotPermissionLogicalId()', () => {
441.     it('should normalize the function name and add the standard suffix including event index',
442.       () => {
443.         expect(sdk.naming.getLambdaIotPermissionLogicalId('functionName', 0))
444.           .to.equal('FunctionNameLambdaPermissionIotTopicRule0');
445.       });
446.   });
447. 
448.   describe('#getLambdaAlexaSkillPermissionLogicalId()', () => {
449.     it('should normalize the function name and append the standard suffix',
450.       () => {
451.         expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName'))
452.           .to.equal('FunctionNameLambdaPermissionAlexaSkill');
453.       });
454.   });
455. });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:28:50,466 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The issue concerns IoT event compilation in AWS deploy and how multi-line YAML folded scalars affect JSON parsing. The provided context includes the target implementation (lib/plugins/aws/deploy/compile/events/iot/index.js) and its comprehensive test suite (lib/plugins/aws/deploy/compile/events/iot/index.test.js) with exact line numbers, plus YAML parsing and Service tests. This is sufficient to select 8 relevant existing tests and include all necessary imports, setup, and assertions. No further files are essential.' query='' extra_requirements='If line numbers differ in your local repo, please confirm the commit or tag so I can align the ranges.' purpose='Proceed to extract 8 existing tests most relevant to IoT event compilation behavior and likely to be impacted by fixes for multi-line values.'
2025-11-14 00:28:50,470 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='lib/classes/Service.test.js', content='1. \'use strict\';\n2. \n3. const path = require(\'path\');\n4. const YAML = require(\'js-yaml\');\n5. const expect = require(\'chai\').expect;\n6. const sinon = require(\'sinon\');\n7. const Service = require(\'../../lib/classes/Service\');\n8. const Utils = require(\'../../lib/classes/Utils\');\n9. const Serverless = require(\'../../lib/Serverless\');\n10. const testUtils = require(\'../../tests/utils\');\n11. \n12. describe(\'Service\', () => {\n13.   describe(\'#constructor()\', () => {\n14.     const serverless = new Serverless();\n15. \n16.     it(\'should attach serverless instance\', () => {\n17.       const serviceInstance = new Service(serverless);\n18.       expect(typeof serviceInstance.serverless.version).to.be.equal(\'string\');\n19.     });\n20. \n21.     it(\'should construct with defaults\', () => {\n22.       const serviceInstance = new Service(serverless);\n23. \n24.       expect(serviceInstance.service).to.be.equal(null);\n25.       expect(serviceInstance.provider).to.deep.equal({});\n26.       expect(serviceInstance.defaults).to.deep.equal({\n27.         stage: \'dev\',\n28.         region: \'us-east-1\',\n29.         variableSyntax: \'\\\\${([ :a-zA-Z0-9._,\\\\-\\\\/\\\\(\\\\)]+?)}\',\n30.       });\n31.       expect(serviceInstance.custom).to.deep.equal({});\n32.       expect(serviceInstance.plugins).to.deep.equal([]);\n33.       expect(serviceInstance.functions).to.deep.equal({});\n34.       expect(serviceInstance.resources).to.deep.equal({});\n35.       expect(serviceInstance.package).to.deep.equal({});\n36.     });\n37. \n38.     it(\'should construct with data\', () => {\n39.       const data = {\n40.         service: \'testService\',\n41.         provider: \'testProvider\',\n42.         custom: {\n43.           customProp: \'value\',\n44.         },\n45.         plugins: [\'testPlugin\'],\n46.         functions: {\n47.           functionA: {},\n48.         },\n49.         resources: {\n50.           aws: {\n51.             resourcesProp: \'value\',\n52.           },\n53.           azure: {},\n54.           google: {},\n55.         },\n56.         package: {\n57.           exclude: [\'exclude-me\'],\n58.           include: [\'include-me\'],\n59.           artifact: \'some/path/foo.zip\',\n60.         },\n61.       };\n62. \n63.       const serviceInstance = new Service(serverless, data);\n64. \n65.       expect(serviceInstance.service).to.be.equal(\'testService\');\n66.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n67.       expect(serviceInstance.custom).to.deep.equal({ customProp: \'value\' });\n68.       expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n69.       expect(serviceInstance.functions).to.deep.equal({ functionA: {} });\n70.       expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n71.       expect(serviceInstance.resources.azure).to.deep.equal({});\n72.       expect(serviceInstance.resources.google).to.deep.equal({});\n73.       expect(serviceInstance.package.exclude.length).to.equal(1);\n74.       expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n75.       expect(serviceInstance.package.include.length).to.equal(1);\n76.       expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n77.       expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n78.     });\n79. \n80.     it(\'should support string based provider config\', () => {\n81.       const data = {\n82.         provider: \'testProvider\',\n83.       };\n84. \n85.       const serviceInstance = new Service(serverless, data);\n86. \n87.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n88.     });\n89. \n90.     it(\'should support object based provider config\', () => {\n91.       const data = {\n92.         provider: {\n93.           name: \'testProvider\',\n94.           runtime: \'nodejs4.3\',\n95.         },\n96.       };\n97. \n98.       const serviceInstance = new Service(serverless, data);\n99. \n100.       expect(serviceInstance.provider.name).to.be.equal(\'testProvider\');\n101.       expect(serviceInstance.provider.runtime).to.be.equal(\'nodejs4.3\');\n102.     });\n103.   });\n104. \n105.   describe(\'#load()\', () => {\n106.     let serviceInstance;\n107.     let tmpDirPath;\n108. \n109.     beforeEach(() => {\n110.       tmpDirPath = testUtils.getTmpDirPath();\n111.     });\n112. \n113.     it(\'should resolve if no servicePath is found\', () => {\n114.       const serverless = new Serverless();\n115.       const noService = new Service(serverless);\n116. \n117.       return noService.load();\n118.     });\n119. \n120.     it(\'should load from filesystem\', () => {\n121.       const SUtils = new Utils();\n122.       const serverlessYml = {\n123.         service: \'new-service\',\n124.         provider: \'aws\',\n125.         defaults: {\n126.           stage: \'dev\',\n127.           region: \'us-east-1\',\n128.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n129.         },\n130.         plugins: [\'testPlugin\'],\n131.         functions: {\n132.           functionA: {},\n133.         },\n134.         resources: {\n135.           aws: {\n136.             resourcesProp: \'value\',\n137.           },\n138.           azure: {},\n139.           google: {},\n140.         },\n141.         package: {\n142.           exclude: [\'exclude-me\'],\n143.           include: [\'include-me\'],\n144.           artifact: \'some/path/foo.zip\',\n145.         },\n146.       };\n147. \n148.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n149.         YAML.dump(serverlessYml));\n150. \n151.       const serverless = new Serverless();\n152.       serverless.init();\n153.       serverless.config.update({ servicePath: tmpDirPath });\n154.       serviceInstance = new Service(serverless);\n155. \n156.       return serviceInstance.load().then(() => {\n157.         expect(serviceInstance.service).to.be.equal(\'new-service\');\n158.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n159.         expect(serviceInstance.defaults.variableSyntax).to.equal(\'\\\\${{([\\\\s\\\\S]+?)}}\');\n160.         expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n161.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n162.         expect(serviceInstance.resources.azure).to.deep.equal({});\n163.         expect(serviceInstance.resources.google).to.deep.equal({});\n164.         expect(serviceInstance.package.exclude.length).to.equal(1);\n165.         expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n166.         expect(serviceInstance.package.include.length).to.equal(1);\n167.         expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n168.         expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n169.       });\n170.     });\n171. \n172.     it(\'should merge resources given as an array\', () => {\n173.       const SUtils = new Utils();\n174.       const serverlessYml = {\n175.         service: \'new-service\',\n176.         provider: \'aws\',\n177.         resources: [\n178.           {\n179.             aws: {\n180.               resourcesProp: \'value\',\n181.             },\n182.           },\n183.           {\n184.             azure: {},\n185.           },\n186.         ],\n187.       };\n188. \n189.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n190.         YAML.dump(serverlessYml));\n191. \n192.       const serverless = new Serverless();\n193.       serverless.init();\n194.       serverless.config.update({ servicePath: tmpDirPath });\n195.       serviceInstance = new Service(serverless);\n196. \n197.       return serviceInstance.load().then(() => {\n198.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n199.         expect(serviceInstance.resources.azure).to.deep.equal({});\n200.       });\n201.     });\n202. \n203.     it(\'should make sure function name contains the default stage\', () => {\n204.       const SUtils = new Utils();\n205.       const serverlessYml = {\n206.         service: \'new-service\',\n207.         provider: \'aws\',\n208.         defaults: {\n209.           stage: \'dev\',\n210.           region: \'us-east-1\',\n211.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n212.         },\n213.         plugins: [\'testPlugin\'],\n214.         functions: {\n215.           functionA: {},\n216.         },\n217.         resources: {\n218.           aws: {\n219.             resourcesProp: \'value\',\n220.           },\n221.           azure: {},\n222.           google: {},\n223.         },\n224.         package: {\n225.           exclude: [\'exclude-me\'],\n226.           include: [\'include-me\'],\n227.           artifact: \'some/path/foo.zip\',\n228.         },\n229.       };\n230. \n231.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n232.         YAML.dump(serverlessYml));\n233. \n234.       const serverless = new Serverless();\n235.       serverless.init();\n236.       serverless.config.update({ servicePath: tmpDirPath });\n237.       serviceInstance = new Service(serverless);\n238. \n239.       return serviceInstance.load().then(() => {\n240.         expect(serviceInstance.functions.functionA.name).to.be.equal(\'new-service-dev-functionA\');\n241.       });\n242.     });\n243. \n244.     it(\'should support Serverless file with a non-aws provider\', () => {\n245.       const SUtils = new Utils();\n246.       const serverlessYaml = {\n247.         service: \'my-service\',\n248.         provider: \'openwhisk\',\n249.         functions: {\n250.           functionA: {\n251.             name: \'customFunctionName\',\n252.           },\n253.         },\n254.       };\n255. \n256.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n257.         YAML.dump(serverlessYaml));\n258. \n259.       const serverless = new Serverless({ servicePath: tmpDirPath });\n260.       serviceInstance = new Service(serverless);\n261. \n262.       return serviceInstance.load().then(() => {\n263.         const expectedFunc = {\n264.           functionA: {\n265.             name: \'customFunctionName\',\n266.             events: [],\n267.           },\n268.         };\n269.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n270.         expect(serviceInstance.provider.name).to.deep.equal(\'openwhisk\');\n271.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n272.       });\n273.     });\n274. \n275.     it(\'should support Serverless file with a .yaml extension\', () => {\n276.       const SUtils = new Utils();\n277.       const serverlessYaml = {\n278.         service: \'my-service\',\n279.         provider: \'aws\',\n280.         functions: {\n281.           functionA: {\n282.             name: \'customFunctionName\',\n283.           },\n284.         },\n285.       };\n286. \n287.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n288.         YAML.dump(serverlessYaml));\n289. \n290.       const serverless = new Serverless({ servicePath: tmpDirPath });\n291.       serviceInstance = new Service(serverless);\n292. \n293.       return serviceInstance.load().then(() => {\n294.         const expectedFunc = {\n295.           functionA: {\n296.             name: \'customFunctionName\',\n297.             events: [],\n298.           },\n299.         };\n300.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n301.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n302.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n303.       });\n304.     });\n305. \n306.     it(\'should support Serverless file with a .yml extension\', () => {\n307.       const SUtils = new Utils();\n308.       const serverlessYml = {\n309.         service: \'my-service\',\n310.         provider: \'aws\',\n311.         functions: {\n312.           functionA: {},\n313.         },\n314.       };\n315. \n316.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n317.         YAML.dump(serverlessYml));\n318. \n319.       const serverless = new Serverless({ servicePath: tmpDirPath });\n320.       serviceInstance = new Service(serverless);\n321. \n322.       return serviceInstance.load({ stage: \'dev\' }).then(() => {\n323.         const expectedFunc = {\n324.           functionA: {\n325.             name: \'my-service-dev-functionA\',\n326.             events: [],\n327.           },\n328.         };\n329.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n330.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n331.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n332.       });\n333.     });\n334. \n335.     it(\'should throw error if service property is missing\', () => {\n336.       const SUtils = new Utils();\n337.       const serverlessYml = {\n338.         provider: \'aws\',\n339.         functions: {},\n340.       };\n341.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n342.         YAML.dump(serverlessYml));\n343. \n344.       const serverless = new Serverless({ servicePath: tmpDirPath });\n345.       serviceInstance = new Service(serverless);\n346. \n347.       return serviceInstance.load().then(() => {\n348.         // if we reach this, then no error was thrown as expected\n349.         // so make assertion fail intentionally to let us know something is wrong\n350.         expect(1).to.equal(2);\n351.       }).catch(e => {\n352.         expect(e.name).to.be.equal(\'ServerlessError\');\n353.       });\n354.     });\n355. \n356.     it(\'should throw error if provider property is missing\', () => {\n357.       const SUtils = new Utils();\n358.       const serverlessYml = {\n359.         service: \'service-name\',\n360.         functions: {},\n361.       };\n362.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n363.         YAML.dump(serverlessYml));\n364. \n365.       const serverless = new Serverless({ servicePath: tmpDirPath });\n366.       serviceInstance = new Service(serverless);\n367. \n368.       return serviceInstance.load().then(() => {\n369.         // if we reach this, then no error was thrown as expected\n370.         // so make assertion fail intentionally to let us know something is wrong\n371.         expect(1).to.equal(2);\n372.       }).catch(e => {\n373.         expect(e.name).to.be.equal(\'ServerlessError\');\n374.       });\n375.     });\n376. \n377.     it(\'should throw error if frameworkVersion is not satisfied\', () => {\n378.       const SUtils = new Utils();\n379.       const serverlessYml = {\n380.         service: \'service-name\',\n381.         frameworkVersion: \'=1.0.0\',\n382.         provider: \'aws\',\n383.         functions: {},\n384.       };\n385.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n386.         YAML.dump(serverlessYml));\n387. \n388.       const serverless = new Serverless({ servicePath: tmpDirPath });\n389.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n390.       getVersion.returns(\'1.0.2\');\n391.       serviceInstance = new Service(serverless);\n392. \n393.       return serviceInstance.load().then(() => {\n394.         // if we reach this, then no error was thrown as expected\n395.         // so make assertion fail intentionally to let us know something is wrong\n396.         expect(1).to.equal(2);\n397.       }).catch(e => {\n398.         expect(e.name).to.be.equal(\'ServerlessError\');\n399.       });\n400.     });\n401. \n402.     it(\'should pass if frameworkVersion is satisfied\', () => {\n403.       const SUtils = new Utils();\n404.       const serverlessYml = {\n405.         service: \'service-name\',\n406.         frameworkVersion: \'>=1.0.0\',\n407.         provider: \'aws\',\n408.         functions: {},\n409.       };\n410.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n411.         YAML.dump(serverlessYml));\n412. \n413.       const serverless = new Serverless({ servicePath: tmpDirPath });\n414.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n415.       getVersion.returns(\'1.2.2\');\n416.       serviceInstance = new Service(serverless);\n417. \n418.       return serviceInstance.load().then(() => {\n419.         // if this callbar is reached, then no error was thrown as expected\n420.         expect(1).to.equal(1);\n421.       });\n422.     });\n423. \n424.     it(\'should not throw error if functions property is missing\', () => {\n425.       const SUtils = new Utils();\n426.       const serverlessYml = {\n427.         service: \'service-name\',\n428.         provider: \'aws\',\n429.       };\n430.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n431.         YAML.dump(serverlessYml));\n432. \n433.       const serverless = new Serverless({ servicePath: tmpDirPath });\n434.       serviceInstance = new Service(serverless);\n435. \n436.       return serviceInstance.load().then(() => {\n437.         expect(serverless.service.functions).to.deep.equal({});\n438.       });\n439.     });\n440. \n441.     it("should throw error if a function\'s event is not an array", () => {\n442.       const SUtils = new Utils();\n443.       const serverlessYml = {\n444.         service: \'service-name\',\n445.         provider: \'aws\',\n446.         functions: {\n447.           functionA: {\n448.             events: {},\n449.           },\n450.         },\n451.       };\n452.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n453.         YAML.dump(serverlessYml));\n454. \n455.       const serverless = new Serverless({ servicePath: tmpDirPath });\n456.       serviceInstance = new Service(serverless);\n457. \n458.       return serviceInstance.load().then(() => {\n459.         // if we reach this, then no error was thrown as expected\n460.         // so make assertion fail intentionally to let us know something is wrong\n461.         expect(1).to.equal(2);\n462.       }).catch(e => {\n463.         expect(e.name).to.be.equal(\'ServerlessError\');\n464.       });\n465.     });\n466. \n467.     it(\'should throw error if provider property is invalid\', () => {\n468.       const SUtils = new Utils();\n469.       const serverlessYml = {\n470.         service: \'service-name\',\n471.         provider: \'invalid\',\n472.         functions: {},\n473.       };\n474. \n475.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n476.         YAML.dump(serverlessYml));\n477. \n478.       const serverless = new Serverless({ servicePath: tmpDirPath });\n479.       serviceInstance = new Service(serverless);\n480. \n481.       return serviceInstance.load().then(() => {\n482.         // if we reach this, then no error was thrown as expected\n483.         // so make assertion fail intentionally to let us know something is wrong\n484.         expect(1).to.equal(2);\n485.       }).catch(e => {\n486.         expect(e.name).to.be.equal(\'ServerlessError\');\n487.       });\n488.     });\n489.   });\n490. \n491.   describe(\'#update()\', () => {\n492.     it(\'should update service instance data\', () => {\n493.       const serverless = new Serverless();\n494.       const serviceInstance = new Service(serverless);\n495.       const newData = { service: \'newName\' };\n496.       const updatedInstance = serviceInstance.update(newData);\n497.       expect(updatedInstance.service).to.be.equal(\'newName\');\n498.     });\n499.   });\n500. ', start_line_number=1, end_line_number=500), Context(relative_path='lib/classes/YamlParser.test.js', content="1. 'use strict';\n2. \n3. /**\n4.  * Test: YamlParser Function Class\n5.  */\n6. \n7. const expect = require('chai').expect;\n8. const YAML = require('js-yaml');\n9. const path = require('path');\n10. const Serverless = require('../../lib/Serverless');\n11. const testUtils = require('../../tests/utils');\n12. \n13. const serverless = new Serverless();\n14. \n15. describe('YamlParser', () => {\n16.   describe('#parse()', () => {\n17.     it('should parse a simple .yaml file', () => {\n18.       const tmpFilePath = testUtils.getTmpFilePath('simple.yaml');\n19. \n20.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));\n21. \n22.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n23.         expect(obj.foo).to.equal('bar');\n24.       });\n25.     });\n26. \n27.     it('should parse a simple .yml file', () => {\n28.       const tmpFilePath = testUtils.getTmpFilePath('simple.yml');\n29. \n30.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));\n31. \n32.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n33.         expect(obj.foo).to.equal('bar');\n34.       });\n35.     });\n36. \n37.     it('should parse a .yml file with JSON-REF to YAML', () => {\n38.       const tmpDirPath = testUtils.getTmpDirPath();\n39. \n40.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.yml'), { foo: 'bar' });\n41. \n42.       const testYml = {\n43.         main: {\n44.           $ref: './ref.yml',\n45.         },\n46.       };\n47. \n48.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);\n49. \n50.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {\n51.         expect(obj.main.foo).to.equal('bar');\n52.       });\n53.     });\n54. \n55.     it('should parse a .yml file with JSON-REF to JSON', () => {\n56.       const tmpDirPath = testUtils.getTmpDirPath();\n57. \n58.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.json'), { foo: 'bar' });\n59. \n60.       const testYml = {\n61.         main: {\n62.           $ref: './ref.json',\n63.         },\n64.       };\n65. \n66.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);\n67. \n68.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {\n69.         expect(obj.main.foo).to.equal('bar');\n70.       });\n71.     });\n72. \n73.     it('should parse a .yml file with recursive JSON-REF', () => {\n74.       const tmpDirPath = testUtils.getTmpDirPath();\n75. \n76.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'three.yml'), { foo: 'bar' });\n77. \n78.       const twoYml = {\n79.         two: {\n80.           $ref: './three.yml',\n81.         },\n82.       };\n83. \n84.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'two.yml'), twoYml);\n85. \n86.       const oneYml = {\n87.         one: {\n88.           $ref: './two.yml',\n89.         },\n90.       };\n91. \n92.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'one.yml'), oneYml);\n93. \n94.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'one.yml')).then((obj) => {\n95.         expect(obj.one.two.foo).to.equal('bar');\n96.       });\n97.     });\n98.   });\n99. });", start_line_number=1, end_line_number=99), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n47. \n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n96. \n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n107.           }\n108.         });\n109.       }\n110.     });\n111.   }\n112. }\n113. module.exports = AwsCompileIoTEvents;', start_line_number=1, end_line_number=113), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.test.js', content='1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsProvider = require(\'../../../../provider/awsProvider\');\n5. const AwsCompileIoTEvents = require(\'./index\');\n6. const Serverless = require(\'../../../../../../Serverless\');\n7. \n8. describe(\'AwsCompileIoTEvents\', () => {\n9.   let serverless;\n10.   let awsCompileIoTEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n15.     serverless.setProvider(\'aws\', new AwsProvider(serverless));\n16.     awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);\n17.     awsCompileIoTEvents.serverless.service.service = \'new-service\';\n18.   });\n19. \n20.   describe(\'#constructor()\', () => {\n21.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n22.       expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));\n23.   });\n24. \n25.   describe(\'#awsCompileIoTEvents()\', () => {\n26.     it(\'should throw an error if iot event type is not an object\', () => {\n27.       awsCompileIoTEvents.serverless.service.functions = {\n28.         first: {\n29.           events: [\n30.             {\n31.               iot: \'iot\',\n32.             },\n33.           ],\n34.         },\n35.       };\n36. \n37.       expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);\n38.     });\n39. \n40.     it(\'should create corresponding resources when iot events are given\', () => {\n41.       awsCompileIoTEvents.serverless.service.functions = {\n42.         first: {\n43.           events: [\n44.             {\n45.               iot: {\n46.                 sql: "SELECT * FROM \'topic_1\'",\n47.               },\n48.             },\n49.             {\n50.               iot: {\n51.                 sql: "SELECT * FROM \'topic_2\'",\n52.               },\n53.             },\n54.           ],\n55.         },\n56.       };\n57. \n58.       awsCompileIoTEvents.compileIoTEvents();\n59. \n60.       expect(awsCompileIoTEvents.serverless.service\n61.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type\n62.       ).to.equal(\'AWS::IoT::TopicRule\');\n63.       expect(awsCompileIoTEvents.serverless.service\n64.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type\n65.       ).to.equal(\'AWS::IoT::TopicRule\');\n66.       expect(awsCompileIoTEvents.serverless.service\n67.         .provider.compiledCloudFormationTemplate.Resources\n68.         .FirstIotTopicRule1.Properties.TopicRulePayload.Sql\n69.       ).to.equal(\'SELECT * FROM \\\'topic_1\\\'\');\n70.       expect(awsCompileIoTEvents.serverless.service\n71.         .provider.compiledCloudFormationTemplate.Resources\n72.         .FirstIotTopicRule2.Properties.TopicRulePayload.Sql\n73.       ).to.equal(\'SELECT * FROM \\\'topic_2\\\'\');\n74.       expect(awsCompileIoTEvents.serverless.service\n75.         .provider.compiledCloudFormationTemplate.Resources\n76.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n77.       ).to.equal(\'false\');\n78.       expect(awsCompileIoTEvents.serverless.service\n79.         .provider.compiledCloudFormationTemplate.Resources\n80.         .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled\n81.       ).to.equal(\'false\');\n82.       expect(awsCompileIoTEvents.serverless.service\n83.         .provider.compiledCloudFormationTemplate.Resources\n84.         .FirstLambdaPermissionIotTopicRule1.Type\n85.       ).to.equal(\'AWS::Lambda::Permission\');\n86.       expect(awsCompileIoTEvents.serverless.service\n87.         .provider.compiledCloudFormationTemplate.Resources\n88.         .FirstLambdaPermissionIotTopicRule2.Type\n89.       ).to.equal(\'AWS::Lambda::Permission\');\n90.     });\n91. \n92.     it(\'should respect "name" variable\', () => {\n93.       awsCompileIoTEvents.serverless.service.functions = {\n94.         first: {\n95.           events: [\n96.             {\n97.               iot: {\n98.                 name: \'iotEvantName\',\n99.                 sql: "SELECT * FROM \'topic_1\'",\n100.               },\n101.             },\n102.           ],\n103.         },\n104.       };\n105. \n106.       awsCompileIoTEvents.compileIoTEvents();\n107. \n108.       expect(awsCompileIoTEvents.serverless.service\n109.         .provider.compiledCloudFormationTemplate.Resources\n110.         .FirstIotTopicRule1.Properties.RuleName\n111.       ).to.equal(\'iotEvantName\');\n112.     });\n113. \n114.     it(\'should respect "enabled" variable\', () => {\n115.       awsCompileIoTEvents.serverless.service.functions = {\n116.         first: {\n117.           events: [\n118.             {\n119.               iot: {\n120.                 enabled: false,\n121.                 sql: "SELECT * FROM \'topic_1\'",\n122.               },\n123.             },\n124.           ],\n125.         },\n126.         second: {\n127.           events: [\n128.             {\n129.               iot: {\n130.                 enabled: true,\n131.                 sql: "SELECT * FROM \'topic_1\'",\n132.               },\n133.             },\n134.           ],\n135.         },\n136.       };\n137. \n138.       awsCompileIoTEvents.compileIoTEvents();\n139. \n140.       expect(awsCompileIoTEvents.serverless.service\n141.         .provider.compiledCloudFormationTemplate.Resources\n142.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n143.       ).to.equal(\'true\');\n144.       expect(awsCompileIoTEvents.serverless.service\n145.         .provider.compiledCloudFormationTemplate.Resources\n146.         .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n147.       ).to.equal(\'false\');\n148.     });\n149. \n150.     it(\'should respect "sqlVersion" variable\', () => {\n151.       awsCompileIoTEvents.serverless.service.functions = {\n152.         first: {\n153.           events: [\n154.             {\n155.               iot: {\n156.                 sqlVersion: \'2016-03-23\',\n157.                 sql: "SELECT * FROM \'topic_1\'",\n158.               },\n159.             },\n160.           ],\n161.         },\n162.       };\n163. \n164.       awsCompileIoTEvents.compileIoTEvents();\n165. \n166.       expect(awsCompileIoTEvents.serverless.service\n167.         .provider.compiledCloudFormationTemplate.Resources\n168.         .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion\n169.       ).to.equal(\'2016-03-23\');\n170.     });\n171. \n172.     it(\'should respect "description" variable\', () => {\n173.       awsCompileIoTEvents.serverless.service.functions = {\n174.         first: {\n175.           events: [\n176.             {\n177.               iot: {\n178.                 description: \'iot event description\',\n179.                 sql: "SELECT * FROM \'topic_1\'",\n180.               },\n181.             },\n182.           ],\n183.         },\n184.       };\n185. \n186.       awsCompileIoTEvents.compileIoTEvents();\n187. \n188.       expect(awsCompileIoTEvents.serverless.service\n189.         .provider.compiledCloudFormationTemplate.Resources\n190.         .FirstIotTopicRule1.Properties.TopicRulePayload.Description\n191.       ).to.equal(\'iot event description\');\n192.     });\n193. \n194.     it(\'should respect enabled variable if the "enabled" property is not given\', () => {\n195.       awsCompileIoTEvents.serverless.service.functions = {\n196.         first: {\n197.           events: [\n198.             {\n199.               iot: {\n200.                 sql: "SELECT * FROM \'topic_1\'",\n201.               },\n202.             },\n203.           ],\n204.         },\n205.       };\n206. \n207.       awsCompileIoTEvents.compileIoTEvents();\n208. \n209.       expect(awsCompileIoTEvents.serverless.service\n210.         .provider.compiledCloudFormationTemplate.Resources\n211.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n212.       ).to.equal(\'false\');\n213.     });\n214. \n215.     it(\'should not create corresponding resources when iot events are not given\', () => {\n216.       awsCompileIoTEvents.serverless.service.functions = {\n217.         first: {\n218.           events: [],\n219.         },\n220.       };\n221. \n222.       awsCompileIoTEvents.compileIoTEvents();\n223. \n224.       expect(awsCompileIoTEvents.serverless.service\n225.         .provider.compiledCloudFormationTemplate.Resources\n226.       ).to.deep.equal({});\n227.     });\n228.   });\n229. });', start_line_number=1, end_line_number=229), Context(relative_path='lib/plugins/aws/lib/naming.test.js', content='1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. \n5. const SDK = require(\'../provider/awsProvider\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. describe(\'#naming()\', () => {\n9.   let options;\n10.   let serverless;\n11.   let sdk;\n12. \n13.   beforeEach(() => {\n14.     options = {\n15.       stage: \'dev\',\n16.       region: \'us-east-1\',\n17.     };\n18.     serverless = new Serverless(options);\n19.     sdk = new SDK(serverless, options);\n20.   });\n21. \n22.   describe(\'#normalizeName()\', () => {\n23.     it(\'should capitalize the first letter\', () => {\n24.       expect(sdk.naming.normalizeName(\'name\')).to.equal(\'Name\');\n25.     });\n26. \n27.     it(\'should have no effect on caps\', () => {\n28.       expect(sdk.naming.normalizeName(\'Name\')).to.equal(\'Name\');\n29.     });\n30. \n31.     it(\'should have no effect on the rest of the name\', () => {\n32.       expect(sdk.naming.normalizeName(\'nAME\')).to.equal(\'NAME\');\n33.     });\n34.   });\n35. \n36.   describe(\'#normalizeNameToAlphaNumericOnly()\', () => {\n37.     it(\'should strip non-alpha-numeric characters\', () => {\n38.       expect(sdk.naming\n39.         .normalizeNameToAlphaNumericOnly(\'`!@#$%^&*()-={}|[]\\\\:";\\\'<>?,./\')).to.equal(\'\');\n40.     });\n41. \n42.     it(\'should apply normalizeName to the remaining characters\', () => {\n43.       expect(sdk.naming.normalizeNameToAlphaNumericOnly(\'a-b-c\')).to.equal(\'Abc\');\n44.     });\n45.   });\n46. \n47.   describe(\'#normalizePathPart()\', () => {\n48.     it(\'converts `-` to `Dash`\', () => {\n49.       expect(sdk.naming.normalizePathPart(\n50.         \'a-path\'\n51.       )).to.equal(\'ADashpath\');\n52.     });\n53. \n54.     it(\'converts variable declarations (`${var}`) to `VariableVar`\', () => {\n55.       expect(sdk.naming.normalizePathPart(\n56.         \'${variable}\'\n57.       )).to.equal(\'VariableVar\');\n58.     });\n59. \n60.     it(\'converts variable declarations prefixes to `VariableVarpath`\', () => {\n61.       expect(sdk.naming.normalizePathPart(\n62.         \'${variable}Path\'\n63.       )).to.equal(\'VariableVarpath\');\n64.     });\n65. \n66.     it(\'converts variable declarations suffixes to `PathvariableVar`\', () => {\n67.       expect(sdk.naming.normalizePathPart(\n68.         \'path${variable}\'\n69.       )).to.equal(\'PathvariableVar\');\n70.     });\n71. \n72.     it(\'converts variable declarations in center to `PathvariableVardir`\', () => {\n73.       expect(sdk.naming.normalizePathPart(\n74.         \'path${variable}Dir\'\n75.       )).to.equal(\'PathvariableVardir\');\n76.     });\n77.   });\n78. \n79.   describe(\'#getServiceEndpointRegex()\', () => {\n80.     it(\'should match the prefix\', () => {\n81.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpoint\'))\n82.         .to.equal(true);\n83.     });\n84. \n85.     it(\'should not match a name without the prefix\', () => {\n86.       expect(sdk.naming.getServiceEndpointRegex()\n87.         .test(\'NotThePrefixServiceEndpoint\')).to.equal(false);\n88.     });\n89. \n90.     it(\'should match a name with the prefix\', () => {\n91.       expect(sdk.naming.getServiceEndpointRegex()\n92.         .test(\'ServiceEndpointForAService\')).to.equal(true);\n93.     });\n94.   });\n95. \n96.   describe(\'#getStackName()\', () => {\n97.     it(\'should use the service name and stage from the service and config\', () => {\n98.       serverless.service.service = \'myService\';\n99.       expect(sdk.naming.getStackName()).to.equal(`${serverless.service.service}-${options.stage}`);\n100.     });\n101.   });\n102. \n103.   describe(\'#getRolePath()\', () => {\n104.     it(\'should return `/`\', () => {\n105.       expect(sdk.naming.getRolePath()).to.equal(\'/\');\n106.     });\n107.   });\n108. \n109.   describe(\'#getRoleName()\', () => {\n110.     it(\'uses the service name, stage, and region to generate a role name\', () => {\n111.       serverless.service.service = \'myService\';\n112.       expect(sdk.naming.getRoleName()).to.eql({\n113.         \'Fn::Join\': [\n114.           \'-\',\n115.           [\n116.             serverless.service.service,\n117.             options.stage,\n118.             options.region,\n119.             \'lambdaRole\',\n120.           ],\n121.         ],\n122.       });\n123.     });\n124.   });\n125. \n126.   describe(\'#getRoleLogicalId()\', () => {\n127.     it(\'should return the expected role name (IamRoleLambdaExecution)\', () => {\n128.       expect(sdk.naming.getRoleLogicalId()).to.equal(\'IamRoleLambdaExecution\');\n129.     });\n130.   });\n131. \n132.   describe(\'#getPolicyName()\', () => {\n133.     it(\'should use the stage and service name\', () => {\n134.       serverless.service.service = \'myService\';\n135.       expect(sdk.naming.getPolicyName()).to.eql({\n136.         \'Fn::Join\': [\n137.           \'-\',\n138.           [\n139.             options.stage,\n140.             serverless.service.service,\n141.             \'lambda\',\n142.           ],\n143.         ],\n144.       });\n145.     });\n146.   });\n147. \n148.   describe(\'#getPolicyLogicalId()\', () => {\n149.     it(\'should return the expected policy name (IamPolicyLambdaExecution)\', () => {\n150.       expect(sdk.naming.getPolicyLogicalId()).to.equal(\'IamPolicyLambdaExecution\');\n151.     });\n152.   });\n153. \n154.   describe(\'#getLogicalLogGroupName()\', () => {\n155.     it(\'should prefix the normalized function name to "LogGroup"\', () => {\n156.       expect(sdk.naming.getLogGroupLogicalId(\'functionName\')).to.equal(\'FunctionNameLogGroup\');\n157.     });\n158.   });\n159. \n160.   describe(\'#getLogGroupName()\', () => {\n161.     it(\'should add the function name to the log group name\', () => {\n162.       expect(sdk.naming.getLogGroupName(\'functionName\')).to.equal(\'/aws/lambda/functionName\');\n163.     });\n164.   });\n165. \n166.   describe(\'#getNormalizedFunctionName()\', () => {\n167.     it(\'should normalize the given functionName\', () => {\n168.       expect(sdk.naming.getNormalizedFunctionName(\'functionName\'))\n169.         .to.equal(\'FunctionName\');\n170.     });\n171. \n172.     it(\'should normalize the given functionName with an underscore\', () => {\n173.       expect(sdk.naming.getNormalizedFunctionName(\'hello_world\'))\n174.         .to.equal(\'HelloUnderscoreworld\');\n175.     });\n176. \n177.     it(\'should normalize the given functionName with a dash\', () => {\n178.       expect(sdk.naming.getNormalizedFunctionName(\'hello-world\'))\n179.         .to.equal(\'HelloDashworld\');\n180.     });\n181.   });\n182. \n183.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n184.     it(\'should extract everything after the last colon and dash\', () => {\n185.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n186.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n187.     });\n188.   });\n189. \n190.   describe(\'#extractLambdaNameFromArn()\', () => {\n191.     it(\'should extract everything after the last colon\', () => {\n192.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n193.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal(\'my-dev-lambda\');\n194.     });\n195.   });\n196. \n197.   describe(\'#getLambdaLogicalId()\', () => {\n198.     it(\'should normalize the function name and add the logical suffix\', () => {\n199.       expect(sdk.naming.getLambdaLogicalId(\'functionName\'))\n200.         .to.equal(\'FunctionNameLambdaFunction\');\n201.     });\n202.   });\n203. \n204.   describe(\'#getLambdaLogicalIdRegex()\', () => {\n205.     it(\'should match the suffix\', () => {\n206.       expect(sdk.naming.getLambdaLogicalIdRegex()\n207.         .test(\'LambdaFunction\')).to.equal(true);\n208.     });\n209. \n210.     it(\'should not match a name without the suffix\', () => {\n211.       expect(sdk.naming.getLambdaLogicalIdRegex()\n212.         .test(\'LambdaFunctionNotTheSuffix\')).to.equal(false);\n213.     });\n214. \n215.     it(\'should match a name with the suffix\', () => {\n216.       expect(sdk.naming.getLambdaLogicalIdRegex()\n217.         .test(\'AFunctionNameLambdaFunction\')).to.equal(true);\n218.     });\n219.   });\n220. \n221.   describe(\'#getLambdaOutputLogicalId()\', () => {\n222.     it(\'should normalize the function name and add the logical arn suffix\', () => {\n223.       expect(\n224.         sdk.naming.getLambdaOutputLogicalId(\'functionName\')\n225.       ).to.equal(\'FunctionNameLambdaFunctionArn\');\n226.     });\n227.   });\n228. \n229.   describe(\'#getLambdaOutputLogicalIdRegex()\', () => {\n230.     it(\'should match the suffix\', () => {\n231.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n232.         .test(\'aLambdaFunctionArn\')).to.equal(true);\n233.     });\n234. \n235.     it(\'should not match a name without the suffix\', () => {\n236.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n237.         .test(\'LambdaFunctionArnNotTheSuffix\'))\n238.         .to.equal(false);\n239.     });\n240. \n241.     it(\'should match a name with the suffix\', () => {\n242.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n243.         .test(\'AFunctionArnNameLambdaFunctionArn\'))\n244.         .to.equal(true);\n245.     });\n246.   });\n247. \n248.   describe(\'#getApiGatewayName()\', () => {\n249.     it(\'should return the composition of stage and service name\', () => {\n250.       serverless.service.service = \'myService\';\n251.       expect(sdk.naming.getApiGatewayName())\n252.         .to.equal(`${options.stage}-${serverless.service.service}`);\n253.     });\n254.   });\n255. \n256.   describe(\'#generateApiGatewayDeploymentLogicalId()\', () => {\n257.     it(\'should return ApiGatewayDeployment with a date based suffix\', () => {\n258.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId()\n259.         .match(/ApiGatewayDeployment(.*)/).length)\n260.         .to.be.greaterThan(1);\n261.     });\n262.   });\n263. \n264.   describe(\'#getRestApiLogicalId()\', () => {\n265.     it(\'should return ApiGatewayRestApi\', () => {\n266.       expect(sdk.naming.getRestApiLogicalId()).to.equal(\'ApiGatewayRestApi\');\n267.     });\n268.   });\n269. \n270.   describe(\'#getNormalizedAuthorizerName()\', () => {\n271.     it(\'normalize the authorizer name\', () => {\n272.       expect(sdk.naming.getNormalizedAuthorizerName(\'authorizerName\'))\n273.         .to.equal(\'AuthorizerName\');\n274.     });\n275.   });\n276. \n277.   describe(\'#getAuthorizerLogicalId()\', () => {\n278.     it(\'should normalize the authorizer name and add the standard suffix\', () => {\n279.       expect(sdk.naming.getAuthorizerLogicalId(\'authorizerName\'))\n280.         .to.equal(\'AuthorizerNameApiGatewayAuthorizer\');\n281.     });\n282.   });\n283. \n284.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n285.     it(\'should extract the authorizer name from an ARN\', () => {\n286.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n287.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n288.     });\n289.   });\n290. \n291.   describe(\'#normalizePath()\', () => {\n292.     it(\'should normalize each part of the resource path and remove non-alpha-numeric characters\',\n293.       () => {\n294.         expect(sdk.naming.normalizePath(\n295.           \'my/path/to/a-${var}-resource\'\n296.         )).to.equal(\'MyPathToADashvarVarDashresource\');\n297.       });\n298.   });\n299. \n300.   describe(\'#getResourceLogicalId()\', () => {\n301.     it(\'should normalize the resource and add the standard suffix\', () => {\n302.       expect(sdk.naming.getResourceLogicalId(\n303.         \'my/path/to/a-${var}-resource\'\n304.       )).to.equal(\'ApiGatewayResourceMyPathToADashvarVarDashresource\');\n305.     });\n306.   });\n307. \n308.   describe(\'#extractResourceId()\', () => {\n309.     it(\'should extract the normalized resource name\', () => {\n310.       expect(sdk.naming.extractResourceId(\n311.         \'ApiGatewayResourceMyPathToADashvarVarDashResource\'\n312.       )).to.equal(\'MyPathToADashvarVarDashResource\');\n313.     });\n314.   });\n315. \n316.   describe(\'#normalizeMethodName()\', () => {\n317.     it(\'should capitalize the first letter and lowercase any other characters\', () => {\n318.       expect(sdk.naming.normalizeMethodName(\'gET\')).to.equal(\'Get\');\n319.     });\n320.   });\n321. \n322.   describe(\'#getMethodLogicalId()\', () => {\n323.     it(\'\', () => {\n324.       expect(sdk.naming.getMethodLogicalId(\n325.         \'ResourceId\', \'get\'\n326.       )).to.equal(\'ApiGatewayMethodResourceIdGet\');\n327.     });\n328.   });\n329. \n330.   describe(\'#getApiKeyLogicalId(keyIndex)\', () => {\n331.     it(\'should produce the given index with ApiGatewayApiKey as a prefix\', () => {\n332.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal(\'ApiGatewayApiKey1\');\n333.     });\n334.   });\n335. \n336.   describe(\'#getApiKeyLogicalIdRegex()\', () => {\n337.     it(\'should match the prefix\', () => {\n338.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n339.         .test(\'ApiGatewayApiKey\')).to.equal(true);\n340.     });\n341. \n342.     it(\'should not match a name without the prefix\', () => {\n343.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n344.         .test(\'NotThePrefixApiGatewayApiKey\')).to.equal(false);\n345.     });\n346. \n347.     it(\'should match a name with the prefix\', () => {\n348.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n349.         .test(\'ApiGatewayApiKeySuffix\')).to.equal(true);\n350.     });\n351.   });\n352. \n353.   describe(\'#getDeploymentBucketLogicalId()\', () => {\n354.     it(\'should return "ServerlessDeploymentBucket"\', () => {\n355.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal(\'ServerlessDeploymentBucket\');\n356.     });\n357.   });\n358. \n359.   describe(\'#getDeploymentBucketOutputLogicalId()\', () => {\n360.     it(\'should return "ServerlessDeploymentBucketName"\', () => {\n361.       expect(sdk.naming.getDeploymentBucketOutputLogicalId())\n362.         .to.equal(\'ServerlessDeploymentBucketName\');\n363.     });\n364.   });\n365. \n366.   describe(\'#normalizeBucketName()\', () => {\n367.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n368.       expect(sdk.naming.normalizeBucketName(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'BucketName\');\n369.     });\n370.   });\n371. \n372.   describe(\'#getBucketLogicalId()\', () => {\n373.     it(\'should normalize the bucket name and add the standard prefix\', () => {\n374.       expect(sdk.naming.getBucketLogicalId(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'S3BucketBucketName\');\n375.     });\n376.   });\n377. \n378.   describe(\'#normalizeTopicName()\', () => {\n379.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n380.       expect(sdk.naming.normalizeTopicName(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'TopicName\');\n381.     });\n382.   });\n383. \n384.   describe(\'#getTopicLogicalId()\', () => {\n385.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n386.       expect(sdk.naming.getTopicLogicalId(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'SNSTopicTopicName\');\n387.     });\n388.   });\n389. \n390.   describe(\'#getScheduleId()\', () => {\n391.     it(\'should add the standard suffix\', () => {\n392.       expect(sdk.naming.getScheduleId(\'functionName\')).to.equal(\'functionNameSchedule\');\n393.     });\n394.   });\n395. \n396.   describe(\'#getScheduleLogicalId()\', () => {\n397.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n398.       expect(sdk.naming.getScheduleLogicalId(\'functionName\', 0))\n399.         .to.equal(\'FunctionNameEventsRuleSchedule0\');\n400.     });\n401.   });\n402. \n403.   describe(\'#getLambdaS3PermissionLogicalId()\', () => {\n404.     it(\'should normalize the function name and add the standard suffix\', () => {\n405.       expect(sdk.naming.getLambdaS3PermissionLogicalId(\'functionName\', \'bucket\'))\n406.         .to.equal(\'FunctionNameLambdaPermissionBucketS3\');\n407.     });\n408.   });\n409. \n410.   describe(\'#getLambdaSnsPermissionLogicalId()\', () => {\n411.     it(\'should normalize the function and topic names and add them as prefix and suffix to the \' +\n412.       \'standard permission center\', () => {\n413.       expect(sdk.naming.getLambdaSnsPermissionLogicalId(\'functionName\', \'topic\'))\n414.         .to.equal(\'FunctionNameLambdaPermissionTopicSNS\');\n415.     });\n416.   });\n417. \n418.   describe(\'#getLambdaSchedulePermissionLogicalId()\', () => {\n419.     it(\'should normalize the function name and add the standard suffix including event index\',\n420.       () => {\n421.         expect(sdk.naming.getLambdaSchedulePermissionLogicalId(\'functionName\', 0))\n422.           .to.equal(\'FunctionNameLambdaPermissionEventsRuleSchedule0\');\n423.       });\n424.   });\n425. \n426.   describe(\'#getLambdaApiGatewayPermissionLogicalId()\', () => {\n427.     it(\'should normalize the function name and append the standard suffix\', () => {\n428.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId(\'functionName\'))\n429.         .to.equal(\'FunctionNameLambdaPermissionApiGateway\');\n430.     });\n431.   });\n432. \n433.   describe(\'#getIotLogicalId()\', () => {\n434.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n435.       expect(sdk.naming.getIotLogicalId(\'functionName\', 0))\n436.         .to.equal(\'FunctionNameIotTopicRule0\');\n437.     });\n438.   });\n439. \n440.   describe(\'#getLambdaIotPermissionLogicalId()\', () => {\n441.     it(\'should normalize the function name and add the standard suffix including event index\',\n442.       () => {\n443.         expect(sdk.naming.getLambdaIotPermissionLogicalId(\'functionName\', 0))\n444.           .to.equal(\'FunctionNameLambdaPermissionIotTopicRule0\');\n445.       });\n446.   });\n447. \n448.   describe(\'#getLambdaAlexaSkillPermissionLogicalId()\', () => {\n449.     it(\'should normalize the function name and append the standard suffix\',\n450.       () => {\n451.         expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\'))\n452.           .to.equal(\'FunctionNameLambdaPermissionAlexaSkill\');\n453.       });\n454.   });\n455. });', start_line_number=1, end_line_number=455)]
2025-11-14 00:29:13,205 - thread-135845308794560.prometheus.lang_graph.nodes.bug_get_regression_tests_selection_node - DEBUG - Model response: selected_tests=[RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: This test directly exercises the IoT events compilation path that currently fails with multi-line (folded YAML) values due to JSON.parse on the constructed string template. Ensuring resources are created validates that the JSON template is parseable after any fix.\n2. Impact likelihood: Fixing handling of multi-line strings (e.g., escaping or trimming trailing linefeeds) could change how properties are serialized, potentially affecting SQL string equality and RuleDisabled values. This test will catch regressions in overall resource creation and key payload fields.\n3. Normal run inclusion: This is a standard unit test with no skip conditions; it runs in normal test suites.', test_identifier='lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given'), RegressionTestStructuredOutPut(reasoning="1. Relevance to issue: The bug specifically mentions multi-line 'description' causing an unexpected token due to preserved trailing linefeed in the JSON template. This test verifies that the description is correctly propagated into the compiled CloudFormation, making it highly relevant.\n2. Impact likelihood: Any change to escape or normalize multi-line strings could alter how Description is injected (e.g., trimming, escaping). This test will detect unintended changes to Description handling.\n3. Normal run inclusion: This is a normal unit test without skip markers; it runs during standard test execution.", test_identifier='lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: The fix will modify the JSON string construction for IoT TopicRule payload. This test asserts correct inclusion of RuleName, which is built within the same template where Description and Sql are interpolated. Changes to templating can inadvertently affect RuleName emission.\n2. Impact likelihood: If the fix refactors how the JSON template is constructed (e.g., using JSON serialization instead of string concatenation), it could impact optional fields emission like RuleName. This test serves as a guard against such regressions.\n3. Normal run inclusion: It is a regular unit test with no skip annotation, included in standard runs.', test_identifier='lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable'), RegressionTestStructuredOutPut(reasoning="1. Relevance to issue: The bug fix may adjust how values are serialized in the JSON payload. This test asserts the resulting RuleDisabled value, which resides next to Sql/Description in the same payload. Ensuring its value remains correct guards against collateral changes.\n2. Impact likelihood: Moving to safer serialization could change types (e.g., string 'false' to boolean false). This test will detect such breaking changes that affect existing expectations.\n3. Normal run inclusion: This is included in normal test runs; no skip is present.", test_identifier='lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: The IoT event compilation constructs the TopicRulePayload including AwsIotSqlVersion along with Sql/Description. Changes to the templating approach to fix multi-line handling could impact inclusion or formatting of sqlVersion.\n2. Impact likelihood: Refactoring the template to use JSON serialization or escaping may alter optional property handling. This test will catch regressions where sqlVersion is omitted or incorrectly formatted.\n3. Normal run inclusion: This is a standard unit test; it is not skipped and runs by default.', test_identifier='lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable')]
2025-11-14 00:29:13,206 - thread-135845308794560.prometheus.lang_graph.nodes.bug_get_regression_tests_selection_node - DEBUG - 5 tests selected as regression tests
2025-11-14 00:29:13,207 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-14 00:29:13,207 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:29:19,365 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hifSBaQ6Pb0wYwW2c9HvBpbR', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 474, 'prompt_tokens': 724, 'total_tokens': 1198, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d92ec39e-3711-4669-98b6-5276b9bd1b7d-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_hifSBaQ6Pb0wYwW2c9HvBpbR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 724, 'output_tokens': 474, 'total_tokens': 1198, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-14 00:29:19,368 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-14 00:29:19,470 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:19,470 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 680
drwxr-xr-x   1 root root   4096 Aug 28 02:31 [0m[01;34m.[0m
drwxr-xr-x   1 root root   4096 Nov 14 00:26 [01;34m..[0m
-rw-rw-r--   1 root root    232 Aug 28 02:31 .editorconfig
-rw-rw-r--   1 root root     45 Aug 28 02:31 .eslintignore
-rw-rw-r--   1 root root    339 Aug 28 02:31 .eslintrc.js
drwxrwxr-x   7 root root   4096 Aug 28 02:31 [01;34m.git[0m
drwxrwxr-x   2 root root   4096 Aug 28 02:31 [01;34m.github[0m
-rwxrwxr-x   1 root root    691 Aug 28 02:31 [01;32m.gitignore[0m
-rw-rw-r--   1 root root   1512 Aug 28 02:31 .jsbeautifyrc
-rw-rw-r--   1 root root   3934 Aug 28 02:31 .travis.yml
-rw-rw-r--   1 root root   5151 Aug 28 02:31 0.5.x-RESOURCES.md
-rw-rw-r--   1 root root   9786 Aug 28 02:31 CHANGELOG.md
-rw-rw-r--   1 root root   5927 Aug 28 02:31 CONTRIBUTING.md
-rw-rw-r--   1 root root    130 Aug 28 02:31 Dockerfile
-rw-rw-r--   1 root root   1439 Aug 28 02:31 LICENSE.txt
-rwxrwxr-x   1 root root  25723 Aug 28 02:31 [01;32mREADME.md[0m
-rw-rw-r--   1 root root   3092 Aug 28 02:31 RELEASE_CHECKLIST.md
drwxrwxr-x   2 root root   4096 Aug 28 02:31 [01;34mbin[0m
-rw-rw-r--   1 root root   3290 Aug 28 02:31 code_of_conduct.md
-rw-rw-r--   1 root root    992 Aug 28 02:31 docker-compose.yml
drwxrwxr-x   3 root root   4096 Aug 28 02:31 [01;34mdocs[0m
drwxrwxr-x   4 root root   4096 Aug 28 02:31 [01;34mlib[0m
drwxr-xr-x 626 root root  20480 Aug 28 02:31 [01;34mnode_modules[0m
-rw-rw-r--   1 root root 531492 Aug 28 02:31 npm-shrinkwrap.json
-rw-rw-r--   1 root root   2930 Aug 28 02:31 package.json
drwxrwxr-x   2 root root   4096 Aug 28 02:31 [01;34mscripts[0m
drwxrwxr-x   6 root root   4096 Aug 28 02:31 [01;34mtests[0m
[?2004l
2025-11-14 00:29:21,261 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_GHU8DawdRdUJiBiq3AvaJIKs', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 1594, 'total_tokens': 1620, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4fb8e8b3-fcf2-4756-97ed-458ece3bf0fb-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_GHU8DawdRdUJiBiq3AvaJIKs', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1594, 'output_tokens': 26, 'total_tokens': 1620, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:29:21,264 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-14 00:29:21,365 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:21,365 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.5.0",
  "engines": {
    "node": ">=4.0"
  },
  "preferGlobal": true,
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "author": "serverless.com",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/serverless/serverless"
  },
  "keywords": [
    "serverless",
    "serverless framework",
    "serverless applications",
    "serverless modules",
    "api gateway",
    "lambda",
    "aws",
    "aws lambda",
    "amazon",
    "amazon web services",
    "azure",
    "azure functions",
    "google cloud functions",
    "ibm open whisk",
    "iot",
    "internet of things",
    "serverless.com"
  ],
  "files": [
    "bin",
    "lib",
    "scripts/postinstall.js",
    "scripts/preuninstall.js",
    "package.json",
    "npm-shrinkwrap.json",
    "README.md",
    "LICENSE.txt",
    "CHANGELOG.md"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless",
    "slss": "./bin/serverless",
    "sls": "./bin/serverless"
  },
  "scripts": {
    "test": "istanbul cover -x '**/*.test.js' node_modules/mocha/bin/_mocha '!(node_modules)/**/*.test.js' -- -R spec --recursive",
    "lint": "eslint . --cache",
    "docs": "node scripts/generate-readme.js",
    "simple-integration-test": "jest --maxWorkers=5 simple-suite",
    "complex-integration-test": "jest --maxWorkers=5 integration",
    "postinstall": "node ./scripts/postinstall.js",
    "preuninstall": "node ./scripts/preuninstall.js"
  },
  "jest": {
    "testRegex": "(\\.|/)(tests)\\.js$",
    "setupTestFrameworkScriptFile": "<rootDir>/tests/setupTests.js"
  },
  "devDependencies": {
    "chai": "^3.5.0",
    "coveralls": "^2.11.12",
    "eslint": "^3.3.1",
    "eslint-config-airbnb": "^10.0.1",
    "eslint-config-airbnb-base": "^5.0.2",
    "eslint-plugin-import": "^1.13.0",
    "eslint-plugin-jsx-a11y": "^2.1.0",
    "eslint-plugin-react": "^6.1.1",
    "istanbul": "^0.4.4",
    "jest-cli": "^18.0.0",
    "jszip": "^3.1.2",
    "markdown-magic": "0.1.0",
    "mocha": "^3.0.2",
    "mocha-lcov-reporter": "^1.2.0",
    "mock-require": "^1.3.0",
    "proxyquire": "^1.7.10",
    "sinon": "^1.17.5"
  },
  "dependencies": {
    "archiver": "^1.1.0",
    "async": "^1.5.2",
    "aws-sdk": "^2.7.13",
    "bluebird": "^3.4.0",
    "chalk": "^1.1.1",
    "download": "^5.0.2",
    "filesize": "^3.3.0",
    "fs-extra": "^0.26.7",
    "get-stdin": "^5.0.1",
    "glob-all": "^3.1.0",
    "https-proxy-agent": "^1.0.0",
    "js-yaml": "^3.6.1",
    "json-refs": "^2.1.5",
    "lodash": "^4.13.1",
    "minimist": "^1.2.0",
    "moment": "^2.13.0",
    "node-fetch": "^1.5.3",
    "replaceall": "^0.1.6",
    "semver": "^5.0.3",
    "semver-regex": "^1.0.0",
    "shelljs": "^0.6.0",
    "traverse": "^0.6.6",
    "uuid": "^2.0.2"
  }
}
[?2004l
2025-11-14 00:29:25,925 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JDJgq51X7iKVPzuOcLhEq2tS', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 429, 'prompt_tokens': 2646, 'total_tokens': 3075, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8062d6e6-4f43-424a-a9ed-18a6bb7ec490-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}, 'id': 'call_JDJgq51X7iKVPzuOcLhEq2tS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2646, 'output_tokens': 429, 'total_tokens': 3075, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-14 00:29:25,928 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/deploy/compile/events/iot/index.test.js
2025-11-14 00:29:26,030 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:26,030 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/deploy/compile/events
s/iot/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsProvider = require('../../../../provider/awsProvider');
const AwsCompileIoTEvents = require('./index');
const Serverless = require('../../../../../../Serverless');

describe('AwsCompileIoTEvents', () => {
  let serverless;
  let awsCompileIoTEvents;

  beforeEach(() => {
    serverless = new Serverless();
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.setProvider('aws', new AwsProvider(serverless));
    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
    awsCompileIoTEvents.serverless.service.service = 'new-service';
  });

  describe('#constructor()', () => {
    it('should set the provider variable to an instance of AwsProvider', () =>
      expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));
  });

  describe('#awsCompileIoTEvents()', () => {
    it('should throw an error if iot event type is not an object', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: 'iot',
            },
          ],
        },
      };

      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);
    });

    it('should create corresponding resources when iot events are given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sql: "SELECT * FROM 'topic_1'",
              },
            },
            {
              iot: {
                sql: "SELECT * FROM 'topic_2'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type
      ).to.equal('AWS::IoT::TopicRule');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type
      ).to.equal('AWS::IoT::TopicRule');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.Sql
      ).to.equal('SELECT * FROM \'topic_1\'');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule2.Properties.TopicRulePayload.Sql
      ).to.equal('SELECT * FROM \'topic_2\'');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstLambdaPermissionIotTopicRule1.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstLambdaPermissionIotTopicRule2.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should respect "name" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                name: 'iotEvantName',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.RuleName
      ).to.equal('iotEvantName');
    });

    it('should respect "enabled" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                enabled: false,
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
        second: {
          events: [
            {
              iot: {
                enabled: true,
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('true');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
    });

    it('should respect "sqlVersion" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sqlVersion: '2016-03-23',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion
      ).to.equal('2016-03-23');
    });

    it('should respect "description" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                description: 'iot event description',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.Description
      ).to.equal('iot event description');
    });

    it('should respect enabled variable if the "enabled" property is not given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sql: "SELECT * FROM 'topic_1'",
[?2004l
2025-11-14 00:29:27,307 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_btv9T0vAD1GerXz7sOKFPP4r', 'function': {'arguments': '{"command":"sed -n \'200,400p\' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 4141, 'total_tokens': 4180, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7a5084f4-ff2e-4bb1-83eb-66faebf159bb-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,400p' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}, 'id': 'call_btv9T0vAD1GerXz7sOKFPP4r', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4141, 'output_tokens': 39, 'total_tokens': 4180, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:29:27,311 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,400p' lib/plugins/aws/deploy/compile/events/iot/index.test.js
2025-11-14 00:29:27,413 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:27,413 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,400p' lib/plugins/aws/deploy/compile/even
nts/iot/index.test.js
[?2004l
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
    });

    it('should not create corresponding resources when iot events are not given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });
});
[?2004l
2025-11-14 00:29:35,934 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gVsCSqhvaeoqhpzmGOWruS7b', 'function': {'arguments': '{"command":"node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep \\"should create corresponding resources when iot events are given\\" -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 767, 'prompt_tokens': 4395, 'total_tokens': 5162, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--df9413b8-7372-4f14-b7c9-edcd5f8f9d5d-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should create corresponding resources when iot events are given" -R spec'}, 'id': 'call_gVsCSqhvaeoqhpzmGOWruS7b', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4395, 'output_tokens': 767, 'total_tokens': 5162, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-14 00:29:35,938 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should create corresponding resources when iot events are given" -R spec
2025-11-14 00:29:36,377 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:36,377 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should create corresponding reso
ources when iot events are given" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when iot events are given[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
2025-11-14 00:29:41,460 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kFJbAX4nV5Pe92k6WOOdTOgN', 'function': {'arguments': '{"command":"node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep \\"should respect \\\\\\"description\\\\\\" variable\\" -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 445, 'prompt_tokens': 4624, 'total_tokens': 5069, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2560}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--75af8d2b-1068-4b97-a285-a62fb742f69a-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \\"description\\" variable" -R spec'}, 'id': 'call_kFJbAX4nV5Pe92k6WOOdTOgN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4624, 'output_tokens': 445, 'total_tokens': 5069, 'input_token_details': {'audio': 0, 'cache_read': 2560}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-14 00:29:41,463 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \"description\" variable" -R spec
2025-11-14 00:29:41,913 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:41,913 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"description\" v
variable" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "description" variable[0m


[92m [0m[32m 1 passing[0m[90m (9ms)[0m

[?2004l
2025-11-14 00:29:43,263 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5WlWlSibeYkaVRvXhk16MUSR', 'function': {'arguments': '{"command":"node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep \\"should respect \\\\\\"name\\\\\\" variable\\" -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 55, 'prompt_tokens': 4842, 'total_tokens': 4897, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d6301a5d-8e8e-4ff7-a712-97f1f103c4a1-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \\"name\\" variable" -R spec'}, 'id': 'call_5WlWlSibeYkaVRvXhk16MUSR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4842, 'output_tokens': 55, 'total_tokens': 4897, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:29:43,267 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \"name\" variable" -R spec
2025-11-14 00:29:43,687 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:43,687 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"name\" variable
e" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "name" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
2025-11-14 00:29:44,816 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_IJ5YfUbVoLFhUfxqhAUnsLnU', 'function': {'arguments': '{"command":"node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep \\"should respect \\\\\\"enabled\\\\\\" variable\\" -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 55, 'prompt_tokens': 5060, 'total_tokens': 5115, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--89472082-53ba-4203-b42f-9830ab320a0d-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \\"enabled\\" variable" -R spec'}, 'id': 'call_IJ5YfUbVoLFhUfxqhAUnsLnU', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5060, 'output_tokens': 55, 'total_tokens': 5115, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:29:44,819 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \"enabled\" variable" -R spec
2025-11-14 00:29:45,243 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:45,243 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"enabled\" varia
able" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "enabled" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
2025-11-14 00:29:46,341 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_q8mgjUCB02LR2892wOx4b6G7', 'function': {'arguments': '{"command":"node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep \\"should respect \\\\\\"sqlVersion\\\\\\" variable\\" -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 56, 'prompt_tokens': 5278, 'total_tokens': 5334, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4864}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8aaed999-c4a3-47ee-aba4-ff0debd4e49d-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \\"sqlVersion\\" variable" -R spec'}, 'id': 'call_q8mgjUCB02LR2892wOx4b6G7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5278, 'output_tokens': 56, 'total_tokens': 5334, 'input_token_details': {'audio': 0, 'cache_read': 4864}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:29:46,344 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep "should respect \"sqlVersion\" variable" -R spec
2025-11-14 00:29:46,770 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:29:46,770 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"sqlVersion\" va
ariable" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "sqlVersion" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
2025-11-14 00:30:02,615 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n node ./node_modules/mocha/bin/_mocha lib/plugins/aws/\n/deploy/compile/events/iot/index.test.js --grep "should create corresponding reso\nources when iot events are given" -R spec\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileIoTEvents\x1b[0m\n\x1b[0m    #awsCompileIoTEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should create corresponding resources when iot events are given\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (8ms)\x1b[0m\n\n\x1b[?2004l\n node ./node_modules/mocha/bin/_mocha lib/plugins/aws/\n/deploy/compile/events/iot/index.test.js --grep "should respect \\"description\\" v\nvariable" -R spec\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileIoTEvents\x1b[0m\n\x1b[0m    #awsCompileIoTEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should respect "description" variable\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (9ms)\x1b[0m\n\n\x1b[?2004l\n node ./node_modules/mocha/bin/_mocha lib/plugins/aws/\n/deploy/compile/events/iot/index.test.js --grep "should respect \\"name\\" variable\ne" -R spec\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileIoTEvents\x1b[0m\n\x1b[0m    #awsCompileIoTEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should respect "name" variable\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (8ms)\x1b[0m\n\n\x1b[?2004l\n node ./node_modules/mocha/bin/_mocha lib/plugins/aws/\n/deploy/compile/events/iot/index.test.js --grep "should respect \\"enabled\\" varia\nable" -R spec\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileIoTEvents\x1b[0m\n\x1b[0m    #awsCompileIoTEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should respect "enabled" variable\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (8ms)\x1b[0m\n\n\x1b[?2004l\n node ./node_modules/mocha/bin/_mocha lib/plugins/aws/\n/deploy/compile/events/iot/index.test.js --grep "should respect \\"sqlVersion\\" va\nariable" -R spec\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileIoTEvents\x1b[0m\n\x1b[0m    #awsCompileIoTEvents()\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should respect "sqlVersion" variable\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (8ms)\x1b[0m\n\n\x1b[?2004l\nTotal tests run: 5\nOverall result: Pass' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1700, 'prompt_tokens': 5499, 'total_tokens': 7199, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--9c031d3f-426d-4423-9047-70afc7724ea9-0' usage_metadata={'input_tokens': 5499, 'output_tokens': 1700, 'total_tokens': 7199, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-14 00:30:02,618 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should create corresponding reso
ources when iot events are given" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when iot events are given[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"description\" v
variable" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "description" variable[0m


[92m [0m[32m 1 passing[0m[90m (9ms)[0m

[?2004l
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"name\" variable
e" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "name" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"enabled\" varia
able" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "enabled" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
 node ./node_modules/mocha/bin/_mocha lib/plugins/aws/
/deploy/compile/events/iot/index.test.js --grep "should respect \"sqlVersion\" va
ariable" -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "sqlVersion" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
Total tests run: 5
Overall result: Pass
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-14 00:30:12,965 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable'] regression_test_fail_log='' total_tests_run=5
2025-11-14 00:30:12,966 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:30:12,966 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-14 00:30:12,967 - thread-135845308794560.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - DEBUG - Selected 5 regression tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:30:12,969 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - Enter bug_reproduction_subgraph
2025-11-14 00:30:12,971 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_reproduction_context_message_node - DEBUG - Sending query to context provider subgraph:
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


OBJECTIVE: Find 5 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 5 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 5 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

2025-11-14 00:30:12,972 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-14 00:30:12,974 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


OBJECTIVE: Find 5 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 5 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 5 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:30:30,371 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The task requires extracting and reproducing 5 complete, existing test cases (with imports, setup, assertions, and exact line numbers). The current context only provides the repository file tree and not the contents of any test files. The bug concerns IoT event compilation handling YAML multi-line scalars, so we need the actual test files that cover IoT events and YAML parsing to identify the most relevant cases and quote them accurately.' query='Please provide the full content (with line numbers) of the following test files: lib/plugins/aws/deploy/compile/events/iot/index.test.js, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/classes/Variables.test.js, and lib/plugins/aws/provider/awsProvider.test.js.' extra_requirements='If any of these files do not exist, please provide the closest equivalent tests that cover IoT event compilation and YAML multi-line parsing, with their full content and line numbers.' purpose='I need these test files to select 5 most relevant cases and reproduce them with all necessary imports, setup, and exact line references.'
2025-11-14 00:30:30,373 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content (with line numbers) of the following test files: lib/plugins/aws/deploy/compile/events/iot/index.test.js, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/classes/Variables.test.js, and lib/plugins/aws/provider/awsProvider.test.js.
2025-11-14 00:30:38,040 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full contents of the following files: lib/plugins/aws/deploy/compile/events/iot/index.js and any test files under that directory, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/plugins/aws/deploy/compile/index.test.js, and lib/plugins/aws/lib/naming.test.js.', 'query_extra_requirements': "If some files do not exist or are empty, please share any tests that reference IoT events or YAML folded scalars ('>') and their full content with line numbers.", 'query_purpose': 'I need the exact test definitions and line numbers to select 8 relevant existing test cases and include all necessary imports and assertions.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'content': '1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n47. \n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n96. \n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n107.           }\n108.         });\n109.       }\n110.     });\n111.   }\n112. }\n113. module.exports = AwsCompileIoTEvents;', 'start_line_number': 1, 'end_line_number': 113}, {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.test.js', 'content': '1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsProvider = require(\'../../../../provider/awsProvider\');\n5. const AwsCompileIoTEvents = require(\'./index\');\n6. const Serverless = require(\'../../../../../../Serverless\');\n7. \n8. describe(\'AwsCompileIoTEvents\', () => {\n9.   let serverless;\n10.   let awsCompileIoTEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n15.     serverless.setProvider(\'aws\', new AwsProvider(serverless));\n16.     awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);\n17.     awsCompileIoTEvents.serverless.service.service = \'new-service\';\n18.   });\n19. \n20.   describe(\'#constructor()\', () => {\n21.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n22.       expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));\n23.   });\n24. \n25.   describe(\'#awsCompileIoTEvents()\', () => {\n26.     it(\'should throw an error if iot event type is not an object\', () => {\n27.       awsCompileIoTEvents.serverless.service.functions = {\n28.         first: {\n29.           events: [\n30.             {\n31.               iot: \'iot\',\n32.             },\n33.           ],\n34.         },\n35.       };\n36. \n37.       expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);\n38.     });\n39. \n40.     it(\'should create corresponding resources when iot events are given\', () => {\n41.       awsCompileIoTEvents.serverless.service.functions = {\n42.         first: {\n43.           events: [\n44.             {\n45.               iot: {\n46.                 sql: "SELECT * FROM \'topic_1\'",\n47.               },\n48.             },\n49.             {\n50.               iot: {\n51.                 sql: "SELECT * FROM \'topic_2\'",\n52.               },\n53.             },\n54.           ],\n55.         },\n56.       };\n57. \n58.       awsCompileIoTEvents.compileIoTEvents();\n59. \n60.       expect(awsCompileIoTEvents.serverless.service\n61.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type\n62.       ).to.equal(\'AWS::IoT::TopicRule\');\n63.       expect(awsCompileIoTEvents.serverless.service\n64.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type\n65.       ).to.equal(\'AWS::IoT::TopicRule\');\n66.       expect(awsCompileIoTEvents.serverless.service\n67.         .provider.compiledCloudFormationTemplate.Resources\n68.         .FirstIotTopicRule1.Properties.TopicRulePayload.Sql\n69.       ).to.equal(\'SELECT * FROM \\\'topic_1\\\'\');\n70.       expect(awsCompileIoTEvents.serverless.service\n71.         .provider.compiledCloudFormationTemplate.Resources\n72.         .FirstIotTopicRule2.Properties.TopicRulePayload.Sql\n73.       ).to.equal(\'SELECT * FROM \\\'topic_2\\\'\');\n74.       expect(awsCompileIoTEvents.serverless.service\n75.         .provider.compiledCloudFormationTemplate.Resources\n76.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n77.       ).to.equal(\'false\');\n78.       expect(awsCompileIoTEvents.serverless.service\n79.         .provider.compiledCloudFormationTemplate.Resources\n80.         .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled\n81.       ).to.equal(\'false\');\n82.       expect(awsCompileIoTEvents.serverless.service\n83.         .provider.compiledCloudFormationTemplate.Resources\n84.         .FirstLambdaPermissionIotTopicRule1.Type\n85.       ).to.equal(\'AWS::Lambda::Permission\');\n86.       expect(awsCompileIoTEvents.serverless.service\n87.         .provider.compiledCloudFormationTemplate.Resources\n88.         .FirstLambdaPermissionIotTopicRule2.Type\n89.       ).to.equal(\'AWS::Lambda::Permission\');\n90.     });\n91. \n92.     it(\'should respect "name" variable\', () => {\n93.       awsCompileIoTEvents.serverless.service.functions = {\n94.         first: {\n95.           events: [\n96.             {\n97.               iot: {\n98.                 name: \'iotEvantName\',\n99.                 sql: "SELECT * FROM \'topic_1\'",\n100.               },\n101.             },\n102.           ],\n103.         },\n104.       };\n105. \n106.       awsCompileIoTEvents.compileIoTEvents();\n107. \n108.       expect(awsCompileIoTEvents.serverless.service\n109.         .provider.compiledCloudFormationTemplate.Resources\n110.         .FirstIotTopicRule1.Properties.RuleName\n111.       ).to.equal(\'iotEvantName\');\n112.     });\n113. \n114.     it(\'should respect "enabled" variable\', () => {\n115.       awsCompileIoTEvents.serverless.service.functions = {\n116.         first: {\n117.           events: [\n118.             {\n119.               iot: {\n120.                 enabled: false,\n121.                 sql: "SELECT * FROM \'topic_1\'",\n122.               },\n123.             },\n124.           ],\n125.         },\n126.         second: {\n127.           events: [\n128.             {\n129.               iot: {\n130.                 enabled: true,\n131.                 sql: "SELECT * FROM \'topic_1\'",\n132.               },\n133.             },\n134.           ],\n135.         },\n136.       };\n137. \n138.       awsCompileIoTEvents.compileIoTEvents();\n139. \n140.       expect(awsCompileIoTEvents.serverless.service\n141.         .provider.compiledCloudFormationTemplate.Resources\n142.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n143.       ).to.equal(\'true\');\n144.       expect(awsCompileIoTEvents.serverless.service\n145.         .provider.compiledCloudFormationTemplate.Resources\n146.         .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n147.       ).to.equal(\'false\');\n148.     });\n149. \n150.     it(\'should respect "sqlVersion" variable\', () => {\n151.       awsCompileIoTEvents.serverless.service.functions = {\n152.         first: {\n153.           events: [\n154.             {\n155.               iot: {\n156.                 sqlVersion: \'2016-03-23\',\n157.                 sql: "SELECT * FROM \'topic_1\'",\n158.               },\n159.             },\n160.           ],\n161.         },\n162.       };\n163. \n164.       awsCompileIoTEvents.compileIoTEvents();\n165. \n166.       expect(awsCompileIoTEvents.serverless.service\n167.         .provider.compiledCloudFormationTemplate.Resources\n168.         .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion\n169.       ).to.equal(\'2016-03-23\');\n170.     });\n171. \n172.     it(\'should respect "description" variable\', () => {\n173.       awsCompileIoTEvents.serverless.service.functions = {\n174.         first: {\n175.           events: [\n176.             {\n177.               iot: {\n178.                 description: \'iot event description\',\n179.                 sql: "SELECT * FROM \'topic_1\'",\n180.               },\n181.             },\n182.           ],\n183.         },\n184.       };\n185. \n186.       awsCompileIoTEvents.compileIoTEvents();\n187. \n188.       expect(awsCompileIoTEvents.serverless.service\n189.         .provider.compiledCloudFormationTemplate.Resources\n190.         .FirstIotTopicRule1.Properties.TopicRulePayload.Description\n191.       ).to.equal(\'iot event description\');\n192.     });\n193. \n194.     it(\'should respect enabled variable if the "enabled" property is not given\', () => {\n195.       awsCompileIoTEvents.serverless.service.functions = {\n196.         first: {\n197.           events: [\n198.             {\n199.               iot: {\n200.                 sql: "SELECT * FROM \'topic_1\'",\n201.               },\n202.             },\n203.           ],\n204.         },\n205.       };\n206. \n207.       awsCompileIoTEvents.compileIoTEvents();\n208. \n209.       expect(awsCompileIoTEvents.serverless.service\n210.         .provider.compiledCloudFormationTemplate.Resources\n211.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n212.       ).to.equal(\'false\');\n213.     });\n214. \n215.     it(\'should not create corresponding resources when iot events are not given\', () => {\n216.       awsCompileIoTEvents.serverless.service.functions = {\n217.         first: {\n218.           events: [],\n219.         },\n220.       };\n221. \n222.       awsCompileIoTEvents.compileIoTEvents();\n223. \n224.       expect(awsCompileIoTEvents.serverless.service\n225.         .provider.compiledCloudFormationTemplate.Resources\n226.       ).to.deep.equal({});\n227.     });\n228.   });\n229. });', 'start_line_number': 1, 'end_line_number': 229}, {'relative_path': 'lib/classes/YamlParser.test.js', 'content': "1. 'use strict';\n2. \n3. /**\n4.  * Test: YamlParser Function Class\n5.  */\n6. \n7. const expect = require('chai').expect;\n8. const YAML = require('js-yaml');\n9. const path = require('path');\n10. const Serverless = require('../../lib/Serverless');\n11. const testUtils = require('../../tests/utils');\n12. \n13. const serverless = new Serverless();\n14. \n15. describe('YamlParser', () => {\n16.   describe('#parse()', () => {\n17.     it('should parse a simple .yaml file', () => {\n18.       const tmpFilePath = testUtils.getTmpFilePath('simple.yaml');\n19. \n20.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));\n21. \n22.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n23.         expect(obj.foo).to.equal('bar');\n24.       });\n25.     });\n26. \n27.     it('should parse a simple .yml file', () => {\n28.       const tmpFilePath = testUtils.getTmpFilePath('simple.yml');\n29. \n30.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));\n31. \n32.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n33.         expect(obj.foo).to.equal('bar');\n34.       });\n35.     });\n36. \n37.     it('should parse a .yml file with JSON-REF to YAML', () => {\n38.       const tmpDirPath = testUtils.getTmpDirPath();\n39. \n40.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.yml'), { foo: 'bar' });\n41. \n42.       const testYml = {\n43.         main: {\n44.           $ref: './ref.yml',\n45.         },\n46.       };\n47. \n48.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);\n49. \n50.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {\n51.         expect(obj.main.foo).to.equal('bar');\n52.       });\n53.     });\n54. \n55.     it('should parse a .yml file with JSON-REF to JSON', () => {\n56.       const tmpDirPath = testUtils.getTmpDirPath();\n57. \n58.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.json'), { foo: 'bar' });\n59. \n60.       const testYml = {\n61.         main: {\n62.           $ref: './ref.json',\n63.         },\n64.       };\n65. \n66.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);\n67. \n68.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {\n69.         expect(obj.main.foo).to.equal('bar');\n70.       });\n71.     });\n72. \n73.     it('should parse a .yml file with recursive JSON-REF', () => {\n74.       const tmpDirPath = testUtils.getTmpDirPath();\n75. \n76.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'three.yml'), { foo: 'bar' });\n77. \n78.       const twoYml = {\n79.         two: {\n80.           $ref: './three.yml',\n81.         },\n82.       };\n83. \n84.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'two.yml'), twoYml);\n85. \n86.       const oneYml = {\n87.         one: {\n88.           $ref: './two.yml',\n89.         },\n90.       };\n91. \n92.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'one.yml'), oneYml);\n93. \n94.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'one.yml')).then((obj) => {\n95.         expect(obj.one.two.foo).to.equal('bar');\n96.       });\n97.     });\n98.   });\n99. });", 'start_line_number': 1, 'end_line_number': 99}, {'relative_path': 'lib/classes/Service.test.js', 'content': '1. \'use strict\';\n2. \n3. const path = require(\'path\');\n4. const YAML = require(\'js-yaml\');\n5. const expect = require(\'chai\').expect;\n6. const sinon = require(\'sinon\');\n7. const Service = require(\'../../lib/classes/Service\');\n8. const Utils = require(\'../../lib/classes/Utils\');\n9. const Serverless = require(\'../../lib/Serverless\');\n10. const testUtils = require(\'../../tests/utils\');\n11. \n12. describe(\'Service\', () => {\n13.   describe(\'#constructor()\', () => {\n14.     const serverless = new Serverless();\n15. \n16.     it(\'should attach serverless instance\', () => {\n17.       const serviceInstance = new Service(serverless);\n18.       expect(typeof serviceInstance.serverless.version).to.be.equal(\'string\');\n19.     });\n20. \n21.     it(\'should construct with defaults\', () => {\n22.       const serviceInstance = new Service(serverless);\n23. \n24.       expect(serviceInstance.service).to.be.equal(null);\n25.       expect(serviceInstance.provider).to.deep.equal({});\n26.       expect(serviceInstance.defaults).to.deep.equal({\n27.         stage: \'dev\',\n28.         region: \'us-east-1\',\n29.         variableSyntax: \'\\\\${([ :a-zA-Z0-9._,\\\\-\\\\/\\\\(\\\\)]+?)}\',\n30.       });\n31.       expect(serviceInstance.custom).to.deep.equal({});\n32.       expect(serviceInstance.plugins).to.deep.equal([]);\n33.       expect(serviceInstance.functions).to.deep.equal({});\n34.       expect(serviceInstance.resources).to.deep.equal({});\n35.       expect(serviceInstance.package).to.deep.equal({});\n36.     });\n37. \n38.     it(\'should construct with data\', () => {\n39.       const data = {\n40.         service: \'testService\',\n41.         provider: \'testProvider\',\n42.         custom: {\n43.           customProp: \'value\',\n44.         },\n45.         plugins: [\'testPlugin\'],\n46.         functions: {\n47.           functionA: {},\n48.         },\n49.         resources: {\n50.           aws: {\n51.             resourcesProp: \'value\',\n52.           },\n53.           azure: {},\n54.           google: {},\n55.         },\n56.         package: {\n57.           exclude: [\'exclude-me\'],\n58.           include: [\'include-me\'],\n59.           artifact: \'some/path/foo.zip\',\n60.         },\n61.       };\n62. \n63.       const serviceInstance = new Service(serverless, data);\n64. \n65.       expect(serviceInstance.service).to.be.equal(\'testService\');\n66.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n67.       expect(serviceInstance.custom).to.deep.equal({ customProp: \'value\' });\n68.       expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n69.       expect(serviceInstance.functions).to.deep.equal({ functionA: {} });\n70.       expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n71.       expect(serviceInstance.resources.azure).to.deep.equal({});\n72.       expect(serviceInstance.resources.google).to.deep.equal({});\n73.       expect(serviceInstance.package.exclude.length).to.equal(1);\n74.       expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n75.       expect(serviceInstance.package.include.length).to.equal(1);\n76.       expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n77.       expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n78.     });\n79. \n80.     it(\'should support string based provider config\', () => {\n81.       const data = {\n82.         provider: \'testProvider\',\n83.       };\n84. \n85.       const serviceInstance = new Service(serverless, data);\n86. \n87.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n88.     });\n89. \n90.     it(\'should support object based provider config\', () => {\n91.       const data = {\n92.         provider: {\n93.           name: \'testProvider\',\n94.           runtime: \'nodejs4.3\',\n95.         },\n96.       };\n97. \n98.       const serviceInstance = new Service(serverless, data);\n99. \n100.       expect(serviceInstance.provider.name).to.be.equal(\'testProvider\');\n101.       expect(serviceInstance.provider.runtime).to.be.equal(\'nodejs4.3\');\n102.     });\n103.   });\n104. \n105.   describe(\'#load()\', () => {\n106.     let serviceInstance;\n107.     let tmpDirPath;\n108. \n109.     beforeEach(() => {\n110.       tmpDirPath = testUtils.getTmpDirPath();\n111.     });\n112. \n113.     it(\'should resolve if no servicePath is found\', () => {\n114.       const serverless = new Serverless();\n115.       const noService = new Service(serverless);\n116. \n117.       return noService.load();\n118.     });\n119. \n120.     it(\'should load from filesystem\', () => {\n121.       const SUtils = new Utils();\n122.       const serverlessYml = {\n123.         service: \'new-service\',\n124.         provider: \'aws\',\n125.         defaults: {\n126.           stage: \'dev\',\n127.           region: \'us-east-1\',\n128.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n129.         },\n130.         plugins: [\'testPlugin\'],\n131.         functions: {\n132.           functionA: {},\n133.         },\n134.         resources: {\n135.           aws: {\n136.             resourcesProp: \'value\',\n137.           },\n138.           azure: {},\n139.           google: {},\n140.         },\n141.         package: {\n142.           exclude: [\'exclude-me\'],\n143.           include: [\'include-me\'],\n144.           artifact: \'some/path/foo.zip\',\n145.         },\n146.       };\n147. \n148.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n149.         YAML.dump(serverlessYml));\n150. \n151.       const serverless = new Serverless();\n152.       serverless.init();\n153.       serverless.config.update({ servicePath: tmpDirPath });\n154.       serviceInstance = new Service(serverless);\n155. \n156.       return serviceInstance.load().then(() => {\n157.         expect(serviceInstance.service).to.be.equal(\'new-service\');\n158.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n159.         expect(serviceInstance.defaults.variableSyntax).to.equal(\'\\\\${{([\\\\s\\\\S]+?)}}\');\n160.         expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n161.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n162.         expect(serviceInstance.resources.azure).to.deep.equal({});\n163.         expect(serviceInstance.resources.google).to.deep.equal({});\n164.         expect(serviceInstance.package.exclude.length).to.equal(1);\n165.         expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n166.         expect(serviceInstance.package.include.length).to.equal(1);\n167.         expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n168.         expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n169.       });\n170.     });\n171. \n172.     it(\'should merge resources given as an array\', () => {\n173.       const SUtils = new Utils();\n174.       const serverlessYml = {\n175.         service: \'new-service\',\n176.         provider: \'aws\',\n177.         resources: [\n178.           {\n179.             aws: {\n180.               resourcesProp: \'value\',\n181.             },\n182.           },\n183.           {\n184.             azure: {},\n185.           },\n186.         ],\n187.       };\n188. \n189.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n190.         YAML.dump(serverlessYml));\n191. \n192.       const serverless = new Serverless();\n193.       serverless.init();\n194.       serverless.config.update({ servicePath: tmpDirPath });\n195.       serviceInstance = new Service(serverless);\n196. \n197.       return serviceInstance.load().then(() => {\n198.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n199.         expect(serviceInstance.resources.azure).to.deep.equal({});\n200.       });\n201.     });\n202. \n203.     it(\'should make sure function name contains the default stage\', () => {\n204.       const SUtils = new Utils();\n205.       const serverlessYml = {\n206.         service: \'new-service\',\n207.         provider: \'aws\',\n208.         defaults: {\n209.           stage: \'dev\',\n210.           region: \'us-east-1\',\n211.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n212.         },\n213.         plugins: [\'testPlugin\'],\n214.         functions: {\n215.           functionA: {},\n216.         },\n217.         resources: {\n218.           aws: {\n219.             resourcesProp: \'value\',\n220.           },\n221.           azure: {},\n222.           google: {},\n223.         },\n224.         package: {\n225.           exclude: [\'exclude-me\'],\n226.           include: [\'include-me\'],\n227.           artifact: \'some/path/foo.zip\',\n228.         },\n229.       };\n230. \n231.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n232.         YAML.dump(serverlessYml));\n233. \n234.       const serverless = new Serverless();\n235.       serverless.init();\n236.       serverless.config.update({ servicePath: tmpDirPath });\n237.       serviceInstance = new Service(serverless);\n238. \n239.       return serviceInstance.load().then(() => {\n240.         expect(serviceInstance.functions.functionA.name).to.be.equal(\'new-service-dev-functionA\');\n241.       });\n242.     });\n243. \n244.     it(\'should support Serverless file with a non-aws provider\', () => {\n245.       const SUtils = new Utils();\n246.       const serverlessYaml = {\n247.         service: \'my-service\',\n248.         provider: \'openwhisk\',\n249.         functions: {\n250.           functionA: {\n251.             name: \'customFunctionName\',\n252.           },\n253.         },\n254.       };\n255. \n256.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n257.         YAML.dump(serverlessYaml));\n258. \n259.       const serverless = new Serverless({ servicePath: tmpDirPath });\n260.       serviceInstance = new Service(serverless);\n261. \n262.       return serviceInstance.load().then(() => {\n263.         const expectedFunc = {\n264.           functionA: {\n265.             name: \'customFunctionName\',\n266.             events: [],\n267.           },\n268.         };\n269.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n270.         expect(serviceInstance.provider.name).to.deep.equal(\'openwhisk\');\n271.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n272.       });\n273.     });\n274. \n275.     it(\'should support Serverless file with a .yaml extension\', () => {\n276.       const SUtils = new Utils();\n277.       const serverlessYaml = {\n278.         service: \'my-service\',\n279.         provider: \'aws\',\n280.         functions: {\n281.           functionA: {\n282.             name: \'customFunctionName\',\n283.           },\n284.         },\n285.       };\n286. \n287.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n288.         YAML.dump(serverlessYaml));\n289. \n290.       const serverless = new Serverless({ servicePath: tmpDirPath });\n291.       serviceInstance = new Service(serverless);\n292. \n293.       return serviceInstance.load().then(() => {\n294.         const expectedFunc = {\n295.           functionA: {\n296.             name: \'customFunctionName\',\n297.             events: [],\n298.           },\n299.         };\n300.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n301.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n302.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n303.       });\n304.     });\n305. \n306.     it(\'should support Serverless file with a .yml extension\', () => {\n307.       const SUtils = new Utils();\n308.       const serverlessYml = {\n309.         service: \'my-service\',\n310.         provider: \'aws\',\n311.         functions: {\n312.           functionA: {},\n313.         },\n314.       };\n315. \n316.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n317.         YAML.dump(serverlessYml));\n318. \n319.       const serverless = new Serverless({ servicePath: tmpDirPath });\n320.       serviceInstance = new Service(serverless);\n321. \n322.       return serviceInstance.load({ stage: \'dev\' }).then(() => {\n323.         const expectedFunc = {\n324.           functionA: {\n325.             name: \'my-service-dev-functionA\',\n326.             events: [],\n327.           },\n328.         };\n329.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n330.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n331.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n332.       });\n333.     });\n334. \n335.     it(\'should throw error if service property is missing\', () => {\n336.       const SUtils = new Utils();\n337.       const serverlessYml = {\n338.         provider: \'aws\',\n339.         functions: {},\n340.       };\n341.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n342.         YAML.dump(serverlessYml));\n343. \n344.       const serverless = new Serverless({ servicePath: tmpDirPath });\n345.       serviceInstance = new Service(serverless);\n346. \n347.       return serviceInstance.load().then(() => {\n348.         // if we reach this, then no error was thrown as expected\n349.         // so make assertion fail intentionally to let us know something is wrong\n350.         expect(1).to.equal(2);\n351.       }).catch(e => {\n352.         expect(e.name).to.be.equal(\'ServerlessError\');\n353.       });\n354.     });\n355. \n356.     it(\'should throw error if provider property is missing\', () => {\n357.       const SUtils = new Utils();\n358.       const serverlessYml = {\n359.         service: \'service-name\',\n360.         functions: {},\n361.       };\n362.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n363.         YAML.dump(serverlessYml));\n364. \n365.       const serverless = new Serverless({ servicePath: tmpDirPath });\n366.       serviceInstance = new Service(serverless);\n367. \n368.       return serviceInstance.load().then(() => {\n369.         // if we reach this, then no error was thrown as expected\n370.         // so make assertion fail intentionally to let us know something is wrong\n371.         expect(1).to.equal(2);\n372.       }).catch(e => {\n373.         expect(e.name).to.be.equal(\'ServerlessError\');\n374.       });\n375.     });\n376. \n377.     it(\'should throw error if frameworkVersion is not satisfied\', () => {\n378.       const SUtils = new Utils();\n379.       const serverlessYml = {\n380.         service: \'service-name\',\n381.         frameworkVersion: \'=1.0.0\',\n382.         provider: \'aws\',\n383.         functions: {},\n384.       };\n385.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n386.         YAML.dump(serverlessYml));\n387. \n388.       const serverless = new Serverless({ servicePath: tmpDirPath });\n389.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n390.       getVersion.returns(\'1.0.2\');\n391.       serviceInstance = new Service(serverless);\n392. \n393.       return serviceInstance.load().then(() => {\n394.         // if we reach this, then no error was thrown as expected\n395.         // so make assertion fail intentionally to let us know something is wrong\n396.         expect(1).to.equal(2);\n397.       }).catch(e => {\n398.         expect(e.name).to.be.equal(\'ServerlessError\');\n399.       });\n400.     });\n401. \n402.     it(\'should pass if frameworkVersion is satisfied\', () => {\n403.       const SUtils = new Utils();\n404.       const serverlessYml = {\n405.         service: \'service-name\',\n406.         frameworkVersion: \'>=1.0.0\',\n407.         provider: \'aws\',\n408.         functions: {},\n409.       };\n410.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n411.         YAML.dump(serverlessYml));\n412. \n413.       const serverless = new Serverless({ servicePath: tmpDirPath });\n414.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n415.       getVersion.returns(\'1.2.2\');\n416.       serviceInstance = new Service(serverless);\n417. \n418.       return serviceInstance.load().then(() => {\n419.         // if this callbar is reached, then no error was thrown as expected\n420.         expect(1).to.equal(1);\n421.       });\n422.     });\n423. \n424.     it(\'should not throw error if functions property is missing\', () => {\n425.       const SUtils = new Utils();\n426.       const serverlessYml = {\n427.         service: \'service-name\',\n428.         provider: \'aws\',\n429.       };\n430.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n431.         YAML.dump(serverlessYml));\n432. \n433.       const serverless = new Serverless({ servicePath: tmpDirPath });\n434.       serviceInstance = new Service(serverless);\n435. \n436.       return serviceInstance.load().then(() => {\n437.         expect(serverless.service.functions).to.deep.equal({});\n438.       });\n439.     });\n440. \n441.     it("should throw error if a function\'s event is not an array", () => {\n442.       const SUtils = new Utils();\n443.       const serverlessYml = {\n444.         service: \'service-name\',\n445.         provider: \'aws\',\n446.         functions: {\n447.           functionA: {\n448.             events: {},\n449.           },\n450.         },\n451.       };\n452.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n453.         YAML.dump(serverlessYml));\n454. \n455.       const serverless = new Serverless({ servicePath: tmpDirPath });\n456.       serviceInstance = new Service(serverless);\n457. \n458.       return serviceInstance.load().then(() => {\n459.         // if we reach this, then no error was thrown as expected\n460.         // so make assertion fail intentionally to let us know something is wrong\n461.         expect(1).to.equal(2);\n462.       }).catch(e => {\n463.         expect(e.name).to.be.equal(\'ServerlessError\');\n464.       });\n465.     });\n466. \n467.     it(\'should throw error if provider property is invalid\', () => {\n468.       const SUtils = new Utils();\n469.       const serverlessYml = {\n470.         service: \'service-name\',\n471.         provider: \'invalid\',\n472.         functions: {},\n473.       };\n474. \n475.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n476.         YAML.dump(serverlessYml));\n477. \n478.       const serverless = new Serverless({ servicePath: tmpDirPath });\n479.       serviceInstance = new Service(serverless);\n480. \n481.       return serviceInstance.load().then(() => {\n482.         // if we reach this, then no error was thrown as expected\n483.         // so make assertion fail intentionally to let us know something is wrong\n484.         expect(1).to.equal(2);\n485.       }).catch(e => {\n486.         expect(e.name).to.be.equal(\'ServerlessError\');\n487.       });\n488.     });\n489.   });\n490. \n491.   describe(\'#update()\', () => {\n492.     it(\'should update service instance data\', () => {\n493.       const serverless = new Serverless();\n494.       const serviceInstance = new Service(serverless);\n495.       const newData = { service: \'newName\' };\n496.       const updatedInstance = serviceInstance.update(newData);\n497.       expect(updatedInstance.service).to.be.equal(\'newName\');\n498.     });\n499.   });\n500. ', 'start_line_number': 1, 'end_line_number': 500}, {'relative_path': 'lib/plugins/aws/lib/naming.test.js', 'content': '1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. \n5. const SDK = require(\'../provider/awsProvider\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. describe(\'#naming()\', () => {\n9.   let options;\n10.   let serverless;\n11.   let sdk;\n12. \n13.   beforeEach(() => {\n14.     options = {\n15.       stage: \'dev\',\n16.       region: \'us-east-1\',\n17.     };\n18.     serverless = new Serverless(options);\n19.     sdk = new SDK(serverless, options);\n20.   });\n21. \n22.   describe(\'#normalizeName()\', () => {\n23.     it(\'should capitalize the first letter\', () => {\n24.       expect(sdk.naming.normalizeName(\'name\')).to.equal(\'Name\');\n25.     });\n26. \n27.     it(\'should have no effect on caps\', () => {\n28.       expect(sdk.naming.normalizeName(\'Name\')).to.equal(\'Name\');\n29.     });\n30. \n31.     it(\'should have no effect on the rest of the name\', () => {\n32.       expect(sdk.naming.normalizeName(\'nAME\')).to.equal(\'NAME\');\n33.     });\n34.   });\n35. \n36.   describe(\'#normalizeNameToAlphaNumericOnly()\', () => {\n37.     it(\'should strip non-alpha-numeric characters\', () => {\n38.       expect(sdk.naming\n39.         .normalizeNameToAlphaNumericOnly(\'`!@#$%^&*()-={}|[]\\\\:";\\\'<>?,./\')).to.equal(\'\');\n40.     });\n41. \n42.     it(\'should apply normalizeName to the remaining characters\', () => {\n43.       expect(sdk.naming.normalizeNameToAlphaNumericOnly(\'a-b-c\')).to.equal(\'Abc\');\n44.     });\n45.   });\n46. \n47.   describe(\'#normalizePathPart()\', () => {\n48.     it(\'converts `-` to `Dash`\', () => {\n49.       expect(sdk.naming.normalizePathPart(\n50.         \'a-path\'\n51.       )).to.equal(\'ADashpath\');\n52.     });\n53. \n54.     it(\'converts variable declarations (`${var}`) to `VariableVar`\', () => {\n55.       expect(sdk.naming.normalizePathPart(\n56.         \'${variable}\'\n57.       )).to.equal(\'VariableVar\');\n58.     });\n59. \n60.     it(\'converts variable declarations prefixes to `VariableVarpath`\', () => {\n61.       expect(sdk.naming.normalizePathPart(\n62.         \'${variable}Path\'\n63.       )).to.equal(\'VariableVarpath\');\n64.     });\n65. \n66.     it(\'converts variable declarations suffixes to `PathvariableVar`\', () => {\n67.       expect(sdk.naming.normalizePathPart(\n68.         \'path${variable}\'\n69.       )).to.equal(\'PathvariableVar\');\n70.     });\n71. \n72.     it(\'converts variable declarations in center to `PathvariableVardir`\', () => {\n73.       expect(sdk.naming.normalizePathPart(\n74.         \'path${variable}Dir\'\n75.       )).to.equal(\'PathvariableVardir\');\n76.     });\n77.   });\n78. \n79.   describe(\'#getServiceEndpointRegex()\', () => {\n80.     it(\'should match the prefix\', () => {\n81.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpoint\'))\n82.         .to.equal(true);\n83.     });\n84. \n85.     it(\'should not match a name without the prefix\', () => {\n86.       expect(sdk.naming.getServiceEndpointRegex()\n87.         .test(\'NotThePrefixServiceEndpoint\')).to.equal(false);\n88.     });\n89. \n90.     it(\'should match a name with the prefix\', () => {\n91.       expect(sdk.naming.getServiceEndpointRegex()\n92.         .test(\'ServiceEndpointForAService\')).to.equal(true);\n93.     });\n94.   });\n95. \n96.   describe(\'#getStackName()\', () => {\n97.     it(\'should use the service name and stage from the service and config\', () => {\n98.       serverless.service.service = \'myService\';\n99.       expect(sdk.naming.getStackName()).to.equal(`${serverless.service.service}-${options.stage}`);\n100.     });\n101.   });\n102. \n103.   describe(\'#getRolePath()\', () => {\n104.     it(\'should return `/`\', () => {\n105.       expect(sdk.naming.getRolePath()).to.equal(\'/\');\n106.     });\n107.   });\n108. \n109.   describe(\'#getRoleName()\', () => {\n110.     it(\'uses the service name, stage, and region to generate a role name\', () => {\n111.       serverless.service.service = \'myService\';\n112.       expect(sdk.naming.getRoleName()).to.eql({\n113.         \'Fn::Join\': [\n114.           \'-\',\n115.           [\n116.             serverless.service.service,\n117.             options.stage,\n118.             options.region,\n119.             \'lambdaRole\',\n120.           ],\n121.         ],\n122.       });\n123.     });\n124.   });\n125. \n126.   describe(\'#getRoleLogicalId()\', () => {\n127.     it(\'should return the expected role name (IamRoleLambdaExecution)\', () => {\n128.       expect(sdk.naming.getRoleLogicalId()).to.equal(\'IamRoleLambdaExecution\');\n129.     });\n130.   });\n131. \n132.   describe(\'#getPolicyName()\', () => {\n133.     it(\'should use the stage and service name\', () => {\n134.       serverless.service.service = \'myService\';\n135.       expect(sdk.naming.getPolicyName()).to.eql({\n136.         \'Fn::Join\': [\n137.           \'-\',\n138.           [\n139.             options.stage,\n140.             serverless.service.service,\n141.             \'lambda\',\n142.           ],\n143.         ],\n144.       });\n145.     });\n146.   });\n147. \n148.   describe(\'#getPolicyLogicalId()\', () => {\n149.     it(\'should return the expected policy name (IamPolicyLambdaExecution)\', () => {\n150.       expect(sdk.naming.getPolicyLogicalId()).to.equal(\'IamPolicyLambdaExecution\');\n151.     });\n152.   });\n153. \n154.   describe(\'#getLogicalLogGroupName()\', () => {\n155.     it(\'should prefix the normalized function name to "LogGroup"\', () => {\n156.       expect(sdk.naming.getLogGroupLogicalId(\'functionName\')).to.equal(\'FunctionNameLogGroup\');\n157.     });\n158.   });\n159. \n160.   describe(\'#getLogGroupName()\', () => {\n161.     it(\'should add the function name to the log group name\', () => {\n162.       expect(sdk.naming.getLogGroupName(\'functionName\')).to.equal(\'/aws/lambda/functionName\');\n163.     });\n164.   });\n165. \n166.   describe(\'#getNormalizedFunctionName()\', () => {\n167.     it(\'should normalize the given functionName\', () => {\n168.       expect(sdk.naming.getNormalizedFunctionName(\'functionName\'))\n169.         .to.equal(\'FunctionName\');\n170.     });\n171. \n172.     it(\'should normalize the given functionName with an underscore\', () => {\n173.       expect(sdk.naming.getNormalizedFunctionName(\'hello_world\'))\n174.         .to.equal(\'HelloUnderscoreworld\');\n175.     });\n176. \n177.     it(\'should normalize the given functionName with a dash\', () => {\n178.       expect(sdk.naming.getNormalizedFunctionName(\'hello-world\'))\n179.         .to.equal(\'HelloDashworld\');\n180.     });\n181.   });\n182. \n183.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n184.     it(\'should extract everything after the last colon and dash\', () => {\n185.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n186.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n187.     });\n188.   });\n189. \n190.   describe(\'#extractLambdaNameFromArn()\', () => {\n191.     it(\'should extract everything after the last colon\', () => {\n192.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n193.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal(\'my-dev-lambda\');\n194.     });\n195.   });\n196. \n197.   describe(\'#getLambdaLogicalId()\', () => {\n198.     it(\'should normalize the function name and add the logical suffix\', () => {\n199.       expect(sdk.naming.getLambdaLogicalId(\'functionName\'))\n200.         .to.equal(\'FunctionNameLambdaFunction\');\n201.     });\n202.   });\n203. \n204.   describe(\'#getLambdaLogicalIdRegex()\', () => {\n205.     it(\'should match the suffix\', () => {\n206.       expect(sdk.naming.getLambdaLogicalIdRegex()\n207.         .test(\'LambdaFunction\')).to.equal(true);\n208.     });\n209. \n210.     it(\'should not match a name without the suffix\', () => {\n211.       expect(sdk.naming.getLambdaLogicalIdRegex()\n212.         .test(\'LambdaFunctionNotTheSuffix\')).to.equal(false);\n213.     });\n214. \n215.     it(\'should match a name with the suffix\', () => {\n216.       expect(sdk.naming.getLambdaLogicalIdRegex()\n217.         .test(\'AFunctionNameLambdaFunction\')).to.equal(true);\n218.     });\n219.   });\n220. \n221.   describe(\'#getLambdaOutputLogicalId()\', () => {\n222.     it(\'should normalize the function name and add the logical arn suffix\', () => {\n223.       expect(\n224.         sdk.naming.getLambdaOutputLogicalId(\'functionName\')\n225.       ).to.equal(\'FunctionNameLambdaFunctionArn\');\n226.     });\n227.   });\n228. \n229.   describe(\'#getLambdaOutputLogicalIdRegex()\', () => {\n230.     it(\'should match the suffix\', () => {\n231.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n232.         .test(\'aLambdaFunctionArn\')).to.equal(true);\n233.     });\n234. \n235.     it(\'should not match a name without the suffix\', () => {\n236.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n237.         .test(\'LambdaFunctionArnNotTheSuffix\'))\n238.         .to.equal(false);\n239.     });\n240. \n241.     it(\'should match a name with the suffix\', () => {\n242.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n243.         .test(\'AFunctionArnNameLambdaFunctionArn\'))\n244.         .to.equal(true);\n245.     });\n246.   });\n247. \n248.   describe(\'#getApiGatewayName()\', () => {\n249.     it(\'should return the composition of stage and service name\', () => {\n250.       serverless.service.service = \'myService\';\n251.       expect(sdk.naming.getApiGatewayName())\n252.         .to.equal(`${options.stage}-${serverless.service.service}`);\n253.     });\n254.   });\n255. \n256.   describe(\'#generateApiGatewayDeploymentLogicalId()\', () => {\n257.     it(\'should return ApiGatewayDeployment with a date based suffix\', () => {\n258.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId()\n259.         .match(/ApiGatewayDeployment(.*)/).length)\n260.         .to.be.greaterThan(1);\n261.     });\n262.   });\n263. \n264.   describe(\'#getRestApiLogicalId()\', () => {\n265.     it(\'should return ApiGatewayRestApi\', () => {\n266.       expect(sdk.naming.getRestApiLogicalId()).to.equal(\'ApiGatewayRestApi\');\n267.     });\n268.   });\n269. \n270.   describe(\'#getNormalizedAuthorizerName()\', () => {\n271.     it(\'normalize the authorizer name\', () => {\n272.       expect(sdk.naming.getNormalizedAuthorizerName(\'authorizerName\'))\n273.         .to.equal(\'AuthorizerName\');\n274.     });\n275.   });\n276. \n277.   describe(\'#getAuthorizerLogicalId()\', () => {\n278.     it(\'should normalize the authorizer name and add the standard suffix\', () => {\n279.       expect(sdk.naming.getAuthorizerLogicalId(\'authorizerName\'))\n280.         .to.equal(\'AuthorizerNameApiGatewayAuthorizer\');\n281.     });\n282.   });\n283. \n284.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n285.     it(\'should extract the authorizer name from an ARN\', () => {\n286.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n287.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n288.     });\n289.   });\n290. \n291.   describe(\'#normalizePath()\', () => {\n292.     it(\'should normalize each part of the resource path and remove non-alpha-numeric characters\',\n293.       () => {\n294.         expect(sdk.naming.normalizePath(\n295.           \'my/path/to/a-${var}-resource\'\n296.         )).to.equal(\'MyPathToADashvarVarDashresource\');\n297.       });\n298.   });\n299. \n300.   describe(\'#getResourceLogicalId()\', () => {\n301.     it(\'should normalize the resource and add the standard suffix\', () => {\n302.       expect(sdk.naming.getResourceLogicalId(\n303.         \'my/path/to/a-${var}-resource\'\n304.       )).to.equal(\'ApiGatewayResourceMyPathToADashvarVarDashresource\');\n305.     });\n306.   });\n307. \n308.   describe(\'#extractResourceId()\', () => {\n309.     it(\'should extract the normalized resource name\', () => {\n310.       expect(sdk.naming.extractResourceId(\n311.         \'ApiGatewayResourceMyPathToADashvarVarDashResource\'\n312.       )).to.equal(\'MyPathToADashvarVarDashResource\');\n313.     });\n314.   });\n315. \n316.   describe(\'#normalizeMethodName()\', () => {\n317.     it(\'should capitalize the first letter and lowercase any other characters\', () => {\n318.       expect(sdk.naming.normalizeMethodName(\'gET\')).to.equal(\'Get\');\n319.     });\n320.   });\n321. \n322.   describe(\'#getMethodLogicalId()\', () => {\n323.     it(\'\', () => {\n324.       expect(sdk.naming.getMethodLogicalId(\n325.         \'ResourceId\', \'get\'\n326.       )).to.equal(\'ApiGatewayMethodResourceIdGet\');\n327.     });\n328.   });\n329. \n330.   describe(\'#getApiKeyLogicalId(keyIndex)\', () => {\n331.     it(\'should produce the given index with ApiGatewayApiKey as a prefix\', () => {\n332.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal(\'ApiGatewayApiKey1\');\n333.     });\n334.   });\n335. \n336.   describe(\'#getApiKeyLogicalIdRegex()\', () => {\n337.     it(\'should match the prefix\', () => {\n338.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n339.         .test(\'ApiGatewayApiKey\')).to.equal(true);\n340.     });\n341. \n342.     it(\'should not match a name without the prefix\', () => {\n343.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n344.         .test(\'NotThePrefixApiGatewayApiKey\')).to.equal(false);\n345.     });\n346. \n347.     it(\'should match a name with the prefix\', () => {\n348.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n349.         .test(\'ApiGatewayApiKeySuffix\')).to.equal(true);\n350.     });\n351.   });\n352. \n353.   describe(\'#getDeploymentBucketLogicalId()\', () => {\n354.     it(\'should return "ServerlessDeploymentBucket"\', () => {\n355.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal(\'ServerlessDeploymentBucket\');\n356.     });\n357.   });\n358. \n359.   describe(\'#getDeploymentBucketOutputLogicalId()\', () => {\n360.     it(\'should return "ServerlessDeploymentBucketName"\', () => {\n361.       expect(sdk.naming.getDeploymentBucketOutputLogicalId())\n362.         .to.equal(\'ServerlessDeploymentBucketName\');\n363.     });\n364.   });\n365. \n366.   describe(\'#normalizeBucketName()\', () => {\n367.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n368.       expect(sdk.naming.normalizeBucketName(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'BucketName\');\n369.     });\n370.   });\n371. \n372.   describe(\'#getBucketLogicalId()\', () => {\n373.     it(\'should normalize the bucket name and add the standard prefix\', () => {\n374.       expect(sdk.naming.getBucketLogicalId(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'S3BucketBucketName\');\n375.     });\n376.   });\n377. \n378.   describe(\'#normalizeTopicName()\', () => {\n379.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n380.       expect(sdk.naming.normalizeTopicName(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'TopicName\');\n381.     });\n382.   });\n383. \n384.   describe(\'#getTopicLogicalId()\', () => {\n385.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n386.       expect(sdk.naming.getTopicLogicalId(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'SNSTopicTopicName\');\n387.     });\n388.   });\n389. \n390.   describe(\'#getScheduleId()\', () => {\n391.     it(\'should add the standard suffix\', () => {\n392.       expect(sdk.naming.getScheduleId(\'functionName\')).to.equal(\'functionNameSchedule\');\n393.     });\n394.   });\n395. \n396.   describe(\'#getScheduleLogicalId()\', () => {\n397.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n398.       expect(sdk.naming.getScheduleLogicalId(\'functionName\', 0))\n399.         .to.equal(\'FunctionNameEventsRuleSchedule0\');\n400.     });\n401.   });\n402. \n403.   describe(\'#getLambdaS3PermissionLogicalId()\', () => {\n404.     it(\'should normalize the function name and add the standard suffix\', () => {\n405.       expect(sdk.naming.getLambdaS3PermissionLogicalId(\'functionName\', \'bucket\'))\n406.         .to.equal(\'FunctionNameLambdaPermissionBucketS3\');\n407.     });\n408.   });\n409. \n410.   describe(\'#getLambdaSnsPermissionLogicalId()\', () => {\n411.     it(\'should normalize the function and topic names and add them as prefix and suffix to the \' +\n412.       \'standard permission center\', () => {\n413.       expect(sdk.naming.getLambdaSnsPermissionLogicalId(\'functionName\', \'topic\'))\n414.         .to.equal(\'FunctionNameLambdaPermissionTopicSNS\');\n415.     });\n416.   });\n417. \n418.   describe(\'#getLambdaSchedulePermissionLogicalId()\', () => {\n419.     it(\'should normalize the function name and add the standard suffix including event index\',\n420.       () => {\n421.         expect(sdk.naming.getLambdaSchedulePermissionLogicalId(\'functionName\', 0))\n422.           .to.equal(\'FunctionNameLambdaPermissionEventsRuleSchedule0\');\n423.       });\n424.   });\n425. \n426.   describe(\'#getLambdaApiGatewayPermissionLogicalId()\', () => {\n427.     it(\'should normalize the function name and append the standard suffix\', () => {\n428.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId(\'functionName\'))\n429.         .to.equal(\'FunctionNameLambdaPermissionApiGateway\');\n430.     });\n431.   });\n432. \n433.   describe(\'#getIotLogicalId()\', () => {\n434.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n435.       expect(sdk.naming.getIotLogicalId(\'functionName\', 0))\n436.         .to.equal(\'FunctionNameIotTopicRule0\');\n437.     });\n438.   });\n439. \n440.   describe(\'#getLambdaIotPermissionLogicalId()\', () => {\n441.     it(\'should normalize the function name and add the standard suffix including event index\',\n442.       () => {\n443.         expect(sdk.naming.getLambdaIotPermissionLogicalId(\'functionName\', 0))\n444.           .to.equal(\'FunctionNameLambdaPermissionIotTopicRule0\');\n445.       });\n446.   });\n447. \n448.   describe(\'#getLambdaAlexaSkillPermissionLogicalId()\', () => {\n449.     it(\'should normalize the function name and append the standard suffix\',\n450.       () => {\n451.         expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\'))\n452.           .to.equal(\'FunctionNameLambdaPermissionAlexaSkill\');\n453.       });\n454.   });\n455. });', 'start_line_number': 1, 'end_line_number': 455}]}]
2025-11-14 00:30:38,041 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 1 memories from memory
2025-11-14 00:30:38,041 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 5 contexts from memory
2025-11-14 00:30:38,041 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 5 contexts from memory
2025-11-14 00:30:38,043 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 5 new contexts to 0 existing contexts
2025-11-14 00:30:38,043 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 5 total contexts (removed 0 duplicates)
2025-11-14 00:30:38,044 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


OBJECTIVE: Find 5 relevant existing test cases that demonstrates similar functionality to the reported bug,
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 5 complete, self-contained test cases most similar to bug scenario
- Must include ALL necessary imports at the start of each test file
- Must include full test method implementation
- Must include ALL mock/fixture setup
- Must include helper functions used by test
- Must preserve exact file paths and line numbers

<examples>
<example id="database-timeout">
<bug>
db.execute("SELECT * FROM users").fetchall() 
raises ConnectionTimeout when load is high
</bug>

<ideal_test_match>
# File: tests/test_database.py
import pytest
from unittest.mock import Mock, patch
from database.exceptions import ConnectionTimeout
from database.models import QueryResult
from database.client import DatabaseClient

class TestDatabaseTimeout:
    @pytest.fixture
    def mock_db_connection(self):
        conn = Mock()
        conn.execute.side_effect = [
            ConnectionTimeout("Connection timed out"),
            QueryResult(["user1", "user2"])  # Second try succeeds
        ]
        return conn
        
    def test_handle_timeout_during_query(self, mock_db_connection):
        # Complete test showing timeout scenario
        # Including retry logic verification
        # With all necessary assertions
</ideal_test_match>
</example>

<example id="file-permission">
<bug>
FileProcessor('/root/data.txt').process() 
fails with PermissionError
</bug>

<ideal_test_match>
# File: tests/test_file_processor.py
import os
import pytest
from unittest.mock import patch, mock_open
from file_processor import FileProcessor
from file_processor.exceptions import ProcessingError

class TestFilePermissions:
    @patch('os.access')
    @patch('builtins.open')
    def test_file_permission_denied(self, mock_open, mock_access):
        # Full test setup with mocked file system
        # Permission denial simulation
        # Error handling verification
</ideal_test_match>
</example>

Search priority:
1. Tests of exact same functionality (including import patterns)
2. Tests with similar error conditions
3. Tests with comparable mocking patterns
4. Tests demonstrating similar assertions

Find the 5 most relevant test cases with complete context, ensuring ALL necessary imports are included at the start of each test file.

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content (with line numbers) of the following test files: lib/plugins/aws/deploy/compile/events/iot/index.test.js, lib/classes/YamlParser.test.js, lib/classes/Service.test.js, lib/classes/Variables.test.js, and lib/plugins/aws/provider/awsProvider.test.js.
Extra Requirements: If any of these files do not exist, please provide the closest equivalent tests that cover IoT event compilation and YAML multi-line parsing, with their full content and line numbers.
Purpose: I need these test files to select 5 most relevant cases and reproduce them with all necessary imports, setup, and exact line references.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/classes/Service.test.js
Line number range: 1 - 500
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const YAML = require('js-yaml');
5. const expect = require('chai').expect;
6. const sinon = require('sinon');
7. const Service = require('../../lib/classes/Service');
8. const Utils = require('../../lib/classes/Utils');
9. const Serverless = require('../../lib/Serverless');
10. const testUtils = require('../../tests/utils');
11. 
12. describe('Service', () => {
13.   describe('#constructor()', () => {
14.     const serverless = new Serverless();
15. 
16.     it('should attach serverless instance', () => {
17.       const serviceInstance = new Service(serverless);
18.       expect(typeof serviceInstance.serverless.version).to.be.equal('string');
19.     });
20. 
21.     it('should construct with defaults', () => {
22.       const serviceInstance = new Service(serverless);
23. 
24.       expect(serviceInstance.service).to.be.equal(null);
25.       expect(serviceInstance.provider).to.deep.equal({});
26.       expect(serviceInstance.defaults).to.deep.equal({
27.         stage: 'dev',
28.         region: 'us-east-1',
29.         variableSyntax: '\\${([ :a-zA-Z0-9._,\\-\\/\\(\\)]+?)}',
30.       });
31.       expect(serviceInstance.custom).to.deep.equal({});
32.       expect(serviceInstance.plugins).to.deep.equal([]);
33.       expect(serviceInstance.functions).to.deep.equal({});
34.       expect(serviceInstance.resources).to.deep.equal({});
35.       expect(serviceInstance.package).to.deep.equal({});
36.     });
37. 
38.     it('should construct with data', () => {
39.       const data = {
40.         service: 'testService',
41.         provider: 'testProvider',
42.         custom: {
43.           customProp: 'value',
44.         },
45.         plugins: ['testPlugin'],
46.         functions: {
47.           functionA: {},
48.         },
49.         resources: {
50.           aws: {
51.             resourcesProp: 'value',
52.           },
53.           azure: {},
54.           google: {},
55.         },
56.         package: {
57.           exclude: ['exclude-me'],
58.           include: ['include-me'],
59.           artifact: 'some/path/foo.zip',
60.         },
61.       };
62. 
63.       const serviceInstance = new Service(serverless, data);
64. 
65.       expect(serviceInstance.service).to.be.equal('testService');
66.       expect(serviceInstance.provider).to.be.equal('testProvider');
67.       expect(serviceInstance.custom).to.deep.equal({ customProp: 'value' });
68.       expect(serviceInstance.plugins).to.deep.equal(['testPlugin']);
69.       expect(serviceInstance.functions).to.deep.equal({ functionA: {} });
70.       expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
71.       expect(serviceInstance.resources.azure).to.deep.equal({});
72.       expect(serviceInstance.resources.google).to.deep.equal({});
73.       expect(serviceInstance.package.exclude.length).to.equal(1);
74.       expect(serviceInstance.package.exclude[0]).to.equal('exclude-me');
75.       expect(serviceInstance.package.include.length).to.equal(1);
76.       expect(serviceInstance.package.include[0]).to.equal('include-me');
77.       expect(serviceInstance.package.artifact).to.equal('some/path/foo.zip');
78.     });
79. 
80.     it('should support string based provider config', () => {
81.       const data = {
82.         provider: 'testProvider',
83.       };
84. 
85.       const serviceInstance = new Service(serverless, data);
86. 
87.       expect(serviceInstance.provider).to.be.equal('testProvider');
88.     });
89. 
90.     it('should support object based provider config', () => {
91.       const data = {
92.         provider: {
93.           name: 'testProvider',
94.           runtime: 'nodejs4.3',
95.         },
96.       };
97. 
98.       const serviceInstance = new Service(serverless, data);
99. 
100.       expect(serviceInstance.provider.name).to.be.equal('testProvider');
101.       expect(serviceInstance.provider.runtime).to.be.equal('nodejs4.3');
102.     });
103.   });
104. 
105.   describe('#load()', () => {
106.     let serviceInstance;
107.     let tmpDirPath;
108. 
109.     beforeEach(() => {
110.       tmpDirPath = testUtils.getTmpDirPath();
111.     });
112. 
113.     it('should resolve if no servicePath is found', () => {
114.       const serverless = new Serverless();
115.       const noService = new Service(serverless);
116. 
117.       return noService.load();
118.     });
119. 
120.     it('should load from filesystem', () => {
121.       const SUtils = new Utils();
122.       const serverlessYml = {
123.         service: 'new-service',
124.         provider: 'aws',
125.         defaults: {
126.           stage: 'dev',
127.           region: 'us-east-1',
128.           variableSyntax: '\\${{([\\s\\S]+?)}}',
129.         },
130.         plugins: ['testPlugin'],
131.         functions: {
132.           functionA: {},
133.         },
134.         resources: {
135.           aws: {
136.             resourcesProp: 'value',
137.           },
138.           azure: {},
139.           google: {},
140.         },
141.         package: {
142.           exclude: ['exclude-me'],
143.           include: ['include-me'],
144.           artifact: 'some/path/foo.zip',
145.         },
146.       };
147. 
148.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
149.         YAML.dump(serverlessYml));
150. 
151.       const serverless = new Serverless();
152.       serverless.init();
153.       serverless.config.update({ servicePath: tmpDirPath });
154.       serviceInstance = new Service(serverless);
155. 
156.       return serviceInstance.load().then(() => {
157.         expect(serviceInstance.service).to.be.equal('new-service');
158.         expect(serviceInstance.provider.name).to.deep.equal('aws');
159.         expect(serviceInstance.defaults.variableSyntax).to.equal('\\${{([\\s\\S]+?)}}');
160.         expect(serviceInstance.plugins).to.deep.equal(['testPlugin']);
161.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
162.         expect(serviceInstance.resources.azure).to.deep.equal({});
163.         expect(serviceInstance.resources.google).to.deep.equal({});
164.         expect(serviceInstance.package.exclude.length).to.equal(1);
165.         expect(serviceInstance.package.exclude[0]).to.equal('exclude-me');
166.         expect(serviceInstance.package.include.length).to.equal(1);
167.         expect(serviceInstance.package.include[0]).to.equal('include-me');
168.         expect(serviceInstance.package.artifact).to.equal('some/path/foo.zip');
169.       });
170.     });
171. 
172.     it('should merge resources given as an array', () => {
173.       const SUtils = new Utils();
174.       const serverlessYml = {
175.         service: 'new-service',
176.         provider: 'aws',
177.         resources: [
178.           {
179.             aws: {
180.               resourcesProp: 'value',
181.             },
182.           },
183.           {
184.             azure: {},
185.           },
186.         ],
187.       };
188. 
189.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
190.         YAML.dump(serverlessYml));
191. 
192.       const serverless = new Serverless();
193.       serverless.init();
194.       serverless.config.update({ servicePath: tmpDirPath });
195.       serviceInstance = new Service(serverless);
196. 
197.       return serviceInstance.load().then(() => {
198.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: 'value' });
199.         expect(serviceInstance.resources.azure).to.deep.equal({});
200.       });
201.     });
202. 
203.     it('should make sure function name contains the default stage', () => {
204.       const SUtils = new Utils();
205.       const serverlessYml = {
206.         service: 'new-service',
207.         provider: 'aws',
208.         defaults: {
209.           stage: 'dev',
210.           region: 'us-east-1',
211.           variableSyntax: '\\${{([\\s\\S]+?)}}',
212.         },
213.         plugins: ['testPlugin'],
214.         functions: {
215.           functionA: {},
216.         },
217.         resources: {
218.           aws: {
219.             resourcesProp: 'value',
220.           },
221.           azure: {},
222.           google: {},
223.         },
224.         package: {
225.           exclude: ['exclude-me'],
226.           include: ['include-me'],
227.           artifact: 'some/path/foo.zip',
228.         },
229.       };
230. 
231.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
232.         YAML.dump(serverlessYml));
233. 
234.       const serverless = new Serverless();
235.       serverless.init();
236.       serverless.config.update({ servicePath: tmpDirPath });
237.       serviceInstance = new Service(serverless);
238. 
239.       return serviceInstance.load().then(() => {
240.         expect(serviceInstance.functions.functionA.name).to.be.equal('new-service-dev-functionA');
241.       });
242.     });
243. 
244.     it('should support Serverless file with a non-aws provider', () => {
245.       const SUtils = new Utils();
246.       const serverlessYaml = {
247.         service: 'my-service',
248.         provider: 'openwhisk',
249.         functions: {
250.           functionA: {
251.             name: 'customFunctionName',
252.           },
253.         },
254.       };
255. 
256.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yaml'),
257.         YAML.dump(serverlessYaml));
258. 
259.       const serverless = new Serverless({ servicePath: tmpDirPath });
260.       serviceInstance = new Service(serverless);
261. 
262.       return serviceInstance.load().then(() => {
263.         const expectedFunc = {
264.           functionA: {
265.             name: 'customFunctionName',
266.             events: [],
267.           },
268.         };
269.         expect(serviceInstance.service).to.be.equal('my-service');
270.         expect(serviceInstance.provider.name).to.deep.equal('openwhisk');
271.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
272.       });
273.     });
274. 
275.     it('should support Serverless file with a .yaml extension', () => {
276.       const SUtils = new Utils();
277.       const serverlessYaml = {
278.         service: 'my-service',
279.         provider: 'aws',
280.         functions: {
281.           functionA: {
282.             name: 'customFunctionName',
283.           },
284.         },
285.       };
286. 
287.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yaml'),
288.         YAML.dump(serverlessYaml));
289. 
290.       const serverless = new Serverless({ servicePath: tmpDirPath });
291.       serviceInstance = new Service(serverless);
292. 
293.       return serviceInstance.load().then(() => {
294.         const expectedFunc = {
295.           functionA: {
296.             name: 'customFunctionName',
297.             events: [],
298.           },
299.         };
300.         expect(serviceInstance.service).to.be.equal('my-service');
301.         expect(serviceInstance.provider.name).to.deep.equal('aws');
302.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
303.       });
304.     });
305. 
306.     it('should support Serverless file with a .yml extension', () => {
307.       const SUtils = new Utils();
308.       const serverlessYml = {
309.         service: 'my-service',
310.         provider: 'aws',
311.         functions: {
312.           functionA: {},
313.         },
314.       };
315. 
316.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
317.         YAML.dump(serverlessYml));
318. 
319.       const serverless = new Serverless({ servicePath: tmpDirPath });
320.       serviceInstance = new Service(serverless);
321. 
322.       return serviceInstance.load({ stage: 'dev' }).then(() => {
323.         const expectedFunc = {
324.           functionA: {
325.             name: 'my-service-dev-functionA',
326.             events: [],
327.           },
328.         };
329.         expect(serviceInstance.service).to.be.equal('my-service');
330.         expect(serviceInstance.provider.name).to.deep.equal('aws');
331.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);
332.       });
333.     });
334. 
335.     it('should throw error if service property is missing', () => {
336.       const SUtils = new Utils();
337.       const serverlessYml = {
338.         provider: 'aws',
339.         functions: {},
340.       };
341.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
342.         YAML.dump(serverlessYml));
343. 
344.       const serverless = new Serverless({ servicePath: tmpDirPath });
345.       serviceInstance = new Service(serverless);
346. 
347.       return serviceInstance.load().then(() => {
348.         // if we reach this, then no error was thrown as expected
349.         // so make assertion fail intentionally to let us know something is wrong
350.         expect(1).to.equal(2);
351.       }).catch(e => {
352.         expect(e.name).to.be.equal('ServerlessError');
353.       });
354.     });
355. 
356.     it('should throw error if provider property is missing', () => {
357.       const SUtils = new Utils();
358.       const serverlessYml = {
359.         service: 'service-name',
360.         functions: {},
361.       };
362.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
363.         YAML.dump(serverlessYml));
364. 
365.       const serverless = new Serverless({ servicePath: tmpDirPath });
366.       serviceInstance = new Service(serverless);
367. 
368.       return serviceInstance.load().then(() => {
369.         // if we reach this, then no error was thrown as expected
370.         // so make assertion fail intentionally to let us know something is wrong
371.         expect(1).to.equal(2);
372.       }).catch(e => {
373.         expect(e.name).to.be.equal('ServerlessError');
374.       });
375.     });
376. 
377.     it('should throw error if frameworkVersion is not satisfied', () => {
378.       const SUtils = new Utils();
379.       const serverlessYml = {
380.         service: 'service-name',
381.         frameworkVersion: '=1.0.0',
382.         provider: 'aws',
383.         functions: {},
384.       };
385.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
386.         YAML.dump(serverlessYml));
387. 
388.       const serverless = new Serverless({ servicePath: tmpDirPath });
389.       const getVersion = sinon.stub(serverless.utils, 'getVersion');
390.       getVersion.returns('1.0.2');
391.       serviceInstance = new Service(serverless);
392. 
393.       return serviceInstance.load().then(() => {
394.         // if we reach this, then no error was thrown as expected
395.         // so make assertion fail intentionally to let us know something is wrong
396.         expect(1).to.equal(2);
397.       }).catch(e => {
398.         expect(e.name).to.be.equal('ServerlessError');
399.       });
400.     });
401. 
402.     it('should pass if frameworkVersion is satisfied', () => {
403.       const SUtils = new Utils();
404.       const serverlessYml = {
405.         service: 'service-name',
406.         frameworkVersion: '>=1.0.0',
407.         provider: 'aws',
408.         functions: {},
409.       };
410.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
411.         YAML.dump(serverlessYml));
412. 
413.       const serverless = new Serverless({ servicePath: tmpDirPath });
414.       const getVersion = sinon.stub(serverless.utils, 'getVersion');
415.       getVersion.returns('1.2.2');
416.       serviceInstance = new Service(serverless);
417. 
418.       return serviceInstance.load().then(() => {
419.         // if this callbar is reached, then no error was thrown as expected
420.         expect(1).to.equal(1);
421.       });
422.     });
423. 
424.     it('should not throw error if functions property is missing', () => {
425.       const SUtils = new Utils();
426.       const serverlessYml = {
427.         service: 'service-name',
428.         provider: 'aws',
429.       };
430.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
431.         YAML.dump(serverlessYml));
432. 
433.       const serverless = new Serverless({ servicePath: tmpDirPath });
434.       serviceInstance = new Service(serverless);
435. 
436.       return serviceInstance.load().then(() => {
437.         expect(serverless.service.functions).to.deep.equal({});
438.       });
439.     });
440. 
441.     it("should throw error if a function's event is not an array", () => {
442.       const SUtils = new Utils();
443.       const serverlessYml = {
444.         service: 'service-name',
445.         provider: 'aws',
446.         functions: {
447.           functionA: {
448.             events: {},
449.           },
450.         },
451.       };
452.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
453.         YAML.dump(serverlessYml));
454. 
455.       const serverless = new Serverless({ servicePath: tmpDirPath });
456.       serviceInstance = new Service(serverless);
457. 
458.       return serviceInstance.load().then(() => {
459.         // if we reach this, then no error was thrown as expected
460.         // so make assertion fail intentionally to let us know something is wrong
461.         expect(1).to.equal(2);
462.       }).catch(e => {
463.         expect(e.name).to.be.equal('ServerlessError');
464.       });
465.     });
466. 
467.     it('should throw error if provider property is invalid', () => {
468.       const SUtils = new Utils();
469.       const serverlessYml = {
470.         service: 'service-name',
471.         provider: 'invalid',
472.         functions: {},
473.       };
474. 
475.       SUtils.writeFileSync(path.join(tmpDirPath, 'serverless.yml'),
476.         YAML.dump(serverlessYml));
477. 
478.       const serverless = new Serverless({ servicePath: tmpDirPath });
479.       serviceInstance = new Service(serverless);
480. 
481.       return serviceInstance.load().then(() => {
482.         // if we reach this, then no error was thrown as expected
483.         // so make assertion fail intentionally to let us know something is wrong
484.         expect(1).to.equal(2);
485.       }).catch(e => {
486.         expect(e.name).to.be.equal('ServerlessError');
487.       });
488.     });
489.   });
490. 
491.   describe('#update()', () => {
492.     it('should update service instance data', () => {
493.       const serverless = new Serverless();
494.       const serviceInstance = new Service(serverless);
495.       const newData = { service: 'newName' };
496.       const updatedInstance = serviceInstance.update(newData);
497.       expect(updatedInstance.service).to.be.equal('newName');
498.     });
499.   });
500. 


File: lib/classes/YamlParser.test.js
Line number range: 1 - 99
Content:
1. 'use strict';
2. 
3. /**
4.  * Test: YamlParser Function Class
5.  */
6. 
7. const expect = require('chai').expect;
8. const YAML = require('js-yaml');
9. const path = require('path');
10. const Serverless = require('../../lib/Serverless');
11. const testUtils = require('../../tests/utils');
12. 
13. const serverless = new Serverless();
14. 
15. describe('YamlParser', () => {
16.   describe('#parse()', () => {
17.     it('should parse a simple .yaml file', () => {
18.       const tmpFilePath = testUtils.getTmpFilePath('simple.yaml');
19. 
20.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));
21. 
22.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {
23.         expect(obj.foo).to.equal('bar');
24.       });
25.     });
26. 
27.     it('should parse a simple .yml file', () => {
28.       const tmpFilePath = testUtils.getTmpFilePath('simple.yml');
29. 
30.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));
31. 
32.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {
33.         expect(obj.foo).to.equal('bar');
34.       });
35.     });
36. 
37.     it('should parse a .yml file with JSON-REF to YAML', () => {
38.       const tmpDirPath = testUtils.getTmpDirPath();
39. 
40.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.yml'), { foo: 'bar' });
41. 
42.       const testYml = {
43.         main: {
44.           $ref: './ref.yml',
45.         },
46.       };
47. 
48.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);
49. 
50.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {
51.         expect(obj.main.foo).to.equal('bar');
52.       });
53.     });
54. 
55.     it('should parse a .yml file with JSON-REF to JSON', () => {
56.       const tmpDirPath = testUtils.getTmpDirPath();
57. 
58.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.json'), { foo: 'bar' });
59. 
60.       const testYml = {
61.         main: {
62.           $ref: './ref.json',
63.         },
64.       };
65. 
66.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);
67. 
68.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {
69.         expect(obj.main.foo).to.equal('bar');
70.       });
71.     });
72. 
73.     it('should parse a .yml file with recursive JSON-REF', () => {
74.       const tmpDirPath = testUtils.getTmpDirPath();
75. 
76.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'three.yml'), { foo: 'bar' });
77. 
78.       const twoYml = {
79.         two: {
80.           $ref: './three.yml',
81.         },
82.       };
83. 
84.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'two.yml'), twoYml);
85. 
86.       const oneYml = {
87.         one: {
88.           $ref: './two.yml',
89.         },
90.       };
91. 
92.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'one.yml'), oneYml);
93. 
94.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'one.yml')).then((obj) => {
95.         expect(obj.one.two.foo).to.equal('bar');
96.       });
97.     });
98.   });
99. });


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }
14. 
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }
47. 
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;
96. 
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);
107.           }
108.         });
109.       }
110.     });
111.   }
112. }
113. module.exports = AwsCompileIoTEvents;


File: lib/plugins/aws/deploy/compile/events/iot/index.test.js
Line number range: 1 - 229
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsProvider = require('../../../../provider/awsProvider');
5. const AwsCompileIoTEvents = require('./index');
6. const Serverless = require('../../../../../../Serverless');
7. 
8. describe('AwsCompileIoTEvents', () => {
9.   let serverless;
10.   let awsCompileIoTEvents;
11. 
12.   beforeEach(() => {
13.     serverless = new Serverless();
14.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
15.     serverless.setProvider('aws', new AwsProvider(serverless));
16.     awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
17.     awsCompileIoTEvents.serverless.service.service = 'new-service';
18.   });
19. 
20.   describe('#constructor()', () => {
21.     it('should set the provider variable to an instance of AwsProvider', () =>
22.       expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));
23.   });
24. 
25.   describe('#awsCompileIoTEvents()', () => {
26.     it('should throw an error if iot event type is not an object', () => {
27.       awsCompileIoTEvents.serverless.service.functions = {
28.         first: {
29.           events: [
30.             {
31.               iot: 'iot',
32.             },
33.           ],
34.         },
35.       };
36. 
37.       expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);
38.     });
39. 
40.     it('should create corresponding resources when iot events are given', () => {
41.       awsCompileIoTEvents.serverless.service.functions = {
42.         first: {
43.           events: [
44.             {
45.               iot: {
46.                 sql: "SELECT * FROM 'topic_1'",
47.               },
48.             },
49.             {
50.               iot: {
51.                 sql: "SELECT * FROM 'topic_2'",
52.               },
53.             },
54.           ],
55.         },
56.       };
57. 
58.       awsCompileIoTEvents.compileIoTEvents();
59. 
60.       expect(awsCompileIoTEvents.serverless.service
61.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type
62.       ).to.equal('AWS::IoT::TopicRule');
63.       expect(awsCompileIoTEvents.serverless.service
64.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type
65.       ).to.equal('AWS::IoT::TopicRule');
66.       expect(awsCompileIoTEvents.serverless.service
67.         .provider.compiledCloudFormationTemplate.Resources
68.         .FirstIotTopicRule1.Properties.TopicRulePayload.Sql
69.       ).to.equal('SELECT * FROM \'topic_1\'');
70.       expect(awsCompileIoTEvents.serverless.service
71.         .provider.compiledCloudFormationTemplate.Resources
72.         .FirstIotTopicRule2.Properties.TopicRulePayload.Sql
73.       ).to.equal('SELECT * FROM \'topic_2\'');
74.       expect(awsCompileIoTEvents.serverless.service
75.         .provider.compiledCloudFormationTemplate.Resources
76.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
77.       ).to.equal('false');
78.       expect(awsCompileIoTEvents.serverless.service
79.         .provider.compiledCloudFormationTemplate.Resources
80.         .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled
81.       ).to.equal('false');
82.       expect(awsCompileIoTEvents.serverless.service
83.         .provider.compiledCloudFormationTemplate.Resources
84.         .FirstLambdaPermissionIotTopicRule1.Type
85.       ).to.equal('AWS::Lambda::Permission');
86.       expect(awsCompileIoTEvents.serverless.service
87.         .provider.compiledCloudFormationTemplate.Resources
88.         .FirstLambdaPermissionIotTopicRule2.Type
89.       ).to.equal('AWS::Lambda::Permission');
90.     });
91. 
92.     it('should respect "name" variable', () => {
93.       awsCompileIoTEvents.serverless.service.functions = {
94.         first: {
95.           events: [
96.             {
97.               iot: {
98.                 name: 'iotEvantName',
99.                 sql: "SELECT * FROM 'topic_1'",
100.               },
101.             },
102.           ],
103.         },
104.       };
105. 
106.       awsCompileIoTEvents.compileIoTEvents();
107. 
108.       expect(awsCompileIoTEvents.serverless.service
109.         .provider.compiledCloudFormationTemplate.Resources
110.         .FirstIotTopicRule1.Properties.RuleName
111.       ).to.equal('iotEvantName');
112.     });
113. 
114.     it('should respect "enabled" variable', () => {
115.       awsCompileIoTEvents.serverless.service.functions = {
116.         first: {
117.           events: [
118.             {
119.               iot: {
120.                 enabled: false,
121.                 sql: "SELECT * FROM 'topic_1'",
122.               },
123.             },
124.           ],
125.         },
126.         second: {
127.           events: [
128.             {
129.               iot: {
130.                 enabled: true,
131.                 sql: "SELECT * FROM 'topic_1'",
132.               },
133.             },
134.           ],
135.         },
136.       };
137. 
138.       awsCompileIoTEvents.compileIoTEvents();
139. 
140.       expect(awsCompileIoTEvents.serverless.service
141.         .provider.compiledCloudFormationTemplate.Resources
142.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
143.       ).to.equal('true');
144.       expect(awsCompileIoTEvents.serverless.service
145.         .provider.compiledCloudFormationTemplate.Resources
146.         .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
147.       ).to.equal('false');
148.     });
149. 
150.     it('should respect "sqlVersion" variable', () => {
151.       awsCompileIoTEvents.serverless.service.functions = {
152.         first: {
153.           events: [
154.             {
155.               iot: {
156.                 sqlVersion: '2016-03-23',
157.                 sql: "SELECT * FROM 'topic_1'",
158.               },
159.             },
160.           ],
161.         },
162.       };
163. 
164.       awsCompileIoTEvents.compileIoTEvents();
165. 
166.       expect(awsCompileIoTEvents.serverless.service
167.         .provider.compiledCloudFormationTemplate.Resources
168.         .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion
169.       ).to.equal('2016-03-23');
170.     });
171. 
172.     it('should respect "description" variable', () => {
173.       awsCompileIoTEvents.serverless.service.functions = {
174.         first: {
175.           events: [
176.             {
177.               iot: {
178.                 description: 'iot event description',
179.                 sql: "SELECT * FROM 'topic_1'",
180.               },
181.             },
182.           ],
183.         },
184.       };
185. 
186.       awsCompileIoTEvents.compileIoTEvents();
187. 
188.       expect(awsCompileIoTEvents.serverless.service
189.         .provider.compiledCloudFormationTemplate.Resources
190.         .FirstIotTopicRule1.Properties.TopicRulePayload.Description
191.       ).to.equal('iot event description');
192.     });
193. 
194.     it('should respect enabled variable if the "enabled" property is not given', () => {
195.       awsCompileIoTEvents.serverless.service.functions = {
196.         first: {
197.           events: [
198.             {
199.               iot: {
200.                 sql: "SELECT * FROM 'topic_1'",
201.               },
202.             },
203.           ],
204.         },
205.       };
206. 
207.       awsCompileIoTEvents.compileIoTEvents();
208. 
209.       expect(awsCompileIoTEvents.serverless.service
210.         .provider.compiledCloudFormationTemplate.Resources
211.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
212.       ).to.equal('false');
213.     });
214. 
215.     it('should not create corresponding resources when iot events are not given', () => {
216.       awsCompileIoTEvents.serverless.service.functions = {
217.         first: {
218.           events: [],
219.         },
220.       };
221. 
222.       awsCompileIoTEvents.compileIoTEvents();
223. 
224.       expect(awsCompileIoTEvents.serverless.service
225.         .provider.compiledCloudFormationTemplate.Resources
226.       ).to.deep.equal({});
227.     });
228.   });
229. });


File: lib/plugins/aws/lib/naming.test.js
Line number range: 1 - 455
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. 
5. const SDK = require('../provider/awsProvider');
6. const Serverless = require('../../../Serverless');
7. 
8. describe('#naming()', () => {
9.   let options;
10.   let serverless;
11.   let sdk;
12. 
13.   beforeEach(() => {
14.     options = {
15.       stage: 'dev',
16.       region: 'us-east-1',
17.     };
18.     serverless = new Serverless(options);
19.     sdk = new SDK(serverless, options);
20.   });
21. 
22.   describe('#normalizeName()', () => {
23.     it('should capitalize the first letter', () => {
24.       expect(sdk.naming.normalizeName('name')).to.equal('Name');
25.     });
26. 
27.     it('should have no effect on caps', () => {
28.       expect(sdk.naming.normalizeName('Name')).to.equal('Name');
29.     });
30. 
31.     it('should have no effect on the rest of the name', () => {
32.       expect(sdk.naming.normalizeName('nAME')).to.equal('NAME');
33.     });
34.   });
35. 
36.   describe('#normalizeNameToAlphaNumericOnly()', () => {
37.     it('should strip non-alpha-numeric characters', () => {
38.       expect(sdk.naming
39.         .normalizeNameToAlphaNumericOnly('`!@#$%^&*()-={}|[]\\:";\'<>?,./')).to.equal('');
40.     });
41. 
42.     it('should apply normalizeName to the remaining characters', () => {
43.       expect(sdk.naming.normalizeNameToAlphaNumericOnly('a-b-c')).to.equal('Abc');
44.     });
45.   });
46. 
47.   describe('#normalizePathPart()', () => {
48.     it('converts `-` to `Dash`', () => {
49.       expect(sdk.naming.normalizePathPart(
50.         'a-path'
51.       )).to.equal('ADashpath');
52.     });
53. 
54.     it('converts variable declarations (`${var}`) to `VariableVar`', () => {
55.       expect(sdk.naming.normalizePathPart(
56.         '${variable}'
57.       )).to.equal('VariableVar');
58.     });
59. 
60.     it('converts variable declarations prefixes to `VariableVarpath`', () => {
61.       expect(sdk.naming.normalizePathPart(
62.         '${variable}Path'
63.       )).to.equal('VariableVarpath');
64.     });
65. 
66.     it('converts variable declarations suffixes to `PathvariableVar`', () => {
67.       expect(sdk.naming.normalizePathPart(
68.         'path${variable}'
69.       )).to.equal('PathvariableVar');
70.     });
71. 
72.     it('converts variable declarations in center to `PathvariableVardir`', () => {
73.       expect(sdk.naming.normalizePathPart(
74.         'path${variable}Dir'
75.       )).to.equal('PathvariableVardir');
76.     });
77.   });
78. 
79.   describe('#getServiceEndpointRegex()', () => {
80.     it('should match the prefix', () => {
81.       expect(sdk.naming.getServiceEndpointRegex().test('ServiceEndpoint'))
82.         .to.equal(true);
83.     });
84. 
85.     it('should not match a name without the prefix', () => {
86.       expect(sdk.naming.getServiceEndpointRegex()
87.         .test('NotThePrefixServiceEndpoint')).to.equal(false);
88.     });
89. 
90.     it('should match a name with the prefix', () => {
91.       expect(sdk.naming.getServiceEndpointRegex()
92.         .test('ServiceEndpointForAService')).to.equal(true);
93.     });
94.   });
95. 
96.   describe('#getStackName()', () => {
97.     it('should use the service name and stage from the service and config', () => {
98.       serverless.service.service = 'myService';
99.       expect(sdk.naming.getStackName()).to.equal(`${serverless.service.service}-${options.stage}`);
100.     });
101.   });
102. 
103.   describe('#getRolePath()', () => {
104.     it('should return `/`', () => {
105.       expect(sdk.naming.getRolePath()).to.equal('/');
106.     });
107.   });
108. 
109.   describe('#getRoleName()', () => {
110.     it('uses the service name, stage, and region to generate a role name', () => {
111.       serverless.service.service = 'myService';
112.       expect(sdk.naming.getRoleName()).to.eql({
113.         'Fn::Join': [
114.           '-',
115.           [
116.             serverless.service.service,
117.             options.stage,
118.             options.region,
119.             'lambdaRole',
120.           ],
121.         ],
122.       });
123.     });
124.   });
125. 
126.   describe('#getRoleLogicalId()', () => {
127.     it('should return the expected role name (IamRoleLambdaExecution)', () => {
128.       expect(sdk.naming.getRoleLogicalId()).to.equal('IamRoleLambdaExecution');
129.     });
130.   });
131. 
132.   describe('#getPolicyName()', () => {
133.     it('should use the stage and service name', () => {
134.       serverless.service.service = 'myService';
135.       expect(sdk.naming.getPolicyName()).to.eql({
136.         'Fn::Join': [
137.           '-',
138.           [
139.             options.stage,
140.             serverless.service.service,
141.             'lambda',
142.           ],
143.         ],
144.       });
145.     });
146.   });
147. 
148.   describe('#getPolicyLogicalId()', () => {
149.     it('should return the expected policy name (IamPolicyLambdaExecution)', () => {
150.       expect(sdk.naming.getPolicyLogicalId()).to.equal('IamPolicyLambdaExecution');
151.     });
152.   });
153. 
154.   describe('#getLogicalLogGroupName()', () => {
155.     it('should prefix the normalized function name to "LogGroup"', () => {
156.       expect(sdk.naming.getLogGroupLogicalId('functionName')).to.equal('FunctionNameLogGroup');
157.     });
158.   });
159. 
160.   describe('#getLogGroupName()', () => {
161.     it('should add the function name to the log group name', () => {
162.       expect(sdk.naming.getLogGroupName('functionName')).to.equal('/aws/lambda/functionName');
163.     });
164.   });
165. 
166.   describe('#getNormalizedFunctionName()', () => {
167.     it('should normalize the given functionName', () => {
168.       expect(sdk.naming.getNormalizedFunctionName('functionName'))
169.         .to.equal('FunctionName');
170.     });
171. 
172.     it('should normalize the given functionName with an underscore', () => {
173.       expect(sdk.naming.getNormalizedFunctionName('hello_world'))
174.         .to.equal('HelloUnderscoreworld');
175.     });
176. 
177.     it('should normalize the given functionName with a dash', () => {
178.       expect(sdk.naming.getNormalizedFunctionName('hello-world'))
179.         .to.equal('HelloDashworld');
180.     });
181.   });
182. 
183.   describe('#extractAuthorizerNameFromArn()', () => {
184.     it('should extract everything after the last colon and dash', () => {
185.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
186.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
187.     });
188.   });
189. 
190.   describe('#extractLambdaNameFromArn()', () => {
191.     it('should extract everything after the last colon', () => {
192.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
193.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal('my-dev-lambda');
194.     });
195.   });
196. 
197.   describe('#getLambdaLogicalId()', () => {
198.     it('should normalize the function name and add the logical suffix', () => {
199.       expect(sdk.naming.getLambdaLogicalId('functionName'))
200.         .to.equal('FunctionNameLambdaFunction');
201.     });
202.   });
203. 
204.   describe('#getLambdaLogicalIdRegex()', () => {
205.     it('should match the suffix', () => {
206.       expect(sdk.naming.getLambdaLogicalIdRegex()
207.         .test('LambdaFunction')).to.equal(true);
208.     });
209. 
210.     it('should not match a name without the suffix', () => {
211.       expect(sdk.naming.getLambdaLogicalIdRegex()
212.         .test('LambdaFunctionNotTheSuffix')).to.equal(false);
213.     });
214. 
215.     it('should match a name with the suffix', () => {
216.       expect(sdk.naming.getLambdaLogicalIdRegex()
217.         .test('AFunctionNameLambdaFunction')).to.equal(true);
218.     });
219.   });
220. 
221.   describe('#getLambdaOutputLogicalId()', () => {
222.     it('should normalize the function name and add the logical arn suffix', () => {
223.       expect(
224.         sdk.naming.getLambdaOutputLogicalId('functionName')
225.       ).to.equal('FunctionNameLambdaFunctionArn');
226.     });
227.   });
228. 
229.   describe('#getLambdaOutputLogicalIdRegex()', () => {
230.     it('should match the suffix', () => {
231.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
232.         .test('aLambdaFunctionArn')).to.equal(true);
233.     });
234. 
235.     it('should not match a name without the suffix', () => {
236.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
237.         .test('LambdaFunctionArnNotTheSuffix'))
238.         .to.equal(false);
239.     });
240. 
241.     it('should match a name with the suffix', () => {
242.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()
243.         .test('AFunctionArnNameLambdaFunctionArn'))
244.         .to.equal(true);
245.     });
246.   });
247. 
248.   describe('#getApiGatewayName()', () => {
249.     it('should return the composition of stage and service name', () => {
250.       serverless.service.service = 'myService';
251.       expect(sdk.naming.getApiGatewayName())
252.         .to.equal(`${options.stage}-${serverless.service.service}`);
253.     });
254.   });
255. 
256.   describe('#generateApiGatewayDeploymentLogicalId()', () => {
257.     it('should return ApiGatewayDeployment with a date based suffix', () => {
258.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId()
259.         .match(/ApiGatewayDeployment(.*)/).length)
260.         .to.be.greaterThan(1);
261.     });
262.   });
263. 
264.   describe('#getRestApiLogicalId()', () => {
265.     it('should return ApiGatewayRestApi', () => {
266.       expect(sdk.naming.getRestApiLogicalId()).to.equal('ApiGatewayRestApi');
267.     });
268.   });
269. 
270.   describe('#getNormalizedAuthorizerName()', () => {
271.     it('normalize the authorizer name', () => {
272.       expect(sdk.naming.getNormalizedAuthorizerName('authorizerName'))
273.         .to.equal('AuthorizerName');
274.     });
275.   });
276. 
277.   describe('#getAuthorizerLogicalId()', () => {
278.     it('should normalize the authorizer name and add the standard suffix', () => {
279.       expect(sdk.naming.getAuthorizerLogicalId('authorizerName'))
280.         .to.equal('AuthorizerNameApiGatewayAuthorizer');
281.     });
282.   });
283. 
284.   describe('#extractAuthorizerNameFromArn()', () => {
285.     it('should extract the authorizer name from an ARN', () => {
286.       const arn = 'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda';
287.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal('lambda');
288.     });
289.   });
290. 
291.   describe('#normalizePath()', () => {
292.     it('should normalize each part of the resource path and remove non-alpha-numeric characters',
293.       () => {
294.         expect(sdk.naming.normalizePath(
295.           'my/path/to/a-${var}-resource'
296.         )).to.equal('MyPathToADashvarVarDashresource');
297.       });
298.   });
299. 
300.   describe('#getResourceLogicalId()', () => {
301.     it('should normalize the resource and add the standard suffix', () => {
302.       expect(sdk.naming.getResourceLogicalId(
303.         'my/path/to/a-${var}-resource'
304.       )).to.equal('ApiGatewayResourceMyPathToADashvarVarDashresource');
305.     });
306.   });
307. 
308.   describe('#extractResourceId()', () => {
309.     it('should extract the normalized resource name', () => {
310.       expect(sdk.naming.extractResourceId(
311.         'ApiGatewayResourceMyPathToADashvarVarDashResource'
312.       )).to.equal('MyPathToADashvarVarDashResource');
313.     });
314.   });
315. 
316.   describe('#normalizeMethodName()', () => {
317.     it('should capitalize the first letter and lowercase any other characters', () => {
318.       expect(sdk.naming.normalizeMethodName('gET')).to.equal('Get');
319.     });
320.   });
321. 
322.   describe('#getMethodLogicalId()', () => {
323.     it('', () => {
324.       expect(sdk.naming.getMethodLogicalId(
325.         'ResourceId', 'get'
326.       )).to.equal('ApiGatewayMethodResourceIdGet');
327.     });
328.   });
329. 
330.   describe('#getApiKeyLogicalId(keyIndex)', () => {
331.     it('should produce the given index with ApiGatewayApiKey as a prefix', () => {
332.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal('ApiGatewayApiKey1');
333.     });
334.   });
335. 
336.   describe('#getApiKeyLogicalIdRegex()', () => {
337.     it('should match the prefix', () => {
338.       expect(sdk.naming.getApiKeyLogicalIdRegex()
339.         .test('ApiGatewayApiKey')).to.equal(true);
340.     });
341. 
342.     it('should not match a name without the prefix', () => {
343.       expect(sdk.naming.getApiKeyLogicalIdRegex()
344.         .test('NotThePrefixApiGatewayApiKey')).to.equal(false);
345.     });
346. 
347.     it('should match a name with the prefix', () => {
348.       expect(sdk.naming.getApiKeyLogicalIdRegex()
349.         .test('ApiGatewayApiKeySuffix')).to.equal(true);
350.     });
351.   });
352. 
353.   describe('#getDeploymentBucketLogicalId()', () => {
354.     it('should return "ServerlessDeploymentBucket"', () => {
355.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal('ServerlessDeploymentBucket');
356.     });
357.   });
358. 
359.   describe('#getDeploymentBucketOutputLogicalId()', () => {
360.     it('should return "ServerlessDeploymentBucketName"', () => {
361.       expect(sdk.naming.getDeploymentBucketOutputLogicalId())
362.         .to.equal('ServerlessDeploymentBucketName');
363.     });
364.   });
365. 
366.   describe('#normalizeBucketName()', () => {
367.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
368.       expect(sdk.naming.normalizeBucketName('b!u@c#k$e%t^N&a*m(e')).to.equal('BucketName');
369.     });
370.   });
371. 
372.   describe('#getBucketLogicalId()', () => {
373.     it('should normalize the bucket name and add the standard prefix', () => {
374.       expect(sdk.naming.getBucketLogicalId('b!u@c#k$e%t^N&a*m(e')).to.equal('S3BucketBucketName');
375.     });
376.   });
377. 
378.   describe('#normalizeTopicName()', () => {
379.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
380.       expect(sdk.naming.normalizeTopicName('t!o@p#i$c%N^a&m*e')).to.equal('TopicName');
381.     });
382.   });
383. 
384.   describe('#getTopicLogicalId()', () => {
385.     it('should remove all non-alpha-numeric characters and capitalize the first letter', () => {
386.       expect(sdk.naming.getTopicLogicalId('t!o@p#i$c%N^a&m*e')).to.equal('SNSTopicTopicName');
387.     });
388.   });
389. 
390.   describe('#getScheduleId()', () => {
391.     it('should add the standard suffix', () => {
392.       expect(sdk.naming.getScheduleId('functionName')).to.equal('functionNameSchedule');
393.     });
394.   });
395. 
396.   describe('#getScheduleLogicalId()', () => {
397.     it('should normalize the function name and add the standard suffix including the index', () => {
398.       expect(sdk.naming.getScheduleLogicalId('functionName', 0))
399.         .to.equal('FunctionNameEventsRuleSchedule0');
400.     });
401.   });
402. 
403.   describe('#getLambdaS3PermissionLogicalId()', () => {
404.     it('should normalize the function name and add the standard suffix', () => {
405.       expect(sdk.naming.getLambdaS3PermissionLogicalId('functionName', 'bucket'))
406.         .to.equal('FunctionNameLambdaPermissionBucketS3');
407.     });
408.   });
409. 
410.   describe('#getLambdaSnsPermissionLogicalId()', () => {
411.     it('should normalize the function and topic names and add them as prefix and suffix to the ' +
412.       'standard permission center', () => {
413.       expect(sdk.naming.getLambdaSnsPermissionLogicalId('functionName', 'topic'))
414.         .to.equal('FunctionNameLambdaPermissionTopicSNS');
415.     });
416.   });
417. 
418.   describe('#getLambdaSchedulePermissionLogicalId()', () => {
419.     it('should normalize the function name and add the standard suffix including event index',
420.       () => {
421.         expect(sdk.naming.getLambdaSchedulePermissionLogicalId('functionName', 0))
422.           .to.equal('FunctionNameLambdaPermissionEventsRuleSchedule0');
423.       });
424.   });
425. 
426.   describe('#getLambdaApiGatewayPermissionLogicalId()', () => {
427.     it('should normalize the function name and append the standard suffix', () => {
428.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId('functionName'))
429.         .to.equal('FunctionNameLambdaPermissionApiGateway');
430.     });
431.   });
432. 
433.   describe('#getIotLogicalId()', () => {
434.     it('should normalize the function name and add the standard suffix including the index', () => {
435.       expect(sdk.naming.getIotLogicalId('functionName', 0))
436.         .to.equal('FunctionNameIotTopicRule0');
437.     });
438.   });
439. 
440.   describe('#getLambdaIotPermissionLogicalId()', () => {
441.     it('should normalize the function name and add the standard suffix including event index',
442.       () => {
443.         expect(sdk.naming.getLambdaIotPermissionLogicalId('functionName', 0))
444.           .to.equal('FunctionNameLambdaPermissionIotTopicRule0');
445.       });
446.   });
447. 
448.   describe('#getLambdaAlexaSkillPermissionLogicalId()', () => {
449.     it('should normalize the function name and append the standard suffix',
450.       () => {
451.         expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId('functionName'))
452.           .to.equal('FunctionNameLambdaPermissionAlexaSkill');
453.       });
454.   });
455. });

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:31:48,813 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The bug pertains to AWS IoT event compilation producing invalid JSON when multi-line YAML scalars are used. The aggregated context includes the IoT compiler implementation (lib/plugins/aws/deploy/compile/events/iot/index.js) and its dedicated test file with line numbers (lib/plugins/aws/deploy/compile/events/iot/index.test.js), plus YAML parsing and Service loading tests. From the IoT test file, there are multiple specific tests directly exercising the same compilation path and fields (sql, description, enabled, name) and asserting on the compiled CloudFormation template. These are the most relevant to the reported issue and contain all necessary imports and setup. Therefore, no additional context is required to provide 5 relevant, complete test cases with exact file paths and line numbers.' query='' extra_requirements='' purpose=''
2025-11-14 00:31:48,815 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='lib/classes/Service.test.js', content='1. \'use strict\';\n2. \n3. const path = require(\'path\');\n4. const YAML = require(\'js-yaml\');\n5. const expect = require(\'chai\').expect;\n6. const sinon = require(\'sinon\');\n7. const Service = require(\'../../lib/classes/Service\');\n8. const Utils = require(\'../../lib/classes/Utils\');\n9. const Serverless = require(\'../../lib/Serverless\');\n10. const testUtils = require(\'../../tests/utils\');\n11. \n12. describe(\'Service\', () => {\n13.   describe(\'#constructor()\', () => {\n14.     const serverless = new Serverless();\n15. \n16.     it(\'should attach serverless instance\', () => {\n17.       const serviceInstance = new Service(serverless);\n18.       expect(typeof serviceInstance.serverless.version).to.be.equal(\'string\');\n19.     });\n20. \n21.     it(\'should construct with defaults\', () => {\n22.       const serviceInstance = new Service(serverless);\n23. \n24.       expect(serviceInstance.service).to.be.equal(null);\n25.       expect(serviceInstance.provider).to.deep.equal({});\n26.       expect(serviceInstance.defaults).to.deep.equal({\n27.         stage: \'dev\',\n28.         region: \'us-east-1\',\n29.         variableSyntax: \'\\\\${([ :a-zA-Z0-9._,\\\\-\\\\/\\\\(\\\\)]+?)}\',\n30.       });\n31.       expect(serviceInstance.custom).to.deep.equal({});\n32.       expect(serviceInstance.plugins).to.deep.equal([]);\n33.       expect(serviceInstance.functions).to.deep.equal({});\n34.       expect(serviceInstance.resources).to.deep.equal({});\n35.       expect(serviceInstance.package).to.deep.equal({});\n36.     });\n37. \n38.     it(\'should construct with data\', () => {\n39.       const data = {\n40.         service: \'testService\',\n41.         provider: \'testProvider\',\n42.         custom: {\n43.           customProp: \'value\',\n44.         },\n45.         plugins: [\'testPlugin\'],\n46.         functions: {\n47.           functionA: {},\n48.         },\n49.         resources: {\n50.           aws: {\n51.             resourcesProp: \'value\',\n52.           },\n53.           azure: {},\n54.           google: {},\n55.         },\n56.         package: {\n57.           exclude: [\'exclude-me\'],\n58.           include: [\'include-me\'],\n59.           artifact: \'some/path/foo.zip\',\n60.         },\n61.       };\n62. \n63.       const serviceInstance = new Service(serverless, data);\n64. \n65.       expect(serviceInstance.service).to.be.equal(\'testService\');\n66.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n67.       expect(serviceInstance.custom).to.deep.equal({ customProp: \'value\' });\n68.       expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n69.       expect(serviceInstance.functions).to.deep.equal({ functionA: {} });\n70.       expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n71.       expect(serviceInstance.resources.azure).to.deep.equal({});\n72.       expect(serviceInstance.resources.google).to.deep.equal({});\n73.       expect(serviceInstance.package.exclude.length).to.equal(1);\n74.       expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n75.       expect(serviceInstance.package.include.length).to.equal(1);\n76.       expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n77.       expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n78.     });\n79. \n80.     it(\'should support string based provider config\', () => {\n81.       const data = {\n82.         provider: \'testProvider\',\n83.       };\n84. \n85.       const serviceInstance = new Service(serverless, data);\n86. \n87.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n88.     });\n89. \n90.     it(\'should support object based provider config\', () => {\n91.       const data = {\n92.         provider: {\n93.           name: \'testProvider\',\n94.           runtime: \'nodejs4.3\',\n95.         },\n96.       };\n97. \n98.       const serviceInstance = new Service(serverless, data);\n99. \n100.       expect(serviceInstance.provider.name).to.be.equal(\'testProvider\');\n101.       expect(serviceInstance.provider.runtime).to.be.equal(\'nodejs4.3\');\n102.     });\n103.   });\n104. \n105.   describe(\'#load()\', () => {\n106.     let serviceInstance;\n107.     let tmpDirPath;\n108. \n109.     beforeEach(() => {\n110.       tmpDirPath = testUtils.getTmpDirPath();\n111.     });\n112. \n113.     it(\'should resolve if no servicePath is found\', () => {\n114.       const serverless = new Serverless();\n115.       const noService = new Service(serverless);\n116. \n117.       return noService.load();\n118.     });\n119. \n120.     it(\'should load from filesystem\', () => {\n121.       const SUtils = new Utils();\n122.       const serverlessYml = {\n123.         service: \'new-service\',\n124.         provider: \'aws\',\n125.         defaults: {\n126.           stage: \'dev\',\n127.           region: \'us-east-1\',\n128.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n129.         },\n130.         plugins: [\'testPlugin\'],\n131.         functions: {\n132.           functionA: {},\n133.         },\n134.         resources: {\n135.           aws: {\n136.             resourcesProp: \'value\',\n137.           },\n138.           azure: {},\n139.           google: {},\n140.         },\n141.         package: {\n142.           exclude: [\'exclude-me\'],\n143.           include: [\'include-me\'],\n144.           artifact: \'some/path/foo.zip\',\n145.         },\n146.       };\n147. \n148.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n149.         YAML.dump(serverlessYml));\n150. \n151.       const serverless = new Serverless();\n152.       serverless.init();\n153.       serverless.config.update({ servicePath: tmpDirPath });\n154.       serviceInstance = new Service(serverless);\n155. \n156.       return serviceInstance.load().then(() => {\n157.         expect(serviceInstance.service).to.be.equal(\'new-service\');\n158.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n159.         expect(serviceInstance.defaults.variableSyntax).to.equal(\'\\\\${{([\\\\s\\\\S]+?)}}\');\n160.         expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n161.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n162.         expect(serviceInstance.resources.azure).to.deep.equal({});\n163.         expect(serviceInstance.resources.google).to.deep.equal({});\n164.         expect(serviceInstance.package.exclude.length).to.equal(1);\n165.         expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n166.         expect(serviceInstance.package.include.length).to.equal(1);\n167.         expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n168.         expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n169.       });\n170.     });\n171. \n172.     it(\'should merge resources given as an array\', () => {\n173.       const SUtils = new Utils();\n174.       const serverlessYml = {\n175.         service: \'new-service\',\n176.         provider: \'aws\',\n177.         resources: [\n178.           {\n179.             aws: {\n180.               resourcesProp: \'value\',\n181.             },\n182.           },\n183.           {\n184.             azure: {},\n185.           },\n186.         ],\n187.       };\n188. \n189.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n190.         YAML.dump(serverlessYml));\n191. \n192.       const serverless = new Serverless();\n193.       serverless.init();\n194.       serverless.config.update({ servicePath: tmpDirPath });\n195.       serviceInstance = new Service(serverless);\n196. \n197.       return serviceInstance.load().then(() => {\n198.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n199.         expect(serviceInstance.resources.azure).to.deep.equal({});\n200.       });\n201.     });\n202. \n203.     it(\'should make sure function name contains the default stage\', () => {\n204.       const SUtils = new Utils();\n205.       const serverlessYml = {\n206.         service: \'new-service\',\n207.         provider: \'aws\',\n208.         defaults: {\n209.           stage: \'dev\',\n210.           region: \'us-east-1\',\n211.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n212.         },\n213.         plugins: [\'testPlugin\'],\n214.         functions: {\n215.           functionA: {},\n216.         },\n217.         resources: {\n218.           aws: {\n219.             resourcesProp: \'value\',\n220.           },\n221.           azure: {},\n222.           google: {},\n223.         },\n224.         package: {\n225.           exclude: [\'exclude-me\'],\n226.           include: [\'include-me\'],\n227.           artifact: \'some/path/foo.zip\',\n228.         },\n229.       };\n230. \n231.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n232.         YAML.dump(serverlessYml));\n233. \n234.       const serverless = new Serverless();\n235.       serverless.init();\n236.       serverless.config.update({ servicePath: tmpDirPath });\n237.       serviceInstance = new Service(serverless);\n238. \n239.       return serviceInstance.load().then(() => {\n240.         expect(serviceInstance.functions.functionA.name).to.be.equal(\'new-service-dev-functionA\');\n241.       });\n242.     });\n243. \n244.     it(\'should support Serverless file with a non-aws provider\', () => {\n245.       const SUtils = new Utils();\n246.       const serverlessYaml = {\n247.         service: \'my-service\',\n248.         provider: \'openwhisk\',\n249.         functions: {\n250.           functionA: {\n251.             name: \'customFunctionName\',\n252.           },\n253.         },\n254.       };\n255. \n256.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n257.         YAML.dump(serverlessYaml));\n258. \n259.       const serverless = new Serverless({ servicePath: tmpDirPath });\n260.       serviceInstance = new Service(serverless);\n261. \n262.       return serviceInstance.load().then(() => {\n263.         const expectedFunc = {\n264.           functionA: {\n265.             name: \'customFunctionName\',\n266.             events: [],\n267.           },\n268.         };\n269.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n270.         expect(serviceInstance.provider.name).to.deep.equal(\'openwhisk\');\n271.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n272.       });\n273.     });\n274. \n275.     it(\'should support Serverless file with a .yaml extension\', () => {\n276.       const SUtils = new Utils();\n277.       const serverlessYaml = {\n278.         service: \'my-service\',\n279.         provider: \'aws\',\n280.         functions: {\n281.           functionA: {\n282.             name: \'customFunctionName\',\n283.           },\n284.         },\n285.       };\n286. \n287.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n288.         YAML.dump(serverlessYaml));\n289. \n290.       const serverless = new Serverless({ servicePath: tmpDirPath });\n291.       serviceInstance = new Service(serverless);\n292. \n293.       return serviceInstance.load().then(() => {\n294.         const expectedFunc = {\n295.           functionA: {\n296.             name: \'customFunctionName\',\n297.             events: [],\n298.           },\n299.         };\n300.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n301.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n302.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n303.       });\n304.     });\n305. \n306.     it(\'should support Serverless file with a .yml extension\', () => {\n307.       const SUtils = new Utils();\n308.       const serverlessYml = {\n309.         service: \'my-service\',\n310.         provider: \'aws\',\n311.         functions: {\n312.           functionA: {},\n313.         },\n314.       };\n315. \n316.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n317.         YAML.dump(serverlessYml));\n318. \n319.       const serverless = new Serverless({ servicePath: tmpDirPath });\n320.       serviceInstance = new Service(serverless);\n321. \n322.       return serviceInstance.load({ stage: \'dev\' }).then(() => {\n323.         const expectedFunc = {\n324.           functionA: {\n325.             name: \'my-service-dev-functionA\',\n326.             events: [],\n327.           },\n328.         };\n329.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n330.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n331.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n332.       });\n333.     });\n334. \n335.     it(\'should throw error if service property is missing\', () => {\n336.       const SUtils = new Utils();\n337.       const serverlessYml = {\n338.         provider: \'aws\',\n339.         functions: {},\n340.       };\n341.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n342.         YAML.dump(serverlessYml));\n343. \n344.       const serverless = new Serverless({ servicePath: tmpDirPath });\n345.       serviceInstance = new Service(serverless);\n346. \n347.       return serviceInstance.load().then(() => {\n348.         // if we reach this, then no error was thrown as expected\n349.         // so make assertion fail intentionally to let us know something is wrong\n350.         expect(1).to.equal(2);\n351.       }).catch(e => {\n352.         expect(e.name).to.be.equal(\'ServerlessError\');\n353.       });\n354.     });\n355. \n356.     it(\'should throw error if provider property is missing\', () => {\n357.       const SUtils = new Utils();\n358.       const serverlessYml = {\n359.         service: \'service-name\',\n360.         functions: {},\n361.       };\n362.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n363.         YAML.dump(serverlessYml));\n364. \n365.       const serverless = new Serverless({ servicePath: tmpDirPath });\n366.       serviceInstance = new Service(serverless);\n367. \n368.       return serviceInstance.load().then(() => {\n369.         // if we reach this, then no error was thrown as expected\n370.         // so make assertion fail intentionally to let us know something is wrong\n371.         expect(1).to.equal(2);\n372.       }).catch(e => {\n373.         expect(e.name).to.be.equal(\'ServerlessError\');\n374.       });\n375.     });\n376. \n377.     it(\'should throw error if frameworkVersion is not satisfied\', () => {\n378.       const SUtils = new Utils();\n379.       const serverlessYml = {\n380.         service: \'service-name\',\n381.         frameworkVersion: \'=1.0.0\',\n382.         provider: \'aws\',\n383.         functions: {},\n384.       };\n385.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n386.         YAML.dump(serverlessYml));\n387. \n388.       const serverless = new Serverless({ servicePath: tmpDirPath });\n389.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n390.       getVersion.returns(\'1.0.2\');\n391.       serviceInstance = new Service(serverless);\n392. \n393.       return serviceInstance.load().then(() => {\n394.         // if we reach this, then no error was thrown as expected\n395.         // so make assertion fail intentionally to let us know something is wrong\n396.         expect(1).to.equal(2);\n397.       }).catch(e => {\n398.         expect(e.name).to.be.equal(\'ServerlessError\');\n399.       });\n400.     });\n401. \n402.     it(\'should pass if frameworkVersion is satisfied\', () => {\n403.       const SUtils = new Utils();\n404.       const serverlessYml = {\n405.         service: \'service-name\',\n406.         frameworkVersion: \'>=1.0.0\',\n407.         provider: \'aws\',\n408.         functions: {},\n409.       };\n410.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n411.         YAML.dump(serverlessYml));\n412. \n413.       const serverless = new Serverless({ servicePath: tmpDirPath });\n414.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n415.       getVersion.returns(\'1.2.2\');\n416.       serviceInstance = new Service(serverless);\n417. \n418.       return serviceInstance.load().then(() => {\n419.         // if this callbar is reached, then no error was thrown as expected\n420.         expect(1).to.equal(1);\n421.       });\n422.     });\n423. \n424.     it(\'should not throw error if functions property is missing\', () => {\n425.       const SUtils = new Utils();\n426.       const serverlessYml = {\n427.         service: \'service-name\',\n428.         provider: \'aws\',\n429.       };\n430.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n431.         YAML.dump(serverlessYml));\n432. \n433.       const serverless = new Serverless({ servicePath: tmpDirPath });\n434.       serviceInstance = new Service(serverless);\n435. \n436.       return serviceInstance.load().then(() => {\n437.         expect(serverless.service.functions).to.deep.equal({});\n438.       });\n439.     });\n440. \n441.     it("should throw error if a function\'s event is not an array", () => {\n442.       const SUtils = new Utils();\n443.       const serverlessYml = {\n444.         service: \'service-name\',\n445.         provider: \'aws\',\n446.         functions: {\n447.           functionA: {\n448.             events: {},\n449.           },\n450.         },\n451.       };\n452.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n453.         YAML.dump(serverlessYml));\n454. \n455.       const serverless = new Serverless({ servicePath: tmpDirPath });\n456.       serviceInstance = new Service(serverless);\n457. \n458.       return serviceInstance.load().then(() => {\n459.         // if we reach this, then no error was thrown as expected\n460.         // so make assertion fail intentionally to let us know something is wrong\n461.         expect(1).to.equal(2);\n462.       }).catch(e => {\n463.         expect(e.name).to.be.equal(\'ServerlessError\');\n464.       });\n465.     });\n466. \n467.     it(\'should throw error if provider property is invalid\', () => {\n468.       const SUtils = new Utils();\n469.       const serverlessYml = {\n470.         service: \'service-name\',\n471.         provider: \'invalid\',\n472.         functions: {},\n473.       };\n474. \n475.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n476.         YAML.dump(serverlessYml));\n477. \n478.       const serverless = new Serverless({ servicePath: tmpDirPath });\n479.       serviceInstance = new Service(serverless);\n480. \n481.       return serviceInstance.load().then(() => {\n482.         // if we reach this, then no error was thrown as expected\n483.         // so make assertion fail intentionally to let us know something is wrong\n484.         expect(1).to.equal(2);\n485.       }).catch(e => {\n486.         expect(e.name).to.be.equal(\'ServerlessError\');\n487.       });\n488.     });\n489.   });\n490. \n491.   describe(\'#update()\', () => {\n492.     it(\'should update service instance data\', () => {\n493.       const serverless = new Serverless();\n494.       const serviceInstance = new Service(serverless);\n495.       const newData = { service: \'newName\' };\n496.       const updatedInstance = serviceInstance.update(newData);\n497.       expect(updatedInstance.service).to.be.equal(\'newName\');\n498.     });\n499.   });\n500. ', start_line_number=1, end_line_number=500), Context(relative_path='lib/classes/YamlParser.test.js', content="1. 'use strict';\n2. \n3. /**\n4.  * Test: YamlParser Function Class\n5.  */\n6. \n7. const expect = require('chai').expect;\n8. const YAML = require('js-yaml');\n9. const path = require('path');\n10. const Serverless = require('../../lib/Serverless');\n11. const testUtils = require('../../tests/utils');\n12. \n13. const serverless = new Serverless();\n14. \n15. describe('YamlParser', () => {\n16.   describe('#parse()', () => {\n17.     it('should parse a simple .yaml file', () => {\n18.       const tmpFilePath = testUtils.getTmpFilePath('simple.yaml');\n19. \n20.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));\n21. \n22.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n23.         expect(obj.foo).to.equal('bar');\n24.       });\n25.     });\n26. \n27.     it('should parse a simple .yml file', () => {\n28.       const tmpFilePath = testUtils.getTmpFilePath('simple.yml');\n29. \n30.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: 'bar' }));\n31. \n32.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n33.         expect(obj.foo).to.equal('bar');\n34.       });\n35.     });\n36. \n37.     it('should parse a .yml file with JSON-REF to YAML', () => {\n38.       const tmpDirPath = testUtils.getTmpDirPath();\n39. \n40.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.yml'), { foo: 'bar' });\n41. \n42.       const testYml = {\n43.         main: {\n44.           $ref: './ref.yml',\n45.         },\n46.       };\n47. \n48.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);\n49. \n50.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {\n51.         expect(obj.main.foo).to.equal('bar');\n52.       });\n53.     });\n54. \n55.     it('should parse a .yml file with JSON-REF to JSON', () => {\n56.       const tmpDirPath = testUtils.getTmpDirPath();\n57. \n58.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'ref.json'), { foo: 'bar' });\n59. \n60.       const testYml = {\n61.         main: {\n62.           $ref: './ref.json',\n63.         },\n64.       };\n65. \n66.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'test.yml'), testYml);\n67. \n68.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'test.yml')).then((obj) => {\n69.         expect(obj.main.foo).to.equal('bar');\n70.       });\n71.     });\n72. \n73.     it('should parse a .yml file with recursive JSON-REF', () => {\n74.       const tmpDirPath = testUtils.getTmpDirPath();\n75. \n76.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'three.yml'), { foo: 'bar' });\n77. \n78.       const twoYml = {\n79.         two: {\n80.           $ref: './three.yml',\n81.         },\n82.       };\n83. \n84.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'two.yml'), twoYml);\n85. \n86.       const oneYml = {\n87.         one: {\n88.           $ref: './two.yml',\n89.         },\n90.       };\n91. \n92.       serverless.utils.writeFileSync(path.join(tmpDirPath, 'one.yml'), oneYml);\n93. \n94.       return serverless.yamlParser.parse(path.join(tmpDirPath, 'one.yml')).then((obj) => {\n95.         expect(obj.one.two.foo).to.equal('bar');\n96.       });\n97.     });\n98.   });\n99. });", start_line_number=1, end_line_number=99), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n47. \n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n96. \n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n107.           }\n108.         });\n109.       }\n110.     });\n111.   }\n112. }\n113. module.exports = AwsCompileIoTEvents;', start_line_number=1, end_line_number=113), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.test.js', content='1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsProvider = require(\'../../../../provider/awsProvider\');\n5. const AwsCompileIoTEvents = require(\'./index\');\n6. const Serverless = require(\'../../../../../../Serverless\');\n7. \n8. describe(\'AwsCompileIoTEvents\', () => {\n9.   let serverless;\n10.   let awsCompileIoTEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n15.     serverless.setProvider(\'aws\', new AwsProvider(serverless));\n16.     awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);\n17.     awsCompileIoTEvents.serverless.service.service = \'new-service\';\n18.   });\n19. \n20.   describe(\'#constructor()\', () => {\n21.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n22.       expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));\n23.   });\n24. \n25.   describe(\'#awsCompileIoTEvents()\', () => {\n26.     it(\'should throw an error if iot event type is not an object\', () => {\n27.       awsCompileIoTEvents.serverless.service.functions = {\n28.         first: {\n29.           events: [\n30.             {\n31.               iot: \'iot\',\n32.             },\n33.           ],\n34.         },\n35.       };\n36. \n37.       expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);\n38.     });\n39. \n40.     it(\'should create corresponding resources when iot events are given\', () => {\n41.       awsCompileIoTEvents.serverless.service.functions = {\n42.         first: {\n43.           events: [\n44.             {\n45.               iot: {\n46.                 sql: "SELECT * FROM \'topic_1\'",\n47.               },\n48.             },\n49.             {\n50.               iot: {\n51.                 sql: "SELECT * FROM \'topic_2\'",\n52.               },\n53.             },\n54.           ],\n55.         },\n56.       };\n57. \n58.       awsCompileIoTEvents.compileIoTEvents();\n59. \n60.       expect(awsCompileIoTEvents.serverless.service\n61.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type\n62.       ).to.equal(\'AWS::IoT::TopicRule\');\n63.       expect(awsCompileIoTEvents.serverless.service\n64.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type\n65.       ).to.equal(\'AWS::IoT::TopicRule\');\n66.       expect(awsCompileIoTEvents.serverless.service\n67.         .provider.compiledCloudFormationTemplate.Resources\n68.         .FirstIotTopicRule1.Properties.TopicRulePayload.Sql\n69.       ).to.equal(\'SELECT * FROM \\\'topic_1\\\'\');\n70.       expect(awsCompileIoTEvents.serverless.service\n71.         .provider.compiledCloudFormationTemplate.Resources\n72.         .FirstIotTopicRule2.Properties.TopicRulePayload.Sql\n73.       ).to.equal(\'SELECT * FROM \\\'topic_2\\\'\');\n74.       expect(awsCompileIoTEvents.serverless.service\n75.         .provider.compiledCloudFormationTemplate.Resources\n76.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n77.       ).to.equal(\'false\');\n78.       expect(awsCompileIoTEvents.serverless.service\n79.         .provider.compiledCloudFormationTemplate.Resources\n80.         .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled\n81.       ).to.equal(\'false\');\n82.       expect(awsCompileIoTEvents.serverless.service\n83.         .provider.compiledCloudFormationTemplate.Resources\n84.         .FirstLambdaPermissionIotTopicRule1.Type\n85.       ).to.equal(\'AWS::Lambda::Permission\');\n86.       expect(awsCompileIoTEvents.serverless.service\n87.         .provider.compiledCloudFormationTemplate.Resources\n88.         .FirstLambdaPermissionIotTopicRule2.Type\n89.       ).to.equal(\'AWS::Lambda::Permission\');\n90.     });\n91. \n92.     it(\'should respect "name" variable\', () => {\n93.       awsCompileIoTEvents.serverless.service.functions = {\n94.         first: {\n95.           events: [\n96.             {\n97.               iot: {\n98.                 name: \'iotEvantName\',\n99.                 sql: "SELECT * FROM \'topic_1\'",\n100.               },\n101.             },\n102.           ],\n103.         },\n104.       };\n105. \n106.       awsCompileIoTEvents.compileIoTEvents();\n107. \n108.       expect(awsCompileIoTEvents.serverless.service\n109.         .provider.compiledCloudFormationTemplate.Resources\n110.         .FirstIotTopicRule1.Properties.RuleName\n111.       ).to.equal(\'iotEvantName\');\n112.     });\n113. \n114.     it(\'should respect "enabled" variable\', () => {\n115.       awsCompileIoTEvents.serverless.service.functions = {\n116.         first: {\n117.           events: [\n118.             {\n119.               iot: {\n120.                 enabled: false,\n121.                 sql: "SELECT * FROM \'topic_1\'",\n122.               },\n123.             },\n124.           ],\n125.         },\n126.         second: {\n127.           events: [\n128.             {\n129.               iot: {\n130.                 enabled: true,\n131.                 sql: "SELECT * FROM \'topic_1\'",\n132.               },\n133.             },\n134.           ],\n135.         },\n136.       };\n137. \n138.       awsCompileIoTEvents.compileIoTEvents();\n139. \n140.       expect(awsCompileIoTEvents.serverless.service\n141.         .provider.compiledCloudFormationTemplate.Resources\n142.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n143.       ).to.equal(\'true\');\n144.       expect(awsCompileIoTEvents.serverless.service\n145.         .provider.compiledCloudFormationTemplate.Resources\n146.         .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n147.       ).to.equal(\'false\');\n148.     });\n149. \n150.     it(\'should respect "sqlVersion" variable\', () => {\n151.       awsCompileIoTEvents.serverless.service.functions = {\n152.         first: {\n153.           events: [\n154.             {\n155.               iot: {\n156.                 sqlVersion: \'2016-03-23\',\n157.                 sql: "SELECT * FROM \'topic_1\'",\n158.               },\n159.             },\n160.           ],\n161.         },\n162.       };\n163. \n164.       awsCompileIoTEvents.compileIoTEvents();\n165. \n166.       expect(awsCompileIoTEvents.serverless.service\n167.         .provider.compiledCloudFormationTemplate.Resources\n168.         .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion\n169.       ).to.equal(\'2016-03-23\');\n170.     });\n171. \n172.     it(\'should respect "description" variable\', () => {\n173.       awsCompileIoTEvents.serverless.service.functions = {\n174.         first: {\n175.           events: [\n176.             {\n177.               iot: {\n178.                 description: \'iot event description\',\n179.                 sql: "SELECT * FROM \'topic_1\'",\n180.               },\n181.             },\n182.           ],\n183.         },\n184.       };\n185. \n186.       awsCompileIoTEvents.compileIoTEvents();\n187. \n188.       expect(awsCompileIoTEvents.serverless.service\n189.         .provider.compiledCloudFormationTemplate.Resources\n190.         .FirstIotTopicRule1.Properties.TopicRulePayload.Description\n191.       ).to.equal(\'iot event description\');\n192.     });\n193. \n194.     it(\'should respect enabled variable if the "enabled" property is not given\', () => {\n195.       awsCompileIoTEvents.serverless.service.functions = {\n196.         first: {\n197.           events: [\n198.             {\n199.               iot: {\n200.                 sql: "SELECT * FROM \'topic_1\'",\n201.               },\n202.             },\n203.           ],\n204.         },\n205.       };\n206. \n207.       awsCompileIoTEvents.compileIoTEvents();\n208. \n209.       expect(awsCompileIoTEvents.serverless.service\n210.         .provider.compiledCloudFormationTemplate.Resources\n211.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n212.       ).to.equal(\'false\');\n213.     });\n214. \n215.     it(\'should not create corresponding resources when iot events are not given\', () => {\n216.       awsCompileIoTEvents.serverless.service.functions = {\n217.         first: {\n218.           events: [],\n219.         },\n220.       };\n221. \n222.       awsCompileIoTEvents.compileIoTEvents();\n223. \n224.       expect(awsCompileIoTEvents.serverless.service\n225.         .provider.compiledCloudFormationTemplate.Resources\n226.       ).to.deep.equal({});\n227.     });\n228.   });\n229. });', start_line_number=1, end_line_number=229), Context(relative_path='lib/plugins/aws/lib/naming.test.js', content='1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. \n5. const SDK = require(\'../provider/awsProvider\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. describe(\'#naming()\', () => {\n9.   let options;\n10.   let serverless;\n11.   let sdk;\n12. \n13.   beforeEach(() => {\n14.     options = {\n15.       stage: \'dev\',\n16.       region: \'us-east-1\',\n17.     };\n18.     serverless = new Serverless(options);\n19.     sdk = new SDK(serverless, options);\n20.   });\n21. \n22.   describe(\'#normalizeName()\', () => {\n23.     it(\'should capitalize the first letter\', () => {\n24.       expect(sdk.naming.normalizeName(\'name\')).to.equal(\'Name\');\n25.     });\n26. \n27.     it(\'should have no effect on caps\', () => {\n28.       expect(sdk.naming.normalizeName(\'Name\')).to.equal(\'Name\');\n29.     });\n30. \n31.     it(\'should have no effect on the rest of the name\', () => {\n32.       expect(sdk.naming.normalizeName(\'nAME\')).to.equal(\'NAME\');\n33.     });\n34.   });\n35. \n36.   describe(\'#normalizeNameToAlphaNumericOnly()\', () => {\n37.     it(\'should strip non-alpha-numeric characters\', () => {\n38.       expect(sdk.naming\n39.         .normalizeNameToAlphaNumericOnly(\'`!@#$%^&*()-={}|[]\\\\:";\\\'<>?,./\')).to.equal(\'\');\n40.     });\n41. \n42.     it(\'should apply normalizeName to the remaining characters\', () => {\n43.       expect(sdk.naming.normalizeNameToAlphaNumericOnly(\'a-b-c\')).to.equal(\'Abc\');\n44.     });\n45.   });\n46. \n47.   describe(\'#normalizePathPart()\', () => {\n48.     it(\'converts `-` to `Dash`\', () => {\n49.       expect(sdk.naming.normalizePathPart(\n50.         \'a-path\'\n51.       )).to.equal(\'ADashpath\');\n52.     });\n53. \n54.     it(\'converts variable declarations (`${var}`) to `VariableVar`\', () => {\n55.       expect(sdk.naming.normalizePathPart(\n56.         \'${variable}\'\n57.       )).to.equal(\'VariableVar\');\n58.     });\n59. \n60.     it(\'converts variable declarations prefixes to `VariableVarpath`\', () => {\n61.       expect(sdk.naming.normalizePathPart(\n62.         \'${variable}Path\'\n63.       )).to.equal(\'VariableVarpath\');\n64.     });\n65. \n66.     it(\'converts variable declarations suffixes to `PathvariableVar`\', () => {\n67.       expect(sdk.naming.normalizePathPart(\n68.         \'path${variable}\'\n69.       )).to.equal(\'PathvariableVar\');\n70.     });\n71. \n72.     it(\'converts variable declarations in center to `PathvariableVardir`\', () => {\n73.       expect(sdk.naming.normalizePathPart(\n74.         \'path${variable}Dir\'\n75.       )).to.equal(\'PathvariableVardir\');\n76.     });\n77.   });\n78. \n79.   describe(\'#getServiceEndpointRegex()\', () => {\n80.     it(\'should match the prefix\', () => {\n81.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpoint\'))\n82.         .to.equal(true);\n83.     });\n84. \n85.     it(\'should not match a name without the prefix\', () => {\n86.       expect(sdk.naming.getServiceEndpointRegex()\n87.         .test(\'NotThePrefixServiceEndpoint\')).to.equal(false);\n88.     });\n89. \n90.     it(\'should match a name with the prefix\', () => {\n91.       expect(sdk.naming.getServiceEndpointRegex()\n92.         .test(\'ServiceEndpointForAService\')).to.equal(true);\n93.     });\n94.   });\n95. \n96.   describe(\'#getStackName()\', () => {\n97.     it(\'should use the service name and stage from the service and config\', () => {\n98.       serverless.service.service = \'myService\';\n99.       expect(sdk.naming.getStackName()).to.equal(`${serverless.service.service}-${options.stage}`);\n100.     });\n101.   });\n102. \n103.   describe(\'#getRolePath()\', () => {\n104.     it(\'should return `/`\', () => {\n105.       expect(sdk.naming.getRolePath()).to.equal(\'/\');\n106.     });\n107.   });\n108. \n109.   describe(\'#getRoleName()\', () => {\n110.     it(\'uses the service name, stage, and region to generate a role name\', () => {\n111.       serverless.service.service = \'myService\';\n112.       expect(sdk.naming.getRoleName()).to.eql({\n113.         \'Fn::Join\': [\n114.           \'-\',\n115.           [\n116.             serverless.service.service,\n117.             options.stage,\n118.             options.region,\n119.             \'lambdaRole\',\n120.           ],\n121.         ],\n122.       });\n123.     });\n124.   });\n125. \n126.   describe(\'#getRoleLogicalId()\', () => {\n127.     it(\'should return the expected role name (IamRoleLambdaExecution)\', () => {\n128.       expect(sdk.naming.getRoleLogicalId()).to.equal(\'IamRoleLambdaExecution\');\n129.     });\n130.   });\n131. \n132.   describe(\'#getPolicyName()\', () => {\n133.     it(\'should use the stage and service name\', () => {\n134.       serverless.service.service = \'myService\';\n135.       expect(sdk.naming.getPolicyName()).to.eql({\n136.         \'Fn::Join\': [\n137.           \'-\',\n138.           [\n139.             options.stage,\n140.             serverless.service.service,\n141.             \'lambda\',\n142.           ],\n143.         ],\n144.       });\n145.     });\n146.   });\n147. \n148.   describe(\'#getPolicyLogicalId()\', () => {\n149.     it(\'should return the expected policy name (IamPolicyLambdaExecution)\', () => {\n150.       expect(sdk.naming.getPolicyLogicalId()).to.equal(\'IamPolicyLambdaExecution\');\n151.     });\n152.   });\n153. \n154.   describe(\'#getLogicalLogGroupName()\', () => {\n155.     it(\'should prefix the normalized function name to "LogGroup"\', () => {\n156.       expect(sdk.naming.getLogGroupLogicalId(\'functionName\')).to.equal(\'FunctionNameLogGroup\');\n157.     });\n158.   });\n159. \n160.   describe(\'#getLogGroupName()\', () => {\n161.     it(\'should add the function name to the log group name\', () => {\n162.       expect(sdk.naming.getLogGroupName(\'functionName\')).to.equal(\'/aws/lambda/functionName\');\n163.     });\n164.   });\n165. \n166.   describe(\'#getNormalizedFunctionName()\', () => {\n167.     it(\'should normalize the given functionName\', () => {\n168.       expect(sdk.naming.getNormalizedFunctionName(\'functionName\'))\n169.         .to.equal(\'FunctionName\');\n170.     });\n171. \n172.     it(\'should normalize the given functionName with an underscore\', () => {\n173.       expect(sdk.naming.getNormalizedFunctionName(\'hello_world\'))\n174.         .to.equal(\'HelloUnderscoreworld\');\n175.     });\n176. \n177.     it(\'should normalize the given functionName with a dash\', () => {\n178.       expect(sdk.naming.getNormalizedFunctionName(\'hello-world\'))\n179.         .to.equal(\'HelloDashworld\');\n180.     });\n181.   });\n182. \n183.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n184.     it(\'should extract everything after the last colon and dash\', () => {\n185.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n186.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n187.     });\n188.   });\n189. \n190.   describe(\'#extractLambdaNameFromArn()\', () => {\n191.     it(\'should extract everything after the last colon\', () => {\n192.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n193.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal(\'my-dev-lambda\');\n194.     });\n195.   });\n196. \n197.   describe(\'#getLambdaLogicalId()\', () => {\n198.     it(\'should normalize the function name and add the logical suffix\', () => {\n199.       expect(sdk.naming.getLambdaLogicalId(\'functionName\'))\n200.         .to.equal(\'FunctionNameLambdaFunction\');\n201.     });\n202.   });\n203. \n204.   describe(\'#getLambdaLogicalIdRegex()\', () => {\n205.     it(\'should match the suffix\', () => {\n206.       expect(sdk.naming.getLambdaLogicalIdRegex()\n207.         .test(\'LambdaFunction\')).to.equal(true);\n208.     });\n209. \n210.     it(\'should not match a name without the suffix\', () => {\n211.       expect(sdk.naming.getLambdaLogicalIdRegex()\n212.         .test(\'LambdaFunctionNotTheSuffix\')).to.equal(false);\n213.     });\n214. \n215.     it(\'should match a name with the suffix\', () => {\n216.       expect(sdk.naming.getLambdaLogicalIdRegex()\n217.         .test(\'AFunctionNameLambdaFunction\')).to.equal(true);\n218.     });\n219.   });\n220. \n221.   describe(\'#getLambdaOutputLogicalId()\', () => {\n222.     it(\'should normalize the function name and add the logical arn suffix\', () => {\n223.       expect(\n224.         sdk.naming.getLambdaOutputLogicalId(\'functionName\')\n225.       ).to.equal(\'FunctionNameLambdaFunctionArn\');\n226.     });\n227.   });\n228. \n229.   describe(\'#getLambdaOutputLogicalIdRegex()\', () => {\n230.     it(\'should match the suffix\', () => {\n231.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n232.         .test(\'aLambdaFunctionArn\')).to.equal(true);\n233.     });\n234. \n235.     it(\'should not match a name without the suffix\', () => {\n236.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n237.         .test(\'LambdaFunctionArnNotTheSuffix\'))\n238.         .to.equal(false);\n239.     });\n240. \n241.     it(\'should match a name with the suffix\', () => {\n242.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n243.         .test(\'AFunctionArnNameLambdaFunctionArn\'))\n244.         .to.equal(true);\n245.     });\n246.   });\n247. \n248.   describe(\'#getApiGatewayName()\', () => {\n249.     it(\'should return the composition of stage and service name\', () => {\n250.       serverless.service.service = \'myService\';\n251.       expect(sdk.naming.getApiGatewayName())\n252.         .to.equal(`${options.stage}-${serverless.service.service}`);\n253.     });\n254.   });\n255. \n256.   describe(\'#generateApiGatewayDeploymentLogicalId()\', () => {\n257.     it(\'should return ApiGatewayDeployment with a date based suffix\', () => {\n258.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId()\n259.         .match(/ApiGatewayDeployment(.*)/).length)\n260.         .to.be.greaterThan(1);\n261.     });\n262.   });\n263. \n264.   describe(\'#getRestApiLogicalId()\', () => {\n265.     it(\'should return ApiGatewayRestApi\', () => {\n266.       expect(sdk.naming.getRestApiLogicalId()).to.equal(\'ApiGatewayRestApi\');\n267.     });\n268.   });\n269. \n270.   describe(\'#getNormalizedAuthorizerName()\', () => {\n271.     it(\'normalize the authorizer name\', () => {\n272.       expect(sdk.naming.getNormalizedAuthorizerName(\'authorizerName\'))\n273.         .to.equal(\'AuthorizerName\');\n274.     });\n275.   });\n276. \n277.   describe(\'#getAuthorizerLogicalId()\', () => {\n278.     it(\'should normalize the authorizer name and add the standard suffix\', () => {\n279.       expect(sdk.naming.getAuthorizerLogicalId(\'authorizerName\'))\n280.         .to.equal(\'AuthorizerNameApiGatewayAuthorizer\');\n281.     });\n282.   });\n283. \n284.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n285.     it(\'should extract the authorizer name from an ARN\', () => {\n286.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n287.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n288.     });\n289.   });\n290. \n291.   describe(\'#normalizePath()\', () => {\n292.     it(\'should normalize each part of the resource path and remove non-alpha-numeric characters\',\n293.       () => {\n294.         expect(sdk.naming.normalizePath(\n295.           \'my/path/to/a-${var}-resource\'\n296.         )).to.equal(\'MyPathToADashvarVarDashresource\');\n297.       });\n298.   });\n299. \n300.   describe(\'#getResourceLogicalId()\', () => {\n301.     it(\'should normalize the resource and add the standard suffix\', () => {\n302.       expect(sdk.naming.getResourceLogicalId(\n303.         \'my/path/to/a-${var}-resource\'\n304.       )).to.equal(\'ApiGatewayResourceMyPathToADashvarVarDashresource\');\n305.     });\n306.   });\n307. \n308.   describe(\'#extractResourceId()\', () => {\n309.     it(\'should extract the normalized resource name\', () => {\n310.       expect(sdk.naming.extractResourceId(\n311.         \'ApiGatewayResourceMyPathToADashvarVarDashResource\'\n312.       )).to.equal(\'MyPathToADashvarVarDashResource\');\n313.     });\n314.   });\n315. \n316.   describe(\'#normalizeMethodName()\', () => {\n317.     it(\'should capitalize the first letter and lowercase any other characters\', () => {\n318.       expect(sdk.naming.normalizeMethodName(\'gET\')).to.equal(\'Get\');\n319.     });\n320.   });\n321. \n322.   describe(\'#getMethodLogicalId()\', () => {\n323.     it(\'\', () => {\n324.       expect(sdk.naming.getMethodLogicalId(\n325.         \'ResourceId\', \'get\'\n326.       )).to.equal(\'ApiGatewayMethodResourceIdGet\');\n327.     });\n328.   });\n329. \n330.   describe(\'#getApiKeyLogicalId(keyIndex)\', () => {\n331.     it(\'should produce the given index with ApiGatewayApiKey as a prefix\', () => {\n332.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal(\'ApiGatewayApiKey1\');\n333.     });\n334.   });\n335. \n336.   describe(\'#getApiKeyLogicalIdRegex()\', () => {\n337.     it(\'should match the prefix\', () => {\n338.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n339.         .test(\'ApiGatewayApiKey\')).to.equal(true);\n340.     });\n341. \n342.     it(\'should not match a name without the prefix\', () => {\n343.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n344.         .test(\'NotThePrefixApiGatewayApiKey\')).to.equal(false);\n345.     });\n346. \n347.     it(\'should match a name with the prefix\', () => {\n348.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n349.         .test(\'ApiGatewayApiKeySuffix\')).to.equal(true);\n350.     });\n351.   });\n352. \n353.   describe(\'#getDeploymentBucketLogicalId()\', () => {\n354.     it(\'should return "ServerlessDeploymentBucket"\', () => {\n355.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal(\'ServerlessDeploymentBucket\');\n356.     });\n357.   });\n358. \n359.   describe(\'#getDeploymentBucketOutputLogicalId()\', () => {\n360.     it(\'should return "ServerlessDeploymentBucketName"\', () => {\n361.       expect(sdk.naming.getDeploymentBucketOutputLogicalId())\n362.         .to.equal(\'ServerlessDeploymentBucketName\');\n363.     });\n364.   });\n365. \n366.   describe(\'#normalizeBucketName()\', () => {\n367.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n368.       expect(sdk.naming.normalizeBucketName(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'BucketName\');\n369.     });\n370.   });\n371. \n372.   describe(\'#getBucketLogicalId()\', () => {\n373.     it(\'should normalize the bucket name and add the standard prefix\', () => {\n374.       expect(sdk.naming.getBucketLogicalId(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'S3BucketBucketName\');\n375.     });\n376.   });\n377. \n378.   describe(\'#normalizeTopicName()\', () => {\n379.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n380.       expect(sdk.naming.normalizeTopicName(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'TopicName\');\n381.     });\n382.   });\n383. \n384.   describe(\'#getTopicLogicalId()\', () => {\n385.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n386.       expect(sdk.naming.getTopicLogicalId(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'SNSTopicTopicName\');\n387.     });\n388.   });\n389. \n390.   describe(\'#getScheduleId()\', () => {\n391.     it(\'should add the standard suffix\', () => {\n392.       expect(sdk.naming.getScheduleId(\'functionName\')).to.equal(\'functionNameSchedule\');\n393.     });\n394.   });\n395. \n396.   describe(\'#getScheduleLogicalId()\', () => {\n397.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n398.       expect(sdk.naming.getScheduleLogicalId(\'functionName\', 0))\n399.         .to.equal(\'FunctionNameEventsRuleSchedule0\');\n400.     });\n401.   });\n402. \n403.   describe(\'#getLambdaS3PermissionLogicalId()\', () => {\n404.     it(\'should normalize the function name and add the standard suffix\', () => {\n405.       expect(sdk.naming.getLambdaS3PermissionLogicalId(\'functionName\', \'bucket\'))\n406.         .to.equal(\'FunctionNameLambdaPermissionBucketS3\');\n407.     });\n408.   });\n409. \n410.   describe(\'#getLambdaSnsPermissionLogicalId()\', () => {\n411.     it(\'should normalize the function and topic names and add them as prefix and suffix to the \' +\n412.       \'standard permission center\', () => {\n413.       expect(sdk.naming.getLambdaSnsPermissionLogicalId(\'functionName\', \'topic\'))\n414.         .to.equal(\'FunctionNameLambdaPermissionTopicSNS\');\n415.     });\n416.   });\n417. \n418.   describe(\'#getLambdaSchedulePermissionLogicalId()\', () => {\n419.     it(\'should normalize the function name and add the standard suffix including event index\',\n420.       () => {\n421.         expect(sdk.naming.getLambdaSchedulePermissionLogicalId(\'functionName\', 0))\n422.           .to.equal(\'FunctionNameLambdaPermissionEventsRuleSchedule0\');\n423.       });\n424.   });\n425. \n426.   describe(\'#getLambdaApiGatewayPermissionLogicalId()\', () => {\n427.     it(\'should normalize the function name and append the standard suffix\', () => {\n428.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId(\'functionName\'))\n429.         .to.equal(\'FunctionNameLambdaPermissionApiGateway\');\n430.     });\n431.   });\n432. \n433.   describe(\'#getIotLogicalId()\', () => {\n434.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n435.       expect(sdk.naming.getIotLogicalId(\'functionName\', 0))\n436.         .to.equal(\'FunctionNameIotTopicRule0\');\n437.     });\n438.   });\n439. \n440.   describe(\'#getLambdaIotPermissionLogicalId()\', () => {\n441.     it(\'should normalize the function name and add the standard suffix including event index\',\n442.       () => {\n443.         expect(sdk.naming.getLambdaIotPermissionLogicalId(\'functionName\', 0))\n444.           .to.equal(\'FunctionNameLambdaPermissionIotTopicRule0\');\n445.       });\n446.   });\n447. \n448.   describe(\'#getLambdaAlexaSkillPermissionLogicalId()\', () => {\n449.     it(\'should normalize the function name and append the standard suffix\',\n450.       () => {\n451.         expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\'))\n452.           .to.equal(\'FunctionNameLambdaPermissionAlexaSkill\');\n453.       });\n454.   });\n455. });', start_line_number=1, end_line_number=455)]
2025-11-14 00:31:48,817 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_write_message_node - DEBUG - Sending message to BugReproducingWriteNode:
content='Issue title:\nMulti-line values in IoT event\n\nIssue description: \n<!--\n1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com\n2. Please check if an issue already exists so there are no duplicates\n3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md\n4. Fill out the whole template so we have a good overview on the issue\n5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue\n6. Please follow the template, otherwise we\'ll have to ask you to update it\n-->\n\n# This is a Bug Report\n\nUsing multi-line values (with yaml >) in an IoT definition results in an \'unexpected token\' error.\n\nFor bug reports:\n* What went wrong?  The following yaml:\n```\nevents:\n      - iot:\n          description: >\n            My multi-\n            line value.\n          name: enrollPlayer\n          sql: >\n            SELECT * FROM \'path/#\'\n            WHERE prop = \'value\'\n```\ncomplain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:\n```\n           "Description": "My multi- line value.\n            ",\n            "RuleDisabled": "false",\n            "Sql": "SELECT * FROM \'path/#\' WHERE prop = \'value\'\n            ",\n```\n* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.\n* What was the config you used?\n* What stacktrace or error message from your provider did you see?\n\nSimilar or dependent issues:\n*\n\n* ***Serverless Framework Version you\'re using***: 1.5.0\n* ***Operating System***: OS X 10.12\n* ***Stack Trace***:\nSyntaxError: Unexpected token \n\n    at Object.parse (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36\n    at Array.forEach (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28\n    at Array.forEach (native)\n    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)\n    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50\n    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)\n    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)\n    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)\n    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)\n    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)\n    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)\n    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)\n* ***Provider Error messages***:\n  Syntax Error -------------------------------------------\n \n     Unexpected token \n\n\nIssue comments:\n\n\nBug reproducing context:\nFile: lib/classes/Service.test.js\nLine number range: 1 - 500\nContent:\n1. \'use strict\';\n2. \n3. const path = require(\'path\');\n4. const YAML = require(\'js-yaml\');\n5. const expect = require(\'chai\').expect;\n6. const sinon = require(\'sinon\');\n7. const Service = require(\'../../lib/classes/Service\');\n8. const Utils = require(\'../../lib/classes/Utils\');\n9. const Serverless = require(\'../../lib/Serverless\');\n10. const testUtils = require(\'../../tests/utils\');\n11. \n12. describe(\'Service\', () => {\n13.   describe(\'#constructor()\', () => {\n14.     const serverless = new Serverless();\n15. \n16.     it(\'should attach serverless instance\', () => {\n17.       const serviceInstance = new Service(serverless);\n18.       expect(typeof serviceInstance.serverless.version).to.be.equal(\'string\');\n19.     });\n20. \n21.     it(\'should construct with defaults\', () => {\n22.       const serviceInstance = new Service(serverless);\n23. \n24.       expect(serviceInstance.service).to.be.equal(null);\n25.       expect(serviceInstance.provider).to.deep.equal({});\n26.       expect(serviceInstance.defaults).to.deep.equal({\n27.         stage: \'dev\',\n28.         region: \'us-east-1\',\n29.         variableSyntax: \'\\\\${([ :a-zA-Z0-9._,\\\\-\\\\/\\\\(\\\\)]+?)}\',\n30.       });\n31.       expect(serviceInstance.custom).to.deep.equal({});\n32.       expect(serviceInstance.plugins).to.deep.equal([]);\n33.       expect(serviceInstance.functions).to.deep.equal({});\n34.       expect(serviceInstance.resources).to.deep.equal({});\n35.       expect(serviceInstance.package).to.deep.equal({});\n36.     });\n37. \n38.     it(\'should construct with data\', () => {\n39.       const data = {\n40.         service: \'testService\',\n41.         provider: \'testProvider\',\n42.         custom: {\n43.           customProp: \'value\',\n44.         },\n45.         plugins: [\'testPlugin\'],\n46.         functions: {\n47.           functionA: {},\n48.         },\n49.         resources: {\n50.           aws: {\n51.             resourcesProp: \'value\',\n52.           },\n53.           azure: {},\n54.           google: {},\n55.         },\n56.         package: {\n57.           exclude: [\'exclude-me\'],\n58.           include: [\'include-me\'],\n59.           artifact: \'some/path/foo.zip\',\n60.         },\n61.       };\n62. \n63.       const serviceInstance = new Service(serverless, data);\n64. \n65.       expect(serviceInstance.service).to.be.equal(\'testService\');\n66.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n67.       expect(serviceInstance.custom).to.deep.equal({ customProp: \'value\' });\n68.       expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n69.       expect(serviceInstance.functions).to.deep.equal({ functionA: {} });\n70.       expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n71.       expect(serviceInstance.resources.azure).to.deep.equal({});\n72.       expect(serviceInstance.resources.google).to.deep.equal({});\n73.       expect(serviceInstance.package.exclude.length).to.equal(1);\n74.       expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n75.       expect(serviceInstance.package.include.length).to.equal(1);\n76.       expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n77.       expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n78.     });\n79. \n80.     it(\'should support string based provider config\', () => {\n81.       const data = {\n82.         provider: \'testProvider\',\n83.       };\n84. \n85.       const serviceInstance = new Service(serverless, data);\n86. \n87.       expect(serviceInstance.provider).to.be.equal(\'testProvider\');\n88.     });\n89. \n90.     it(\'should support object based provider config\', () => {\n91.       const data = {\n92.         provider: {\n93.           name: \'testProvider\',\n94.           runtime: \'nodejs4.3\',\n95.         },\n96.       };\n97. \n98.       const serviceInstance = new Service(serverless, data);\n99. \n100.       expect(serviceInstance.provider.name).to.be.equal(\'testProvider\');\n101.       expect(serviceInstance.provider.runtime).to.be.equal(\'nodejs4.3\');\n102.     });\n103.   });\n104. \n105.   describe(\'#load()\', () => {\n106.     let serviceInstance;\n107.     let tmpDirPath;\n108. \n109.     beforeEach(() => {\n110.       tmpDirPath = testUtils.getTmpDirPath();\n111.     });\n112. \n113.     it(\'should resolve if no servicePath is found\', () => {\n114.       const serverless = new Serverless();\n115.       const noService = new Service(serverless);\n116. \n117.       return noService.load();\n118.     });\n119. \n120.     it(\'should load from filesystem\', () => {\n121.       const SUtils = new Utils();\n122.       const serverlessYml = {\n123.         service: \'new-service\',\n124.         provider: \'aws\',\n125.         defaults: {\n126.           stage: \'dev\',\n127.           region: \'us-east-1\',\n128.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n129.         },\n130.         plugins: [\'testPlugin\'],\n131.         functions: {\n132.           functionA: {},\n133.         },\n134.         resources: {\n135.           aws: {\n136.             resourcesProp: \'value\',\n137.           },\n138.           azure: {},\n139.           google: {},\n140.         },\n141.         package: {\n142.           exclude: [\'exclude-me\'],\n143.           include: [\'include-me\'],\n144.           artifact: \'some/path/foo.zip\',\n145.         },\n146.       };\n147. \n148.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n149.         YAML.dump(serverlessYml));\n150. \n151.       const serverless = new Serverless();\n152.       serverless.init();\n153.       serverless.config.update({ servicePath: tmpDirPath });\n154.       serviceInstance = new Service(serverless);\n155. \n156.       return serviceInstance.load().then(() => {\n157.         expect(serviceInstance.service).to.be.equal(\'new-service\');\n158.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n159.         expect(serviceInstance.defaults.variableSyntax).to.equal(\'\\\\${{([\\\\s\\\\S]+?)}}\');\n160.         expect(serviceInstance.plugins).to.deep.equal([\'testPlugin\']);\n161.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n162.         expect(serviceInstance.resources.azure).to.deep.equal({});\n163.         expect(serviceInstance.resources.google).to.deep.equal({});\n164.         expect(serviceInstance.package.exclude.length).to.equal(1);\n165.         expect(serviceInstance.package.exclude[0]).to.equal(\'exclude-me\');\n166.         expect(serviceInstance.package.include.length).to.equal(1);\n167.         expect(serviceInstance.package.include[0]).to.equal(\'include-me\');\n168.         expect(serviceInstance.package.artifact).to.equal(\'some/path/foo.zip\');\n169.       });\n170.     });\n171. \n172.     it(\'should merge resources given as an array\', () => {\n173.       const SUtils = new Utils();\n174.       const serverlessYml = {\n175.         service: \'new-service\',\n176.         provider: \'aws\',\n177.         resources: [\n178.           {\n179.             aws: {\n180.               resourcesProp: \'value\',\n181.             },\n182.           },\n183.           {\n184.             azure: {},\n185.           },\n186.         ],\n187.       };\n188. \n189.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n190.         YAML.dump(serverlessYml));\n191. \n192.       const serverless = new Serverless();\n193.       serverless.init();\n194.       serverless.config.update({ servicePath: tmpDirPath });\n195.       serviceInstance = new Service(serverless);\n196. \n197.       return serviceInstance.load().then(() => {\n198.         expect(serviceInstance.resources.aws).to.deep.equal({ resourcesProp: \'value\' });\n199.         expect(serviceInstance.resources.azure).to.deep.equal({});\n200.       });\n201.     });\n202. \n203.     it(\'should make sure function name contains the default stage\', () => {\n204.       const SUtils = new Utils();\n205.       const serverlessYml = {\n206.         service: \'new-service\',\n207.         provider: \'aws\',\n208.         defaults: {\n209.           stage: \'dev\',\n210.           region: \'us-east-1\',\n211.           variableSyntax: \'\\\\${{([\\\\s\\\\S]+?)}}\',\n212.         },\n213.         plugins: [\'testPlugin\'],\n214.         functions: {\n215.           functionA: {},\n216.         },\n217.         resources: {\n218.           aws: {\n219.             resourcesProp: \'value\',\n220.           },\n221.           azure: {},\n222.           google: {},\n223.         },\n224.         package: {\n225.           exclude: [\'exclude-me\'],\n226.           include: [\'include-me\'],\n227.           artifact: \'some/path/foo.zip\',\n228.         },\n229.       };\n230. \n231.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n232.         YAML.dump(serverlessYml));\n233. \n234.       const serverless = new Serverless();\n235.       serverless.init();\n236.       serverless.config.update({ servicePath: tmpDirPath });\n237.       serviceInstance = new Service(serverless);\n238. \n239.       return serviceInstance.load().then(() => {\n240.         expect(serviceInstance.functions.functionA.name).to.be.equal(\'new-service-dev-functionA\');\n241.       });\n242.     });\n243. \n244.     it(\'should support Serverless file with a non-aws provider\', () => {\n245.       const SUtils = new Utils();\n246.       const serverlessYaml = {\n247.         service: \'my-service\',\n248.         provider: \'openwhisk\',\n249.         functions: {\n250.           functionA: {\n251.             name: \'customFunctionName\',\n252.           },\n253.         },\n254.       };\n255. \n256.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n257.         YAML.dump(serverlessYaml));\n258. \n259.       const serverless = new Serverless({ servicePath: tmpDirPath });\n260.       serviceInstance = new Service(serverless);\n261. \n262.       return serviceInstance.load().then(() => {\n263.         const expectedFunc = {\n264.           functionA: {\n265.             name: \'customFunctionName\',\n266.             events: [],\n267.           },\n268.         };\n269.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n270.         expect(serviceInstance.provider.name).to.deep.equal(\'openwhisk\');\n271.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n272.       });\n273.     });\n274. \n275.     it(\'should support Serverless file with a .yaml extension\', () => {\n276.       const SUtils = new Utils();\n277.       const serverlessYaml = {\n278.         service: \'my-service\',\n279.         provider: \'aws\',\n280.         functions: {\n281.           functionA: {\n282.             name: \'customFunctionName\',\n283.           },\n284.         },\n285.       };\n286. \n287.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yaml\'),\n288.         YAML.dump(serverlessYaml));\n289. \n290.       const serverless = new Serverless({ servicePath: tmpDirPath });\n291.       serviceInstance = new Service(serverless);\n292. \n293.       return serviceInstance.load().then(() => {\n294.         const expectedFunc = {\n295.           functionA: {\n296.             name: \'customFunctionName\',\n297.             events: [],\n298.           },\n299.         };\n300.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n301.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n302.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n303.       });\n304.     });\n305. \n306.     it(\'should support Serverless file with a .yml extension\', () => {\n307.       const SUtils = new Utils();\n308.       const serverlessYml = {\n309.         service: \'my-service\',\n310.         provider: \'aws\',\n311.         functions: {\n312.           functionA: {},\n313.         },\n314.       };\n315. \n316.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n317.         YAML.dump(serverlessYml));\n318. \n319.       const serverless = new Serverless({ servicePath: tmpDirPath });\n320.       serviceInstance = new Service(serverless);\n321. \n322.       return serviceInstance.load({ stage: \'dev\' }).then(() => {\n323.         const expectedFunc = {\n324.           functionA: {\n325.             name: \'my-service-dev-functionA\',\n326.             events: [],\n327.           },\n328.         };\n329.         expect(serviceInstance.service).to.be.equal(\'my-service\');\n330.         expect(serviceInstance.provider.name).to.deep.equal(\'aws\');\n331.         expect(serviceInstance.functions).to.deep.equal(expectedFunc);\n332.       });\n333.     });\n334. \n335.     it(\'should throw error if service property is missing\', () => {\n336.       const SUtils = new Utils();\n337.       const serverlessYml = {\n338.         provider: \'aws\',\n339.         functions: {},\n340.       };\n341.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n342.         YAML.dump(serverlessYml));\n343. \n344.       const serverless = new Serverless({ servicePath: tmpDirPath });\n345.       serviceInstance = new Service(serverless);\n346. \n347.       return serviceInstance.load().then(() => {\n348.         // if we reach this, then no error was thrown as expected\n349.         // so make assertion fail intentionally to let us know something is wrong\n350.         expect(1).to.equal(2);\n351.       }).catch(e => {\n352.         expect(e.name).to.be.equal(\'ServerlessError\');\n353.       });\n354.     });\n355. \n356.     it(\'should throw error if provider property is missing\', () => {\n357.       const SUtils = new Utils();\n358.       const serverlessYml = {\n359.         service: \'service-name\',\n360.         functions: {},\n361.       };\n362.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n363.         YAML.dump(serverlessYml));\n364. \n365.       const serverless = new Serverless({ servicePath: tmpDirPath });\n366.       serviceInstance = new Service(serverless);\n367. \n368.       return serviceInstance.load().then(() => {\n369.         // if we reach this, then no error was thrown as expected\n370.         // so make assertion fail intentionally to let us know something is wrong\n371.         expect(1).to.equal(2);\n372.       }).catch(e => {\n373.         expect(e.name).to.be.equal(\'ServerlessError\');\n374.       });\n375.     });\n376. \n377.     it(\'should throw error if frameworkVersion is not satisfied\', () => {\n378.       const SUtils = new Utils();\n379.       const serverlessYml = {\n380.         service: \'service-name\',\n381.         frameworkVersion: \'=1.0.0\',\n382.         provider: \'aws\',\n383.         functions: {},\n384.       };\n385.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n386.         YAML.dump(serverlessYml));\n387. \n388.       const serverless = new Serverless({ servicePath: tmpDirPath });\n389.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n390.       getVersion.returns(\'1.0.2\');\n391.       serviceInstance = new Service(serverless);\n392. \n393.       return serviceInstance.load().then(() => {\n394.         // if we reach this, then no error was thrown as expected\n395.         // so make assertion fail intentionally to let us know something is wrong\n396.         expect(1).to.equal(2);\n397.       }).catch(e => {\n398.         expect(e.name).to.be.equal(\'ServerlessError\');\n399.       });\n400.     });\n401. \n402.     it(\'should pass if frameworkVersion is satisfied\', () => {\n403.       const SUtils = new Utils();\n404.       const serverlessYml = {\n405.         service: \'service-name\',\n406.         frameworkVersion: \'>=1.0.0\',\n407.         provider: \'aws\',\n408.         functions: {},\n409.       };\n410.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n411.         YAML.dump(serverlessYml));\n412. \n413.       const serverless = new Serverless({ servicePath: tmpDirPath });\n414.       const getVersion = sinon.stub(serverless.utils, \'getVersion\');\n415.       getVersion.returns(\'1.2.2\');\n416.       serviceInstance = new Service(serverless);\n417. \n418.       return serviceInstance.load().then(() => {\n419.         // if this callbar is reached, then no error was thrown as expected\n420.         expect(1).to.equal(1);\n421.       });\n422.     });\n423. \n424.     it(\'should not throw error if functions property is missing\', () => {\n425.       const SUtils = new Utils();\n426.       const serverlessYml = {\n427.         service: \'service-name\',\n428.         provider: \'aws\',\n429.       };\n430.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n431.         YAML.dump(serverlessYml));\n432. \n433.       const serverless = new Serverless({ servicePath: tmpDirPath });\n434.       serviceInstance = new Service(serverless);\n435. \n436.       return serviceInstance.load().then(() => {\n437.         expect(serverless.service.functions).to.deep.equal({});\n438.       });\n439.     });\n440. \n441.     it("should throw error if a function\'s event is not an array", () => {\n442.       const SUtils = new Utils();\n443.       const serverlessYml = {\n444.         service: \'service-name\',\n445.         provider: \'aws\',\n446.         functions: {\n447.           functionA: {\n448.             events: {},\n449.           },\n450.         },\n451.       };\n452.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n453.         YAML.dump(serverlessYml));\n454. \n455.       const serverless = new Serverless({ servicePath: tmpDirPath });\n456.       serviceInstance = new Service(serverless);\n457. \n458.       return serviceInstance.load().then(() => {\n459.         // if we reach this, then no error was thrown as expected\n460.         // so make assertion fail intentionally to let us know something is wrong\n461.         expect(1).to.equal(2);\n462.       }).catch(e => {\n463.         expect(e.name).to.be.equal(\'ServerlessError\');\n464.       });\n465.     });\n466. \n467.     it(\'should throw error if provider property is invalid\', () => {\n468.       const SUtils = new Utils();\n469.       const serverlessYml = {\n470.         service: \'service-name\',\n471.         provider: \'invalid\',\n472.         functions: {},\n473.       };\n474. \n475.       SUtils.writeFileSync(path.join(tmpDirPath, \'serverless.yml\'),\n476.         YAML.dump(serverlessYml));\n477. \n478.       const serverless = new Serverless({ servicePath: tmpDirPath });\n479.       serviceInstance = new Service(serverless);\n480. \n481.       return serviceInstance.load().then(() => {\n482.         // if we reach this, then no error was thrown as expected\n483.         // so make assertion fail intentionally to let us know something is wrong\n484.         expect(1).to.equal(2);\n485.       }).catch(e => {\n486.         expect(e.name).to.be.equal(\'ServerlessError\');\n487.       });\n488.     });\n489.   });\n490. \n491.   describe(\'#update()\', () => {\n492.     it(\'should update service instance data\', () => {\n493.       const serverless = new Serverless();\n494.       const serviceInstance = new Service(serverless);\n495.       const newData = { service: \'newName\' };\n496.       const updatedInstance = serviceInstance.update(newData);\n497.       expect(updatedInstance.service).to.be.equal(\'newName\');\n498.     });\n499.   });\n500. \n\n\nFile: lib/classes/YamlParser.test.js\nLine number range: 1 - 99\nContent:\n1. \'use strict\';\n2. \n3. /**\n4.  * Test: YamlParser Function Class\n5.  */\n6. \n7. const expect = require(\'chai\').expect;\n8. const YAML = require(\'js-yaml\');\n9. const path = require(\'path\');\n10. const Serverless = require(\'../../lib/Serverless\');\n11. const testUtils = require(\'../../tests/utils\');\n12. \n13. const serverless = new Serverless();\n14. \n15. describe(\'YamlParser\', () => {\n16.   describe(\'#parse()\', () => {\n17.     it(\'should parse a simple .yaml file\', () => {\n18.       const tmpFilePath = testUtils.getTmpFilePath(\'simple.yaml\');\n19. \n20.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: \'bar\' }));\n21. \n22.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n23.         expect(obj.foo).to.equal(\'bar\');\n24.       });\n25.     });\n26. \n27.     it(\'should parse a simple .yml file\', () => {\n28.       const tmpFilePath = testUtils.getTmpFilePath(\'simple.yml\');\n29. \n30.       serverless.utils.writeFileSync(tmpFilePath, YAML.dump({ foo: \'bar\' }));\n31. \n32.       return serverless.yamlParser.parse(tmpFilePath).then((obj) => {\n33.         expect(obj.foo).to.equal(\'bar\');\n34.       });\n35.     });\n36. \n37.     it(\'should parse a .yml file with JSON-REF to YAML\', () => {\n38.       const tmpDirPath = testUtils.getTmpDirPath();\n39. \n40.       serverless.utils.writeFileSync(path.join(tmpDirPath, \'ref.yml\'), { foo: \'bar\' });\n41. \n42.       const testYml = {\n43.         main: {\n44.           $ref: \'./ref.yml\',\n45.         },\n46.       };\n47. \n48.       serverless.utils.writeFileSync(path.join(tmpDirPath, \'test.yml\'), testYml);\n49. \n50.       return serverless.yamlParser.parse(path.join(tmpDirPath, \'test.yml\')).then((obj) => {\n51.         expect(obj.main.foo).to.equal(\'bar\');\n52.       });\n53.     });\n54. \n55.     it(\'should parse a .yml file with JSON-REF to JSON\', () => {\n56.       const tmpDirPath = testUtils.getTmpDirPath();\n57. \n58.       serverless.utils.writeFileSync(path.join(tmpDirPath, \'ref.json\'), { foo: \'bar\' });\n59. \n60.       const testYml = {\n61.         main: {\n62.           $ref: \'./ref.json\',\n63.         },\n64.       };\n65. \n66.       serverless.utils.writeFileSync(path.join(tmpDirPath, \'test.yml\'), testYml);\n67. \n68.       return serverless.yamlParser.parse(path.join(tmpDirPath, \'test.yml\')).then((obj) => {\n69.         expect(obj.main.foo).to.equal(\'bar\');\n70.       });\n71.     });\n72. \n73.     it(\'should parse a .yml file with recursive JSON-REF\', () => {\n74.       const tmpDirPath = testUtils.getTmpDirPath();\n75. \n76.       serverless.utils.writeFileSync(path.join(tmpDirPath, \'three.yml\'), { foo: \'bar\' });\n77. \n78.       const twoYml = {\n79.         two: {\n80.           $ref: \'./three.yml\',\n81.         },\n82.       };\n83. \n84.       serverless.utils.writeFileSync(path.join(tmpDirPath, \'two.yml\'), twoYml);\n85. \n86.       const oneYml = {\n87.         one: {\n88.           $ref: \'./two.yml\',\n89.         },\n90.       };\n91. \n92.       serverless.utils.writeFileSync(path.join(tmpDirPath, \'one.yml\'), oneYml);\n93. \n94.       return serverless.yamlParser.parse(path.join(tmpDirPath, \'one.yml\')).then((obj) => {\n95.         expect(obj.one.two.foo).to.equal(\'bar\');\n96.       });\n97.     });\n98.   });\n99. });\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 1 - 113\nContent:\n1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n14. \n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n47. \n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n96. \n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n107.           }\n108.         });\n109.       }\n110.     });\n111.   }\n112. }\n113. module.exports = AwsCompileIoTEvents;\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.test.js\nLine number range: 1 - 229\nContent:\n1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsProvider = require(\'../../../../provider/awsProvider\');\n5. const AwsCompileIoTEvents = require(\'./index\');\n6. const Serverless = require(\'../../../../../../Serverless\');\n7. \n8. describe(\'AwsCompileIoTEvents\', () => {\n9.   let serverless;\n10.   let awsCompileIoTEvents;\n11. \n12.   beforeEach(() => {\n13.     serverless = new Serverless();\n14.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n15.     serverless.setProvider(\'aws\', new AwsProvider(serverless));\n16.     awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);\n17.     awsCompileIoTEvents.serverless.service.service = \'new-service\';\n18.   });\n19. \n20.   describe(\'#constructor()\', () => {\n21.     it(\'should set the provider variable to an instance of AwsProvider\', () =>\n22.       expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));\n23.   });\n24. \n25.   describe(\'#awsCompileIoTEvents()\', () => {\n26.     it(\'should throw an error if iot event type is not an object\', () => {\n27.       awsCompileIoTEvents.serverless.service.functions = {\n28.         first: {\n29.           events: [\n30.             {\n31.               iot: \'iot\',\n32.             },\n33.           ],\n34.         },\n35.       };\n36. \n37.       expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);\n38.     });\n39. \n40.     it(\'should create corresponding resources when iot events are given\', () => {\n41.       awsCompileIoTEvents.serverless.service.functions = {\n42.         first: {\n43.           events: [\n44.             {\n45.               iot: {\n46.                 sql: "SELECT * FROM \'topic_1\'",\n47.               },\n48.             },\n49.             {\n50.               iot: {\n51.                 sql: "SELECT * FROM \'topic_2\'",\n52.               },\n53.             },\n54.           ],\n55.         },\n56.       };\n57. \n58.       awsCompileIoTEvents.compileIoTEvents();\n59. \n60.       expect(awsCompileIoTEvents.serverless.service\n61.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type\n62.       ).to.equal(\'AWS::IoT::TopicRule\');\n63.       expect(awsCompileIoTEvents.serverless.service\n64.         .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type\n65.       ).to.equal(\'AWS::IoT::TopicRule\');\n66.       expect(awsCompileIoTEvents.serverless.service\n67.         .provider.compiledCloudFormationTemplate.Resources\n68.         .FirstIotTopicRule1.Properties.TopicRulePayload.Sql\n69.       ).to.equal(\'SELECT * FROM \\\'topic_1\\\'\');\n70.       expect(awsCompileIoTEvents.serverless.service\n71.         .provider.compiledCloudFormationTemplate.Resources\n72.         .FirstIotTopicRule2.Properties.TopicRulePayload.Sql\n73.       ).to.equal(\'SELECT * FROM \\\'topic_2\\\'\');\n74.       expect(awsCompileIoTEvents.serverless.service\n75.         .provider.compiledCloudFormationTemplate.Resources\n76.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n77.       ).to.equal(\'false\');\n78.       expect(awsCompileIoTEvents.serverless.service\n79.         .provider.compiledCloudFormationTemplate.Resources\n80.         .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled\n81.       ).to.equal(\'false\');\n82.       expect(awsCompileIoTEvents.serverless.service\n83.         .provider.compiledCloudFormationTemplate.Resources\n84.         .FirstLambdaPermissionIotTopicRule1.Type\n85.       ).to.equal(\'AWS::Lambda::Permission\');\n86.       expect(awsCompileIoTEvents.serverless.service\n87.         .provider.compiledCloudFormationTemplate.Resources\n88.         .FirstLambdaPermissionIotTopicRule2.Type\n89.       ).to.equal(\'AWS::Lambda::Permission\');\n90.     });\n91. \n92.     it(\'should respect "name" variable\', () => {\n93.       awsCompileIoTEvents.serverless.service.functions = {\n94.         first: {\n95.           events: [\n96.             {\n97.               iot: {\n98.                 name: \'iotEvantName\',\n99.                 sql: "SELECT * FROM \'topic_1\'",\n100.               },\n101.             },\n102.           ],\n103.         },\n104.       };\n105. \n106.       awsCompileIoTEvents.compileIoTEvents();\n107. \n108.       expect(awsCompileIoTEvents.serverless.service\n109.         .provider.compiledCloudFormationTemplate.Resources\n110.         .FirstIotTopicRule1.Properties.RuleName\n111.       ).to.equal(\'iotEvantName\');\n112.     });\n113. \n114.     it(\'should respect "enabled" variable\', () => {\n115.       awsCompileIoTEvents.serverless.service.functions = {\n116.         first: {\n117.           events: [\n118.             {\n119.               iot: {\n120.                 enabled: false,\n121.                 sql: "SELECT * FROM \'topic_1\'",\n122.               },\n123.             },\n124.           ],\n125.         },\n126.         second: {\n127.           events: [\n128.             {\n129.               iot: {\n130.                 enabled: true,\n131.                 sql: "SELECT * FROM \'topic_1\'",\n132.               },\n133.             },\n134.           ],\n135.         },\n136.       };\n137. \n138.       awsCompileIoTEvents.compileIoTEvents();\n139. \n140.       expect(awsCompileIoTEvents.serverless.service\n141.         .provider.compiledCloudFormationTemplate.Resources\n142.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n143.       ).to.equal(\'true\');\n144.       expect(awsCompileIoTEvents.serverless.service\n145.         .provider.compiledCloudFormationTemplate.Resources\n146.         .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n147.       ).to.equal(\'false\');\n148.     });\n149. \n150.     it(\'should respect "sqlVersion" variable\', () => {\n151.       awsCompileIoTEvents.serverless.service.functions = {\n152.         first: {\n153.           events: [\n154.             {\n155.               iot: {\n156.                 sqlVersion: \'2016-03-23\',\n157.                 sql: "SELECT * FROM \'topic_1\'",\n158.               },\n159.             },\n160.           ],\n161.         },\n162.       };\n163. \n164.       awsCompileIoTEvents.compileIoTEvents();\n165. \n166.       expect(awsCompileIoTEvents.serverless.service\n167.         .provider.compiledCloudFormationTemplate.Resources\n168.         .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion\n169.       ).to.equal(\'2016-03-23\');\n170.     });\n171. \n172.     it(\'should respect "description" variable\', () => {\n173.       awsCompileIoTEvents.serverless.service.functions = {\n174.         first: {\n175.           events: [\n176.             {\n177.               iot: {\n178.                 description: \'iot event description\',\n179.                 sql: "SELECT * FROM \'topic_1\'",\n180.               },\n181.             },\n182.           ],\n183.         },\n184.       };\n185. \n186.       awsCompileIoTEvents.compileIoTEvents();\n187. \n188.       expect(awsCompileIoTEvents.serverless.service\n189.         .provider.compiledCloudFormationTemplate.Resources\n190.         .FirstIotTopicRule1.Properties.TopicRulePayload.Description\n191.       ).to.equal(\'iot event description\');\n192.     });\n193. \n194.     it(\'should respect enabled variable if the "enabled" property is not given\', () => {\n195.       awsCompileIoTEvents.serverless.service.functions = {\n196.         first: {\n197.           events: [\n198.             {\n199.               iot: {\n200.                 sql: "SELECT * FROM \'topic_1\'",\n201.               },\n202.             },\n203.           ],\n204.         },\n205.       };\n206. \n207.       awsCompileIoTEvents.compileIoTEvents();\n208. \n209.       expect(awsCompileIoTEvents.serverless.service\n210.         .provider.compiledCloudFormationTemplate.Resources\n211.         .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled\n212.       ).to.equal(\'false\');\n213.     });\n214. \n215.     it(\'should not create corresponding resources when iot events are not given\', () => {\n216.       awsCompileIoTEvents.serverless.service.functions = {\n217.         first: {\n218.           events: [],\n219.         },\n220.       };\n221. \n222.       awsCompileIoTEvents.compileIoTEvents();\n223. \n224.       expect(awsCompileIoTEvents.serverless.service\n225.         .provider.compiledCloudFormationTemplate.Resources\n226.       ).to.deep.equal({});\n227.     });\n228.   });\n229. });\n\n\nFile: lib/plugins/aws/lib/naming.test.js\nLine number range: 1 - 455\nContent:\n1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. \n5. const SDK = require(\'../provider/awsProvider\');\n6. const Serverless = require(\'../../../Serverless\');\n7. \n8. describe(\'#naming()\', () => {\n9.   let options;\n10.   let serverless;\n11.   let sdk;\n12. \n13.   beforeEach(() => {\n14.     options = {\n15.       stage: \'dev\',\n16.       region: \'us-east-1\',\n17.     };\n18.     serverless = new Serverless(options);\n19.     sdk = new SDK(serverless, options);\n20.   });\n21. \n22.   describe(\'#normalizeName()\', () => {\n23.     it(\'should capitalize the first letter\', () => {\n24.       expect(sdk.naming.normalizeName(\'name\')).to.equal(\'Name\');\n25.     });\n26. \n27.     it(\'should have no effect on caps\', () => {\n28.       expect(sdk.naming.normalizeName(\'Name\')).to.equal(\'Name\');\n29.     });\n30. \n31.     it(\'should have no effect on the rest of the name\', () => {\n32.       expect(sdk.naming.normalizeName(\'nAME\')).to.equal(\'NAME\');\n33.     });\n34.   });\n35. \n36.   describe(\'#normalizeNameToAlphaNumericOnly()\', () => {\n37.     it(\'should strip non-alpha-numeric characters\', () => {\n38.       expect(sdk.naming\n39.         .normalizeNameToAlphaNumericOnly(\'`!@#$%^&*()-={}|[]\\\\:";\\\'<>?,./\')).to.equal(\'\');\n40.     });\n41. \n42.     it(\'should apply normalizeName to the remaining characters\', () => {\n43.       expect(sdk.naming.normalizeNameToAlphaNumericOnly(\'a-b-c\')).to.equal(\'Abc\');\n44.     });\n45.   });\n46. \n47.   describe(\'#normalizePathPart()\', () => {\n48.     it(\'converts `-` to `Dash`\', () => {\n49.       expect(sdk.naming.normalizePathPart(\n50.         \'a-path\'\n51.       )).to.equal(\'ADashpath\');\n52.     });\n53. \n54.     it(\'converts variable declarations (`${var}`) to `VariableVar`\', () => {\n55.       expect(sdk.naming.normalizePathPart(\n56.         \'${variable}\'\n57.       )).to.equal(\'VariableVar\');\n58.     });\n59. \n60.     it(\'converts variable declarations prefixes to `VariableVarpath`\', () => {\n61.       expect(sdk.naming.normalizePathPart(\n62.         \'${variable}Path\'\n63.       )).to.equal(\'VariableVarpath\');\n64.     });\n65. \n66.     it(\'converts variable declarations suffixes to `PathvariableVar`\', () => {\n67.       expect(sdk.naming.normalizePathPart(\n68.         \'path${variable}\'\n69.       )).to.equal(\'PathvariableVar\');\n70.     });\n71. \n72.     it(\'converts variable declarations in center to `PathvariableVardir`\', () => {\n73.       expect(sdk.naming.normalizePathPart(\n74.         \'path${variable}Dir\'\n75.       )).to.equal(\'PathvariableVardir\');\n76.     });\n77.   });\n78. \n79.   describe(\'#getServiceEndpointRegex()\', () => {\n80.     it(\'should match the prefix\', () => {\n81.       expect(sdk.naming.getServiceEndpointRegex().test(\'ServiceEndpoint\'))\n82.         .to.equal(true);\n83.     });\n84. \n85.     it(\'should not match a name without the prefix\', () => {\n86.       expect(sdk.naming.getServiceEndpointRegex()\n87.         .test(\'NotThePrefixServiceEndpoint\')).to.equal(false);\n88.     });\n89. \n90.     it(\'should match a name with the prefix\', () => {\n91.       expect(sdk.naming.getServiceEndpointRegex()\n92.         .test(\'ServiceEndpointForAService\')).to.equal(true);\n93.     });\n94.   });\n95. \n96.   describe(\'#getStackName()\', () => {\n97.     it(\'should use the service name and stage from the service and config\', () => {\n98.       serverless.service.service = \'myService\';\n99.       expect(sdk.naming.getStackName()).to.equal(`${serverless.service.service}-${options.stage}`);\n100.     });\n101.   });\n102. \n103.   describe(\'#getRolePath()\', () => {\n104.     it(\'should return `/`\', () => {\n105.       expect(sdk.naming.getRolePath()).to.equal(\'/\');\n106.     });\n107.   });\n108. \n109.   describe(\'#getRoleName()\', () => {\n110.     it(\'uses the service name, stage, and region to generate a role name\', () => {\n111.       serverless.service.service = \'myService\';\n112.       expect(sdk.naming.getRoleName()).to.eql({\n113.         \'Fn::Join\': [\n114.           \'-\',\n115.           [\n116.             serverless.service.service,\n117.             options.stage,\n118.             options.region,\n119.             \'lambdaRole\',\n120.           ],\n121.         ],\n122.       });\n123.     });\n124.   });\n125. \n126.   describe(\'#getRoleLogicalId()\', () => {\n127.     it(\'should return the expected role name (IamRoleLambdaExecution)\', () => {\n128.       expect(sdk.naming.getRoleLogicalId()).to.equal(\'IamRoleLambdaExecution\');\n129.     });\n130.   });\n131. \n132.   describe(\'#getPolicyName()\', () => {\n133.     it(\'should use the stage and service name\', () => {\n134.       serverless.service.service = \'myService\';\n135.       expect(sdk.naming.getPolicyName()).to.eql({\n136.         \'Fn::Join\': [\n137.           \'-\',\n138.           [\n139.             options.stage,\n140.             serverless.service.service,\n141.             \'lambda\',\n142.           ],\n143.         ],\n144.       });\n145.     });\n146.   });\n147. \n148.   describe(\'#getPolicyLogicalId()\', () => {\n149.     it(\'should return the expected policy name (IamPolicyLambdaExecution)\', () => {\n150.       expect(sdk.naming.getPolicyLogicalId()).to.equal(\'IamPolicyLambdaExecution\');\n151.     });\n152.   });\n153. \n154.   describe(\'#getLogicalLogGroupName()\', () => {\n155.     it(\'should prefix the normalized function name to "LogGroup"\', () => {\n156.       expect(sdk.naming.getLogGroupLogicalId(\'functionName\')).to.equal(\'FunctionNameLogGroup\');\n157.     });\n158.   });\n159. \n160.   describe(\'#getLogGroupName()\', () => {\n161.     it(\'should add the function name to the log group name\', () => {\n162.       expect(sdk.naming.getLogGroupName(\'functionName\')).to.equal(\'/aws/lambda/functionName\');\n163.     });\n164.   });\n165. \n166.   describe(\'#getNormalizedFunctionName()\', () => {\n167.     it(\'should normalize the given functionName\', () => {\n168.       expect(sdk.naming.getNormalizedFunctionName(\'functionName\'))\n169.         .to.equal(\'FunctionName\');\n170.     });\n171. \n172.     it(\'should normalize the given functionName with an underscore\', () => {\n173.       expect(sdk.naming.getNormalizedFunctionName(\'hello_world\'))\n174.         .to.equal(\'HelloUnderscoreworld\');\n175.     });\n176. \n177.     it(\'should normalize the given functionName with a dash\', () => {\n178.       expect(sdk.naming.getNormalizedFunctionName(\'hello-world\'))\n179.         .to.equal(\'HelloDashworld\');\n180.     });\n181.   });\n182. \n183.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n184.     it(\'should extract everything after the last colon and dash\', () => {\n185.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n186.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n187.     });\n188.   });\n189. \n190.   describe(\'#extractLambdaNameFromArn()\', () => {\n191.     it(\'should extract everything after the last colon\', () => {\n192.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n193.       expect(sdk.naming.extractLambdaNameFromArn(arn)).to.equal(\'my-dev-lambda\');\n194.     });\n195.   });\n196. \n197.   describe(\'#getLambdaLogicalId()\', () => {\n198.     it(\'should normalize the function name and add the logical suffix\', () => {\n199.       expect(sdk.naming.getLambdaLogicalId(\'functionName\'))\n200.         .to.equal(\'FunctionNameLambdaFunction\');\n201.     });\n202.   });\n203. \n204.   describe(\'#getLambdaLogicalIdRegex()\', () => {\n205.     it(\'should match the suffix\', () => {\n206.       expect(sdk.naming.getLambdaLogicalIdRegex()\n207.         .test(\'LambdaFunction\')).to.equal(true);\n208.     });\n209. \n210.     it(\'should not match a name without the suffix\', () => {\n211.       expect(sdk.naming.getLambdaLogicalIdRegex()\n212.         .test(\'LambdaFunctionNotTheSuffix\')).to.equal(false);\n213.     });\n214. \n215.     it(\'should match a name with the suffix\', () => {\n216.       expect(sdk.naming.getLambdaLogicalIdRegex()\n217.         .test(\'AFunctionNameLambdaFunction\')).to.equal(true);\n218.     });\n219.   });\n220. \n221.   describe(\'#getLambdaOutputLogicalId()\', () => {\n222.     it(\'should normalize the function name and add the logical arn suffix\', () => {\n223.       expect(\n224.         sdk.naming.getLambdaOutputLogicalId(\'functionName\')\n225.       ).to.equal(\'FunctionNameLambdaFunctionArn\');\n226.     });\n227.   });\n228. \n229.   describe(\'#getLambdaOutputLogicalIdRegex()\', () => {\n230.     it(\'should match the suffix\', () => {\n231.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n232.         .test(\'aLambdaFunctionArn\')).to.equal(true);\n233.     });\n234. \n235.     it(\'should not match a name without the suffix\', () => {\n236.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n237.         .test(\'LambdaFunctionArnNotTheSuffix\'))\n238.         .to.equal(false);\n239.     });\n240. \n241.     it(\'should match a name with the suffix\', () => {\n242.       expect(sdk.naming.getLambdaOutputLogicalIdRegex()\n243.         .test(\'AFunctionArnNameLambdaFunctionArn\'))\n244.         .to.equal(true);\n245.     });\n246.   });\n247. \n248.   describe(\'#getApiGatewayName()\', () => {\n249.     it(\'should return the composition of stage and service name\', () => {\n250.       serverless.service.service = \'myService\';\n251.       expect(sdk.naming.getApiGatewayName())\n252.         .to.equal(`${options.stage}-${serverless.service.service}`);\n253.     });\n254.   });\n255. \n256.   describe(\'#generateApiGatewayDeploymentLogicalId()\', () => {\n257.     it(\'should return ApiGatewayDeployment with a date based suffix\', () => {\n258.       expect(sdk.naming.generateApiGatewayDeploymentLogicalId()\n259.         .match(/ApiGatewayDeployment(.*)/).length)\n260.         .to.be.greaterThan(1);\n261.     });\n262.   });\n263. \n264.   describe(\'#getRestApiLogicalId()\', () => {\n265.     it(\'should return ApiGatewayRestApi\', () => {\n266.       expect(sdk.naming.getRestApiLogicalId()).to.equal(\'ApiGatewayRestApi\');\n267.     });\n268.   });\n269. \n270.   describe(\'#getNormalizedAuthorizerName()\', () => {\n271.     it(\'normalize the authorizer name\', () => {\n272.       expect(sdk.naming.getNormalizedAuthorizerName(\'authorizerName\'))\n273.         .to.equal(\'AuthorizerName\');\n274.     });\n275.   });\n276. \n277.   describe(\'#getAuthorizerLogicalId()\', () => {\n278.     it(\'should normalize the authorizer name and add the standard suffix\', () => {\n279.       expect(sdk.naming.getAuthorizerLogicalId(\'authorizerName\'))\n280.         .to.equal(\'AuthorizerNameApiGatewayAuthorizer\');\n281.     });\n282.   });\n283. \n284.   describe(\'#extractAuthorizerNameFromArn()\', () => {\n285.     it(\'should extract the authorizer name from an ARN\', () => {\n286.       const arn = \'arn:aws:lambda:us-east-1:0123456789:my-dev-lambda\';\n287.       expect(sdk.naming.extractAuthorizerNameFromArn(arn)).to.equal(\'lambda\');\n288.     });\n289.   });\n290. \n291.   describe(\'#normalizePath()\', () => {\n292.     it(\'should normalize each part of the resource path and remove non-alpha-numeric characters\',\n293.       () => {\n294.         expect(sdk.naming.normalizePath(\n295.           \'my/path/to/a-${var}-resource\'\n296.         )).to.equal(\'MyPathToADashvarVarDashresource\');\n297.       });\n298.   });\n299. \n300.   describe(\'#getResourceLogicalId()\', () => {\n301.     it(\'should normalize the resource and add the standard suffix\', () => {\n302.       expect(sdk.naming.getResourceLogicalId(\n303.         \'my/path/to/a-${var}-resource\'\n304.       )).to.equal(\'ApiGatewayResourceMyPathToADashvarVarDashresource\');\n305.     });\n306.   });\n307. \n308.   describe(\'#extractResourceId()\', () => {\n309.     it(\'should extract the normalized resource name\', () => {\n310.       expect(sdk.naming.extractResourceId(\n311.         \'ApiGatewayResourceMyPathToADashvarVarDashResource\'\n312.       )).to.equal(\'MyPathToADashvarVarDashResource\');\n313.     });\n314.   });\n315. \n316.   describe(\'#normalizeMethodName()\', () => {\n317.     it(\'should capitalize the first letter and lowercase any other characters\', () => {\n318.       expect(sdk.naming.normalizeMethodName(\'gET\')).to.equal(\'Get\');\n319.     });\n320.   });\n321. \n322.   describe(\'#getMethodLogicalId()\', () => {\n323.     it(\'\', () => {\n324.       expect(sdk.naming.getMethodLogicalId(\n325.         \'ResourceId\', \'get\'\n326.       )).to.equal(\'ApiGatewayMethodResourceIdGet\');\n327.     });\n328.   });\n329. \n330.   describe(\'#getApiKeyLogicalId(keyIndex)\', () => {\n331.     it(\'should produce the given index with ApiGatewayApiKey as a prefix\', () => {\n332.       expect(sdk.naming.getApiKeyLogicalId(1)).to.equal(\'ApiGatewayApiKey1\');\n333.     });\n334.   });\n335. \n336.   describe(\'#getApiKeyLogicalIdRegex()\', () => {\n337.     it(\'should match the prefix\', () => {\n338.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n339.         .test(\'ApiGatewayApiKey\')).to.equal(true);\n340.     });\n341. \n342.     it(\'should not match a name without the prefix\', () => {\n343.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n344.         .test(\'NotThePrefixApiGatewayApiKey\')).to.equal(false);\n345.     });\n346. \n347.     it(\'should match a name with the prefix\', () => {\n348.       expect(sdk.naming.getApiKeyLogicalIdRegex()\n349.         .test(\'ApiGatewayApiKeySuffix\')).to.equal(true);\n350.     });\n351.   });\n352. \n353.   describe(\'#getDeploymentBucketLogicalId()\', () => {\n354.     it(\'should return "ServerlessDeploymentBucket"\', () => {\n355.       expect(sdk.naming.getDeploymentBucketLogicalId()).to.equal(\'ServerlessDeploymentBucket\');\n356.     });\n357.   });\n358. \n359.   describe(\'#getDeploymentBucketOutputLogicalId()\', () => {\n360.     it(\'should return "ServerlessDeploymentBucketName"\', () => {\n361.       expect(sdk.naming.getDeploymentBucketOutputLogicalId())\n362.         .to.equal(\'ServerlessDeploymentBucketName\');\n363.     });\n364.   });\n365. \n366.   describe(\'#normalizeBucketName()\', () => {\n367.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n368.       expect(sdk.naming.normalizeBucketName(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'BucketName\');\n369.     });\n370.   });\n371. \n372.   describe(\'#getBucketLogicalId()\', () => {\n373.     it(\'should normalize the bucket name and add the standard prefix\', () => {\n374.       expect(sdk.naming.getBucketLogicalId(\'b!u@c#k$e%t^N&a*m(e\')).to.equal(\'S3BucketBucketName\');\n375.     });\n376.   });\n377. \n378.   describe(\'#normalizeTopicName()\', () => {\n379.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n380.       expect(sdk.naming.normalizeTopicName(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'TopicName\');\n381.     });\n382.   });\n383. \n384.   describe(\'#getTopicLogicalId()\', () => {\n385.     it(\'should remove all non-alpha-numeric characters and capitalize the first letter\', () => {\n386.       expect(sdk.naming.getTopicLogicalId(\'t!o@p#i$c%N^a&m*e\')).to.equal(\'SNSTopicTopicName\');\n387.     });\n388.   });\n389. \n390.   describe(\'#getScheduleId()\', () => {\n391.     it(\'should add the standard suffix\', () => {\n392.       expect(sdk.naming.getScheduleId(\'functionName\')).to.equal(\'functionNameSchedule\');\n393.     });\n394.   });\n395. \n396.   describe(\'#getScheduleLogicalId()\', () => {\n397.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n398.       expect(sdk.naming.getScheduleLogicalId(\'functionName\', 0))\n399.         .to.equal(\'FunctionNameEventsRuleSchedule0\');\n400.     });\n401.   });\n402. \n403.   describe(\'#getLambdaS3PermissionLogicalId()\', () => {\n404.     it(\'should normalize the function name and add the standard suffix\', () => {\n405.       expect(sdk.naming.getLambdaS3PermissionLogicalId(\'functionName\', \'bucket\'))\n406.         .to.equal(\'FunctionNameLambdaPermissionBucketS3\');\n407.     });\n408.   });\n409. \n410.   describe(\'#getLambdaSnsPermissionLogicalId()\', () => {\n411.     it(\'should normalize the function and topic names and add them as prefix and suffix to the \' +\n412.       \'standard permission center\', () => {\n413.       expect(sdk.naming.getLambdaSnsPermissionLogicalId(\'functionName\', \'topic\'))\n414.         .to.equal(\'FunctionNameLambdaPermissionTopicSNS\');\n415.     });\n416.   });\n417. \n418.   describe(\'#getLambdaSchedulePermissionLogicalId()\', () => {\n419.     it(\'should normalize the function name and add the standard suffix including event index\',\n420.       () => {\n421.         expect(sdk.naming.getLambdaSchedulePermissionLogicalId(\'functionName\', 0))\n422.           .to.equal(\'FunctionNameLambdaPermissionEventsRuleSchedule0\');\n423.       });\n424.   });\n425. \n426.   describe(\'#getLambdaApiGatewayPermissionLogicalId()\', () => {\n427.     it(\'should normalize the function name and append the standard suffix\', () => {\n428.       expect(sdk.naming.getLambdaApiGatewayPermissionLogicalId(\'functionName\'))\n429.         .to.equal(\'FunctionNameLambdaPermissionApiGateway\');\n430.     });\n431.   });\n432. \n433.   describe(\'#getIotLogicalId()\', () => {\n434.     it(\'should normalize the function name and add the standard suffix including the index\', () => {\n435.       expect(sdk.naming.getIotLogicalId(\'functionName\', 0))\n436.         .to.equal(\'FunctionNameIotTopicRule0\');\n437.     });\n438.   });\n439. \n440.   describe(\'#getLambdaIotPermissionLogicalId()\', () => {\n441.     it(\'should normalize the function name and add the standard suffix including event index\',\n442.       () => {\n443.         expect(sdk.naming.getLambdaIotPermissionLogicalId(\'functionName\', 0))\n444.           .to.equal(\'FunctionNameLambdaPermissionIotTopicRule0\');\n445.       });\n446.   });\n447. \n448.   describe(\'#getLambdaAlexaSkillPermissionLogicalId()\', () => {\n449.     it(\'should normalize the function name and append the standard suffix\',\n450.       () => {\n451.         expect(sdk.naming.getLambdaAlexaSkillPermissionLogicalId(\'functionName\'))\n452.           .to.equal(\'FunctionNameLambdaPermissionAlexaSkill\');\n453.       });\n454.   });\n455. });\n\n\nNow generate the complete self-contained test case that reproduces the bug with the same error/exception.\n' additional_kwargs={} response_metadata={}
2025-11-14 00:32:08,283 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_write_node - DEBUG - content='\'use strict\';\n\nconst expect = require(\'chai\').expect;\nconst AwsProvider = require(\'../../../../provider/awsProvider\');\nconst AwsCompileIoTEvents = require(\'./index\');\nconst Serverless = require(\'../../../../../../Serverless\');\n\ndescribe(\'AwsCompileIoTEvents\', () => {\n  let serverless;\n  let awsCompileIoTEvents;\n\n  beforeEach(() => {\n    serverless = new Serverless();\n    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n    serverless.setProvider(\'aws\', new AwsProvider(serverless));\n    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);\n    awsCompileIoTEvents.serverless.service.service = \'new-service\';\n  });\n\n  describe(\'#awsCompileIoTEvents()\', () => {\n    it(\'should not throw when iot event contains multi-line values\', () => {\n      awsCompileIoTEvents.serverless.service.functions = {\n        first: {\n          events: [\n            {\n              iot: {\n                description: \'My multi-\\nline value.\\n\',\n                name: \'enrollPlayer\',\n                sql: "SELECT * FROM \'path/#\'\\nWHERE prop = \'value\'\\n",\n              },\n            },\n          ],\n        },\n      };\n\n      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();\n    });\n  });\n});' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2335, 'prompt_tokens': 15105, 'total_tokens': 17440, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2048, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--dac276cf-2667-43d7-8955-719ea5469869-0' usage_metadata={'input_tokens': 15105, 'output_tokens': 2335, 'total_tokens': 17440, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 2048}}
2025-11-14 00:32:12,027 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_R9v6iYarRfivwebRZBveLdrV', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 225, 'prompt_tokens': 3244, 'total_tokens': 3469, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--48aa85db-a6e1-4e8b-a89b-475b74985fa3-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/index.js'}, 'id': 'call_R9v6iYarRfivwebRZBveLdrV', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3244, 'output_tokens': 225, 'total_tokens': 3469, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-14 00:32:14,221 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PnTkcpGk41wcBFUj7AJXUfHJ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 91, 'prompt_tokens': 3296, 'total_tokens': 3387, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f6e5827b-6714-4f1f-92bb-67bb66f045cb-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws'}, 'id': 'call_PnTkcpGk41wcBFUj7AJXUfHJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3296, 'output_tokens': 91, 'total_tokens': 3387, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-14 00:32:25,215 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CnMdBIlULpXs5tVl5qGdcK9o', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1252, 'prompt_tokens': 3346, 'total_tokens': 4598, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1216, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a3d138da-373b-4281-97fd-20b6adc4ad0d-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_CnMdBIlULpXs5tVl5qGdcK9o', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3346, 'output_tokens': 1252, 'total_tokens': 4598, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1216}}
2025-11-14 00:32:27,756 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_WGI9rEo2jBz1w5l4HIuO6h4n', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 98, 'prompt_tokens': 4378, 'total_tokens': 4476, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cf330c11-b10a-4fad-bc9b-f573dd4a0a7f-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot'}, 'id': 'call_WGI9rEo2jBz1w5l4HIuO6h4n', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4378, 'output_tokens': 98, 'total_tokens': 4476, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-14 00:32:34,503 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HUNFuWiVAUlq25T6TUPnPhxh', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 672, 'prompt_tokens': 4435, 'total_tokens': 5107, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f65e7725-4fc6-4993-a6ec-55d5ff50f690-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.test.js'}, 'id': 'call_HUNFuWiVAUlq25T6TUPnPhxh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4435, 'output_tokens': 672, 'total_tokens': 5107, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-14 00:32:39,268 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kLIIsgrWzULaEe7pTt7Vz13w', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 293, 'prompt_tokens': 9133, 'total_tokens': 9426, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4352}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--da2c4fdd-1c27-4b4d-b632-abb0a79f9305-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.test.js'}, 'id': 'call_kLIIsgrWzULaEe7pTt7Vz13w', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9133, 'output_tokens': 293, 'total_tokens': 9426, 'input_token_details': {'audio': 0, 'cache_read': 4352}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-14 00:32:48,346 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_tXz6Kp5KbAbpZmlhLG4ktqt1', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js","content":"\'use strict\';\\n\\nconst expect = require(\'chai\').expect;\\nconst AwsProvider = require(\'../../../../provider/awsProvider\');\\nconst AwsCompileIoTEvents = require(\'./index\');\\nconst Serverless = require(\'../../../../../../Serverless\');\\n\\ndescribe(\'AwsCompileIoTEvents\', () => {\\n  let serverless;\\n  let awsCompileIoTEvents;\\n\\n  beforeEach(() => {\\n    serverless = new Serverless();\\n    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\\n    serverless.setProvider(\'aws\', new AwsProvider(serverless));\\n    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);\\n    awsCompileIoTEvents.serverless.service.service = \'new-service\';\\n  });\\n\\n  describe(\'#awsCompileIoTEvents()\', () => {\\n    it(\'should not throw when iot event contains multi-line values\', () => {\\n      awsCompileIoTEvents.serverless.service.functions = {\\n        first: {\\n          events: [\\n            {\\n              iot: {\\n                description: \'My multi-\\\\nline value.\\\\n\',\\n                name: \'enrollPlayer\',\\n                sql: \\"SELECT * FROM \'path/#\'\\\\nWHERE prop = \'value\'\\\\n\\",\\n              },\\n            },\\n          ],\\n        },\\n      };\\n\\n      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();\\n    });\\n  });\\n});"}', 'name': 'create_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 960, 'prompt_tokens': 11222, 'total_tokens': 12182, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--112866c3-4e15-4279-972d-d1cbc8ec88d4-0' tool_calls=[{'name': 'create_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js', 'content': '\'use strict\';\n\nconst expect = require(\'chai\').expect;\nconst AwsProvider = require(\'../../../../provider/awsProvider\');\nconst AwsCompileIoTEvents = require(\'./index\');\nconst Serverless = require(\'../../../../../../Serverless\');\n\ndescribe(\'AwsCompileIoTEvents\', () => {\n  let serverless;\n  let awsCompileIoTEvents;\n\n  beforeEach(() => {\n    serverless = new Serverless();\n    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n    serverless.setProvider(\'aws\', new AwsProvider(serverless));\n    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);\n    awsCompileIoTEvents.serverless.service.service = \'new-service\';\n  });\n\n  describe(\'#awsCompileIoTEvents()\', () => {\n    it(\'should not throw when iot event contains multi-line values\', () => {\n      awsCompileIoTEvents.serverless.service.functions = {\n        first: {\n          events: [\n            {\n              iot: {\n                description: \'My multi-\\nline value.\\n\',\n                name: \'enrollPlayer\',\n                sql: "SELECT * FROM \'path/#\'\\nWHERE prop = \'value\'\\n",\n              },\n            },\n          ],\n        },\n      };\n\n      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();\n    });\n  });\n});'}, 'id': 'call_tXz6Kp5KbAbpZmlhLG4ktqt1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11222, 'output_tokens': 960, 'total_tokens': 12182, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-14 00:32:49,852 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_file_node - DEBUG - content='lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 20, 'prompt_tokens': 11632, 'total_tokens': 11652, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--f4709640-f2c4-4ce5-b0b7-fc66a2074029-0' usage_metadata={'input_tokens': 11632, 'output_tokens': 20, 'total_tokens': 11652, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:32:49,893 - thread-135845308794560.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
new file mode 100644
index 000000000..c00c46231
--- /dev/null
+++ b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
@@ -0,0 +1,39 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileIoTEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileIoTEvents', () => {
+  let serverless;
+  let awsCompileIoTEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
+    awsCompileIoTEvents.serverless.service.service = 'new-service';
+  });
+
+  describe('#awsCompileIoTEvents()', () => {
+    it('should not throw when iot event contains multi-line values', () => {
+      awsCompileIoTEvents.serverless.service.functions = {
+        first: {
+          events: [
+            {
+              iot: {
+                description: 'My multi-\nline value.\n',
+                name: 'enrollPlayer',
+                sql: "SELECT * FROM 'path/#'\nWHERE prop = 'value'\n",
+              },
+            },
+          ],
+        },
+      };
+
+      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();
+    });
+  });
+});
\ No newline at end of file

2025-11-14 00:32:49,895 - thread-135845308794560.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-14 00:32:49,916 - thread-135845308794560.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-14 00:32:49,916 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-14 00:32:50,035 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:32:50,035 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 356a3d596 Merge pull request #3086 from alasdairnicol/docs_python_hello_world
[?2004l
2025-11-14 00:32:50,035 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-14 00:32:50,137 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:32:50,137 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
Removing Dockerfile
[?2004l
2025-11-14 00:32:50,138 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-14 00:32:50,138 - thread-135845308794560.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/deploy/compile/events/iot in the container
2025-11-14 00:32:50,138 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/deploy/compile/events/iot
2025-11-14 00:32:50,240 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:32:50,240 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-14 00:32:50,241 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js in the container
2025-11-14 00:32:50,250 - thread-135845308794560.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-14 00:32:54,258 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hVXN8zdgfHA1RfPT09HG8REA', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 282, 'prompt_tokens': 1184, 'total_tokens': 1466, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a798e2ec-fe97-43b1-a9dd-ee0f5381e2e6-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_hVXN8zdgfHA1RfPT09HG8REA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1184, 'output_tokens': 282, 'total_tokens': 1466, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-14 00:32:54,261 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-14 00:32:54,363 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:32:54,363 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 204
drwxr-xr-x   1 root root  4096 Nov 14 00:32 [0m[01;34m.[0m
drwxr-xr-x   1 root root  4096 Nov 14 00:32 [01;34m..[0m
-rw-r--r--   1 root root   232 Nov 14 00:32 .editorconfig
-rw-r--r--   1 root root    45 Nov 14 00:32 .eslintignore
-rw-r--r--   1 root root   339 Nov 14 00:32 .eslintrc.js
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34m.git[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34m.github[0m
-rwxr-xr-x   1 root root   691 Nov 14 00:32 [01;32m.gitignore[0m
-rw-r--r--   1 root root  1512 Nov 14 00:32 .jsbeautifyrc
-rw-r--r--   1 root root  3934 Nov 14 00:32 .travis.yml
-rw-r--r--   1 root root  5151 Nov 14 00:32 0.5.x-RESOURCES.md
-rw-r--r--   1 root root  9786 Nov 14 00:32 CHANGELOG.md
-rw-r--r--   1 root root  5927 Nov 14 00:32 CONTRIBUTING.md
-rw-r--r--   1 root root  1439 Nov 14 00:32 LICENSE.txt
-rwxr-xr-x   1 root root 25723 Nov 14 00:32 [01;32mREADME.md[0m
-rw-r--r--   1 root root  3092 Nov 14 00:32 RELEASE_CHECKLIST.md
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mbin[0m
-rw-r--r--   1 root root  3290 Nov 14 00:32 code_of_conduct.md
-rw-r--r--   1 root root   992 Nov 14 00:32 docker-compose.yml
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mdocs[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mlib[0m
drwxr-xr-x 626 root root 20480 Aug 28 02:31 [01;34mnode_modules[0m
-rw-r--r--   1 root root 29294 Nov 14 00:32 npm-shrinkwrap.json
-rw-r--r--   1 root root  2930 Nov 14 00:32 package.json
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mscripts[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mtests[0m
[?2004l
2025-11-14 00:32:57,837 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_sFbCwYWFk224NMUzj8Mp6S5T', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 154, 'prompt_tokens': 2028, 'total_tokens': 2182, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 128, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dbae0dfe-b299-4519-984b-b821572f648b-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_sFbCwYWFk224NMUzj8Mp6S5T', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2028, 'output_tokens': 154, 'total_tokens': 2182, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 128}}
2025-11-14 00:32:57,841 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-14 00:32:57,943 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:32:57,943 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.5.0",
  "engines": {
    "node": ">=4.0"
  },
  "preferGlobal": true,
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "author": "serverless.com",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/serverless/serverless"
  },
  "keywords": [
    "serverless",
    "serverless framework",
    "serverless applications",
    "serverless modules",
    "api gateway",
    "lambda",
    "aws",
    "aws lambda",
    "amazon",
    "amazon web services",
    "azure",
    "azure functions",
    "google cloud functions",
    "ibm open whisk",
    "iot",
    "internet of things",
    "serverless.com"
  ],
  "files": [
    "bin",
    "lib",
    "scripts/postinstall.js",
    "scripts/preuninstall.js",
    "package.json",
    "npm-shrinkwrap.json",
    "README.md",
    "LICENSE.txt",
    "CHANGELOG.md"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless",
    "slss": "./bin/serverless",
    "sls": "./bin/serverless"
  },
  "scripts": {
    "test": "istanbul cover -x '**/*.test.js' node_modules/mocha/bin/_mocha '!(node_modules)/**/*.test.js' -- -R spec --recursive",
    "lint": "eslint . --cache",
    "docs": "node scripts/generate-readme.js",
    "simple-integration-test": "jest --maxWorkers=5 simple-suite",
    "complex-integration-test": "jest --maxWorkers=5 integration",
    "postinstall": "node ./scripts/postinstall.js",
    "preuninstall": "node ./scripts/preuninstall.js"
  },
  "jest": {
    "testRegex": "(\\.|/)(tests)\\.js$",
    "setupTestFrameworkScriptFile": "<rootDir>/tests/setupTests.js"
  },
  "devDependencies": {
    "chai": "^3.5.0",
    "coveralls": "^2.11.12",
    "eslint": "^3.3.1",
    "eslint-config-airbnb": "^10.0.1",
    "eslint-config-airbnb-base": "^5.0.2",
    "eslint-plugin-import": "^1.13.0",
    "eslint-plugin-jsx-a11y": "^2.1.0",
    "eslint-plugin-react": "^6.1.1",
    "istanbul": "^0.4.4",
    "jest-cli": "^18.0.0",
    "jszip": "^3.1.2",
    "markdown-magic": "0.1.0",
    "mocha": "^3.0.2",
    "mocha-lcov-reporter": "^1.2.0",
    "mock-require": "^1.3.0",
    "proxyquire": "^1.7.10",
    "sinon": "^1.17.5"
  },
  "dependencies": {
    "archiver": "^1.1.0",
    "async": "^1.5.2",
    "aws-sdk": "^2.7.13",
    "bluebird": "^3.4.0",
    "chalk": "^1.1.1",
    "download": "^5.0.2",
    "filesize": "^3.3.0",
    "fs-extra": "^0.26.7",
    "get-stdin": "^5.0.1",
    "glob-all": "^3.1.0",
    "https-proxy-agent": "^1.0.0",
    "js-yaml": "^3.6.1",
    "json-refs": "^2.1.5",
    "lodash": "^4.13.1",
    "minimist": "^1.2.0",
    "moment": "^2.13.0",
    "node-fetch": "^1.5.3",
    "replaceall": "^0.1.6",
    "semver": "^5.0.3",
    "semver-regex": "^1.0.0",
    "shelljs": "^0.6.0",
    "traverse": "^0.6.6",
    "uuid": "^2.0.2"
  }
}
[?2004l
2025-11-14 00:33:03,870 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_KqRd27wXsHNjB0rdXzH1Fwg5', 'function': {'arguments': '{"command":"node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 499, 'prompt_tokens': 3080, 'total_tokens': 3579, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7d5ecb57-47fc-4653-92e9-9c8ed10ad83c-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec'}, 'id': 'call_KqRd27wXsHNjB0rdXzH1Fwg5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3080, 'output_tokens': 499, 'total_tokens': 3579, 'input_token_details': {'audio': 0, 'cache_read': 1920}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-14 00:33:03,874 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec
2025-11-14 00:33:04,297 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 1
2025-11-14 00:33:04,297 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node node_modules/mocha/bin/_mocha lib/plugins/aws/de
eploy/compile/events/iot/multiline-values.test.js -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [31m  1) should not throw when iot event contains multi-line values[0m


[92m [0m[32m 0 passing[0m[90m (8ms)[0m
[31m  1 failing[0m

[0m  1) AwsCompileIoTEvents #awsCompileIoTEvents() should not throw when iot event contains multi-line values:
[0m[31m     AssertionError: expected [Function] to not throw an error but 'SyntaxError: Unexpected token \n in JSON at position 248' was thrown[0m[90m
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js:36:72)
      at processImmediate (node:internal/timers:466:21)
[0m


[?2004l
2025-11-14 00:33:20,267 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_execute_node - DEBUG - content=" node node_modules/mocha/bin/_mocha lib/plugins/aws/de\neploy/compile/events/iot/multiline-values.test.js -R spec\n\x1b[?2004l\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileIoTEvents\x1b[0m\n\x1b[0m    #awsCompileIoTEvents()\x1b[0m\n    \x1b[31m  1) should not throw when iot event contains multi-line values\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 0 passing\x1b[0m\x1b[90m (8ms)\x1b[0m\n\x1b[31m  1 failing\x1b[0m\n\n\x1b[0m  1) AwsCompileIoTEvents #awsCompileIoTEvents() should not throw when iot event contains multi-line values:\n\x1b[0m\x1b[31m     AssertionError: expected [Function] to not throw an error but 'SyntaxError: Unexpected token \\n in JSON at position 248' was thrown\x1b[0m\x1b[90m\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js:36:72)\n      at processImmediate (node:internal/timers:466:21)\n\x1b[0m\n\n\n\x1b[?2004l" additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1639, 'prompt_tokens': 3420, 'total_tokens': 5059, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1344, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--c0e3e968-ce93-46f9-8fac-a0253e49e12c-0' usage_metadata={'input_tokens': 3420, 'output_tokens': 1639, 'total_tokens': 5059, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1344}}
2025-11-14 00:33:37,617 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproducing_structured_node - DEBUG - reproduced_bug=True reproduced_bug_failure_log="node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec\n\n  AwsCompileIoTEvents\n    #awsCompileIoTEvents()\n      1) should not throw when iot event contains multi-line values\n\n\n  0 passing (8ms)\n  1 failing\n\n  1) AwsCompileIoTEvents #awsCompileIoTEvents() should not throw when iot event contains multi-line values:\n     AssertionError: expected [Function] to not throw an error but 'SyntaxError: Unexpected token \\n in JSON at position 248' was thrown\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js:36:72)\n      at processImmediate (node:internal/timers:466:21)\n" reproduced_bug_commands=['node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec']
2025-11-14 00:33:37,637 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug: True
2025-11-14 00:33:37,637 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug_file: lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
2025-11-14 00:33:37,637 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug_commands: ['node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec']
2025-11-14 00:33:37,637 - thread-135845308794560.prometheus.lang_graph.nodes.bug_reproduction_subgraph_node - INFO - reproduced_bug_patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
new file mode 100644
index 000000000..c00c46231
--- /dev/null
+++ b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
@@ -0,0 +1,39 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileIoTEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileIoTEvents', () => {
+  let serverless;
+  let awsCompileIoTEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
+    awsCompileIoTEvents.serverless.service.service = 'new-service';
+  });
+
+  describe('#awsCompileIoTEvents()', () => {
+    it('should not throw when iot event contains multi-line values', () => {
+      awsCompileIoTEvents.serverless.service.functions = {
+        first: {
+          events: [
+            {
+              iot: {
+                description: 'My multi-\nline value.\n',
+                name: 'enrollPlayer',
+                sql: "SELECT * FROM 'path/#'\nWHERE prop = 'value'\n",
+              },
+            },
+          ],
+        },
+      };
+
+      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();
+    });
+  });
+});
\ No newline at end of file

2025-11-14 00:33:37,639 - thread-135845308794560.prometheus.lang_graph.nodes.issue_verified_bug_subgraph_node - INFO - Enter IssueVerifiedBugSubgraphNode
2025-11-14 00:33:37,642 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

2025-11-14 00:33:37,644 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-14 00:33:37,647 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:33:51,787 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The issue references an error in lib/plugins/aws/deploy/compile/events/iot/index.js (Unexpected token) and mentions the iotTemplate string preserving trailing newlines, causing invalid JSON. To analyze and fix it, I need the exact implementation of this IoT compile plugin, including how iotTemplate is constructed and parsed. Additionally, the IoT event documentation will clarify expected config fields and behavior.' query='Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md' extra_requirements='If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.' purpose='This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.'
2025-11-14 00:33:51,789 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
2025-11-14 00:33:54,400 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-14 00:33:54,400 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-14 00:33:54,400 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-14 00:33:54,400 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-14 00:33:54,402 - thread-135845308794560.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-14 00:33:54,403 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-14 00:33:54,403 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
Extra requirements: If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.
Purpose: This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.
2025-11-14 00:33:58,800 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_jqNKyUT1UmUmvUiRVPpm3e7E', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 297, 'prompt_tokens': 2188, 'total_tokens': 2485, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e8c687c5-905b-4eef-bc83-a7335b644773-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_jqNKyUT1UmUmvUiRVPpm3e7E', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2188, 'output_tokens': 297, 'total_tokens': 2485, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-14 00:34:00,264 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ZISJmk8q7SuwwHSRP59VwrQJ', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/iot.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 3453, 'total_tokens': 3483, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d19f17c3-2852-46bc-96bf-61f42bf53ddf-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/events/iot.md'}, 'id': 'call_ZISJmk8q7SuwwHSRP59VwrQJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3453, 'output_tokens': 30, 'total_tokens': 3483, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:34:06,439 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I located and read the full contents of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md. In index.js, I confirmed the require statements, the iotTemplate string construction, and the JSON.parse usage for both iotTemplate and permissionTemplate before merging into the compiled CloudFormation template. I also retrieved the IoT event documentation that shows how the YAML is defined, including examples of sql, enabled, name, description, and sqlVersion. This should give you a clear path to trace how multi-line YAML values flow into the IoT template and where newline escaping would need to be handled.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 651, 'prompt_tokens': 4201, 'total_tokens': 4852, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--e6a8720f-b473-4961-ad44-ee1d2b436211-0' usage_metadata={'input_tokens': 4201, 'output_tokens': 651, 'total_tokens': 4852, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-14 00:34:06,442 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: docs/providers/aws/events/iot.md
Line number range: 1 - 71
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - IoT
3. menuText: IoT
4. menuOrder: 7
5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)
11. <!-- DOCS-SITE-LINK:END -->
12. 
13. # IoT
14. 
15. ## Simple event definition
16. 
17. This will enable your Lambda function to be called by an AWS IoT rule.
18. 
19. ```yml
20. functions:
21.   myIoT:
22.     handler: myIoT.handler
23.     events:
24.       - iot:
25.           sql: "SELECT * FROM 'some_topic'"
26. ```
27. 
28. ## Enabling / Disabling
29. 
30. **Note:** `iot` events are enabled by default.
31. 
32. This will create and attach a disabled `iot` event for the `myIoT` function.
33. 
34. ```yml
35. functions:
36.   myIoT:
37.     handler: myIoT.handler
38.     events:
39.       - iot:
40.           sql: "SELECT * FROM 'some_topic'"
41.           enabled: false
42. ```
43. 
44. ## Specify Name and Description
45. 
46. Name and Description can be specified with the help of the `name` and `description` properties.
47. 
48. ```yml
49. functions:
50.   myIoT:
51.     handler: myIoT.handler
52.     events:
53.       - iot:
54.           name: "myIotEvent"
55.           sql: "SELECT * FROM 'some_topic'"
56.           description: "My IoT Event Description"
57. ```
58. 
59. ## Specify SQL Versions
60. 
61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.
62. 
63. ```yml
64. functions:
65.   myIoT:
66.     handler: myIoT.handler
67.     events:
68.       - iot:
69.           sql: "SELECT * FROM 'some_topic'"
70.           sqlVersion: "beta"
71. ```


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }
14. 
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }
47. 
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;
96. 
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);
107.           }
108.         });
109.       }
110.     });
111.   }
112. }
113. module.exports = AwsCompileIoTEvents;

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-14 00:34:34,909 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="Query requirement analysis:\n- The user requests full content of index.js with a focus on import/require statements and template construction.\n- These lines include the require statement and file header, satisfying the 'imports/require' requirement.\nExtended relevance:\n- Establishes module setup and lodash inclusion used later for merging templates.", relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=1, end_line=4), ContextOutput(reasoning="Query requirement analysis:\n- The user needs to trace where multi-line YAML values (e.g., 'sql') are read and assigned before template construction.\n- These lines show the entry point function and the extraction of RuleName, AwsIotSqlVersion, Description, RuleDisabled, and especially Sql = event.iot.sql.\nExtended relevance:\n- Essential to understand how event.iot object fields are transformed and used in template creation.", relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=15, end_line=39), ContextOutput(reasoning='Query requirement analysis:\n- The user asked for definitions and usage of iotTemplate and related identifiers.\n- These lines compute logical IDs used in the iotTemplate.\nExtended relevance:\n- Provides necessary identifiers for template construction that reference Lambda and IoT resources.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=48, end_line=53), ContextOutput(reasoning="Query requirement analysis:\n- The user specifically asked for the definitions and usage of iotTemplate and where template construction occurs.\n- These lines define the iotTemplate string, including embedding of Sql and other properties.\nExtended relevance:\n- Critical for understanding how the IoT TopicRule CloudFormation resource is constructed, and where newline escaping may impact 'Sql'.", relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=54, end_line=75), ContextOutput(reasoning='Query requirement analysis:\n- Template construction also occurs for permissions related to the IoT rule invoking the Lambda.\n- These lines define permissionTemplate.\nExtended relevance:\n- Complements iotTemplate with the Lambda permission resource necessary for completeness; helpful to see overall template-building pattern.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=76, end_line=95), ContextOutput(reasoning='Query requirement analysis:\n- The user requested functions where JSON.parse or template construction occurs.\n- These lines show JSON.parse applied to the constructed templates and merging into compiled CloudFormation resources.\nExtended relevance:\n- Demonstrates how the string templates are converted into JSON objects and injected into the final template, which is key to tracking where newline handling would matter.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=97, end_line=106), ContextOutput(reasoning="Query requirement analysis:\n- The user requests full content of the docs file; it is relatively small, and including all lines meets the request.\nExtended relevance:\n- Provides examples of YAML definitions for iot events (including 'sql', 'enabled', 'name', 'description', and 'sqlVersion') which are the source values mapped into the IoT template.", relative_path='docs/providers/aws/events/iot.md', start_line=1, end_line=71)]
2025-11-14 00:34:34,913 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 7 contexts to memory for query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
2025-11-14 00:34:36,980 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-14 00:34:36,982 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 7 new contexts to 0 existing contexts
2025-11-14 00:34:36,982 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 7 total contexts (removed 0 duplicates)
2025-11-14 00:34:36,984 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
Extra Requirements: If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.
Purpose: This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/iot.md
Line number range: 1 - 71
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - IoT
3. menuText: IoT
4. menuOrder: 7
5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)
11. <!-- DOCS-SITE-LINK:END -->
12. 
13. # IoT
14. 
15. ## Simple event definition
16. 
17. This will enable your Lambda function to be called by an AWS IoT rule.
18. 
19. ```yml
20. functions:
21.   myIoT:
22.     handler: myIoT.handler
23.     events:
24.       - iot:
25.           sql: "SELECT * FROM 'some_topic'"
26. ```
27. 
28. ## Enabling / Disabling
29. 
30. **Note:** `iot` events are enabled by default.
31. 
32. This will create and attach a disabled `iot` event for the `myIoT` function.
33. 
34. ```yml
35. functions:
36.   myIoT:
37.     handler: myIoT.handler
38.     events:
39.       - iot:
40.           sql: "SELECT * FROM 'some_topic'"
41.           enabled: false
42. ```
43. 
44. ## Specify Name and Description
45. 
46. Name and Description can be specified with the help of the `name` and `description` properties.
47. 
48. ```yml
49. functions:
50.   myIoT:
51.     handler: myIoT.handler
52.     events:
53.       - iot:
54.           name: "myIotEvent"
55.           sql: "SELECT * FROM 'some_topic'"
56.           description: "My IoT Event Description"
57. ```
58. 
59. ## Specify SQL Versions
60. 
61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.
62. 
63. ```yml
64. functions:
65.   myIoT:
66.     handler: myIoT.handler
67.     events:
68.       - iot:
69.           sql: "SELECT * FROM 'some_topic'"
70.           sqlVersion: "beta"
71. ```


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 4
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 15 - 39
Content:
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 48 - 53
Content:
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 54 - 75
Content:
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 76 - 95
Content:
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 97 - 106
Content:
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:34:55,315 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The provided context shows only fragments of the IoT compile plugin file, missing the class definition and the else branch logic, which are required for a complete understanding. The error originates in JSON parsing within this module, and it relies on provider.naming helpers whose implementations are not visible. Additionally, multi-line YAML handling likely stems from the YamlParser, which is relevant to the newline issue.' query='Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js, lib/plugins/aws/lib/naming.js, and lib/classes/YamlParser.js.' extra_requirements='If full files are too large, include at minimum: the import/require section, the class definition and complete compileIoTEvents method (including the else branch), naming functions used (getLambdaLogicalId, getIotLogicalId, getLambdaIotPermissionLogicalId), and the YamlParser logic affecting multi-line scalars.' purpose='This will allow me to fully trace how YAML multi-line values flow into the IoT CloudFormation template and where newline escaping must be handled, including logical ID resolution.'
2025-11-14 00:34:55,317 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js, lib/plugins/aws/lib/naming.js, and lib/classes/YamlParser.js.
2025-11-14 00:34:57,637 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: [{'query_essential_query': 'Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md', 'query_extra_requirements': 'If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.', 'query_purpose': 'This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.', 'memory_context_contexts': [{'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'content': "1. 'use strict';\n2. \n3. const _ = require('lodash');\n4. ", 'start_line_number': 1, 'end_line_number': 4}, {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'content': "15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === 'object') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {", 'start_line_number': 15, 'end_line_number': 39}, {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'content': '48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);', 'start_line_number': 48, 'end_line_number': 53}, {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'content': '54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. ', 'start_line_number': 54, 'end_line_number': 75}, {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'content': '76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;', 'start_line_number': 76, 'end_line_number': 95}, {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'content': '97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);', 'start_line_number': 97, 'end_line_number': 106}, {'relative_path': 'docs/providers/aws/events/iot.md', 'content': '1. <!--\n2. title: Serverless Framework - AWS Lambda Events - IoT\n3. menuText: IoT\n4. menuOrder: 7\n5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)\n11. <!-- DOCS-SITE-LINK:END -->\n12. \n13. # IoT\n14. \n15. ## Simple event definition\n16. \n17. This will enable your Lambda function to be called by an AWS IoT rule.\n18. \n19. ```yml\n20. functions:\n21.   myIoT:\n22.     handler: myIoT.handler\n23.     events:\n24.       - iot:\n25.           sql: "SELECT * FROM \'some_topic\'"\n26. ```\n27. \n28. ## Enabling / Disabling\n29. \n30. **Note:** `iot` events are enabled by default.\n31. \n32. This will create and attach a disabled `iot` event for the `myIoT` function.\n33. \n34. ```yml\n35. functions:\n36.   myIoT:\n37.     handler: myIoT.handler\n38.     events:\n39.       - iot:\n40.           sql: "SELECT * FROM \'some_topic\'"\n41.           enabled: false\n42. ```\n43. \n44. ## Specify Name and Description\n45. \n46. Name and Description can be specified with the help of the `name` and `description` properties.\n47. \n48. ```yml\n49. functions:\n50.   myIoT:\n51.     handler: myIoT.handler\n52.     events:\n53.       - iot:\n54.           name: "myIotEvent"\n55.           sql: "SELECT * FROM \'some_topic\'"\n56.           description: "My IoT Event Description"\n57. ```\n58. \n59. ## Specify SQL Versions\n60. \n61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.\n62. \n63. ```yml\n64. functions:\n65.   myIoT:\n66.     handler: myIoT.handler\n67.     events:\n68.       - iot:\n69.           sql: "SELECT * FROM \'some_topic\'"\n70.           sqlVersion: "beta"\n71. ```', 'start_line_number': 1, 'end_line_number': 71}]}]
2025-11-14 00:34:57,637 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 1 memories from memory
2025-11-14 00:34:57,637 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 7 contexts from memory
2025-11-14 00:34:57,638 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 7 contexts from memory
2025-11-14 00:34:57,639 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 7 new contexts to 7 existing contexts
2025-11-14 00:34:57,640 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 7 total contexts (removed 7 duplicates)
2025-11-14 00:34:57,641 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
Extra Requirements: If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.
Purpose: This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.

Previous refined query 2:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js, lib/plugins/aws/lib/naming.js, and lib/classes/YamlParser.js.
Extra Requirements: If full files are too large, include at minimum: the import/require section, the class definition and complete compileIoTEvents method (including the else branch), naming functions used (getLambdaLogicalId, getIotLogicalId, getLambdaIotPermissionLogicalId), and the YamlParser logic affecting multi-line scalars.
Purpose: This will allow me to fully trace how YAML multi-line values flow into the IoT CloudFormation template and where newline escaping must be handled, including logical ID resolution.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/iot.md
Line number range: 1 - 71
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - IoT
3. menuText: IoT
4. menuOrder: 7
5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)
11. <!-- DOCS-SITE-LINK:END -->
12. 
13. # IoT
14. 
15. ## Simple event definition
16. 
17. This will enable your Lambda function to be called by an AWS IoT rule.
18. 
19. ```yml
20. functions:
21.   myIoT:
22.     handler: myIoT.handler
23.     events:
24.       - iot:
25.           sql: "SELECT * FROM 'some_topic'"
26. ```
27. 
28. ## Enabling / Disabling
29. 
30. **Note:** `iot` events are enabled by default.
31. 
32. This will create and attach a disabled `iot` event for the `myIoT` function.
33. 
34. ```yml
35. functions:
36.   myIoT:
37.     handler: myIoT.handler
38.     events:
39.       - iot:
40.           sql: "SELECT * FROM 'some_topic'"
41.           enabled: false
42. ```
43. 
44. ## Specify Name and Description
45. 
46. Name and Description can be specified with the help of the `name` and `description` properties.
47. 
48. ```yml
49. functions:
50.   myIoT:
51.     handler: myIoT.handler
52.     events:
53.       - iot:
54.           name: "myIotEvent"
55.           sql: "SELECT * FROM 'some_topic'"
56.           description: "My IoT Event Description"
57. ```
58. 
59. ## Specify SQL Versions
60. 
61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.
62. 
63. ```yml
64. functions:
65.   myIoT:
66.     handler: myIoT.handler
67.     events:
68.       - iot:
69.           sql: "SELECT * FROM 'some_topic'"
70.           sqlVersion: "beta"
71. ```


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 4
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 15 - 39
Content:
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 48 - 53
Content:
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 54 - 75
Content:
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 76 - 95
Content:
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 97 - 106
Content:
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:35:20,401 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The IoT event compiler file is only partially visible, and the error stems from constructing and JSON-parsing a template string that includes multi-line YAML values. To fully understand and fix the issue, I need the complete IoT plugin implementation and the YAML parsing logic, since multi-line scalars (>) may preserve trailing newlines. Naming-related code is not essential for the newline bug itself.' query='Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js (including header, class/constructor, and lifecycle hook registrations) and lib/classes/YamlParser.js.' extra_requirements='If full files are too large, include at minimum: where event.iot.description and event.iot.sql are read/normalized, any string escaping, module exports, and the js-yaml parsing details for multi-line scalars.' purpose='This will confirm how multi-line YAML values are parsed and injected into the IoT CloudFormation template so we can adjust template construction or escaping to prevent JSON.parse errors.'
2025-11-14 00:35:20,403 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js (including header, class/constructor, and lifecycle hook registrations) and lib/classes/YamlParser.js.
2025-11-14 00:35:20,711 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-14 00:35:20,711 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-14 00:35:20,711 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-14 00:35:20,711 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-14 00:35:20,713 - thread-135845308794560.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-14 00:35:20,714 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-14 00:35:20,714 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js (including header, class/constructor, and lifecycle hook registrations) and lib/classes/YamlParser.js.
Extra requirements: If full files are too large, include at minimum: where event.iot.description and event.iot.sql are read/normalized, any string escaping, module exports, and the js-yaml parsing details for multi-line scalars.
Purpose: This will confirm how multi-line YAML values are parsed and injected into the IoT CloudFormation template so we can adjust template construction or escaping to prevent JSON.parse errors.
2025-11-14 00:35:24,418 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XIEWzP4cYasT44kafmlbdC4T', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 297, 'prompt_tokens': 2213, 'total_tokens': 2510, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c1408e49-06cb-4b1f-a892-c6a0b3c71f47-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_XIEWzP4cYasT44kafmlbdC4T', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2213, 'output_tokens': 297, 'total_tokens': 2510, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-14 00:35:26,115 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_TON6tslJjX7APK1C4LD6HjUd', 'function': {'arguments': '{"relative_path":"lib/classes/YamlParser.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 3478, 'total_tokens': 3513, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c3b98960-3f8b-4ac3-a294-3c66b06a2a0d-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/classes/YamlParser.js'}, 'id': 'call_TON6tslJjX7APK1C4LD6HjUd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3478, 'output_tokens': 35, 'total_tokens': 3513, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:35:39,736 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Uli3VIqJWOU7rAMG09nByjqv', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js","start_line":1,"end_line":1000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1266, 'prompt_tokens': 3870, 'total_tokens': 5136, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1216, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--39ef67a0-7119-4906-9152-f29fa411e4f1-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'start_line': 1, 'end_line': 1000}, 'id': 'call_Uli3VIqJWOU7rAMG09nByjqv', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3870, 'output_tokens': 1266, 'total_tokens': 5136, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1216}}
2025-11-14 00:35:51,136 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I retrieved the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and lib/classes/YamlParser.js. The IoT compiler reads event.iot.description and event.iot.sql directly from the event object and interpolates them into a JSON template string without any escaping, then JSON.parse is called on that string; multi-line or quoted values can therefore break parsing. The YAML parser uses js-yaml’s YAML.load via json-refs resolveRefs, so multi-line YAML scalars become plain JavaScript strings with literal newline characters. This confirms that multi-line SQL/description from YAML are injected as-is into the CloudFormation JSON string, which can cause JSON.parse errors unless escaping or a non-stringified object construction approach is used.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1310, 'prompt_tokens': 5144, 'total_tokens': 6454, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--bb27c9cb-f7ba-4887-8ed5-f311d1eadd15-0' usage_metadata={'input_tokens': 5144, 'output_tokens': 1310, 'total_tokens': 6454, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-14 00:35:51,139 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js (including header, class/constructor, and lifecycle hook registrations) and lib/classes/YamlParser.js.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If full files are too large, include at minimum: where event.iot.description and event.iot.sql are read/normalized, any string escaping, module exports, and the js-yaml parsing details for multi-line scalars.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
This will confirm how multi-line YAML values are parsed and injected into the IoT CloudFormation template so we can adjust template construction or escaping to prevent JSON.parse errors.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/classes/YamlParser.js
Line number range: 1 - 32
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const YAML = require('js-yaml');
5. const resolve = require('json-refs').resolveRefs;
6. 
7. class YamlParser {
8. 
9.   constructor(serverless) {
10.     this.serverless = serverless;
11.   }
12. 
13.   parse(yamlFilePath) {
14.     let parentDir = yamlFilePath.split(path.sep);
15.     parentDir.pop();
16.     parentDir = parentDir.join('/');
17.     process.chdir(parentDir);
18. 
19.     const root = this.serverless.utils.readFileSync(yamlFilePath);
20.     const options = {
21.       filter: ['relative', 'remote'],
22.       loaderOptions: {
23.         processContent: (res, callback) => {
24.           callback(null, YAML.load(res.text));
25.         },
26.       },
27.     };
28.     return resolve(root, options).then((res) => (res.resolved));
29.   }
30. }
31. 
32. module.exports = YamlParser;

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-14 00:36:16,726 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="1. Query requirement analysis:\n   - The request asks for js-yaml parsing details for multi-line scalars and module exports for YamlParser.\n   - This parse() implementation shows how YAML content is read and parsed using js-yaml's YAML.load, which is the critical detail for multi-line scalar handling.\n2. Extended relevance:\n   - Includes readFileSync of the YAML file, process.chdir for relative resolution, and json-refs resolveRefs with loaderOptions.processContent using YAML.load. These are essential to understand how YAML content (including multi-line strings) is turned into JS objects before further template injection.", relative_path='lib/classes/YamlParser.js', start_line=13, end_line=29), ContextOutput(reasoning='1. Query requirement analysis:\n   - Identifies the specific YAML parsing library used (js-yaml), which is directly requested for understanding parsing behavior, including multi-line scalars.\n2. Extended relevance:\n   - Knowing the exact import clarifies that YAML.load from js-yaml is the parser employed.', relative_path='lib/classes/YamlParser.js', start_line=4, end_line=4), ContextOutput(reasoning='1. Query requirement analysis:\n   - The request asks to include module exports for YamlParser.\n2. Extended relevance:\n   - Shows exactly how the class is exported, which may be needed to trace how the parser is instantiated and used elsewhere.', relative_path='lib/classes/YamlParser.js', start_line=31, end_line=32)]
2025-11-14 00:36:16,729 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js (including header, class/constructor, and lifecycle hook registrations) and lib/classes/YamlParser.js.
2025-11-14 00:36:19,248 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-14 00:36:19,249 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 7 existing contexts
2025-11-14 00:36:19,250 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 10 total contexts (removed 0 duplicates)
2025-11-14 00:36:19,251 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
Extra Requirements: If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.
Purpose: This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.

Previous refined query 2:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js, lib/plugins/aws/lib/naming.js, and lib/classes/YamlParser.js.
Extra Requirements: If full files are too large, include at minimum: the import/require section, the class definition and complete compileIoTEvents method (including the else branch), naming functions used (getLambdaLogicalId, getIotLogicalId, getLambdaIotPermissionLogicalId), and the YamlParser logic affecting multi-line scalars.
Purpose: This will allow me to fully trace how YAML multi-line values flow into the IoT CloudFormation template and where newline escaping must be handled, including logical ID resolution.

Previous refined query 3:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js (including header, class/constructor, and lifecycle hook registrations) and lib/classes/YamlParser.js.
Extra Requirements: If full files are too large, include at minimum: where event.iot.description and event.iot.sql are read/normalized, any string escaping, module exports, and the js-yaml parsing details for multi-line scalars.
Purpose: This will confirm how multi-line YAML values are parsed and injected into the IoT CloudFormation template so we can adjust template construction or escaping to prevent JSON.parse errors.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/iot.md
Line number range: 1 - 71
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - IoT
3. menuText: IoT
4. menuOrder: 7
5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)
11. <!-- DOCS-SITE-LINK:END -->
12. 
13. # IoT
14. 
15. ## Simple event definition
16. 
17. This will enable your Lambda function to be called by an AWS IoT rule.
18. 
19. ```yml
20. functions:
21.   myIoT:
22.     handler: myIoT.handler
23.     events:
24.       - iot:
25.           sql: "SELECT * FROM 'some_topic'"
26. ```
27. 
28. ## Enabling / Disabling
29. 
30. **Note:** `iot` events are enabled by default.
31. 
32. This will create and attach a disabled `iot` event for the `myIoT` function.
33. 
34. ```yml
35. functions:
36.   myIoT:
37.     handler: myIoT.handler
38.     events:
39.       - iot:
40.           sql: "SELECT * FROM 'some_topic'"
41.           enabled: false
42. ```
43. 
44. ## Specify Name and Description
45. 
46. Name and Description can be specified with the help of the `name` and `description` properties.
47. 
48. ```yml
49. functions:
50.   myIoT:
51.     handler: myIoT.handler
52.     events:
53.       - iot:
54.           name: "myIotEvent"
55.           sql: "SELECT * FROM 'some_topic'"
56.           description: "My IoT Event Description"
57. ```
58. 
59. ## Specify SQL Versions
60. 
61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.
62. 
63. ```yml
64. functions:
65.   myIoT:
66.     handler: myIoT.handler
67.     events:
68.       - iot:
69.           sql: "SELECT * FROM 'some_topic'"
70.           sqlVersion: "beta"
71. ```


File: lib/classes/YamlParser.js
Line number range: 4 - 4
Content:
4. const YAML = require('js-yaml');


File: lib/classes/YamlParser.js
Line number range: 13 - 29
Content:
13.   parse(yamlFilePath) {
14.     let parentDir = yamlFilePath.split(path.sep);
15.     parentDir.pop();
16.     parentDir = parentDir.join('/');
17.     process.chdir(parentDir);
18. 
19.     const root = this.serverless.utils.readFileSync(yamlFilePath);
20.     const options = {
21.       filter: ['relative', 'remote'],
22.       loaderOptions: {
23.         processContent: (res, callback) => {
24.           callback(null, YAML.load(res.text));
25.         },
26.       },
27.     };
28.     return resolve(root, options).then((res) => (res.resolved));
29.   }


File: lib/classes/YamlParser.js
Line number range: 31 - 32
Content:
31. 
32. module.exports = YamlParser;


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 4
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 15 - 39
Content:
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 48 - 53
Content:
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 54 - 75
Content:
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 76 - 95
Content:
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 97 - 106
Content:
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:36:48,549 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We have the core parts of iot/index.js showing where Description and Sql are interpolated into a JSON string and parsed, which explains the newline issue. However, the file content is incomplete: we’re missing the plugin class definition (constructor and hook registrations), the else branch handling for non-object event.iot definitions, and the module export. These are needed to satisfy the request to include complete implementations and class definitions and to ensure we understand the full lifecycle context for applying a fix. The YamlParser details provided are sufficient for understanding YAML parsing and are not critical to this specific bug fix.' query='Please provide the remaining sections of lib/plugins/aws/deploy/compile/events/iot/index.js that include the plugin class definition (constructor and hook registrations), the else branch logic for non-object iot events, and the module export.' extra_requirements='If sending the full file is too large, include at minimum the else branch in compileIoTEvents and the constructor showing how compileIoTEvents is registered.' purpose='This will let me trace the full compile lifecycle for IoT events and confirm where to implement escaping or object-based template construction to fix the JSON parsing error.'
2025-11-14 00:36:48,551 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the remaining sections of lib/plugins/aws/deploy/compile/events/iot/index.js that include the plugin class definition (constructor and hook registrations), the else branch logic for non-object iot events, and the module export.
2025-11-14 00:36:50,592 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-14 00:36:50,593 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-14 00:36:50,593 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-14 00:36:50,593 - thread-135845308794560.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-14 00:36:50,595 - thread-135845308794560.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-14 00:36:50,596 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-14 00:36:50,596 - thread-135845308794560.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the remaining sections of lib/plugins/aws/deploy/compile/events/iot/index.js that include the plugin class definition (constructor and hook registrations), the else branch logic for non-object iot events, and the module export.
Extra requirements: If sending the full file is too large, include at minimum the else branch in compileIoTEvents and the constructor showing how compileIoTEvents is registered.
Purpose: This will let me trace the full compile lifecycle for IoT events and confirm where to implement escaping or object-based template construction to fix the JSON parsing error.
2025-11-14 00:36:53,257 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7ki8Zq1HOS0lrrYgQfm55uZJ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 233, 'prompt_tokens': 2206, 'total_tokens': 2439, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--48cbc1cd-285a-4b99-a279-cb21b0769307-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_7ki8Zq1HOS0lrrYgQfm55uZJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2206, 'output_tokens': 233, 'total_tokens': 2439, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-14 00:37:00,277 - thread-135845308794560.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content="I opened lib/plugins/aws/deploy/compile/events/iot/index.js and retrieved the full file. It defines class AwsCompileIoTEvents whose constructor sets this.hooks = { 'deploy:compileEvents': this.compileIoTEvents.bind(this) }. In compileIoTEvents, the else branch for non-object iot events builds an error message and throws new this.serverless.classes.Error(errorMessage). The file ends with module.exports = AwsCompileIoTEvents, and you can see where the IoT and permission templates are JSON-parsed and merged, which is the spot to implement escaping or shift to object-based construction." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 648, 'prompt_tokens': 3471, 'total_tokens': 4119, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--a961a316-f6cf-4c40-8605-798d0a8f696d-0' usage_metadata={'input_tokens': 3471, 'output_tokens': 648, 'total_tokens': 4119, 'input_token_details': {'audio': 0, 'cache_read': 2048}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-14 00:37:00,281 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the remaining sections of lib/plugins/aws/deploy/compile/events/iot/index.js that include the plugin class definition (constructor and hook registrations), the else branch logic for non-object iot events, and the module export.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If sending the full file is too large, include at minimum the else branch in compileIoTEvents and the constructor showing how compileIoTEvents is registered.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
This will let me trace the full compile lifecycle for IoT events and confirm where to implement escaping or object-based template construction to fix the JSON parsing error.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 113
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }
14. 
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }
47. 
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;
96. 
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);
107.           }
108.         });
109.       }
110.     });
111.   }
112. }
113. module.exports = AwsCompileIoTEvents;

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-14 00:37:15,441 - thread-135845308794560.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='Includes the plugin class definition with constructor setting serverless/provider and registering the deploy:compileEvents hook to compileIoTEvents, which is required to trace how compileIoTEvents is invoked.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=5, end_line=13), ContextOutput(reasoning='Captures the else branch logic in compileIoTEvents for when event.iot is not an object, including construction of the error message and throwing Serverless Error. This directly answers the request for the non-object iot events handling.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=39, end_line=46), ContextOutput(reasoning='Provides the module export of the AwsCompileIoTEvents class, as requested.', relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', start_line=112, end_line=113)]
2025-11-14 00:37:15,443 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the remaining sections of lib/plugins/aws/deploy/compile/events/iot/index.js that include the plugin class definition (constructor and hook registrations), the else branch logic for non-object iot events, and the module export.
2025-11-14 00:37:16,194 - thread-135845308794560.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-14 00:37:16,196 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 10 existing contexts
2025-11-14 00:37:16,196 - thread-135845308794560.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 13 total contexts (removed 0 duplicates)
2025-11-14 00:37:16,198 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .eslintrc.js
├── .github
|   ├── ISSUE_TEMPLATE.md
|   └── PULL_REQUEST_TEMPLATE.md
├── .travis.yml
├── 0.5.x-RESOURCES.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── LICENSE.txt
├── README.md
├── RELEASE_CHECKLIST.md
├── bin
├── code_of_conduct.md
├── docker-compose.yml
├── docs
|   ├── README.md
|   └── providers
|       ├── README.md
|       └── aws
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── config-credentials.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke-local.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   ├── rollback.md
|           |   └── slstats.md
|           ├── events
|           |   ├── README.md
|           |   ├── alexa-skill.md
|           |   ├── apigateway.md
|           |   ├── iot.md
|           |   ├── s3.md
|           |   ├── schedule.md
|           |   ├── sns.md
|           |   └── streams.md
|           ├── examples
|           |   ├── README.md
|           |   └── hello-world
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── iam.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── resources.md
|               ├── serverless.yml.md
|               ├── services.md
|               ├── testing.md
|               ├── v0_to_v1.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── Error.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   └── plugins
|       ├── aws
|       |   ├── configCredentials
|       |   |   ├── awsConfigCredentials.js
|       |   |   └── awsConfigCredentials.test.js
|       |   ├── deploy
|       |   |   ├── compile
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── deployFunction
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── deployList
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── info
|       |   |   ├── display.js
|       |   |   ├── display.test.js
|       |   |   ├── getApiKeyValues.js
|       |   |   ├── getApiKeyValues.test.js
|       |   |   ├── getStackInfo.js
|       |   |   ├── getStackInfo.test.js
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invoke
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── invokeLocal
|       |   |   ├── fixture
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── lib
|       |   |   ├── monitorStack.js
|       |   |   ├── monitorStack.test.js
|       |   |   ├── naming.js
|       |   |   ├── naming.test.js
|       |   |   ├── setBucketName.js
|       |   |   ├── setBucketName.test.js
|       |   |   ├── updateStack.js
|       |   |   ├── updateStack.test.js
|       |   |   ├── validate.js
|       |   |   └── validate.test.js
|       |   ├── logs
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   ├── metrics
|       |   |   ├── awsMetrics.js
|       |   |   └── awsMetrics.test.js
|       |   ├── provider
|       |   |   ├── awsProvider.js
|       |   |   └── awsProvider.test.js
|       |   ├── remove
|       |   |   ├── index.js
|       |   |   ├── index.test.js
|       |   |   └── lib
|       |   ├── rollback
|       |   |   ├── index.js
|       |   |   └── index.test.js
|       |   └── utils
|       |       ├── findAndGroupDeployments.js
|       |       ├── findAndGroupDeployments.test.js
|       |       ├── getS3ObjectsFromStacks.js
|       |       └── getS3ObjectsFromStacks.test.js
|       ├── config
|       |   ├── config.js
|       |   └── config.test.js
|       ├── create
|       |   ├── create.js
|       |   ├── create.test.js
|       |   └── templates
|       |       ├── aws-csharp
|       |       ├── aws-java-gradle
|       |       ├── aws-java-maven
|       |       ├── aws-nodejs
|       |       ├── aws-python
|       |       ├── aws-scala-sbt
|       |       └── plugin
|       ├── deploy
|       |   ├── deploy.js
|       |   └── deploy.test.js
|       ├── info
|       |   ├── info.js
|       |   └── info.test.js
|       ├── install
|       |   ├── install.js
|       |   └── install.test.js
|       ├── invoke
|       |   ├── invoke.js
|       |   └── invoke.test.js
|       ├── logs
|       |   ├── logs.js
|       |   └── logs.test.js
|       ├── metrics
|       |   ├── metrics.js
|       |   └── metrics.test.js
|       ├── package
|       |   ├── index.js
|       |   ├── index.test.js
|       |   └── lib
|       |       ├── cleanup.js
|       |       ├── cleanup.test.js
|       |       ├── packageService.js
|       |       ├── packageService.test.js
|       |       ├── validate.js
|       |       ├── validate.test.js
|       |       ├── zipService.js
|       |       └── zipService.test.js
|       ├── remove
|       |   ├── remove.js
|       |   └── remove.test.js
|       ├── rollback
|       |   ├── index.js
|       |   └── index.test.js
|       └── slstats
|           ├── slstats.js
|           └── slstats.test.js
├── scripts
|   ├── generate-readme.js
|   ├── integration-test-cleanup.js
|   ├── postinstall.js
|   └── preuninstall.js
└── tests
    ├── integration
    |   ├── aws
    |   |   ├── api-gateway
    |   |   |   ├── integration-lambda
    |   |   |   └── integration-lambda-proxy
    |   |   ├── general
    |   |   |   ├── custom-resources
    |   |   |   ├── environment-variables
    |   |   |   ├── nested-handlers
    |   |   |   ├── overwrite-resources
    |   |   |   └── package
    |   |   ├── s3
    |   |   |   ├── multiple-events-multiple-functions-multiple-buckets
    |   |   |   ├── multiple-events-multiple-functions-single-bucket
    |   |   |   ├── multiple-events-single-function-single-bucket
    |   |   |   └── single-event-single-function-single-bucket
    |   |   ├── schedule
    |   |   |   └── multiple-schedules-multiple-functions
    |   |   └── sns
    |   |       ├── multiple-topics-multiple-functions
    |   |       ├── multiple-topics-single-function
    |   |       ├── single-topic-multiple-functions
    |   |       └── single-topic-single-function
    |   └── general
    |       ├── custom-plugins
    |       |   ├── service
    |       |   └── tests.js
    |       └── local-plugins
    |           ├── service
    |           └── tests.js
    ├── setupTests.js
    ├── simple-suite
    |   └── tests.js
    ├── templates
    └── utils
        ├── index.js
        └── index.test.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Multi-line values in IoT event

Issue description: 
<!--
1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com
2. Please check if an issue already exists so there are no duplicates
3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md
4. Fill out the whole template so we have a good overview on the issue
5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue
6. Please follow the template, otherwise we'll have to ask you to update it
-->

# This is a Bug Report

Using multi-line values (with yaml >) in an IoT definition results in an 'unexpected token' error.

For bug reports:
* What went wrong?  The following yaml:
```
events:
      - iot:
          description: >
            My multi-
            line value.
          name: enrollPlayer
          sql: >
            SELECT * FROM 'path/#'
            WHERE prop = 'value'
```
complain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:
```
           "Description": "My multi- line value.
            ",
            "RuleDisabled": "false",
            "Sql": "SELECT * FROM 'path/#' WHERE prop = 'value'
            ",
```
* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.
* What was the config you used?
* What stacktrace or error message from your provider did you see?

Similar or dependent issues:
*

* ***Serverless Framework Version you're using***: 1.5.0
* ***Operating System***: OS X 10.12
* ***Stack Trace***:
SyntaxError: Unexpected token 

    at Object.parse (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36
    at Array.forEach (native)
    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28
    at Array.forEach (native)
    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)
    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50
    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)
    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)
    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)
    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)
    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)
    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)
    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)
    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)
* ***Provider Error messages***:
  Syntax Error -------------------------------------------
 
     Unexpected token 


Issue comments:


Find all relevant source code context and documentation needed to understand and fix this issue.
Focus on production code (ignore test files) and follow these steps:
1. Identify key components mentioned in the issue, especially from the error message(functions, classes, types, etc.)
2. Find their complete implementations and class definitions
3. Include related code from the same module that affects the behavior
4. Follow imports to find dependent code that directly impacts the issue

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js and docs/providers/aws/events/iot.md
Extra Requirements: If the full file is large, include at minimum: all import/require statements, the definitions and usage of iotTemplate, and the functions where JSON.parse or template construction occurs.
Purpose: This will allow me to trace how multi-line YAML values are transformed into the IoT template and identify where newline escaping should be handled.

Previous refined query 2:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js, lib/plugins/aws/lib/naming.js, and lib/classes/YamlParser.js.
Extra Requirements: If full files are too large, include at minimum: the import/require section, the class definition and complete compileIoTEvents method (including the else branch), naming functions used (getLambdaLogicalId, getIotLogicalId, getLambdaIotPermissionLogicalId), and the YamlParser logic affecting multi-line scalars.
Purpose: This will allow me to fully trace how YAML multi-line values flow into the IoT CloudFormation template and where newline escaping must be handled, including logical ID resolution.

Previous refined query 3:
Essential Query: Please provide the full content of lib/plugins/aws/deploy/compile/events/iot/index.js (including header, class/constructor, and lifecycle hook registrations) and lib/classes/YamlParser.js.
Extra Requirements: If full files are too large, include at minimum: where event.iot.description and event.iot.sql are read/normalized, any string escaping, module exports, and the js-yaml parsing details for multi-line scalars.
Purpose: This will confirm how multi-line YAML values are parsed and injected into the IoT CloudFormation template so we can adjust template construction or escaping to prevent JSON.parse errors.

Previous refined query 4:
Essential Query: Please provide the remaining sections of lib/plugins/aws/deploy/compile/events/iot/index.js that include the plugin class definition (constructor and hook registrations), the else branch logic for non-object iot events, and the module export.
Extra Requirements: If sending the full file is too large, include at minimum the else branch in compileIoTEvents and the constructor showing how compileIoTEvents is registered.
Purpose: This will let me trace the full compile lifecycle for IoT events and confirm where to implement escaping or object-based template construction to fix the JSON parsing error.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/iot.md
Line number range: 1 - 71
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - IoT
3. menuText: IoT
4. menuOrder: 7
5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)
11. <!-- DOCS-SITE-LINK:END -->
12. 
13. # IoT
14. 
15. ## Simple event definition
16. 
17. This will enable your Lambda function to be called by an AWS IoT rule.
18. 
19. ```yml
20. functions:
21.   myIoT:
22.     handler: myIoT.handler
23.     events:
24.       - iot:
25.           sql: "SELECT * FROM 'some_topic'"
26. ```
27. 
28. ## Enabling / Disabling
29. 
30. **Note:** `iot` events are enabled by default.
31. 
32. This will create and attach a disabled `iot` event for the `myIoT` function.
33. 
34. ```yml
35. functions:
36.   myIoT:
37.     handler: myIoT.handler
38.     events:
39.       - iot:
40.           sql: "SELECT * FROM 'some_topic'"
41.           enabled: false
42. ```
43. 
44. ## Specify Name and Description
45. 
46. Name and Description can be specified with the help of the `name` and `description` properties.
47. 
48. ```yml
49. functions:
50.   myIoT:
51.     handler: myIoT.handler
52.     events:
53.       - iot:
54.           name: "myIotEvent"
55.           sql: "SELECT * FROM 'some_topic'"
56.           description: "My IoT Event Description"
57. ```
58. 
59. ## Specify SQL Versions
60. 
61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.
62. 
63. ```yml
64. functions:
65.   myIoT:
66.     handler: myIoT.handler
67.     events:
68.       - iot:
69.           sql: "SELECT * FROM 'some_topic'"
70.           sqlVersion: "beta"
71. ```


File: lib/classes/YamlParser.js
Line number range: 4 - 4
Content:
4. const YAML = require('js-yaml');


File: lib/classes/YamlParser.js
Line number range: 13 - 29
Content:
13.   parse(yamlFilePath) {
14.     let parentDir = yamlFilePath.split(path.sep);
15.     parentDir.pop();
16.     parentDir = parentDir.join('/');
17.     process.chdir(parentDir);
18. 
19.     const root = this.serverless.utils.readFileSync(yamlFilePath);
20.     const options = {
21.       filter: ['relative', 'remote'],
22.       loaderOptions: {
23.         processContent: (res, callback) => {
24.           callback(null, YAML.load(res.text));
25.         },
26.       },
27.     };
28.     return resolve(root, options).then((res) => (res.resolved));
29.   }


File: lib/classes/YamlParser.js
Line number range: 31 - 32
Content:
31. 
32. module.exports = YamlParser;


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 1 - 4
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 5 - 13
Content:
5. class AwsCompileIoTEvents {
6.   constructor(serverless) {
7.     this.serverless = serverless;
8.     this.provider = this.serverless.getProvider('aws');
9. 
10.     this.hooks = {
11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),
12.     };
13.   }


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 15 - 39
Content:
15.   compileIoTEvents() {
16.     this.serverless.service.getAllFunctions().forEach((functionName) => {
17.       const functionObj = this.serverless.service.getFunction(functionName);
18.       let iotNumberInFunction = 0;
19. 
20.       if (functionObj.events) {
21.         functionObj.events.forEach(event => {
22.           if (event.iot) {
23.             iotNumberInFunction++;
24.             let RuleName;
25.             let AwsIotSqlVersion;
26.             let Description;
27.             let RuleDisabled;
28.             let Sql;
29. 
30.             if (typeof event.iot === 'object') {
31.               RuleName = event.iot.name;
32.               AwsIotSqlVersion = event.iot.sqlVersion;
33.               Description = event.iot.description;
34.               RuleDisabled = false;
35.               if (event.iot.enabled === false) {
36.                 RuleDisabled = true;
37.               }
38.               Sql = event.iot.sql;
39.             } else {


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 39 - 46
Content:
39.             } else {
40.               const errorMessage = [
41.                 `IoT event of function "${functionName}" is not an object`,
42.                 ' Please check the docs for more info.',
43.               ].join('');
44.               throw new this.serverless.classes
45.                 .Error(errorMessage);
46.             }


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 48 - 53
Content:
48.             const lambdaLogicalId = this.provider.naming
49.               .getLambdaLogicalId(functionName);
50.             const iotLogicalId = this.provider.naming
51.               .getIotLogicalId(functionName, iotNumberInFunction);
52.             const lambdaPermissionLogicalId = this.provider.naming
53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 54 - 75
Content:
54.             const iotTemplate = `
55.               {
56.                 "Type": "AWS::IoT::TopicRule",
57.                 "Properties": {
58.                   ${RuleName ? `"RuleName": "${RuleName}",` : ''}
59.                   "TopicRulePayload": {
60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
61.                     ${Description ? `"Description": "${Description}",` : ''}
62.                     "RuleDisabled": "${RuleDisabled}",
63.                     "Sql": "${Sql}",
64.                     "Actions": [
65.                       {
66.                         "Lambda": {
67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
68.                         }
69.                       }
70.                     ]
71.                   }
72.                 }
73.               }
74.             `;
75. 


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 76 - 95
Content:
76.             const permissionTemplate = `
77.               {
78.                 "Type": "AWS::Lambda::Permission",
79.                 "Properties": {
80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
81.                   "Action": "lambda:InvokeFunction",
82.                   "Principal": "iot.amazonaws.com",
83.                   "SourceArn": { "Fn::Join": ["",
84.                     [
85.                       "arn:aws:iot:",
86.                       { "Ref": "AWS::Region" },
87.                       ":",
88.                       { "Ref": "AWS::AccountId" },
89.                       ":rule/",
90.                       { "Ref": "${iotLogicalId}"}
91.                     ]
92.                   ] }
93.                 }
94.               }
95.             `;


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 97 - 106
Content:
97.             const newIotObject = {
98.               [iotLogicalId]: JSON.parse(iotTemplate),
99.             };
100. 
101.             const newPermissionObject = {
102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
103.             };
104. 
105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,
106.               newIotObject, newPermissionObject);


File: lib/plugins/aws/deploy/compile/events/iot/index.js
Line number range: 112 - 113
Content:
112. }
113. module.exports = AwsCompileIoTEvents;

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-14 00:37:34,927 - thread-135845308794560.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The provided context includes the complete implementation of lib/plugins/aws/deploy/compile/events/iot/index.js, which constructs JSON strings with interpolated values and then parses them, and the relevant YAML parsing behavior via lib/classes/YamlParser.js (showing js-yaml usage). The IoT event documentation is also present. These are the critical components to understand why multi-line YAML scalars with trailing newlines cause JSON.parse errors. Naming helpers and other modules do not impact newline escaping. Therefore, no additional context is needed.' query='' extra_requirements='' purpose=''
2025-11-14 00:37:34,929 - thread-135845308794560.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/events/iot.md', content='1. <!--\n2. title: Serverless Framework - AWS Lambda Events - IoT\n3. menuText: IoT\n4. menuOrder: 7\n5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)\n11. <!-- DOCS-SITE-LINK:END -->\n12. \n13. # IoT\n14. \n15. ## Simple event definition\n16. \n17. This will enable your Lambda function to be called by an AWS IoT rule.\n18. \n19. ```yml\n20. functions:\n21.   myIoT:\n22.     handler: myIoT.handler\n23.     events:\n24.       - iot:\n25.           sql: "SELECT * FROM \'some_topic\'"\n26. ```\n27. \n28. ## Enabling / Disabling\n29. \n30. **Note:** `iot` events are enabled by default.\n31. \n32. This will create and attach a disabled `iot` event for the `myIoT` function.\n33. \n34. ```yml\n35. functions:\n36.   myIoT:\n37.     handler: myIoT.handler\n38.     events:\n39.       - iot:\n40.           sql: "SELECT * FROM \'some_topic\'"\n41.           enabled: false\n42. ```\n43. \n44. ## Specify Name and Description\n45. \n46. Name and Description can be specified with the help of the `name` and `description` properties.\n47. \n48. ```yml\n49. functions:\n50.   myIoT:\n51.     handler: myIoT.handler\n52.     events:\n53.       - iot:\n54.           name: "myIotEvent"\n55.           sql: "SELECT * FROM \'some_topic\'"\n56.           description: "My IoT Event Description"\n57. ```\n58. \n59. ## Specify SQL Versions\n60. \n61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.\n62. \n63. ```yml\n64. functions:\n65.   myIoT:\n66.     handler: myIoT.handler\n67.     events:\n68.       - iot:\n69.           sql: "SELECT * FROM \'some_topic\'"\n70.           sqlVersion: "beta"\n71. ```', start_line_number=1, end_line_number=71), Context(relative_path='lib/classes/YamlParser.js', content="4. const YAML = require('js-yaml');", start_line_number=4, end_line_number=4), Context(relative_path='lib/classes/YamlParser.js', content="13.   parse(yamlFilePath) {\n14.     let parentDir = yamlFilePath.split(path.sep);\n15.     parentDir.pop();\n16.     parentDir = parentDir.join('/');\n17.     process.chdir(parentDir);\n18. \n19.     const root = this.serverless.utils.readFileSync(yamlFilePath);\n20.     const options = {\n21.       filter: ['relative', 'remote'],\n22.       loaderOptions: {\n23.         processContent: (res, callback) => {\n24.           callback(null, YAML.load(res.text));\n25.         },\n26.       },\n27.     };\n28.     return resolve(root, options).then((res) => (res.resolved));\n29.   }", start_line_number=13, end_line_number=29), Context(relative_path='lib/classes/YamlParser.js', content='31. \n32. module.exports = YamlParser;', start_line_number=31, end_line_number=32), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content="1. 'use strict';\n2. \n3. const _ = require('lodash');\n4. ", start_line_number=1, end_line_number=4), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content="5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider('aws');\n9. \n10.     this.hooks = {\n11.       'deploy:compileEvents': this.compileIoTEvents.bind(this),\n12.     };\n13.   }", start_line_number=5, end_line_number=13), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content="15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === 'object') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {", start_line_number=15, end_line_number=39), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }', start_line_number=39, end_line_number=46), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);', start_line_number=48, end_line_number=53), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. ', start_line_number=54, end_line_number=75), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;', start_line_number=76, end_line_number=95), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);', start_line_number=97, end_line_number=106), Context(relative_path='lib/plugins/aws/deploy/compile/events/iot/index.js', content='112. }\n113. module.exports = AwsCompileIoTEvents;', start_line_number=112, end_line_number=113)]
2025-11-14 00:37:34,931 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_analyzer_message_node - DEBUG - Sending message to IssueBugAnalyzerNode:
content='I am going to share details about an issue reported to a codebase and its related bug context.\nPlease analyze this bug and provide a high-level description of what needs to be changed:\n\n1. Issue Understanding:\n- Analyze the issue title, description, and comments provided\n- Identify the reported symptoms and unexpected behaviors\n\n2. Code Analysis:\n- Identify which files, functions, or code blocks are involved\n- Explain what the problematic code is currently doing\n\n3. Root Cause:\n- Explain why the current behavior is incorrect\n- Identify which specific parts of the code are causing the issue\n\n4. Fix Suggestion:\nFor each needed change, describe in plain English:\n- Which file needs to be modified\n- Which function or code block needs changes\n- What needs to be changed (e.g., "rename variable x to y", "add null check for parameter z")\n- Why this change would fix the issue\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be changed.\n\nHere are the details for analysis:\n\nIssue title:\nMulti-line values in IoT event\n\nIssue description: \n<!--\n1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com\n2. Please check if an issue already exists so there are no duplicates\n3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md\n4. Fill out the whole template so we have a good overview on the issue\n5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue\n6. Please follow the template, otherwise we\'ll have to ask you to update it\n-->\n\n# This is a Bug Report\n\nUsing multi-line values (with yaml >) in an IoT definition results in an \'unexpected token\' error.\n\nFor bug reports:\n* What went wrong?  The following yaml:\n```\nevents:\n      - iot:\n          description: >\n            My multi-\n            line value.\n          name: enrollPlayer\n          sql: >\n            SELECT * FROM \'path/#\'\n            WHERE prop = \'value\'\n```\ncomplain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:\n```\n           "Description": "My multi- line value.\n            ",\n            "RuleDisabled": "false",\n            "Sql": "SELECT * FROM \'path/#\' WHERE prop = \'value\'\n            ",\n```\n* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.\n* What was the config you used?\n* What stacktrace or error message from your provider did you see?\n\nSimilar or dependent issues:\n*\n\n* ***Serverless Framework Version you\'re using***: 1.5.0\n* ***Operating System***: OS X 10.12\n* ***Stack Trace***:\nSyntaxError: Unexpected token \n\n    at Object.parse (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36\n    at Array.forEach (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28\n    at Array.forEach (native)\n    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)\n    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50\n    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)\n    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)\n    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)\n    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)\n    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)\n    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)\n    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)\n* ***Provider Error messages***:\n  Syntax Error -------------------------------------------\n \n     Unexpected token \n\n\nIssue comments:\n\n\nBug Context:\nFile: docs/providers/aws/events/iot.md\nLine number range: 1 - 71\nContent:\n1. <!--\n2. title: Serverless Framework - AWS Lambda Events - IoT\n3. menuText: IoT\n4. menuOrder: 7\n5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)\n11. <!-- DOCS-SITE-LINK:END -->\n12. \n13. # IoT\n14. \n15. ## Simple event definition\n16. \n17. This will enable your Lambda function to be called by an AWS IoT rule.\n18. \n19. ```yml\n20. functions:\n21.   myIoT:\n22.     handler: myIoT.handler\n23.     events:\n24.       - iot:\n25.           sql: "SELECT * FROM \'some_topic\'"\n26. ```\n27. \n28. ## Enabling / Disabling\n29. \n30. **Note:** `iot` events are enabled by default.\n31. \n32. This will create and attach a disabled `iot` event for the `myIoT` function.\n33. \n34. ```yml\n35. functions:\n36.   myIoT:\n37.     handler: myIoT.handler\n38.     events:\n39.       - iot:\n40.           sql: "SELECT * FROM \'some_topic\'"\n41.           enabled: false\n42. ```\n43. \n44. ## Specify Name and Description\n45. \n46. Name and Description can be specified with the help of the `name` and `description` properties.\n47. \n48. ```yml\n49. functions:\n50.   myIoT:\n51.     handler: myIoT.handler\n52.     events:\n53.       - iot:\n54.           name: "myIotEvent"\n55.           sql: "SELECT * FROM \'some_topic\'"\n56.           description: "My IoT Event Description"\n57. ```\n58. \n59. ## Specify SQL Versions\n60. \n61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.\n62. \n63. ```yml\n64. functions:\n65.   myIoT:\n66.     handler: myIoT.handler\n67.     events:\n68.       - iot:\n69.           sql: "SELECT * FROM \'some_topic\'"\n70.           sqlVersion: "beta"\n71. ```\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 4 - 4\nContent:\n4. const YAML = require(\'js-yaml\');\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 13 - 29\nContent:\n13.   parse(yamlFilePath) {\n14.     let parentDir = yamlFilePath.split(path.sep);\n15.     parentDir.pop();\n16.     parentDir = parentDir.join(\'/\');\n17.     process.chdir(parentDir);\n18. \n19.     const root = this.serverless.utils.readFileSync(yamlFilePath);\n20.     const options = {\n21.       filter: [\'relative\', \'remote\'],\n22.       loaderOptions: {\n23.         processContent: (res, callback) => {\n24.           callback(null, YAML.load(res.text));\n25.         },\n26.       },\n27.     };\n28.     return resolve(root, options).then((res) => (res.resolved));\n29.   }\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 31 - 32\nContent:\n31. \n32. module.exports = YamlParser;\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 1 - 4\nContent:\n1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 5 - 13\nContent:\n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 15 - 39\nContent:\n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 39 - 46\nContent:\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 48 - 53\nContent:\n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 54 - 75\nContent:\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 76 - 95\nContent:\n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 97 - 106\nContent:\n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 112 - 113\nContent:\n112. }\n113. module.exports = AwsCompileIoTEvents;\n\n' additional_kwargs={} response_metadata={}
2025-11-14 00:38:05,373 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_analyzer_node - DEBUG - content='1) Issue Understanding\n\n- Reported symptom: Deploying an IoT event with multi-line values provided via YAML’s folded style (>) causes a “SyntaxError: Unexpected token” during compilation. The error points to JSON.parse in the IoT events compiler.\n- Unexpected behavior: The generated JSON for the CloudFormation resource includes unescaped newline characters at the end of the Description and Sql fields. This breaks the JSON, causing JSON.parse to fail.\n- Observed example of generated template: The Description and Sql fields contain a trailing linefeed, resulting in invalid JSON such as:\n  - "Description": "My multi- line value.\n    ",\n  - "Sql": "SELECT * FROM \'path/#\' WHERE prop = \'value\'\n    ",\n- Expected: Multi-line inputs should be correctly handled without breaking JSON; the folded content should either be trimmed or properly escaped so that the resulting JSON is valid.\n\n2) Code Analysis\n\n- Involved files:\n  - lib/plugins/aws/deploy/compile/events/iot/index.js\n  - lib/classes/YamlParser.js (context on YAML handling, but not the direct source of the error)\n- Involved function/code blocks:\n  - AwsCompileIoTEvents.compileIoTEvents in lib/plugins/aws/deploy/compile/events/iot/index.js\n    - Dynamic JSON string construction occurs in lines ~54–75 (iotTemplate).\n    - The JSON string is parsed with JSON.parse in lines ~97–103 to create the CloudFormation resource object.\n- Current behavior:\n  - The IoT resource (AWS::IoT::TopicRule) is constructed as a string (iotTemplate) via template literals with interpolated values (RuleName, AwsIotSqlVersion, Description, RuleDisabled, Sql).\n  - The interpolated values are injected raw without escaping or normalization.\n  - The string is then passed to JSON.parse to obtain a JSON object.\n  - YAML folded style (>) produces strings with a trailing newline by default; those newline characters are injected directly into the JSON string without escaping, making the JSON invalid and causing JSON.parse to throw “Unexpected token”.\n\n3) Root Cause\n\n- The compiler uses manual string interpolation to build JSON and then parses it (JSON.parse). This approach does not escape special characters in the interpolated content.\n- Multi-line YAML folded strings include a trailing newline (and could include other characters in different styles). When inserted directly into JSON string literals, these characters must be escaped (e.g., \\n), but they are not, resulting in invalid JSON.\n- Specific problematic parts:\n  - lib/plugins/aws/deploy/compile/events/iot/index.js:\n    - The iotTemplate string block around lines ~54–75 injects Description and Sql directly.\n    - The subsequent JSON.parse call around lines ~97–103 fails due to invalid JSON.\n  - Additionally, "RuleDisabled" is emitted as a quoted string ("false"/"true") instead of a boolean, which is semantically incorrect for CloudFormation properties (though this does not cause the parse error, it is a separate correctness issue).\n\n4) Fix Suggestion\n\nChange 1: Stop building JSON via string interpolation; build plain JS objects\n- File: lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/block: AwsCompileIoTEvents.compileIoTEvents; specifically the iotTemplate construction (lines ~54–75) and its JSON.parse usage (lines ~97–103).\n- What to change:\n  - Replace the string-based iotTemplate with a plain JavaScript object representing the AWS::IoT::TopicRule resource. Populate Properties.TopicRulePayload fields directly from event.iot.*\n  - Do the same for permissionTemplate or keep as-is if it does not interpolate untrusted string content; for consistency and safety, prefer building it as an object as well.\n  - When setting “RuleDisabled”, use a boolean value (true/false) instead of a string.\n- Why this fixes the issue:\n  - Constructing objects directly avoids the need to escape values and eliminates the JSON.parse step, so embedded newlines or special characters will not corrupt JSON syntax. It also corrects the boolean type for “RuleDisabled”.\n\nChange 2: Normalize/trim multi-line string values before assignment\n- File: lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/block: AwsCompileIoTEvents.compileIoTEvents; at the point where Description and Sql are read and assigned (lines ~31–39 and when populating the object).\n- What to change:\n  - Apply trimming to Description and Sql values to remove trailing newline characters that YAML folded style (>) adds by default. If preserving internal formatting is desired for other styles (e.g., |), ensure proper handling rather than trimming internal content.\n- Why this fixes the issue:\n  - Trimming removes the trailing linefeed that was causing JSON syntax errors when using string templates. Even when building objects, normalization provides clean inputs and prevents unintended whitespace in CloudFormation output.\n\nChange 3: If keeping string templates, escape interpolated values properly\n- File: lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/block: AwsCompileIoTEvents.compileIoTEvents; iotTemplate construction (lines ~54–75).\n- What to change:\n  - If you decide to retain string-based templates, ensure every interpolated string field (RuleName, AwsIotSqlVersion, Description, Sql) is converted into a JSON-safe representation before injection. Also ensure RuleDisabled is injected as an unquoted boolean.\n  - Introduce a small helper in this module to sanitize/escape special characters (quotes, backslashes, line breaks) for JSON strings. Use it to wrap Description and Sql prior to insertion.\n- Why this fixes the issue:\n  - Proper escaping ensures that the final JSON string is valid even with special characters or newlines, preventing JSON.parse from failing. Handling booleans as non-strings aligns with CloudFormation expectations.\n\nChange 4: Optional documentation update to clarify multi-line support\n- File: docs/providers/aws/events/iot.md\n- Section: “Specify Name and Description” and/or a new example section\n- What to change:\n  - Add a note/example showing that multi-line values are supported for description and sql. Clarify that folded style (>) is accepted and will be normalized (e.g., trailing newline trimmed).\n- Why this helps:\n  - Improves user expectations and reduces confusion when providing multi-line inputs.\n\nSummary of impacted locations:\n- Primary fix: lib/plugins/aws/deploy/compile/events/iot/index.js, in compileIoTEvents:\n  - Replace JSON string template with object construction for the IoT TopicRule resource.\n  - Trim multi-line string inputs (Description and Sql) before assignment.\n  - Emit RuleDisabled as a boolean.\n  - Eliminate JSON.parse calls for these resources.\n- Optional: Update docs to reflect multi-line input handling behavior.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3669, 'prompt_tokens': 3931, 'total_tokens': 7600, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2240, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--39dd6ef2-57ed-4081-aab2-da4fb33e7279-0' usage_metadata={'input_tokens': 3931, 'output_tokens': 3669, 'total_tokens': 7600, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 2240}}
2025-11-14 00:38:05,377 - thread-135845308794560.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nMulti-line values in IoT event\n\nIssue description: \n<!--\n1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com\n2. Please check if an issue already exists so there are no duplicates\n3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md\n4. Fill out the whole template so we have a good overview on the issue\n5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue\n6. Please follow the template, otherwise we\'ll have to ask you to update it\n-->\n\n# This is a Bug Report\n\nUsing multi-line values (with yaml >) in an IoT definition results in an \'unexpected token\' error.\n\nFor bug reports:\n* What went wrong?  The following yaml:\n```\nevents:\n      - iot:\n          description: >\n            My multi-\n            line value.\n          name: enrollPlayer\n          sql: >\n            SELECT * FROM \'path/#\'\n            WHERE prop = \'value\'\n```\ncomplain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:\n```\n           "Description": "My multi- line value.\n            ",\n            "RuleDisabled": "false",\n            "Sql": "SELECT * FROM \'path/#\' WHERE prop = \'value\'\n            ",\n```\n* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.\n* What was the config you used?\n* What stacktrace or error message from your provider did you see?\n\nSimilar or dependent issues:\n*\n\n* ***Serverless Framework Version you\'re using***: 1.5.0\n* ***Operating System***: OS X 10.12\n* ***Stack Trace***:\nSyntaxError: Unexpected token \n\n    at Object.parse (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36\n    at Array.forEach (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28\n    at Array.forEach (native)\n    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)\n    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50\n    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)\n    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)\n    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)\n    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)\n    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)\n    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)\n    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)\n* ***Provider Error messages***:\n  Syntax Error -------------------------------------------\n \n     Unexpected token \n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/iot.md\nLine number range: 1 - 71\nContent:\n1. <!--\n2. title: Serverless Framework - AWS Lambda Events - IoT\n3. menuText: IoT\n4. menuOrder: 7\n5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)\n11. <!-- DOCS-SITE-LINK:END -->\n12. \n13. # IoT\n14. \n15. ## Simple event definition\n16. \n17. This will enable your Lambda function to be called by an AWS IoT rule.\n18. \n19. ```yml\n20. functions:\n21.   myIoT:\n22.     handler: myIoT.handler\n23.     events:\n24.       - iot:\n25.           sql: "SELECT * FROM \'some_topic\'"\n26. ```\n27. \n28. ## Enabling / Disabling\n29. \n30. **Note:** `iot` events are enabled by default.\n31. \n32. This will create and attach a disabled `iot` event for the `myIoT` function.\n33. \n34. ```yml\n35. functions:\n36.   myIoT:\n37.     handler: myIoT.handler\n38.     events:\n39.       - iot:\n40.           sql: "SELECT * FROM \'some_topic\'"\n41.           enabled: false\n42. ```\n43. \n44. ## Specify Name and Description\n45. \n46. Name and Description can be specified with the help of the `name` and `description` properties.\n47. \n48. ```yml\n49. functions:\n50.   myIoT:\n51.     handler: myIoT.handler\n52.     events:\n53.       - iot:\n54.           name: "myIotEvent"\n55.           sql: "SELECT * FROM \'some_topic\'"\n56.           description: "My IoT Event Description"\n57. ```\n58. \n59. ## Specify SQL Versions\n60. \n61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.\n62. \n63. ```yml\n64. functions:\n65.   myIoT:\n66.     handler: myIoT.handler\n67.     events:\n68.       - iot:\n69.           sql: "SELECT * FROM \'some_topic\'"\n70.           sqlVersion: "beta"\n71. ```\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 4 - 4\nContent:\n4. const YAML = require(\'js-yaml\');\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 13 - 29\nContent:\n13.   parse(yamlFilePath) {\n14.     let parentDir = yamlFilePath.split(path.sep);\n15.     parentDir.pop();\n16.     parentDir = parentDir.join(\'/\');\n17.     process.chdir(parentDir);\n18. \n19.     const root = this.serverless.utils.readFileSync(yamlFilePath);\n20.     const options = {\n21.       filter: [\'relative\', \'remote\'],\n22.       loaderOptions: {\n23.         processContent: (res, callback) => {\n24.           callback(null, YAML.load(res.text));\n25.         },\n26.       },\n27.     };\n28.     return resolve(root, options).then((res) => (res.resolved));\n29.   }\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 31 - 32\nContent:\n31. \n32. module.exports = YamlParser;\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 1 - 4\nContent:\n1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 5 - 13\nContent:\n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 15 - 39\nContent:\n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 39 - 46\nContent:\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 48 - 53\nContent:\n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 54 - 75\nContent:\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 76 - 95\nContent:\n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 97 - 106\nContent:\n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 112 - 113\nContent:\n112. }\n113. module.exports = AwsCompileIoTEvents;\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\n1) Issue Understanding\n\n- Reported symptom: Deploying an IoT event with multi-line values provided via YAML’s folded style (>) causes a “SyntaxError: Unexpected token” during compilation. The error points to JSON.parse in the IoT events compiler.\n- Unexpected behavior: The generated JSON for the CloudFormation resource includes unescaped newline characters at the end of the Description and Sql fields. This breaks the JSON, causing JSON.parse to fail.\n- Observed example of generated template: The Description and Sql fields contain a trailing linefeed, resulting in invalid JSON such as:\n  - "Description": "My multi- line value.\n    ",\n  - "Sql": "SELECT * FROM \'path/#\' WHERE prop = \'value\'\n    ",\n- Expected: Multi-line inputs should be correctly handled without breaking JSON; the folded content should either be trimmed or properly escaped so that the resulting JSON is valid.\n\n2) Code Analysis\n\n- Involved files:\n  - lib/plugins/aws/deploy/compile/events/iot/index.js\n  - lib/classes/YamlParser.js (context on YAML handling, but not the direct source of the error)\n- Involved function/code blocks:\n  - AwsCompileIoTEvents.compileIoTEvents in lib/plugins/aws/deploy/compile/events/iot/index.js\n    - Dynamic JSON string construction occurs in lines ~54–75 (iotTemplate).\n    - The JSON string is parsed with JSON.parse in lines ~97–103 to create the CloudFormation resource object.\n- Current behavior:\n  - The IoT resource (AWS::IoT::TopicRule) is constructed as a string (iotTemplate) via template literals with interpolated values (RuleName, AwsIotSqlVersion, Description, RuleDisabled, Sql).\n  - The interpolated values are injected raw without escaping or normalization.\n  - The string is then passed to JSON.parse to obtain a JSON object.\n  - YAML folded style (>) produces strings with a trailing newline by default; those newline characters are injected directly into the JSON string without escaping, making the JSON invalid and causing JSON.parse to throw “Unexpected token”.\n\n3) Root Cause\n\n- The compiler uses manual string interpolation to build JSON and then parses it (JSON.parse). This approach does not escape special characters in the interpolated content.\n- Multi-line YAML folded strings include a trailing newline (and could include other characters in different styles). When inserted directly into JSON string literals, these characters must be escaped (e.g., \\n), but they are not, resulting in invalid JSON.\n- Specific problematic parts:\n  - lib/plugins/aws/deploy/compile/events/iot/index.js:\n    - The iotTemplate string block around lines ~54–75 injects Description and Sql directly.\n    - The subsequent JSON.parse call around lines ~97–103 fails due to invalid JSON.\n  - Additionally, "RuleDisabled" is emitted as a quoted string ("false"/"true") instead of a boolean, which is semantically incorrect for CloudFormation properties (though this does not cause the parse error, it is a separate correctness issue).\n\n4) Fix Suggestion\n\nChange 1: Stop building JSON via string interpolation; build plain JS objects\n- File: lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/block: AwsCompileIoTEvents.compileIoTEvents; specifically the iotTemplate construction (lines ~54–75) and its JSON.parse usage (lines ~97–103).\n- What to change:\n  - Replace the string-based iotTemplate with a plain JavaScript object representing the AWS::IoT::TopicRule resource. Populate Properties.TopicRulePayload fields directly from event.iot.*\n  - Do the same for permissionTemplate or keep as-is if it does not interpolate untrusted string content; for consistency and safety, prefer building it as an object as well.\n  - When setting “RuleDisabled”, use a boolean value (true/false) instead of a string.\n- Why this fixes the issue:\n  - Constructing objects directly avoids the need to escape values and eliminates the JSON.parse step, so embedded newlines or special characters will not corrupt JSON syntax. It also corrects the boolean type for “RuleDisabled”.\n\nChange 2: Normalize/trim multi-line string values before assignment\n- File: lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/block: AwsCompileIoTEvents.compileIoTEvents; at the point where Description and Sql are read and assigned (lines ~31–39 and when populating the object).\n- What to change:\n  - Apply trimming to Description and Sql values to remove trailing newline characters that YAML folded style (>) adds by default. If preserving internal formatting is desired for other styles (e.g., |), ensure proper handling rather than trimming internal content.\n- Why this fixes the issue:\n  - Trimming removes the trailing linefeed that was causing JSON syntax errors when using string templates. Even when building objects, normalization provides clean inputs and prevents unintended whitespace in CloudFormation output.\n\nChange 3: If keeping string templates, escape interpolated values properly\n- File: lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/block: AwsCompileIoTEvents.compileIoTEvents; iotTemplate construction (lines ~54–75).\n- What to change:\n  - If you decide to retain string-based templates, ensure every interpolated string field (RuleName, AwsIotSqlVersion, Description, Sql) is converted into a JSON-safe representation before injection. Also ensure RuleDisabled is injected as an unquoted boolean.\n  - Introduce a small helper in this module to sanitize/escape special characters (quotes, backslashes, line breaks) for JSON strings. Use it to wrap Description and Sql prior to insertion.\n- Why this fixes the issue:\n  - Proper escaping ensures that the final JSON string is valid even with special characters or newlines, preventing JSON.parse from failing. Handling booleans as non-strings aligns with CloudFormation expectations.\n\nChange 4: Optional documentation update to clarify multi-line support\n- File: docs/providers/aws/events/iot.md\n- Section: “Specify Name and Description” and/or a new example section\n- What to change:\n  - Add a note/example showing that multi-line values are supported for description and sql. Clarify that folded style (>) is accepted and will be normalized (e.g., trailing newline trimmed).\n- Why this helps:\n  - Improves user expectations and reduces confusion when providing multi-line inputs.\n\nSummary of impacted locations:\n- Primary fix: lib/plugins/aws/deploy/compile/events/iot/index.js, in compileIoTEvents:\n  - Replace JSON string template with object construction for the IoT TopicRule resource.\n  - Trim multi-line string inputs (Description and Sql) before assignment.\n  - Emit RuleDisabled as a boolean.\n  - Eliminate JSON.parse calls for these resources.\n- Optional: Update docs to reflect multi-line input handling behavior.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-14 00:38:20,427 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_IPqzFwhAa5SFPItLOf17NQea', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1508, 'prompt_tokens': 5814, 'total_tokens': 7322, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--542404c3-08a9-4f8a-8952-ae102bdd1ef9-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_IPqzFwhAa5SFPItLOf17NQea', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5814, 'output_tokens': 1508, 'total_tokens': 7322, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-14 00:38:46,585 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_bMi8EBsM6yTVOMcWM1LTc2ba', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js","old_content":"            const iotTemplate = `\\n              {\\n                \\"Type\\": \\"AWS::IoT::TopicRule\\",\\n                \\"Properties\\": {\\n                  ${RuleName ? `\\"RuleName\\": \\"${RuleName}\\",` : \'\'}\\n                  \\"TopicRulePayload\\": {\\n                    ${AwsIotSqlVersion ? `\\"AwsIotSqlVersion\\": \\"${AwsIotSqlVersion}\\",` : \'\'}\\n                    ${Description ? `\\"Description\\": \\"${Description}\\",` : \'\'}\\n                    \\"RuleDisabled\\": \\"${RuleDisabled}\\",\\n                    \\"Sql\\": \\"${Sql}\\",\\n                    \\"Actions\\": [\\n                      {\\n                        \\"Lambda\\": {\\n                          \\"FunctionArn\\": { \\"Fn::GetAtt\\": [\\"${lambdaLogicalId}\\", \\"Arn\\"] }\\n                        }\\n                      }\\n                    ]\\n                  }\\n                }\\n              }\\n            `;\\n\\n            const permissionTemplate = `\\n              {\\n                \\"Type\\": \\"AWS::Lambda::Permission\\",\\n                \\"Properties\\": {\\n                  \\"FunctionName\\": { \\"Fn::GetAtt\\": [\\"${lambdaLogicalId}\\", \\"Arn\\"] },\\n                  \\"Action\\": \\"lambda:InvokeFunction\\",\\n                  \\"Principal\\": \\"iot.amazonaws.com\\",\\n                  \\"SourceArn\\": { \\"Fn::Join\\": [\\"\\",\\n                    [\\n                      \\"arn:aws:iot:\\",\\n                      { \\"Ref\\": \\"AWS::Region\\" },\\n                      \\":\\",\\n                      { \\"Ref\\": \\"AWS::AccountId\\" },\\n                      \\":rule/\\",\\n                      { \\"Ref\\": \\"${iotLogicalId}\\"}\\n                    ]\\n                  ] }\\n                }\\n              }\\n            `;\\n\\n            const newIotObject = {\\n              [iotLogicalId]: JSON.parse(iotTemplate),\\n            };\\n\\n            const newPermissionObject = {\\n              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\\n            };","new_content":"            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues\\n            const trimmedDescription = (typeof Description === \'string\') ? Description.trim() : undefined;\\n            const trimmedSql = (typeof Sql === \'string\') ? Sql.trim() : undefined;\\n\\n            const iotRuleResource = {\\n              Type: \'AWS::IoT::TopicRule\',\\n              Properties: {\\n                TopicRulePayload: {\\n                  RuleDisabled: RuleDisabled,\\n                  Sql: trimmedSql,\\n                  Actions: [\\n                    {\\n                      Lambda: {\\n                        FunctionArn: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] }\\n                      }\\n                    }\\n                  ]\\n                }\\n              }\\n            };\\n\\n            if (RuleName) {\\n              iotRuleResource.Properties.RuleName = RuleName;\\n            }\\n            if (AwsIotSqlVersion) {\\n              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;\\n            }\\n            if (trimmedDescription) {\\n              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;\\n            }\\n\\n            const permissionResource = {\\n              Type: \'AWS::Lambda::Permission\',\\n              Properties: {\\n                FunctionName: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] },\\n                Action: \'lambda:InvokeFunction\',\\n                Principal: \'iot.amazonaws.com\',\\n                SourceArn: { \'Fn::Join\': [\'\',\\n                  [\\n                    \'arn:aws:iot:\',\\n                    { Ref: \'AWS::Region\' },\\n                    \':\',\\n                    { Ref: \'AWS::AccountId\' },\\n                    \':rule/\',\\n                    { Ref: iotLogicalId }\\n                  ]\\n                ] }\\n              }\\n            };\\n\\n            const newIotObject = {\\n              [iotLogicalId]: iotRuleResource,\\n            };\\n\\n            const newPermissionObject = {\\n              [lambdaPermissionLogicalId]: permissionResource,\\n            };" }', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3552, 'prompt_tokens': 6846, 'total_tokens': 10398, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2624, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5760}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--294cabdf-0649-4296-b1bd-fddcd186137a-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'old_content': '            const iotTemplate = `\n              {\n                "Type": "AWS::IoT::TopicRule",\n                "Properties": {\n                  ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n                  "TopicRulePayload": {\n                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n                    ${Description ? `"Description": "${Description}",` : \'\'}\n                    "RuleDisabled": "${RuleDisabled}",\n                    "Sql": "${Sql}",\n                    "Actions": [\n                      {\n                        "Lambda": {\n                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n                        }\n                      }\n                    ]\n                  }\n                }\n              }\n            `;\n\n            const permissionTemplate = `\n              {\n                "Type": "AWS::Lambda::Permission",\n                "Properties": {\n                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n                  "Action": "lambda:InvokeFunction",\n                  "Principal": "iot.amazonaws.com",\n                  "SourceArn": { "Fn::Join": ["",\n                    [\n                      "arn:aws:iot:",\n                      { "Ref": "AWS::Region" },\n                      ":",\n                      { "Ref": "AWS::AccountId" },\n                      ":rule/",\n                      { "Ref": "${iotLogicalId}"}\n                    ]\n                  ] }\n                }\n              }\n            `;\n\n            const newIotObject = {\n              [iotLogicalId]: JSON.parse(iotTemplate),\n            };\n\n            const newPermissionObject = {\n              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n            };', 'new_content': "            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues\n            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;\n            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;\n\n            const iotRuleResource = {\n              Type: 'AWS::IoT::TopicRule',\n              Properties: {\n                TopicRulePayload: {\n                  RuleDisabled: RuleDisabled,\n                  Sql: trimmedSql,\n                  Actions: [\n                    {\n                      Lambda: {\n                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }\n                      }\n                    }\n                  ]\n                }\n              }\n            };\n\n            if (RuleName) {\n              iotRuleResource.Properties.RuleName = RuleName;\n            }\n            if (AwsIotSqlVersion) {\n              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;\n            }\n            if (trimmedDescription) {\n              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;\n            }\n\n            const permissionResource = {\n              Type: 'AWS::Lambda::Permission',\n              Properties: {\n                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },\n                Action: 'lambda:InvokeFunction',\n                Principal: 'iot.amazonaws.com',\n                SourceArn: { 'Fn::Join': ['',\n                  [\n                    'arn:aws:iot:',\n                    { Ref: 'AWS::Region' },\n                    ':',\n                    { Ref: 'AWS::AccountId' },\n                    ':rule/',\n                    { Ref: iotLogicalId }\n                  ]\n                ] }\n              }\n            };\n\n            const newIotObject = {\n              [iotLogicalId]: iotRuleResource,\n            };\n\n            const newPermissionObject = {\n              [lambdaPermissionLogicalId]: permissionResource,\n            };"}, 'id': 'call_bMi8EBsM6yTVOMcWM1LTc2ba', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6846, 'output_tokens': 3552, 'total_tokens': 10398, 'input_token_details': {'audio': 0, 'cache_read': 5760}, 'output_token_details': {'audio': 0, 'reasoning': 2624}}
2025-11-14 00:38:47,754 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Ui2a3c16zPh2U7ATEqWs2YIH', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 7792, 'total_tokens': 7822, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2d4f9aa5-424d-4f1c-b476-0bc24a5cc85f-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_Ui2a3c16zPh2U7ATEqWs2YIH', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7792, 'output_tokens': 30, 'total_tokens': 7822, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:38:49,991 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I have implemented the fix to handle multi-line values in IoT event definitions.\n\nSummary of changes:\n- Replaced the string-based JSON construction with direct JavaScript object construction for the IoT TopicRule and Lambda Permission resources. This eliminates the need for JSON.parse and prevents syntax errors from unescaped newlines or special characters.\n- Normalized multi-line strings by trimming Description and Sql values to remove trailing newlines introduced by YAML folded style.\n- Ensured RuleDisabled is treated as a boolean rather than a quoted string.\n\nThese changes were made in lib/plugins/aws/deploy/compile/events/iot/index.js and verified after implementation.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 130, 'prompt_tokens': 8889, 'total_tokens': 9019, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--58fad0b9-67a1-4813-9c10-5fe7ab1247ee-0' usage_metadata={'input_tokens': 8889, 'output_tokens': 130, 'total_tokens': 9019, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:38:50,014 - thread-135845308794560.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..359d8c698 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,62 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: RuleDisabled,
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:38:50,016 - thread-135845308794560.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-14 00:38:50,030 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - INFO - Enter bug_fix_verification_subgraph_node
2025-11-14 00:38:50,031 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_file: lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
2025-11-14 00:38:50,031 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_commands: ['node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec']
2025-11-14 00:38:50,031 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
new file mode 100644
index 000000000..c00c46231
--- /dev/null
+++ b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
@@ -0,0 +1,39 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileIoTEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileIoTEvents', () => {
+  let serverless;
+  let awsCompileIoTEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
+    awsCompileIoTEvents.serverless.service.service = 'new-service';
+  });
+
+  describe('#awsCompileIoTEvents()', () => {
+    it('should not throw when iot event contains multi-line values', () => {
+      awsCompileIoTEvents.serverless.service.functions = {
+        first: {
+          events: [
+            {
+              iot: {
+                description: 'My multi-\nline value.\n',
+                name: 'enrollPlayer',
+                sql: "SELECT * FROM 'path/#'\nWHERE prop = 'value'\n",
+              },
+            },
+          ],
+        },
+      };
+
+      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();
+    });
+  });
+});
\ No newline at end of file

2025-11-14 00:38:50,031 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - edit_patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..359d8c698 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,62 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: RuleDisabled,
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:38:50,033 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Applying patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..359d8c698 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,62 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: RuleDisabled,
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:38:50,037 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Patch applied successfully.
2025-11-14 00:38:50,038 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Applying patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
new file mode 100644
index 000000000..c00c46231
--- /dev/null
+++ b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
@@ -0,0 +1,39 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileIoTEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileIoTEvents', () => {
+  let serverless;
+  let awsCompileIoTEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
+    awsCompileIoTEvents.serverless.service.service = 'new-service';
+  });
+
+  describe('#awsCompileIoTEvents()', () => {
+    it('should not throw when iot event contains multi-line values', () => {
+      awsCompileIoTEvents.serverless.service.functions = {
+        first: {
+          events: [
+            {
+              iot: {
+                description: 'My multi-\nline value.\n',
+                name: 'enrollPlayer',
+                sql: "SELECT * FROM 'path/#'\nWHERE prop = 'value'\n",
+              },
+            },
+          ],
+        },
+      };
+
+      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();
+    });
+  });
+});
\ No newline at end of file

2025-11-14 00:38:50,042 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Patch applied successfully.
2025-11-14 00:38:50,042 - thread-135845308794560.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-14 00:38:50,061 - thread-135845308794560.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-14 00:38:50,061 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-14 00:38:50,163 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:38:50,163 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 356a3d596 Merge pull request #3086 from alasdairnicol/docs_python_hello_world
[?2004l
2025-11-14 00:38:50,163 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-14 00:38:50,265 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:38:50,265 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
Removing lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
[?2004l
2025-11-14 00:38:50,266 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-14 00:38:50,266 - thread-135845308794560.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/deploy/compile/events/iot in the container
2025-11-14 00:38:50,267 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/deploy/compile/events/iot
2025-11-14 00:38:50,368 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:38:50,368 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-14 00:38:50,369 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js in the container
2025-11-14 00:38:50,370 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/deploy/compile/events/iot/index.js in the container
2025-11-14 00:38:50,378 - thread-135845308794560.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-14 00:38:52,776 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verify_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_8nY0n97eMXKt9scOyh4NP6KN', 'function': {'arguments': '{"command":"node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 179, 'prompt_tokens': 470, 'total_tokens': 649, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 128, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f38a3236-94d6-45b4-a27b-6dd7199577b8-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec'}, 'id': 'call_8nY0n97eMXKt9scOyh4NP6KN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 470, 'output_tokens': 179, 'total_tokens': 649, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 128}}
2025-11-14 00:38:52,779 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec
2025-11-14 00:38:53,222 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:38:53,222 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node node_modules/mocha/bin/_mocha lib/plugins/aws/de
eploy/compile/events/iot/multiline-values.test.js -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should not throw when iot event contains multi-line values[0m


[92m [0m[32m 1 passing[0m[90m (9ms)[0m

[?2004l
2025-11-14 00:38:54,620 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verify_node - DEBUG - content='Result:\n  AwsCompileIoTEvents\n    #awsCompileIoTEvents()\n      ✓ should not throw when iot event contains multi-line values\n\n  1 passing (9ms)' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 675, 'total_tokens': 718, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--738dd123-5c29-45da-b2f1-82438940893e-0' usage_metadata={'input_tokens': 675, 'output_tokens': 43, 'total_tokens': 718, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:38:58,106 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verify_structured_node - DEBUG - reproducing_test_fail_log=''
2025-11-14 00:38:58,123 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - INFO - Passing bug reproducing test: True
2025-11-14 00:38:58,123 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproducing_test_fail_log: 
2025-11-14 00:38:58,125 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-14 00:38:58,125 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-14 00:38:58,125 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-14 00:38:58,125 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-14 00:38:58,127 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-14 00:38:58,127 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-14 00:38:58,127 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-14 00:38:58,127 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-14 00:38:58,128 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - INFO - Enter get_pass_regression_test_patch_subgraph_node
2025-11-14 00:38:58,129 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:38:58,132 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..359d8c698 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,62 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: RuleDisabled,
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:38:58,150 - thread-135845308794560.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-14 00:38:58,171 - thread-135845308794560.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-14 00:38:58,171 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-14 00:38:58,273 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:38:58,273 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 356a3d596 Merge pull request #3086 from alasdairnicol/docs_python_hello_world
[?2004l
2025-11-14 00:38:58,273 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-14 00:38:58,375 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:38:58,375 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
Removing lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
[?2004l
2025-11-14 00:38:58,376 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-14 00:38:58,376 - thread-135845308794560.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/deploy/compile/events/iot in the container
2025-11-14 00:38:58,376 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/deploy/compile/events/iot
2025-11-14 00:38:58,477 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:38:58,477 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-14 00:38:58,478 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/deploy/compile/events/iot/index.js in the container
2025-11-14 00:38:58,486 - thread-135845308794560.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-14 00:38:58,487 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-14 00:38:58,487 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:39:01,976 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_GszFNOAF2kRBzbmtgafpLodv', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 282, 'prompt_tokens': 724, 'total_tokens': 1006, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--016eb285-d1c8-40e3-802e-2234cf4f60d7-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_GszFNOAF2kRBzbmtgafpLodv', 'type': 'tool_call'}] usage_metadata={'input_tokens': 724, 'output_tokens': 282, 'total_tokens': 1006, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-14 00:39:01,979 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-14 00:39:02,080 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:39:02,080 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 204
drwxr-xr-x   1 root root  4096 Nov 14 00:32 [0m[01;34m.[0m
drwxr-xr-x   1 root root  4096 Nov 14 00:38 [01;34m..[0m
-rw-r--r--   1 root root   232 Nov 14 00:32 .editorconfig
-rw-r--r--   1 root root    45 Nov 14 00:32 .eslintignore
-rw-r--r--   1 root root   339 Nov 14 00:32 .eslintrc.js
drwxrwxr-x   1 root root  4096 Nov 14 00:38 [01;34m.git[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34m.github[0m
-rwxr-xr-x   1 root root   691 Nov 14 00:32 [01;32m.gitignore[0m
-rw-r--r--   1 root root  1512 Nov 14 00:32 .jsbeautifyrc
-rw-r--r--   1 root root  3934 Nov 14 00:32 .travis.yml
-rw-r--r--   1 root root  5151 Nov 14 00:32 0.5.x-RESOURCES.md
-rw-r--r--   1 root root  9786 Nov 14 00:32 CHANGELOG.md
-rw-r--r--   1 root root  5927 Nov 14 00:32 CONTRIBUTING.md
-rw-r--r--   1 root root  1439 Nov 14 00:32 LICENSE.txt
-rwxr-xr-x   1 root root 25723 Nov 14 00:32 [01;32mREADME.md[0m
-rw-r--r--   1 root root  3092 Nov 14 00:32 RELEASE_CHECKLIST.md
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mbin[0m
-rw-r--r--   1 root root  3290 Nov 14 00:32 code_of_conduct.md
-rw-r--r--   1 root root   992 Nov 14 00:32 docker-compose.yml
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mdocs[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mlib[0m
drwxr-xr-x 626 root root 20480 Aug 28 02:31 [01;34mnode_modules[0m
-rw-r--r--   1 root root 29294 Nov 14 00:32 npm-shrinkwrap.json
-rw-r--r--   1 root root  2930 Nov 14 00:32 package.json
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mscripts[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mtests[0m
[?2004l
2025-11-14 00:39:05,445 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_upXES5ZbDMMOhlwb7owQf1wY', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 218, 'prompt_tokens': 1568, 'total_tokens': 1786, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3e5bfaab-b6f6-4a1f-a6ed-fbf2472795e2-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_upXES5ZbDMMOhlwb7owQf1wY', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1568, 'output_tokens': 218, 'total_tokens': 1786, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-14 00:39:05,448 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-14 00:39:05,550 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:39:05,550 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.5.0",
  "engines": {
    "node": ">=4.0"
  },
  "preferGlobal": true,
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "author": "serverless.com",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/serverless/serverless"
  },
  "keywords": [
    "serverless",
    "serverless framework",
    "serverless applications",
    "serverless modules",
    "api gateway",
    "lambda",
    "aws",
    "aws lambda",
    "amazon",
    "amazon web services",
    "azure",
    "azure functions",
    "google cloud functions",
    "ibm open whisk",
    "iot",
    "internet of things",
    "serverless.com"
  ],
  "files": [
    "bin",
    "lib",
    "scripts/postinstall.js",
    "scripts/preuninstall.js",
    "package.json",
    "npm-shrinkwrap.json",
    "README.md",
    "LICENSE.txt",
    "CHANGELOG.md"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless",
    "slss": "./bin/serverless",
    "sls": "./bin/serverless"
  },
  "scripts": {
    "test": "istanbul cover -x '**/*.test.js' node_modules/mocha/bin/_mocha '!(node_modules)/**/*.test.js' -- -R spec --recursive",
    "lint": "eslint . --cache",
    "docs": "node scripts/generate-readme.js",
    "simple-integration-test": "jest --maxWorkers=5 simple-suite",
    "complex-integration-test": "jest --maxWorkers=5 integration",
    "postinstall": "node ./scripts/postinstall.js",
    "preuninstall": "node ./scripts/preuninstall.js"
  },
  "jest": {
    "testRegex": "(\\.|/)(tests)\\.js$",
    "setupTestFrameworkScriptFile": "<rootDir>/tests/setupTests.js"
  },
  "devDependencies": {
    "chai": "^3.5.0",
    "coveralls": "^2.11.12",
    "eslint": "^3.3.1",
    "eslint-config-airbnb": "^10.0.1",
    "eslint-config-airbnb-base": "^5.0.2",
    "eslint-plugin-import": "^1.13.0",
    "eslint-plugin-jsx-a11y": "^2.1.0",
    "eslint-plugin-react": "^6.1.1",
    "istanbul": "^0.4.4",
    "jest-cli": "^18.0.0",
    "jszip": "^3.1.2",
    "markdown-magic": "0.1.0",
    "mocha": "^3.0.2",
    "mocha-lcov-reporter": "^1.2.0",
    "mock-require": "^1.3.0",
    "proxyquire": "^1.7.10",
    "sinon": "^1.17.5"
  },
  "dependencies": {
    "archiver": "^1.1.0",
    "async": "^1.5.2",
    "aws-sdk": "^2.7.13",
    "bluebird": "^3.4.0",
    "chalk": "^1.1.1",
    "download": "^5.0.2",
    "filesize": "^3.3.0",
    "fs-extra": "^0.26.7",
    "get-stdin": "^5.0.1",
    "glob-all": "^3.1.0",
    "https-proxy-agent": "^1.0.0",
    "js-yaml": "^3.6.1",
    "json-refs": "^2.1.5",
    "lodash": "^4.13.1",
    "minimist": "^1.2.0",
    "moment": "^2.13.0",
    "node-fetch": "^1.5.3",
    "replaceall": "^0.1.6",
    "semver": "^5.0.3",
    "semver-regex": "^1.0.0",
    "shelljs": "^0.6.0",
    "traverse": "^0.6.6",
    "uuid": "^2.0.2"
  }
}
[?2004l
2025-11-14 00:39:13,360 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_CeYYhY4LUr8oioVwAj3aPiPc', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 813, 'prompt_tokens': 2620, 'total_tokens': 3433, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b9e4f87a-7518-460e-b0c7-a0cbbec78c5b-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}, 'id': 'call_CeYYhY4LUr8oioVwAj3aPiPc', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2620, 'output_tokens': 813, 'total_tokens': 3433, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-14 00:39:13,363 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/deploy/compile/events/iot/index.test.js
2025-11-14 00:39:13,465 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:39:13,466 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/deploy/compile/events
s/iot/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsProvider = require('../../../../provider/awsProvider');
const AwsCompileIoTEvents = require('./index');
const Serverless = require('../../../../../../Serverless');

describe('AwsCompileIoTEvents', () => {
  let serverless;
  let awsCompileIoTEvents;

  beforeEach(() => {
    serverless = new Serverless();
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.setProvider('aws', new AwsProvider(serverless));
    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
    awsCompileIoTEvents.serverless.service.service = 'new-service';
  });

  describe('#constructor()', () => {
    it('should set the provider variable to an instance of AwsProvider', () =>
      expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));
  });

  describe('#awsCompileIoTEvents()', () => {
    it('should throw an error if iot event type is not an object', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: 'iot',
            },
          ],
        },
      };

      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);
    });

    it('should create corresponding resources when iot events are given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sql: "SELECT * FROM 'topic_1'",
              },
            },
            {
              iot: {
                sql: "SELECT * FROM 'topic_2'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type
      ).to.equal('AWS::IoT::TopicRule');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type
      ).to.equal('AWS::IoT::TopicRule');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.Sql
      ).to.equal('SELECT * FROM \'topic_1\'');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule2.Properties.TopicRulePayload.Sql
      ).to.equal('SELECT * FROM \'topic_2\'');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstLambdaPermissionIotTopicRule1.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstLambdaPermissionIotTopicRule2.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should respect "name" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                name: 'iotEvantName',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.RuleName
      ).to.equal('iotEvantName');
    });

    it('should respect "enabled" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                enabled: false,
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
        second: {
          events: [
            {
              iot: {
                enabled: true,
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('true');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
    });

    it('should respect "sqlVersion" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sqlVersion: '2016-03-23',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion
      ).to.equal('2016-03-23');
    });

    it('should respect "description" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                description: 'iot event description',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.Description
      ).to.equal('iot event description');
    });

    it('should respect enabled variable if the "enabled" property is not given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sql: "SELECT * FROM 'topic_1'",
[?2004l
2025-11-14 00:39:14,992 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0sIPKH0eLH5LfXrfkcadKpBW', 'function': {'arguments': '{"command":"sed -n \'200,500p\' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 4115, 'total_tokens': 4154, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--90978158-a1ec-4e6f-b471-f61412e0738a-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,500p' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}, 'id': 'call_0sIPKH0eLH5LfXrfkcadKpBW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4115, 'output_tokens': 39, 'total_tokens': 4154, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:39:14,995 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,500p' lib/plugins/aws/deploy/compile/events/iot/index.test.js
2025-11-14 00:39:15,097 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:39:15,097 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,500p' lib/plugins/aws/deploy/compile/even
nts/iot/index.test.js
[?2004l
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
    });

    it('should not create corresponding resources when iot events are not given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });
});
[?2004l
2025-11-14 00:39:24,458 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_vObpZAZDIc5VH4g49NglGo23', 'function': {'arguments': '{"command":"./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should create corresponding resources when iot events are given\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 830, 'prompt_tokens': 4369, 'total_tokens': 5199, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--526d2b3e-f724-4841-9774-b3bf6ed1acb3-0' tool_calls=[{'name': 'run_command', 'args': {'command': "./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g 'should create corresponding resources when iot events are given'"}, 'id': 'call_vObpZAZDIc5VH4g49NglGo23', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4369, 'output_tokens': 830, 'total_tokens': 5199, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-14 00:39:24,461 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g 'should create corresponding resources when iot events are given'
2025-11-14 00:39:24,881 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 1
2025-11-14 00:39:24,881 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo
oy/compile/events/iot/index.test.js -R spec -g 'should create corresponding resou
urces when iot events are given'
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [31m  1) should create corresponding resources when iot events are given[0m


[92m [0m[32m 0 passing[0m[90m (9ms)[0m
[31m  1 failing[0m

[0m  1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:
[0m[31m     AssertionError: expected false to equal 'false'[0m[90m
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)
      at processImmediate (node:internal/timers:466:21)
[0m


[?2004l
2025-11-14 00:39:29,730 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yJqlWgcWWTni7ENtraqw4Z4e', 'function': {'arguments': '{"command":"./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect \\"description\\" variable\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 442, 'prompt_tokens': 4709, 'total_tokens': 5151, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--575852b8-a4b8-4719-8098-b2cd4dbc9db6-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect "description" variable\''}, 'id': 'call_yJqlWgcWWTni7ENtraqw4Z4e', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4709, 'output_tokens': 442, 'total_tokens': 5151, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-14 00:39:29,733 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g 'should respect "description" variable'
2025-11-14 00:39:30,172 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:39:30,172 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo
oy/compile/events/iot/index.test.js -R spec -g 'should respect "description" vari
iable'
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "description" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
2025-11-14 00:39:31,292 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nCZgI43119WRJmkQJq0j4vvr', 'function': {'arguments': '{"command":"./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect \\"name\\" variable\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 52, 'prompt_tokens': 4924, 'total_tokens': 4976, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4096}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f565882f-7e09-4632-871d-e8f2354fc88a-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect "name" variable\''}, 'id': 'call_nCZgI43119WRJmkQJq0j4vvr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4924, 'output_tokens': 52, 'total_tokens': 4976, 'input_token_details': {'audio': 0, 'cache_read': 4096}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:39:31,295 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g 'should respect "name" variable'
2025-11-14 00:39:31,714 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:39:31,714 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo
oy/compile/events/iot/index.test.js -R spec -g 'should respect "name" variable'
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "name" variable[0m


[92m [0m[32m 1 passing[0m[90m (7ms)[0m

[?2004l
2025-11-14 00:39:33,849 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xLkbGcfmv4gBaIMoQALEJ9qs', 'function': {'arguments': '{"command":"./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect \\"enabled\\" variable\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 52, 'prompt_tokens': 5137, 'total_tokens': 5189, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4608}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a3b22c43-5508-41ed-b6e0-77a08f1c8650-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect "enabled" variable\''}, 'id': 'call_xLkbGcfmv4gBaIMoQALEJ9qs', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5137, 'output_tokens': 52, 'total_tokens': 5189, 'input_token_details': {'audio': 0, 'cache_read': 4608}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:39:33,852 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g 'should respect "enabled" variable'
2025-11-14 00:39:34,294 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 1
2025-11-14 00:39:34,294 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo
oy/compile/events/iot/index.test.js -R spec -g 'should respect "enabled" variable
e'
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [31m  1) should respect "enabled" variable[0m


[92m [0m[32m 0 passing[0m[90m (9ms)[0m
[31m  1 failing[0m

[0m  1) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:
[0m[31m     AssertionError: expected true to equal 'true'[0m[90m
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)
      at processImmediate (node:internal/timers:466:21)
[0m


[?2004l
2025-11-14 00:39:35,853 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VIJiZcijoqzygARF2KrUfxXH', 'function': {'arguments': '{"command":"./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect \\"sqlVersion\\" variable\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 53, 'prompt_tokens': 5459, 'total_tokens': 5512, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4352}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2451f5e8-8e58-4ffa-9d67-2245b7e66c21-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should respect "sqlVersion" variable\''}, 'id': 'call_VIJiZcijoqzygARF2KrUfxXH', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5459, 'output_tokens': 53, 'total_tokens': 5512, 'input_token_details': {'audio': 0, 'cache_read': 4352}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:39:35,856 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g 'should respect "sqlVersion" variable'
2025-11-14 00:39:36,282 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:39:36,282 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo
oy/compile/events/iot/index.test.js -R spec -g 'should respect "sqlVersion" varia
able'
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should respect "sqlVersion" variable[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
2025-11-14 00:39:46,752 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_RMzNRkyqhgJ14AcGVvnYjEGG', 'function': {'arguments': '{"command":"./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should (create corresponding resources when iot events are given|respect \\"description\\" variable|respect \\"name\\" variable|respect \\"enabled\\" variable|respect \\"sqlVersion\\" variable)\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 856, 'prompt_tokens': 5677, 'total_tokens': 6533, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5504}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1095961a-3ba5-46f1-b45b-028734fa7423-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g \'should (create corresponding resources when iot events are given|respect "description" variable|respect "name" variable|respect "enabled" variable|respect "sqlVersion" variable)\''}, 'id': 'call_RMzNRkyqhgJ14AcGVvnYjEGG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5677, 'output_tokens': 856, 'total_tokens': 6533, 'input_token_details': {'audio': 0, 'cache_read': 5504}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-14 00:39:46,755 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js -R spec -g 'should (create corresponding resources when iot events are given|respect "description" variable|respect "name" variable|respect "enabled" variable|respect "sqlVersion" variable)'
2025-11-14 00:39:47,182 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 2
2025-11-14 00:39:47,182 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo
oy/compile/events/iot/index.test.js -R spec -g 'should (create corresponding reso
ources when iot events are given|respect "description" variable|respect "name" va
ariable|respect "enabled" variable|respect "sqlVersion" variable)'
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [31m  1) should create corresponding resources when iot events are given[0m
    [32m  ✓[0m[90m should respect "name" variable[0m
    [31m  2) should respect "enabled" variable[0m
    [32m  ✓[0m[90m should respect "sqlVersion" variable[0m
    [32m  ✓[0m[90m should respect "description" variable[0m


[92m [0m[32m 3 passing[0m[90m (12ms)[0m
[31m  2 failing[0m

[0m  1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:
[0m[31m     AssertionError: expected false to equal 'false'[0m[90m
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)
      at processImmediate (node:internal/timers:466:21)
[0m
[0m  2) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:
[0m[31m     AssertionError: expected true to equal 'true'[0m[90m
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)
      at processImmediate (node:internal/timers:466:21)
[0m


[?2004l
2025-11-14 00:40:06,516 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo\noy/compile/events/iot/index.test.js -R spec -g \'should (create corresponding reso\nources when iot events are given|respect "description" variable|respect "name" va\nariable|respect "enabled" variable|respect "sqlVersion" variable)\'\n\n\x1b[0m\x1b[0m\n\x1b[0m  AwsCompileIoTEvents\x1b[0m\n\x1b[0m    #awsCompileIoTEvents()\x1b[0m\n    \x1b[31m  1) should create corresponding resources when iot events are given\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should respect "name" variable\x1b[0m\n    \x1b[31m  2) should respect "enabled" variable\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should respect "sqlVersion" variable\x1b[0m\n    \x1b[32m  ✓\x1b[0m\x1b[90m should respect "description" variable\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 3 passing\x1b[0m\x1b[90m (12ms)\x1b[0m\n\x1b[31m  2 failing\x1b[0m\n\n\x1b[0m  1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:\n\x1b[0m\x1b[31m     AssertionError: expected false to equal \'false\'\x1b[0m\x1b[90m\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)\n      at processImmediate (node:internal/timers:466:21)\n\x1b[0m\n\x1b[0m  2) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:\n\x1b[0m\x1b[31m     AssertionError: expected true to equal \'true\'\x1b[0m\x1b[90m\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)\n      at processImmediate (node:internal/timers:466:21)\n\x1b[0m\n\nTotal tests run: 5' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2046, 'prompt_tokens': 6273, 'total_tokens': 8319, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1536, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--8ead2997-8e1b-4ff0-b198-a3f0d4740387-0' usage_metadata={'input_tokens': 6273, 'output_tokens': 2046, 'total_tokens': 8319, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1536}}
2025-11-14 00:40:06,519 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
 ./node_modules/mocha/bin/_mocha lib/plugins/aws/deplo
oy/compile/events/iot/index.test.js -R spec -g 'should (create corresponding reso
ources when iot events are given|respect "description" variable|respect "name" va
ariable|respect "enabled" variable|respect "sqlVersion" variable)'

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [31m  1) should create corresponding resources when iot events are given[0m
    [32m  ✓[0m[90m should respect "name" variable[0m
    [31m  2) should respect "enabled" variable[0m
    [32m  ✓[0m[90m should respect "sqlVersion" variable[0m
    [32m  ✓[0m[90m should respect "description" variable[0m


[92m [0m[32m 3 passing[0m[90m (12ms)[0m
[31m  2 failing[0m

[0m  1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:
[0m[31m     AssertionError: expected false to equal 'false'[0m[90m
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)
      at processImmediate (node:internal/timers:466:21)
[0m
[0m  2) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:
[0m[31m     AssertionError: expected true to equal 'true'[0m[90m
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)
      at processImmediate (node:internal/timers:466:21)
[0m

Total tests run: 5
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-14 00:40:35,040 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable'] regression_test_fail_log='1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:\n     AssertionError: expected false to equal \'false\'\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)\n      at processImmediate (node:internal/timers:466:21)\n\n2) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:\n     AssertionError: expected true to equal \'true\'\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)\n      at processImmediate (node:internal/timers:466:21)' total_tests_run=5
2025-11-14 00:40:35,042 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable']
2025-11-14 00:40:35,042 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:
     AssertionError: expected false to equal 'false'
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)
      at processImmediate (node:internal/timers:466:21)

2) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:
     AssertionError: expected true to equal 'true'
      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)
      at processImmediate (node:internal/timers:466:21)
2025-11-14 00:40:35,043 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:40:35,043 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable']
2025-11-14 00:40:35,043 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - False
2025-11-14 00:40:35,045 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - tested_patch_result: [TestedPatchResult(patch='diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js\nindex 0d6b01f07..359d8c698 100644\n--- a/lib/plugins/aws/deploy/compile/events/iot/index.js\n+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js\n@@ -51,55 +51,62 @@ class AwsCompileIoTEvents {\n               .getIotLogicalId(functionName, iotNumberInFunction);\n             const lambdaPermissionLogicalId = this.provider.naming\n               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n-            const iotTemplate = `\n-              {\n-                "Type": "AWS::IoT::TopicRule",\n-                "Properties": {\n-                  ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n-                  "TopicRulePayload": {\n-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n-                    ${Description ? `"Description": "${Description}",` : \'\'}\n-                    "RuleDisabled": "${RuleDisabled}",\n-                    "Sql": "${Sql}",\n-                    "Actions": [\n-                      {\n-                        "Lambda": {\n-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n-                        }\n+            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues\n+            const trimmedDescription = (typeof Description === \'string\') ? Description.trim() : undefined;\n+            const trimmedSql = (typeof Sql === \'string\') ? Sql.trim() : undefined;\n+\n+            const iotRuleResource = {\n+              Type: \'AWS::IoT::TopicRule\',\n+              Properties: {\n+                TopicRulePayload: {\n+                  RuleDisabled: RuleDisabled,\n+                  Sql: trimmedSql,\n+                  Actions: [\n+                    {\n+                      Lambda: {\n+                        FunctionArn: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] }\n                       }\n-                    ]\n-                  }\n+                    }\n+                  ]\n                 }\n               }\n-            `;\n+            };\n \n-            const permissionTemplate = `\n-              {\n-                "Type": "AWS::Lambda::Permission",\n-                "Properties": {\n-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n-                  "Action": "lambda:InvokeFunction",\n-                  "Principal": "iot.amazonaws.com",\n-                  "SourceArn": { "Fn::Join": ["",\n-                    [\n-                      "arn:aws:iot:",\n-                      { "Ref": "AWS::Region" },\n-                      ":",\n-                      { "Ref": "AWS::AccountId" },\n-                      ":rule/",\n-                      { "Ref": "${iotLogicalId}"}\n-                    ]\n-                  ] }\n-                }\n+            if (RuleName) {\n+              iotRuleResource.Properties.RuleName = RuleName;\n+            }\n+            if (AwsIotSqlVersion) {\n+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;\n+            }\n+            if (trimmedDescription) {\n+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;\n+            }\n+\n+            const permissionResource = {\n+              Type: \'AWS::Lambda::Permission\',\n+              Properties: {\n+                FunctionName: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] },\n+                Action: \'lambda:InvokeFunction\',\n+                Principal: \'iot.amazonaws.com\',\n+                SourceArn: { \'Fn::Join\': [\'\',\n+                  [\n+                    \'arn:aws:iot:\',\n+                    { Ref: \'AWS::Region\' },\n+                    \':\',\n+                    { Ref: \'AWS::AccountId\' },\n+                    \':rule/\',\n+                    { Ref: iotLogicalId }\n+                  ]\n+                ] }\n               }\n-            `;\n+            };\n \n             const newIotObject = {\n-              [iotLogicalId]: JSON.parse(iotTemplate),\n+              [iotLogicalId]: iotRuleResource,\n             };\n \n             const newPermissionObject = {\n-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n+              [lambdaPermissionLogicalId]: permissionResource,\n             };\n \n             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n', passed=False, regression_test_failure_log='1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:\n     AssertionError: expected false to equal \'false\'\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)\n      at processImmediate (node:internal/timers:466:21)\n\n2) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:\n     AssertionError: expected true to equal \'true\'\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)\n      at processImmediate (node:internal/timers:466:21)')]
2025-11-14 00:40:35,062 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_analyzer_message_node - DEBUG - Sending message to IssueBugAnalyzerNode:
content='Given your suggestion, the edit agent generated the following patch:\ndiff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js\nindex 0d6b01f07..359d8c698 100644\n--- a/lib/plugins/aws/deploy/compile/events/iot/index.js\n+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js\n@@ -51,55 +51,62 @@ class AwsCompileIoTEvents {\n               .getIotLogicalId(functionName, iotNumberInFunction);\n             const lambdaPermissionLogicalId = this.provider.naming\n               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n-            const iotTemplate = `\n-              {\n-                "Type": "AWS::IoT::TopicRule",\n-                "Properties": {\n-                  ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n-                  "TopicRulePayload": {\n-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n-                    ${Description ? `"Description": "${Description}",` : \'\'}\n-                    "RuleDisabled": "${RuleDisabled}",\n-                    "Sql": "${Sql}",\n-                    "Actions": [\n-                      {\n-                        "Lambda": {\n-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n-                        }\n+            // Normalize multi-line strings and build resources as objects to avoid JSON parsing issues\n+            const trimmedDescription = (typeof Description === \'string\') ? Description.trim() : undefined;\n+            const trimmedSql = (typeof Sql === \'string\') ? Sql.trim() : undefined;\n+\n+            const iotRuleResource = {\n+              Type: \'AWS::IoT::TopicRule\',\n+              Properties: {\n+                TopicRulePayload: {\n+                  RuleDisabled: RuleDisabled,\n+                  Sql: trimmedSql,\n+                  Actions: [\n+                    {\n+                      Lambda: {\n+                        FunctionArn: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] }\n                       }\n-                    ]\n-                  }\n+                    }\n+                  ]\n                 }\n               }\n-            `;\n+            };\n \n-            const permissionTemplate = `\n-              {\n-                "Type": "AWS::Lambda::Permission",\n-                "Properties": {\n-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n-                  "Action": "lambda:InvokeFunction",\n-                  "Principal": "iot.amazonaws.com",\n-                  "SourceArn": { "Fn::Join": ["",\n-                    [\n-                      "arn:aws:iot:",\n-                      { "Ref": "AWS::Region" },\n-                      ":",\n-                      { "Ref": "AWS::AccountId" },\n-                      ":rule/",\n-                      { "Ref": "${iotLogicalId}"}\n-                    ]\n-                  ] }\n-                }\n+            if (RuleName) {\n+              iotRuleResource.Properties.RuleName = RuleName;\n+            }\n+            if (AwsIotSqlVersion) {\n+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;\n+            }\n+            if (trimmedDescription) {\n+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;\n+            }\n+\n+            const permissionResource = {\n+              Type: \'AWS::Lambda::Permission\',\n+              Properties: {\n+                FunctionName: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] },\n+                Action: \'lambda:InvokeFunction\',\n+                Principal: \'iot.amazonaws.com\',\n+                SourceArn: { \'Fn::Join\': [\'\',\n+                  [\n+                    \'arn:aws:iot:\',\n+                    { Ref: \'AWS::Region\' },\n+                    \':\',\n+                    { Ref: \'AWS::AccountId\' },\n+                    \':rule/\',\n+                    { Ref: iotLogicalId }\n+                  ]\n+                ] }\n               }\n-            `;\n+            };\n \n             const newIotObject = {\n-              [iotLogicalId]: JSON.parse(iotTemplate),\n+              [iotLogicalId]: iotRuleResource,\n             };\n \n             const newPermissionObject = {\n-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n+              [lambdaPermissionLogicalId]: permissionResource,\n             };\n \n             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n\n\nThe patch generated following error:\nThe patch failed to pass the regression tests:\n1) AwsCompileIoTEvents #awsCompileIoTEvents() should create corresponding resources when iot events are given:\n     AssertionError: expected false to equal \'false\'\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:77:12)\n      at processImmediate (node:internal/timers:466:21)\n\n2) AwsCompileIoTEvents #awsCompileIoTEvents() should respect "enabled" variable:\n     AssertionError: expected true to equal \'true\'\n      at Context.<anonymous> (lib/plugins/aws/deploy/compile/events/iot/index.test.js:143:12)\n      at processImmediate (node:internal/timers:466:21)\n\nPlease analyze the failure and provide a revised suggestion:\n\n1. Error Analysis:\n- Explain why the previous changes failed\n- Identify what specific aspects were problematic\n\n2. Revised Fix Suggestion:\nDescribe in plain English:\n- Which file needs to be modified\n- Which function or code block needs changes\n- What needs to be changed (e.g., "rename variable x to y", "add null check for parameter z")\n- Why this change would fix both the original issue and the new error\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be changed.\n' additional_kwargs={} response_metadata={}
2025-11-14 00:40:50,231 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_analyzer_node - DEBUG - content='1) Error Analysis\n\n- Why the previous changes failed:\n  - The patch changed the IoT rule payload’s RuleDisabled property from a string to a boolean when constructing the resource object. The original implementation produced "RuleDisabled": "false"/"true" as strings by interpolating the boolean into a JSON string template. The existing unit tests assert that RuleDisabled is a string, not a boolean.\n- Symptoms in tests:\n  - Test 1 expected the string \'false\' but received the boolean false.\n  - Test 2 expected the string \'true\' but received the boolean true.\n- Problematic aspect:\n  - Type mismatch for RuleDisabled in the compiled CloudFormation template. While constructing the resource as a plain object fixed the original JSON parsing issue, it unintentionally changed the type of RuleDisabled, breaking tests that depend on the previous string representation.\n\n2) Revised Fix Suggestion\n\n- File to modify:\n  - lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/code block to change:\n  - AwsCompileIoTEvents.compileIoTEvents, specifically the section where the iotRuleResource object is constructed and the TopicRulePayload.RuleDisabled property is set.\n\n- What needs to be changed:\n  - Ensure that the TopicRulePayload.RuleDisabled property is set as a string (\'true\' or \'false\'), not as a boolean. You can either:\n    - Convert the existing RuleDisabled boolean to its string representation at assignment time within iotRuleResource (e.g., set TopicRulePayload.RuleDisabled using a string value based on the boolean), or\n    - Change the earlier variable initialization so that RuleDisabled is stored as a string (\'false\' by default, \'true\' if event.iot.enabled === false), and then assign that string to TopicRulePayload.RuleDisabled.\n  - Keep the rest of the object-based construction intact, including trimming of Description and Sql (assign trimmedDescription and trimmedSql only if they are strings) and avoiding JSON.parse for both the IoT rule and the Lambda permission resource.\n  - Maintain RuleName at the Properties level and AwsIotSqlVersion, Description, Sql under Properties.TopicRulePayload as in the original structure.\n\n- Why this change fixes both issues:\n  - Preserving RuleDisabled as a string maintains backward compatibility with the existing unit test expectations and mirrors the original output, satisfying the regression tests.\n  - Constructing the resources as plain objects and trimming multi-line strings continues to resolve the original “Unexpected token” error by eliminating unsafe JSON string construction and removing trailing linefeeds from multi-line YAML values before they reach the CloudFormation template.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1755, 'prompt_tokens': 6591, 'total_tokens': 8346, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1216, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--fd15fcc0-c4fc-445c-bbb2-b9b4f2dcae8f-0' usage_metadata={'input_tokens': 6591, 'output_tokens': 1755, 'total_tokens': 8346, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1216}}
2025-11-14 00:40:50,235 - thread-135845308794560.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nMulti-line values in IoT event\n\nIssue description: \n<!--\n1. If you have a question and not a bug/feature request please ask it at http://forum.serverless.com\n2. Please check if an issue already exists so there are no duplicates\n3. Check out and follow our Guidelines: https://github.com/serverless/serverless/blob/master/CONTRIBUTING.md\n4. Fill out the whole template so we have a good overview on the issue\n5. Do not remove any section of the template. If something is not applicable leave it empty but leave it in the Issue\n6. Please follow the template, otherwise we\'ll have to ask you to update it\n-->\n\n# This is a Bug Report\n\nUsing multi-line values (with yaml >) in an IoT definition results in an \'unexpected token\' error.\n\nFor bug reports:\n* What went wrong?  The following yaml:\n```\nevents:\n      - iot:\n          description: >\n            My multi-\n            line value.\n          name: enrollPlayer\n          sql: >\n            SELECT * FROM \'path/#\'\n            WHERE prop = \'value\'\n```\ncomplain of an "Unexpected token" when deployed.   Looking at the value of `iotTemplate` in file `serverless/lib/plugins/aws/deploy/compile/events/iot/index.js`, it seems the trailing linefeed is being preserved:\n```\n           "Description": "My multi- line value.\n            ",\n            "RuleDisabled": "false",\n            "Sql": "SELECT * FROM \'path/#\' WHERE prop = \'value\'\n            ",\n```\n* What did you expect should have happened?  The multi-line input should not break the ending quote on the next line.\n* What was the config you used?\n* What stacktrace or error message from your provider did you see?\n\nSimilar or dependent issues:\n*\n\n* ***Serverless Framework Version you\'re using***: 1.5.0\n* ***Operating System***: OS X 10.12\n* ***Stack Trace***:\nSyntaxError: Unexpected token \n\n    at Object.parse (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:99:36\n    at Array.forEach (native)\n    at /usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:21:28\n    at Array.forEach (native)\n    at AwsCompileIoTEvents.compileIoTEvents (/usr/local/lib/node_modules/serverless/lib/plugins/aws/deploy/compile/events/iot/index.js:16:47)\n    at /usr/local/lib/node_modules/serverless/lib/classes/PluginManager.js:160:50\n    at tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Object.gotValue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:157:18)\n    at Object.gotAccum (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/reduce.js:144:25)\n    at Object.tryCatcher (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/util.js:16:23)\n    at Promise._settlePromiseFromHandler (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:510:31)\n    at Promise._settlePromise (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:567:18)\n    at Promise._settlePromise0 (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:612:10)\n    at Promise._settlePromises (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/promise.js:691:18)\n    at Async._drainQueue (/usr/local/lib/node_modules/serverless/node_modules/bluebird/js/release/async.js:138:16)\n* ***Provider Error messages***:\n  Syntax Error -------------------------------------------\n \n     Unexpected token \n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/iot.md\nLine number range: 1 - 71\nContent:\n1. <!--\n2. title: Serverless Framework - AWS Lambda Events - IoT\n3. menuText: IoT\n4. menuOrder: 7\n5. description:  Setting up AWS IoT Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/iot)\n11. <!-- DOCS-SITE-LINK:END -->\n12. \n13. # IoT\n14. \n15. ## Simple event definition\n16. \n17. This will enable your Lambda function to be called by an AWS IoT rule.\n18. \n19. ```yml\n20. functions:\n21.   myIoT:\n22.     handler: myIoT.handler\n23.     events:\n24.       - iot:\n25.           sql: "SELECT * FROM \'some_topic\'"\n26. ```\n27. \n28. ## Enabling / Disabling\n29. \n30. **Note:** `iot` events are enabled by default.\n31. \n32. This will create and attach a disabled `iot` event for the `myIoT` function.\n33. \n34. ```yml\n35. functions:\n36.   myIoT:\n37.     handler: myIoT.handler\n38.     events:\n39.       - iot:\n40.           sql: "SELECT * FROM \'some_topic\'"\n41.           enabled: false\n42. ```\n43. \n44. ## Specify Name and Description\n45. \n46. Name and Description can be specified with the help of the `name` and `description` properties.\n47. \n48. ```yml\n49. functions:\n50.   myIoT:\n51.     handler: myIoT.handler\n52.     events:\n53.       - iot:\n54.           name: "myIotEvent"\n55.           sql: "SELECT * FROM \'some_topic\'"\n56.           description: "My IoT Event Description"\n57. ```\n58. \n59. ## Specify SQL Versions\n60. \n61. [SQL Versions](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-sql-version.html) can be specified for an `iot` event. However the `sqlVersion` is not a required property.\n62. \n63. ```yml\n64. functions:\n65.   myIoT:\n66.     handler: myIoT.handler\n67.     events:\n68.       - iot:\n69.           sql: "SELECT * FROM \'some_topic\'"\n70.           sqlVersion: "beta"\n71. ```\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 4 - 4\nContent:\n4. const YAML = require(\'js-yaml\');\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 13 - 29\nContent:\n13.   parse(yamlFilePath) {\n14.     let parentDir = yamlFilePath.split(path.sep);\n15.     parentDir.pop();\n16.     parentDir = parentDir.join(\'/\');\n17.     process.chdir(parentDir);\n18. \n19.     const root = this.serverless.utils.readFileSync(yamlFilePath);\n20.     const options = {\n21.       filter: [\'relative\', \'remote\'],\n22.       loaderOptions: {\n23.         processContent: (res, callback) => {\n24.           callback(null, YAML.load(res.text));\n25.         },\n26.       },\n27.     };\n28.     return resolve(root, options).then((res) => (res.resolved));\n29.   }\n\n\nFile: lib/classes/YamlParser.js\nLine number range: 31 - 32\nContent:\n31. \n32. module.exports = YamlParser;\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 1 - 4\nContent:\n1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 5 - 13\nContent:\n5. class AwsCompileIoTEvents {\n6.   constructor(serverless) {\n7.     this.serverless = serverless;\n8.     this.provider = this.serverless.getProvider(\'aws\');\n9. \n10.     this.hooks = {\n11.       \'deploy:compileEvents\': this.compileIoTEvents.bind(this),\n12.     };\n13.   }\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 15 - 39\nContent:\n15.   compileIoTEvents() {\n16.     this.serverless.service.getAllFunctions().forEach((functionName) => {\n17.       const functionObj = this.serverless.service.getFunction(functionName);\n18.       let iotNumberInFunction = 0;\n19. \n20.       if (functionObj.events) {\n21.         functionObj.events.forEach(event => {\n22.           if (event.iot) {\n23.             iotNumberInFunction++;\n24.             let RuleName;\n25.             let AwsIotSqlVersion;\n26.             let Description;\n27.             let RuleDisabled;\n28.             let Sql;\n29. \n30.             if (typeof event.iot === \'object\') {\n31.               RuleName = event.iot.name;\n32.               AwsIotSqlVersion = event.iot.sqlVersion;\n33.               Description = event.iot.description;\n34.               RuleDisabled = false;\n35.               if (event.iot.enabled === false) {\n36.                 RuleDisabled = true;\n37.               }\n38.               Sql = event.iot.sql;\n39.             } else {\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 39 - 46\nContent:\n39.             } else {\n40.               const errorMessage = [\n41.                 `IoT event of function "${functionName}" is not an object`,\n42.                 \' Please check the docs for more info.\',\n43.               ].join(\'\');\n44.               throw new this.serverless.classes\n45.                 .Error(errorMessage);\n46.             }\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 48 - 53\nContent:\n48.             const lambdaLogicalId = this.provider.naming\n49.               .getLambdaLogicalId(functionName);\n50.             const iotLogicalId = this.provider.naming\n51.               .getIotLogicalId(functionName, iotNumberInFunction);\n52.             const lambdaPermissionLogicalId = this.provider.naming\n53.               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 54 - 75\nContent:\n54.             const iotTemplate = `\n55.               {\n56.                 "Type": "AWS::IoT::TopicRule",\n57.                 "Properties": {\n58.                   ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n59.                   "TopicRulePayload": {\n60.                     ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n61.                     ${Description ? `"Description": "${Description}",` : \'\'}\n62.                     "RuleDisabled": "${RuleDisabled}",\n63.                     "Sql": "${Sql}",\n64.                     "Actions": [\n65.                       {\n66.                         "Lambda": {\n67.                           "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n68.                         }\n69.                       }\n70.                     ]\n71.                   }\n72.                 }\n73.               }\n74.             `;\n75. \n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 76 - 95\nContent:\n76.             const permissionTemplate = `\n77.               {\n78.                 "Type": "AWS::Lambda::Permission",\n79.                 "Properties": {\n80.                   "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n81.                   "Action": "lambda:InvokeFunction",\n82.                   "Principal": "iot.amazonaws.com",\n83.                   "SourceArn": { "Fn::Join": ["",\n84.                     [\n85.                       "arn:aws:iot:",\n86.                       { "Ref": "AWS::Region" },\n87.                       ":",\n88.                       { "Ref": "AWS::AccountId" },\n89.                       ":rule/",\n90.                       { "Ref": "${iotLogicalId}"}\n91.                     ]\n92.                   ] }\n93.                 }\n94.               }\n95.             `;\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 97 - 106\nContent:\n97.             const newIotObject = {\n98.               [iotLogicalId]: JSON.parse(iotTemplate),\n99.             };\n100. \n101.             const newPermissionObject = {\n102.               [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n103.             };\n104. \n105.             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n106.               newIotObject, newPermissionObject);\n\n\nFile: lib/plugins/aws/deploy/compile/events/iot/index.js\nLine number range: 112 - 113\nContent:\n112. }\n113. module.exports = AwsCompileIoTEvents;\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\n1) Error Analysis\n\n- Why the previous changes failed:\n  - The patch changed the IoT rule payload’s RuleDisabled property from a string to a boolean when constructing the resource object. The original implementation produced "RuleDisabled": "false"/"true" as strings by interpolating the boolean into a JSON string template. The existing unit tests assert that RuleDisabled is a string, not a boolean.\n- Symptoms in tests:\n  - Test 1 expected the string \'false\' but received the boolean false.\n  - Test 2 expected the string \'true\' but received the boolean true.\n- Problematic aspect:\n  - Type mismatch for RuleDisabled in the compiled CloudFormation template. While constructing the resource as a plain object fixed the original JSON parsing issue, it unintentionally changed the type of RuleDisabled, breaking tests that depend on the previous string representation.\n\n2) Revised Fix Suggestion\n\n- File to modify:\n  - lib/plugins/aws/deploy/compile/events/iot/index.js\n- Function/code block to change:\n  - AwsCompileIoTEvents.compileIoTEvents, specifically the section where the iotRuleResource object is constructed and the TopicRulePayload.RuleDisabled property is set.\n\n- What needs to be changed:\n  - Ensure that the TopicRulePayload.RuleDisabled property is set as a string (\'true\' or \'false\'), not as a boolean. You can either:\n    - Convert the existing RuleDisabled boolean to its string representation at assignment time within iotRuleResource (e.g., set TopicRulePayload.RuleDisabled using a string value based on the boolean), or\n    - Change the earlier variable initialization so that RuleDisabled is stored as a string (\'false\' by default, \'true\' if event.iot.enabled === false), and then assign that string to TopicRulePayload.RuleDisabled.\n  - Keep the rest of the object-based construction intact, including trimming of Description and Sql (assign trimmedDescription and trimmedSql only if they are strings) and avoiding JSON.parse for both the IoT rule and the Lambda permission resource.\n  - Maintain RuleName at the Properties level and AwsIotSqlVersion, Description, Sql under Properties.TopicRulePayload as in the original structure.\n\n- Why this change fixes both issues:\n  - Preserving RuleDisabled as a string maintains backward compatibility with the existing unit test expectations and mirrors the original output, satisfying the regression tests.\n  - Constructing the resources as plain objects and trimming multi-line strings continues to resolve the original “Unexpected token” error by eliminating unsafe JSON string construction and removing trailing linefeeds from multi-line YAML values before they reach the CloudFormation template.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-14 00:40:55,449 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_H0z2CnYKTzFzyBIyg97Rllkn', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js","old_content":"                TopicRulePayload: {\\n                  RuleDisabled: RuleDisabled,\\n                  Sql: trimmedSql,\\n                  Actions: [\\n                    {\\n                      Lambda: {\\n                        FunctionArn: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] }\\n                      }\\n                    }\\n                  ]\\n                }","new_content":"                TopicRulePayload: {\\n                  RuleDisabled: String(RuleDisabled),\\n                  Sql: trimmedSql,\\n                  Actions: [\\n                    {\\n                      Lambda: {\\n                        FunctionArn: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] }\\n                      }\\n                    }\\n                  ]\\n                }"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 505, 'prompt_tokens': 12629, 'total_tokens': 13134, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4f713c69-216c-4f7b-af44-21e9dfff3fa1-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'old_content': "                TopicRulePayload: {\n                  RuleDisabled: RuleDisabled,\n                  Sql: trimmedSql,\n                  Actions: [\n                    {\n                      Lambda: {\n                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }\n                      }\n                    }\n                  ]\n                }", 'new_content': "                TopicRulePayload: {\n                  RuleDisabled: String(RuleDisabled),\n                  Sql: trimmedSql,\n                  Actions: [\n                    {\n                      Lambda: {\n                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }\n                      }\n                    }\n                  ]\n                }"}, 'id': 'call_H0z2CnYKTzFzyBIyg97Rllkn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12629, 'output_tokens': 505, 'total_tokens': 13134, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-14 00:40:56,664 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Hx4DbPYCH5bonqlcssuLnYVQ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 12846, 'total_tokens': 12876, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12544}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a1c9f4f8-3cdc-4108-bbca-126c35ac2956-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_Hx4DbPYCH5bonqlcssuLnYVQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12846, 'output_tokens': 30, 'total_tokens': 12876, 'input_token_details': {'audio': 0, 'cache_read': 12544}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:41:12,069 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_JHqrZCnfIXCNLyK31PDAMXJl', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js","old_content":"            const iotTemplate = `\\n              {\\n                \\"Type\\": \\"AWS::IoT::TopicRule\\",\\n                \\"Properties\\": {\\n                  ${RuleName ? `\\"RuleName\\": \\"${RuleName}\\",` : \'\'}\\n                  \\"TopicRulePayload\\": {\\n                    ${AwsIotSqlVersion ? `\\"AwsIotSqlVersion\\": \\"${AwsIotSqlVersion}\\",` : \'\'}\\n                    ${Description ? `\\"Description\\": \\"${Description}\\",` : \'\'}\\n                    \\"RuleDisabled\\": \\"${RuleDisabled}\\",\\n                    \\"Sql\\": \\"${Sql}\\",\\n                    \\"Actions\\": [\\n                      {\\n                        \\"Lambda\\": {\\n                          \\"FunctionArn\\": { \\"Fn::GetAtt\\": [\\"${lambdaLogicalId}\\", \\"Arn\\"] }\\n                        }\\n                      }\\n                    ]\\n                  }\\n                }\\n              }\\n            `;\\n\\n            const permissionTemplate = `\\n              {\\n                \\"Type\\": \\"AWS::Lambda::Permission\\",\\n                \\"Properties\\": {\\n                  \\"FunctionName\\": { \\"Fn::GetAtt\\": [\\"${lambdaLogicalId}\\", \\"Arn\\"] },\\n                  \\"Action\\": \\"lambda:InvokeFunction\\",\\n                  \\"Principal\\": \\"iot.amazonaws.com\\",\\n                  \\"SourceArn\\": { \\"Fn::Join\\": [\\"\\",\\n                    [\\n                      \\"arn:aws:iot:\\",\\n                      { \\"Ref\\": \\"AWS::Region\\" },\\n                      \\":\\",\\n                      { \\"Ref\\": \\"AWS::AccountId\\" },\\n                      \\":rule/\\",\\n                      { \\"Ref\\": \\"${iotLogicalId}\\"}\\n                    ]\\n                  ] }\\n                }\\n              }\\n            `;\\n\\n            const newIotObject = {\\n              [iotLogicalId]: JSON.parse(iotTemplate),\\n            };\\n\\n            const newPermissionObject = {\\n              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\\n            };","new_content":"            const trimmedDescription = (typeof Description === \'string\') ? Description.trim() : undefined;\\n            const trimmedSql = (typeof Sql === \'string\') ? Sql.trim() : undefined;\\n\\n            const iotRuleResource = {\\n              Type: \'AWS::IoT::TopicRule\',\\n              Properties: {\\n                TopicRulePayload: {\\n                  RuleDisabled: String(RuleDisabled),\\n                  Sql: trimmedSql,\\n                  Actions: [\\n                    {\\n                      Lambda: {\\n                        FunctionArn: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] }\\n                      }\\n                    }\\n                  ]\\n                }\\n              }\\n            };\\n\\n            if (RuleName) {\\n              iotRuleResource.Properties.RuleName = RuleName;\\n            }\\n            if (AwsIotSqlVersion) {\\n              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;\\n            }\\n            if (trimmedDescription) {\\n              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;\\n            }\\n\\n            const permissionResource = {\\n              Type: \'AWS::Lambda::Permission\',\\n              Properties: {\\n                FunctionName: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] },\\n                Action: \'lambda:InvokeFunction\',\\n                Principal: \'iot.amazonaws.com\',\\n                SourceArn: { \'Fn::Join\': [\'\',\\n                  [\\n                    \'arn:aws:iot:\',\\n                    { Ref: \'AWS::Region\' },\\n                    \':\',\\n                    { Ref: \'AWS::AccountId\' },\\n                    \':rule/\',\\n                    { Ref: iotLogicalId }\\n                  ]\\n                ] }\\n              }\\n            };\\n\\n            const newIotObject = {\\n              [iotLogicalId]: iotRuleResource,\\n            };\\n\\n            const newPermissionObject = {\\n              [lambdaPermissionLogicalId]: permissionResource,\\n            };"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2129, 'prompt_tokens': 13878, 'total_tokens': 16007, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1216, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12800}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--72ac2b24-3f8b-4541-bb4d-46ab38d639cc-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js', 'old_content': '            const iotTemplate = `\n              {\n                "Type": "AWS::IoT::TopicRule",\n                "Properties": {\n                  ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n                  "TopicRulePayload": {\n                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n                    ${Description ? `"Description": "${Description}",` : \'\'}\n                    "RuleDisabled": "${RuleDisabled}",\n                    "Sql": "${Sql}",\n                    "Actions": [\n                      {\n                        "Lambda": {\n                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n                        }\n                      }\n                    ]\n                  }\n                }\n              }\n            `;\n\n            const permissionTemplate = `\n              {\n                "Type": "AWS::Lambda::Permission",\n                "Properties": {\n                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n                  "Action": "lambda:InvokeFunction",\n                  "Principal": "iot.amazonaws.com",\n                  "SourceArn": { "Fn::Join": ["",\n                    [\n                      "arn:aws:iot:",\n                      { "Ref": "AWS::Region" },\n                      ":",\n                      { "Ref": "AWS::AccountId" },\n                      ":rule/",\n                      { "Ref": "${iotLogicalId}"}\n                    ]\n                  ] }\n                }\n              }\n            `;\n\n            const newIotObject = {\n              [iotLogicalId]: JSON.parse(iotTemplate),\n            };\n\n            const newPermissionObject = {\n              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n            };', 'new_content': "            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;\n            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;\n\n            const iotRuleResource = {\n              Type: 'AWS::IoT::TopicRule',\n              Properties: {\n                TopicRulePayload: {\n                  RuleDisabled: String(RuleDisabled),\n                  Sql: trimmedSql,\n                  Actions: [\n                    {\n                      Lambda: {\n                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }\n                      }\n                    }\n                  ]\n                }\n              }\n            };\n\n            if (RuleName) {\n              iotRuleResource.Properties.RuleName = RuleName;\n            }\n            if (AwsIotSqlVersion) {\n              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;\n            }\n            if (trimmedDescription) {\n              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;\n            }\n\n            const permissionResource = {\n              Type: 'AWS::Lambda::Permission',\n              Properties: {\n                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },\n                Action: 'lambda:InvokeFunction',\n                Principal: 'iot.amazonaws.com',\n                SourceArn: { 'Fn::Join': ['',\n                  [\n                    'arn:aws:iot:',\n                    { Ref: 'AWS::Region' },\n                    ':',\n                    { Ref: 'AWS::AccountId' },\n                    ':rule/',\n                    { Ref: iotLogicalId }\n                  ]\n                ] }\n              }\n            };\n\n            const newIotObject = {\n              [iotLogicalId]: iotRuleResource,\n            };\n\n            const newPermissionObject = {\n              [lambdaPermissionLogicalId]: permissionResource,\n            };"}, 'id': 'call_JHqrZCnfIXCNLyK31PDAMXJl', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13878, 'output_tokens': 2129, 'total_tokens': 16007, 'input_token_details': {'audio': 0, 'cache_read': 12800}, 'output_token_details': {'audio': 0, 'reasoning': 1216}}
2025-11-14 00:41:14,138 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Kppm5RRnhlJdtmYbfcDSpsQR', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/deploy/compile/events/iot/index.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 14810, 'total_tokens': 14840, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--62a919d2-8630-4a34-a851-0b56572d12ea-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/deploy/compile/events/iot/index.js'}, 'id': 'call_Kppm5RRnhlJdtmYbfcDSpsQR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14810, 'output_tokens': 30, 'total_tokens': 14840, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:41:17,074 - thread-135845308794560.prometheus.lang_graph.nodes.edit_node - DEBUG - content='Thanks for the detailed issue report. I’ve adjusted the IoT event compilation to correctly handle multi-line YAML values while preserving compatibility with existing expectations.\n\nWhat changed:\n- The IoT and Lambda permission resources are now constructed as plain JavaScript objects instead of string templates, eliminating JSON.parse errors caused by unescaped newlines.\n- Description and Sql values are trimmed to remove trailing newlines introduced by YAML folded style (>), preventing invalid JSON syntax.\n- RuleDisabled is explicitly set as a string ("true" or "false") to match previous output and avoid breaking existing behavior/tests.\n\nFiles updated:\n- lib/plugins/aws/deploy/compile/events/iot/index.js\n\nThis resolves the “Unexpected token” error when using multi-line values in IoT event definitions and maintains backward compatibility.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 159, 'prompt_tokens': 15890, 'total_tokens': 16049, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--3ec2c219-cf66-4cef-9c31-2c4093b0cbc6-0' usage_metadata={'input_tokens': 15890, 'output_tokens': 159, 'total_tokens': 16049, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:41:17,098 - thread-135845308794560.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..f97987cbf 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,61 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: String(RuleDisabled),
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:41:17,100 - thread-135845308794560.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-14 00:41:17,117 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - INFO - Enter bug_fix_verification_subgraph_node
2025-11-14 00:41:17,117 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_file: lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
2025-11-14 00:41:17,117 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_commands: ['node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec']
2025-11-14 00:41:17,117 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproduced_bug_patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
new file mode 100644
index 000000000..c00c46231
--- /dev/null
+++ b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
@@ -0,0 +1,39 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileIoTEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileIoTEvents', () => {
+  let serverless;
+  let awsCompileIoTEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
+    awsCompileIoTEvents.serverless.service.service = 'new-service';
+  });
+
+  describe('#awsCompileIoTEvents()', () => {
+    it('should not throw when iot event contains multi-line values', () => {
+      awsCompileIoTEvents.serverless.service.functions = {
+        first: {
+          events: [
+            {
+              iot: {
+                description: 'My multi-\nline value.\n',
+                name: 'enrollPlayer',
+                sql: "SELECT * FROM 'path/#'\nWHERE prop = 'value'\n",
+              },
+            },
+          ],
+        },
+      };
+
+      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();
+    });
+  });
+});
\ No newline at end of file

2025-11-14 00:41:17,117 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - edit_patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..f97987cbf 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,61 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: String(RuleDisabled),
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:41:17,119 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Applying patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..f97987cbf 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,61 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: String(RuleDisabled),
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:41:17,124 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Patch applied successfully.
2025-11-14 00:41:17,125 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Applying patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
new file mode 100644
index 000000000..c00c46231
--- /dev/null
+++ b/lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
@@ -0,0 +1,39 @@
+'use strict';
+
+const expect = require('chai').expect;
+const AwsProvider = require('../../../../provider/awsProvider');
+const AwsCompileIoTEvents = require('./index');
+const Serverless = require('../../../../../../Serverless');
+
+describe('AwsCompileIoTEvents', () => {
+  let serverless;
+  let awsCompileIoTEvents;
+
+  beforeEach(() => {
+    serverless = new Serverless();
+    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
+    serverless.setProvider('aws', new AwsProvider(serverless));
+    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
+    awsCompileIoTEvents.serverless.service.service = 'new-service';
+  });
+
+  describe('#awsCompileIoTEvents()', () => {
+    it('should not throw when iot event contains multi-line values', () => {
+      awsCompileIoTEvents.serverless.service.functions = {
+        first: {
+          events: [
+            {
+              iot: {
+                description: 'My multi-\nline value.\n',
+                name: 'enrollPlayer',
+                sql: "SELECT * FROM 'path/#'\nWHERE prop = 'value'\n",
+              },
+            },
+          ],
+        },
+      };
+
+      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.not.throw();
+    });
+  });
+});
\ No newline at end of file

2025-11-14 00:41:17,128 - thread-135845308794560.prometheus.lang_graph.nodes.git_apply_patch_node - INFO - Patch applied successfully.
2025-11-14 00:41:17,129 - thread-135845308794560.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-14 00:41:17,149 - thread-135845308794560.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-14 00:41:17,149 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-14 00:41:17,251 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:17,251 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 356a3d596 Merge pull request #3086 from alasdairnicol/docs_python_hello_world
[?2004l
2025-11-14 00:41:17,251 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-14 00:41:17,353 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:17,353 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-14 00:41:17,354 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-14 00:41:17,354 - thread-135845308794560.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/deploy/compile/events/iot in the container
2025-11-14 00:41:17,354 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/deploy/compile/events/iot
2025-11-14 00:41:17,456 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:17,456 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-14 00:41:17,457 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js in the container
2025-11-14 00:41:17,457 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/deploy/compile/events/iot/index.js in the container
2025-11-14 00:41:17,465 - thread-135845308794560.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-14 00:41:19,159 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verify_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Ix1PlK9qBNbwQe1dCPxW6Nye', 'function': {'arguments': '{"command":"node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 51, 'prompt_tokens': 470, 'total_tokens': 521, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5befd6e4-09c1-4197-b54b-01bea79fe250-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec'}, 'id': 'call_Ix1PlK9qBNbwQe1dCPxW6Nye', 'type': 'tool_call'}] usage_metadata={'input_tokens': 470, 'output_tokens': 51, 'total_tokens': 521, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:41:19,162 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js -R spec
2025-11-14 00:41:19,586 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:19,587 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node node_modules/mocha/bin/_mocha lib/plugins/aws/de
eploy/compile/events/iot/multiline-values.test.js -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should not throw when iot event contains multi-line values[0m


[92m [0m[32m 1 passing[0m[90m (8ms)[0m

[?2004l
2025-11-14 00:41:20,917 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verify_node - DEBUG - content='Result:\n node node_modules/mocha/bin/_mocha lib/plugins/aws/de\neploy/compile/events/iot/multiline-values.test.js -R spec\n\n  AwsCompileIoTEvents\n    #awsCompileIoTEvents()\n      ✓ should not throw when iot event contains multi-line values\n\n\n   1 passing (8ms)' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 74, 'prompt_tokens': 675, 'total_tokens': 749, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--cd1b38df-3eb3-4fbc-906b-4bf0635ae2b4-0' usage_metadata={'input_tokens': 675, 'output_tokens': 74, 'total_tokens': 749, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:41:28,009 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verify_structured_node - DEBUG - reproducing_test_fail_log=''
2025-11-14 00:41:28,023 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - INFO - Passing bug reproducing test: True
2025-11-14 00:41:28,023 - thread-135845308794560.prometheus.lang_graph.nodes.bug_fix_verification_subgraph_node - DEBUG - reproducing_test_fail_log: 
2025-11-14 00:41:28,024 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-14 00:41:28,024 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-14 00:41:28,024 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-14 00:41:28,024 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-14 00:41:28,025 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-14 00:41:28,025 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-14 00:41:28,026 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-14 00:41:28,026 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-14 00:41:28,027 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - INFO - Enter get_pass_regression_test_patch_subgraph_node
2025-11-14 00:41:28,027 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:41:28,029 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..f97987cbf 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,61 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: String(RuleDisabled),
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:41:28,044 - thread-135845308794560.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-14 00:41:28,062 - thread-135845308794560.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-14 00:41:28,063 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-14 00:41:28,164 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:28,164 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 356a3d596 Merge pull request #3086 from alasdairnicol/docs_python_hello_world
[?2004l
2025-11-14 00:41:28,164 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-14 00:41:28,266 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:28,266 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
Removing lib/plugins/aws/deploy/compile/events/iot/multiline-values.test.js
[?2004l
2025-11-14 00:41:28,267 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-14 00:41:28,267 - thread-135845308794560.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/deploy/compile/events/iot in the container
2025-11-14 00:41:28,267 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/deploy/compile/events/iot
2025-11-14 00:41:28,369 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:28,369 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-14 00:41:28,369 - thread-135845308794560.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/deploy/compile/events/iot/index.js in the container
2025-11-14 00:41:28,376 - thread-135845308794560.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-14 00:41:28,377 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-14 00:41:28,377 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:41:32,662 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_q6ngRUgaAqm3MpOIMvYXPvxM', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 346, 'prompt_tokens': 724, 'total_tokens': 1070, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--435bea9a-2676-40fd-a837-04ff47239f8b-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_q6ngRUgaAqm3MpOIMvYXPvxM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 724, 'output_tokens': 346, 'total_tokens': 1070, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-14 00:41:32,666 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-14 00:41:32,767 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:32,768 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 204
drwxr-xr-x   1 root root  4096 Nov 14 00:32 [0m[01;34m.[0m
drwxr-xr-x   1 root root  4096 Nov 14 00:41 [01;34m..[0m
-rw-r--r--   1 root root   232 Nov 14 00:32 .editorconfig
-rw-r--r--   1 root root    45 Nov 14 00:32 .eslintignore
-rw-r--r--   1 root root   339 Nov 14 00:32 .eslintrc.js
drwxrwxr-x   1 root root  4096 Nov 14 00:41 [01;34m.git[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34m.github[0m
-rwxr-xr-x   1 root root   691 Nov 14 00:32 [01;32m.gitignore[0m
-rw-r--r--   1 root root  1512 Nov 14 00:32 .jsbeautifyrc
-rw-r--r--   1 root root  3934 Nov 14 00:32 .travis.yml
-rw-r--r--   1 root root  5151 Nov 14 00:32 0.5.x-RESOURCES.md
-rw-r--r--   1 root root  9786 Nov 14 00:32 CHANGELOG.md
-rw-r--r--   1 root root  5927 Nov 14 00:32 CONTRIBUTING.md
-rw-r--r--   1 root root  1439 Nov 14 00:32 LICENSE.txt
-rwxr-xr-x   1 root root 25723 Nov 14 00:32 [01;32mREADME.md[0m
-rw-r--r--   1 root root  3092 Nov 14 00:32 RELEASE_CHECKLIST.md
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mbin[0m
-rw-r--r--   1 root root  3290 Nov 14 00:32 code_of_conduct.md
-rw-r--r--   1 root root   992 Nov 14 00:32 docker-compose.yml
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mdocs[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mlib[0m
drwxr-xr-x 626 root root 20480 Aug 28 02:31 [01;34mnode_modules[0m
-rw-r--r--   1 root root 29294 Nov 14 00:32 npm-shrinkwrap.json
-rw-r--r--   1 root root  2930 Nov 14 00:32 package.json
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mscripts[0m
drwxrwxr-x   1 root root  4096 Nov 14 00:32 [01;34mtests[0m
[?2004l
2025-11-14 00:41:35,350 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_RnKnweTdplGkONOTqJl1h6lU', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 1568, 'total_tokens': 1658, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--134441b5-634e-4cae-9456-04758ccba6bb-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_RnKnweTdplGkONOTqJl1h6lU', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1568, 'output_tokens': 90, 'total_tokens': 1658, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-14 00:41:35,353 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-14 00:41:35,455 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:35,456 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.5.0",
  "engines": {
    "node": ">=4.0"
  },
  "preferGlobal": true,
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "author": "serverless.com",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/serverless/serverless"
  },
  "keywords": [
    "serverless",
    "serverless framework",
    "serverless applications",
    "serverless modules",
    "api gateway",
    "lambda",
    "aws",
    "aws lambda",
    "amazon",
    "amazon web services",
    "azure",
    "azure functions",
    "google cloud functions",
    "ibm open whisk",
    "iot",
    "internet of things",
    "serverless.com"
  ],
  "files": [
    "bin",
    "lib",
    "scripts/postinstall.js",
    "scripts/preuninstall.js",
    "package.json",
    "npm-shrinkwrap.json",
    "README.md",
    "LICENSE.txt",
    "CHANGELOG.md"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless",
    "slss": "./bin/serverless",
    "sls": "./bin/serverless"
  },
  "scripts": {
    "test": "istanbul cover -x '**/*.test.js' node_modules/mocha/bin/_mocha '!(node_modules)/**/*.test.js' -- -R spec --recursive",
    "lint": "eslint . --cache",
    "docs": "node scripts/generate-readme.js",
    "simple-integration-test": "jest --maxWorkers=5 simple-suite",
    "complex-integration-test": "jest --maxWorkers=5 integration",
    "postinstall": "node ./scripts/postinstall.js",
    "preuninstall": "node ./scripts/preuninstall.js"
  },
  "jest": {
    "testRegex": "(\\.|/)(tests)\\.js$",
    "setupTestFrameworkScriptFile": "<rootDir>/tests/setupTests.js"
  },
  "devDependencies": {
    "chai": "^3.5.0",
    "coveralls": "^2.11.12",
    "eslint": "^3.3.1",
    "eslint-config-airbnb": "^10.0.1",
    "eslint-config-airbnb-base": "^5.0.2",
    "eslint-plugin-import": "^1.13.0",
    "eslint-plugin-jsx-a11y": "^2.1.0",
    "eslint-plugin-react": "^6.1.1",
    "istanbul": "^0.4.4",
    "jest-cli": "^18.0.0",
    "jszip": "^3.1.2",
    "markdown-magic": "0.1.0",
    "mocha": "^3.0.2",
    "mocha-lcov-reporter": "^1.2.0",
    "mock-require": "^1.3.0",
    "proxyquire": "^1.7.10",
    "sinon": "^1.17.5"
  },
  "dependencies": {
    "archiver": "^1.1.0",
    "async": "^1.5.2",
    "aws-sdk": "^2.7.13",
    "bluebird": "^3.4.0",
    "chalk": "^1.1.1",
    "download": "^5.0.2",
    "filesize": "^3.3.0",
    "fs-extra": "^0.26.7",
    "get-stdin": "^5.0.1",
    "glob-all": "^3.1.0",
    "https-proxy-agent": "^1.0.0",
    "js-yaml": "^3.6.1",
    "json-refs": "^2.1.5",
    "lodash": "^4.13.1",
    "minimist": "^1.2.0",
    "moment": "^2.13.0",
    "node-fetch": "^1.5.3",
    "replaceall": "^0.1.6",
    "semver": "^5.0.3",
    "semver-regex": "^1.0.0",
    "shelljs": "^0.6.0",
    "traverse": "^0.6.6",
    "uuid": "^2.0.2"
  }
}
[?2004l
2025-11-14 00:41:40,690 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_iaDt2VnEpYbRkick67eH1seg', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 301, 'prompt_tokens': 2620, 'total_tokens': 2921, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7afa2499-1f2f-4373-879c-6fcd902ef8cd-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}, 'id': 'call_iaDt2VnEpYbRkick67eH1seg', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2620, 'output_tokens': 301, 'total_tokens': 2921, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-14 00:41:40,693 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/deploy/compile/events/iot/index.test.js
2025-11-14 00:41:40,795 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:40,795 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/deploy/compile/events
s/iot/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsProvider = require('../../../../provider/awsProvider');
const AwsCompileIoTEvents = require('./index');
const Serverless = require('../../../../../../Serverless');

describe('AwsCompileIoTEvents', () => {
  let serverless;
  let awsCompileIoTEvents;

  beforeEach(() => {
    serverless = new Serverless();
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.setProvider('aws', new AwsProvider(serverless));
    awsCompileIoTEvents = new AwsCompileIoTEvents(serverless);
    awsCompileIoTEvents.serverless.service.service = 'new-service';
  });

  describe('#constructor()', () => {
    it('should set the provider variable to an instance of AwsProvider', () =>
      expect(awsCompileIoTEvents.provider).to.be.instanceof(AwsProvider));
  });

  describe('#awsCompileIoTEvents()', () => {
    it('should throw an error if iot event type is not an object', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: 'iot',
            },
          ],
        },
      };

      expect(() => awsCompileIoTEvents.compileIoTEvents()).to.throw(Error);
    });

    it('should create corresponding resources when iot events are given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sql: "SELECT * FROM 'topic_1'",
              },
            },
            {
              iot: {
                sql: "SELECT * FROM 'topic_2'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule1.Type
      ).to.equal('AWS::IoT::TopicRule');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources.FirstIotTopicRule2.Type
      ).to.equal('AWS::IoT::TopicRule');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.Sql
      ).to.equal('SELECT * FROM \'topic_1\'');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule2.Properties.TopicRulePayload.Sql
      ).to.equal('SELECT * FROM \'topic_2\'');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule2.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstLambdaPermissionIotTopicRule1.Type
      ).to.equal('AWS::Lambda::Permission');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstLambdaPermissionIotTopicRule2.Type
      ).to.equal('AWS::Lambda::Permission');
    });

    it('should respect "name" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                name: 'iotEvantName',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.RuleName
      ).to.equal('iotEvantName');
    });

    it('should respect "enabled" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                enabled: false,
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
        second: {
          events: [
            {
              iot: {
                enabled: true,
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('true');
      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .SecondIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
    });

    it('should respect "sqlVersion" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sqlVersion: '2016-03-23',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.AwsIotSqlVersion
      ).to.equal('2016-03-23');
    });

    it('should respect "description" variable', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                description: 'iot event description',
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.Description
      ).to.equal('iot event description');
    });

    it('should respect enabled variable if the "enabled" property is not given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [
            {
              iot: {
                sql: "SELECT * FROM 'topic_1'",
[?2004l
2025-11-14 00:41:42,201 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_TTevFJJPx4ctHeUyvhDCQ9Y7', 'function': {'arguments': '{"command":"sed -n \'200,500p\' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 4115, 'total_tokens': 4154, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f8bb860a-8fdd-4d14-a3fd-3bf2655e2ede-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,500p' lib/plugins/aws/deploy/compile/events/iot/index.test.js"}, 'id': 'call_TTevFJJPx4ctHeUyvhDCQ9Y7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4115, 'output_tokens': 39, 'total_tokens': 4154, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:41:42,204 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,500p' lib/plugins/aws/deploy/compile/events/iot/index.test.js
2025-11-14 00:41:42,306 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:42,306 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,500p' lib/plugins/aws/deploy/compile/even
nts/iot/index.test.js
[?2004l
                sql: "SELECT * FROM 'topic_1'",
              },
            },
          ],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
        .FirstIotTopicRule1.Properties.TopicRulePayload.RuleDisabled
      ).to.equal('false');
    });

    it('should not create corresponding resources when iot events are not given', () => {
      awsCompileIoTEvents.serverless.service.functions = {
        first: {
          events: [],
        },
      };

      awsCompileIoTEvents.compileIoTEvents();

      expect(awsCompileIoTEvents.serverless.service
        .provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });
});
[?2004l
2025-11-14 00:41:57,985 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_U5uNvMc2UXAcuoqXVHBLg3ei', 'function': {'arguments': '{"command":"node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep \'^(AwsCompileIoTEvents #awsCompileIoTEvents\\\\(\\\\) (should create corresponding resources when iot events are given|should respect \\"description\\" variable|should respect \\"name\\" variable|should respect \\"enabled\\" variable|should respect \\"sqlVersion\\" variable))$\' -R spec"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1646, 'prompt_tokens': 4369, 'total_tokens': 6015, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1536, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cdcfd4e9-4c9d-4d35-999d-9ae36820a159-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep \'^(AwsCompileIoTEvents #awsCompileIoTEvents\\(\\) (should create corresponding resources when iot events are given|should respect "description" variable|should respect "name" variable|should respect "enabled" variable|should respect "sqlVersion" variable))$\' -R spec'}, 'id': 'call_U5uNvMc2UXAcuoqXVHBLg3ei', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4369, 'output_tokens': 1646, 'total_tokens': 6015, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1536}}
2025-11-14 00:41:57,988 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Executing command: node node_modules/mocha/bin/_mocha lib/plugins/aws/deploy/compile/events/iot/index.test.js --grep '^(AwsCompileIoTEvents #awsCompileIoTEvents\(\) (should create corresponding resources when iot events are given|should respect "description" variable|should respect "name" variable|should respect "enabled" variable|should respect "sqlVersion" variable))$' -R spec
2025-11-14 00:41:58,422 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-14 00:41:58,422 - thread-135845308794560.prometheus.docker.base_container - DEBUG - Command output:
 node node_modules/mocha/bin/_mocha lib/plugins/aws/de
eploy/compile/events/iot/index.test.js --grep '^(AwsCompileIoTEvents #awsCompileI
IoTEvents\(\) (should create corresponding resources when iot events are given|sh
hould respect "description" variable|should respect "name" variable|should respec
ct "enabled" variable|should respect "sqlVersion" variable))$' -R spec
[?2004l

[0m[0m
[0m  AwsCompileIoTEvents[0m
[0m    #awsCompileIoTEvents()[0m
    [32m  ✓[0m[90m should create corresponding resources when iot events are given[0m
    [32m  ✓[0m[90m should respect "name" variable[0m
    [32m  ✓[0m[90m should respect "enabled" variable[0m
    [32m  ✓[0m[90m should respect "sqlVersion" variable[0m
    [32m  ✓[0m[90m should respect "description" variable[0m


[92m [0m[32m 5 passing[0m[90m (12ms)[0m

[?2004l
2025-11-14 00:41:59,801 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\nPass: 5 tests run.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 13, 'prompt_tokens': 4807, 'total_tokens': 4820, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--a672f92f-56fa-4b47-80b9-190df153ada6-0' usage_metadata={'input_tokens': 4807, 'output_tokens': 13, 'total_tokens': 4820, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-14 00:41:59,804 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable
lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
Pass: 5 tests run.
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-14 00:42:06,420 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable'] regression_test_fail_log='' total_tests_run=5
2025-11-14 00:42:06,422 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:42:06,422 - thread-135845308794560.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-14 00:42:06,423 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:42:06,423 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should create corresponding resources when iot events are given', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "description" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "name" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "enabled" variable', 'lib/plugins/aws/deploy/compile/events/iot/index.test.js::AwsCompileIoTEvents::#awsCompileIoTEvents()::should respect "sqlVersion" variable']
2025-11-14 00:42:06,423 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - True
2025-11-14 00:42:06,425 - thread-135845308794560.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - tested_patch_result: [TestedPatchResult(patch='diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js\nindex 0d6b01f07..f97987cbf 100644\n--- a/lib/plugins/aws/deploy/compile/events/iot/index.js\n+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js\n@@ -51,55 +51,61 @@ class AwsCompileIoTEvents {\n               .getIotLogicalId(functionName, iotNumberInFunction);\n             const lambdaPermissionLogicalId = this.provider.naming\n               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);\n-            const iotTemplate = `\n-              {\n-                "Type": "AWS::IoT::TopicRule",\n-                "Properties": {\n-                  ${RuleName ? `"RuleName": "${RuleName}",` : \'\'}\n-                  "TopicRulePayload": {\n-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : \'\'}\n-                    ${Description ? `"Description": "${Description}",` : \'\'}\n-                    "RuleDisabled": "${RuleDisabled}",\n-                    "Sql": "${Sql}",\n-                    "Actions": [\n-                      {\n-                        "Lambda": {\n-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }\n-                        }\n+            const trimmedDescription = (typeof Description === \'string\') ? Description.trim() : undefined;\n+            const trimmedSql = (typeof Sql === \'string\') ? Sql.trim() : undefined;\n+\n+            const iotRuleResource = {\n+              Type: \'AWS::IoT::TopicRule\',\n+              Properties: {\n+                TopicRulePayload: {\n+                  RuleDisabled: String(RuleDisabled),\n+                  Sql: trimmedSql,\n+                  Actions: [\n+                    {\n+                      Lambda: {\n+                        FunctionArn: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] }\n                       }\n-                    ]\n-                  }\n+                    }\n+                  ]\n                 }\n               }\n-            `;\n+            };\n \n-            const permissionTemplate = `\n-              {\n-                "Type": "AWS::Lambda::Permission",\n-                "Properties": {\n-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },\n-                  "Action": "lambda:InvokeFunction",\n-                  "Principal": "iot.amazonaws.com",\n-                  "SourceArn": { "Fn::Join": ["",\n-                    [\n-                      "arn:aws:iot:",\n-                      { "Ref": "AWS::Region" },\n-                      ":",\n-                      { "Ref": "AWS::AccountId" },\n-                      ":rule/",\n-                      { "Ref": "${iotLogicalId}"}\n-                    ]\n-                  ] }\n-                }\n+            if (RuleName) {\n+              iotRuleResource.Properties.RuleName = RuleName;\n+            }\n+            if (AwsIotSqlVersion) {\n+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;\n+            }\n+            if (trimmedDescription) {\n+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;\n+            }\n+\n+            const permissionResource = {\n+              Type: \'AWS::Lambda::Permission\',\n+              Properties: {\n+                FunctionName: { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] },\n+                Action: \'lambda:InvokeFunction\',\n+                Principal: \'iot.amazonaws.com\',\n+                SourceArn: { \'Fn::Join\': [\'\',\n+                  [\n+                    \'arn:aws:iot:\',\n+                    { Ref: \'AWS::Region\' },\n+                    \':\',\n+                    { Ref: \'AWS::AccountId\' },\n+                    \':rule/\',\n+                    { Ref: iotLogicalId }\n+                  ]\n+                ] }\n               }\n-            `;\n+            };\n \n             const newIotObject = {\n-              [iotLogicalId]: JSON.parse(iotTemplate),\n+              [iotLogicalId]: iotRuleResource,\n             };\n \n             const newPermissionObject = {\n-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),\n+              [lambdaPermissionLogicalId]: permissionResource,\n             };\n \n             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,\n', passed=True, regression_test_failure_log='')]
2025-11-14 00:42:06,443 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State max_refined_query_loop: 4
2025-11-14 00:42:06,443 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 3
2025-11-14 00:42:06,443 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-14 00:42:06,443 - thread-135845308794560.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-14 00:42:06,459 - thread-135845308794560.prometheus.lang_graph.nodes.issue_verified_bug_subgraph_node - INFO - edit_patch: diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..f97987cbf 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,61 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: String(RuleDisabled),
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:42:17,089 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_responder_node - DEBUG - content='Thanks for the detailed report and example. We were able to reproduce the “Unexpected token” error when using YAML’s folded scalars (>) for multi-line IoT event values. The issue stemmed from constructing the CloudFormation resources via stringified JSON where the trailing newline from the multi-line value was preserved, producing invalid JSON and causing JSON.parse to fail.\n\nWhat changed\n- Rewrote the IoT rule and permission resource construction to use plain JavaScript objects instead of building JSON strings and parsing them.\n- Trimmed multi-line fields (Description and Sql) to remove trailing newlines.\n- Kept optional fields handled explicitly (RuleName, AwsIotSqlVersion) and ensured RuleDisabled is correctly represented.\n- File touched: lib/plugins/aws/deploy/compile/events/iot/index.js\n\nResult\n- Multi-line values in iot.description and iot.sql are now handled correctly and no longer break deployment.\n\nVerification\n- The bug reproducing test now passes.\n- All selected regression tests pass successfully.\n\nYou shouldn’t need any configuration changes—your original YAML with multi-line values will now deploy without errors. Thanks again for reporting this!' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 817, 'prompt_tokens': 2048, 'total_tokens': 2865, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--76341640-eb73-493e-9b35-c48485847ccc-0' usage_metadata={'input_tokens': 2048, 'output_tokens': 817, 'total_tokens': 2865, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-14 00:42:17,090 - thread-135845308794560.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-14 00:42:17,090 - thread-135845308794560.prometheus.docker.base_container - INFO - Closing persistent shell...
2025-11-14 00:42:17,191 - thread-135845308794560.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-14 00:42:27,380 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - Generated patch:
diff --git a/lib/plugins/aws/deploy/compile/events/iot/index.js b/lib/plugins/aws/deploy/compile/events/iot/index.js
index 0d6b01f07..f97987cbf 100644
--- a/lib/plugins/aws/deploy/compile/events/iot/index.js
+++ b/lib/plugins/aws/deploy/compile/events/iot/index.js
@@ -51,55 +51,61 @@ class AwsCompileIoTEvents {
               .getIotLogicalId(functionName, iotNumberInFunction);
             const lambdaPermissionLogicalId = this.provider.naming
               .getLambdaIotPermissionLogicalId(functionName, iotNumberInFunction);
-            const iotTemplate = `
-              {
-                "Type": "AWS::IoT::TopicRule",
-                "Properties": {
-                  ${RuleName ? `"RuleName": "${RuleName}",` : ''}
-                  "TopicRulePayload": {
-                    ${AwsIotSqlVersion ? `"AwsIotSqlVersion": "${AwsIotSqlVersion}",` : ''}
-                    ${Description ? `"Description": "${Description}",` : ''}
-                    "RuleDisabled": "${RuleDisabled}",
-                    "Sql": "${Sql}",
-                    "Actions": [
-                      {
-                        "Lambda": {
-                          "FunctionArn": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] }
-                        }
+            const trimmedDescription = (typeof Description === 'string') ? Description.trim() : undefined;
+            const trimmedSql = (typeof Sql === 'string') ? Sql.trim() : undefined;
+
+            const iotRuleResource = {
+              Type: 'AWS::IoT::TopicRule',
+              Properties: {
+                TopicRulePayload: {
+                  RuleDisabled: String(RuleDisabled),
+                  Sql: trimmedSql,
+                  Actions: [
+                    {
+                      Lambda: {
+                        FunctionArn: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] }
                       }
-                    ]
-                  }
+                    }
+                  ]
                 }
               }
-            `;
+            };
 
-            const permissionTemplate = `
-              {
-                "Type": "AWS::Lambda::Permission",
-                "Properties": {
-                  "FunctionName": { "Fn::GetAtt": ["${lambdaLogicalId}", "Arn"] },
-                  "Action": "lambda:InvokeFunction",
-                  "Principal": "iot.amazonaws.com",
-                  "SourceArn": { "Fn::Join": ["",
-                    [
-                      "arn:aws:iot:",
-                      { "Ref": "AWS::Region" },
-                      ":",
-                      { "Ref": "AWS::AccountId" },
-                      ":rule/",
-                      { "Ref": "${iotLogicalId}"}
-                    ]
-                  ] }
-                }
+            if (RuleName) {
+              iotRuleResource.Properties.RuleName = RuleName;
+            }
+            if (AwsIotSqlVersion) {
+              iotRuleResource.Properties.TopicRulePayload.AwsIotSqlVersion = AwsIotSqlVersion;
+            }
+            if (trimmedDescription) {
+              iotRuleResource.Properties.TopicRulePayload.Description = trimmedDescription;
+            }
+
+            const permissionResource = {
+              Type: 'AWS::Lambda::Permission',
+              Properties: {
+                FunctionName: { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
+                Action: 'lambda:InvokeFunction',
+                Principal: 'iot.amazonaws.com',
+                SourceArn: { 'Fn::Join': ['',
+                  [
+                    'arn:aws:iot:',
+                    { Ref: 'AWS::Region' },
+                    ':',
+                    { Ref: 'AWS::AccountId' },
+                    ':rule/',
+                    { Ref: iotLogicalId }
+                  ]
+                ] }
               }
-            `;
+            };
 
             const newIotObject = {
-              [iotLogicalId]: JSON.parse(iotTemplate),
+              [iotLogicalId]: iotRuleResource,
             };
 
             const newPermissionObject = {
-              [lambdaPermissionLogicalId]: JSON.parse(permissionTemplate),
+              [lambdaPermissionLogicalId]: permissionResource,
             };
 
             _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources,

2025-11-14 00:42:27,380 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - passed_reproducing_test: True
2025-11-14 00:42:27,380 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - passed_regression_test: True
2025-11-14 00:42:27,380 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - passed_existing_test: False
2025-11-14 00:42:27,380 - thread-135845308794560.prometheus.lang_graph.nodes.issue_bug_subgraph_node - INFO - issue_response:
Thanks for the detailed report and example. We were able to reproduce the “Unexpected token” error when using YAML’s folded scalars (>) for multi-line IoT event values. The issue stemmed from constructing the CloudFormation resources via stringified JSON where the trailing newline from the multi-line value was preserved, producing invalid JSON and causing JSON.parse to fail.

What changed
- Rewrote the IoT rule and permission resource construction to use plain JavaScript objects instead of building JSON strings and parsing them.
- Trimmed multi-line fields (Description and Sql) to remove trailing newlines.
- Kept optional fields handled explicitly (RuleName, AwsIotSqlVersion) and ensured RuleDisabled is correctly represented.
- File touched: lib/plugins/aws/deploy/compile/events/iot/index.js

Result
- Multi-line values in iot.description and iot.sql are now handled correctly and no longer break deployment.

Verification
- The bug reproducing test now passes.
- All selected regression tests pass successfully.

You shouldn’t need any configuration changes—your original YAML with multi-line values will now deploy without errors. Thanks again for reporting this!

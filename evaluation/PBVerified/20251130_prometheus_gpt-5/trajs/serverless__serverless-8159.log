2025-11-13 19:43:31,112 - thread-135845287823040.prometheus.docker.base_container - INFO - Created temporary project directory: /tmp/tmp21xpnqcy/serverless
2025-11-13 19:43:31,112 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Using workdir: /testbed
2025-11-13 19:43:31,502 - thread-135845287823040.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_build: False
2025-11-13 19:43:31,502 - thread-135845287823040.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_existing_test: False
2025-11-13 19:43:31,502 - thread-135845287823040.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_regression_test: True
2025-11-13 19:43:31,502 - thread-135845287823040.prometheus.lang_graph.nodes.noop_node - DEBUG - State run_reproduce_test: True
2025-11-13 19:43:31,502 - thread-135845287823040.prometheus.lang_graph.nodes.noop_node - DEBUG - State number_of_candidate_patch: 5
2025-11-13 19:43:31,502 - thread-135845287823040.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - Enter IssueClassificationSubgraphNode
2025-11-13 19:43:31,503 - thread-135845287823040.prometheus.lang_graph.nodes.issue_classification_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

2025-11-13 19:43:31,503 - thread-135845287823040.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 19:43:31,504 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 19:48:50,363 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We only have a file tree. The issue references default API Gateway request mapping templates created in integration.js, but the actual implementation is not visible. To classify the issue (bug vs feature vs docs vs question), we must inspect the code that sets defaults and any configuration options to override/disable them, and compare with documentation for API Gateway HTTP event request templates. Tests may help but core code and docs are critical.' query='Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js and docs/providers/aws/events/apigateway.md' extra_requirements='If integration.js is large, include at minimum the function(s) building requestTemplates defaults and any config handling that disables or overrides them.' purpose='To determine whether removing or overriding default request mapping templates is currently supported (documented or implemented) and accurately classify the issue.'
2025-11-13 19:48:50,365 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js and docs/providers/aws/events/apigateway.md
2025-11-13 19:48:52,338 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 19:48:52,338 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 19:48:52,339 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 19:48:52,339 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 19:48:52,340 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 19:48:52,341 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 19:48:52,341 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js and docs/providers/aws/events/apigateway.md
Extra requirements: If integration.js is large, include at minimum the function(s) building requestTemplates defaults and any config handling that disables or overrides them.
Purpose: To determine whether removing or overriding default request mapping templates is currently supported (documented or implemented) and accurately classify the issue.
2025-11-13 19:48:59,766 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XBZV2QTlp9eJquouNEoYB6NS', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 556, 'prompt_tokens': 2272, 'total_tokens': 2828, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8ba1545a-be01-415e-81be-ba8446c6d5d0-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_XBZV2QTlp9eJquouNEoYB6NS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2272, 'output_tokens': 556, 'total_tokens': 2828, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 19:49:02,025 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3WKOExpBEuXwiCTwcd0kuiSm', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 5099, 'total_tokens': 5130, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b5aefcb0-9224-47d2-a4c9-0957bd648faa-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_3WKOExpBEuXwiCTwcd0kuiSm', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5099, 'output_tokens': 31, 'total_tokens': 5130, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:13,859 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pWBTfdulqcQmmpFn4pnnd1He', 'function': {'arguments': '{"text":"Serverless Framework - AWS Lambda Events - API Gateway","basename":"apigateway.md"}', 'name': 'find_text_node_with_text_in_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1069, 'prompt_tokens': 11031, 'total_tokens': 12100, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1024, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d9bf107a-e4d0-4df8-afe2-ded51d93a65d-0' tool_calls=[{'name': 'find_text_node_with_text_in_file', 'args': {'text': 'Serverless Framework - AWS Lambda Events - API Gateway', 'basename': 'apigateway.md'}, 'id': 'call_pWBTfdulqcQmmpFn4pnnd1He', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11031, 'output_tokens': 1069, 'total_tokens': 12100, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1024}}
2025-11-13 19:49:15,274 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ifdShbTPXsfCg7KqyzCgQtYg', 'function': {'arguments': '{"node_id":765095}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 12427, 'total_tokens': 12452, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--49c6b173-1723-46db-b877-b04986a348bd-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765095}, 'id': 'call_ifdShbTPXsfCg7KqyzCgQtYg', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12427, 'output_tokens': 25, 'total_tokens': 12452, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:17,243 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Rbg63cCkw35DIOTmzQXejyLn', 'function': {'arguments': '{"node_id":765096}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 14048, 'total_tokens': 14073, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 11008}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--eb95cc64-6cbd-4847-8c41-489f658ea296-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765096}, 'id': 'call_Rbg63cCkw35DIOTmzQXejyLn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14048, 'output_tokens': 25, 'total_tokens': 14073, 'input_token_details': {'audio': 0, 'cache_read': 11008}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:18,787 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ASbsxoYUwdiLAWdMsWCmwimh', 'function': {'arguments': '{"node_id":765097}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 15403, 'total_tokens': 15428, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d1e22e4b-0ba7-4b78-8a4b-35b73ccc09c7-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765097}, 'id': 'call_ASbsxoYUwdiLAWdMsWCmwimh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15403, 'output_tokens': 25, 'total_tokens': 15428, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:20,414 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Q7MAW5ebTWRP98sa1gpNZw1k', 'function': {'arguments': '{"node_id":765098}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 16704, 'total_tokens': 16729, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--975dd24b-49a9-4fe9-85d6-1c15a81bac76-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765098}, 'id': 'call_Q7MAW5ebTWRP98sa1gpNZw1k', 'type': 'tool_call'}] usage_metadata={'input_tokens': 16704, 'output_tokens': 25, 'total_tokens': 16729, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:21,836 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xCWg5asmmNmFB2BILoSn1Ofn', 'function': {'arguments': '{"node_id":765099}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 18001, 'total_tokens': 18026, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 16640}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1b5302e6-bb98-4798-a39d-fa9859903136-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765099}, 'id': 'call_xCWg5asmmNmFB2BILoSn1Ofn', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18001, 'output_tokens': 25, 'total_tokens': 18026, 'input_token_details': {'audio': 0, 'cache_read': 16640}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:24,100 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_uPKCVLI2NntvDEjV2XuSnQnc', 'function': {'arguments': '{"node_id":765100}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 19351, 'total_tokens': 19376, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ef544bb4-bc4b-4949-8983-1e6b38ff8e3b-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765100}, 'id': 'call_uPKCVLI2NntvDEjV2XuSnQnc', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19351, 'output_tokens': 25, 'total_tokens': 19376, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:25,571 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_oDNuj88i5pSubZrB4hn8YxEm', 'function': {'arguments': '{"node_id":765101}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 21036, 'total_tokens': 21061, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 15360}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--918d7d69-ebf7-45ed-a571-bc8e76c5ad03-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765101}, 'id': 'call_oDNuj88i5pSubZrB4hn8YxEm', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21036, 'output_tokens': 25, 'total_tokens': 21061, 'input_token_details': {'audio': 0, 'cache_read': 15360}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:27,528 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_KpsSi7EWmTtyNvqaIXPDw4PP', 'function': {'arguments': '{"node_id":765102}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 22262, 'total_tokens': 22287, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--15509db2-1c03-4f15-95ec-4412da810cd0-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765102}, 'id': 'call_KpsSi7EWmTtyNvqaIXPDw4PP', 'type': 'tool_call'}] usage_metadata={'input_tokens': 22262, 'output_tokens': 25, 'total_tokens': 22287, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:35,494 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_FKZsocsHcuLKPPX72KjBYDzU', 'function': {'arguments': '{"node_id":765103}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 543, 'prompt_tokens': 23458, 'total_tokens': 24001, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 13952}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6fadac1e-a038-49ee-b7bc-e42d2e259115-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765103}, 'id': 'call_FKZsocsHcuLKPPX72KjBYDzU', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23458, 'output_tokens': 543, 'total_tokens': 24001, 'input_token_details': {'audio': 0, 'cache_read': 13952}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 19:49:37,480 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0XOATFVOOobuoCr9FpntzFcL', 'function': {'arguments': '{"node_id":765104}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 24762, 'total_tokens': 24787, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19328}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ca80a529-9ddf-49e4-ab71-5d6250236f26-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765104}, 'id': 'call_0XOATFVOOobuoCr9FpntzFcL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24762, 'output_tokens': 25, 'total_tokens': 24787, 'input_token_details': {'audio': 0, 'cache_read': 19328}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:40,554 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nmF8PYmiZRfXmd5WVVATb61i', 'function': {'arguments': '{"node_id":765105}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 26216, 'total_tokens': 26241, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17920}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--83fbec65-5976-4db0-a98f-fbef0fcecf85-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765105}, 'id': 'call_nmF8PYmiZRfXmd5WVVATb61i', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26216, 'output_tokens': 25, 'total_tokens': 26241, 'input_token_details': {'audio': 0, 'cache_read': 17920}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:42,548 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gwkobrX6ts9ZEO8v5wAp2CIK', 'function': {'arguments': '{"node_id":765106}', 'name': 'get_next_text_node_with_node_id'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 25, 'prompt_tokens': 27597, 'total_tokens': 27622, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12416}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2c94a869-5218-45a2-9f03-6c584033c834-0' tool_calls=[{'name': 'get_next_text_node_with_node_id', 'args': {'node_id': 765106}, 'id': 'call_gwkobrX6ts9ZEO8v5wAp2CIK', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27597, 'output_tokens': 25, 'total_tokens': 27622, 'input_token_details': {'audio': 0, 'cache_read': 12416}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:49:59,269 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I retrieved the full integration.js with line numbers and confirmed it includes getIntegrationRequestTemplates, which sets default templates only for AWS integration and merges any http.request.template overrides. I also gathered the full apigateway.md by walking through its text chunks, ensuring the sections on Default/Custom Request Templates and Pass Through Behavior are included. This provides both the implementation details and documentation to assess whether defaults can be overridden or effectively disabled.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1567, 'prompt_tokens': 28847, 'total_tokens': 30414, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 20992}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--ad1fde84-b2ac-489f-a979-46288eb4776c-0' usage_metadata={'input_tokens': 28847, 'output_tokens': 1567, 'total_tokens': 30414, 'input_token_details': {'audio': 0, 'cache_read': 20992}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-13 19:49:59,277 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js and docs/providers/aws/events/apigateway.md
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If integration.js is large, include at minimum the function(s) building requestTemplates defaults and any config handling that disables or overrides them.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
To determine whether removing or overriding default request mapping templates is currently supported (documented or implemented) and accurately classify the issue.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: docs/providers/aws/events/apigateway.md
Line number range: 1 - 501
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - API Gateway
3. menuText: API Gateway
4. menuOrder: 1
5. description: Setting up AWS API Gateway Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/apigateway)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # API Gateway
16. 
17. - [API Gateway](#api-gateway)
18.   - [Lambda Proxy Integration](#lambda-proxy-integration)
19.     - [Simple HTTP Endpoint](#simple-http-endpoint)
20.     - [Example "LAMBDA-PROXY" event (default)](#example-lambda-proxy-event-default)
21.     - [HTTP Endpoint with Extended Options](#http-endpoint-with-extended-options)
22.     - [Enabling CORS](#enabling-cors)
23.     - [HTTP Endpoints with `AWS_IAM` Authorizers](#http-endpoints-with-aws_iam-authorizers)
24.     - [HTTP Endpoints with Custom Authorizers](#http-endpoints-with-custom-authorizers)
25.     - [HTTP Endpoints with `operationId`](#http-endpoints-with-operationId)
26.     - [Catching Exceptions In Your Lambda Function](#catching-exceptions-in-your-lambda-function)
27.     - [Setting API keys for your Rest API](#setting-api-keys-for-your-rest-api)
28.     - [Configuring endpoint types](#configuring-endpoint-types)
29.     - [Request Parameters](#request-parameters)
30.     - [Request Schema Validators](#request-schema-validators)
31.     - [Setting source of API key for metering requests](#setting-source-of-api-key-for-metering-requests)
32.   - [Lambda Integration](#lambda-integration)
33.     - [Example "LAMBDA" event (before customization)](#example-lambda-event-before-customization)
34.     - [Request templates](#request-templates)
35.       - [Default Request Templates](#default-request-templates)
36.       - [Custom Request Templates](#custom-request-templates)
37.       - [Pass Through Behavior](#pass-through-behavior)
38.     - [Responses](#responses)
39.       - [Custom Response Headers](#custom-response-headers)
40.       - [Custom Response Templates](#custom-response-templates)
41.     - [Status Codes](#status-codes)
42.       - [Available Status Codes](#available-status-codes)
43.       - [Using Status Codes](#using-status-codes)
44.       - [Custom Status Codes](#custom-status-codes)
45.   - [Setting an HTTP Proxy on API Gateway](#setting-an-http-proxy-on-api-gateway)
46.   - [Accessing private resources using VPC Link](#accessing-private-resources-using-vpc-link)
47.   - [Mock Integration](#mock-integration)
48.   - [Share API Gateway and API Resources](#share-api-gateway-and-api-resources)
49.     - [Easiest and CI/CD friendly example of using shared API Gateway and API Resources.](#easiest-and-cicd-friendly-example-of-using-shared-api-gateway-and-api-resources)
50.     - [Manually Configuring shared API Gateway](#manually-configuring-shared-api-gateway)
51.       - [Note while using authorizers with shared API Gateway](#note-while-using-authorizers-with-shared-api-gateway)
52.   - [Share Authorizer](#share-authorizer)
53.   - [Resource Policy](#resource-policy)
54.   - [Compression](#compression)
55.   - [Binary Media Types](#binary-media-types)
56.   - [Detailed CloudWatch Metrics](#detailed-cloudwatch-metrics)
57.   - [AWS X-Ray Tracing](#aws-x-ray-tracing)
58.   - [Tags / Stack Tags](#tags--stack-tags)
59.   - [Logs](#logs)
60. 
61. _Are you looking for tutorials on using API Gateway? Check out the following resources:_
62. 
63. > - [Add a custom domain for your API Gateway](https://serverless.com/blog/serverless-api-gateway-domain/)
64. > - [Deploy multiple micro-services under the same domain](https://serverless.com/blog/api-gateway-multiple-services/)
65. > - [Create a Node REST API with Express.js](https://serverless.com/blog/serverless-express-rest-api/)
66. > - [Make a Serverless GraphQL API](https://serverless.com/blog/make-serverless-graphql-api-using-lambda-dynamodb/)
67. 
68. To create HTTP endpoints as Event sources for your AWS Lambda Functions, use the Serverless Framework's easy AWS API Gateway Events syntax.
69. 
70. There are five ways you can configure your HTTP endpoints to integrate with your AWS Lambda Functions:
71. 
72. - `lambda-proxy` / `aws-proxy` / `aws_proxy` (Recommended)
73. - `lambda` / `aws`
74. - `http`
75. - `http-proxy` / `http_proxy`
76. - `mock`
77. 
78. **The Framework uses the `lambda-proxy` method (i.e., everything is passed into your Lambda) by default unless another method is supplied by the user**
79. 
80. The difference between these is `lambda-proxy` (alternative writing styles are `aws-proxy` and `aws_proxy` for compatibility with the standard AWS integration type naming) automatically passes the content of the HTTP request into your AWS Lambda function (headers, body, etc.) and allows you to configure your response (headers, status code, body) in the code of your AWS Lambda Function. Whereas, the `lambda` method makes you explicitly define headers, status codes, and more in the configuration of each API Gateway Endpoint (not in code). We highly recommend using the `lambda-proxy` method if it supports your use-case, since the `lambda` method is highly tedious.
81. 
82. Use `http` for integrating with an HTTP back end, `http-proxy` for integrating with the HTTP proxy integration or `mock` for testing without actually invoking the back end.
83. 
84. ## Lambda Proxy Integration
85. 
86. ### Simple HTTP Endpoint
87. 
88. This setup specifies that the `hello` function should be run when someone accesses the API gateway at `hello` via
89. a `GET` request.
90. 
91. Here's an example:
92. 
93. ```yml
94. # serverless.yml
95. 
96. functions:
97.   index:
98.     handler: handler.hello
99.     events:
100.       - http: GET hello
101. ```
102. 
103. ```javascript
104. // handler.js
105. 
106. 'use strict';
107. 
108. module.exports.hello = function(event, context, callback) {
109.   console.log(event); // Contains incoming request data (e.g., query params, headers and more)
110. 
111.   const response = {
112.     statusCode: 200,
113.     headers: {
114.       'x-custom-header': 'My Header Value',
115.     },
116.     body: JSON.stringify({ message: 'Hello World!' }),
117.   };
118. 
119.   callback(null, response);
120. };
121. ```
122. 
123. **Note:** When the body is a JSON-Document, you must parse it yourself:
124. 
125. ```
126. JSON.parse(event.body);
127. ```
128. 
129. ### Example "LAMBDA-PROXY" event (default)
130. 
131. ```json
132. {
133.   "resource": "/",
134.   "path": "/",
135.   "httpMethod": "POST",
136.   "headers": {
137.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
138.     "Accept-Encoding": "gzip, deflate, br",
139.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
140.     "cache-control": "max-age=0",
141.     "CloudFront-Forwarded-Proto": "https",
142.     "CloudFront-Is-Desktop-Viewer": "true",
143.     "CloudFront-Is-Mobile-Viewer": "false",
144.     "CloudFront-Is-SmartTV-Viewer": "false",
145.     "CloudFront-Is-Tablet-Viewer": "false",
146.     "CloudFront-Viewer-Country": "GB",
147.     "content-type": "application/x-www-form-urlencoded",
148.     "Host": "j3ap25j034.execute-api.eu-west-2.amazonaws.com",
149.     "origin": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com",
150.     "Referer": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com/dev/",
151.     "upgrade-insecure-requests": "1",
152.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
153.     "Via": "2.0 a3650115c5e21e2b5d133ce84464bea3.cloudfront.net (CloudFront)",
154.     "X-Amz-Cf-Id": "0nDeiXnReyHYCkv8cc150MWCFCLFPbJoTs1mexDuKe2WJwK5ANgv2A==",
155.     "X-Amzn-Trace-Id": "Root=1-597079de-75fec8453f6fd4812414a4cd",
156.     "X-Forwarded-For": "50.129.117.14, 50.112.234.94",
157.     "X-Forwarded-Port": "443",
158.     "X-Forwarded-Proto": "https"
159.   },
160.   "queryStringParameters": null,
161.   "pathParameters": null,
162.   "stageVariables": null,
163.   "requestContext": {
164.     "path": "/dev/",
165.     "accountId": "125002137610",
166.     "resourceId": "qdolsr1yhk",
167.     "stage": "dev",
168.     "requestId": "0f2431a2-6d2f-11e7-b799-5152aa497861",
169.     "identity": {
170.       "cognitoIdentityPoolId": null,
171.       "accountId": null,
172.       "cognitoIdentityId": null,
173.       "caller": null,
174.       "apiKey": "",
175.       "sourceIp": "50.129.117.14",
176.       "accessKey": null,
177.       "cognitoAuthenticationType": null,
178.       "cognitoAuthenticationProvider": null,
179.       "userArn": null,
180.       "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
181.       "user": null
182.     },
183.     "resourcePath": "/",
184.     "httpMethod": "POST",
185.     "apiId": "j3azlsj0c4"
186.   },
187.   "body": "postcode=LS17FR",
188.   "isBase64Encoded": false
189. }
190. ```
191. 
192. ### HTTP Endpoint with Extended Options
193. 
194. Here we've defined an POST endpoint for the path `posts/create`.
195. 
196. ```yml
197. # serverless.yml
198. 
199. functions:
200.   create:
201.     handler: posts.create
202.     events:
203.       - http:
204.           path: posts/create
205.           method: post
206. ```
207. 
208. ### Enabling CORS
209. 
210. To set CORS configurations for your HTTP endpoints, simply modify your event configurations as follows:
211. 
212. ```yml
213. # serverless.yml
214. 
215. functions:
216.   hello:
217.     handler: handler.hello
218.     events:
219.       - http:
220.           path: hello
221.           method: get
222.           cors: true
223. ```
224. 
225. Setting `cors` to `true` assumes a default configuration which is equivalent to:
226. 
227. ```yml
228. functions:
229.   hello:
230.     handler: handler.hello
231.     events:
232.       - http:
233.           path: hello
234.           method: get
235.           cors:
236.             origin: '*'
237.             headers:
238.               - Content-Type
239.               - X-Amz-Date
240.               - Authorization
241.               - X-Api-Key
242.               - X-Amz-Security-Token
243.               - X-Amz-User-Agent
244.             allowCredentials: false
245. ```
246. 
247. To allow multiple origins, you can use the following configuration and provide an array in the `origins` or use comma separated `origin` field:
248. 
249. ```yml
250. functions:
251.   hello:
252.     handler: handler.hello
253.     events:
254.       - http:
255.           path: hello
256.           method: get
257.           cors:
258.             origins:
259.               - http://example.com
260.               - http://example2.com
261.             headers:
262.               - Content-Type
263.               - X-Amz-Date
264.               - Authorization
265.               - X-Api-Key
266.               - X-Amz-Security-Token
267.               - X-Amz-User-Agent
268.             allowCredentials: false
269. ```
270. 
271. Wildcards are accepted. The following example will match all sub-domains of example.com over http:
272. 
273. ```yml
274. cors:
275.   origins:
276.     - http://*.example.com
277.     - http://example2.com
278. ```
279. 
280. Please note that since you can't send multiple values for [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), this configuration uses a response template to check if the request origin matches one of your provided `
281. origins` and overrides the header with the following code:
282. 
283. ```
284. #set($origin = $input.params("Origin")
285. #if($origin == "http://example.com" || $origin == "http://*.amazonaws.com") #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end
286. ```
287. 
288. Configuring the `cors` property sets [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), [Access-Control-Allow-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers), [Access-Control-Allow-Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods),[Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) headers in the CORS preflight response.
289. 
290. If you use the lambda integration, the Access-Control-Allow-Origin and Access-Control-Allow-Credentials will also be provided to the method and integration responses.
291. 
292. Please note that the [Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)-Header is omitted when not explicitly set to `true`.
293. 
294. To enable the `Access-Control-Max-Age` preflight response header, set the `maxAge` property in the `cors` object:
295. 
296. ```yml
297. functions:
298.   hello:
299.     handler: handler.hello
300.     events:
301.       - http:
302.           path: hello
303.           method: get
304.           cors:
305.             origin: '*'
306.             maxAge: 86400
307. ```
308. 
309. If you are using CloudFront or another CDN for your API Gateway, you may want to setup a `Cache-Control` header to allow for OPTIONS request to be cached to avoid the additional hop.
310. 
311. To enable the `Cache-Control` header on preflight response, set the `cacheControl` property in the `cors` object:
312. 
313. ```yml
314. functions:
315.   hello:
316.     handler: handler.hello
317.     events:
318.       - http:
319.           path: hello
320.           method: get
321.           cors:
322.             origin: '*'
323.             headers:
324.               - Content-Type
325.               - X-Amz-Date
326.               - Authorization
327.               - X-Api-Key
328.               - X-Amz-Security-Token
329.               - X-Amz-User-Agent
330.             allowCredentials: false
331.             cacheControl: 'max-age=600, s-maxage=600, proxy-revalidate' # Caches on browser and proxy for 10 minutes and doesnt allow proxy to serve out of date content
332. ```
333. 
334. CORS header accepts single value too
335. 
336. ```yml
337. functions:
338.   hello:
339.     handler: handler.hello
340.     events:
341.       - http:
342.           path: hello
343.           method: get
344.           cors:
345.             headers: '*'
346. ```
347. 
348. If you want to use CORS with the lambda-proxy integration, remember to include the `Access-Control-Allow-*` headers in your headers object, like this:
349. 
350. ```javascript
351. // handler.js
352. 
353. 'use strict';
354. 
355. module.exports.hello = function(event, context, callback) {
356.   const response = {
357.     statusCode: 200,
358.     headers: {
359.       'Access-Control-Allow-Origin': '*', // Required for CORS support to work
360.       'Access-Control-Allow-Credentials': true, // Required for cookies, authorization headers with HTTPS
361.     },
362.     body: JSON.stringify({ message: 'Hello World!' }),
363.   };
364. 
365.   callback(null, response);
366. };
367. ```
368. 
369. ### HTTP Endpoints with `AWS_IAM` Authorizers
370. 
371. If you want to require that the caller submit the IAM user's access keys in order to be authenticated to invoke your Lambda Function, set the authorizer to `AWS_IAM` as shown in the following example:
372. 
373. ```yml
374. functions:
375.   create:
376.     handler: posts.create
377.     events:
378.       - http:
379.           path: posts/create
380.           method: post
381.           authorizer: aws_iam
382. ```
383. 
384. Which is the short hand notation for:
385. 
386. ```yml
387. functions:
388.   create:
389.     handler: posts.create
390.     events:
391.       - http:
392.           path: posts/create
393.           method: post
394.           authorizer:
395.             type: aws_iam
396. ```
397. 
398. ### HTTP Endpoints with Custom Authorizers
399. 
400. Custom Authorizers allow you to run an AWS Lambda Function before your targeted AWS Lambda Function. This is useful for Microservice Architectures or when you simply want to do some Authorization before running your business logic.
401. 
402. You can enable Custom Authorizers for your HTTP endpoint by setting the Authorizer in your `http` event to another function
403. in the same service, as shown in the following example:
404. 
405. ```yml
406. functions:
407.   create:
408.     handler: posts.create
409.     events:
410.       - http:
411.           path: posts/create
412.           method: post
413.           authorizer: authorizerFunc
414.   authorizerFunc:
415.     handler: handler.authorizerFunc
416. ```
417. 
418. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
419. shown in the following example:
420. 
421. ```yml
422. functions:
423.   create:
424.     handler: posts.create
425.     events:
426.       - http:
427.           path: posts/create
428.           method: post
429.           authorizer:
430.             name: authorizerFunc
431.             resultTtlInSeconds: 0
432.             identitySource: method.request.header.Authorization
433.             identityValidationExpression: someRegex
434.             type: token
435.   authorizerFunc:
436.     handler: handler.authorizerFunc
437. ```
438. 
439. If the Authorizer function does not exist in your service but exists in AWS, you can provide the ARN of the Lambda
440. function instead of the function name, as shown in the following example:
441. 
442. ```yml
443. functions:
444.   create:
445.     handler: posts.create
446.     events:
447.       - http:
448.           path: posts/create
449.           method: post
450.           authorizer: xxx:xxx:Lambda-Name
451. ```
452. 
453. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
454. shown in the following example:
455. 
456. ```yml
457. functions:
458.   create:
459.     handler: posts.create
460.     events:
461.       - http:
462.           path: posts/create
463.           method: post
464.           authorizer:
465.             arn: xxx:xxx:Lambda-Name
466.             managedExternally: false
467.             resultTtlInSeconds: 0
468.             identitySource: method.request.header.Authorization
469.             identityValidationExpression: someRegex
470. ```
471. 
472. If permissions for the Authorizer function are managed externally (for example, if the Authorizer function exists
473. in a different AWS account), you can skip creating the permission for the function by setting `managedExternally: true`,
474. as shown in the following example:
475. 
476. ```yml
477. functions:
478.   create:
479.     handler: posts.create
480.     events:
481.       - http:
482.           path: posts/create
483.           method: post
484.           authorizer:
485.             arn: xxx:xxx:Lambda-Name
486.             managedExternally: true
487. ```
488. 
489. **IMPORTANT NOTE**: The permission allowing the authorizer function to be called by API Gateway must exist
490. before deploying the stack, otherwise deployment will fail.
491. 
492. You can also use the Request Type Authorizer by setting the `type` property. In this case, your `identitySource` could contain multiple entries for your policy cache. The default `type` is 'token'.
493. 
494. ```yml
495. functions:
496.   create:
497.     handler: posts.create
498.     events:
499.       - http:
500.           path: posts/create
501.           method: post


File: docs/providers/aws/events/apigateway.md
Line number range: 372 - 547
Content:
```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer: aws_iam
```

Which is the short hand notation for:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer:
            type: aws_iam
```

### HTTP Endpoints with Custom Authorizers

Custom Authorizers allow you to run an AWS Lambda Function before your targeted AWS Lambda Function. This is useful for Microservice Architectures or when you simply want to do some Authorization before running your business logic.

You can enable Custom Authorizers for your HTTP endpoint by setting the Authorizer in your `http` event to another function
in the same service, as shown in the following example:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer: authorizerFunc
  authorizerFunc:
    handler: handler.authorizerFunc
```

Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
shown in the following example:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer:
            name: authorizerFunc
            resultTtlInSeconds: 0
            identitySource: method.request.header.Authorization
            identityValidationExpression: someRegex
            type: token
  authorizerFunc:
    handler: handler.authorizerFunc
```

If the Authorizer function does not exist in your service but exists in AWS, you can provide the ARN of the Lambda
function instead of the function name, as shown in the following example:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer: xxx:xxx:Lambda-Name
```

Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
shown in the following example:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer:
            arn: xxx:xxx:Lambda-Name
            managedExternally: false
            resultTtlInSeconds: 0
            identitySource: method.request.header.Authorization
            identityValidationExpression: someRegex
```

If permissions for the Authorizer function are managed externally (for example, if the Authorizer function exists
in a different AWS account), you can skip creating the permission for the function by setting `managedExternally: true`,
as shown in the following example:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer:
            arn: xxx:xxx:Lambda-Name
            managedExternally: true
```

**IMPORTANT NOTE**: The permission allowing the authorizer function to be called by API Gateway must exist
before deploying the stack, otherwise deployment will fail.

You can also use the Request Type Authorizer by setting the `type` property. In this case, your `identitySource` could contain multiple entries for your policy cache. The default `type` is 'token'.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer:
            arn: xxx:xxx:Lambda-Name
            resultTtlInSeconds: 0
            identitySource: method.request.header.Authorization, context.identity.sourceIp
            identityValidationExpression: someRegex
            type: request
```

You can also configure an existing Cognito User Pool as the authorizer, as shown
in the following example with optional access token allowed scopes:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          authorizer:
            arn: arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ
            scopes:
              - my-app/read
```

If you are using the default `lambda-proxy` integration, your attributes will be
exposed at `event.requestContext.authorizer.claims`.

If you want more control over which attributes are exposed as claims you
can switch to `integration: lambda` and add the following configuration. The
claims will be exposed at `events.cognitoPoolClaims`.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          integration: lambda
          authorizer:
            arn: arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ
            claims:
              - email
              - nickname
```


File: docs/providers/aws/events/apigateway.md
Line number range: 533 - 658
Content:
```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          integration: lambda
          authorizer:
            arn: arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ
            claims:
              - email
              - nickname
```

If you are creating the Cognito User Pool in the `resources` section of the same template, you can refer to the ARN using the `Fn::GetAtt` attribute from CloudFormation. To do so, you _must_ give your authorizer a name and specify a type of `COGNITO_USER_POOLS`:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          integration: lambda
          authorizer:
            name: MyAuthorizer
            type: COGNITO_USER_POOLS
            arn:
              Fn::GetAtt:
                - CognitoUserPool
                - Arn
---
resources:
  Resources:
    CognitoUserPool:
      Type: 'AWS::Cognito::UserPool'
      Properties: ...
```

### HTTP Endpoints with `operationId`

Include `operationId` when you want to provide a name for the method endpoint. This will set `OperationName` inside `AWS::ApiGateway::Method` accordingly. One common use case for this is customizing method names in some code generators (e.g., swagger).

```yml
functions:
  create:
    handler: users.create
    events:
      - http:
          path: users/create
          method: post
          operationId: createUser
```

### Using asynchronous integration

Use `async: true` when integrating a lambda function using [event invocation](https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html#SSS-Invoke-request-InvocationType). This lets API Gateway to return immediately with a 200 status code while the lambda continues running. If not otherwise specified integration type will be `AWS`.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          async: true # default is false
```

### Catching Exceptions In Your Lambda Function

In case an exception is thrown in your lambda function AWS will send an error message with `Process exited before completing request`. This will be caught by the regular expression for the 500 HTTP status and the 500 status will be returned.

### Setting API keys for your Rest API

You can specify a list of API keys to be used by your service Rest API by adding an `apiKeys` array property to the
`provider` object in `serverless.yml`. You'll also need to explicitly specify which endpoints are `private` and require
one of the api keys to be included in the request by adding a `private` boolean property to the `http` event object you
want to set as private. API Keys are created globally, so if you want to deploy your service to different stages make sure
your API key contains a stage variable as defined below. When using API keys, you can optionally define usage plan quota
and throttle, using `usagePlan` object.

When setting the value, you need to be aware that changing value will require replacement and CloudFormation doesn't allow
two API keys with the same name. It means that you need to change the name also when changing the value. If you don't care
about the name of the key, it is recommended only to set the value and let CloudFormation name the key.

Here's an example configuration for setting API keys for your service Rest API:

```yml
service: my-service
provider:
  name: aws
  apiKeys:
    - myFirstKey
    - ${opt:stage}-myFirstKey
    - ${env:MY_API_KEY} # you can hide it in a serverless variable
    - name: myThirdKey
      value: myThirdKeyValue
    - value: myFourthKeyValue # let cloudformation name the key (recommended when setting api key value)
      description: Api key description # Optional
      customerId: A string that will be set as the customerID for the key # Optional
  usagePlan:
    quota:
      limit: 5000
      offset: 2
      period: MONTH
    throttle:
      burstLimit: 200
      rateLimit: 100
functions:
  hello:
    events:
      - http:
          path: user/create
          method: get
          private: true
```

Please note that those are the API keys names, not the actual values. Once you deploy your service, the value of those API keys will be auto generated by AWS and printed on the screen for you to use. The values can be concealed from the output with the `--conceal` deploy option.

Clients connecting to this Rest API will then need to set any of these API keys values in the `x-api-key` header of their request. This is only necessary for functions where the `private` property is set to true.

You can also setup multiple usage plans for your API. In this case you need to map your usage plans to your api keys. Here's an example how this might look like:


File: docs/providers/aws/events/apigateway.md
Line number range: 656 - 833
Content:
Clients connecting to this Rest API will then need to set any of these API keys values in the `x-api-key` header of their request. This is only necessary for functions where the `private` property is set to true.

You can also setup multiple usage plans for your API. In this case you need to map your usage plans to your api keys. Here's an example how this might look like:

```yml
service: my-service
provider:
  name: aws
  apiKeys:
    - free:
        - myFreeKey
        - ${opt:stage}-myFreeKey
    - paid:
        - myPaidKey
        - ${opt:stage}-myPaidKey
  usagePlan:
    - free:
        quota:
          limit: 5000
          offset: 2
          period: MONTH
        throttle:
          burstLimit: 200
          rateLimit: 100
    - paid:
        quota:
          limit: 50000
          offset: 1
          period: MONTH
        throttle:
          burstLimit: 2000
          rateLimit: 1000
functions:
  hello:
    events:
      - http:
          path: user/create
          method: get
          private: true
```

### Configuring endpoint types

API Gateway [supports regional endpoints](https://aws.amazon.com/about-aws/whats-new/2017/11/amazon-api-gateway-supports-regional-api-endpoints/) for associating your API Gateway REST APIs with a particular region. This can reduce latency if your requests originate from the same region as your REST API and can be helpful in building multi-region applications.

By default, the Serverless Framework deploys your REST API using the EDGE endpoint configuration. If you would like to use the REGIONAL or PRIVATE configuration, set the `endpointType` parameter in your `provider` block.

Here's an example configuration for setting the endpoint configuration for your service Rest API:

```yml
service: my-service
provider:
  name: aws
  endpointType: REGIONAL
functions:
  hello:
    events:
      - http:
          path: user/create
          method: get
```

API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:

```
https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com
```

Here's an example configuration:

```yml
service: my-service
provider:
  name: aws
  endpointType: PRIVATE
  vpcEndpointIds:
    - vpce-123
    - vpce-456
```

### Request Parameters

To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            parameters:
              querystrings:
                url: true
              headers:
                foo: false
              paths:
                bar: false
```

In order for path variables to work, API Gateway also needs them in the method path itself, like so:

```yml
functions:
  create:
    handler: posts.post_detail
    events:
      - http:
          path: posts/{id}
          method: get
          request:
            parameters:
              paths:
                id: true
```

To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.

```yml
functions:
  create:
    handler: posts.post_detail
    events:
      - http:
          path: posts/{id}
          method: get
          request:
            parameters:
              paths:
                id: true
              headers:
                custom-header:
                  required: true
                  mappedValue: context.requestId
```

For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)

### Request Schema Validators

To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)
for your content type. Since JSON Schema is represented in JSON, it's easier to include it from a
file.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            schema:
              application/json: ${file(create_request.json)}
```

A sample schema contained in `create_request.json` might look something like this:

```json
{
  "definitions": {},
  "$schema": "http://json-schema.org/draft-04/schema#",
  "type": "object",
  "title": "The Root Schema",
  "required": ["username"],
  "properties": {
    "username": {
      "type": "string",
      "title": "The Foo Schema",
      "default": "",
      "pattern": "^[a-zA-Z0-9]+$"
    }
  }
}
```


File: docs/providers/aws/events/apigateway.md
Line number range: 815 - 975
Content:
A sample schema contained in `create_request.json` might look something like this:

```json
{
  "definitions": {},
  "$schema": "http://json-schema.org/draft-04/schema#",
  "type": "object",
  "title": "The Root Schema",
  "required": ["username"],
  "properties": {
    "username": {
      "type": "string",
      "title": "The Foo Schema",
      "default": "",
      "pattern": "^[a-zA-Z0-9]+$"
    }
  }
}
```

**NOTE:** schema validators are only applied to content types you specify. Other content types are
not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.

### Setting source of API key for metering requests

API Gateway provide a feature for metering your API's requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request's X-API-Key header, set option like this:

```yml
service: my-service
provider:
  name: aws
  apiGateway:
    apiKeySourceType: HEADER
functions:
  hello:
    events:
      - http:
          path: hello
          method: get
```

Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.

```yml
service: my-service
provider:
  name: aws
  apiGateway:
    apiKeySourceType: AUTHORIZER
functions:
  hello:
    events:
      - http:
          path: hello
          method: get
```

## Lambda Integration

This method is more complicated and involves a lot more configuration of the `http` event syntax.

### Example "LAMBDA" event (before customization)

**Refer to this only if you're using the non-default `LAMBDA` integration method**

```json
{
  "body": {},
  "method": "GET",
  "principalId": "",
  "stage": "dev",
  "cognitoPoolClaims": {
    "sub": ""
  },
  "enhancedAuthContext": {},
  "headers": {
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
    "Accept-Encoding": "gzip, deflate, br",
    "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
    "CloudFront-Forwarded-Proto": "https",
    "CloudFront-Is-Desktop-Viewer": "true",
    "CloudFront-Is-Mobile-Viewer": "false",
    "CloudFront-Is-SmartTV-Viewer": "false",
    "CloudFront-Is-Tablet-Viewer": "false",
    "CloudFront-Viewer-Country": "GB",
    "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",
    "upgrade-insecure-requests": "1",
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
    "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",
    "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",
    "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",
    "X-Forwarded-For": "94.117.120.169, 116.132.62.73",
    "X-Forwarded-Port": "443",
    "X-Forwarded-Proto": "https"
  },
  "query": {},
  "path": {},
  "identity": {
    "cognitoIdentityPoolId": "",
    "accountId": "",
    "cognitoIdentityId": "",
    "caller": "",
    "apiKey": "",
    "sourceIp": "94.197.120.169",
    "accessKey": "",
    "cognitoAuthenticationType": "",
    "cognitoAuthenticationProvider": "",
    "userArn": "",
    "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
    "user": ""
  },
  "stageVariables": {},
  "requestPath": "/request/path"
}
```

### Request templates

#### Default Request Templates

Serverless ships with the following default request templates you can use out of the box:

1. `application/json`
2. `application/x-www-form-urlencoded`

Both templates give you access to the following properties you can access with the help of the `event` object:

- body
- method
- principalId
- stage
- headers
- queryStringParameters
- path
- identity
- stageVariables
- requestPath

#### Custom Request Templates

However you can define and use your own request templates as follows (you can even overwrite the default request templates
by defining a new request template for an existing content type):

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          request:
            template:
              text/xhtml: '{ "stage" : "$context.stage" }'
              application/json: '{ "httpMethod" : "$context.httpMethod" }'
```

**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.

**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.


File: docs/providers/aws/events/apigateway.md
Line number range: 973 - 1081
Content:
**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.

**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.

If you want to map querystrings to the event object, you can use the `$input.params('hub.challenge')` syntax from API Gateway, as follows:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          request:
            template:
              application/json: '{ "foo" : "$input.params(''bar'')" }'
```

**Note:** Notice when using single-quoted strings, any single quote `'` inside its contents must be doubled (`''`) to escape it.
You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.
If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).

#### Pass Through Behavior

[API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.

You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          request:
            passThrough: NEVER
```

There are 3 available options:

| Value             | Passed Through When                          | Rejected When                                                          |
| ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |
| NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |
| WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |
| WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |

See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.

**Notes:**

- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
- API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)

### Responses

Serverless lets you setup custom headers and a response template for your `http` event.

#### Custom Response Headers

Here's an example which shows you how you can setup a custom response header:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          response:
            headers:
              Content-Type: integration.response.header.Content-Type
              Cache-Control: "'max-age=120'"
```

**Note:** You're able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)
for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header
as `"'max-age=120'"` means API Gateway will receive the value as `'max-age=120'` (enclosed with single quotes).

#### Custom Response Templates

Sometimes you'll want to define a custom response template API Gateway should use to transform your lambdas output.
Here's an example which will transform the return value of your lambda so that the browser renders it as HTML:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          response:
            headers:
              Content-Type: "'text/html'"
            template: $input.path('$')
```

**Note:** The template is defined as plain text here. However you can also reference an external file with the help of
the `${file(templatefile)}` syntax.

### Status Codes


File: docs/providers/aws/events/apigateway.md
Line number range: 1063 - 1186
Content:
```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          response:
            headers:
              Content-Type: "'text/html'"
            template: $input.path('$')
```

**Note:** The template is defined as plain text here. However you can also reference an external file with the help of
the `${file(templatefile)}` syntax.

### Status Codes

Serverless ships with default status codes you can use to e.g. signal that a resource could not be found (404) or that
the user is not authorized to perform the action (401). Those status codes are regex definitions that will be added to your API Gateway configuration.

**_Note:_** Status codes as documented in this chapter relate to `lambda` integration method (as documented at the top of this page). If using default integration method `lambda-proxy` object with status code and message should be returned as in the example below:

```javascript
module.exports.hello = (event, context, callback) => {
  callback(null, { statusCode: 404, body: 'Not found', headers: { 'Content-Type': 'text/plain' } });
};
```

#### Available Status Codes

| Status Code | Meaning               |
| ----------- | --------------------- |
| 400         | Bad Request           |
| 401         | Unauthorized          |
| 403         | Forbidden             |
| 404         | Not Found             |
| 422         | Unprocessable Entity  |
| 500         | Internal Server Error |
| 502         | Bad Gateway           |
| 504         | Gateway Timeout       |

#### Using Status Codes

To return a given status code you simply need to add square brackets with the status code of your choice to your
returned message like this: `[401] You are not authorized to access this resource!`.

Here's an example which shows you how you can raise a 404 HTTP status from within your lambda function.

```javascript
module.exports.hello = (event, context, callback) => {
  callback(new Error('[404] Not found'));
};
```

#### Custom Status Codes

You can override the defaults status codes supplied by Serverless. You can use this to change the default status code, add/remove status codes, or change the templates and headers used for each status code. Use the pattern key to change the selection process that dictates what code is returned.

If you specify a status code with a pattern of '' that will become the default response code. See below on how to change the default to 201 for post requests.

If you omit any default status code. A standard default 200 status code will be generated for you.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: post
          path: whatever
          integration: lambda
          response:
            headers:
              Content-Type: "'text/html'"
            template: $input.path('$')
            statusCodes:
              201:
                pattern: '' # Default response method
              409:
                pattern: '.*"statusCode":409,.*' # JSON response
                template: $input.path("$.errorMessage") # JSON return object
                headers:
                  Content-Type: "'application/json+hal'"
```

You can also create varying response templates for each code and content type by creating an object with the key as the content type

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: post
          path: whatever
          integration: lambda
          response:
            headers:
              Content-Type: "'text/html'"
            template: $input.path('$')
            statusCodes:
              201:
                pattern: '' # Default response method
              409:
                pattern: '.*"statusCode":409,.*' # JSON response
                template:
                  application/json: $input.path("$.errorMessage") # JSON return object
                  application/xml: $input.path("$.body.errorMessage") # XML return object
                headers:
                  Content-Type: "'application/json+hal'"
```

## Setting an HTTP Proxy on API Gateway

To set up an HTTP proxy, you'll need two CloudFormation templates, one for the endpoint (known as resource in CF), and
one for method. These two templates will work together to construct your proxy. So if you want to set `your-app.com/serverless` as a proxy for `serverless.com`, you'll need the following two templates in your `serverless.yml`:

```yml
service: service-name
provider: aws
functions: ...


File: docs/providers/aws/events/apigateway.md
Line number range: 1178 - 1322
Content:
## Setting an HTTP Proxy on API Gateway

To set up an HTTP proxy, you'll need two CloudFormation templates, one for the endpoint (known as resource in CF), and
one for method. These two templates will work together to construct your proxy. So if you want to set `your-app.com/serverless` as a proxy for `serverless.com`, you'll need the following two templates in your `serverless.yml`:

```yml
service: service-name
provider: aws
functions: ...

resources:
  Resources:
    ProxyResource:
      Type: AWS::ApiGateway::Resource
      Properties:
        ParentId:
          Fn::GetAtt:
            - ApiGatewayRestApi # our default Rest API logical ID
            - RootResourceId
        PathPart: serverless # the endpoint in your API that is set as proxy
        RestApiId:
          Ref: ApiGatewayRestApi
    ProxyMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        ResourceId:
          Ref: ProxyResource
        RestApiId:
          Ref: ApiGatewayRestApi
        HttpMethod: GET # the method of your proxy. Is it GET or POST or ... ?
        MethodResponses:
          - StatusCode: 200
        Integration:
          IntegrationHttpMethod: POST
          Type: HTTP
          Uri: http://serverless.com # the URL you want to set a proxy to
          IntegrationResponses:
            - StatusCode: 200
```

There's a lot going on in these two templates, but all you need to know to set up a simple proxy is setting the method &
endpoint of your proxy, and the URI you want to set a proxy to.

Now that you have these two CloudFormation templates defined in your `serverless.yml` file, you can simply run
`serverless deploy` and that will deploy these custom resources for you along with your service and set up a proxy on your Rest API.

## Accessing private resources using VPC Link

If you have an Edge Optimized or Regional API Gateway, you can access the internal VPC resources using VPC Link. Please refer [AWS documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-private-integration.html) to know more about API Gateway private integration.

We can use following configuration to have an http-proxy vpc-link integration.

```yml
- http:
    path: v1/repository
    method: get
    integration: http-proxy
    connectionType: vpc-link
    connectionId: '{your-vpc-link-id}'
    cors: true
    request:
      uri: http://www.github.com/v1/repository
      method: get
```

## Mock Integration

Mocks allow developers to offer simulated methods for an API, with this, responses can be defined directly, without the need for a integration backend. A simple mock response example is provided below:

```yml
functions:
  hello:
    handler: handler.hello
    events:
      - http:
          path: hello
          cors: true
          method: get
          integration: mock
          request:
            template:
              application/json: '{"statusCode": 200}'
          response:
            template: $input.path('$')
            statusCodes:
              201:
                pattern: ''
```

## Share API Gateway and API Resources

As your application grows, you will likely need to break it out into multiple, smaller services. By default, each Serverless project generates a new API Gateway. However, you can share the same API Gateway between multiple projects by referencing its REST API ID and Root Resource ID in `serverless.yml` as follows:

```yml
service: service-name
provider:
  name: aws
  apiGateway:
    restApiId: xxxxxxxxxx # REST API resource ID. Default is generated by the framework
    restApiRootResourceId: xxxxxxxxxx # Root resource, represent as / path
    websocketApiId: xxxxxxxxxx # Websocket API resource ID. Default is generated by the framework
    description: Some Description # optional - description of deployment history

functions: ...
```

If your application has many nested paths, you might also want to break them out into smaller services.

```yml
service: service-a
provider:
  apiGateway:
    restApiId: xxxxxxxxxx
    restApiRootResourceId: xxxxxxxxxx
    websocketApiId: xxxxxxxxxx
    description: Some Description

functions:
  create:
    handler: posts.create
    events:
      - http:
          method: post
          path: /posts
```

```yml
service: service-b
provider:
  apiGateway:
    restApiId: xxxxxxxxxx
    restApiRootResourceId: xxxxxxxxxx
    websocketApiId: xxxxxxxxxx
    description: Some Description

functions:
  create:
    handler: posts.createComment
    events:
      - http:
          method: post
          path: /posts/{id}/comments
```

The above example services both reference the same parent path `/posts`. However, Cloudformation will throw an error if we try to generate an existing path resource. To avoid that, we reference the resource ID of `/posts`:


File: docs/providers/aws/events/apigateway.md
Line number range: 1313 - 1501
Content:
functions:
  create:
    handler: posts.createComment
    events:
      - http:
          method: post
          path: /posts/{id}/comments
```

The above example services both reference the same parent path `/posts`. However, Cloudformation will throw an error if we try to generate an existing path resource. To avoid that, we reference the resource ID of `/posts`:

```yml
service: service-a
provider:
  apiGateway:
    restApiId: xxxxxxxxxx
    restApiRootResourceId: xxxxxxxxxx
    websocketApiId: xxxxxxxxxx
    description: Some Description
    restApiResources:
      posts: xxxxxxxxxx

functions: ...
```

```yml
service: service-b
provider:
  apiGateway:
    restApiId: xxxxxxxxxx
    restApiRootResourceId: xxxxxxxxxx
    websocketApiId: xxxxxxxxxx
    description: Some Description
    restApiResources:
      /posts: xxxxxxxxxx

functions: ...
```

You can define more than one path resource, but by default, Serverless will generate them from the root resource.
`restApiRootResourceId` is optional if a path resource isn't required for the root (`/`).

```yml
service: service-a
provider:
  apiGateway:
    restApiId: xxxxxxxxxx
    # restApiRootResourceId: xxxxxxxxxx # Optional
    websocketApiId: xxxxxxxxxx
    description: Some Description
    restApiResources:
      /posts: xxxxxxxxxx
      /categories: xxxxxxxxx

functions:
  listPosts:
    handler: posts.list
    events:
      - http:
          method: get
          path: /posts

  listCategories:
    handler: categories.list
    events:
      - http:
          method: get
          path: /categories
```

### Easiest and CI/CD friendly example of using shared API Gateway and API Resources.

You can define your API Gateway resource in its own service and export the `restApiId`, `restApiRootResourceId` and `websocketApiId` using cloudformation cross-stack references.

```yml
service: my-api

provider:
  name: aws
  runtime: nodejs12.x
  stage: dev
  region: eu-west-2

resources:
  Resources:
    MyApiGW:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Name: MyApiGW

    MyWebsocketApi:
      Type: AWS::ApiGatewayV2::Api
      Properties:
        Name: MyWebsocketApi
        ProtocolType: WEBSOCKET
        RouteSelectionExpression: '$request.body.action'

  Outputs:
    apiGatewayRestApiId:
      Value:
        Ref: MyApiGW
      Export:
        Name: MyApiGateway-restApiId

    apiGatewayRestApiRootResourceId:
      Value:
        Fn::GetAtt:
          - MyApiGW
          - RootResourceId
      Export:
        Name: MyApiGateway-rootResourceId

    websocketApiId:
      Value:
        Ref: MyWebsocketApi
      Export:
        Name: MyApiGateway-websocketApiId
```

This creates API gateway and then exports the `restApiId`, `rootResourceId` and `websocketApiId` values using cloudformation cross stack output.
We will import this and reference in future services.

```yml
service: service-a

provider:
  apiGateway:
    restApiId:
      'Fn::ImportValue': MyApiGateway-restApiId
    restApiRootResourceId:
      'Fn::ImportValue': MyApiGateway-rootResourceId
    websocketApiId:
      'Fn::ImportValue': MyApiGateway-websocketApiId

functions: service-a-functions
```

```yml
service: service-b

provider:
  apiGateway:
    restApiId:
      'Fn::ImportValue': MyApiGateway-restApiId
    restApiRootResourceId:
      'Fn::ImportValue': MyApiGateway-rootResourceId
    websocketApiId:
      'Fn::ImportValue': MyApiGateway-websocketApiId

functions: service-b-functions
```

You can use this method to share your API Gateway across services in same region. Read about this limitation [here](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html).

**Note:** We've noticed you can't use provider.tags together with `Fn::ImportValue` for `restApiId` and `restApiRootResourceId`. Doing so won't resolve the imported value, and therefore returns an error.

### Manually Configuring shared API Gateway

Use AWS console on browser, navigate to the API Gateway console. Select your already existing API Gateway.
Top Navbar should look like this

```
    APIs>apigateway-Name (xxxxxxxxxx)>Resources>/ (yyyyyyyyyy)
```

Here xxxxxxxxx is your restApiId and yyyyyyyyyy the restApiRootResourceId.

#### Note while using authorizers with shared API Gateway

AWS API Gateway allows only 1 Authorizer for 1 ARN, This is okay when you use conventional serverless setup, because each stage and service will create different API Gateway. But this can cause problem when using authorizers with shared API Gateway. If we use the same authorizer directly in different services like this.

```yml
service: service-c

provider:
  apiGateway:
    restApiId:
      'Fn::ImportValue': apiGateway-restApiId
    restApiRootResourceId:
      'Fn::ImportValue': apiGateway-rootResourceId

functions:
  deleteUser:
    events:
      - http:
        path: /users/{userId}
        authorizer:
          arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
```


File: docs/providers/aws/events/apigateway.md
Line number range: 1484 - 1638
Content:
```yml
service: service-c

provider:
  apiGateway:
    restApiId:
      'Fn::ImportValue': apiGateway-restApiId
    restApiRootResourceId:
      'Fn::ImportValue': apiGateway-rootResourceId

functions:
  deleteUser:
    events:
      - http:
        path: /users/{userId}
        authorizer:
          arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
```

```yml
service: service-d

provider:
  apiGateway:
    restApiId:
      'Fn::ImportValue': apiGateway-restApiId
    restApiRootResourceId:
      'Fn::ImportValue': apiGateway-rootResourceId

functions:
  deleteProject:
    events:
      - http:
        path: /project/{projectId}
        authorizer:
          arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
```

we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).

A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.

## Share Authorizer

Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.

```yml
functions:
  createUser:
     ...
    events:
      - http:
          path: /users
          ...
          authorizer:
            # Provide both type and authorizerId
            type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
            authorizerId:
              Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID
            scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS
              - myapp/myscope

  deleteUser:
     ...
    events:
      - http:
          path: /users/{userId}
          ...
          # Provide both type and authorizerId
          type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
          authorizerId:
            Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID

resources:
  Resources:
    ApiGatewayAuthorizer:
      Type: AWS::ApiGateway::Authorizer
      Properties:
        AuthorizerResultTtlInSeconds: 300
        IdentitySource: method.request.header.Authorization
        Name: Cognito
        RestApiId:
          Ref: YourApiGatewayName
        Type: COGNITO_USER_POOLS
        ProviderARNs:
          - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef

```

## Resource Policy

Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.

```yml
provider:
  name: aws
  runtime: nodejs12.x

  resourcePolicy:
    - Effect: Allow
      Principal: '*'
      Action: execute-api:Invoke
      Resource:
        - execute-api:/*/*/*
      Condition:
        IpAddress:
          aws:SourceIp:
            - '123.123.123.123'
```

## Compression

API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).

```yml
provider:
  name: aws
  apiGateway:
    minimumCompressionSize: 1024
```

## Binary Media Types

API Gateway makes it possible to return binary media such as images or files as responses.

Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:

```yml
provider:
  apiGateway:
    binaryMediaTypes:
      - '*/*'
```

In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.

To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            contentHandling: CONVERT_TO_TEXT
          response:
            contentHandling: CONVERT_TO_TEXT
```

## Detailed CloudWatch Metrics

Use the following configuration to enable detailed CloudWatch Metrics:


File: docs/providers/aws/events/apigateway.md
Line number range: 1622 - 1774
Content:
```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            contentHandling: CONVERT_TO_TEXT
          response:
            contentHandling: CONVERT_TO_TEXT
```

## Detailed CloudWatch Metrics

Use the following configuration to enable detailed CloudWatch Metrics:

```yml
provider:
  apiGateway:
    metrics: true
```

## AWS X-Ray Tracing

API Gateway supports a form of out of the box distributed tracing via [AWS X-Ray](https://aws.amazon.com/xray/) though enabling [active tracing](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-xray.html). To enable this feature for your serverless application's API Gateway add the following to your `serverless.yml`

```yml
# serverless.yml

provider:
  name: aws
  tracing:
    apiGateway: true
```

## Tags / Stack Tags

API Gateway stages will be tagged with the `tags` and `stackTags` values defined at the `provider` level:

```yml
# serverless.yml

provider:
  name: aws
  stackTags:
    stackTagKey: stackTagValue
  tags:
    tagKey: tagValue
```

## Logs

Use the following configuration to enable API Gateway logs:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi: true
```

The log streams will be generated in a dedicated log group which follows the naming schema `/aws/api-gateway/{service}-{stage}`.

To be able to write logs, API Gateway [needs a CloudWatch role configured](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html). This setting is per region, shared by all the APIs. There are three approaches for handling it:

- Let Serverless create and assign an IAM role for you (default behavior). Note that since this is a shared setting, this role is not removed when you remove the deployment.
- Let Serverless assign an existing IAM role that you created before the deployment, if not already assigned:

  ```yml
  # serverless.yml
  provider:
    logs:
      restApi:
        role: arn:aws:iam::123456:role
  ```

- Do not let Serverless manage the CloudWatch role configuration. In this case, you would create and assign the IAM role yourself, e.g. in a separate "account setup" deployment:

  ```yml
  provider:
    logs:
      restApi:
        roleManagedExternally: true # disables automatic role creation/checks done by Serverless
  ```

**Note:** Serverless configures the API Gateway CloudWatch role setting using a custom resource lambda function. If you're using `cfnRole` to specify a limited-access IAM role for your serverless deployment, the custom resource lambda will assume this role during execution.

By default, API Gateway access logs will use the following format:

```
'requestId: $context.requestId, ip: $context.identity.sourceIp, caller: $context.identity.caller, user: $context.identity.user, requestTime: $context.requestTime, httpMethod: $context.httpMethod, resourcePath: $context.resourcePath, status: $context.status, protocol: $context.protocol, responseLength: $context.responseLength'
```

You can specify your own [format for API Gateway Access Logs](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html#apigateway-cloudwatch-log-formats) by including your preferred string in the `format` property:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      format: '{ "requestId":"$context.requestId",   "ip": "$context.identity.sourceIp" }'
```

The default API Gateway log level will be INFO. You can change this to error with the following:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      level: ERROR
```

Valid values are INFO, ERROR.

If you want to disable access logging completly you can do with the following:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      accessLogging: true
```

By default, the full requests and responses data will be logged. If you want to disable like so:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      fullExecutionData: false
```

Websockets have the same configuration options as the the REST API. Example:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    websoocket:
      level: INFO
      fullExecutionData: false
```


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 1 - 261
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. const DEFAULT_COMMON_TEMPLATE = `
6.   #define( $loop )
7.     {
8.     #foreach($key in $map.keySet())
9.         #set( $k = $util.escapeJavaScript($key) )
10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\'", "'") )
11.         "$k":
12.           "$v"
13.           #if( $foreach.hasNext ) , #end
14.     #end
15.     }
16.   #end
17. 
18.   {
19.     "body": $body,
20.     "method": "$context.httpMethod",
21.     "principalId": "$context.authorizer.principalId",
22.     "stage": "$context.stage",
23. 
24.     "cognitoPoolClaims" : {
25.        extraCognitoPoolClaims
26.        "sub": "$context.authorizer.claims.sub"
27.     },
28. 
29.     #set( $map = $context.authorizer )
30.     "enhancedAuthContext": $loop,
31. 
32.     #set( $map = $input.params().header )
33.     "headers": $loop,
34. 
35.     #set( $map = $input.params().querystring )
36.     "query": $loop,
37. 
38.     #set( $map = $input.params().path )
39.     "path": $loop,
40. 
41.     #set( $map = $context.identity )
42.     "identity": $loop,
43. 
44.     #set( $map = $stageVariables )
45.     "stageVariables": $loop,
46. 
47.     "requestPath": "$context.resourcePath"
48.   }
49. `;
50. 
51. module.exports = {
52.   getMethodIntegration(http, { lambdaLogicalId, lambdaAliasName }) {
53.     const type = http.integration || 'AWS_PROXY';
54.     const integration = {
55.       IntegrationHttpMethod: 'POST',
56.       Type: type,
57.     };
58. 
59.     // Valid integrations are:
60.     // * `HTTP` for integrating with an HTTP back end,
61.     // * `AWS` for any AWS service endpoints,
62.     // * `MOCK` for testing without actually invoking the back end,
63.     // * `HTTP_PROXY` for integrating with the HTTP proxy integration, or
64.     // * `AWS_PROXY` for integrating with the Lambda proxy integration type (the default)
65.     if (type === 'AWS' || type === 'AWS_PROXY') {
66.       Object.assign(integration, {
67.         Uri: {
68.           'Fn::Join': [
69.             '',
70.             [
71.               'arn:',
72.               { Ref: 'AWS::Partition' },
73.               ':apigateway:',
74.               { Ref: 'AWS::Region' },
75.               ':lambda:path/2015-03-31/functions/',
76.               ...[],
77.               { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
78.               ...(lambdaAliasName ? [':', lambdaAliasName] : []),
79.               '/invocations',
80.             ],
81.           ],
82.         },
83.       });
84.     } else if (type === 'HTTP' || type === 'HTTP_PROXY') {
85.       const integrationHttpMethod = (http.request && http.request.method) || http.method;
86.       Object.assign(integration, {
87.         Uri: http.request && http.request.uri,
88.         IntegrationHttpMethod: integrationHttpMethod.toUpperCase(),
89.       });
90.       if (http.connectionType) {
91.         Object.assign(integration, {
92.           ConnectionType: http.connectionType,
93.           ConnectionId: http.connectionId,
94.         });
95.       }
96.     } else if (type === 'MOCK') {
97.       // nothing to do but kept here for reference
98.     }
99. 
100.     if (type === 'AWS' || type === 'HTTP' || type === 'MOCK') {
101.       Object.assign(integration, {
102.         PassthroughBehavior: http.request && http.request.passThrough,
103.         ContentHandling: http.request && http.request.contentHandling,
104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === 'AWS'),
105.         IntegrationResponses: this.getIntegrationResponses(http),
106.       });
107.     }
108.     if (
109.       ((type === 'AWS' || type === 'HTTP' || type === 'HTTP_PROXY') &&
110.         http.request &&
111.         http.request.parameters &&
112.         Object.keys(http.request.parameters).length) ||
113.       http.async
114.     ) {
115.       Object.assign(integration, {
116.         RequestParameters: this.getIntegrationRequestParameters(http),
117.       });
118.     }
119. 
120.     return {
121.       Properties: {
122.         Integration: integration,
123.       },
124.     };
125.   },
126. 
127.   getIntegrationResponses(http) {
128.     const integrationResponses = [];
129. 
130.     if (http.response) {
131.       const integrationResponseHeaders = [];
132. 
133.       if (http.cors) {
134.         let origin = http.cors.origin;
135. 
136.         // TODO remove once "origins" config is deprecated
137.         if (http.cors.origins && http.cors.origins.length) {
138.           origin = http.cors.origins.join(',');
139.         }
140. 
141.         _.merge(integrationResponseHeaders, {
142.           'Access-Control-Allow-Origin': `'${origin}'`,
143.         });
144. 
145.         // Only set Access-Control-Allow-Credentials when explicitly allowed (omit if false)
146.         if (http.cors.allowCredentials) {
147.           integrationResponseHeaders['Access-Control-Allow-Credentials'] = 'true';
148.         }
149.       }
150. 
151.       if (http.response.headers) {
152.         _.merge(integrationResponseHeaders, http.response.headers);
153.       }
154. 
155.       _.forEach(http.response.statusCodes, (config, statusCode) => {
156.         const responseParameters = _.mapKeys(
157.           integrationResponseHeaders,
158.           (value, header) => `method.response.header.${header}`
159.         );
160. 
161.         const integrationResponse = {
162.           StatusCode: statusCode,
163.           SelectionPattern: config.pattern || '',
164.           ResponseParameters: responseParameters,
165.           ResponseTemplates: {},
166.           ContentHandling: statusCode.startsWith('2') ? http.response.contentHandling : undefined,
167.         };
168. 
169.         if (config.headers) {
170.           _.merge(
171.             integrationResponse.ResponseParameters,
172.             _.mapKeys(config.headers, (value, header) => `method.response.header.${header}`)
173.           );
174.         }
175. 
176.         if (http.response.template) {
177.           _.merge(integrationResponse.ResponseTemplates, {
178.             'application/json': http.response.template,
179.           });
180.         }
181. 
182.         if (config.template) {
183.           const template =
184.             typeof config.template === 'string'
185.               ? { 'application/json': config.template }
186.               : config.template;
187. 
188.           _.merge(integrationResponse.ResponseTemplates, template);
189.         }
190. 
191.         integrationResponses.push(integrationResponse);
192.       });
193.     }
194. 
195.     return integrationResponses;
196.   },
197. 
198.   getIntegrationRequestTemplates(http, useDefaults) {
199.     // default request templates
200.     const integrationRequestTemplates = {};
201. 
202.     // Only set defaults for AWS (lambda) integration
203.     if (useDefaults) {
204.       Object.assign(integrationRequestTemplates, {
205.         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
206.         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
207.       });
208.     }
209. 
210.     // set custom request templates if provided
211.     if (http.request && typeof http.request.template === 'object') {
212.       Object.assign(integrationRequestTemplates, http.request.template);
213.     }
214. 
215.     return Object.keys(integrationRequestTemplates).length
216.       ? integrationRequestTemplates
217.       : undefined;
218.   },
219.   getIntegrationRequestParameters(http) {
220.     const parameters = {};
221.     if (http.request && http.request.parameters) {
222.       _.forEach(http.request.parameters, (value, key) => {
223.         parameters[`integration.${key.substring('method.'.length)}`] = value.mappedValue || key;
224.       });
225.     }
226. 
227.     if (http.async) {
228.       parameters['integration.request.header.X-Amz-Invocation-Type'] = "'Event'";
229.     }
230. 
231.     return parameters;
232.   },
233. 
234.   DEFAULT_JSON_REQUEST_TEMPLATE: `
235.     #set( $body = $input.json("$") )
236. 
237.     ${DEFAULT_COMMON_TEMPLATE}
238.   `,
239. 
240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `
241.     #define( $body )
242.       {
243.       #foreach( $token in $input.path('$').split('&') )
244.         #set( $keyVal = $token.split('=') )
245.         #set( $keyValSize = $keyVal.size() )
246.         #if( $keyValSize >= 1 )
247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )
248.           #if( $keyValSize >= 2 )
249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\'","'"))
250.           #else
251.             #set( $val = '' )
252.           #end
253.           "$key": "$val"#if($foreach.hasNext),#end
254.         #end
255.       #end
256.       }
257.     #end
258. 
259.     ${DEFAULT_COMMON_TEMPLATE}
260.   `,
261. };

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 19:50:32,711 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requirement analysis:\n   - The user requests the full content with line numbers of lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js.\n   - This file contains the implementation for API Gateway method integration including request templates defaults and overrides, which are crucial per extra requirements.\n2. Extended relevance:\n   - The getIntegrationRequestTemplates function and related default templates directly implement how default request mapping templates are set and how custom templates can override them.\n   - Including the entire file (lines 1-261) ensures complete coverage for determining whether removing or overriding default templates is supported.\n', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=1, end_line=261), ContextOutput(reasoning='1. Query requirement analysis:\n   - The user requests the full content with line numbers of docs/providers/aws/events/apigateway.md.\n   - This documentation includes sections about Lambda Integration request templates (Default and Custom), pass-through behavior, and other API Gateway configurations.\n2. Extended relevance:\n   - The request template sections document how defaults can be overridden with custom templates, which is essential to the issue classification purpose.\n   - Providing the entire file ensures all relevant documentation context is available.\n', relative_path='docs/providers/aws/events/apigateway.md', start_line=1, end_line=1774)]
2025-11-13 19:50:32,717 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 2 contexts to memory for query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js and docs/providers/aws/events/apigateway.md
2025-11-13 19:50:36,849 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 19:50:36,850 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 2 new contexts to 0 existing contexts
2025-11-13 19:50:36,850 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 2 total contexts (removed 0 duplicates)
2025-11-13 19:50:36,852 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:


OBJECTIVE: Find ALL self-contained context needed to accurately classify this issue as a bug, feature request, documentation update, or question.

<reasoning>
1. Analyze issue characteristics:
   - Error patterns suggesting bugs
   - New functionality requests
   - Documentation gaps
   - Knowledge-seeking patterns

2. Search strategy:
   - Implementation files matching descriptions
   - Similar existing features
   - Documentation coverage
   - Related Q&A patterns

3. Required context categories:
   - Core implementations
   - Feature interfaces
   - Documentation files
   - Test coverage
   - Configuration settings
   - Issue history
</reasoning>

REQUIREMENTS:
- Context MUST be fully self-contained
- MUST include complete file paths
- MUST include full function/class implementations
- MUST preserve all code structure and formatting
- MUST include line numbers

<examples>
<example id="error-classification">
<issue>
Database queries timing out randomly
Error: Connection pool exhausted
</issue>

<search_targets>
1. Connection pool implementation
2. Database configuration
3. Error handling code
4. Related timeout settings
</search_targets>

<expected_context>
- Complete connection pool class
- Full database configuration
- Error handling implementations
- Timeout management code
</expected_context>
</example>
</examples>

Search priority:
1. Implementation patterns matching issue
2. Feature definitions and interfaces
3. Documentation coverage
4. Configuration schemas
5. Test implementations
6. Integration patterns

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content with line numbers of lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js and docs/providers/aws/events/apigateway.md
Extra Requirements: If integration.js is large, include at minimum the function(s) building requestTemplates defaults and any config handling that disables or overrides them.
Purpose: To determine whether removing or overriding default request mapping templates is currently supported (documented or implemented) and accurately classify the issue.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/apigateway.md
Line number range: 1 - 1774
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - API Gateway
3. menuText: API Gateway
4. menuOrder: 1
5. description: Setting up AWS API Gateway Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/apigateway)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # API Gateway
16. 
17. - [API Gateway](#api-gateway)
18.   - [Lambda Proxy Integration](#lambda-proxy-integration)
19.     - [Simple HTTP Endpoint](#simple-http-endpoint)
20.     - [Example "LAMBDA-PROXY" event (default)](#example-lambda-proxy-event-default)
21.     - [HTTP Endpoint with Extended Options](#http-endpoint-with-extended-options)
22.     - [Enabling CORS](#enabling-cors)
23.     - [HTTP Endpoints with `AWS_IAM` Authorizers](#http-endpoints-with-aws_iam-authorizers)
24.     - [HTTP Endpoints with Custom Authorizers](#http-endpoints-with-custom-authorizers)
25.     - [HTTP Endpoints with `operationId`](#http-endpoints-with-operationId)
26.     - [Catching Exceptions In Your Lambda Function](#catching-exceptions-in-your-lambda-function)
27.     - [Setting API keys for your Rest API](#setting-api-keys-for-your-rest-api)
28.     - [Configuring endpoint types](#configuring-endpoint-types)
29.     - [Request Parameters](#request-parameters)
30.     - [Request Schema Validators](#request-schema-validators)
31.     - [Setting source of API key for metering requests](#setting-source-of-api-key-for-metering-requests)
32.   - [Lambda Integration](#lambda-integration)
33.     - [Example "LAMBDA" event (before customization)](#example-lambda-event-before-customization)
34.     - [Request templates](#request-templates)
35.       - [Default Request Templates](#default-request-templates)
36.       - [Custom Request Templates](#custom-request-templates)
37.       - [Pass Through Behavior](#pass-through-behavior)
38.     - [Responses](#responses)
39.       - [Custom Response Headers](#custom-response-headers)
40.       - [Custom Response Templates](#custom-response-templates)
41.     - [Status Codes](#status-codes)
42.       - [Available Status Codes](#available-status-codes)
43.       - [Using Status Codes](#using-status-codes)
44.       - [Custom Status Codes](#custom-status-codes)
45.   - [Setting an HTTP Proxy on API Gateway](#setting-an-http-proxy-on-api-gateway)
46.   - [Accessing private resources using VPC Link](#accessing-private-resources-using-vpc-link)
47.   - [Mock Integration](#mock-integration)
48.   - [Share API Gateway and API Resources](#share-api-gateway-and-api-resources)
49.     - [Easiest and CI/CD friendly example of using shared API Gateway and API Resources.](#easiest-and-cicd-friendly-example-of-using-shared-api-gateway-and-api-resources)
50.     - [Manually Configuring shared API Gateway](#manually-configuring-shared-api-gateway)
51.       - [Note while using authorizers with shared API Gateway](#note-while-using-authorizers-with-shared-api-gateway)
52.   - [Share Authorizer](#share-authorizer)
53.   - [Resource Policy](#resource-policy)
54.   - [Compression](#compression)
55.   - [Binary Media Types](#binary-media-types)
56.   - [Detailed CloudWatch Metrics](#detailed-cloudwatch-metrics)
57.   - [AWS X-Ray Tracing](#aws-x-ray-tracing)
58.   - [Tags / Stack Tags](#tags--stack-tags)
59.   - [Logs](#logs)
60. 
61. _Are you looking for tutorials on using API Gateway? Check out the following resources:_
62. 
63. > - [Add a custom domain for your API Gateway](https://serverless.com/blog/serverless-api-gateway-domain/)
64. > - [Deploy multiple micro-services under the same domain](https://serverless.com/blog/api-gateway-multiple-services/)
65. > - [Create a Node REST API with Express.js](https://serverless.com/blog/serverless-express-rest-api/)
66. > - [Make a Serverless GraphQL API](https://serverless.com/blog/make-serverless-graphql-api-using-lambda-dynamodb/)
67. 
68. To create HTTP endpoints as Event sources for your AWS Lambda Functions, use the Serverless Framework's easy AWS API Gateway Events syntax.
69. 
70. There are five ways you can configure your HTTP endpoints to integrate with your AWS Lambda Functions:
71. 
72. - `lambda-proxy` / `aws-proxy` / `aws_proxy` (Recommended)
73. - `lambda` / `aws`
74. - `http`
75. - `http-proxy` / `http_proxy`
76. - `mock`
77. 
78. **The Framework uses the `lambda-proxy` method (i.e., everything is passed into your Lambda) by default unless another method is supplied by the user**
79. 
80. The difference between these is `lambda-proxy` (alternative writing styles are `aws-proxy` and `aws_proxy` for compatibility with the standard AWS integration type naming) automatically passes the content of the HTTP request into your AWS Lambda function (headers, body, etc.) and allows you to configure your response (headers, status code, body) in the code of your AWS Lambda Function. Whereas, the `lambda` method makes you explicitly define headers, status codes, and more in the configuration of each API Gateway Endpoint (not in code). We highly recommend using the `lambda-proxy` method if it supports your use-case, since the `lambda` method is highly tedious.
81. 
82. Use `http` for integrating with an HTTP back end, `http-proxy` for integrating with the HTTP proxy integration or `mock` for testing without actually invoking the back end.
83. 
84. ## Lambda Proxy Integration
85. 
86. ### Simple HTTP Endpoint
87. 
88. This setup specifies that the `hello` function should be run when someone accesses the API gateway at `hello` via
89. a `GET` request.
90. 
91. Here's an example:
92. 
93. ```yml
94. # serverless.yml
95. 
96. functions:
97.   index:
98.     handler: handler.hello
99.     events:
100.       - http: GET hello
101. ```
102. 
103. ```javascript
104. // handler.js
105. 
106. 'use strict';
107. 
108. module.exports.hello = function(event, context, callback) {
109.   console.log(event); // Contains incoming request data (e.g., query params, headers and more)
110. 
111.   const response = {
112.     statusCode: 200,
113.     headers: {
114.       'x-custom-header': 'My Header Value',
115.     },
116.     body: JSON.stringify({ message: 'Hello World!' }),
117.   };
118. 
119.   callback(null, response);
120. };
121. ```
122. 
123. **Note:** When the body is a JSON-Document, you must parse it yourself:
124. 
125. ```
126. JSON.parse(event.body);
127. ```
128. 
129. ### Example "LAMBDA-PROXY" event (default)
130. 
131. ```json
132. {
133.   "resource": "/",
134.   "path": "/",
135.   "httpMethod": "POST",
136.   "headers": {
137.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
138.     "Accept-Encoding": "gzip, deflate, br",
139.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
140.     "cache-control": "max-age=0",
141.     "CloudFront-Forwarded-Proto": "https",
142.     "CloudFront-Is-Desktop-Viewer": "true",
143.     "CloudFront-Is-Mobile-Viewer": "false",
144.     "CloudFront-Is-SmartTV-Viewer": "false",
145.     "CloudFront-Is-Tablet-Viewer": "false",
146.     "CloudFront-Viewer-Country": "GB",
147.     "content-type": "application/x-www-form-urlencoded",
148.     "Host": "j3ap25j034.execute-api.eu-west-2.amazonaws.com",
149.     "origin": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com",
150.     "Referer": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com/dev/",
151.     "upgrade-insecure-requests": "1",
152.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
153.     "Via": "2.0 a3650115c5e21e2b5d133ce84464bea3.cloudfront.net (CloudFront)",
154.     "X-Amz-Cf-Id": "0nDeiXnReyHYCkv8cc150MWCFCLFPbJoTs1mexDuKe2WJwK5ANgv2A==",
155.     "X-Amzn-Trace-Id": "Root=1-597079de-75fec8453f6fd4812414a4cd",
156.     "X-Forwarded-For": "50.129.117.14, 50.112.234.94",
157.     "X-Forwarded-Port": "443",
158.     "X-Forwarded-Proto": "https"
159.   },
160.   "queryStringParameters": null,
161.   "pathParameters": null,
162.   "stageVariables": null,
163.   "requestContext": {
164.     "path": "/dev/",
165.     "accountId": "125002137610",
166.     "resourceId": "qdolsr1yhk",
167.     "stage": "dev",
168.     "requestId": "0f2431a2-6d2f-11e7-b799-5152aa497861",
169.     "identity": {
170.       "cognitoIdentityPoolId": null,
171.       "accountId": null,
172.       "cognitoIdentityId": null,
173.       "caller": null,
174.       "apiKey": "",
175.       "sourceIp": "50.129.117.14",
176.       "accessKey": null,
177.       "cognitoAuthenticationType": null,
178.       "cognitoAuthenticationProvider": null,
179.       "userArn": null,
180.       "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
181.       "user": null
182.     },
183.     "resourcePath": "/",
184.     "httpMethod": "POST",
185.     "apiId": "j3azlsj0c4"
186.   },
187.   "body": "postcode=LS17FR",
188.   "isBase64Encoded": false
189. }
190. ```
191. 
192. ### HTTP Endpoint with Extended Options
193. 
194. Here we've defined an POST endpoint for the path `posts/create`.
195. 
196. ```yml
197. # serverless.yml
198. 
199. functions:
200.   create:
201.     handler: posts.create
202.     events:
203.       - http:
204.           path: posts/create
205.           method: post
206. ```
207. 
208. ### Enabling CORS
209. 
210. To set CORS configurations for your HTTP endpoints, simply modify your event configurations as follows:
211. 
212. ```yml
213. # serverless.yml
214. 
215. functions:
216.   hello:
217.     handler: handler.hello
218.     events:
219.       - http:
220.           path: hello
221.           method: get
222.           cors: true
223. ```
224. 
225. Setting `cors` to `true` assumes a default configuration which is equivalent to:
226. 
227. ```yml
228. functions:
229.   hello:
230.     handler: handler.hello
231.     events:
232.       - http:
233.           path: hello
234.           method: get
235.           cors:
236.             origin: '*'
237.             headers:
238.               - Content-Type
239.               - X-Amz-Date
240.               - Authorization
241.               - X-Api-Key
242.               - X-Amz-Security-Token
243.               - X-Amz-User-Agent
244.             allowCredentials: false
245. ```
246. 
247. To allow multiple origins, you can use the following configuration and provide an array in the `origins` or use comma separated `origin` field:
248. 
249. ```yml
250. functions:
251.   hello:
252.     handler: handler.hello
253.     events:
254.       - http:
255.           path: hello
256.           method: get
257.           cors:
258.             origins:
259.               - http://example.com
260.               - http://example2.com
261.             headers:
262.               - Content-Type
263.               - X-Amz-Date
264.               - Authorization
265.               - X-Api-Key
266.               - X-Amz-Security-Token
267.               - X-Amz-User-Agent
268.             allowCredentials: false
269. ```
270. 
271. Wildcards are accepted. The following example will match all sub-domains of example.com over http:
272. 
273. ```yml
274. cors:
275.   origins:
276.     - http://*.example.com
277.     - http://example2.com
278. ```
279. 
280. Please note that since you can't send multiple values for [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), this configuration uses a response template to check if the request origin matches one of your provided `
281. origins` and overrides the header with the following code:
282. 
283. ```
284. #set($origin = $input.params("Origin")
285. #if($origin == "http://example.com" || $origin == "http://*.amazonaws.com") #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end
286. ```
287. 
288. Configuring the `cors` property sets [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), [Access-Control-Allow-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers), [Access-Control-Allow-Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods),[Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) headers in the CORS preflight response.
289. 
290. If you use the lambda integration, the Access-Control-Allow-Origin and Access-Control-Allow-Credentials will also be provided to the method and integration responses.
291. 
292. Please note that the [Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)-Header is omitted when not explicitly set to `true`.
293. 
294. To enable the `Access-Control-Max-Age` preflight response header, set the `maxAge` property in the `cors` object:
295. 
296. ```yml
297. functions:
298.   hello:
299.     handler: handler.hello
300.     events:
301.       - http:
302.           path: hello
303.           method: get
304.           cors:
305.             origin: '*'
306.             maxAge: 86400
307. ```
308. 
309. If you are using CloudFront or another CDN for your API Gateway, you may want to setup a `Cache-Control` header to allow for OPTIONS request to be cached to avoid the additional hop.
310. 
311. To enable the `Cache-Control` header on preflight response, set the `cacheControl` property in the `cors` object:
312. 
313. ```yml
314. functions:
315.   hello:
316.     handler: handler.hello
317.     events:
318.       - http:
319.           path: hello
320.           method: get
321.           cors:
322.             origin: '*'
323.             headers:
324.               - Content-Type
325.               - X-Amz-Date
326.               - Authorization
327.               - X-Api-Key
328.               - X-Amz-Security-Token
329.               - X-Amz-User-Agent
330.             allowCredentials: false
331.             cacheControl: 'max-age=600, s-maxage=600, proxy-revalidate' # Caches on browser and proxy for 10 minutes and doesnt allow proxy to serve out of date content
332. ```
333. 
334. CORS header accepts single value too
335. 
336. ```yml
337. functions:
338.   hello:
339.     handler: handler.hello
340.     events:
341.       - http:
342.           path: hello
343.           method: get
344.           cors:
345.             headers: '*'
346. ```
347. 
348. If you want to use CORS with the lambda-proxy integration, remember to include the `Access-Control-Allow-*` headers in your headers object, like this:
349. 
350. ```javascript
351. // handler.js
352. 
353. 'use strict';
354. 
355. module.exports.hello = function(event, context, callback) {
356.   const response = {
357.     statusCode: 200,
358.     headers: {
359.       'Access-Control-Allow-Origin': '*', // Required for CORS support to work
360.       'Access-Control-Allow-Credentials': true, // Required for cookies, authorization headers with HTTPS
361.     },
362.     body: JSON.stringify({ message: 'Hello World!' }),
363.   };
364. 
365.   callback(null, response);
366. };
367. ```
368. 
369. ### HTTP Endpoints with `AWS_IAM` Authorizers
370. 
371. If you want to require that the caller submit the IAM user's access keys in order to be authenticated to invoke your Lambda Function, set the authorizer to `AWS_IAM` as shown in the following example:
372. 
373. ```yml
374. functions:
375.   create:
376.     handler: posts.create
377.     events:
378.       - http:
379.           path: posts/create
380.           method: post
381.           authorizer: aws_iam
382. ```
383. 
384. Which is the short hand notation for:
385. 
386. ```yml
387. functions:
388.   create:
389.     handler: posts.create
390.     events:
391.       - http:
392.           path: posts/create
393.           method: post
394.           authorizer:
395.             type: aws_iam
396. ```
397. 
398. ### HTTP Endpoints with Custom Authorizers
399. 
400. Custom Authorizers allow you to run an AWS Lambda Function before your targeted AWS Lambda Function. This is useful for Microservice Architectures or when you simply want to do some Authorization before running your business logic.
401. 
402. You can enable Custom Authorizers for your HTTP endpoint by setting the Authorizer in your `http` event to another function
403. in the same service, as shown in the following example:
404. 
405. ```yml
406. functions:
407.   create:
408.     handler: posts.create
409.     events:
410.       - http:
411.           path: posts/create
412.           method: post
413.           authorizer: authorizerFunc
414.   authorizerFunc:
415.     handler: handler.authorizerFunc
416. ```
417. 
418. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
419. shown in the following example:
420. 
421. ```yml
422. functions:
423.   create:
424.     handler: posts.create
425.     events:
426.       - http:
427.           path: posts/create
428.           method: post
429.           authorizer:
430.             name: authorizerFunc
431.             resultTtlInSeconds: 0
432.             identitySource: method.request.header.Authorization
433.             identityValidationExpression: someRegex
434.             type: token
435.   authorizerFunc:
436.     handler: handler.authorizerFunc
437. ```
438. 
439. If the Authorizer function does not exist in your service but exists in AWS, you can provide the ARN of the Lambda
440. function instead of the function name, as shown in the following example:
441. 
442. ```yml
443. functions:
444.   create:
445.     handler: posts.create
446.     events:
447.       - http:
448.           path: posts/create
449.           method: post
450.           authorizer: xxx:xxx:Lambda-Name
451. ```
452. 
453. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
454. shown in the following example:
455. 
456. ```yml
457. functions:
458.   create:
459.     handler: posts.create
460.     events:
461.       - http:
462.           path: posts/create
463.           method: post
464.           authorizer:
465.             arn: xxx:xxx:Lambda-Name
466.             managedExternally: false
467.             resultTtlInSeconds: 0
468.             identitySource: method.request.header.Authorization
469.             identityValidationExpression: someRegex
470. ```
471. 
472. If permissions for the Authorizer function are managed externally (for example, if the Authorizer function exists
473. in a different AWS account), you can skip creating the permission for the function by setting `managedExternally: true`,
474. as shown in the following example:
475. 
476. ```yml
477. functions:
478.   create:
479.     handler: posts.create
480.     events:
481.       - http:
482.           path: posts/create
483.           method: post
484.           authorizer:
485.             arn: xxx:xxx:Lambda-Name
486.             managedExternally: true
487. ```
488. 
489. **IMPORTANT NOTE**: The permission allowing the authorizer function to be called by API Gateway must exist
490. before deploying the stack, otherwise deployment will fail.
491. 
492. You can also use the Request Type Authorizer by setting the `type` property. In this case, your `identitySource` could contain multiple entries for your policy cache. The default `type` is 'token'.
493. 
494. ```yml
495. functions:
496.   create:
497.     handler: posts.create
498.     events:
499.       - http:
500.           path: posts/create
501.           method: post
502.           authorizer:
503.             arn: xxx:xxx:Lambda-Name
504.             resultTtlInSeconds: 0
505.             identitySource: method.request.header.Authorization, context.identity.sourceIp
506.             identityValidationExpression: someRegex
507.             type: request
508. ```
509. 
510. You can also configure an existing Cognito User Pool as the authorizer, as shown
511. in the following example with optional access token allowed scopes:
512. 
513. ```yml
514. functions:
515.   create:
516.     handler: posts.create
517.     events:
518.       - http:
519.           path: posts/create
520.           method: post
521.           authorizer:
522.             arn: arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ
523.             scopes:
524.               - my-app/read
525. ```
526. 
527. If you are using the default `lambda-proxy` integration, your attributes will be
528. exposed at `event.requestContext.authorizer.claims`.
529. 
530. If you want more control over which attributes are exposed as claims you
531. can switch to `integration: lambda` and add the following configuration. The
532. claims will be exposed at `events.cognitoPoolClaims`.
533. 
534. ```yml
535. functions:
536.   create:
537.     handler: posts.create
538.     events:
539.       - http:
540.           path: posts/create
541.           method: post
542.           integration: lambda
543.           authorizer:
544.             arn: arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ
545.             claims:
546.               - email
547.               - nickname
548. ```
549. 
550. If you are creating the Cognito User Pool in the `resources` section of the same template, you can refer to the ARN using the `Fn::GetAtt` attribute from CloudFormation. To do so, you _must_ give your authorizer a name and specify a type of `COGNITO_USER_POOLS`:
551. 
552. ```yml
553. functions:
554.   create:
555.     handler: posts.create
556.     events:
557.       - http:
558.           path: posts/create
559.           method: post
560.           integration: lambda
561.           authorizer:
562.             name: MyAuthorizer
563.             type: COGNITO_USER_POOLS
564.             arn:
565.               Fn::GetAtt:
566.                 - CognitoUserPool
567.                 - Arn
568. ---
569. resources:
570.   Resources:
571.     CognitoUserPool:
572.       Type: 'AWS::Cognito::UserPool'
573.       Properties: ...
574. ```
575. 
576. ### HTTP Endpoints with `operationId`
577. 
578. Include `operationId` when you want to provide a name for the method endpoint. This will set `OperationName` inside `AWS::ApiGateway::Method` accordingly. One common use case for this is customizing method names in some code generators (e.g., swagger).
579. 
580. ```yml
581. functions:
582.   create:
583.     handler: users.create
584.     events:
585.       - http:
586.           path: users/create
587.           method: post
588.           operationId: createUser
589. ```
590. 
591. ### Using asynchronous integration
592. 
593. Use `async: true` when integrating a lambda function using [event invocation](https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html#SSS-Invoke-request-InvocationType). This lets API Gateway to return immediately with a 200 status code while the lambda continues running. If not otherwise specified integration type will be `AWS`.
594. 
595. ```yml
596. functions:
597.   create:
598.     handler: posts.create
599.     events:
600.       - http:
601.           path: posts/create
602.           method: post
603.           async: true # default is false
604. ```
605. 
606. ### Catching Exceptions In Your Lambda Function
607. 
608. In case an exception is thrown in your lambda function AWS will send an error message with `Process exited before completing request`. This will be caught by the regular expression for the 500 HTTP status and the 500 status will be returned.
609. 
610. ### Setting API keys for your Rest API
611. 
612. You can specify a list of API keys to be used by your service Rest API by adding an `apiKeys` array property to the
613. `provider` object in `serverless.yml`. You'll also need to explicitly specify which endpoints are `private` and require
614. one of the api keys to be included in the request by adding a `private` boolean property to the `http` event object you
615. want to set as private. API Keys are created globally, so if you want to deploy your service to different stages make sure
616. your API key contains a stage variable as defined below. When using API keys, you can optionally define usage plan quota
617. and throttle, using `usagePlan` object.
618. 
619. When setting the value, you need to be aware that changing value will require replacement and CloudFormation doesn't allow
620. two API keys with the same name. It means that you need to change the name also when changing the value. If you don't care
621. about the name of the key, it is recommended only to set the value and let CloudFormation name the key.
622. 
623. Here's an example configuration for setting API keys for your service Rest API:
624. 
625. ```yml
626. service: my-service
627. provider:
628.   name: aws
629.   apiKeys:
630.     - myFirstKey
631.     - ${opt:stage}-myFirstKey
632.     - ${env:MY_API_KEY} # you can hide it in a serverless variable
633.     - name: myThirdKey
634.       value: myThirdKeyValue
635.     - value: myFourthKeyValue # let cloudformation name the key (recommended when setting api key value)
636.       description: Api key description # Optional
637.       customerId: A string that will be set as the customerID for the key # Optional
638.   usagePlan:
639.     quota:
640.       limit: 5000
641.       offset: 2
642.       period: MONTH
643.     throttle:
644.       burstLimit: 200
645.       rateLimit: 100
646. functions:
647.   hello:
648.     events:
649.       - http:
650.           path: user/create
651.           method: get
652.           private: true
653. ```
654. 
655. Please note that those are the API keys names, not the actual values. Once you deploy your service, the value of those API keys will be auto generated by AWS and printed on the screen for you to use. The values can be concealed from the output with the `--conceal` deploy option.
656. 
657. Clients connecting to this Rest API will then need to set any of these API keys values in the `x-api-key` header of their request. This is only necessary for functions where the `private` property is set to true.
658. 
659. You can also setup multiple usage plans for your API. In this case you need to map your usage plans to your api keys. Here's an example how this might look like:
660. 
661. ```yml
662. service: my-service
663. provider:
664.   name: aws
665.   apiKeys:
666.     - free:
667.         - myFreeKey
668.         - ${opt:stage}-myFreeKey
669.     - paid:
670.         - myPaidKey
671.         - ${opt:stage}-myPaidKey
672.   usagePlan:
673.     - free:
674.         quota:
675.           limit: 5000
676.           offset: 2
677.           period: MONTH
678.         throttle:
679.           burstLimit: 200
680.           rateLimit: 100
681.     - paid:
682.         quota:
683.           limit: 50000
684.           offset: 1
685.           period: MONTH
686.         throttle:
687.           burstLimit: 2000
688.           rateLimit: 1000
689. functions:
690.   hello:
691.     events:
692.       - http:
693.           path: user/create
694.           method: get
695.           private: true
696. ```
697. 
698. ### Configuring endpoint types
699. 
700. API Gateway [supports regional endpoints](https://aws.amazon.com/about-aws/whats-new/2017/11/amazon-api-gateway-supports-regional-api-endpoints/) for associating your API Gateway REST APIs with a particular region. This can reduce latency if your requests originate from the same region as your REST API and can be helpful in building multi-region applications.
701. 
702. By default, the Serverless Framework deploys your REST API using the EDGE endpoint configuration. If you would like to use the REGIONAL or PRIVATE configuration, set the `endpointType` parameter in your `provider` block.
703. 
704. Here's an example configuration for setting the endpoint configuration for your service Rest API:
705. 
706. ```yml
707. service: my-service
708. provider:
709.   name: aws
710.   endpointType: REGIONAL
711. functions:
712.   hello:
713.     events:
714.       - http:
715.           path: user/create
716.           method: get
717. ```
718. 
719. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:
720. 
721. ```
722. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com
723. ```
724. 
725. Here's an example configuration:
726. 
727. ```yml
728. service: my-service
729. provider:
730.   name: aws
731.   endpointType: PRIVATE
732.   vpcEndpointIds:
733.     - vpce-123
734.     - vpce-456
735. ```
736. 
737. ### Request Parameters
738. 
739. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.
740. 
741. ```yml
742. functions:
743.   create:
744.     handler: posts.create
745.     events:
746.       - http:
747.           path: posts/create
748.           method: post
749.           request:
750.             parameters:
751.               querystrings:
752.                 url: true
753.               headers:
754.                 foo: false
755.               paths:
756.                 bar: false
757. ```
758. 
759. In order for path variables to work, API Gateway also needs them in the method path itself, like so:
760. 
761. ```yml
762. functions:
763.   create:
764.     handler: posts.post_detail
765.     events:
766.       - http:
767.           path: posts/{id}
768.           method: get
769.           request:
770.             parameters:
771.               paths:
772.                 id: true
773. ```
774. 
775. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.
776. 
777. ```yml
778. functions:
779.   create:
780.     handler: posts.post_detail
781.     events:
782.       - http:
783.           path: posts/{id}
784.           method: get
785.           request:
786.             parameters:
787.               paths:
788.                 id: true
789.               headers:
790.                 custom-header:
791.                   required: true
792.                   mappedValue: context.requestId
793. ```
794. 
795. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)
796. 
797. ### Request Schema Validators
798. 
799. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)
800. for your content type. Since JSON Schema is represented in JSON, it's easier to include it from a
801. file.
802. 
803. ```yml
804. functions:
805.   create:
806.     handler: posts.create
807.     events:
808.       - http:
809.           path: posts/create
810.           method: post
811.           request:
812.             schema:
813.               application/json: ${file(create_request.json)}
814. ```
815. 
816. A sample schema contained in `create_request.json` might look something like this:
817. 
818. ```json
819. {
820.   "definitions": {},
821.   "$schema": "http://json-schema.org/draft-04/schema#",
822.   "type": "object",
823.   "title": "The Root Schema",
824.   "required": ["username"],
825.   "properties": {
826.     "username": {
827.       "type": "string",
828.       "title": "The Foo Schema",
829.       "default": "",
830.       "pattern": "^[a-zA-Z0-9]+$"
831.     }
832.   }
833. }
834. ```
835. 
836. **NOTE:** schema validators are only applied to content types you specify. Other content types are
837. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.
838. 
839. ### Setting source of API key for metering requests
840. 
841. API Gateway provide a feature for metering your API's requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request's X-API-Key header, set option like this:
842. 
843. ```yml
844. service: my-service
845. provider:
846.   name: aws
847.   apiGateway:
848.     apiKeySourceType: HEADER
849. functions:
850.   hello:
851.     events:
852.       - http:
853.           path: hello
854.           method: get
855. ```
856. 
857. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.
858. 
859. ```yml
860. service: my-service
861. provider:
862.   name: aws
863.   apiGateway:
864.     apiKeySourceType: AUTHORIZER
865. functions:
866.   hello:
867.     events:
868.       - http:
869.           path: hello
870.           method: get
871. ```
872. 
873. ## Lambda Integration
874. 
875. This method is more complicated and involves a lot more configuration of the `http` event syntax.
876. 
877. ### Example "LAMBDA" event (before customization)
878. 
879. **Refer to this only if you're using the non-default `LAMBDA` integration method**
880. 
881. ```json
882. {
883.   "body": {},
884.   "method": "GET",
885.   "principalId": "",
886.   "stage": "dev",
887.   "cognitoPoolClaims": {
888.     "sub": ""
889.   },
890.   "enhancedAuthContext": {},
891.   "headers": {
892.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
893.     "Accept-Encoding": "gzip, deflate, br",
894.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
895.     "CloudFront-Forwarded-Proto": "https",
896.     "CloudFront-Is-Desktop-Viewer": "true",
897.     "CloudFront-Is-Mobile-Viewer": "false",
898.     "CloudFront-Is-SmartTV-Viewer": "false",
899.     "CloudFront-Is-Tablet-Viewer": "false",
900.     "CloudFront-Viewer-Country": "GB",
901.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",
902.     "upgrade-insecure-requests": "1",
903.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
904.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",
905.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",
906.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",
907.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",
908.     "X-Forwarded-Port": "443",
909.     "X-Forwarded-Proto": "https"
910.   },
911.   "query": {},
912.   "path": {},
913.   "identity": {
914.     "cognitoIdentityPoolId": "",
915.     "accountId": "",
916.     "cognitoIdentityId": "",
917.     "caller": "",
918.     "apiKey": "",
919.     "sourceIp": "94.197.120.169",
920.     "accessKey": "",
921.     "cognitoAuthenticationType": "",
922.     "cognitoAuthenticationProvider": "",
923.     "userArn": "",
924.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
925.     "user": ""
926.   },
927.   "stageVariables": {},
928.   "requestPath": "/request/path"
929. }
930. ```
931. 
932. ### Request templates
933. 
934. #### Default Request Templates
935. 
936. Serverless ships with the following default request templates you can use out of the box:
937. 
938. 1. `application/json`
939. 2. `application/x-www-form-urlencoded`
940. 
941. Both templates give you access to the following properties you can access with the help of the `event` object:
942. 
943. - body
944. - method
945. - principalId
946. - stage
947. - headers
948. - queryStringParameters
949. - path
950. - identity
951. - stageVariables
952. - requestPath
953. 
954. #### Custom Request Templates
955. 
956. However you can define and use your own request templates as follows (you can even overwrite the default request templates
957. by defining a new request template for an existing content type):
958. 
959. ```yml
960. functions:
961.   create:
962.     handler: posts.create
963.     events:
964.       - http:
965.           method: get
966.           path: whatever
967.           integration: lambda
968.           request:
969.             template:
970.               text/xhtml: '{ "stage" : "$context.stage" }'
971.               application/json: '{ "httpMethod" : "$context.httpMethod" }'
972. ```
973. 
974. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
975. 
976. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
977. 
978. If you want to map querystrings to the event object, you can use the `$input.params('hub.challenge')` syntax from API Gateway, as follows:
979. 
980. ```yml
981. functions:
982.   create:
983.     handler: posts.create
984.     events:
985.       - http:
986.           method: get
987.           path: whatever
988.           integration: lambda
989.           request:
990.             template:
991.               application/json: '{ "foo" : "$input.params(''bar'')" }'
992. ```
993. 
994. **Note:** Notice when using single-quoted strings, any single quote `'` inside its contents must be doubled (`''`) to escape it.
995. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.
996. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).
997. 
998. #### Pass Through Behavior
999. 
1000. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.
1001. 
1002. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):
1003. 
1004. ```yml
1005. functions:
1006.   create:
1007.     handler: posts.create
1008.     events:
1009.       - http:
1010.           method: get
1011.           path: whatever
1012.           integration: lambda
1013.           request:
1014.             passThrough: NEVER
1015. ```
1016. 
1017. There are 3 available options:
1018. 
1019. | Value             | Passed Through When                          | Rejected When                                                          |
1020. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |
1021. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |
1022. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |
1023. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |
1024. 
1025. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.
1026. 
1027. **Notes:**
1028. 
1029. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
1030. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)
1031. 
1032. ### Responses
1033. 
1034. Serverless lets you setup custom headers and a response template for your `http` event.
1035. 
1036. #### Custom Response Headers
1037. 
1038. Here's an example which shows you how you can setup a custom response header:
1039. 
1040. ```yml
1041. functions:
1042.   create:
1043.     handler: posts.create
1044.     events:
1045.       - http:
1046.           method: get
1047.           path: whatever
1048.           integration: lambda
1049.           response:
1050.             headers:
1051.               Content-Type: integration.response.header.Content-Type
1052.               Cache-Control: "'max-age=120'"
1053. ```
1054. 
1055. **Note:** You're able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)
1056. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header
1057. as `"'max-age=120'"` means API Gateway will receive the value as `'max-age=120'` (enclosed with single quotes).
1058. 
1059. #### Custom Response Templates
1060. 
1061. Sometimes you'll want to define a custom response template API Gateway should use to transform your lambdas output.
1062. Here's an example which will transform the return value of your lambda so that the browser renders it as HTML:
1063. 
1064. ```yml
1065. functions:
1066.   create:
1067.     handler: posts.create
1068.     events:
1069.       - http:
1070.           method: get
1071.           path: whatever
1072.           integration: lambda
1073.           response:
1074.             headers:
1075.               Content-Type: "'text/html'"
1076.             template: $input.path('$')
1077. ```
1078. 
1079. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of
1080. the `${file(templatefile)}` syntax.
1081. 
1082. ### Status Codes
1083. 
1084. Serverless ships with default status codes you can use to e.g. signal that a resource could not be found (404) or that
1085. the user is not authorized to perform the action (401). Those status codes are regex definitions that will be added to your API Gateway configuration.
1086. 
1087. **_Note:_** Status codes as documented in this chapter relate to `lambda` integration method (as documented at the top of this page). If using default integration method `lambda-proxy` object with status code and message should be returned as in the example below:
1088. 
1089. ```javascript
1090. module.exports.hello = (event, context, callback) => {
1091.   callback(null, { statusCode: 404, body: 'Not found', headers: { 'Content-Type': 'text/plain' } });
1092. };
1093. ```
1094. 
1095. #### Available Status Codes
1096. 
1097. | Status Code | Meaning               |
1098. | ----------- | --------------------- |
1099. | 400         | Bad Request           |
1100. | 401         | Unauthorized          |
1101. | 403         | Forbidden             |
1102. | 404         | Not Found             |
1103. | 422         | Unprocessable Entity  |
1104. | 500         | Internal Server Error |
1105. | 502         | Bad Gateway           |
1106. | 504         | Gateway Timeout       |
1107. 
1108. #### Using Status Codes
1109. 
1110. To return a given status code you simply need to add square brackets with the status code of your choice to your
1111. returned message like this: `[401] You are not authorized to access this resource!`.
1112. 
1113. Here's an example which shows you how you can raise a 404 HTTP status from within your lambda function.
1114. 
1115. ```javascript
1116. module.exports.hello = (event, context, callback) => {
1117.   callback(new Error('[404] Not found'));
1118. };
1119. ```
1120. 
1121. #### Custom Status Codes
1122. 
1123. You can override the defaults status codes supplied by Serverless. You can use this to change the default status code, add/remove status codes, or change the templates and headers used for each status code. Use the pattern key to change the selection process that dictates what code is returned.
1124. 
1125. If you specify a status code with a pattern of '' that will become the default response code. See below on how to change the default to 201 for post requests.
1126. 
1127. If you omit any default status code. A standard default 200 status code will be generated for you.
1128. 
1129. ```yml
1130. functions:
1131.   create:
1132.     handler: posts.create
1133.     events:
1134.       - http:
1135.           method: post
1136.           path: whatever
1137.           integration: lambda
1138.           response:
1139.             headers:
1140.               Content-Type: "'text/html'"
1141.             template: $input.path('$')
1142.             statusCodes:
1143.               201:
1144.                 pattern: '' # Default response method
1145.               409:
1146.                 pattern: '.*"statusCode":409,.*' # JSON response
1147.                 template: $input.path("$.errorMessage") # JSON return object
1148.                 headers:
1149.                   Content-Type: "'application/json+hal'"
1150. ```
1151. 
1152. You can also create varying response templates for each code and content type by creating an object with the key as the content type
1153. 
1154. ```yml
1155. functions:
1156.   create:
1157.     handler: posts.create
1158.     events:
1159.       - http:
1160.           method: post
1161.           path: whatever
1162.           integration: lambda
1163.           response:
1164.             headers:
1165.               Content-Type: "'text/html'"
1166.             template: $input.path('$')
1167.             statusCodes:
1168.               201:
1169.                 pattern: '' # Default response method
1170.               409:
1171.                 pattern: '.*"statusCode":409,.*' # JSON response
1172.                 template:
1173.                   application/json: $input.path("$.errorMessage") # JSON return object
1174.                   application/xml: $input.path("$.body.errorMessage") # XML return object
1175.                 headers:
1176.                   Content-Type: "'application/json+hal'"
1177. ```
1178. 
1179. ## Setting an HTTP Proxy on API Gateway
1180. 
1181. To set up an HTTP proxy, you'll need two CloudFormation templates, one for the endpoint (known as resource in CF), and
1182. one for method. These two templates will work together to construct your proxy. So if you want to set `your-app.com/serverless` as a proxy for `serverless.com`, you'll need the following two templates in your `serverless.yml`:
1183. 
1184. ```yml
1185. service: service-name
1186. provider: aws
1187. functions: ...
1188. 
1189. resources:
1190.   Resources:
1191.     ProxyResource:
1192.       Type: AWS::ApiGateway::Resource
1193.       Properties:
1194.         ParentId:
1195.           Fn::GetAtt:
1196.             - ApiGatewayRestApi # our default Rest API logical ID
1197.             - RootResourceId
1198.         PathPart: serverless # the endpoint in your API that is set as proxy
1199.         RestApiId:
1200.           Ref: ApiGatewayRestApi
1201.     ProxyMethod:
1202.       Type: AWS::ApiGateway::Method
1203.       Properties:
1204.         ResourceId:
1205.           Ref: ProxyResource
1206.         RestApiId:
1207.           Ref: ApiGatewayRestApi
1208.         HttpMethod: GET # the method of your proxy. Is it GET or POST or ... ?
1209.         MethodResponses:
1210.           - StatusCode: 200
1211.         Integration:
1212.           IntegrationHttpMethod: POST
1213.           Type: HTTP
1214.           Uri: http://serverless.com # the URL you want to set a proxy to
1215.           IntegrationResponses:
1216.             - StatusCode: 200
1217. ```
1218. 
1219. There's a lot going on in these two templates, but all you need to know to set up a simple proxy is setting the method &
1220. endpoint of your proxy, and the URI you want to set a proxy to.
1221. 
1222. Now that you have these two CloudFormation templates defined in your `serverless.yml` file, you can simply run
1223. `serverless deploy` and that will deploy these custom resources for you along with your service and set up a proxy on your Rest API.
1224. 
1225. ## Accessing private resources using VPC Link
1226. 
1227. If you have an Edge Optimized or Regional API Gateway, you can access the internal VPC resources using VPC Link. Please refer [AWS documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-private-integration.html) to know more about API Gateway private integration.
1228. 
1229. We can use following configuration to have an http-proxy vpc-link integration.
1230. 
1231. ```yml
1232. - http:
1233.     path: v1/repository
1234.     method: get
1235.     integration: http-proxy
1236.     connectionType: vpc-link
1237.     connectionId: '{your-vpc-link-id}'
1238.     cors: true
1239.     request:
1240.       uri: http://www.github.com/v1/repository
1241.       method: get
1242. ```
1243. 
1244. ## Mock Integration
1245. 
1246. Mocks allow developers to offer simulated methods for an API, with this, responses can be defined directly, without the need for a integration backend. A simple mock response example is provided below:
1247. 
1248. ```yml
1249. functions:
1250.   hello:
1251.     handler: handler.hello
1252.     events:
1253.       - http:
1254.           path: hello
1255.           cors: true
1256.           method: get
1257.           integration: mock
1258.           request:
1259.             template:
1260.               application/json: '{"statusCode": 200}'
1261.           response:
1262.             template: $input.path('$')
1263.             statusCodes:
1264.               201:
1265.                 pattern: ''
1266. ```
1267. 
1268. ## Share API Gateway and API Resources
1269. 
1270. As your application grows, you will likely need to break it out into multiple, smaller services. By default, each Serverless project generates a new API Gateway. However, you can share the same API Gateway between multiple projects by referencing its REST API ID and Root Resource ID in `serverless.yml` as follows:
1271. 
1272. ```yml
1273. service: service-name
1274. provider:
1275.   name: aws
1276.   apiGateway:
1277.     restApiId: xxxxxxxxxx # REST API resource ID. Default is generated by the framework
1278.     restApiRootResourceId: xxxxxxxxxx # Root resource, represent as / path
1279.     websocketApiId: xxxxxxxxxx # Websocket API resource ID. Default is generated by the framework
1280.     description: Some Description # optional - description of deployment history
1281. 
1282. functions: ...
1283. ```
1284. 
1285. If your application has many nested paths, you might also want to break them out into smaller services.
1286. 
1287. ```yml
1288. service: service-a
1289. provider:
1290.   apiGateway:
1291.     restApiId: xxxxxxxxxx
1292.     restApiRootResourceId: xxxxxxxxxx
1293.     websocketApiId: xxxxxxxxxx
1294.     description: Some Description
1295. 
1296. functions:
1297.   create:
1298.     handler: posts.create
1299.     events:
1300.       - http:
1301.           method: post
1302.           path: /posts
1303. ```
1304. 
1305. ```yml
1306. service: service-b
1307. provider:
1308.   apiGateway:
1309.     restApiId: xxxxxxxxxx
1310.     restApiRootResourceId: xxxxxxxxxx
1311.     websocketApiId: xxxxxxxxxx
1312.     description: Some Description
1313. 
1314. functions:
1315.   create:
1316.     handler: posts.createComment
1317.     events:
1318.       - http:
1319.           method: post
1320.           path: /posts/{id}/comments
1321. ```
1322. 
1323. The above example services both reference the same parent path `/posts`. However, Cloudformation will throw an error if we try to generate an existing path resource. To avoid that, we reference the resource ID of `/posts`:
1324. 
1325. ```yml
1326. service: service-a
1327. provider:
1328.   apiGateway:
1329.     restApiId: xxxxxxxxxx
1330.     restApiRootResourceId: xxxxxxxxxx
1331.     websocketApiId: xxxxxxxxxx
1332.     description: Some Description
1333.     restApiResources:
1334.       posts: xxxxxxxxxx
1335. 
1336. functions: ...
1337. ```
1338. 
1339. ```yml
1340. service: service-b
1341. provider:
1342.   apiGateway:
1343.     restApiId: xxxxxxxxxx
1344.     restApiRootResourceId: xxxxxxxxxx
1345.     websocketApiId: xxxxxxxxxx
1346.     description: Some Description
1347.     restApiResources:
1348.       /posts: xxxxxxxxxx
1349. 
1350. functions: ...
1351. ```
1352. 
1353. You can define more than one path resource, but by default, Serverless will generate them from the root resource.
1354. `restApiRootResourceId` is optional if a path resource isn't required for the root (`/`).
1355. 
1356. ```yml
1357. service: service-a
1358. provider:
1359.   apiGateway:
1360.     restApiId: xxxxxxxxxx
1361.     # restApiRootResourceId: xxxxxxxxxx # Optional
1362.     websocketApiId: xxxxxxxxxx
1363.     description: Some Description
1364.     restApiResources:
1365.       /posts: xxxxxxxxxx
1366.       /categories: xxxxxxxxx
1367. 
1368. functions:
1369.   listPosts:
1370.     handler: posts.list
1371.     events:
1372.       - http:
1373.           method: get
1374.           path: /posts
1375. 
1376.   listCategories:
1377.     handler: categories.list
1378.     events:
1379.       - http:
1380.           method: get
1381.           path: /categories
1382. ```
1383. 
1384. ### Easiest and CI/CD friendly example of using shared API Gateway and API Resources.
1385. 
1386. You can define your API Gateway resource in its own service and export the `restApiId`, `restApiRootResourceId` and `websocketApiId` using cloudformation cross-stack references.
1387. 
1388. ```yml
1389. service: my-api
1390. 
1391. provider:
1392.   name: aws
1393.   runtime: nodejs12.x
1394.   stage: dev
1395.   region: eu-west-2
1396. 
1397. resources:
1398.   Resources:
1399.     MyApiGW:
1400.       Type: AWS::ApiGateway::RestApi
1401.       Properties:
1402.         Name: MyApiGW
1403. 
1404.     MyWebsocketApi:
1405.       Type: AWS::ApiGatewayV2::Api
1406.       Properties:
1407.         Name: MyWebsocketApi
1408.         ProtocolType: WEBSOCKET
1409.         RouteSelectionExpression: '$request.body.action'
1410. 
1411.   Outputs:
1412.     apiGatewayRestApiId:
1413.       Value:
1414.         Ref: MyApiGW
1415.       Export:
1416.         Name: MyApiGateway-restApiId
1417. 
1418.     apiGatewayRestApiRootResourceId:
1419.       Value:
1420.         Fn::GetAtt:
1421.           - MyApiGW
1422.           - RootResourceId
1423.       Export:
1424.         Name: MyApiGateway-rootResourceId
1425. 
1426.     websocketApiId:
1427.       Value:
1428.         Ref: MyWebsocketApi
1429.       Export:
1430.         Name: MyApiGateway-websocketApiId
1431. ```
1432. 
1433. This creates API gateway and then exports the `restApiId`, `rootResourceId` and `websocketApiId` values using cloudformation cross stack output.
1434. We will import this and reference in future services.
1435. 
1436. ```yml
1437. service: service-a
1438. 
1439. provider:
1440.   apiGateway:
1441.     restApiId:
1442.       'Fn::ImportValue': MyApiGateway-restApiId
1443.     restApiRootResourceId:
1444.       'Fn::ImportValue': MyApiGateway-rootResourceId
1445.     websocketApiId:
1446.       'Fn::ImportValue': MyApiGateway-websocketApiId
1447. 
1448. functions: service-a-functions
1449. ```
1450. 
1451. ```yml
1452. service: service-b
1453. 
1454. provider:
1455.   apiGateway:
1456.     restApiId:
1457.       'Fn::ImportValue': MyApiGateway-restApiId
1458.     restApiRootResourceId:
1459.       'Fn::ImportValue': MyApiGateway-rootResourceId
1460.     websocketApiId:
1461.       'Fn::ImportValue': MyApiGateway-websocketApiId
1462. 
1463. functions: service-b-functions
1464. ```
1465. 
1466. You can use this method to share your API Gateway across services in same region. Read about this limitation [here](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html).
1467. 
1468. **Note:** We've noticed you can't use provider.tags together with `Fn::ImportValue` for `restApiId` and `restApiRootResourceId`. Doing so won't resolve the imported value, and therefore returns an error.
1469. 
1470. ### Manually Configuring shared API Gateway
1471. 
1472. Use AWS console on browser, navigate to the API Gateway console. Select your already existing API Gateway.
1473. Top Navbar should look like this
1474. 
1475. ```
1476.     APIs>apigateway-Name (xxxxxxxxxx)>Resources>/ (yyyyyyyyyy)
1477. ```
1478. 
1479. Here xxxxxxxxx is your restApiId and yyyyyyyyyy the restApiRootResourceId.
1480. 
1481. #### Note while using authorizers with shared API Gateway
1482. 
1483. AWS API Gateway allows only 1 Authorizer for 1 ARN, This is okay when you use conventional serverless setup, because each stage and service will create different API Gateway. But this can cause problem when using authorizers with shared API Gateway. If we use the same authorizer directly in different services like this.
1484. 
1485. ```yml
1486. service: service-c
1487. 
1488. provider:
1489.   apiGateway:
1490.     restApiId:
1491.       'Fn::ImportValue': apiGateway-restApiId
1492.     restApiRootResourceId:
1493.       'Fn::ImportValue': apiGateway-rootResourceId
1494. 
1495. functions:
1496.   deleteUser:
1497.     events:
1498.       - http:
1499.         path: /users/{userId}
1500.         authorizer:
1501.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
1502. ```
1503. 
1504. ```yml
1505. service: service-d
1506. 
1507. provider:
1508.   apiGateway:
1509.     restApiId:
1510.       'Fn::ImportValue': apiGateway-restApiId
1511.     restApiRootResourceId:
1512.       'Fn::ImportValue': apiGateway-rootResourceId
1513. 
1514. functions:
1515.   deleteProject:
1516.     events:
1517.       - http:
1518.         path: /project/{projectId}
1519.         authorizer:
1520.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
1521. ```
1522. 
1523. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).
1524. 
1525. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.
1526. 
1527. ## Share Authorizer
1528. 
1529. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.
1530. 
1531. ```yml
1532. functions:
1533.   createUser:
1534.      ...
1535.     events:
1536.       - http:
1537.           path: /users
1538.           ...
1539.           authorizer:
1540.             # Provide both type and authorizerId
1541.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
1542.             authorizerId:
1543.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID
1544.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS
1545.               - myapp/myscope
1546. 
1547.   deleteUser:
1548.      ...
1549.     events:
1550.       - http:
1551.           path: /users/{userId}
1552.           ...
1553.           # Provide both type and authorizerId
1554.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
1555.           authorizerId:
1556.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID
1557. 
1558. resources:
1559.   Resources:
1560.     ApiGatewayAuthorizer:
1561.       Type: AWS::ApiGateway::Authorizer
1562.       Properties:
1563.         AuthorizerResultTtlInSeconds: 300
1564.         IdentitySource: method.request.header.Authorization
1565.         Name: Cognito
1566.         RestApiId:
1567.           Ref: YourApiGatewayName
1568.         Type: COGNITO_USER_POOLS
1569.         ProviderARNs:
1570.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef
1571. 
1572. ```
1573. 
1574. ## Resource Policy
1575. 
1576. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.
1577. 
1578. ```yml
1579. provider:
1580.   name: aws
1581.   runtime: nodejs12.x
1582. 
1583.   resourcePolicy:
1584.     - Effect: Allow
1585.       Principal: '*'
1586.       Action: execute-api:Invoke
1587.       Resource:
1588.         - execute-api:/*/*/*
1589.       Condition:
1590.         IpAddress:
1591.           aws:SourceIp:
1592.             - '123.123.123.123'
1593. ```
1594. 
1595. ## Compression
1596. 
1597. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).
1598. 
1599. ```yml
1600. provider:
1601.   name: aws
1602.   apiGateway:
1603.     minimumCompressionSize: 1024
1604. ```
1605. 
1606. ## Binary Media Types
1607. 
1608. API Gateway makes it possible to return binary media such as images or files as responses.
1609. 
1610. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:
1611. 
1612. ```yml
1613. provider:
1614.   apiGateway:
1615.     binaryMediaTypes:
1616.       - '*/*'
1617. ```
1618. 
1619. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.
1620. 
1621. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).
1622. 
1623. ```yml
1624. functions:
1625.   create:
1626.     handler: posts.create
1627.     events:
1628.       - http:
1629.           path: posts/create
1630.           method: post
1631.           request:
1632.             contentHandling: CONVERT_TO_TEXT
1633.           response:
1634.             contentHandling: CONVERT_TO_TEXT
1635. ```
1636. 
1637. ## Detailed CloudWatch Metrics
1638. 
1639. Use the following configuration to enable detailed CloudWatch Metrics:
1640. 
1641. ```yml
1642. provider:
1643.   apiGateway:
1644.     metrics: true
1645. ```
1646. 
1647. ## AWS X-Ray Tracing
1648. 
1649. API Gateway supports a form of out of the box distributed tracing via [AWS X-Ray](https://aws.amazon.com/xray/) though enabling [active tracing](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-xray.html). To enable this feature for your serverless application's API Gateway add the following to your `serverless.yml`
1650. 
1651. ```yml
1652. # serverless.yml
1653. 
1654. provider:
1655.   name: aws
1656.   tracing:
1657.     apiGateway: true
1658. ```
1659. 
1660. ## Tags / Stack Tags
1661. 
1662. API Gateway stages will be tagged with the `tags` and `stackTags` values defined at the `provider` level:
1663. 
1664. ```yml
1665. # serverless.yml
1666. 
1667. provider:
1668.   name: aws
1669.   stackTags:
1670.     stackTagKey: stackTagValue
1671.   tags:
1672.     tagKey: tagValue
1673. ```
1674. 
1675. ## Logs
1676. 
1677. Use the following configuration to enable API Gateway logs:
1678. 
1679. ```yml
1680. # serverless.yml
1681. provider:
1682.   name: aws
1683.   logs:
1684.     restApi: true
1685. ```
1686. 
1687. The log streams will be generated in a dedicated log group which follows the naming schema `/aws/api-gateway/{service}-{stage}`.
1688. 
1689. To be able to write logs, API Gateway [needs a CloudWatch role configured](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html). This setting is per region, shared by all the APIs. There are three approaches for handling it:
1690. 
1691. - Let Serverless create and assign an IAM role for you (default behavior). Note that since this is a shared setting, this role is not removed when you remove the deployment.
1692. - Let Serverless assign an existing IAM role that you created before the deployment, if not already assigned:
1693. 
1694.   ```yml
1695.   # serverless.yml
1696.   provider:
1697.     logs:
1698.       restApi:
1699.         role: arn:aws:iam::123456:role
1700.   ```
1701. 
1702. - Do not let Serverless manage the CloudWatch role configuration. In this case, you would create and assign the IAM role yourself, e.g. in a separate "account setup" deployment:
1703. 
1704.   ```yml
1705.   provider:
1706.     logs:
1707.       restApi:
1708.         roleManagedExternally: true # disables automatic role creation/checks done by Serverless
1709.   ```
1710. 
1711. **Note:** Serverless configures the API Gateway CloudWatch role setting using a custom resource lambda function. If you're using `cfnRole` to specify a limited-access IAM role for your serverless deployment, the custom resource lambda will assume this role during execution.
1712. 
1713. By default, API Gateway access logs will use the following format:
1714. 
1715. ```
1716. 'requestId: $context.requestId, ip: $context.identity.sourceIp, caller: $context.identity.caller, user: $context.identity.user, requestTime: $context.requestTime, httpMethod: $context.httpMethod, resourcePath: $context.resourcePath, status: $context.status, protocol: $context.protocol, responseLength: $context.responseLength'
1717. ```
1718. 
1719. You can specify your own [format for API Gateway Access Logs](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html#apigateway-cloudwatch-log-formats) by including your preferred string in the `format` property:
1720. 
1721. ```yml
1722. # serverless.yml
1723. provider:
1724.   name: aws
1725.   logs:
1726.     restApi:
1727.       format: '{ "requestId":"$context.requestId",   "ip": "$context.identity.sourceIp" }'
1728. ```
1729. 
1730. The default API Gateway log level will be INFO. You can change this to error with the following:
1731. 
1732. ```yml
1733. # serverless.yml
1734. provider:
1735.   name: aws
1736.   logs:
1737.     restApi:
1738.       level: ERROR
1739. ```
1740. 
1741. Valid values are INFO, ERROR.
1742. 
1743. If you want to disable access logging completly you can do with the following:
1744. 
1745. ```yml
1746. # serverless.yml
1747. provider:
1748.   name: aws
1749.   logs:
1750.     restApi:
1751.       accessLogging: true
1752. ```
1753. 
1754. By default, the full requests and responses data will be logged. If you want to disable like so:
1755. 
1756. ```yml
1757. # serverless.yml
1758. provider:
1759.   name: aws
1760.   logs:
1761.     restApi:
1762.       fullExecutionData: false
1763. ```
1764. 
1765. Websockets have the same configuration options as the the REST API. Example:
1766. 
1767. ```yml
1768. # serverless.yml
1769. provider:
1770.   name: aws
1771.   logs:
1772.     websoocket:
1773.       level: INFO
1774.       fullExecutionData: false
1775. ```


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 1 - 261
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. const DEFAULT_COMMON_TEMPLATE = `
6.   #define( $loop )
7.     {
8.     #foreach($key in $map.keySet())
9.         #set( $k = $util.escapeJavaScript($key) )
10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\'", "'") )
11.         "$k":
12.           "$v"
13.           #if( $foreach.hasNext ) , #end
14.     #end
15.     }
16.   #end
17. 
18.   {
19.     "body": $body,
20.     "method": "$context.httpMethod",
21.     "principalId": "$context.authorizer.principalId",
22.     "stage": "$context.stage",
23. 
24.     "cognitoPoolClaims" : {
25.        extraCognitoPoolClaims
26.        "sub": "$context.authorizer.claims.sub"
27.     },
28. 
29.     #set( $map = $context.authorizer )
30.     "enhancedAuthContext": $loop,
31. 
32.     #set( $map = $input.params().header )
33.     "headers": $loop,
34. 
35.     #set( $map = $input.params().querystring )
36.     "query": $loop,
37. 
38.     #set( $map = $input.params().path )
39.     "path": $loop,
40. 
41.     #set( $map = $context.identity )
42.     "identity": $loop,
43. 
44.     #set( $map = $stageVariables )
45.     "stageVariables": $loop,
46. 
47.     "requestPath": "$context.resourcePath"
48.   }
49. `;
50. 
51. module.exports = {
52.   getMethodIntegration(http, { lambdaLogicalId, lambdaAliasName }) {
53.     const type = http.integration || 'AWS_PROXY';
54.     const integration = {
55.       IntegrationHttpMethod: 'POST',
56.       Type: type,
57.     };
58. 
59.     // Valid integrations are:
60.     // * `HTTP` for integrating with an HTTP back end,
61.     // * `AWS` for any AWS service endpoints,
62.     // * `MOCK` for testing without actually invoking the back end,
63.     // * `HTTP_PROXY` for integrating with the HTTP proxy integration, or
64.     // * `AWS_PROXY` for integrating with the Lambda proxy integration type (the default)
65.     if (type === 'AWS' || type === 'AWS_PROXY') {
66.       Object.assign(integration, {
67.         Uri: {
68.           'Fn::Join': [
69.             '',
70.             [
71.               'arn:',
72.               { Ref: 'AWS::Partition' },
73.               ':apigateway:',
74.               { Ref: 'AWS::Region' },
75.               ':lambda:path/2015-03-31/functions/',
76.               ...[],
77.               { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
78.               ...(lambdaAliasName ? [':', lambdaAliasName] : []),
79.               '/invocations',
80.             ],
81.           ],
82.         },
83.       });
84.     } else if (type === 'HTTP' || type === 'HTTP_PROXY') {
85.       const integrationHttpMethod = (http.request && http.request.method) || http.method;
86.       Object.assign(integration, {
87.         Uri: http.request && http.request.uri,
88.         IntegrationHttpMethod: integrationHttpMethod.toUpperCase(),
89.       });
90.       if (http.connectionType) {
91.         Object.assign(integration, {
92.           ConnectionType: http.connectionType,
93.           ConnectionId: http.connectionId,
94.         });
95.       }
96.     } else if (type === 'MOCK') {
97.       // nothing to do but kept here for reference
98.     }
99. 
100.     if (type === 'AWS' || type === 'HTTP' || type === 'MOCK') {
101.       Object.assign(integration, {
102.         PassthroughBehavior: http.request && http.request.passThrough,
103.         ContentHandling: http.request && http.request.contentHandling,
104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === 'AWS'),
105.         IntegrationResponses: this.getIntegrationResponses(http),
106.       });
107.     }
108.     if (
109.       ((type === 'AWS' || type === 'HTTP' || type === 'HTTP_PROXY') &&
110.         http.request &&
111.         http.request.parameters &&
112.         Object.keys(http.request.parameters).length) ||
113.       http.async
114.     ) {
115.       Object.assign(integration, {
116.         RequestParameters: this.getIntegrationRequestParameters(http),
117.       });
118.     }
119. 
120.     return {
121.       Properties: {
122.         Integration: integration,
123.       },
124.     };
125.   },
126. 
127.   getIntegrationResponses(http) {
128.     const integrationResponses = [];
129. 
130.     if (http.response) {
131.       const integrationResponseHeaders = [];
132. 
133.       if (http.cors) {
134.         let origin = http.cors.origin;
135. 
136.         // TODO remove once "origins" config is deprecated
137.         if (http.cors.origins && http.cors.origins.length) {
138.           origin = http.cors.origins.join(',');
139.         }
140. 
141.         _.merge(integrationResponseHeaders, {
142.           'Access-Control-Allow-Origin': `'${origin}'`,
143.         });
144. 
145.         // Only set Access-Control-Allow-Credentials when explicitly allowed (omit if false)
146.         if (http.cors.allowCredentials) {
147.           integrationResponseHeaders['Access-Control-Allow-Credentials'] = 'true';
148.         }
149.       }
150. 
151.       if (http.response.headers) {
152.         _.merge(integrationResponseHeaders, http.response.headers);
153.       }
154. 
155.       _.forEach(http.response.statusCodes, (config, statusCode) => {
156.         const responseParameters = _.mapKeys(
157.           integrationResponseHeaders,
158.           (value, header) => `method.response.header.${header}`
159.         );
160. 
161.         const integrationResponse = {
162.           StatusCode: statusCode,
163.           SelectionPattern: config.pattern || '',
164.           ResponseParameters: responseParameters,
165.           ResponseTemplates: {},
166.           ContentHandling: statusCode.startsWith('2') ? http.response.contentHandling : undefined,
167.         };
168. 
169.         if (config.headers) {
170.           _.merge(
171.             integrationResponse.ResponseParameters,
172.             _.mapKeys(config.headers, (value, header) => `method.response.header.${header}`)
173.           );
174.         }
175. 
176.         if (http.response.template) {
177.           _.merge(integrationResponse.ResponseTemplates, {
178.             'application/json': http.response.template,
179.           });
180.         }
181. 
182.         if (config.template) {
183.           const template =
184.             typeof config.template === 'string'
185.               ? { 'application/json': config.template }
186.               : config.template;
187. 
188.           _.merge(integrationResponse.ResponseTemplates, template);
189.         }
190. 
191.         integrationResponses.push(integrationResponse);
192.       });
193.     }
194. 
195.     return integrationResponses;
196.   },
197. 
198.   getIntegrationRequestTemplates(http, useDefaults) {
199.     // default request templates
200.     const integrationRequestTemplates = {};
201. 
202.     // Only set defaults for AWS (lambda) integration
203.     if (useDefaults) {
204.       Object.assign(integrationRequestTemplates, {
205.         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
206.         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
207.       });
208.     }
209. 
210.     // set custom request templates if provided
211.     if (http.request && typeof http.request.template === 'object') {
212.       Object.assign(integrationRequestTemplates, http.request.template);
213.     }
214. 
215.     return Object.keys(integrationRequestTemplates).length
216.       ? integrationRequestTemplates
217.       : undefined;
218.   },
219.   getIntegrationRequestParameters(http) {
220.     const parameters = {};
221.     if (http.request && http.request.parameters) {
222.       _.forEach(http.request.parameters, (value, key) => {
223.         parameters[`integration.${key.substring('method.'.length)}`] = value.mappedValue || key;
224.       });
225.     }
226. 
227.     if (http.async) {
228.       parameters['integration.request.header.X-Amz-Invocation-Type'] = "'Event'";
229.     }
230. 
231.     return parameters;
232.   },
233. 
234.   DEFAULT_JSON_REQUEST_TEMPLATE: `
235.     #set( $body = $input.json("$") )
236. 
237.     ${DEFAULT_COMMON_TEMPLATE}
238.   `,
239. 
240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `
241.     #define( $body )
242.       {
243.       #foreach( $token in $input.path('$').split('&') )
244.         #set( $keyVal = $token.split('=') )
245.         #set( $keyValSize = $keyVal.size() )
246.         #if( $keyValSize >= 1 )
247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )
248.           #if( $keyValSize >= 2 )
249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\'","'"))
250.           #else
251.             #set( $val = '' )
252.           #end
253.           "$key": "$val"#if($foreach.hasNext),#end
254.         #end
255.       #end
256.       }
257.     #end
258. 
259.     ${DEFAULT_COMMON_TEMPLATE}
260.   `,
261. };

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 19:50:49,607 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We have the exact implementation where default request templates are set (lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js) including logic that always adds both application/json and application/x-www-form-urlencoded for AWS (non-proxy) integration, and the official docs (docs/providers/aws/events/apigateway.md) confirming these defaults and describing only how to override, not remove them. This is sufficient to determine whether the behavior is configurable and to classify the issue. No other files or tests are essential for this classification.' query='' extra_requirements='' purpose=''
2025-11-13 19:50:49,610 - thread-135845287823040.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/events/apigateway.md', content='1. <!--\n2. title: Serverless Framework - AWS Lambda Events - API Gateway\n3. menuText: API Gateway\n4. menuOrder: 1\n5. description: Setting up AWS API Gateway Events with AWS Lambda via the Serverless Framework\n6. layout: Doc\n7. -->\n8. \n9. <!-- DOCS-SITE-LINK:START automatically generated  -->\n10. \n11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/apigateway)\n12. \n13. <!-- DOCS-SITE-LINK:END -->\n14. \n15. # API Gateway\n16. \n17. - [API Gateway](#api-gateway)\n18.   - [Lambda Proxy Integration](#lambda-proxy-integration)\n19.     - [Simple HTTP Endpoint](#simple-http-endpoint)\n20.     - [Example "LAMBDA-PROXY" event (default)](#example-lambda-proxy-event-default)\n21.     - [HTTP Endpoint with Extended Options](#http-endpoint-with-extended-options)\n22.     - [Enabling CORS](#enabling-cors)\n23.     - [HTTP Endpoints with `AWS_IAM` Authorizers](#http-endpoints-with-aws_iam-authorizers)\n24.     - [HTTP Endpoints with Custom Authorizers](#http-endpoints-with-custom-authorizers)\n25.     - [HTTP Endpoints with `operationId`](#http-endpoints-with-operationId)\n26.     - [Catching Exceptions In Your Lambda Function](#catching-exceptions-in-your-lambda-function)\n27.     - [Setting API keys for your Rest API](#setting-api-keys-for-your-rest-api)\n28.     - [Configuring endpoint types](#configuring-endpoint-types)\n29.     - [Request Parameters](#request-parameters)\n30.     - [Request Schema Validators](#request-schema-validators)\n31.     - [Setting source of API key for metering requests](#setting-source-of-api-key-for-metering-requests)\n32.   - [Lambda Integration](#lambda-integration)\n33.     - [Example "LAMBDA" event (before customization)](#example-lambda-event-before-customization)\n34.     - [Request templates](#request-templates)\n35.       - [Default Request Templates](#default-request-templates)\n36.       - [Custom Request Templates](#custom-request-templates)\n37.       - [Pass Through Behavior](#pass-through-behavior)\n38.     - [Responses](#responses)\n39.       - [Custom Response Headers](#custom-response-headers)\n40.       - [Custom Response Templates](#custom-response-templates)\n41.     - [Status Codes](#status-codes)\n42.       - [Available Status Codes](#available-status-codes)\n43.       - [Using Status Codes](#using-status-codes)\n44.       - [Custom Status Codes](#custom-status-codes)\n45.   - [Setting an HTTP Proxy on API Gateway](#setting-an-http-proxy-on-api-gateway)\n46.   - [Accessing private resources using VPC Link](#accessing-private-resources-using-vpc-link)\n47.   - [Mock Integration](#mock-integration)\n48.   - [Share API Gateway and API Resources](#share-api-gateway-and-api-resources)\n49.     - [Easiest and CI/CD friendly example of using shared API Gateway and API Resources.](#easiest-and-cicd-friendly-example-of-using-shared-api-gateway-and-api-resources)\n50.     - [Manually Configuring shared API Gateway](#manually-configuring-shared-api-gateway)\n51.       - [Note while using authorizers with shared API Gateway](#note-while-using-authorizers-with-shared-api-gateway)\n52.   - [Share Authorizer](#share-authorizer)\n53.   - [Resource Policy](#resource-policy)\n54.   - [Compression](#compression)\n55.   - [Binary Media Types](#binary-media-types)\n56.   - [Detailed CloudWatch Metrics](#detailed-cloudwatch-metrics)\n57.   - [AWS X-Ray Tracing](#aws-x-ray-tracing)\n58.   - [Tags / Stack Tags](#tags--stack-tags)\n59.   - [Logs](#logs)\n60. \n61. _Are you looking for tutorials on using API Gateway? Check out the following resources:_\n62. \n63. > - [Add a custom domain for your API Gateway](https://serverless.com/blog/serverless-api-gateway-domain/)\n64. > - [Deploy multiple micro-services under the same domain](https://serverless.com/blog/api-gateway-multiple-services/)\n65. > - [Create a Node REST API with Express.js](https://serverless.com/blog/serverless-express-rest-api/)\n66. > - [Make a Serverless GraphQL API](https://serverless.com/blog/make-serverless-graphql-api-using-lambda-dynamodb/)\n67. \n68. To create HTTP endpoints as Event sources for your AWS Lambda Functions, use the Serverless Framework\'s easy AWS API Gateway Events syntax.\n69. \n70. There are five ways you can configure your HTTP endpoints to integrate with your AWS Lambda Functions:\n71. \n72. - `lambda-proxy` / `aws-proxy` / `aws_proxy` (Recommended)\n73. - `lambda` / `aws`\n74. - `http`\n75. - `http-proxy` / `http_proxy`\n76. - `mock`\n77. \n78. **The Framework uses the `lambda-proxy` method (i.e., everything is passed into your Lambda) by default unless another method is supplied by the user**\n79. \n80. The difference between these is `lambda-proxy` (alternative writing styles are `aws-proxy` and `aws_proxy` for compatibility with the standard AWS integration type naming) automatically passes the content of the HTTP request into your AWS Lambda function (headers, body, etc.) and allows you to configure your response (headers, status code, body) in the code of your AWS Lambda Function. Whereas, the `lambda` method makes you explicitly define headers, status codes, and more in the configuration of each API Gateway Endpoint (not in code). We highly recommend using the `lambda-proxy` method if it supports your use-case, since the `lambda` method is highly tedious.\n81. \n82. Use `http` for integrating with an HTTP back end, `http-proxy` for integrating with the HTTP proxy integration or `mock` for testing without actually invoking the back end.\n83. \n84. ## Lambda Proxy Integration\n85. \n86. ### Simple HTTP Endpoint\n87. \n88. This setup specifies that the `hello` function should be run when someone accesses the API gateway at `hello` via\n89. a `GET` request.\n90. \n91. Here\'s an example:\n92. \n93. ```yml\n94. # serverless.yml\n95. \n96. functions:\n97.   index:\n98.     handler: handler.hello\n99.     events:\n100.       - http: GET hello\n101. ```\n102. \n103. ```javascript\n104. // handler.js\n105. \n106. \'use strict\';\n107. \n108. module.exports.hello = function(event, context, callback) {\n109.   console.log(event); // Contains incoming request data (e.g., query params, headers and more)\n110. \n111.   const response = {\n112.     statusCode: 200,\n113.     headers: {\n114.       \'x-custom-header\': \'My Header Value\',\n115.     },\n116.     body: JSON.stringify({ message: \'Hello World!\' }),\n117.   };\n118. \n119.   callback(null, response);\n120. };\n121. ```\n122. \n123. **Note:** When the body is a JSON-Document, you must parse it yourself:\n124. \n125. ```\n126. JSON.parse(event.body);\n127. ```\n128. \n129. ### Example "LAMBDA-PROXY" event (default)\n130. \n131. ```json\n132. {\n133.   "resource": "/",\n134.   "path": "/",\n135.   "httpMethod": "POST",\n136.   "headers": {\n137.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n138.     "Accept-Encoding": "gzip, deflate, br",\n139.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n140.     "cache-control": "max-age=0",\n141.     "CloudFront-Forwarded-Proto": "https",\n142.     "CloudFront-Is-Desktop-Viewer": "true",\n143.     "CloudFront-Is-Mobile-Viewer": "false",\n144.     "CloudFront-Is-SmartTV-Viewer": "false",\n145.     "CloudFront-Is-Tablet-Viewer": "false",\n146.     "CloudFront-Viewer-Country": "GB",\n147.     "content-type": "application/x-www-form-urlencoded",\n148.     "Host": "j3ap25j034.execute-api.eu-west-2.amazonaws.com",\n149.     "origin": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com",\n150.     "Referer": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com/dev/",\n151.     "upgrade-insecure-requests": "1",\n152.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n153.     "Via": "2.0 a3650115c5e21e2b5d133ce84464bea3.cloudfront.net (CloudFront)",\n154.     "X-Amz-Cf-Id": "0nDeiXnReyHYCkv8cc150MWCFCLFPbJoTs1mexDuKe2WJwK5ANgv2A==",\n155.     "X-Amzn-Trace-Id": "Root=1-597079de-75fec8453f6fd4812414a4cd",\n156.     "X-Forwarded-For": "50.129.117.14, 50.112.234.94",\n157.     "X-Forwarded-Port": "443",\n158.     "X-Forwarded-Proto": "https"\n159.   },\n160.   "queryStringParameters": null,\n161.   "pathParameters": null,\n162.   "stageVariables": null,\n163.   "requestContext": {\n164.     "path": "/dev/",\n165.     "accountId": "125002137610",\n166.     "resourceId": "qdolsr1yhk",\n167.     "stage": "dev",\n168.     "requestId": "0f2431a2-6d2f-11e7-b799-5152aa497861",\n169.     "identity": {\n170.       "cognitoIdentityPoolId": null,\n171.       "accountId": null,\n172.       "cognitoIdentityId": null,\n173.       "caller": null,\n174.       "apiKey": "",\n175.       "sourceIp": "50.129.117.14",\n176.       "accessKey": null,\n177.       "cognitoAuthenticationType": null,\n178.       "cognitoAuthenticationProvider": null,\n179.       "userArn": null,\n180.       "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n181.       "user": null\n182.     },\n183.     "resourcePath": "/",\n184.     "httpMethod": "POST",\n185.     "apiId": "j3azlsj0c4"\n186.   },\n187.   "body": "postcode=LS17FR",\n188.   "isBase64Encoded": false\n189. }\n190. ```\n191. \n192. ### HTTP Endpoint with Extended Options\n193. \n194. Here we\'ve defined an POST endpoint for the path `posts/create`.\n195. \n196. ```yml\n197. # serverless.yml\n198. \n199. functions:\n200.   create:\n201.     handler: posts.create\n202.     events:\n203.       - http:\n204.           path: posts/create\n205.           method: post\n206. ```\n207. \n208. ### Enabling CORS\n209. \n210. To set CORS configurations for your HTTP endpoints, simply modify your event configurations as follows:\n211. \n212. ```yml\n213. # serverless.yml\n214. \n215. functions:\n216.   hello:\n217.     handler: handler.hello\n218.     events:\n219.       - http:\n220.           path: hello\n221.           method: get\n222.           cors: true\n223. ```\n224. \n225. Setting `cors` to `true` assumes a default configuration which is equivalent to:\n226. \n227. ```yml\n228. functions:\n229.   hello:\n230.     handler: handler.hello\n231.     events:\n232.       - http:\n233.           path: hello\n234.           method: get\n235.           cors:\n236.             origin: \'*\'\n237.             headers:\n238.               - Content-Type\n239.               - X-Amz-Date\n240.               - Authorization\n241.               - X-Api-Key\n242.               - X-Amz-Security-Token\n243.               - X-Amz-User-Agent\n244.             allowCredentials: false\n245. ```\n246. \n247. To allow multiple origins, you can use the following configuration and provide an array in the `origins` or use comma separated `origin` field:\n248. \n249. ```yml\n250. functions:\n251.   hello:\n252.     handler: handler.hello\n253.     events:\n254.       - http:\n255.           path: hello\n256.           method: get\n257.           cors:\n258.             origins:\n259.               - http://example.com\n260.               - http://example2.com\n261.             headers:\n262.               - Content-Type\n263.               - X-Amz-Date\n264.               - Authorization\n265.               - X-Api-Key\n266.               - X-Amz-Security-Token\n267.               - X-Amz-User-Agent\n268.             allowCredentials: false\n269. ```\n270. \n271. Wildcards are accepted. The following example will match all sub-domains of example.com over http:\n272. \n273. ```yml\n274. cors:\n275.   origins:\n276.     - http://*.example.com\n277.     - http://example2.com\n278. ```\n279. \n280. Please note that since you can\'t send multiple values for [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), this configuration uses a response template to check if the request origin matches one of your provided `\n281. origins` and overrides the header with the following code:\n282. \n283. ```\n284. #set($origin = $input.params("Origin")\n285. #if($origin == "http://example.com" || $origin == "http://*.amazonaws.com") #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end\n286. ```\n287. \n288. Configuring the `cors` property sets [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), [Access-Control-Allow-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers), [Access-Control-Allow-Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods),[Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) headers in the CORS preflight response.\n289. \n290. If you use the lambda integration, the Access-Control-Allow-Origin and Access-Control-Allow-Credentials will also be provided to the method and integration responses.\n291. \n292. Please note that the [Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)-Header is omitted when not explicitly set to `true`.\n293. \n294. To enable the `Access-Control-Max-Age` preflight response header, set the `maxAge` property in the `cors` object:\n295. \n296. ```yml\n297. functions:\n298.   hello:\n299.     handler: handler.hello\n300.     events:\n301.       - http:\n302.           path: hello\n303.           method: get\n304.           cors:\n305.             origin: \'*\'\n306.             maxAge: 86400\n307. ```\n308. \n309. If you are using CloudFront or another CDN for your API Gateway, you may want to setup a `Cache-Control` header to allow for OPTIONS request to be cached to avoid the additional hop.\n310. \n311. To enable the `Cache-Control` header on preflight response, set the `cacheControl` property in the `cors` object:\n312. \n313. ```yml\n314. functions:\n315.   hello:\n316.     handler: handler.hello\n317.     events:\n318.       - http:\n319.           path: hello\n320.           method: get\n321.           cors:\n322.             origin: \'*\'\n323.             headers:\n324.               - Content-Type\n325.               - X-Amz-Date\n326.               - Authorization\n327.               - X-Api-Key\n328.               - X-Amz-Security-Token\n329.               - X-Amz-User-Agent\n330.             allowCredentials: false\n331.             cacheControl: \'max-age=600, s-maxage=600, proxy-revalidate\' # Caches on browser and proxy for 10 minutes and doesnt allow proxy to serve out of date content\n332. ```\n333. \n334. CORS header accepts single value too\n335. \n336. ```yml\n337. functions:\n338.   hello:\n339.     handler: handler.hello\n340.     events:\n341.       - http:\n342.           path: hello\n343.           method: get\n344.           cors:\n345.             headers: \'*\'\n346. ```\n347. \n348. If you want to use CORS with the lambda-proxy integration, remember to include the `Access-Control-Allow-*` headers in your headers object, like this:\n349. \n350. ```javascript\n351. // handler.js\n352. \n353. \'use strict\';\n354. \n355. module.exports.hello = function(event, context, callback) {\n356.   const response = {\n357.     statusCode: 200,\n358.     headers: {\n359.       \'Access-Control-Allow-Origin\': \'*\', // Required for CORS support to work\n360.       \'Access-Control-Allow-Credentials\': true, // Required for cookies, authorization headers with HTTPS\n361.     },\n362.     body: JSON.stringify({ message: \'Hello World!\' }),\n363.   };\n364. \n365.   callback(null, response);\n366. };\n367. ```\n368. \n369. ### HTTP Endpoints with `AWS_IAM` Authorizers\n370. \n371. If you want to require that the caller submit the IAM user\'s access keys in order to be authenticated to invoke your Lambda Function, set the authorizer to `AWS_IAM` as shown in the following example:\n372. \n373. ```yml\n374. functions:\n375.   create:\n376.     handler: posts.create\n377.     events:\n378.       - http:\n379.           path: posts/create\n380.           method: post\n381.           authorizer: aws_iam\n382. ```\n383. \n384. Which is the short hand notation for:\n385. \n386. ```yml\n387. functions:\n388.   create:\n389.     handler: posts.create\n390.     events:\n391.       - http:\n392.           path: posts/create\n393.           method: post\n394.           authorizer:\n395.             type: aws_iam\n396. ```\n397. \n398. ### HTTP Endpoints with Custom Authorizers\n399. \n400. Custom Authorizers allow you to run an AWS Lambda Function before your targeted AWS Lambda Function. This is useful for Microservice Architectures or when you simply want to do some Authorization before running your business logic.\n401. \n402. You can enable Custom Authorizers for your HTTP endpoint by setting the Authorizer in your `http` event to another function\n403. in the same service, as shown in the following example:\n404. \n405. ```yml\n406. functions:\n407.   create:\n408.     handler: posts.create\n409.     events:\n410.       - http:\n411.           path: posts/create\n412.           method: post\n413.           authorizer: authorizerFunc\n414.   authorizerFunc:\n415.     handler: handler.authorizerFunc\n416. ```\n417. \n418. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as\n419. shown in the following example:\n420. \n421. ```yml\n422. functions:\n423.   create:\n424.     handler: posts.create\n425.     events:\n426.       - http:\n427.           path: posts/create\n428.           method: post\n429.           authorizer:\n430.             name: authorizerFunc\n431.             resultTtlInSeconds: 0\n432.             identitySource: method.request.header.Authorization\n433.             identityValidationExpression: someRegex\n434.             type: token\n435.   authorizerFunc:\n436.     handler: handler.authorizerFunc\n437. ```\n438. \n439. If the Authorizer function does not exist in your service but exists in AWS, you can provide the ARN of the Lambda\n440. function instead of the function name, as shown in the following example:\n441. \n442. ```yml\n443. functions:\n444.   create:\n445.     handler: posts.create\n446.     events:\n447.       - http:\n448.           path: posts/create\n449.           method: post\n450.           authorizer: xxx:xxx:Lambda-Name\n451. ```\n452. \n453. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as\n454. shown in the following example:\n455. \n456. ```yml\n457. functions:\n458.   create:\n459.     handler: posts.create\n460.     events:\n461.       - http:\n462.           path: posts/create\n463.           method: post\n464.           authorizer:\n465.             arn: xxx:xxx:Lambda-Name\n466.             managedExternally: false\n467.             resultTtlInSeconds: 0\n468.             identitySource: method.request.header.Authorization\n469.             identityValidationExpression: someRegex\n470. ```\n471. \n472. If permissions for the Authorizer function are managed externally (for example, if the Authorizer function exists\n473. in a different AWS account), you can skip creating the permission for the function by setting `managedExternally: true`,\n474. as shown in the following example:\n475. \n476. ```yml\n477. functions:\n478.   create:\n479.     handler: posts.create\n480.     events:\n481.       - http:\n482.           path: posts/create\n483.           method: post\n484.           authorizer:\n485.             arn: xxx:xxx:Lambda-Name\n486.             managedExternally: true\n487. ```\n488. \n489. **IMPORTANT NOTE**: The permission allowing the authorizer function to be called by API Gateway must exist\n490. before deploying the stack, otherwise deployment will fail.\n491. \n492. You can also use the Request Type Authorizer by setting the `type` property. In this case, your `identitySource` could contain multiple entries for your policy cache. The default `type` is \'token\'.\n493. \n494. ```yml\n495. functions:\n496.   create:\n497.     handler: posts.create\n498.     events:\n499.       - http:\n500.           path: posts/create\n501.           method: post\n502.           authorizer:\n503.             arn: xxx:xxx:Lambda-Name\n504.             resultTtlInSeconds: 0\n505.             identitySource: method.request.header.Authorization, context.identity.sourceIp\n506.             identityValidationExpression: someRegex\n507.             type: request\n508. ```\n509. \n510. You can also configure an existing Cognito User Pool as the authorizer, as shown\n511. in the following example with optional access token allowed scopes:\n512. \n513. ```yml\n514. functions:\n515.   create:\n516.     handler: posts.create\n517.     events:\n518.       - http:\n519.           path: posts/create\n520.           method: post\n521.           authorizer:\n522.             arn: arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ\n523.             scopes:\n524.               - my-app/read\n525. ```\n526. \n527. If you are using the default `lambda-proxy` integration, your attributes will be\n528. exposed at `event.requestContext.authorizer.claims`.\n529. \n530. If you want more control over which attributes are exposed as claims you\n531. can switch to `integration: lambda` and add the following configuration. The\n532. claims will be exposed at `events.cognitoPoolClaims`.\n533. \n534. ```yml\n535. functions:\n536.   create:\n537.     handler: posts.create\n538.     events:\n539.       - http:\n540.           path: posts/create\n541.           method: post\n542.           integration: lambda\n543.           authorizer:\n544.             arn: arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ\n545.             claims:\n546.               - email\n547.               - nickname\n548. ```\n549. \n550. If you are creating the Cognito User Pool in the `resources` section of the same template, you can refer to the ARN using the `Fn::GetAtt` attribute from CloudFormation. To do so, you _must_ give your authorizer a name and specify a type of `COGNITO_USER_POOLS`:\n551. \n552. ```yml\n553. functions:\n554.   create:\n555.     handler: posts.create\n556.     events:\n557.       - http:\n558.           path: posts/create\n559.           method: post\n560.           integration: lambda\n561.           authorizer:\n562.             name: MyAuthorizer\n563.             type: COGNITO_USER_POOLS\n564.             arn:\n565.               Fn::GetAtt:\n566.                 - CognitoUserPool\n567.                 - Arn\n568. ---\n569. resources:\n570.   Resources:\n571.     CognitoUserPool:\n572.       Type: \'AWS::Cognito::UserPool\'\n573.       Properties: ...\n574. ```\n575. \n576. ### HTTP Endpoints with `operationId`\n577. \n578. Include `operationId` when you want to provide a name for the method endpoint. This will set `OperationName` inside `AWS::ApiGateway::Method` accordingly. One common use case for this is customizing method names in some code generators (e.g., swagger).\n579. \n580. ```yml\n581. functions:\n582.   create:\n583.     handler: users.create\n584.     events:\n585.       - http:\n586.           path: users/create\n587.           method: post\n588.           operationId: createUser\n589. ```\n590. \n591. ### Using asynchronous integration\n592. \n593. Use `async: true` when integrating a lambda function using [event invocation](https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html#SSS-Invoke-request-InvocationType). This lets API Gateway to return immediately with a 200 status code while the lambda continues running. If not otherwise specified integration type will be `AWS`.\n594. \n595. ```yml\n596. functions:\n597.   create:\n598.     handler: posts.create\n599.     events:\n600.       - http:\n601.           path: posts/create\n602.           method: post\n603.           async: true # default is false\n604. ```\n605. \n606. ### Catching Exceptions In Your Lambda Function\n607. \n608. In case an exception is thrown in your lambda function AWS will send an error message with `Process exited before completing request`. This will be caught by the regular expression for the 500 HTTP status and the 500 status will be returned.\n609. \n610. ### Setting API keys for your Rest API\n611. \n612. You can specify a list of API keys to be used by your service Rest API by adding an `apiKeys` array property to the\n613. `provider` object in `serverless.yml`. You\'ll also need to explicitly specify which endpoints are `private` and require\n614. one of the api keys to be included in the request by adding a `private` boolean property to the `http` event object you\n615. want to set as private. API Keys are created globally, so if you want to deploy your service to different stages make sure\n616. your API key contains a stage variable as defined below. When using API keys, you can optionally define usage plan quota\n617. and throttle, using `usagePlan` object.\n618. \n619. When setting the value, you need to be aware that changing value will require replacement and CloudFormation doesn\'t allow\n620. two API keys with the same name. It means that you need to change the name also when changing the value. If you don\'t care\n621. about the name of the key, it is recommended only to set the value and let CloudFormation name the key.\n622. \n623. Here\'s an example configuration for setting API keys for your service Rest API:\n624. \n625. ```yml\n626. service: my-service\n627. provider:\n628.   name: aws\n629.   apiKeys:\n630.     - myFirstKey\n631.     - ${opt:stage}-myFirstKey\n632.     - ${env:MY_API_KEY} # you can hide it in a serverless variable\n633.     - name: myThirdKey\n634.       value: myThirdKeyValue\n635.     - value: myFourthKeyValue # let cloudformation name the key (recommended when setting api key value)\n636.       description: Api key description # Optional\n637.       customerId: A string that will be set as the customerID for the key # Optional\n638.   usagePlan:\n639.     quota:\n640.       limit: 5000\n641.       offset: 2\n642.       period: MONTH\n643.     throttle:\n644.       burstLimit: 200\n645.       rateLimit: 100\n646. functions:\n647.   hello:\n648.     events:\n649.       - http:\n650.           path: user/create\n651.           method: get\n652.           private: true\n653. ```\n654. \n655. Please note that those are the API keys names, not the actual values. Once you deploy your service, the value of those API keys will be auto generated by AWS and printed on the screen for you to use. The values can be concealed from the output with the `--conceal` deploy option.\n656. \n657. Clients connecting to this Rest API will then need to set any of these API keys values in the `x-api-key` header of their request. This is only necessary for functions where the `private` property is set to true.\n658. \n659. You can also setup multiple usage plans for your API. In this case you need to map your usage plans to your api keys. Here\'s an example how this might look like:\n660. \n661. ```yml\n662. service: my-service\n663. provider:\n664.   name: aws\n665.   apiKeys:\n666.     - free:\n667.         - myFreeKey\n668.         - ${opt:stage}-myFreeKey\n669.     - paid:\n670.         - myPaidKey\n671.         - ${opt:stage}-myPaidKey\n672.   usagePlan:\n673.     - free:\n674.         quota:\n675.           limit: 5000\n676.           offset: 2\n677.           period: MONTH\n678.         throttle:\n679.           burstLimit: 200\n680.           rateLimit: 100\n681.     - paid:\n682.         quota:\n683.           limit: 50000\n684.           offset: 1\n685.           period: MONTH\n686.         throttle:\n687.           burstLimit: 2000\n688.           rateLimit: 1000\n689. functions:\n690.   hello:\n691.     events:\n692.       - http:\n693.           path: user/create\n694.           method: get\n695.           private: true\n696. ```\n697. \n698. ### Configuring endpoint types\n699. \n700. API Gateway [supports regional endpoints](https://aws.amazon.com/about-aws/whats-new/2017/11/amazon-api-gateway-supports-regional-api-endpoints/) for associating your API Gateway REST APIs with a particular region. This can reduce latency if your requests originate from the same region as your REST API and can be helpful in building multi-region applications.\n701. \n702. By default, the Serverless Framework deploys your REST API using the EDGE endpoint configuration. If you would like to use the REGIONAL or PRIVATE configuration, set the `endpointType` parameter in your `provider` block.\n703. \n704. Here\'s an example configuration for setting the endpoint configuration for your service Rest API:\n705. \n706. ```yml\n707. service: my-service\n708. provider:\n709.   name: aws\n710.   endpointType: REGIONAL\n711. functions:\n712.   hello:\n713.     events:\n714.       - http:\n715.           path: user/create\n716.           method: get\n717. ```\n718. \n719. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n720. \n721. ```\n722. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n723. ```\n724. \n725. Here\'s an example configuration:\n726. \n727. ```yml\n728. service: my-service\n729. provider:\n730.   name: aws\n731.   endpointType: PRIVATE\n732.   vpcEndpointIds:\n733.     - vpce-123\n734.     - vpce-456\n735. ```\n736. \n737. ### Request Parameters\n738. \n739. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n740. \n741. ```yml\n742. functions:\n743.   create:\n744.     handler: posts.create\n745.     events:\n746.       - http:\n747.           path: posts/create\n748.           method: post\n749.           request:\n750.             parameters:\n751.               querystrings:\n752.                 url: true\n753.               headers:\n754.                 foo: false\n755.               paths:\n756.                 bar: false\n757. ```\n758. \n759. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n760. \n761. ```yml\n762. functions:\n763.   create:\n764.     handler: posts.post_detail\n765.     events:\n766.       - http:\n767.           path: posts/{id}\n768.           method: get\n769.           request:\n770.             parameters:\n771.               paths:\n772.                 id: true\n773. ```\n774. \n775. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n776. \n777. ```yml\n778. functions:\n779.   create:\n780.     handler: posts.post_detail\n781.     events:\n782.       - http:\n783.           path: posts/{id}\n784.           method: get\n785.           request:\n786.             parameters:\n787.               paths:\n788.                 id: true\n789.               headers:\n790.                 custom-header:\n791.                   required: true\n792.                   mappedValue: context.requestId\n793. ```\n794. \n795. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n796. \n797. ### Request Schema Validators\n798. \n799. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n800. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n801. file.\n802. \n803. ```yml\n804. functions:\n805.   create:\n806.     handler: posts.create\n807.     events:\n808.       - http:\n809.           path: posts/create\n810.           method: post\n811.           request:\n812.             schema:\n813.               application/json: ${file(create_request.json)}\n814. ```\n815. \n816. A sample schema contained in `create_request.json` might look something like this:\n817. \n818. ```json\n819. {\n820.   "definitions": {},\n821.   "$schema": "http://json-schema.org/draft-04/schema#",\n822.   "type": "object",\n823.   "title": "The Root Schema",\n824.   "required": ["username"],\n825.   "properties": {\n826.     "username": {\n827.       "type": "string",\n828.       "title": "The Foo Schema",\n829.       "default": "",\n830.       "pattern": "^[a-zA-Z0-9]+$"\n831.     }\n832.   }\n833. }\n834. ```\n835. \n836. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n837. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n838. \n839. ### Setting source of API key for metering requests\n840. \n841. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n842. \n843. ```yml\n844. service: my-service\n845. provider:\n846.   name: aws\n847.   apiGateway:\n848.     apiKeySourceType: HEADER\n849. functions:\n850.   hello:\n851.     events:\n852.       - http:\n853.           path: hello\n854.           method: get\n855. ```\n856. \n857. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n858. \n859. ```yml\n860. service: my-service\n861. provider:\n862.   name: aws\n863.   apiGateway:\n864.     apiKeySourceType: AUTHORIZER\n865. functions:\n866.   hello:\n867.     events:\n868.       - http:\n869.           path: hello\n870.           method: get\n871. ```\n872. \n873. ## Lambda Integration\n874. \n875. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n876. \n877. ### Example "LAMBDA" event (before customization)\n878. \n879. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n880. \n881. ```json\n882. {\n883.   "body": {},\n884.   "method": "GET",\n885.   "principalId": "",\n886.   "stage": "dev",\n887.   "cognitoPoolClaims": {\n888.     "sub": ""\n889.   },\n890.   "enhancedAuthContext": {},\n891.   "headers": {\n892.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n893.     "Accept-Encoding": "gzip, deflate, br",\n894.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n895.     "CloudFront-Forwarded-Proto": "https",\n896.     "CloudFront-Is-Desktop-Viewer": "true",\n897.     "CloudFront-Is-Mobile-Viewer": "false",\n898.     "CloudFront-Is-SmartTV-Viewer": "false",\n899.     "CloudFront-Is-Tablet-Viewer": "false",\n900.     "CloudFront-Viewer-Country": "GB",\n901.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n902.     "upgrade-insecure-requests": "1",\n903.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n904.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n905.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n906.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n907.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n908.     "X-Forwarded-Port": "443",\n909.     "X-Forwarded-Proto": "https"\n910.   },\n911.   "query": {},\n912.   "path": {},\n913.   "identity": {\n914.     "cognitoIdentityPoolId": "",\n915.     "accountId": "",\n916.     "cognitoIdentityId": "",\n917.     "caller": "",\n918.     "apiKey": "",\n919.     "sourceIp": "94.197.120.169",\n920.     "accessKey": "",\n921.     "cognitoAuthenticationType": "",\n922.     "cognitoAuthenticationProvider": "",\n923.     "userArn": "",\n924.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n925.     "user": ""\n926.   },\n927.   "stageVariables": {},\n928.   "requestPath": "/request/path"\n929. }\n930. ```\n931. \n932. ### Request templates\n933. \n934. #### Default Request Templates\n935. \n936. Serverless ships with the following default request templates you can use out of the box:\n937. \n938. 1. `application/json`\n939. 2. `application/x-www-form-urlencoded`\n940. \n941. Both templates give you access to the following properties you can access with the help of the `event` object:\n942. \n943. - body\n944. - method\n945. - principalId\n946. - stage\n947. - headers\n948. - queryStringParameters\n949. - path\n950. - identity\n951. - stageVariables\n952. - requestPath\n953. \n954. #### Custom Request Templates\n955. \n956. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n957. by defining a new request template for an existing content type):\n958. \n959. ```yml\n960. functions:\n961.   create:\n962.     handler: posts.create\n963.     events:\n964.       - http:\n965.           method: get\n966.           path: whatever\n967.           integration: lambda\n968.           request:\n969.             template:\n970.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n971.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n972. ```\n973. \n974. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n975. \n976. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n977. \n978. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n979. \n980. ```yml\n981. functions:\n982.   create:\n983.     handler: posts.create\n984.     events:\n985.       - http:\n986.           method: get\n987.           path: whatever\n988.           integration: lambda\n989.           request:\n990.             template:\n991.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n992. ```\n993. \n994. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n995. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n996. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n997. \n998. #### Pass Through Behavior\n999. \n1000. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1001. \n1002. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1003. \n1004. ```yml\n1005. functions:\n1006.   create:\n1007.     handler: posts.create\n1008.     events:\n1009.       - http:\n1010.           method: get\n1011.           path: whatever\n1012.           integration: lambda\n1013.           request:\n1014.             passThrough: NEVER\n1015. ```\n1016. \n1017. There are 3 available options:\n1018. \n1019. | Value             | Passed Through When                          | Rejected When                                                          |\n1020. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1021. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1022. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1023. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1024. \n1025. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1026. \n1027. **Notes:**\n1028. \n1029. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1030. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1031. \n1032. ### Responses\n1033. \n1034. Serverless lets you setup custom headers and a response template for your `http` event.\n1035. \n1036. #### Custom Response Headers\n1037. \n1038. Here\'s an example which shows you how you can setup a custom response header:\n1039. \n1040. ```yml\n1041. functions:\n1042.   create:\n1043.     handler: posts.create\n1044.     events:\n1045.       - http:\n1046.           method: get\n1047.           path: whatever\n1048.           integration: lambda\n1049.           response:\n1050.             headers:\n1051.               Content-Type: integration.response.header.Content-Type\n1052.               Cache-Control: "\'max-age=120\'"\n1053. ```\n1054. \n1055. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1056. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1057. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1058. \n1059. #### Custom Response Templates\n1060. \n1061. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1062. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1063. \n1064. ```yml\n1065. functions:\n1066.   create:\n1067.     handler: posts.create\n1068.     events:\n1069.       - http:\n1070.           method: get\n1071.           path: whatever\n1072.           integration: lambda\n1073.           response:\n1074.             headers:\n1075.               Content-Type: "\'text/html\'"\n1076.             template: $input.path(\'$\')\n1077. ```\n1078. \n1079. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1080. the `${file(templatefile)}` syntax.\n1081. \n1082. ### Status Codes\n1083. \n1084. Serverless ships with default status codes you can use to e.g. signal that a resource could not be found (404) or that\n1085. the user is not authorized to perform the action (401). Those status codes are regex definitions that will be added to your API Gateway configuration.\n1086. \n1087. **_Note:_** Status codes as documented in this chapter relate to `lambda` integration method (as documented at the top of this page). If using default integration method `lambda-proxy` object with status code and message should be returned as in the example below:\n1088. \n1089. ```javascript\n1090. module.exports.hello = (event, context, callback) => {\n1091.   callback(null, { statusCode: 404, body: \'Not found\', headers: { \'Content-Type\': \'text/plain\' } });\n1092. };\n1093. ```\n1094. \n1095. #### Available Status Codes\n1096. \n1097. | Status Code | Meaning               |\n1098. | ----------- | --------------------- |\n1099. | 400         | Bad Request           |\n1100. | 401         | Unauthorized          |\n1101. | 403         | Forbidden             |\n1102. | 404         | Not Found             |\n1103. | 422         | Unprocessable Entity  |\n1104. | 500         | Internal Server Error |\n1105. | 502         | Bad Gateway           |\n1106. | 504         | Gateway Timeout       |\n1107. \n1108. #### Using Status Codes\n1109. \n1110. To return a given status code you simply need to add square brackets with the status code of your choice to your\n1111. returned message like this: `[401] You are not authorized to access this resource!`.\n1112. \n1113. Here\'s an example which shows you how you can raise a 404 HTTP status from within your lambda function.\n1114. \n1115. ```javascript\n1116. module.exports.hello = (event, context, callback) => {\n1117.   callback(new Error(\'[404] Not found\'));\n1118. };\n1119. ```\n1120. \n1121. #### Custom Status Codes\n1122. \n1123. You can override the defaults status codes supplied by Serverless. You can use this to change the default status code, add/remove status codes, or change the templates and headers used for each status code. Use the pattern key to change the selection process that dictates what code is returned.\n1124. \n1125. If you specify a status code with a pattern of \'\' that will become the default response code. See below on how to change the default to 201 for post requests.\n1126. \n1127. If you omit any default status code. A standard default 200 status code will be generated for you.\n1128. \n1129. ```yml\n1130. functions:\n1131.   create:\n1132.     handler: posts.create\n1133.     events:\n1134.       - http:\n1135.           method: post\n1136.           path: whatever\n1137.           integration: lambda\n1138.           response:\n1139.             headers:\n1140.               Content-Type: "\'text/html\'"\n1141.             template: $input.path(\'$\')\n1142.             statusCodes:\n1143.               201:\n1144.                 pattern: \'\' # Default response method\n1145.               409:\n1146.                 pattern: \'.*"statusCode":409,.*\' # JSON response\n1147.                 template: $input.path("$.errorMessage") # JSON return object\n1148.                 headers:\n1149.                   Content-Type: "\'application/json+hal\'"\n1150. ```\n1151. \n1152. You can also create varying response templates for each code and content type by creating an object with the key as the content type\n1153. \n1154. ```yml\n1155. functions:\n1156.   create:\n1157.     handler: posts.create\n1158.     events:\n1159.       - http:\n1160.           method: post\n1161.           path: whatever\n1162.           integration: lambda\n1163.           response:\n1164.             headers:\n1165.               Content-Type: "\'text/html\'"\n1166.             template: $input.path(\'$\')\n1167.             statusCodes:\n1168.               201:\n1169.                 pattern: \'\' # Default response method\n1170.               409:\n1171.                 pattern: \'.*"statusCode":409,.*\' # JSON response\n1172.                 template:\n1173.                   application/json: $input.path("$.errorMessage") # JSON return object\n1174.                   application/xml: $input.path("$.body.errorMessage") # XML return object\n1175.                 headers:\n1176.                   Content-Type: "\'application/json+hal\'"\n1177. ```\n1178. \n1179. ## Setting an HTTP Proxy on API Gateway\n1180. \n1181. To set up an HTTP proxy, you\'ll need two CloudFormation templates, one for the endpoint (known as resource in CF), and\n1182. one for method. These two templates will work together to construct your proxy. So if you want to set `your-app.com/serverless` as a proxy for `serverless.com`, you\'ll need the following two templates in your `serverless.yml`:\n1183. \n1184. ```yml\n1185. service: service-name\n1186. provider: aws\n1187. functions: ...\n1188. \n1189. resources:\n1190.   Resources:\n1191.     ProxyResource:\n1192.       Type: AWS::ApiGateway::Resource\n1193.       Properties:\n1194.         ParentId:\n1195.           Fn::GetAtt:\n1196.             - ApiGatewayRestApi # our default Rest API logical ID\n1197.             - RootResourceId\n1198.         PathPart: serverless # the endpoint in your API that is set as proxy\n1199.         RestApiId:\n1200.           Ref: ApiGatewayRestApi\n1201.     ProxyMethod:\n1202.       Type: AWS::ApiGateway::Method\n1203.       Properties:\n1204.         ResourceId:\n1205.           Ref: ProxyResource\n1206.         RestApiId:\n1207.           Ref: ApiGatewayRestApi\n1208.         HttpMethod: GET # the method of your proxy. Is it GET or POST or ... ?\n1209.         MethodResponses:\n1210.           - StatusCode: 200\n1211.         Integration:\n1212.           IntegrationHttpMethod: POST\n1213.           Type: HTTP\n1214.           Uri: http://serverless.com # the URL you want to set a proxy to\n1215.           IntegrationResponses:\n1216.             - StatusCode: 200\n1217. ```\n1218. \n1219. There\'s a lot going on in these two templates, but all you need to know to set up a simple proxy is setting the method &\n1220. endpoint of your proxy, and the URI you want to set a proxy to.\n1221. \n1222. Now that you have these two CloudFormation templates defined in your `serverless.yml` file, you can simply run\n1223. `serverless deploy` and that will deploy these custom resources for you along with your service and set up a proxy on your Rest API.\n1224. \n1225. ## Accessing private resources using VPC Link\n1226. \n1227. If you have an Edge Optimized or Regional API Gateway, you can access the internal VPC resources using VPC Link. Please refer [AWS documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-private-integration.html) to know more about API Gateway private integration.\n1228. \n1229. We can use following configuration to have an http-proxy vpc-link integration.\n1230. \n1231. ```yml\n1232. - http:\n1233.     path: v1/repository\n1234.     method: get\n1235.     integration: http-proxy\n1236.     connectionType: vpc-link\n1237.     connectionId: \'{your-vpc-link-id}\'\n1238.     cors: true\n1239.     request:\n1240.       uri: http://www.github.com/v1/repository\n1241.       method: get\n1242. ```\n1243. \n1244. ## Mock Integration\n1245. \n1246. Mocks allow developers to offer simulated methods for an API, with this, responses can be defined directly, without the need for a integration backend. A simple mock response example is provided below:\n1247. \n1248. ```yml\n1249. functions:\n1250.   hello:\n1251.     handler: handler.hello\n1252.     events:\n1253.       - http:\n1254.           path: hello\n1255.           cors: true\n1256.           method: get\n1257.           integration: mock\n1258.           request:\n1259.             template:\n1260.               application/json: \'{"statusCode": 200}\'\n1261.           response:\n1262.             template: $input.path(\'$\')\n1263.             statusCodes:\n1264.               201:\n1265.                 pattern: \'\'\n1266. ```\n1267. \n1268. ## Share API Gateway and API Resources\n1269. \n1270. As your application grows, you will likely need to break it out into multiple, smaller services. By default, each Serverless project generates a new API Gateway. However, you can share the same API Gateway between multiple projects by referencing its REST API ID and Root Resource ID in `serverless.yml` as follows:\n1271. \n1272. ```yml\n1273. service: service-name\n1274. provider:\n1275.   name: aws\n1276.   apiGateway:\n1277.     restApiId: xxxxxxxxxx # REST API resource ID. Default is generated by the framework\n1278.     restApiRootResourceId: xxxxxxxxxx # Root resource, represent as / path\n1279.     websocketApiId: xxxxxxxxxx # Websocket API resource ID. Default is generated by the framework\n1280.     description: Some Description # optional - description of deployment history\n1281. \n1282. functions: ...\n1283. ```\n1284. \n1285. If your application has many nested paths, you might also want to break them out into smaller services.\n1286. \n1287. ```yml\n1288. service: service-a\n1289. provider:\n1290.   apiGateway:\n1291.     restApiId: xxxxxxxxxx\n1292.     restApiRootResourceId: xxxxxxxxxx\n1293.     websocketApiId: xxxxxxxxxx\n1294.     description: Some Description\n1295. \n1296. functions:\n1297.   create:\n1298.     handler: posts.create\n1299.     events:\n1300.       - http:\n1301.           method: post\n1302.           path: /posts\n1303. ```\n1304. \n1305. ```yml\n1306. service: service-b\n1307. provider:\n1308.   apiGateway:\n1309.     restApiId: xxxxxxxxxx\n1310.     restApiRootResourceId: xxxxxxxxxx\n1311.     websocketApiId: xxxxxxxxxx\n1312.     description: Some Description\n1313. \n1314. functions:\n1315.   create:\n1316.     handler: posts.createComment\n1317.     events:\n1318.       - http:\n1319.           method: post\n1320.           path: /posts/{id}/comments\n1321. ```\n1322. \n1323. The above example services both reference the same parent path `/posts`. However, Cloudformation will throw an error if we try to generate an existing path resource. To avoid that, we reference the resource ID of `/posts`:\n1324. \n1325. ```yml\n1326. service: service-a\n1327. provider:\n1328.   apiGateway:\n1329.     restApiId: xxxxxxxxxx\n1330.     restApiRootResourceId: xxxxxxxxxx\n1331.     websocketApiId: xxxxxxxxxx\n1332.     description: Some Description\n1333.     restApiResources:\n1334.       posts: xxxxxxxxxx\n1335. \n1336. functions: ...\n1337. ```\n1338. \n1339. ```yml\n1340. service: service-b\n1341. provider:\n1342.   apiGateway:\n1343.     restApiId: xxxxxxxxxx\n1344.     restApiRootResourceId: xxxxxxxxxx\n1345.     websocketApiId: xxxxxxxxxx\n1346.     description: Some Description\n1347.     restApiResources:\n1348.       /posts: xxxxxxxxxx\n1349. \n1350. functions: ...\n1351. ```\n1352. \n1353. You can define more than one path resource, but by default, Serverless will generate them from the root resource.\n1354. `restApiRootResourceId` is optional if a path resource isn\'t required for the root (`/`).\n1355. \n1356. ```yml\n1357. service: service-a\n1358. provider:\n1359.   apiGateway:\n1360.     restApiId: xxxxxxxxxx\n1361.     # restApiRootResourceId: xxxxxxxxxx # Optional\n1362.     websocketApiId: xxxxxxxxxx\n1363.     description: Some Description\n1364.     restApiResources:\n1365.       /posts: xxxxxxxxxx\n1366.       /categories: xxxxxxxxx\n1367. \n1368. functions:\n1369.   listPosts:\n1370.     handler: posts.list\n1371.     events:\n1372.       - http:\n1373.           method: get\n1374.           path: /posts\n1375. \n1376.   listCategories:\n1377.     handler: categories.list\n1378.     events:\n1379.       - http:\n1380.           method: get\n1381.           path: /categories\n1382. ```\n1383. \n1384. ### Easiest and CI/CD friendly example of using shared API Gateway and API Resources.\n1385. \n1386. You can define your API Gateway resource in its own service and export the `restApiId`, `restApiRootResourceId` and `websocketApiId` using cloudformation cross-stack references.\n1387. \n1388. ```yml\n1389. service: my-api\n1390. \n1391. provider:\n1392.   name: aws\n1393.   runtime: nodejs12.x\n1394.   stage: dev\n1395.   region: eu-west-2\n1396. \n1397. resources:\n1398.   Resources:\n1399.     MyApiGW:\n1400.       Type: AWS::ApiGateway::RestApi\n1401.       Properties:\n1402.         Name: MyApiGW\n1403. \n1404.     MyWebsocketApi:\n1405.       Type: AWS::ApiGatewayV2::Api\n1406.       Properties:\n1407.         Name: MyWebsocketApi\n1408.         ProtocolType: WEBSOCKET\n1409.         RouteSelectionExpression: \'$request.body.action\'\n1410. \n1411.   Outputs:\n1412.     apiGatewayRestApiId:\n1413.       Value:\n1414.         Ref: MyApiGW\n1415.       Export:\n1416.         Name: MyApiGateway-restApiId\n1417. \n1418.     apiGatewayRestApiRootResourceId:\n1419.       Value:\n1420.         Fn::GetAtt:\n1421.           - MyApiGW\n1422.           - RootResourceId\n1423.       Export:\n1424.         Name: MyApiGateway-rootResourceId\n1425. \n1426.     websocketApiId:\n1427.       Value:\n1428.         Ref: MyWebsocketApi\n1429.       Export:\n1430.         Name: MyApiGateway-websocketApiId\n1431. ```\n1432. \n1433. This creates API gateway and then exports the `restApiId`, `rootResourceId` and `websocketApiId` values using cloudformation cross stack output.\n1434. We will import this and reference in future services.\n1435. \n1436. ```yml\n1437. service: service-a\n1438. \n1439. provider:\n1440.   apiGateway:\n1441.     restApiId:\n1442.       \'Fn::ImportValue\': MyApiGateway-restApiId\n1443.     restApiRootResourceId:\n1444.       \'Fn::ImportValue\': MyApiGateway-rootResourceId\n1445.     websocketApiId:\n1446.       \'Fn::ImportValue\': MyApiGateway-websocketApiId\n1447. \n1448. functions: service-a-functions\n1449. ```\n1450. \n1451. ```yml\n1452. service: service-b\n1453. \n1454. provider:\n1455.   apiGateway:\n1456.     restApiId:\n1457.       \'Fn::ImportValue\': MyApiGateway-restApiId\n1458.     restApiRootResourceId:\n1459.       \'Fn::ImportValue\': MyApiGateway-rootResourceId\n1460.     websocketApiId:\n1461.       \'Fn::ImportValue\': MyApiGateway-websocketApiId\n1462. \n1463. functions: service-b-functions\n1464. ```\n1465. \n1466. You can use this method to share your API Gateway across services in same region. Read about this limitation [here](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html).\n1467. \n1468. **Note:** We\'ve noticed you can\'t use provider.tags together with `Fn::ImportValue` for `restApiId` and `restApiRootResourceId`. Doing so won\'t resolve the imported value, and therefore returns an error.\n1469. \n1470. ### Manually Configuring shared API Gateway\n1471. \n1472. Use AWS console on browser, navigate to the API Gateway console. Select your already existing API Gateway.\n1473. Top Navbar should look like this\n1474. \n1475. ```\n1476.     APIs>apigateway-Name (xxxxxxxxxx)>Resources>/ (yyyyyyyyyy)\n1477. ```\n1478. \n1479. Here xxxxxxxxx is your restApiId and yyyyyyyyyy the restApiRootResourceId.\n1480. \n1481. #### Note while using authorizers with shared API Gateway\n1482. \n1483. AWS API Gateway allows only 1 Authorizer for 1 ARN, This is okay when you use conventional serverless setup, because each stage and service will create different API Gateway. But this can cause problem when using authorizers with shared API Gateway. If we use the same authorizer directly in different services like this.\n1484. \n1485. ```yml\n1486. service: service-c\n1487. \n1488. provider:\n1489.   apiGateway:\n1490.     restApiId:\n1491.       \'Fn::ImportValue\': apiGateway-restApiId\n1492.     restApiRootResourceId:\n1493.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1494. \n1495. functions:\n1496.   deleteUser:\n1497.     events:\n1498.       - http:\n1499.         path: /users/{userId}\n1500.         authorizer:\n1501.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1502. ```\n1503. \n1504. ```yml\n1505. service: service-d\n1506. \n1507. provider:\n1508.   apiGateway:\n1509.     restApiId:\n1510.       \'Fn::ImportValue\': apiGateway-restApiId\n1511.     restApiRootResourceId:\n1512.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1513. \n1514. functions:\n1515.   deleteProject:\n1516.     events:\n1517.       - http:\n1518.         path: /project/{projectId}\n1519.         authorizer:\n1520.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1521. ```\n1522. \n1523. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1524. \n1525. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1526. \n1527. ## Share Authorizer\n1528. \n1529. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1530. \n1531. ```yml\n1532. functions:\n1533.   createUser:\n1534.      ...\n1535.     events:\n1536.       - http:\n1537.           path: /users\n1538.           ...\n1539.           authorizer:\n1540.             # Provide both type and authorizerId\n1541.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1542.             authorizerId:\n1543.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1544.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1545.               - myapp/myscope\n1546. \n1547.   deleteUser:\n1548.      ...\n1549.     events:\n1550.       - http:\n1551.           path: /users/{userId}\n1552.           ...\n1553.           # Provide both type and authorizerId\n1554.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1555.           authorizerId:\n1556.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1557. \n1558. resources:\n1559.   Resources:\n1560.     ApiGatewayAuthorizer:\n1561.       Type: AWS::ApiGateway::Authorizer\n1562.       Properties:\n1563.         AuthorizerResultTtlInSeconds: 300\n1564.         IdentitySource: method.request.header.Authorization\n1565.         Name: Cognito\n1566.         RestApiId:\n1567.           Ref: YourApiGatewayName\n1568.         Type: COGNITO_USER_POOLS\n1569.         ProviderARNs:\n1570.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1571. \n1572. ```\n1573. \n1574. ## Resource Policy\n1575. \n1576. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1577. \n1578. ```yml\n1579. provider:\n1580.   name: aws\n1581.   runtime: nodejs12.x\n1582. \n1583.   resourcePolicy:\n1584.     - Effect: Allow\n1585.       Principal: \'*\'\n1586.       Action: execute-api:Invoke\n1587.       Resource:\n1588.         - execute-api:/*/*/*\n1589.       Condition:\n1590.         IpAddress:\n1591.           aws:SourceIp:\n1592.             - \'123.123.123.123\'\n1593. ```\n1594. \n1595. ## Compression\n1596. \n1597. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1598. \n1599. ```yml\n1600. provider:\n1601.   name: aws\n1602.   apiGateway:\n1603.     minimumCompressionSize: 1024\n1604. ```\n1605. \n1606. ## Binary Media Types\n1607. \n1608. API Gateway makes it possible to return binary media such as images or files as responses.\n1609. \n1610. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1611. \n1612. ```yml\n1613. provider:\n1614.   apiGateway:\n1615.     binaryMediaTypes:\n1616.       - \'*/*\'\n1617. ```\n1618. \n1619. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1620. \n1621. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1622. \n1623. ```yml\n1624. functions:\n1625.   create:\n1626.     handler: posts.create\n1627.     events:\n1628.       - http:\n1629.           path: posts/create\n1630.           method: post\n1631.           request:\n1632.             contentHandling: CONVERT_TO_TEXT\n1633.           response:\n1634.             contentHandling: CONVERT_TO_TEXT\n1635. ```\n1636. \n1637. ## Detailed CloudWatch Metrics\n1638. \n1639. Use the following configuration to enable detailed CloudWatch Metrics:\n1640. \n1641. ```yml\n1642. provider:\n1643.   apiGateway:\n1644.     metrics: true\n1645. ```\n1646. \n1647. ## AWS X-Ray Tracing\n1648. \n1649. API Gateway supports a form of out of the box distributed tracing via [AWS X-Ray](https://aws.amazon.com/xray/) though enabling [active tracing](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-xray.html). To enable this feature for your serverless application\'s API Gateway add the following to your `serverless.yml`\n1650. \n1651. ```yml\n1652. # serverless.yml\n1653. \n1654. provider:\n1655.   name: aws\n1656.   tracing:\n1657.     apiGateway: true\n1658. ```\n1659. \n1660. ## Tags / Stack Tags\n1661. \n1662. API Gateway stages will be tagged with the `tags` and `stackTags` values defined at the `provider` level:\n1663. \n1664. ```yml\n1665. # serverless.yml\n1666. \n1667. provider:\n1668.   name: aws\n1669.   stackTags:\n1670.     stackTagKey: stackTagValue\n1671.   tags:\n1672.     tagKey: tagValue\n1673. ```\n1674. \n1675. ## Logs\n1676. \n1677. Use the following configuration to enable API Gateway logs:\n1678. \n1679. ```yml\n1680. # serverless.yml\n1681. provider:\n1682.   name: aws\n1683.   logs:\n1684.     restApi: true\n1685. ```\n1686. \n1687. The log streams will be generated in a dedicated log group which follows the naming schema `/aws/api-gateway/{service}-{stage}`.\n1688. \n1689. To be able to write logs, API Gateway [needs a CloudWatch role configured](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html). This setting is per region, shared by all the APIs. There are three approaches for handling it:\n1690. \n1691. - Let Serverless create and assign an IAM role for you (default behavior). Note that since this is a shared setting, this role is not removed when you remove the deployment.\n1692. - Let Serverless assign an existing IAM role that you created before the deployment, if not already assigned:\n1693. \n1694.   ```yml\n1695.   # serverless.yml\n1696.   provider:\n1697.     logs:\n1698.       restApi:\n1699.         role: arn:aws:iam::123456:role\n1700.   ```\n1701. \n1702. - Do not let Serverless manage the CloudWatch role configuration. In this case, you would create and assign the IAM role yourself, e.g. in a separate "account setup" deployment:\n1703. \n1704.   ```yml\n1705.   provider:\n1706.     logs:\n1707.       restApi:\n1708.         roleManagedExternally: true # disables automatic role creation/checks done by Serverless\n1709.   ```\n1710. \n1711. **Note:** Serverless configures the API Gateway CloudWatch role setting using a custom resource lambda function. If you\'re using `cfnRole` to specify a limited-access IAM role for your serverless deployment, the custom resource lambda will assume this role during execution.\n1712. \n1713. By default, API Gateway access logs will use the following format:\n1714. \n1715. ```\n1716. \'requestId: $context.requestId, ip: $context.identity.sourceIp, caller: $context.identity.caller, user: $context.identity.user, requestTime: $context.requestTime, httpMethod: $context.httpMethod, resourcePath: $context.resourcePath, status: $context.status, protocol: $context.protocol, responseLength: $context.responseLength\'\n1717. ```\n1718. \n1719. You can specify your own [format for API Gateway Access Logs](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html#apigateway-cloudwatch-log-formats) by including your preferred string in the `format` property:\n1720. \n1721. ```yml\n1722. # serverless.yml\n1723. provider:\n1724.   name: aws\n1725.   logs:\n1726.     restApi:\n1727.       format: \'{ "requestId":"$context.requestId",   "ip": "$context.identity.sourceIp" }\'\n1728. ```\n1729. \n1730. The default API Gateway log level will be INFO. You can change this to error with the following:\n1731. \n1732. ```yml\n1733. # serverless.yml\n1734. provider:\n1735.   name: aws\n1736.   logs:\n1737.     restApi:\n1738.       level: ERROR\n1739. ```\n1740. \n1741. Valid values are INFO, ERROR.\n1742. \n1743. If you want to disable access logging completly you can do with the following:\n1744. \n1745. ```yml\n1746. # serverless.yml\n1747. provider:\n1748.   name: aws\n1749.   logs:\n1750.     restApi:\n1751.       accessLogging: true\n1752. ```\n1753. \n1754. By default, the full requests and responses data will be logged. If you want to disable like so:\n1755. \n1756. ```yml\n1757. # serverless.yml\n1758. provider:\n1759.   name: aws\n1760.   logs:\n1761.     restApi:\n1762.       fullExecutionData: false\n1763. ```\n1764. \n1765. Websockets have the same configuration options as the the REST API. Example:\n1766. \n1767. ```yml\n1768. # serverless.yml\n1769. provider:\n1770.   name: aws\n1771.   logs:\n1772.     websoocket:\n1773.       level: INFO\n1774.       fullExecutionData: false\n1775. ```', start_line_number=1, end_line_number=1774), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', content='1. \'use strict\';\n2. \n3. const _ = require(\'lodash\');\n4. \n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n50. \n51. module.exports = {\n52.   getMethodIntegration(http, { lambdaLogicalId, lambdaAliasName }) {\n53.     const type = http.integration || \'AWS_PROXY\';\n54.     const integration = {\n55.       IntegrationHttpMethod: \'POST\',\n56.       Type: type,\n57.     };\n58. \n59.     // Valid integrations are:\n60.     // * `HTTP` for integrating with an HTTP back end,\n61.     // * `AWS` for any AWS service endpoints,\n62.     // * `MOCK` for testing without actually invoking the back end,\n63.     // * `HTTP_PROXY` for integrating with the HTTP proxy integration, or\n64.     // * `AWS_PROXY` for integrating with the Lambda proxy integration type (the default)\n65.     if (type === \'AWS\' || type === \'AWS_PROXY\') {\n66.       Object.assign(integration, {\n67.         Uri: {\n68.           \'Fn::Join\': [\n69.             \'\',\n70.             [\n71.               \'arn:\',\n72.               { Ref: \'AWS::Partition\' },\n73.               \':apigateway:\',\n74.               { Ref: \'AWS::Region\' },\n75.               \':lambda:path/2015-03-31/functions/\',\n76.               ...[],\n77.               { \'Fn::GetAtt\': [lambdaLogicalId, \'Arn\'] },\n78.               ...(lambdaAliasName ? [\':\', lambdaAliasName] : []),\n79.               \'/invocations\',\n80.             ],\n81.           ],\n82.         },\n83.       });\n84.     } else if (type === \'HTTP\' || type === \'HTTP_PROXY\') {\n85.       const integrationHttpMethod = (http.request && http.request.method) || http.method;\n86.       Object.assign(integration, {\n87.         Uri: http.request && http.request.uri,\n88.         IntegrationHttpMethod: integrationHttpMethod.toUpperCase(),\n89.       });\n90.       if (http.connectionType) {\n91.         Object.assign(integration, {\n92.           ConnectionType: http.connectionType,\n93.           ConnectionId: http.connectionId,\n94.         });\n95.       }\n96.     } else if (type === \'MOCK\') {\n97.       // nothing to do but kept here for reference\n98.     }\n99. \n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n108.     if (\n109.       ((type === \'AWS\' || type === \'HTTP\' || type === \'HTTP_PROXY\') &&\n110.         http.request &&\n111.         http.request.parameters &&\n112.         Object.keys(http.request.parameters).length) ||\n113.       http.async\n114.     ) {\n115.       Object.assign(integration, {\n116.         RequestParameters: this.getIntegrationRequestParameters(http),\n117.       });\n118.     }\n119. \n120.     return {\n121.       Properties: {\n122.         Integration: integration,\n123.       },\n124.     };\n125.   },\n126. \n127.   getIntegrationResponses(http) {\n128.     const integrationResponses = [];\n129. \n130.     if (http.response) {\n131.       const integrationResponseHeaders = [];\n132. \n133.       if (http.cors) {\n134.         let origin = http.cors.origin;\n135. \n136.         // TODO remove once "origins" config is deprecated\n137.         if (http.cors.origins && http.cors.origins.length) {\n138.           origin = http.cors.origins.join(\',\');\n139.         }\n140. \n141.         _.merge(integrationResponseHeaders, {\n142.           \'Access-Control-Allow-Origin\': `\'${origin}\'`,\n143.         });\n144. \n145.         // Only set Access-Control-Allow-Credentials when explicitly allowed (omit if false)\n146.         if (http.cors.allowCredentials) {\n147.           integrationResponseHeaders[\'Access-Control-Allow-Credentials\'] = \'true\';\n148.         }\n149.       }\n150. \n151.       if (http.response.headers) {\n152.         _.merge(integrationResponseHeaders, http.response.headers);\n153.       }\n154. \n155.       _.forEach(http.response.statusCodes, (config, statusCode) => {\n156.         const responseParameters = _.mapKeys(\n157.           integrationResponseHeaders,\n158.           (value, header) => `method.response.header.${header}`\n159.         );\n160. \n161.         const integrationResponse = {\n162.           StatusCode: statusCode,\n163.           SelectionPattern: config.pattern || \'\',\n164.           ResponseParameters: responseParameters,\n165.           ResponseTemplates: {},\n166.           ContentHandling: statusCode.startsWith(\'2\') ? http.response.contentHandling : undefined,\n167.         };\n168. \n169.         if (config.headers) {\n170.           _.merge(\n171.             integrationResponse.ResponseParameters,\n172.             _.mapKeys(config.headers, (value, header) => `method.response.header.${header}`)\n173.           );\n174.         }\n175. \n176.         if (http.response.template) {\n177.           _.merge(integrationResponse.ResponseTemplates, {\n178.             \'application/json\': http.response.template,\n179.           });\n180.         }\n181. \n182.         if (config.template) {\n183.           const template =\n184.             typeof config.template === \'string\'\n185.               ? { \'application/json\': config.template }\n186.               : config.template;\n187. \n188.           _.merge(integrationResponse.ResponseTemplates, template);\n189.         }\n190. \n191.         integrationResponses.push(integrationResponse);\n192.       });\n193.     }\n194. \n195.     return integrationResponses;\n196.   },\n197. \n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n219.   getIntegrationRequestParameters(http) {\n220.     const parameters = {};\n221.     if (http.request && http.request.parameters) {\n222.       _.forEach(http.request.parameters, (value, key) => {\n223.         parameters[`integration.${key.substring(\'method.\'.length)}`] = value.mappedValue || key;\n224.       });\n225.     }\n226. \n227.     if (http.async) {\n228.       parameters[\'integration.request.header.X-Amz-Invocation-Type\'] = "\'Event\'";\n229.     }\n230. \n231.     return parameters;\n232.   },\n233. \n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };', start_line_number=1, end_line_number=261)]
2025-11-13 19:50:55,240 - thread-135845287823040.prometheus.lang_graph.nodes.issue_classifier_node - INFO - IssueClassifierNode classified the issue as: feature
2025-11-13 19:50:55,241 - thread-135845287823040.prometheus.lang_graph.nodes.issue_classification_subgraph_node - INFO - issue_type: feature
2025-11-13 19:50:55,243 - thread-135845287823040.prometheus.docker.base_container - INFO - Pulling docker image: ghcr.io/timesler/swe-polybench.eval.x86_64.serverless__serverless-8159:latest
2025-11-13 19:51:45,644 - thread-135845287823040.prometheus.docker.base_container - INFO - Tagging pulled image as: prometheus_user_defined_container_1fc737afb4
2025-11-13 19:51:45,653 - thread-135845287823040.prometheus.docker.base_container - INFO - Starting container from image prometheus_user_defined_container_1fc737afb4
2025-11-13 19:51:46,233 - thread-135845287823040.prometheus.docker.base_container - INFO - Starting persistent shell for interactive mode...
2025-11-13 19:51:46,636 - thread-135845287823040.prometheus.docker.base_container - INFO - Persistent shell is ready
2025-11-13 19:51:46,636 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_subgraph_node - INFO - Enter IssueFeatureSubgraphNode
2025-11-13 19:51:46,642 - thread-135845287823040.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - INFO - Enter bug_get_regression_tests_subgraph_node
2025-11-13 19:51:46,643 - thread-135845287823040.prometheus.lang_graph.nodes.bug_get_regression_context_message_node - DEBUG - Sending query to context provider subgraph:
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

2025-11-13 19:51:46,644 - thread-135845287823040.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 19:51:46,645 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 19:52:09,588 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We need to return 8 existing test cases with exact line numbers and full content, but only a file tree is provided. The most relevant tests for API Gateway request mapping templates are likely in the integration API Gateway tests and their helpers, whose contents and line numbers are not shown. Therefore, additional context with the actual test file contents is essential.' query='Please provide the full content with line numbers of test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js.' extra_requirements='If these files do not contain at least 8 relevant test cases, please also include any unit tests under lib/plugins/aws/package/compile/events/apiGateway (e.g., *test.js files) that cover method integration or request mapping templates.' purpose='I need these test contents to extract 8 relevant cases with their exact line numbers and include all required imports and setup.'
2025-11-13 19:52:09,590 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full content with line numbers of test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js.
2025-11-13 19:52:13,533 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 19:52:13,534 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 19:52:13,534 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 19:52:13,534 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 19:52:13,536 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 19:52:13,537 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 19:52:13,537 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full content with line numbers of test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js.
Extra requirements: If these files do not contain at least 8 relevant test cases, please also include any unit tests under lib/plugins/aws/package/compile/events/apiGateway (e.g., *test.js files) that cover method integration or request mapping templates.
Purpose: I need these test contents to extract 8 relevant cases with their exact line numbers and include all required imports and setup.
2025-11-13 19:52:26,655 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_W1tYsOW2vWxxiSwaiRpKNui4', 'function': {'arguments': '{"relative_path":"test/integration-all/api-gateway/tests.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1509, 'prompt_tokens': 2294, 'total_tokens': 3803, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9c612fd1-0a03-4f9a-a8ae-09c9b8dab524-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'test/integration-all/api-gateway/tests.js'}, 'id': 'call_W1tYsOW2vWxxiSwaiRpKNui4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2294, 'output_tokens': 1509, 'total_tokens': 3803, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-13 19:52:28,254 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_a4wrbuwdJK2N8gQ6g07SPtAc', 'function': {'arguments': '{"relative_path":"test/integration-all/api-gateway/tests.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 32, 'prompt_tokens': 2376, 'total_tokens': 2408, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--73f1e3c3-97c6-4949-90de-f4f9c1cc852a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'test/integration-all/api-gateway/tests.js'}, 'id': 'call_a4wrbuwdJK2N8gQ6g07SPtAc', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2376, 'output_tokens': 32, 'total_tokens': 2408, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:52:43,949 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_xZFRokSeMXnLmSaRlUClVidt', 'function': {'arguments': '{"relative_path":"test/utils/api-gateway/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1188, 'prompt_tokens': 6114, 'total_tokens': 7302, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--56ce161d-a077-4eb3-9c36-0cfdf6081218-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'test/utils/api-gateway/index.js'}, 'id': 'call_xZFRokSeMXnLmSaRlUClVidt', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6114, 'output_tokens': 1188, 'total_tokens': 7302, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-13 19:53:12,177 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7uSv0VUxReMFAWR9TgmoMqTt', 'function': {'arguments': '{"relative_path":"test/integration-all/shared/utils.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 6680, 'total_tokens': 6710, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--428c972e-ca43-439d-af37-ee777a933007-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'test/integration-all/shared/utils.js'}, 'id': 'call_7uSv0VUxReMFAWR9TgmoMqTt', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6680, 'output_tokens': 30, 'total_tokens': 6710, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:53:24,825 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I retrieved and displayed the full contents with line numbers for the three requested files: test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js. I reviewed tests.js and confirmed it contains well over 8 relevant test cases (e.g., minimal HTTP methods, CORS, custom authorizers, API keys, stage updates, integration timeout, and external REST API), so no additional unit tests were needed. These files include all required imports and setup used by the test suite. If you need me to also surface specific unit tests under lib/plugins/aws/package/compile/events/apiGateway for mapping templates, let me know.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1171, 'prompt_tokens': 6949, 'total_tokens': 8120, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1024, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--46cab78b-1242-4089-af15-c5c9d115b2ca-0' usage_metadata={'input_tokens': 6949, 'output_tokens': 1171, 'total_tokens': 8120, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1024}}
2025-11-13 19:53:24,829 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full content with line numbers of test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If these files do not contain at least 8 relevant test cases, please also include any unit tests under lib/plugins/aws/package/compile/events/apiGateway (e.g., *test.js files) that cover method integration or request mapping templates.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need these test contents to extract 8 relevant cases with their exact line numbers and include all required imports and setup.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: test/integration-all/api-gateway/tests.js
Line number range: 1 - 313
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const _ = require('lodash');
5. const { expect } = require('chai');
6. const log = require('log').get('serverless:test');
7. const awsRequest = require('@serverless/test/aws-request');
8. 
9. const { getTmpDirPath, readYamlFile, writeYamlFile } = require('../../utils/fs');
10. const { confirmCloudWatchLogs } = require('../../utils/misc');
11. const {
12.   createTestService,
13.   deployService,
14.   removeService,
15.   fetch,
16. } = require('../../utils/integration');
17. const { createRestApi, deleteRestApi, getResources } = require('../../utils/api-gateway');
18. 
19. describe('AWS - API Gateway Integration Test', function() {
20.   this.timeout(1000 * 60 * 10); // Involves time-taking deploys
21.   let serviceName;
22.   let endpoint;
23.   let stackName;
24.   let tmpDirPath;
25.   let serverlessFilePath;
26.   let restApiId;
27.   let restApiRootResourceId;
28.   let apiKey;
29.   let isDeployed = false;
30.   const stage = 'dev';
31. 
32.   const resolveEndpoint = async () => {
33.     const result = await awsRequest('CloudFormation', 'describeStacks', { StackName: stackName });
34.     const endpointOutput = result.Stacks[0].Outputs.find(
35.       output => output.OutputKey === 'ServiceEndpoint'
36.     ).OutputValue;
37.     endpoint = endpointOutput.match(/https:\/\/.+\.execute-api\..+\.amazonaws\.com.+/)[0];
38.   };
39. 
40.   before(async () => {
41.     tmpDirPath = getTmpDirPath();
42.     log.notice(`Temporary path: ${tmpDirPath}`);
43.     serverlessFilePath = path.join(tmpDirPath, 'serverless.yml');
44.     const serverlessConfig = await createTestService(tmpDirPath, {
45.       templateDir: path.join(__dirname, 'service'),
46.       serverlessConfigHook:
47.         // Ensure unique API key for each test (to avoid collision among concurrent CI runs)
48.         config => {
49.           apiKey = `${config.service}-api-key-1`;
50.           config.provider.apiKeys[0] = { name: apiKey, value: apiKey };
51.         },
52.     });
53.     serviceName = serverlessConfig.service;
54.     stackName = `${serviceName}-${stage}`;
55.     log.notice(`Deploying "${stackName}" service...`);
56.     await deployService(tmpDirPath);
57.     isDeployed = true;
58.     return resolveEndpoint();
59.   });
60. 
61.   after(async () => {
62.     if (!isDeployed) return;
63.     log.notice('Removing service...');
64.     await removeService(tmpDirPath);
65.   });
66. 
67.   describe('Minimal Setup', () => {
68.     const expectedMessage = 'Hello from API Gateway! - (minimal)';
69. 
70.     it('should expose an accessible GET HTTP endpoint', () => {
71.       const testEndpoint = `${endpoint}`;
72. 
73.       return fetch(testEndpoint, { method: 'GET' })
74.         .then(response => response.json())
75.         .then(json => expect(json.message).to.equal(expectedMessage));
76.     });
77. 
78.     it('should expose an accessible POST HTTP endpoint', () => {
79.       const testEndpoint = `${endpoint}/minimal-1`;
80. 
81.       return fetch(testEndpoint, { method: 'POST' })
82.         .then(response => response.json())
83.         .then(json => expect(json.message).to.equal(expectedMessage));
84.     });
85. 
86.     it('should expose an accessible PUT HTTP endpoint', () => {
87.       const testEndpoint = `${endpoint}/minimal-2`;
88. 
89.       return fetch(testEndpoint, { method: 'PUT' })
90.         .then(response => response.json())
91.         .then(json => expect(json.message).to.equal(expectedMessage));
92.     });
93. 
94.     it('should expose an accessible DELETE HTTP endpoint', () => {
95.       const testEndpoint = `${endpoint}/minimal-3`;
96. 
97.       return fetch(testEndpoint, { method: 'DELETE' })
98.         .then(response => response.json())
99.         .then(json => expect(json.message).to.equal(expectedMessage));
100.     });
101.   });
102. 
103.   describe('CORS', () => {
104.     it('should setup simple CORS support via cors: true config', () => {
105.       const testEndpoint = `${endpoint}/simple-cors`;
106. 
107.       return fetch(testEndpoint, { method: 'OPTIONS' }).then(response => {
108.         const headers = response.headers;
109.         const allowHeaders = [
110.           'Content-Type',
111.           'X-Amz-Date',
112.           'Authorization',
113.           'X-Api-Key',
114.           'X-Amz-Security-Token',
115.           'X-Amz-User-Agent',
116.         ].join(',');
117.         expect(headers.get('access-control-allow-headers')).to.equal(allowHeaders);
118.         expect(headers.get('access-control-allow-methods')).to.equal('OPTIONS,GET');
119.         expect(headers.get('access-control-allow-credentials')).to.equal(null);
120.         expect(headers.get('access-control-allow-origin')).to.equal('*');
121.       });
122.     });
123. 
124.     it('should setup CORS support with complex object config', () => {
125.       const testEndpoint = `${endpoint}/complex-cors`;
126. 
127.       return fetch(testEndpoint, { method: 'OPTIONS' }).then(response => {
128.         const headers = response.headers;
129.         const allowHeaders = [
130.           'Content-Type',
131.           'X-Amz-Date',
132.           'Authorization',
133.           'X-Api-Key',
134.           'X-Amz-Security-Token',
135.           'X-Amz-User-Agent',
136.         ].join(',');
137.         expect(headers.get('access-control-allow-headers')).to.equal(allowHeaders);
138.         expect(headers.get('access-control-allow-methods')).to.equal('OPTIONS,GET');
139.         expect(headers.get('access-control-allow-credentials')).to.equal('true');
140.         expect(headers.get('access-control-allow-origin')).to.equal('*');
141.       });
142.     });
143.   });
144. 
145.   describe('Custom Authorizers', () => {
146.     let testEndpoint;
147. 
148.     before(() => {
149.       testEndpoint = `${endpoint}/custom-auth`;
150.     });
151. 
152.     it('should reject requests without authorization', () => {
153.       return fetch(testEndpoint).then(response => {
154.         expect(response.status).to.equal(401);
155.       });
156.     });
157. 
158.     it('should reject requests with wrong authorization', () => {
159.       return fetch(testEndpoint, {
160.         headers: { Authorization: 'Bearer ShouldNotBeAuthorized' },
161.       }).then(response => {
162.         expect(response.status).to.equal(401);
163.       });
164.     });
165. 
166.     it('should authorize requests with correct authorization', () => {
167.       return fetch(testEndpoint, { headers: { Authorization: 'Bearer ShouldBeAuthorized' } })
168.         .then(response => response.json())
169.         .then(json => {
170.           expect(json.message).to.equal('Hello from API Gateway! - (customAuthorizers)');
171.           expect(json.event.requestContext.authorizer.principalId).to.equal('SomeRandomId');
172.           expect(json.event.headers.Authorization).to.equal('Bearer ShouldBeAuthorized');
173.         });
174.     });
175.   });
176. 
177.   describe('API Keys', () => {
178.     let testEndpoint;
179.     let startTime;
180. 
181.     before(() => {
182.       testEndpoint = `${endpoint}/api-keys`;
183.       startTime = Date.now();
184.     });
185. 
186.     it('should succeed if correct API key is given', async function self() {
187.       const response = await fetch(testEndpoint, { headers: { 'X-API-Key': apiKey } });
188.       const result = await response.json();
189.       // API Key may take a moment to propagate, retry
190.       if (response.status === 403 && startTime > Date.now() - 1000 * 60 * 3) {
191.         log.notice('API Key rejected, retry');
192.         return self();
193.       }
194.       expect(response.status).to.equal(200);
195.       expect(result.message).to.equal('Hello from API Gateway! - (apiKeys)');
196.       return null;
197.     });
198. 
199.     it('should reject a request with an invalid API Key', () => {
200.       return fetch(testEndpoint).then(response => {
201.         expect(response.status).to.equal(403);
202.       });
203.     });
204.   });
205. 
206.   describe('Using stage specific configuration', () => {
207.     before(async () => {
208.       const serverless = readYamlFile(serverlessFilePath);
209.       // enable Logs, Tags and Tracing
210.       _.merge(serverless.provider, {
211.         tags: {
212.           foo: 'bar',
213.           baz: 'qux',
214.         },
215.         tracing: {
216.           apiGateway: true,
217.         },
218.         logs: {
219.           restApi: true,
220.         },
221.       });
222.       writeYamlFile(serverlessFilePath, serverless);
223.       await deployService(tmpDirPath);
224.     });
225. 
226.     it('should update the stage without service interruptions', () => {
227.       // re-using the endpoint from the "minimal" test case
228.       const testEndpoint = `${endpoint}`;
229. 
230.       return confirmCloudWatchLogs(
231.         `/aws/api-gateway/${stackName}`,
232.         () =>
233.           fetch(`${testEndpoint}`, { method: 'GET' })
234.             .then(response => response.json())
235.             // Confirm that APIGW responds as expected
236.             .then(json => expect(json.message).to.equal('Hello from API Gateway! - (minimal)'))
237.         // Confirm that CloudWatch logs for APIGW are written
238.       ).then(events => expect(events.length > 0).to.equal(true));
239.     });
240.   });
241. 
242.   describe('Integration Lambda Timeout', () => {
243.     it('should result with 504 status code', () =>
244.       fetch(`${endpoint}/integration-lambda-timeout`).then(response =>
245.         expect(response.status).to.equal(504)
246.       ));
247.   });
248. 
249.   // NOTE: this test should  be at the very end because we're using an external REST API here
250.   describe('when using an existing REST API with stage specific configuration', () => {
251.     before(async () => {
252.       // create an external REST API
253.       const externalRestApiName = `${stage}-${serviceName}-ext-api`;
254.       await createRestApi(externalRestApiName)
255.         .then(restApiMeta => {
256.           restApiId = restApiMeta.id;
257.           return getResources(restApiId);
258.         })
259.         .then(resources => {
260.           restApiRootResourceId = resources[0].id;
261.           log.notice(
262.             'Created external rest API ' +
263.               `(id: ${restApiId}, root resource id: ${restApiRootResourceId})`
264.           );
265.         });
266. 
267.       const serverless = readYamlFile(serverlessFilePath);
268.       // enable Logs, Tags and Tracing
269.       _.merge(serverless.provider, {
270.         apiGateway: {
271.           restApiId,
272.           restApiRootResourceId,
273.         },
274.         tags: {
275.           foo: 'bar',
276.           baz: 'qux',
277.         },
278.         tracing: {
279.           apiGateway: true,
280.         },
281.         logs: {
282.           restApi: true,
283.         },
284.       });
285.       writeYamlFile(serverlessFilePath, serverless);
286.       log.notice('Redeploying service (with external Rest API ID)...');
287.       await deployService(tmpDirPath);
288.       return resolveEndpoint();
289.     });
290. 
291.     after(async () => {
292.       // NOTE: deleting the references to the old, external REST API
293.       const serverless = readYamlFile(serverlessFilePath);
294.       delete serverless.provider.apiGateway.restApiId;
295.       delete serverless.provider.apiGateway.restApiRootResourceId;
296.       writeYamlFile(serverlessFilePath, serverless);
297.       // NOTE: deploying once again to get the stack into the original state
298.       log.notice('Redeploying service (without external Rest API ID)...');
299.       await deployService(tmpDirPath);
300.       log.notice('Deleting external rest API...');
301.       return deleteRestApi(restApiId);
302.     });
303. 
304.     it('should update the stage without service interruptions', () => {
305.       // re-using the endpoint from the "minimal" test case
306.       const testEndpoint = `${endpoint}/minimal-1`;
307. 
308.       return fetch(testEndpoint, { method: 'POST' })
309.         .then(response => response.json())
310.         .then(json => expect(json.message).to.equal('Hello from API Gateway! - (minimal)'));
311.     });
312.   });
313. });


File: test/integration-all/shared/utils.js
Line number range: 1 - 22
Content:
1. 'use strict';
2. 
3. const logger = console;
4. 
5. function getMarkers(functionName) {
6.   return {
7.     start: `--- START ${functionName} ---`,
8.     end: `--- END ${functionName} ---`,
9.   };
10. }
11. 
12. function log(functionName, message) {
13.   const markers = getMarkers(functionName);
14.   logger.log(markers.start);
15.   logger.log(message);
16.   logger.log(markers.end);
17. }
18. 
19. module.exports = {
20.   getMarkers,
21.   log,
22. };


File: test/utils/api-gateway/index.js
Line number range: 1 - 55
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const awsRequest = require('@serverless/test/aws-request');
5. 
6. function createRestApi(name) {
7.   const params = {
8.     name,
9.   };
10. 
11.   return awsRequest('APIGateway', 'createRestApi', params);
12. }
13. 
14. function deleteRestApi(restApiId) {
15.   const params = {
16.     restApiId,
17.   };
18. 
19.   return awsRequest('APIGateway', 'deleteRestApi', params);
20. }
21. 
22. function getResources(restApiId) {
23.   const params = {
24.     restApiId,
25.   };
26. 
27.   return awsRequest('APIGateway', 'getResources', params).then(data => data.items);
28. }
29. 
30. function findRestApis(name) {
31.   const params = {
32.     limit: 500,
33.   };
34. 
35.   function recursiveFind(found, position) {
36.     if (position) params.position = position;
37.     return awsRequest('APIGateway', 'getRestApis', params).then(result => {
38.       const matches = result.items.filter(restApi => restApi.name.match(name));
39.       if (matches.length) {
40.         _.merge(found, matches);
41.       }
42.       if (result.position) return recursiveFind(found, result.position);
43.       return found;
44.     });
45.   }
46. 
47.   return recursiveFind([]);
48. }
49. 
50. module.exports = {
51.   createRestApi,
52.   deleteRestApi,
53.   getResources,
54.   findRestApis,
55. };

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 19:53:42,552 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='1. Query requirement analysis: The user explicitly requests the full content with line numbers of test/integration-all/api-gateway/tests.js. 2. Query match: This file directly contains all integration API Gateway tests (well over 8), including imports and setup (createTestService, deployService, removeService, endpoint resolution) required to understand and run the tests. 3. Extended relevance: It includes multiple describe/it blocks covering methods, CORS, authorizers, API keys, stage config, timeouts, and external REST API usage, which satisfies the purpose of extracting at least 8 relevant test cases with exact line numbers.', relative_path='test/integration-all/api-gateway/tests.js', start_line=1, end_line=313), ContextOutput(reasoning='1. Query requirement analysis: The user requests the full content of test/utils/api-gateway/index.js. 2. Query match: This utility module is imported and used by tests.js to create and manage external REST APIs (createRestApi, deleteRestApi, getResources). 3. Extended relevance: Including this file provides the necessary helper implementations and their exact line numbers, which are part of the setup for the API Gateway integration tests.', relative_path='test/utils/api-gateway/index.js', start_line=1, end_line=55), ContextOutput(reasoning="1. Query requirement analysis: The user requests the full content of test/integration-all/shared/utils.js. 2. Query match: While not imported in tests.js, it is a requested file and may be used by other integration suites; providing full content with line numbers satisfies the user's requirement. 3. Extended relevance: It exposes getMarkers and log helpers that could be part of shared test utilities.", relative_path='test/integration-all/shared/utils.js', start_line=1, end_line=22)]
2025-11-13 19:53:42,555 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 3 contexts to memory for query: Please provide the full content with line numbers of test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js.
2025-11-13 19:53:44,863 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 19:53:44,865 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 3 new contexts to 0 existing contexts
2025-11-13 19:53:44,865 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 3 total contexts (removed 0 duplicates)
2025-11-13 19:53:44,867 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content with line numbers of test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js.
Extra Requirements: If these files do not contain at least 8 relevant test cases, please also include any unit tests under lib/plugins/aws/package/compile/events/apiGateway (e.g., *test.js files) that cover method integration or request mapping templates.
Purpose: I need these test contents to extract 8 relevant cases with their exact line numbers and include all required imports and setup.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: test/integration-all/api-gateway/tests.js
Line number range: 1 - 313
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const _ = require('lodash');
5. const { expect } = require('chai');
6. const log = require('log').get('serverless:test');
7. const awsRequest = require('@serverless/test/aws-request');
8. 
9. const { getTmpDirPath, readYamlFile, writeYamlFile } = require('../../utils/fs');
10. const { confirmCloudWatchLogs } = require('../../utils/misc');
11. const {
12.   createTestService,
13.   deployService,
14.   removeService,
15.   fetch,
16. } = require('../../utils/integration');
17. const { createRestApi, deleteRestApi, getResources } = require('../../utils/api-gateway');
18. 
19. describe('AWS - API Gateway Integration Test', function() {
20.   this.timeout(1000 * 60 * 10); // Involves time-taking deploys
21.   let serviceName;
22.   let endpoint;
23.   let stackName;
24.   let tmpDirPath;
25.   let serverlessFilePath;
26.   let restApiId;
27.   let restApiRootResourceId;
28.   let apiKey;
29.   let isDeployed = false;
30.   const stage = 'dev';
31. 
32.   const resolveEndpoint = async () => {
33.     const result = await awsRequest('CloudFormation', 'describeStacks', { StackName: stackName });
34.     const endpointOutput = result.Stacks[0].Outputs.find(
35.       output => output.OutputKey === 'ServiceEndpoint'
36.     ).OutputValue;
37.     endpoint = endpointOutput.match(/https:\/\/.+\.execute-api\..+\.amazonaws\.com.+/)[0];
38.   };
39. 
40.   before(async () => {
41.     tmpDirPath = getTmpDirPath();
42.     log.notice(`Temporary path: ${tmpDirPath}`);
43.     serverlessFilePath = path.join(tmpDirPath, 'serverless.yml');
44.     const serverlessConfig = await createTestService(tmpDirPath, {
45.       templateDir: path.join(__dirname, 'service'),
46.       serverlessConfigHook:
47.         // Ensure unique API key for each test (to avoid collision among concurrent CI runs)
48.         config => {
49.           apiKey = `${config.service}-api-key-1`;
50.           config.provider.apiKeys[0] = { name: apiKey, value: apiKey };
51.         },
52.     });
53.     serviceName = serverlessConfig.service;
54.     stackName = `${serviceName}-${stage}`;
55.     log.notice(`Deploying "${stackName}" service...`);
56.     await deployService(tmpDirPath);
57.     isDeployed = true;
58.     return resolveEndpoint();
59.   });
60. 
61.   after(async () => {
62.     if (!isDeployed) return;
63.     log.notice('Removing service...');
64.     await removeService(tmpDirPath);
65.   });
66. 
67.   describe('Minimal Setup', () => {
68.     const expectedMessage = 'Hello from API Gateway! - (minimal)';
69. 
70.     it('should expose an accessible GET HTTP endpoint', () => {
71.       const testEndpoint = `${endpoint}`;
72. 
73.       return fetch(testEndpoint, { method: 'GET' })
74.         .then(response => response.json())
75.         .then(json => expect(json.message).to.equal(expectedMessage));
76.     });
77. 
78.     it('should expose an accessible POST HTTP endpoint', () => {
79.       const testEndpoint = `${endpoint}/minimal-1`;
80. 
81.       return fetch(testEndpoint, { method: 'POST' })
82.         .then(response => response.json())
83.         .then(json => expect(json.message).to.equal(expectedMessage));
84.     });
85. 
86.     it('should expose an accessible PUT HTTP endpoint', () => {
87.       const testEndpoint = `${endpoint}/minimal-2`;
88. 
89.       return fetch(testEndpoint, { method: 'PUT' })
90.         .then(response => response.json())
91.         .then(json => expect(json.message).to.equal(expectedMessage));
92.     });
93. 
94.     it('should expose an accessible DELETE HTTP endpoint', () => {
95.       const testEndpoint = `${endpoint}/minimal-3`;
96. 
97.       return fetch(testEndpoint, { method: 'DELETE' })
98.         .then(response => response.json())
99.         .then(json => expect(json.message).to.equal(expectedMessage));
100.     });
101.   });
102. 
103.   describe('CORS', () => {
104.     it('should setup simple CORS support via cors: true config', () => {
105.       const testEndpoint = `${endpoint}/simple-cors`;
106. 
107.       return fetch(testEndpoint, { method: 'OPTIONS' }).then(response => {
108.         const headers = response.headers;
109.         const allowHeaders = [
110.           'Content-Type',
111.           'X-Amz-Date',
112.           'Authorization',
113.           'X-Api-Key',
114.           'X-Amz-Security-Token',
115.           'X-Amz-User-Agent',
116.         ].join(',');
117.         expect(headers.get('access-control-allow-headers')).to.equal(allowHeaders);
118.         expect(headers.get('access-control-allow-methods')).to.equal('OPTIONS,GET');
119.         expect(headers.get('access-control-allow-credentials')).to.equal(null);
120.         expect(headers.get('access-control-allow-origin')).to.equal('*');
121.       });
122.     });
123. 
124.     it('should setup CORS support with complex object config', () => {
125.       const testEndpoint = `${endpoint}/complex-cors`;
126. 
127.       return fetch(testEndpoint, { method: 'OPTIONS' }).then(response => {
128.         const headers = response.headers;
129.         const allowHeaders = [
130.           'Content-Type',
131.           'X-Amz-Date',
132.           'Authorization',
133.           'X-Api-Key',
134.           'X-Amz-Security-Token',
135.           'X-Amz-User-Agent',
136.         ].join(',');
137.         expect(headers.get('access-control-allow-headers')).to.equal(allowHeaders);
138.         expect(headers.get('access-control-allow-methods')).to.equal('OPTIONS,GET');
139.         expect(headers.get('access-control-allow-credentials')).to.equal('true');
140.         expect(headers.get('access-control-allow-origin')).to.equal('*');
141.       });
142.     });
143.   });
144. 
145.   describe('Custom Authorizers', () => {
146.     let testEndpoint;
147. 
148.     before(() => {
149.       testEndpoint = `${endpoint}/custom-auth`;
150.     });
151. 
152.     it('should reject requests without authorization', () => {
153.       return fetch(testEndpoint).then(response => {
154.         expect(response.status).to.equal(401);
155.       });
156.     });
157. 
158.     it('should reject requests with wrong authorization', () => {
159.       return fetch(testEndpoint, {
160.         headers: { Authorization: 'Bearer ShouldNotBeAuthorized' },
161.       }).then(response => {
162.         expect(response.status).to.equal(401);
163.       });
164.     });
165. 
166.     it('should authorize requests with correct authorization', () => {
167.       return fetch(testEndpoint, { headers: { Authorization: 'Bearer ShouldBeAuthorized' } })
168.         .then(response => response.json())
169.         .then(json => {
170.           expect(json.message).to.equal('Hello from API Gateway! - (customAuthorizers)');
171.           expect(json.event.requestContext.authorizer.principalId).to.equal('SomeRandomId');
172.           expect(json.event.headers.Authorization).to.equal('Bearer ShouldBeAuthorized');
173.         });
174.     });
175.   });
176. 
177.   describe('API Keys', () => {
178.     let testEndpoint;
179.     let startTime;
180. 
181.     before(() => {
182.       testEndpoint = `${endpoint}/api-keys`;
183.       startTime = Date.now();
184.     });
185. 
186.     it('should succeed if correct API key is given', async function self() {
187.       const response = await fetch(testEndpoint, { headers: { 'X-API-Key': apiKey } });
188.       const result = await response.json();
189.       // API Key may take a moment to propagate, retry
190.       if (response.status === 403 && startTime > Date.now() - 1000 * 60 * 3) {
191.         log.notice('API Key rejected, retry');
192.         return self();
193.       }
194.       expect(response.status).to.equal(200);
195.       expect(result.message).to.equal('Hello from API Gateway! - (apiKeys)');
196.       return null;
197.     });
198. 
199.     it('should reject a request with an invalid API Key', () => {
200.       return fetch(testEndpoint).then(response => {
201.         expect(response.status).to.equal(403);
202.       });
203.     });
204.   });
205. 
206.   describe('Using stage specific configuration', () => {
207.     before(async () => {
208.       const serverless = readYamlFile(serverlessFilePath);
209.       // enable Logs, Tags and Tracing
210.       _.merge(serverless.provider, {
211.         tags: {
212.           foo: 'bar',
213.           baz: 'qux',
214.         },
215.         tracing: {
216.           apiGateway: true,
217.         },
218.         logs: {
219.           restApi: true,
220.         },
221.       });
222.       writeYamlFile(serverlessFilePath, serverless);
223.       await deployService(tmpDirPath);
224.     });
225. 
226.     it('should update the stage without service interruptions', () => {
227.       // re-using the endpoint from the "minimal" test case
228.       const testEndpoint = `${endpoint}`;
229. 
230.       return confirmCloudWatchLogs(
231.         `/aws/api-gateway/${stackName}`,
232.         () =>
233.           fetch(`${testEndpoint}`, { method: 'GET' })
234.             .then(response => response.json())
235.             // Confirm that APIGW responds as expected
236.             .then(json => expect(json.message).to.equal('Hello from API Gateway! - (minimal)'))
237.         // Confirm that CloudWatch logs for APIGW are written
238.       ).then(events => expect(events.length > 0).to.equal(true));
239.     });
240.   });
241. 
242.   describe('Integration Lambda Timeout', () => {
243.     it('should result with 504 status code', () =>
244.       fetch(`${endpoint}/integration-lambda-timeout`).then(response =>
245.         expect(response.status).to.equal(504)
246.       ));
247.   });
248. 
249.   // NOTE: this test should  be at the very end because we're using an external REST API here
250.   describe('when using an existing REST API with stage specific configuration', () => {
251.     before(async () => {
252.       // create an external REST API
253.       const externalRestApiName = `${stage}-${serviceName}-ext-api`;
254.       await createRestApi(externalRestApiName)
255.         .then(restApiMeta => {
256.           restApiId = restApiMeta.id;
257.           return getResources(restApiId);
258.         })
259.         .then(resources => {
260.           restApiRootResourceId = resources[0].id;
261.           log.notice(
262.             'Created external rest API ' +
263.               `(id: ${restApiId}, root resource id: ${restApiRootResourceId})`
264.           );
265.         });
266. 
267.       const serverless = readYamlFile(serverlessFilePath);
268.       // enable Logs, Tags and Tracing
269.       _.merge(serverless.provider, {
270.         apiGateway: {
271.           restApiId,
272.           restApiRootResourceId,
273.         },
274.         tags: {
275.           foo: 'bar',
276.           baz: 'qux',
277.         },
278.         tracing: {
279.           apiGateway: true,
280.         },
281.         logs: {
282.           restApi: true,
283.         },
284.       });
285.       writeYamlFile(serverlessFilePath, serverless);
286.       log.notice('Redeploying service (with external Rest API ID)...');
287.       await deployService(tmpDirPath);
288.       return resolveEndpoint();
289.     });
290. 
291.     after(async () => {
292.       // NOTE: deleting the references to the old, external REST API
293.       const serverless = readYamlFile(serverlessFilePath);
294.       delete serverless.provider.apiGateway.restApiId;
295.       delete serverless.provider.apiGateway.restApiRootResourceId;
296.       writeYamlFile(serverlessFilePath, serverless);
297.       // NOTE: deploying once again to get the stack into the original state
298.       log.notice('Redeploying service (without external Rest API ID)...');
299.       await deployService(tmpDirPath);
300.       log.notice('Deleting external rest API...');
301.       return deleteRestApi(restApiId);
302.     });
303. 
304.     it('should update the stage without service interruptions', () => {
305.       // re-using the endpoint from the "minimal" test case
306.       const testEndpoint = `${endpoint}/minimal-1`;
307. 
308.       return fetch(testEndpoint, { method: 'POST' })
309.         .then(response => response.json())
310.         .then(json => expect(json.message).to.equal('Hello from API Gateway! - (minimal)'));
311.     });
312.   });
313. });


File: test/integration-all/shared/utils.js
Line number range: 1 - 22
Content:
1. 'use strict';
2. 
3. const logger = console;
4. 
5. function getMarkers(functionName) {
6.   return {
7.     start: `--- START ${functionName} ---`,
8.     end: `--- END ${functionName} ---`,
9.   };
10. }
11. 
12. function log(functionName, message) {
13.   const markers = getMarkers(functionName);
14.   logger.log(markers.start);
15.   logger.log(message);
16.   logger.log(markers.end);
17. }
18. 
19. module.exports = {
20.   getMarkers,
21.   log,
22. };


File: test/utils/api-gateway/index.js
Line number range: 1 - 55
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const awsRequest = require('@serverless/test/aws-request');
5. 
6. function createRestApi(name) {
7.   const params = {
8.     name,
9.   };
10. 
11.   return awsRequest('APIGateway', 'createRestApi', params);
12. }
13. 
14. function deleteRestApi(restApiId) {
15.   const params = {
16.     restApiId,
17.   };
18. 
19.   return awsRequest('APIGateway', 'deleteRestApi', params);
20. }
21. 
22. function getResources(restApiId) {
23.   const params = {
24.     restApiId,
25.   };
26. 
27.   return awsRequest('APIGateway', 'getResources', params).then(data => data.items);
28. }
29. 
30. function findRestApis(name) {
31.   const params = {
32.     limit: 500,
33.   };
34. 
35.   function recursiveFind(found, position) {
36.     if (position) params.position = position;
37.     return awsRequest('APIGateway', 'getRestApis', params).then(result => {
38.       const matches = result.items.filter(restApi => restApi.name.match(name));
39.       if (matches.length) {
40.         _.merge(found, matches);
41.       }
42.       if (result.position) return recursiveFind(found, result.position);
43.       return found;
44.     });
45.   }
46. 
47.   return recursiveFind([]);
48. }
49. 
50. module.exports = {
51.   createRestApi,
52.   deleteRestApi,
53.   getResources,
54.   findRestApis,
55. };

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 19:54:02,374 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The issue concerns default API Gateway request mapping templates generated during packaging (lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js). The provided context only includes integration tests that exercise runtime endpoints, not the packaging unit tests that verify generated templates. To identify 8 tests likely affected by changes to mapping templates, I need the unit tests under the API Gateway packaging compile path.' query='Please provide the full contents with line numbers of all *test.js files under lib/plugins/aws/package/compile/events/apiGateway (recursively), especially any that cover method integration or request mapping templates.' extra_requirements='If listing all is too large, include at minimum: index.test.js for this module and any tests that reference method/integration.js.' purpose='I need these test files to extract 8 relevant cases that assert generated request mapping templates and would serve as regression tests for changing default templates.'
2025-11-13 19:54:02,375 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the full contents with line numbers of all *test.js files under lib/plugins/aws/package/compile/events/apiGateway (recursively), especially any that cover method integration or request mapping templates.
2025-11-13 19:54:05,382 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 19:54:05,382 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 19:54:05,382 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 19:54:05,382 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 19:54:05,384 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 19:54:05,385 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 19:54:05,385 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the full contents with line numbers of all *test.js files under lib/plugins/aws/package/compile/events/apiGateway (recursively), especially any that cover method integration or request mapping templates.
Extra requirements: If listing all is too large, include at minimum: index.test.js for this module and any tests that reference method/integration.js.
Purpose: I need these test files to extract 8 relevant cases that assert generated request mapping templates and would serve as regression tests for changing default templates.
2025-11-13 19:54:24,860 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_qQFLJl8AYx7Lop7sWV0N3oDr', 'function': {'arguments': '{"basename":"index.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1311, 'prompt_tokens': 2280, 'total_tokens': 3591, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1280, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--51e6dc7a-ba2f-4c14-9d46-197b39d6d9c1-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'index.test.js'}, 'id': 'call_qQFLJl8AYx7Lop7sWV0N3oDr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2280, 'output_tokens': 1311, 'total_tokens': 3591, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1280}}
2025-11-13 19:54:27,897 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ZVplXAinBlyIx5UZPNaRhipv', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 232, 'prompt_tokens': 2506, 'total_tokens': 2738, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--27475fc8-4d92-48e4-a092-5bd4b2f8726f-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/index.test.js'}, 'id': 'call_ZVplXAinBlyIx5UZPNaRhipv', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2506, 'output_tokens': 232, 'total_tokens': 2738, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 19:54:29,191 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0yNVgRJZUDLaLKG57KBHL1oQ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 35, 'prompt_tokens': 2595, 'total_tokens': 2630, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b29c95ef-8900-4640-b4de-df6f4506315a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/index.test.js'}, 'id': 'call_0yNVgRJZUDLaLKG57KBHL1oQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2595, 'output_tokens': 35, 'total_tokens': 2630, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:54:33,793 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_tTO6AQCMLdtzrBetGNCXVbT1', 'function': {'arguments': '{"basename":"integration.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 350, 'prompt_tokens': 4763, 'total_tokens': 5113, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4400cf7f-0aad-4c49-a975-43f3c09e03ee-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'integration.test.js'}, 'id': 'call_tTO6AQCMLdtzrBetGNCXVbT1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4763, 'output_tokens': 350, 'total_tokens': 5113, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 19:57:11,002 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_EIFJA78r6vFepLvJX5kMS71q', 'function': {'arguments': '{"basename":"method.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 286, 'prompt_tokens': 4813, 'total_tokens': 5099, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4736}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--24ab2cb9-5394-46b7-b4d1-b758cbe161f9-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'method.test.js'}, 'id': 'call_EIFJA78r6vFepLvJX5kMS71q', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4813, 'output_tokens': 286, 'total_tokens': 5099, 'input_token_details': {'audio': 0, 'cache_read': 4736}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 19:57:22,523 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_E6Kw3isAsbirBz6V7KbFrDZb', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 615, 'prompt_tokens': 4863, 'total_tokens': 5478, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--20414ff6-9ecf-4145-91b2-6def1ee5e728-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/index.js'}, 'id': 'call_E6Kw3isAsbirBz6V7KbFrDZb', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4863, 'output_tokens': 615, 'total_tokens': 5478, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 19:57:24,098 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_m6628secbAC3YhPI6iloSpkq', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 34, 'prompt_tokens': 4949, 'total_tokens': 4983, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 4736}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6cac4b21-2f12-4c67-84b1-df71fe9fd98e-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/index.js'}, 'id': 'call_m6628secbAC3YhPI6iloSpkq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 4949, 'output_tokens': 34, 'total_tokens': 4983, 'input_token_details': {'audio': 0, 'cache_read': 4736}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:57:26,653 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_KtN3QXug7TX6SD0QlK07k3Y1', 'function': {'arguments': '{"basename":"test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 93, 'prompt_tokens': 6150, 'total_tokens': 6243, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2560}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--11b21c65-c5ba-4589-87a2-0ff39d7696cf-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'test.js'}, 'id': 'call_KtN3QXug7TX6SD0QlK07k3Y1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6150, 'output_tokens': 93, 'total_tokens': 6243, 'input_token_details': {'audio': 0, 'cache_read': 2560}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 19:57:34,509 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pSW3E0LThDveVf9mswgRie5D', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 619, 'prompt_tokens': 6199, 'total_tokens': 6818, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--59236357-baa6-41a4-b53f-0ec36014a791-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_pSW3E0LThDveVf9mswgRie5D', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6199, 'output_tokens': 619, 'total_tokens': 6818, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 19:57:35,909 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_prGiDtskyzXtomFDl6nscmFl', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 38, 'prompt_tokens': 6294, 'total_tokens': 6332, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 6144}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--90eb01af-e4f1-4c3d-988c-090445d61e8b-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_prGiDtskyzXtomFDl6nscmFl', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6294, 'output_tokens': 38, 'total_tokens': 6332, 'input_token_details': {'audio': 0, 'cache_read': 6144}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:57:43,698 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yc3f9npd27sGm8Rrk3aA2ZGu', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 619, 'prompt_tokens': 11999, 'total_tokens': 12618, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cbf4e285-0848-4876-b027-c9f9f6ff4778-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_yc3f9npd27sGm8Rrk3aA2ZGu', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11999, 'output_tokens': 619, 'total_tokens': 12618, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 19:57:45,284 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OiNXPoEh04lfX2osp7vHgFCL', 'function': {'arguments': '{"basename":"integration.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 24, 'prompt_tokens': 12093, 'total_tokens': 12117, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2432}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4afdb1cc-6193-493b-be29-4a146707bda1-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'integration.test.js'}, 'id': 'call_OiNXPoEh04lfX2osp7vHgFCL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12093, 'output_tokens': 24, 'total_tokens': 12117, 'input_token_details': {'audio': 0, 'cache_read': 2432}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:57:46,883 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nlmS3SRoKCIhixItb4uvvVLS', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 38, 'prompt_tokens': 12143, 'total_tokens': 12181, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 6144}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--548cb26a-b8c3-44b2-b6a4-b59d65b7e6c5-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.test.js'}, 'id': 'call_nlmS3SRoKCIhixItb4uvvVLS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12143, 'output_tokens': 38, 'total_tokens': 12181, 'input_token_details': {'audio': 0, 'cache_read': 6144}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:57:52,119 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NVO82ZRJ7qsrmJZ2cWgRn8wE', 'function': {'arguments': '{"basename":"responses.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 414, 'prompt_tokens': 12207, 'total_tokens': 12621, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d8c2e422-c4b5-440b-a19f-f3222c31345b-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'responses.test.js'}, 'id': 'call_NVO82ZRJ7qsrmJZ2cWgRn8wE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12207, 'output_tokens': 414, 'total_tokens': 12621, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 19:57:53,534 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_FsEF7o3IGNkK5hxNONVfCfe5', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/responses/index.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 12257, 'total_tokens': 12296, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12160}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9e328e04-080c-40ed-adcd-f82ad81e41a9-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/responses/index.test.js'}, 'id': 'call_FsEF7o3IGNkK5hxNONVfCfe5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12257, 'output_tokens': 39, 'total_tokens': 12296, 'input_token_details': {'audio': 0, 'cache_read': 12160}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:57:54,987 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_sn0IDVB46kRY0pXSoSngnhem', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/responses.test.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 38, 'prompt_tokens': 12322, 'total_tokens': 12360, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12288}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--98be79e0-e7ac-42a4-8355-995261e53194-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/responses.test.js'}, 'id': 'call_sn0IDVB46kRY0pXSoSngnhem', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12322, 'output_tokens': 38, 'total_tokens': 12360, 'input_token_details': {'audio': 0, 'cache_read': 12288}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 19:58:02,265 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_GVLSbZ98Yalnuia0GSIWGXoU', 'function': {'arguments': '{"basename":"authorization.test.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 542, 'prompt_tokens': 12386, 'total_tokens': 12928, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c8fe0364-e44a-4bbb-a2cd-ed5aa6cb42e0-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'authorization.test.js'}, 'id': 'call_GVLSbZ98Yalnuia0GSIWGXoU', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12386, 'output_tokens': 542, 'total_tokens': 12928, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:03:14,130 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4w5Nt7dXxCQ6uXupzQNB6GBA', 'function': {'arguments': '{"text":"RequestTemplates", "relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'find_ast_node_with_text_in_file_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1141, 'prompt_tokens': 12436, 'total_tokens': 13577, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1088, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12160}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--13d2b0a0-a7a3-46ab-8ff6-efa26cb405e9-0' tool_calls=[{'name': 'find_ast_node_with_text_in_file_with_relative_path', 'args': {'text': 'RequestTemplates', 'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_4w5Nt7dXxCQ6uXupzQNB6GBA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12436, 'output_tokens': 1141, 'total_tokens': 13577, 'input_token_details': {'audio': 0, 'cache_read': 12160}, 'output_token_details': {'audio': 0, 'reasoning': 1088}}
2025-11-13 20:03:33,725 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_6Ezwa41YTQmnQc7fNraHe1nP', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js","start_line":1,"end_line":2500}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2165, 'prompt_tokens': 28709, 'total_tokens': 30874, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2112, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f8b63fa8-4910-4040-8b82-bf497b3560bf-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js', 'start_line': 1, 'end_line': 2500}, 'id': 'call_6Ezwa41YTQmnQc7fNraHe1nP', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28709, 'output_tokens': 2165, 'total_tokens': 30874, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 2112}}
2025-11-13 20:03:50,611 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I located and returned the full contents with line numbers of lib/plugins/aws/package/compile/events/apiGateway/index.test.js and the recursive test at lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js. The method tests include extensive assertions around integration types, request parameters, and request mapping templates (default and custom), which should cover your need for extracting regression cases. I also checked for any dedicated method/integration test files under this module but did not find separate tests beyond the consolidated method/index.test.js. If you want, I can search for and include other submodule tests under apiGateway (e.g., cors, authorizers, resources) as well.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1873, 'prompt_tokens': 49698, 'total_tokens': 51571, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1728, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--839822e5-4445-4a6d-968a-751c0fd6ded0-0' usage_metadata={'input_tokens': 49698, 'output_tokens': 1873, 'total_tokens': 51571, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1728}}
2025-11-13 20:03:50,614 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the full contents with line numbers of all *test.js files under lib/plugins/aws/package/compile/events/apiGateway (recursively), especially any that cover method integration or request mapping templates.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If listing all is too large, include at minimum: index.test.js for this module and any tests that reference method/integration.js.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
I need these test files to extract 8 relevant cases that assert generated request mapping templates and would serve as regression tests for changing default templates.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 1 - 105
Content:
1. 'use strict';
2. 
3. /* eslint-disable global-require */
4. 
5. const BbPromise = require('bluebird');
6. 
7. const validate = require('./lib/validate');
8. const compileRestApi = require('./lib/restApi');
9. const compileApiKeys = require('./lib/apiKeys');
10. const compileUsagePlan = require('./lib/usagePlan');
11. const compileUsagePlanKeys = require('./lib/usagePlanKeys');
12. const compileResources = require('./lib/resources');
13. const compileCors = require('./lib/cors');
14. const compileMethods = require('./lib/method/index');
15. const compileAuthorizers = require('./lib/authorizers');
16. const compileDeployment = require('./lib/deployment');
17. const compilePermissions = require('./lib/permissions');
18. const compileStage = require('./lib/stage');
19. const getMethodAuthorization = require('./lib/method/authorization');
20. const getMethodIntegration = require('./lib/method/integration');
21. const getMethodResponses = require('./lib/method/responses');
22. 
23. class AwsCompileApigEvents {
24.   constructor(serverless, options) {
25.     this.serverless = serverless;
26.     this.options = options;
27.     this.provider = this.serverless.getProvider('aws');
28. 
29.     this.serverless.configSchemaHandler.defineFunctionEvent('aws', 'http', {
30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018
31.       anyOf: [{ type: 'string' }, { type: 'object' }],
32.     });
33. 
34.     // used for the generated method logical ids (GET, PATCH, PUT, DELETE, OPTIONS, ...)
35.     this.apiGatewayMethodLogicalIds = [];
36. 
37.     Object.assign(
38.       this,
39.       validate,
40.       compileRestApi,
41.       compileApiKeys,
42.       compileUsagePlan,
43.       compileUsagePlanKeys,
44.       compileResources,
45.       compileCors,
46.       compileMethods,
47.       compileAuthorizers,
48.       compileDeployment,
49.       compilePermissions,
50.       compileStage,
51.       getMethodAuthorization,
52.       getMethodIntegration,
53.       getMethodResponses
54.     );
55. 
56.     this.hooks = {
57.       'package:compileEvents': () => {
58.         this.validated = this.validate();
59. 
60.         if (this.validated.events.length === 0) {
61.           return BbPromise.resolve();
62.         }
63. 
64.         return BbPromise.bind(this)
65.           .then(this.compileRestApi)
66.           .then(this.compileResources)
67.           .then(this.compileCors)
68.           .then(this.compileMethods)
69.           .then(this.compileAuthorizers)
70.           .then(this.compileDeployment)
71.           .then(this.compileApiKeys)
72.           .then(this.compileUsagePlan)
73.           .then(this.compileUsagePlanKeys)
74.           .then(this.compilePermissions)
75.           .then(this.compileStage);
76.       },
77. 
78.       // TODO should be removed once AWS fixes the CloudFormation problems using a separate Stage
79.       'after:deploy:deploy': () => {
80.         const getServiceState = require('../../../../lib/getServiceState').getServiceState;
81. 
82.         const state = getServiceState.call(this);
83.         const updateStage = require('./lib/hack/updateStage').updateStage;
84. 
85.         this.state = state;
86.         return updateStage.call(this);
87.       },
88. 
89.       // TODO should be removed once AWS fixes the removal via CloudFormation
90.       'before:remove:remove': () => {
91.         // eslint-disable-next-line no-shadow
92.         const validate = require('../../../../lib/validate').validate;
93.         // eslint-disable-next-line max-len
94.         const disassociateUsagePlan = require('./lib/hack/disassociateUsagePlan')
95.           .disassociateUsagePlan;
96. 
97.         return BbPromise.bind(this)
98.           .then(validate)
99.           .then(disassociateUsagePlan);
100.       },
101.     };
102.   }
103. }
104. 
105. module.exports = AwsCompileApigEvents;


File: lib/plugins/aws/package/compile/events/apiGateway/index.test.js
Line number range: 1 - 179
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const sinon = require('sinon');
5. const AwsProvider = require('../../../../provider/awsProvider');
6. const AwsCompileApigEvents = require('./index');
7. const Serverless = require('../../../../../../Serverless');
8. const validate = require('../../../../lib/validate');
9. const getServiceState = require('../../../../lib/getServiceState');
10. const updateStage = require('./lib/hack/updateStage');
11. const disassociateUsagePlan = require('./lib/hack/disassociateUsagePlan');
12. 
13. describe('AwsCompileApigEvents', () => {
14.   let awsCompileApigEvents;
15. 
16.   beforeEach(() => {
17.     const serverless = new Serverless();
18.     serverless.service.environment = {
19.       vars: {},
20.       stages: {
21.         dev: {
22.           vars: {},
23.           regions: {
24.             'us-east-1': {
25.               vars: {},
26.             },
27.           },
28.         },
29.       },
30.     };
31.     const options = {
32.       stage: 'dev',
33.       region: 'us-east-1',
34.     };
35.     serverless.setProvider('aws', new AwsProvider(serverless, options));
36.     awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
37.   });
38. 
39.   describe('#constructor()', () => {
40.     let compileRestApiStub;
41.     let compileResourcesStub;
42.     let compileMethodsStub;
43.     let compileDeploymentStub;
44.     let compileUsagePlanStub;
45.     let compilePermissionsStub;
46.     let compileStageStub;
47.     let updateStageStub;
48.     let disassociateUsagePlanStub;
49. 
50.     beforeEach(() => {
51.       compileRestApiStub = sinon.stub(awsCompileApigEvents, 'compileRestApi').resolves();
52.       compileResourcesStub = sinon.stub(awsCompileApigEvents, 'compileResources').resolves();
53.       compileMethodsStub = sinon.stub(awsCompileApigEvents, 'compileMethods').resolves();
54.       compileDeploymentStub = sinon.stub(awsCompileApigEvents, 'compileDeployment').resolves();
55.       compileUsagePlanStub = sinon.stub(awsCompileApigEvents, 'compileUsagePlan').resolves();
56.       compilePermissionsStub = sinon.stub(awsCompileApigEvents, 'compilePermissions').resolves();
57.       compileStageStub = sinon.stub(awsCompileApigEvents, 'compileStage').resolves();
58.       updateStageStub = sinon.stub(updateStage, 'updateStage').resolves();
59.       disassociateUsagePlanStub = sinon
60.         .stub(disassociateUsagePlan, 'disassociateUsagePlan')
61.         .resolves();
62.     });
63. 
64.     afterEach(() => {
65.       awsCompileApigEvents.compileRestApi.restore();
66.       awsCompileApigEvents.compileResources.restore();
67.       awsCompileApigEvents.compileMethods.restore();
68.       awsCompileApigEvents.compileDeployment.restore();
69.       awsCompileApigEvents.compileUsagePlan.restore();
70.       awsCompileApigEvents.compilePermissions.restore();
71.       awsCompileApigEvents.compileStage.restore();
72.       updateStage.updateStage.restore();
73.       disassociateUsagePlan.disassociateUsagePlan.restore();
74.     });
75. 
76.     it('should have hooks', () => expect(awsCompileApigEvents.hooks).to.be.not.empty);
77. 
78.     it('should set the provider variable to be an instanceof AwsProvider', () =>
79.       expect(awsCompileApigEvents.provider).to.be.instanceof(AwsProvider));
80. 
81.     it('should setup an empty array to gather the method logical ids', () =>
82.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([]));
83. 
84.     it('should run "package:compileEvents" promise chain in order', () => {
85.       const validateStub = sinon.stub(awsCompileApigEvents, 'validate').returns({
86.         events: [
87.           {
88.             functionName: 'first',
89.             http: {
90.               path: 'users',
91.               method: 'POST',
92.             },
93.           },
94.         ],
95.       });
96. 
97.       return awsCompileApigEvents.hooks['package:compileEvents']().then(() => {
98.         expect(validateStub.calledOnce).to.be.equal(true);
99.         expect(compileRestApiStub.calledAfter(validateStub)).to.be.equal(true);
100.         expect(compileResourcesStub.calledAfter(compileRestApiStub)).to.be.equal(true);
101.         expect(compileMethodsStub.calledAfter(compileResourcesStub)).to.be.equal(true);
102.         expect(compileDeploymentStub.calledAfter(compileMethodsStub)).to.be.equal(true);
103.         expect(compileUsagePlanStub.calledAfter(compileDeploymentStub)).to.be.equal(true);
104.         expect(compilePermissionsStub.calledAfter(compileUsagePlanStub)).to.be.equal(true);
105.         expect(compileStageStub.calledAfter(compilePermissionsStub)).to.be.equal(true);
106. 
107.         awsCompileApigEvents.validate.restore();
108.       });
109.     });
110. 
111.     describe('when running the "after:deploy:deploy" promise chain', () => {
112.       let getServiceStateStub;
113. 
114.       beforeEach(() => {
115.         getServiceStateStub = sinon.stub(getServiceState, 'getServiceState');
116.       });
117. 
118.       afterEach(() => {
119.         getServiceState.getServiceState.restore();
120.       });
121. 
122.       it('should run the promise chain in order', () => {
123.         getServiceStateStub.returns({
124.           service: {
125.             functions: {
126.               first: {
127.                 events: [
128.                   {
129.                     http: {
130.                       path: 'users',
131.                       method: 'POST',
132.                     },
133.                   },
134.                 ],
135.               },
136.             },
137.           },
138.         });
139. 
140.         return awsCompileApigEvents.hooks['after:deploy:deploy']().then(() => {
141.           expect(updateStageStub.calledOnce).to.equal(true);
142.         });
143.       });
144. 
145.       it('should not skip the updateStage step when no http events are found', () => {
146.         getServiceStateStub.returns({
147.           service: {
148.             functions: {
149.               first: {
150.                 events: [],
151.               },
152.             },
153.           },
154.         });
155. 
156.         return awsCompileApigEvents.hooks['after:deploy:deploy']().then(() => {
157.           expect(updateStageStub.calledOnce).to.equal(true);
158.         });
159.       });
160.     });
161. 
162.     it('should run "before:remove:remove" promise chain in order', () => {
163.       const validateStub = sinon.stub(validate, 'validate').returns();
164. 
165.       return awsCompileApigEvents.hooks['before:remove:remove']().then(() => {
166.         expect(validateStub.calledOnce).to.equal(true);
167.         expect(disassociateUsagePlanStub.calledAfter(validateStub)).to.equal(true);
168. 
169.         validate.validate.restore();
170.       });
171.     });
172. 
173.     it('should resolve if no functions are given', () => {
174.       awsCompileApigEvents.serverless.service.functions = {};
175. 
176.       return awsCompileApigEvents.hooks['package:compileEvents']();
177.     });
178.   });
179. });


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
Line number range: 1 - 2500
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsCompileApigEvents = require('../../index');
5. const Serverless = require('../../../../../../../../Serverless');
6. const AwsProvider = require('../../../../../../provider/awsProvider');
7. 
8. describe('#compileMethods()', () => {
9.   let serverless;
10.   let awsCompileApigEvents;
11. 
12.   beforeEach(() => {
13.     const options = {
14.       stage: 'dev',
15.       region: 'us-east-1',
16.     };
17.     serverless = new Serverless();
18.     serverless.setProvider('aws', new AwsProvider(serverless, options));
19.     serverless.service.service = 'first-service';
20.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
21.     serverless.service.environment = {
22.       stages: {
23.         dev: {
24.           regions: {
25.             'us-east-1': {
26.               vars: {
27.                 IamRoleLambdaExecution:
28.                   'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
29.               },
30.             },
31.           },
32.         },
33.       },
34.     };
35.     serverless.service.functions.First = {};
36.     serverless.service.functions.Second = {};
37.     serverless.service.functions.Third = {};
38.     awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
39.     awsCompileApigEvents.validated = {};
40.     awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
41.     awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
42.     awsCompileApigEvents.apiGatewayResources = {
43.       'users/create': {
44.         name: 'UsersCreate',
45.         resourceLogicalId: 'ApiGatewayResourceUsersCreate',
46.       },
47. 
48.       'users/list': {
49.         name: 'UsersList',
50.         resourceLogicalId: 'ApiGatewayResourceUsersList',
51.       },
52.       'users/update': {
53.         name: 'UsersUpdate',
54.         resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
55.       },
56.       'users/delete': {
57.         name: 'UsersDelete',
58.         resourceLogicalId: 'ApiGatewayResourceUsersDelete',
59.       },
60.     };
61.   });
62. 
63.   it('should have request validators/models defined when they are set', () => {
64.     awsCompileApigEvents.validated.events = [
65.       {
66.         functionName: 'First',
67.         http: {
68.           path: 'users/create',
69.           method: 'post',
70.           integration: 'AWS',
71.           request: { schema: { 'application/json': { foo: 'bar' } } },
72.         },
73.       },
74.     ];
75.     return awsCompileApigEvents.compileMethods().then(() => {
76.       expect(
77.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .ApiGatewayMethodUsersCreatePostValidator
79.       ).to.deep.equal({
80.         Type: 'AWS::ApiGateway::RequestValidator',
81.         Properties: {
82.           RestApiId: { Ref: 'ApiGatewayRestApi' },
83.           ValidateRequestBody: true,
84.           ValidateRequestParameters: true,
85.         },
86.       });
87.       expect(
88.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
89.           .ApiGatewayMethodUsersCreatePostApplicationJsonModel
90.       ).to.deep.equal({
91.         Type: 'AWS::ApiGateway::Model',
92.         Properties: {
93.           RestApiId: { Ref: 'ApiGatewayRestApi' },
94.           ContentType: 'application/json',
95.           Schema: { foo: 'bar' },
96.         },
97.       });
98.       expect(
99.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
100.           .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
101.       ).to.deep.equal({
102.         'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
103.       });
104.       expect(
105.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
106.           .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
107.       ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
108.     });
109.   });
110. 
111.   it('should support multiple request schemas', () => {
112.     awsCompileApigEvents.validated.events = [
113.       {
114.         functionName: 'First',
115.         http: {
116.           path: 'users/create',
117.           method: 'post',
118.           integration: 'AWS',
119.           request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
120.         },
121.       },
122.     ];
123.     return awsCompileApigEvents.compileMethods().then(() => {
124.       expect(
125.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
126.           .ApiGatewayMethodUsersCreatePostValidator
127.       ).to.deep.equal({
128.         Type: 'AWS::ApiGateway::RequestValidator',
129.         Properties: {
130.           RestApiId: { Ref: 'ApiGatewayRestApi' },
131.           ValidateRequestBody: true,
132.           ValidateRequestParameters: true,
133.         },
134.       });
135.       expect(
136.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
137.           .ApiGatewayMethodUsersCreatePostApplicationJsonModel
138.       ).to.deep.equal({
139.         Type: 'AWS::ApiGateway::Model',
140.         Properties: {
141.           RestApiId: { Ref: 'ApiGatewayRestApi' },
142.           ContentType: 'application/json',
143.           Schema: { foo: 'bar' },
144.         },
145.       });
146.       expect(
147.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
148.           .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
149.       ).to.deep.equal({
150.         'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
151.         'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
152.       });
153.       expect(
154.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
155.           .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
156.       ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
157.     });
158.   });
159. 
160.   it('should have request parameters defined when they are set', () => {
161.     awsCompileApigEvents.validated.events = [
162.       {
163.         functionName: 'First',
164.         http: {
165.           path: 'users/create',
166.           method: 'post',
167.           integration: 'AWS',
168.           request: {
169.             parameters: {
170.               'method.request.querystring.foo': true,
171.               'method.request.querystring.bar': false,
172.               'method.request.header.foo': true,
173.               'method.request.header.bar': false,
174.               'method.request.path.foo': true,
175.               'method.request.path.bar': false,
176.             },
177.           },
178.           response: {
179.             statusCodes: {
180.               200: {
181.                 pattern: '',
182.               },
183.             },
184.           },
185.         },
186.       },
187.     ];
188.     return awsCompileApigEvents.compileMethods().then(() => {
189.       expect(
190.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
191.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
192.       ).to.equal(true);
193.       expect(
194.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
195.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
196.       ).to.equal(false);
197.       expect(
198.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
199.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
200.           'method.request.querystring.foo'
201.         ]
202.       ).to.equal(true);
203.       expect(
204.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
205.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
206.           'method.request.querystring.bar'
207.         ]
208.       ).to.equal(false);
209.       expect(
210.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
211.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
212.       ).to.equal(true);
213.       expect(
214.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
215.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
216.       ).to.equal(false);
217.     });
218.   });
219. 
220.   it('should not have integration RequestParameters when no request parameters are set', () => {
221.     awsCompileApigEvents.validated.events = [
222.       {
223.         functionName: 'First',
224.         http: {
225.           path: 'users/create',
226.           method: 'post',
227.           integration: 'AWS',
228.         },
229.       },
230.     ];
231.     return awsCompileApigEvents.compileMethods().then(() => {
232.       expect(
233.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
234.           .ApiGatewayMethodUsersCreatePost.Properties.Integration
235.       ).to.not.have.key('RequestParameters');
236.     });
237.   });
238. 
239.   it('should create method resources when http events given', () => {
240.     awsCompileApigEvents.validated.events = [
241.       {
242.         functionName: 'First',
243.         http: {
244.           path: 'users/create',
245.           method: 'post',
246.         },
247.       },
248.       {
249.         functionName: 'Second',
250.         http: {
251.           method: 'get',
252.           path: 'users/list',
253.         },
254.       },
255.     ];
256.     return awsCompileApigEvents.compileMethods().then(() => {
257.       expect(
258.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
259.           .ApiGatewayMethodUsersCreatePost.Type
260.       ).to.equal('AWS::ApiGateway::Method');
261.       expect(
262.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
263.           .ApiGatewayMethodUsersListGet.Type
264.       ).to.equal('AWS::ApiGateway::Method');
265.     });
266.   });
267. 
268.   it('should support AWS integration type', () => {
269.     awsCompileApigEvents.validated.events = [
270.       {
271.         functionName: 'First',
272.         http: {
273.           path: 'users/create',
274.           method: 'post',
275.           integration: 'AWS',
276.           request: {
277.             parameters: {
278.               'method.request.querystring.foo': true,
279.               'method.request.querystring.bar': false,
280.               'method.request.path.foo': true,
281.               'method.request.path.bar': false,
282.               'method.request.header.foo': true,
283.               'method.request.header.bar': false,
284.             },
285.           },
286.         },
287.       },
288.     ];
289.     return awsCompileApigEvents.compileMethods().then(() => {
290.       expect(
291.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
292.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
293.       ).to.equal('AWS');
294.       expect(
295.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
297.       ).to.deep.equal({
298.         'integration.request.querystring.foo': 'method.request.querystring.foo',
299.         'integration.request.querystring.bar': 'method.request.querystring.bar',
300.         'integration.request.path.foo': 'method.request.path.foo',
301.         'integration.request.path.bar': 'method.request.path.bar',
302.         'integration.request.header.foo': 'method.request.header.foo',
303.         'integration.request.header.bar': 'method.request.header.bar',
304.       });
305.     });
306.   });
307. 
308.   it('should support AWS_PROXY integration type', () => {
309.     awsCompileApigEvents.validated.events = [
310.       {
311.         functionName: 'First',
312.         http: {
313.           path: 'users/create',
314.           method: 'post',
315.           integration: 'AWS_PROXY',
316.         },
317.       },
318.     ];
319.     return awsCompileApigEvents.compileMethods().then(() => {
320.       expect(
321.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
322.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
323.       ).to.equal('AWS_PROXY');
324.     });
325.   });
326. 
327.   it('should support HTTP integration type', () => {
328.     awsCompileApigEvents.validated.events = [
329.       {
330.         functionName: 'First',
331.         http: {
332.           path: 'users/create',
333.           method: 'post',
334.           integration: 'HTTP',
335.           request: {
336.             uri: 'https://example.com',
337.             parameters: {
338.               'method.request.querystring.foo': true,
339.               'method.request.querystring.bar': false,
340.               'method.request.path.foo': true,
341.               'method.request.path.bar': false,
342.               'method.request.header.foo': true,
343.               'method.request.header.bar': false,
344.             },
345.           },
346.         },
347.       },
348.     ];
349.     return awsCompileApigEvents.compileMethods().then(() => {
350.       expect(
351.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
352.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
353.       ).to.equal('HTTP');
354.       expect(
355.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
356.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
357.       ).to.equal('https://example.com');
358.       expect(
359.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
360.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
361.       ).to.equal('POST');
362.       expect(
363.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
364.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
365.       ).to.equal(undefined);
366.       expect(
367.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
368.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
369.       ).to.deep.equal({
370.         'integration.request.querystring.foo': 'method.request.querystring.foo',
371.         'integration.request.querystring.bar': 'method.request.querystring.bar',
372.         'integration.request.path.foo': 'method.request.path.foo',
373.         'integration.request.path.bar': 'method.request.path.bar',
374.         'integration.request.header.foo': 'method.request.header.foo',
375.         'integration.request.header.bar': 'method.request.header.bar',
376.       });
377.     });
378.   });
379. 
380.   it('should support HTTP integration type with custom request options', () => {
381.     awsCompileApigEvents.validated.events = [
382.       {
383.         functionName: 'First',
384.         http: {
385.           path: 'users/create',
386.           method: 'post',
387.           integration: 'HTTP',
388.           request: {
389.             uri: 'https://example.com',
390.             method: 'put',
391.           },
392.         },
393.       },
394.     ];
395.     return awsCompileApigEvents.compileMethods().then(() => {
396.       expect(
397.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
398.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
399.       ).to.equal('HTTP');
400.       expect(
401.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
402.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
403.       ).to.equal('https://example.com');
404.       expect(
405.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
406.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
407.       ).to.equal('PUT');
408.     });
409.   });
410. 
411.   it('should support HTTP_PROXY integration type', () => {
412.     awsCompileApigEvents.validated.events = [
413.       {
414.         functionName: 'First',
415.         http: {
416.           path: 'users/create',
417.           method: 'post',
418.           integration: 'HTTP_PROXY',
419.           request: {
420.             uri: 'https://example.com',
421.             method: 'patch',
422.             parameters: {
423.               'method.request.querystring.foo': true,
424.               'method.request.querystring.bar': false,
425.               'method.request.path.foo': true,
426.               'method.request.path.bar': false,
427.               'method.request.header.foo': true,
428.               'method.request.header.bar': false,
429.             },
430.           },
431.         },
432.       },
433.     ];
434.     return awsCompileApigEvents.compileMethods().then(() => {
435.       expect(
436.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
437.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
438.       ).to.equal('HTTP_PROXY');
439.       expect(
440.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
441.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
442.       ).to.equal('https://example.com');
443.       expect(
444.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
445.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
446.       ).to.equal('PATCH');
447.       expect(
448.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
449.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
450.       ).to.deep.equal({
451.         'integration.request.querystring.foo': 'method.request.querystring.foo',
452.         'integration.request.querystring.bar': 'method.request.querystring.bar',
453.         'integration.request.path.foo': 'method.request.path.foo',
454.         'integration.request.path.bar': 'method.request.path.bar',
455.         'integration.request.header.foo': 'method.request.header.foo',
456.         'integration.request.header.bar': 'method.request.header.bar',
457.       });
458.     });
459.   });
460. 
461.   it('should support MOCK integration type', () => {
462.     awsCompileApigEvents.validated.events = [
463.       {
464.         functionName: 'First',
465.         http: {
466.           path: 'users/create',
467.           method: 'post',
468.           integration: 'MOCK',
469.         },
470.       },
471.     ];
472.     return awsCompileApigEvents.compileMethods().then(() => {
473.       expect(
474.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
475.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
476.       ).to.equal('MOCK');
477.     });
478.   });
479. 
480.   it('should add request parameter when async config is used', () => {
481.     awsCompileApigEvents.validated.events = [
482.       {
483.         functionName: 'First',
484.         http: {
485.           path: 'users/create',
486.           method: 'post',
487.           async: true,
488.         },
489.       },
490.     ];
491.     return awsCompileApigEvents.compileMethods().then(() => {
492.       expect(
493.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
494.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
495.           'integration.request.header.X-Amz-Invocation-Type'
496.         ]
497.       ).to.equal("'Event'");
498.     });
499.   });
500. 
501.   it('should add request parameter when integration type is AWS_PROXY and async', () => {
502.     awsCompileApigEvents.validated.events = [
503.       {
504.         functionName: 'First',
505.         http: {
506.           path: 'users/create',
507.           method: 'post',
508.           integration: 'AWS_PROXY',
509.           async: true,
510.         },
511.       },
512.     ];
513.     return awsCompileApigEvents.compileMethods().then(() => {
514.       expect(
515.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
516.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
517.           'integration.request.header.X-Amz-Invocation-Type'
518.         ]
519.       ).to.equal("'Event'");
520.     });
521.   });
522. 
523.   it('should add request parameter mapped value when explicitly defined', () => {
524.     awsCompileApigEvents.validated.events = [
525.       {
526.         functionName: 'First',
527.         http: {
528.           path: 'users/create',
529.           method: 'post',
530.           integration: 'HTTP_PROXY',
531.           request: {
532.             uri: 'https://example.com',
533.             parameters: {
534.               'method.request.querystring.foo': {
535.                 required: true,
536.                 mappedValue: 'fooValue',
537.               },
538.               'method.request.querystring.bar': {
539.                 required: false,
540.                 mappedValue: 'barValue',
541.               },
542.               'method.request.path.foo': {
543.                 required: true,
544.                 mappedValue: 'fooValue',
545.               },
546.               'method.request.path.bar': {
547.                 required: false,
548.                 mappedValue: 'barValue',
549.               },
550.               'method.request.header.foo': {
551.                 required: true,
552.                 mappedValue: 'fooValue',
553.               },
554.               'method.request.header.bar': {
555.                 required: false,
556.                 mappedValue: 'barValue',
557.               },
558.             },
559.           },
560.         },
561.       },
562.     ];
563.     return awsCompileApigEvents.compileMethods().then(() => {
564.       expect(
565.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
566.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
567.       ).to.equal(true);
568.       expect(
569.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
570.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
571.       ).to.equal(false);
572.       expect(
573.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
574.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
575.           'method.request.querystring.foo'
576.         ]
577.       ).to.equal(true);
578.       expect(
579.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
580.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
581.           'method.request.querystring.bar'
582.         ]
583.       ).to.equal(false);
584.       expect(
585.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
586.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
587.       ).to.equal(true);
588.       expect(
589.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
590.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
591.       ).to.equal(false);
592.       expect(
593.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
594.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
595.       ).to.deep.equal({
596.         'integration.request.querystring.foo': 'fooValue',
597.         'integration.request.querystring.bar': 'barValue',
598.         'integration.request.path.foo': 'fooValue',
599.         'integration.request.path.bar': 'barValue',
600.         'integration.request.header.foo': 'fooValue',
601.         'integration.request.header.bar': 'barValue',
602.       });
603.     });
604.   });
605. 
606.   it('should set authorizer config for AWS_IAM', () => {
607.     awsCompileApigEvents.validated.events = [
608.       {
609.         functionName: 'First',
610.         http: {
611.           path: 'users/create',
612.           method: 'post',
613.           authorizer: {
614.             type: 'AWS_IAM',
615.           },
616.         },
617.       },
618.     ];
619.     return awsCompileApigEvents.compileMethods().then(() => {
620.       expect(
621.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
622.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
623.       ).to.equal('AWS_IAM');
624.     });
625.   });
626. 
627.   it('should set custom authorizer config with authorizerId', () => {
628.     awsCompileApigEvents.validated.events = [
629.       {
630.         functionName: 'First',
631.         http: {
632.           path: 'users/create',
633.           method: 'post',
634.           authorizer: {
635.             type: 'COGNITO_USER_POOLS',
636.             authorizerId: 'gy7lyj',
637.           },
638.         },
639.       },
640.     ];
641.     return awsCompileApigEvents.compileMethods().then(() => {
642.       expect(
643.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
644.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
645.       ).to.equal('COGNITO_USER_POOLS');
646.       expect(
647.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
648.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
649.       ).to.equal('gy7lyj');
650.     });
651.   });
652. 
653.   it('should set authorizer config if given as ARN string', () => {
654.     awsCompileApigEvents.validated.events = [
655.       {
656.         functionName: 'First',
657.         http: {
658.           authorizer: {
659.             name: 'Authorizer',
660.           },
661.           integration: 'AWS',
662.           path: 'users/create',
663.           method: 'post',
664.         },
665.       },
666.     ];
667.     return awsCompileApigEvents.compileMethods().then(() => {
668.       expect(
669.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
670.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
671.       ).to.equal('CUSTOM');
672. 
673.       expect(
674.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
675.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
676.       ).to.equal('AuthorizerApiGatewayAuthorizer');
677.     });
678.   });
679. 
680.   it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
681.     awsCompileApigEvents.validated.events = [
682.       {
683.         functionName: 'First',
684.         http: {
685.           authorizer: {
686.             name: 'authorizer',
687.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
688.             scopes: ['myapp/read', 'myapp/write'],
689.           },
690.           integration: 'AWS',
691.           path: 'users/create',
692.           method: 'post',
693.         },
694.       },
695.     ];
696. 
697.     return awsCompileApigEvents.compileMethods().then(() => {
698.       expect(
699.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
700.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
701.       ).to.equal('COGNITO_USER_POOLS');
702. 
703.       expect(
704.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
705.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
706.       ).to.contain('myapp/read');
707. 
708.       expect(
709.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
710.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
711.       ).to.equal('AuthorizerApiGatewayAuthorizer');
712. 
713.       expect(
714.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
715.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
716.           'application/json'
717.         ]
718.       ).to.not.match(/undefined/);
719.     });
720.   });
721. 
722.   it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
723.     awsCompileApigEvents.validated.events = [
724.       {
725.         functionName: 'First',
726.         http: {
727.           authorizer: {
728.             name: 'authorizer',
729.             type: 'COGNITO_USER_POOLS',
730.             authorizerId: { Ref: 'CognitoAuthorizer' },
731.             scopes: ['myapp/read', 'myapp/write'],
732.           },
733.           integration: 'AWS',
734.           path: 'users/create',
735.           method: 'post',
736.         },
737.       },
738.     ];
739. 
740.     return awsCompileApigEvents.compileMethods().then(() => {
741.       expect(
742.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
743.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
744.       ).to.equal('COGNITO_USER_POOLS');
745. 
746.       expect(
747.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
748.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
749.       ).to.contain('myapp/read');
750. 
751.       expect(
752.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
753.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
754.       ).to.equal('CognitoAuthorizer');
755. 
756.       expect(
757.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
758.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
759.           'application/json'
760.         ]
761.       ).to.not.match(/undefined/);
762.     });
763.   });
764. 
765.   it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
766.     awsCompileApigEvents.validated.events = [
767.       {
768.         functionName: 'First',
769.         http: {
770.           authorizer: {
771.             name: 'authorizer',
772.             type: 'COGNITO_USER_POOLS',
773.             arn: {
774.               'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
775.             },
776.             scopes: ['myapp/read', 'myapp/write'],
777.           },
778.           integration: 'AWS',
779.           path: 'users/create',
780.           method: 'post',
781.         },
782.       },
783.     ];
784. 
785.     return awsCompileApigEvents.compileMethods().then(() => {
786.       expect(
787.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
788.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
789.       ).to.equal('COGNITO_USER_POOLS');
790. 
791.       expect(
792.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
793.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
794.       ).to.contain('myapp/read');
795. 
796.       expect(
797.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
798.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
799.       ).to.equal('AuthorizerApiGatewayAuthorizer');
800. 
801.       expect(
802.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
803.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
804.           'application/json'
805.         ]
806.       ).to.not.match(/undefined/);
807.     });
808.   });
809. 
810.   it('should not scopes for a cognito user pool when given empty scopes array', () => {
811.     awsCompileApigEvents.validated.events = [
812.       {
813.         functionName: 'First',
814.         http: {
815.           authorizer: {
816.             name: 'authorizer',
817.             type: 'COGNITO_USER_POOLS',
818.             authorizerId: { Ref: 'CognitoAuthorizer' },
819.             scopes: [],
820.           },
821.           integration: 'AWS',
822.           path: 'users/create',
823.           method: 'post',
824.         },
825.       },
826.     ];
827. 
828.     return awsCompileApigEvents.compileMethods().then(() => {
829.       expect(
830.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
831.           .ApiGatewayMethodUsersCreatePost.Properties
832.       ).to.not.have.property('AuthorizationScopes');
833.     });
834.   });
835. 
836.   it('should set claims for a cognito user pool', () => {
837.     awsCompileApigEvents.validated.events = [
838.       {
839.         functionName: 'First',
840.         http: {
841.           authorizer: {
842.             name: 'authorizer',
843.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
844.             claims: ['email'],
845.           },
846.           integration: 'AWS',
847.           path: 'users/create',
848.           method: 'post',
849.         },
850.       },
851.     ];
852. 
853.     return awsCompileApigEvents.compileMethods().then(() => {
854.       const jsonRequestTemplatesString =
855.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
856.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
857.           'application/json'
858.         ];
859.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
860.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
861.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
862.       expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
863.     });
864.   });
865. 
866.   it('should set multiple claims for a cognito user pool', () => {
867.     awsCompileApigEvents.validated.events = [
868.       {
869.         functionName: 'First',
870.         http: {
871.           authorizer: {
872.             name: 'authorizer',
873.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
874.             claims: ['email', 'gender'],
875.           },
876.           integration: 'AWS',
877.           path: 'users/create',
878.           method: 'post',
879.         },
880.       },
881.     ];
882. 
883.     return awsCompileApigEvents.compileMethods().then(() => {
884.       const jsonRequestTemplatesString =
885.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
886.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
887.           'application/json'
888.         ];
889.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
890.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
891.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
892.       expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
893.       expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
894.     });
895.   });
896. 
897.   it('should properly set claims for custom properties inside the cognito user pool', () => {
898.     awsCompileApigEvents.validated.events = [
899.       {
900.         functionName: 'First',
901.         http: {
902.           authorizer: {
903.             name: 'authorizer',
904.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
905.             claims: ['email', 'custom:score'],
906.           },
907.           integration: 'AWS',
908.           path: 'users/create',
909.           method: 'post',
910.         },
911.       },
912.     ];
913. 
914.     return awsCompileApigEvents.compileMethods().then(() => {
915.       const jsonRequestTemplatesString =
916.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
917.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
918.           'application/json'
919.         ];
920.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
921.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
922.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
923.       expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
924.       expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
925.     });
926.   });
927. 
928.   it('should replace the extra claims in the template if there are none', () => {
929.     awsCompileApigEvents.validated.events = [
930.       {
931.         functionName: 'First',
932.         http: {
933.           authorizer: {
934.             name: 'authorizer',
935.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
936.           },
937.           integration: 'AWS',
938.           path: 'users/create',
939.           method: 'post',
940.         },
941.       },
942.     ];
943. 
944.     return awsCompileApigEvents.compileMethods().then(() => {
945.       expect(
946.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
947.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
948.           'application/json'
949.         ]
950.       ).to.not.match(/extraCognitoPoolClaims/);
951.     });
952.   });
953. 
954.   it('should not create method resources when http events are not given', () => {
955.     awsCompileApigEvents.validated.events = [];
956. 
957.     return awsCompileApigEvents.compileMethods().then(() => {
958.       expect(
959.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
960.       ).to.deep.equal({});
961.     });
962.   });
963. 
964.   it('should update the method logical ids array', () => {
965.     awsCompileApigEvents.validated.events = [
966.       {
967.         functionName: 'First',
968.         http: {
969.           path: 'users/create',
970.           method: 'post',
971.         },
972.       },
973.       {
974.         functionName: 'Second',
975.         http: {
976.           method: 'get',
977.           path: 'users/list',
978.         },
979.       },
980.     ];
981.     return awsCompileApigEvents.compileMethods().then(() => {
982.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
983.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
984.         'ApiGatewayMethodUsersCreatePost',
985.         'ApiGatewayMethodUsersListGet',
986.       ]);
987.     });
988.   });
989. 
990.   it('should set api key as required if private endpoint', () => {
991.     awsCompileApigEvents.validated.events = [
992.       {
993.         functionName: 'First',
994.         http: {
995.           path: 'users/create',
996.           method: 'post',
997.           private: true,
998.         },
999.       },
1000.     ];
1001.     return awsCompileApigEvents.compileMethods().then(() => {
1002.       expect(
1003.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1004.           .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
1005.       ).to.equal(true);
1006.     });
1007.   });
1008. 
1009.   it('should set api key as not required if private property is not specified', () => {
1010.     awsCompileApigEvents.validated.events = [
1011.       {
1012.         functionName: 'First',
1013.         http: {
1014.           path: 'users/create',
1015.           method: 'post',
1016.         },
1017.       },
1018.     ];
1019.     return awsCompileApigEvents.compileMethods().then(() => {
1020.       expect(
1021.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1022.           .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
1023.       ).to.equal(false);
1024.     });
1025.   });
1026. 
1027.   it('should set the correct lambdaUri', () => {
1028.     awsCompileApigEvents.validated.events = [
1029.       {
1030.         functionName: 'First',
1031.         http: {
1032.           path: 'users/create',
1033.           method: 'post',
1034.         },
1035.       },
1036.       {
1037.         functionName: 'Second',
1038.         http: {
1039.           method: 'get',
1040.           path: 'users/list',
1041.         },
1042.       },
1043.     ];
1044.     return awsCompileApigEvents.compileMethods().then(() => {
1045.       expect(
1046.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1047.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
1048.       ).to.deep.equal({
1049.         'Fn::Join': [
1050.           '',
1051.           [
1052.             'arn:',
1053.             { Ref: 'AWS::Partition' },
1054.             ':apigateway:',
1055.             { Ref: 'AWS::Region' },
1056.             ':lambda:path/2015-03-31/functions/',
1057.             { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
1058.             '/invocations',
1059.           ],
1060.         ],
1061.       });
1062.       expect(
1063.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1064.           .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
1065.       ).to.deep.equal({
1066.         'Fn::Join': [
1067.           '',
1068.           [
1069.             'arn:',
1070.             { Ref: 'AWS::Partition' },
1071.             ':apigateway:',
1072.             { Ref: 'AWS::Region' },
1073.             ':lambda:path/2015-03-31/functions/',
1074.             { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
1075.             '/invocations',
1076.           ],
1077.         ],
1078.       });
1079.     });
1080.   });
1081. 
1082.   it('Should point target alias if set', () => {
1083.     awsCompileApigEvents.validated.events = [
1084.       {
1085.         functionName: 'Provisioned',
1086.         http: {
1087.           method: 'get',
1088.           path: 'users/list',
1089.         },
1090.       },
1091.     ];
1092.     serverless.service.functions.Provisioned = {
1093.       targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
1094.     };
1095.     return awsCompileApigEvents.compileMethods().then(() => {
1096.       expect(
1097.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1098.           .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
1099.       ).to.deep.equal({
1100.         'Fn::Join': [
1101.           '',
1102.           [
1103.             'arn:',
1104.             { Ref: 'AWS::Partition' },
1105.             ':apigateway:',
1106.             { Ref: 'AWS::Region' },
1107.             ':lambda:path/2015-03-31/functions/',
1108.             { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
1109.             ':',
1110.             'provisioned',
1111.             '/invocations',
1112.           ],
1113.         ],
1114.       });
1115.     });
1116.   });
1117. 
1118.   it('should add CORS origins to method only when CORS is enabled', () => {
1119.     awsCompileApigEvents.validated.events = [
1120.       {
1121.         functionName: 'First',
1122.         http: {
1123.           path: 'users/create',
1124.           method: 'post',
1125.           integration: 'AWS',
1126.           cors: {
1127.             origin: 'http://example.com',
1128.           },
1129.           response: {
1130.             statusCodes: {
1131.               200: {
1132.                 pattern: '',
1133.               },
1134.             },
1135.           },
1136.         },
1137.       },
1138.       {
1139.         functionName: 'Second',
1140.         http: {
1141.           method: 'get',
1142.           path: 'users/list',
1143.           integration: 'AWS',
1144.           response: {
1145.             statusCodes: {
1146.               200: {
1147.                 pattern: '',
1148.               },
1149.             },
1150.           },
1151.         },
1152.       },
1153.       {
1154.         functionName: 'Third',
1155.         http: {
1156.           path: 'users/update',
1157.           method: 'PUT',
1158.           integration: 'AWS',
1159.           response: {
1160.             statusCodes: {
1161.               200: {
1162.                 pattern: '',
1163.               },
1164.             },
1165.           },
1166.           cors: {
1167.             origins: ['*'],
1168.           },
1169.         },
1170.       },
1171.     ];
1172.     return awsCompileApigEvents.compileMethods().then(() => {
1173.       expect(
1174.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1175.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
1176.           .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
1177.       ).to.equal("'http://example.com'");
1178. 
1179.       // CORS not enabled!
1180.       expect(
1181.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1182.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1183.           .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
1184.       ).to.not.equal("'*'");
1185. 
1186.       expect(
1187.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1188.           .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
1189.           .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
1190.       ).to.equal("'*'");
1191.     });
1192.   });
1193. 
1194.   it('should set CORS allowCredentials to method only when specified', () => {
1195.     awsCompileApigEvents.validated.events = [
1196.       {
1197.         functionName: 'First',
1198.         http: {
1199.           path: 'users/create',
1200.           method: 'post',
1201.           integration: 'AWS',
1202.           cors: {
1203.             origin: 'http://example.com',
1204.             allowCredentials: true,
1205.           },
1206.           response: {
1207.             statusCodes: {
1208.               200: {
1209.                 pattern: '',
1210.               },
1211.             },
1212.           },
1213.         },
1214.       },
1215.       {
1216.         functionName: 'Second',
1217.         http: {
1218.           method: 'get',
1219.           path: 'users/list',
1220.           integration: 'AWS',
1221.           cors: {
1222.             origin: 'http://example.com',
1223.           },
1224.           response: {
1225.             statusCodes: {
1226.               200: {
1227.                 pattern: '',
1228.               },
1229.             },
1230.           },
1231.         },
1232.       },
1233.     ];
1234.     return awsCompileApigEvents.compileMethods().then(() => {
1235.       expect(
1236.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1237.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
1238.           .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
1239.       ).to.equal('true');
1240. 
1241.       // allowCredentials not enabled
1242.       expect(
1243.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1244.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1245.           .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
1246.       ).to.not.equal('true');
1247.     });
1248.   });
1249. 
1250.   describe('when dealing with request configuration', () => {
1251.     it('should setup a default "application/json" template', () => {
1252.       awsCompileApigEvents.validated.events = [
1253.         {
1254.           functionName: 'Second',
1255.           http: {
1256.             method: 'get',
1257.             path: 'users/list',
1258.             integration: 'AWS',
1259.             response: {
1260.               statusCodes: {
1261.                 200: {
1262.                   pattern: '',
1263.                 },
1264.               },
1265.             },
1266.           },
1267.         },
1268.       ];
1269.       return awsCompileApigEvents.compileMethods().then(() => {
1270.         expect(
1271.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1272.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
1273.             'application/json'
1274.           ]
1275.         ).to.have.length.above(0);
1276.       });
1277.     });
1278. 
1279.     it('should setup a default "application/x-www-form-urlencoded" template', () => {
1280.       awsCompileApigEvents.validated.events = [
1281.         {
1282.           functionName: 'Second',
1283.           http: {
1284.             method: 'get',
1285.             path: 'users/list',
1286.             integration: 'AWS',
1287.             response: {
1288.               statusCodes: {
1289.                 200: {
1290.                   pattern: '',
1291.                 },
1292.               },
1293.             },
1294.           },
1295.         },
1296.       ];
1297.       return awsCompileApigEvents.compileMethods().then(() => {
1298.         expect(
1299.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1300.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
1301.             'application/x-www-form-urlencoded'
1302.           ]
1303.         ).to.have.length.above(0);
1304.       });
1305.     });
1306. 
1307.     it('should use defined pass-through behavior', () => {
1308.       awsCompileApigEvents.validated.events = [
1309.         {
1310.           functionName: 'First',
1311.           http: {
1312.             method: 'GET',
1313.             path: 'users/list',
1314.             integration: 'AWS',
1315.             request: {
1316.               passThrough: 'WHEN_NO_TEMPLATES',
1317.             },
1318.             response: {
1319.               statusCodes: {
1320.                 200: {
1321.                   pattern: '',
1322.                 },
1323.               },
1324.             },
1325.           },
1326.         },
1327.       ];
1328.       return awsCompileApigEvents.compileMethods().then(() => {
1329.         expect(
1330.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1331.             .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
1332.         ).to.equal('WHEN_NO_TEMPLATES');
1333.       });
1334.     });
1335. 
1336.     it('should use defined content-handling behavior (request)', () => {
1337.       awsCompileApigEvents.validated.events = [
1338.         {
1339.           functionName: 'First',
1340.           http: {
1341.             method: 'GET',
1342.             path: 'users/list',
1343.             integration: 'AWS',
1344.             request: {
1345.               contentHandling: 'CONVERT_TO_TEXT',
1346.             },
1347.             response: {
1348.               statusCodes: {
1349.                 200: {
1350.                   pattern: '',
1351.                 },
1352.               },
1353.             },
1354.           },
1355.         },
1356.       ];
1357.       return awsCompileApigEvents.compileMethods().then(() => {
1358.         expect(
1359.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1360.             .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
1361.         ).to.equal('CONVERT_TO_TEXT');
1362.       });
1363.     });
1364. 
1365.     it('should use defined response content-handling behavior for 2XX only (response)', () => {
1366.       awsCompileApigEvents.validated.events = [
1367.         {
1368.           functionName: 'First',
1369.           http: {
1370.             method: 'GET',
1371.             path: 'users/list',
1372.             integration: 'AWS',
1373.             response: {
1374.               contentHandling: 'CONVERT_TO_BINARY',
1375.               statusCodes: {
1376.                 200: {
1377.                   pattern: '',
1378.                 },
1379.                 400: {
1380.                   pattern: '400',
1381.                 },
1382.               },
1383.             },
1384.           },
1385.         },
1386.       ];
1387.       return awsCompileApigEvents.compileMethods().then(() => {
1388.         expect(
1389.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1390.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1391.             .ContentHandling
1392.         ).to.equal('CONVERT_TO_BINARY');
1393.         expect(
1394.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1395.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1396.             .ContentHandling
1397.         ).to.equal(undefined);
1398.       });
1399.     });
1400. 
1401.     it('should set custom request templates', () => {
1402.       awsCompileApigEvents.validated.events = [
1403.         {
1404.           functionName: 'First',
1405.           http: {
1406.             method: 'GET',
1407.             path: 'users/list',
1408.             integration: 'AWS',
1409.             request: {
1410.               template: {
1411.                 'template/1': '{ "stage" : "$context.stage" }',
1412.                 'template/2': '{ "httpMethod" : "$context.httpMethod" }',
1413.               },
1414.             },
1415.             response: {
1416.               statusCodes: {
1417.                 200: {
1418.                   pattern: '',
1419.                 },
1420.               },
1421.             },
1422.           },
1423.         },
1424.       ];
1425.       return awsCompileApigEvents.compileMethods().then(() => {
1426.         expect(
1427.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1428.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
1429.         ).to.equal('{ "stage" : "$context.stage" }');
1430. 
1431.         expect(
1432.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1433.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
1434.         ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
1435.       });
1436.     });
1437. 
1438.     it('should be possible to overwrite default request templates', () => {
1439.       awsCompileApigEvents.validated.events = [
1440.         {
1441.           functionName: 'First',
1442.           http: {
1443.             method: 'GET',
1444.             path: 'users/list',
1445.             integration: 'AWS',
1446.             request: {
1447.               template: {
1448.                 'application/json': 'overwritten-request-template-content',
1449.               },
1450.             },
1451.             response: {
1452.               statusCodes: {
1453.                 200: {
1454.                   pattern: '',
1455.                 },
1456.               },
1457.             },
1458.           },
1459.         },
1460.       ];
1461.       return awsCompileApigEvents.compileMethods().then(() => {
1462.         expect(
1463.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1464.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
1465.             'application/json'
1466.           ]
1467.         ).to.equal('overwritten-request-template-content');
1468.       });
1469.     });
1470.   });
1471. 
1472.   describe('when dealing with response configuration', () => {
1473.     it('should set the custom headers', () => {
1474.       awsCompileApigEvents.validated.events = [
1475.         {
1476.           functionName: 'First',
1477.           http: {
1478.             method: 'GET',
1479.             path: 'users/list',
1480.             integration: 'AWS',
1481.             response: {
1482.               statusCodes: {
1483.                 200: {
1484.                   pattern: '',
1485.                   headers: {
1486.                     'Content-Type': "'text/plain'",
1487.                     'My-Custom-Header': 'my/custom/header',
1488.                   },
1489.                 },
1490.               },
1491.             },
1492.           },
1493.         },
1494.       ];
1495.       return awsCompileApigEvents.compileMethods().then(() => {
1496.         expect(
1497.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1498.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1499.             .ResponseParameters['method.response.header.Content-Type']
1500.         ).to.equal("'text/plain'");
1501.         expect(
1502.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1503.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1504.             .ResponseParameters['method.response.header.My-Custom-Header']
1505.         ).to.equal('my/custom/header');
1506.       });
1507.     });
1508. 
1509.     it('should set the custom template', () => {
1510.       awsCompileApigEvents.validated.events = [
1511.         {
1512.           functionName: 'First',
1513.           http: {
1514.             method: 'GET',
1515.             path: 'users/list',
1516.             integration: 'AWS',
1517.             response: {
1518.               statusCodes: {
1519.                 200: {
1520.                   template: "$input.path('$.foo')",
1521.                   pattern: '',
1522.                 },
1523.               },
1524.             },
1525.           },
1526.         },
1527.       ];
1528.       return awsCompileApigEvents.compileMethods().then(() => {
1529.         expect(
1530.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1531.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1532.             .ResponseTemplates['application/json']
1533.         ).to.equal("$input.path('$.foo')");
1534.       });
1535.     });
1536.   });
1537. 
1538.   it('should add method responses for different status codes', () => {
1539.     awsCompileApigEvents.validated.events = [
1540.       {
1541.         functionName: 'First',
1542.         http: {
1543.           method: 'get',
1544.           path: 'users/list',
1545.           integration: 'AWS',
1546.           response: {
1547.             statusCodes: {
1548.               200: {
1549.                 pattern: '',
1550.               },
1551.               202: {
1552.                 pattern: 'foo',
1553.               },
1554.             },
1555.           },
1556.         },
1557.       },
1558.     ];
1559.     return awsCompileApigEvents.compileMethods().then(() => {
1560.       expect(
1561.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1562.           .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
1563.       ).to.equal('200');
1564.       expect(
1565.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1566.           .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
1567.       ).to.equal('202');
1568.     });
1569.   });
1570. 
1571.   it('should add integration responses for different status codes', () => {
1572.     awsCompileApigEvents.validated.events = [
1573.       {
1574.         functionName: 'First',
1575.         http: {
1576.           method: 'get',
1577.           path: 'users/list',
1578.           integration: 'AWS',
1579.           response: {
1580.             statusCodes: {
1581.               200: {
1582.                 pattern: '',
1583.               },
1584.               202: {
1585.                 pattern: 'foo',
1586.               },
1587.             },
1588.           },
1589.         },
1590.       },
1591.     ];
1592.     return awsCompileApigEvents.compileMethods().then(() => {
1593.       expect(
1594.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1595.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1596.       ).to.deep.equal({
1597.         StatusCode: '202',
1598.         SelectionPattern: 'foo',
1599.         ResponseParameters: {},
1600.         ResponseTemplates: {},
1601.         ContentHandling: undefined,
1602.       });
1603.       expect(
1604.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1605.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1606.       ).to.deep.equal({
1607.         StatusCode: '200',
1608.         SelectionPattern: '',
1609.         ResponseParameters: {},
1610.         ResponseTemplates: {},
1611.         ContentHandling: undefined,
1612.       });
1613.     });
1614.   });
1615. 
1616.   it('should add fall back headers and template to statusCodes', () => {
1617.     awsCompileApigEvents.validated.events = [
1618.       {
1619.         functionName: 'First',
1620.         http: {
1621.           method: 'GET',
1622.           path: 'users/list',
1623.           integration: 'AWS',
1624.           response: {
1625.             headers: {
1626.               'Content-Type': 'text/csv',
1627.             },
1628.             template: 'foo',
1629.             statusCodes: {
1630.               400: {
1631.                 pattern: '',
1632.               },
1633.             },
1634.           },
1635.         },
1636.       },
1637.     ];
1638.     return awsCompileApigEvents.compileMethods().then(() => {
1639.       expect(
1640.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1641.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1642.           .ResponseTemplates['application/json']
1643.       ).to.equal('foo');
1644.       expect(
1645.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1646.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1647.           .ResponseParameters['method.response.header.Content-Type']
1648.       ).to.equal('text/csv');
1649.     });
1650.   });
1651. 
1652.   it('should add custom response codes', () => {
1653.     awsCompileApigEvents.validated.events = [
1654.       {
1655.         functionName: 'First',
1656.         http: {
1657.           method: 'GET',
1658.           path: 'users/list',
1659.           integration: 'AWS',
1660.           response: {
1661.             statusCodes: {
1662.               200: {
1663.                 pattern: '',
1664.                 template: "$input.path('$.foo')",
1665.               },
1666.               404: {
1667.                 pattern: '.*"statusCode":404,.*',
1668.                 template: "$input.path('$.errorMessage')",
1669.                 headers: {
1670.                   'Content-Type': 'text/html',
1671.                 },
1672.               },
1673.             },
1674.           },
1675.         },
1676.       },
1677.     ];
1678.     return awsCompileApigEvents.compileMethods().then(() => {
1679.       expect(
1680.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1681.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1682.           .ResponseTemplates['application/json']
1683.       ).to.equal("$input.path('$.foo')");
1684.       expect(
1685.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1686.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1687.           .SelectionPattern
1688.       ).to.equal('');
1689.       expect(
1690.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1691.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1692.           .ResponseTemplates['application/json']
1693.       ).to.equal("$input.path('$.errorMessage')");
1694.       expect(
1695.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1696.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1697.           .SelectionPattern
1698.       ).to.equal('.*"statusCode":404,.*');
1699.       expect(
1700.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1701.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1702.           .ResponseParameters['method.response.header.Content-Type']
1703.       ).to.equal('text/html');
1704.     });
1705.   });
1706. 
1707.   it('should add multiple response templates for a custom response codes', () => {
1708.     awsCompileApigEvents.validated.events = [
1709.       {
1710.         functionName: 'First',
1711.         http: {
1712.           method: 'GET',
1713.           path: 'users/list',
1714.           integration: 'AWS',
1715.           response: {
1716.             statusCodes: {
1717.               200: {
1718.                 template: "$input.path('$.foo')",
1719.                 headers: {
1720.                   'Content-Type': 'text/csv',
1721.                 },
1722.               },
1723.               404: {
1724.                 pattern: '.*"statusCode":404,.*',
1725.                 template: {
1726.                   'application/json': "$input.path('$.errorMessage')",
1727.                   'application/xml': "$input.path('$.xml.errorMessage')",
1728.                 },
1729.                 headers: {
1730.                   'Content-Type': 'text/html',
1731.                 },
1732.               },
1733.             },
1734.           },
1735.         },
1736.       },
1737.     ];
1738.     return awsCompileApigEvents.compileMethods().then(() => {
1739.       expect(
1740.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1741.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1742.           .ResponseTemplates['application/json']
1743.       ).to.equal("$input.path('$.foo')");
1744.       expect(
1745.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1746.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1747.           .SelectionPattern
1748.       ).to.equal('');
1749.       expect(
1750.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1751.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1752.           .ResponseParameters['method.response.header.Content-Type']
1753.       ).to.equal('text/csv');
1754.       expect(
1755.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1756.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1757.           .ResponseTemplates['application/json']
1758.       ).to.equal("$input.path('$.errorMessage')");
1759.       expect(
1760.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1761.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1762.           .ResponseTemplates['application/xml']
1763.       ).to.equal("$input.path('$.xml.errorMessage')");
1764.       expect(
1765.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1766.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1767.           .SelectionPattern
1768.       ).to.equal('.*"statusCode":404,.*');
1769.       expect(
1770.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1771.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1772.           .ResponseParameters['method.response.header.Content-Type']
1773.       ).to.equal('text/html');
1774.     });
1775.   });
1776. 
1777.   it('should use defined content-handling behavior', () => {
1778.     awsCompileApigEvents.validated.events = [
1779.       {
1780.         functionName: 'First',
1781.         http: {
1782.           method: 'get',
1783.           path: 'users/list',
1784.           integration: 'AWS',
1785.           response: {
1786.             contentHandling: 'CONVERT_TO_BINARY',
1787.             statusCodes: {
1788.               200: {
1789.                 pattern: '',
1790.               },
1791.             },
1792.           },
1793.         },
1794.       },
1795.     ];
1796.     return awsCompileApigEvents.compileMethods().then(() => {
1797.       expect(
1798.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1799.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1800.           .ContentHandling
1801.       ).to.equal('CONVERT_TO_BINARY');
1802.     });
1803.   });
1804. 
1805.   it('should handle root resource methods', () => {
1806.     awsCompileApigEvents.validated.events = [
1807.       {
1808.         functionName: 'First',
1809.         http: {
1810.           path: '',
1811.           method: 'GET',
1812.         },
1813.       },
1814.     ];
1815.     return awsCompileApigEvents.compileMethods().then(() => {
1816.       expect(
1817.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1818.           .ApiGatewayMethodGet.Properties.ResourceId
1819.       ).to.deep.equal({
1820.         'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
1821.       });
1822.     });
1823.   });
1824. 
1825.   it('should include operation id as OperationName when it is set', () => {
1826.     awsCompileApigEvents.validated.events = [
1827.       {
1828.         functionName: 'First',
1829.         http: {
1830.           path: 'users/create',
1831.           method: 'post',
1832.           integration: 'AWS',
1833.           operationId: 'createUser',
1834.         },
1835.       },
1836.     ];
1837.     return awsCompileApigEvents.compileMethods().then(() => {
1838.       expect(
1839.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1840.           .ApiGatewayMethodUsersCreatePost.Properties.OperationName
1841.       ).to.equal('createUser');
1842.     });
1843.   });
1844. 
1845.   it('should not include operation id when it is not set', () => {
1846.     awsCompileApigEvents.validated.events = [
1847.       {
1848.         functionName: 'First',
1849.         http: {
1850.           path: 'users/create',
1851.           method: 'post',
1852.           integration: 'AWS',
1853.         },
1854.       },
1855.     ];
1856.     return awsCompileApigEvents.compileMethods().then(() => {
1857.       expect(
1858.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1859.           .ApiGatewayMethodUsersCreatePost.Properties
1860.       ).to.not.have.key('OperationName');
1861.     });
1862.   });
1863. });

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 20:04:16,086 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning="Query requirement analysis: The user requests full contents with line numbers of all test.js files under lib/plugins/aws/package/compile/events/apiGateway. index.test.js is one of those files and is explicitly required by the extra requirements. Extended relevance: This test initializes AwsCompileApigEvents and verifies hooks and ordering, providing essential context for the module's tests hierarchy, though not focused on request templates, it satisfies the minimum inclusion.", relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.test.js', start_line=1, end_line=179), ContextOutput(reasoning="Query requirement analysis: The user specifically mentions tests that cover method integration and request mapping templates. lib/method/index.test.js contains extensive test cases for method integrations (AWS, AWS_PROXY, HTTP, HTTP_PROXY, MOCK) and numerous assertions about RequestTemplates and related request configuration. Extended relevance: It provides critical information for extracting cases that assert generated request mapping templates and integration configuration, matching the user's purpose.", relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js', start_line=1, end_line=1863)]
2025-11-13 20:04:16,093 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 2 contexts to memory for query: Please provide the full contents with line numbers of all *test.js files under lib/plugins/aws/package/compile/events/apiGateway (recursively), especially any that cover method integration or request mapping templates.
2025-11-13 20:04:18,685 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 20:04:18,687 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 2 new contexts to 3 existing contexts
2025-11-13 20:04:18,687 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 5 total contexts (removed 0 duplicates)
2025-11-13 20:04:18,689 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
We are currently solving the following issue within our repository. Here is the issue text:

--- BEGIN ISSUE ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:

--- END ISSUE ---

And we need to find relevant existing tests that can be used as regression tests for this issue.

OBJECTIVE: Find 8 relevant existing test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
including ALL necessary imports, test setup, mocking, assertions, and any test method used in the test case.

<reasoning>
1. Analyze bug characteristics:
   - Core functionality being tested
   - Input parameters and configurations
   - Expected error conditions
   - Environmental dependencies

2. Search requirements:
   - Required imports and dependencies
   - Test files exercising similar functionality
   - Mock/fixture setup patterns
   - Assertion styles
   - Error handling tests

3. Focus areas:
   - All necessary imports (standard library, testing frameworks, mocking utilities)
   - Dependencies and third-party packages
   - Test setup and teardown
   - Mock object configuration
   - Network/external service simulation
   - Error condition verification
</reasoning>

REQUIREMENTS:
- Return 8 complete, self-contained test cases that most likely to break existing functionality if this issue is fixed or new changes apply.
- Must include the identification of the test case (e.g., class name and method name)
- Must preserve exact file paths and line numbers

<examples>
--- BEGIN ISSUE ---
Title: parse_iso8601 drops timezone information for 'Z' suffix
Body: The helper `parse_iso8601` in `utils/datetime.py` incorrectly returns a naive datetime when the input ends with 'Z' (UTC). For example, "2024-10-12T09:15:00Z" becomes a naive dt instead of timezone-aware UTC. This breaks downstream scheduling.
Expected: Return timezone-aware datetime in UTC for 'Z' inputs and preserve offsets like "+09:00".
--- END ISSUE ---
--- BEGIN TEST CASES ---
File: tests/test_datetime.py
Line Number: 118-156
Content:
import datetime
import pytest

from utils.datetime import parse_iso8601  # target under test

def test_z_suffix_returns_utc_aware(self):
    # Input ending with 'Z' should be interpreted as UTC and be timezone-aware
    s = "2024-10-12T09:15:00Z"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    # Use UTC comparison that works across pytz/zoneinfo
    assert dt.utcoffset() == datetime.timedelta(0)

def test_offset_preserved(self):
    # Offset like +09:00 should be preserved (e.g., Asia/Tokyo offset)
    s = "2024-10-12T18:00:00+09:00"
    dt = parse_iso8601(s)

    assert isinstance(dt, datetime.datetime)
    assert dt.tzinfo is not None
    assert dt.utcoffset() == datetime.timedelta(hours=9)
--- END TEST CASES ---
</example>

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the full content with line numbers of test/integration-all/api-gateway/tests.js, test/utils/api-gateway/index.js, and test/integration-all/shared/utils.js.
Extra Requirements: If these files do not contain at least 8 relevant test cases, please also include any unit tests under lib/plugins/aws/package/compile/events/apiGateway (e.g., *test.js files) that cover method integration or request mapping templates.
Purpose: I need these test contents to extract 8 relevant cases with their exact line numbers and include all required imports and setup.

Previous refined query 2:
Essential Query: Please provide the full contents with line numbers of all *test.js files under lib/plugins/aws/package/compile/events/apiGateway (recursively), especially any that cover method integration or request mapping templates.
Extra Requirements: If listing all is too large, include at minimum: index.test.js for this module and any tests that reference method/integration.js.
Purpose: I need these test files to extract 8 relevant cases that assert generated request mapping templates and would serve as regression tests for changing default templates.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: lib/plugins/aws/package/compile/events/apiGateway/index.test.js
Line number range: 1 - 179
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const sinon = require('sinon');
5. const AwsProvider = require('../../../../provider/awsProvider');
6. const AwsCompileApigEvents = require('./index');
7. const Serverless = require('../../../../../../Serverless');
8. const validate = require('../../../../lib/validate');
9. const getServiceState = require('../../../../lib/getServiceState');
10. const updateStage = require('./lib/hack/updateStage');
11. const disassociateUsagePlan = require('./lib/hack/disassociateUsagePlan');
12. 
13. describe('AwsCompileApigEvents', () => {
14.   let awsCompileApigEvents;
15. 
16.   beforeEach(() => {
17.     const serverless = new Serverless();
18.     serverless.service.environment = {
19.       vars: {},
20.       stages: {
21.         dev: {
22.           vars: {},
23.           regions: {
24.             'us-east-1': {
25.               vars: {},
26.             },
27.           },
28.         },
29.       },
30.     };
31.     const options = {
32.       stage: 'dev',
33.       region: 'us-east-1',
34.     };
35.     serverless.setProvider('aws', new AwsProvider(serverless, options));
36.     awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
37.   });
38. 
39.   describe('#constructor()', () => {
40.     let compileRestApiStub;
41.     let compileResourcesStub;
42.     let compileMethodsStub;
43.     let compileDeploymentStub;
44.     let compileUsagePlanStub;
45.     let compilePermissionsStub;
46.     let compileStageStub;
47.     let updateStageStub;
48.     let disassociateUsagePlanStub;
49. 
50.     beforeEach(() => {
51.       compileRestApiStub = sinon.stub(awsCompileApigEvents, 'compileRestApi').resolves();
52.       compileResourcesStub = sinon.stub(awsCompileApigEvents, 'compileResources').resolves();
53.       compileMethodsStub = sinon.stub(awsCompileApigEvents, 'compileMethods').resolves();
54.       compileDeploymentStub = sinon.stub(awsCompileApigEvents, 'compileDeployment').resolves();
55.       compileUsagePlanStub = sinon.stub(awsCompileApigEvents, 'compileUsagePlan').resolves();
56.       compilePermissionsStub = sinon.stub(awsCompileApigEvents, 'compilePermissions').resolves();
57.       compileStageStub = sinon.stub(awsCompileApigEvents, 'compileStage').resolves();
58.       updateStageStub = sinon.stub(updateStage, 'updateStage').resolves();
59.       disassociateUsagePlanStub = sinon
60.         .stub(disassociateUsagePlan, 'disassociateUsagePlan')
61.         .resolves();
62.     });
63. 
64.     afterEach(() => {
65.       awsCompileApigEvents.compileRestApi.restore();
66.       awsCompileApigEvents.compileResources.restore();
67.       awsCompileApigEvents.compileMethods.restore();
68.       awsCompileApigEvents.compileDeployment.restore();
69.       awsCompileApigEvents.compileUsagePlan.restore();
70.       awsCompileApigEvents.compilePermissions.restore();
71.       awsCompileApigEvents.compileStage.restore();
72.       updateStage.updateStage.restore();
73.       disassociateUsagePlan.disassociateUsagePlan.restore();
74.     });
75. 
76.     it('should have hooks', () => expect(awsCompileApigEvents.hooks).to.be.not.empty);
77. 
78.     it('should set the provider variable to be an instanceof AwsProvider', () =>
79.       expect(awsCompileApigEvents.provider).to.be.instanceof(AwsProvider));
80. 
81.     it('should setup an empty array to gather the method logical ids', () =>
82.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([]));
83. 
84.     it('should run "package:compileEvents" promise chain in order', () => {
85.       const validateStub = sinon.stub(awsCompileApigEvents, 'validate').returns({
86.         events: [
87.           {
88.             functionName: 'first',
89.             http: {
90.               path: 'users',
91.               method: 'POST',
92.             },
93.           },
94.         ],
95.       });
96. 
97.       return awsCompileApigEvents.hooks['package:compileEvents']().then(() => {
98.         expect(validateStub.calledOnce).to.be.equal(true);
99.         expect(compileRestApiStub.calledAfter(validateStub)).to.be.equal(true);
100.         expect(compileResourcesStub.calledAfter(compileRestApiStub)).to.be.equal(true);
101.         expect(compileMethodsStub.calledAfter(compileResourcesStub)).to.be.equal(true);
102.         expect(compileDeploymentStub.calledAfter(compileMethodsStub)).to.be.equal(true);
103.         expect(compileUsagePlanStub.calledAfter(compileDeploymentStub)).to.be.equal(true);
104.         expect(compilePermissionsStub.calledAfter(compileUsagePlanStub)).to.be.equal(true);
105.         expect(compileStageStub.calledAfter(compilePermissionsStub)).to.be.equal(true);
106. 
107.         awsCompileApigEvents.validate.restore();
108.       });
109.     });
110. 
111.     describe('when running the "after:deploy:deploy" promise chain', () => {
112.       let getServiceStateStub;
113. 
114.       beforeEach(() => {
115.         getServiceStateStub = sinon.stub(getServiceState, 'getServiceState');
116.       });
117. 
118.       afterEach(() => {
119.         getServiceState.getServiceState.restore();
120.       });
121. 
122.       it('should run the promise chain in order', () => {
123.         getServiceStateStub.returns({
124.           service: {
125.             functions: {
126.               first: {
127.                 events: [
128.                   {
129.                     http: {
130.                       path: 'users',
131.                       method: 'POST',
132.                     },
133.                   },
134.                 ],
135.               },
136.             },
137.           },
138.         });
139. 
140.         return awsCompileApigEvents.hooks['after:deploy:deploy']().then(() => {
141.           expect(updateStageStub.calledOnce).to.equal(true);
142.         });
143.       });
144. 
145.       it('should not skip the updateStage step when no http events are found', () => {
146.         getServiceStateStub.returns({
147.           service: {
148.             functions: {
149.               first: {
150.                 events: [],
151.               },
152.             },
153.           },
154.         });
155. 
156.         return awsCompileApigEvents.hooks['after:deploy:deploy']().then(() => {
157.           expect(updateStageStub.calledOnce).to.equal(true);
158.         });
159.       });
160.     });
161. 
162.     it('should run "before:remove:remove" promise chain in order', () => {
163.       const validateStub = sinon.stub(validate, 'validate').returns();
164. 
165.       return awsCompileApigEvents.hooks['before:remove:remove']().then(() => {
166.         expect(validateStub.calledOnce).to.equal(true);
167.         expect(disassociateUsagePlanStub.calledAfter(validateStub)).to.equal(true);
168. 
169.         validate.validate.restore();
170.       });
171.     });
172. 
173.     it('should resolve if no functions are given', () => {
174.       awsCompileApigEvents.serverless.service.functions = {};
175. 
176.       return awsCompileApigEvents.hooks['package:compileEvents']();
177.     });
178.   });
179. });


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
Line number range: 1 - 1863
Content:
1. 'use strict';
2. 
3. const expect = require('chai').expect;
4. const AwsCompileApigEvents = require('../../index');
5. const Serverless = require('../../../../../../../../Serverless');
6. const AwsProvider = require('../../../../../../provider/awsProvider');
7. 
8. describe('#compileMethods()', () => {
9.   let serverless;
10.   let awsCompileApigEvents;
11. 
12.   beforeEach(() => {
13.     const options = {
14.       stage: 'dev',
15.       region: 'us-east-1',
16.     };
17.     serverless = new Serverless();
18.     serverless.setProvider('aws', new AwsProvider(serverless, options));
19.     serverless.service.service = 'first-service';
20.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
21.     serverless.service.environment = {
22.       stages: {
23.         dev: {
24.           regions: {
25.             'us-east-1': {
26.               vars: {
27.                 IamRoleLambdaExecution:
28.                   'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
29.               },
30.             },
31.           },
32.         },
33.       },
34.     };
35.     serverless.service.functions.First = {};
36.     serverless.service.functions.Second = {};
37.     serverless.service.functions.Third = {};
38.     awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
39.     awsCompileApigEvents.validated = {};
40.     awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
41.     awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
42.     awsCompileApigEvents.apiGatewayResources = {
43.       'users/create': {
44.         name: 'UsersCreate',
45.         resourceLogicalId: 'ApiGatewayResourceUsersCreate',
46.       },
47. 
48.       'users/list': {
49.         name: 'UsersList',
50.         resourceLogicalId: 'ApiGatewayResourceUsersList',
51.       },
52.       'users/update': {
53.         name: 'UsersUpdate',
54.         resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
55.       },
56.       'users/delete': {
57.         name: 'UsersDelete',
58.         resourceLogicalId: 'ApiGatewayResourceUsersDelete',
59.       },
60.     };
61.   });
62. 
63.   it('should have request validators/models defined when they are set', () => {
64.     awsCompileApigEvents.validated.events = [
65.       {
66.         functionName: 'First',
67.         http: {
68.           path: 'users/create',
69.           method: 'post',
70.           integration: 'AWS',
71.           request: { schema: { 'application/json': { foo: 'bar' } } },
72.         },
73.       },
74.     ];
75.     return awsCompileApigEvents.compileMethods().then(() => {
76.       expect(
77.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
78.           .ApiGatewayMethodUsersCreatePostValidator
79.       ).to.deep.equal({
80.         Type: 'AWS::ApiGateway::RequestValidator',
81.         Properties: {
82.           RestApiId: { Ref: 'ApiGatewayRestApi' },
83.           ValidateRequestBody: true,
84.           ValidateRequestParameters: true,
85.         },
86.       });
87.       expect(
88.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
89.           .ApiGatewayMethodUsersCreatePostApplicationJsonModel
90.       ).to.deep.equal({
91.         Type: 'AWS::ApiGateway::Model',
92.         Properties: {
93.           RestApiId: { Ref: 'ApiGatewayRestApi' },
94.           ContentType: 'application/json',
95.           Schema: { foo: 'bar' },
96.         },
97.       });
98.       expect(
99.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
100.           .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
101.       ).to.deep.equal({
102.         'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
103.       });
104.       expect(
105.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
106.           .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
107.       ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
108.     });
109.   });
110. 
111.   it('should support multiple request schemas', () => {
112.     awsCompileApigEvents.validated.events = [
113.       {
114.         functionName: 'First',
115.         http: {
116.           path: 'users/create',
117.           method: 'post',
118.           integration: 'AWS',
119.           request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
120.         },
121.       },
122.     ];
123.     return awsCompileApigEvents.compileMethods().then(() => {
124.       expect(
125.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
126.           .ApiGatewayMethodUsersCreatePostValidator
127.       ).to.deep.equal({
128.         Type: 'AWS::ApiGateway::RequestValidator',
129.         Properties: {
130.           RestApiId: { Ref: 'ApiGatewayRestApi' },
131.           ValidateRequestBody: true,
132.           ValidateRequestParameters: true,
133.         },
134.       });
135.       expect(
136.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
137.           .ApiGatewayMethodUsersCreatePostApplicationJsonModel
138.       ).to.deep.equal({
139.         Type: 'AWS::ApiGateway::Model',
140.         Properties: {
141.           RestApiId: { Ref: 'ApiGatewayRestApi' },
142.           ContentType: 'application/json',
143.           Schema: { foo: 'bar' },
144.         },
145.       });
146.       expect(
147.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
148.           .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
149.       ).to.deep.equal({
150.         'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
151.         'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
152.       });
153.       expect(
154.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
155.           .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
156.       ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
157.     });
158.   });
159. 
160.   it('should have request parameters defined when they are set', () => {
161.     awsCompileApigEvents.validated.events = [
162.       {
163.         functionName: 'First',
164.         http: {
165.           path: 'users/create',
166.           method: 'post',
167.           integration: 'AWS',
168.           request: {
169.             parameters: {
170.               'method.request.querystring.foo': true,
171.               'method.request.querystring.bar': false,
172.               'method.request.header.foo': true,
173.               'method.request.header.bar': false,
174.               'method.request.path.foo': true,
175.               'method.request.path.bar': false,
176.             },
177.           },
178.           response: {
179.             statusCodes: {
180.               200: {
181.                 pattern: '',
182.               },
183.             },
184.           },
185.         },
186.       },
187.     ];
188.     return awsCompileApigEvents.compileMethods().then(() => {
189.       expect(
190.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
191.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
192.       ).to.equal(true);
193.       expect(
194.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
195.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
196.       ).to.equal(false);
197.       expect(
198.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
199.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
200.           'method.request.querystring.foo'
201.         ]
202.       ).to.equal(true);
203.       expect(
204.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
205.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
206.           'method.request.querystring.bar'
207.         ]
208.       ).to.equal(false);
209.       expect(
210.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
211.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
212.       ).to.equal(true);
213.       expect(
214.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
215.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
216.       ).to.equal(false);
217.     });
218.   });
219. 
220.   it('should not have integration RequestParameters when no request parameters are set', () => {
221.     awsCompileApigEvents.validated.events = [
222.       {
223.         functionName: 'First',
224.         http: {
225.           path: 'users/create',
226.           method: 'post',
227.           integration: 'AWS',
228.         },
229.       },
230.     ];
231.     return awsCompileApigEvents.compileMethods().then(() => {
232.       expect(
233.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
234.           .ApiGatewayMethodUsersCreatePost.Properties.Integration
235.       ).to.not.have.key('RequestParameters');
236.     });
237.   });
238. 
239.   it('should create method resources when http events given', () => {
240.     awsCompileApigEvents.validated.events = [
241.       {
242.         functionName: 'First',
243.         http: {
244.           path: 'users/create',
245.           method: 'post',
246.         },
247.       },
248.       {
249.         functionName: 'Second',
250.         http: {
251.           method: 'get',
252.           path: 'users/list',
253.         },
254.       },
255.     ];
256.     return awsCompileApigEvents.compileMethods().then(() => {
257.       expect(
258.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
259.           .ApiGatewayMethodUsersCreatePost.Type
260.       ).to.equal('AWS::ApiGateway::Method');
261.       expect(
262.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
263.           .ApiGatewayMethodUsersListGet.Type
264.       ).to.equal('AWS::ApiGateway::Method');
265.     });
266.   });
267. 
268.   it('should support AWS integration type', () => {
269.     awsCompileApigEvents.validated.events = [
270.       {
271.         functionName: 'First',
272.         http: {
273.           path: 'users/create',
274.           method: 'post',
275.           integration: 'AWS',
276.           request: {
277.             parameters: {
278.               'method.request.querystring.foo': true,
279.               'method.request.querystring.bar': false,
280.               'method.request.path.foo': true,
281.               'method.request.path.bar': false,
282.               'method.request.header.foo': true,
283.               'method.request.header.bar': false,
284.             },
285.           },
286.         },
287.       },
288.     ];
289.     return awsCompileApigEvents.compileMethods().then(() => {
290.       expect(
291.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
292.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
293.       ).to.equal('AWS');
294.       expect(
295.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
296.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
297.       ).to.deep.equal({
298.         'integration.request.querystring.foo': 'method.request.querystring.foo',
299.         'integration.request.querystring.bar': 'method.request.querystring.bar',
300.         'integration.request.path.foo': 'method.request.path.foo',
301.         'integration.request.path.bar': 'method.request.path.bar',
302.         'integration.request.header.foo': 'method.request.header.foo',
303.         'integration.request.header.bar': 'method.request.header.bar',
304.       });
305.     });
306.   });
307. 
308.   it('should support AWS_PROXY integration type', () => {
309.     awsCompileApigEvents.validated.events = [
310.       {
311.         functionName: 'First',
312.         http: {
313.           path: 'users/create',
314.           method: 'post',
315.           integration: 'AWS_PROXY',
316.         },
317.       },
318.     ];
319.     return awsCompileApigEvents.compileMethods().then(() => {
320.       expect(
321.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
322.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
323.       ).to.equal('AWS_PROXY');
324.     });
325.   });
326. 
327.   it('should support HTTP integration type', () => {
328.     awsCompileApigEvents.validated.events = [
329.       {
330.         functionName: 'First',
331.         http: {
332.           path: 'users/create',
333.           method: 'post',
334.           integration: 'HTTP',
335.           request: {
336.             uri: 'https://example.com',
337.             parameters: {
338.               'method.request.querystring.foo': true,
339.               'method.request.querystring.bar': false,
340.               'method.request.path.foo': true,
341.               'method.request.path.bar': false,
342.               'method.request.header.foo': true,
343.               'method.request.header.bar': false,
344.             },
345.           },
346.         },
347.       },
348.     ];
349.     return awsCompileApigEvents.compileMethods().then(() => {
350.       expect(
351.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
352.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
353.       ).to.equal('HTTP');
354.       expect(
355.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
356.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
357.       ).to.equal('https://example.com');
358.       expect(
359.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
360.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
361.       ).to.equal('POST');
362.       expect(
363.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
364.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
365.       ).to.equal(undefined);
366.       expect(
367.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
368.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
369.       ).to.deep.equal({
370.         'integration.request.querystring.foo': 'method.request.querystring.foo',
371.         'integration.request.querystring.bar': 'method.request.querystring.bar',
372.         'integration.request.path.foo': 'method.request.path.foo',
373.         'integration.request.path.bar': 'method.request.path.bar',
374.         'integration.request.header.foo': 'method.request.header.foo',
375.         'integration.request.header.bar': 'method.request.header.bar',
376.       });
377.     });
378.   });
379. 
380.   it('should support HTTP integration type with custom request options', () => {
381.     awsCompileApigEvents.validated.events = [
382.       {
383.         functionName: 'First',
384.         http: {
385.           path: 'users/create',
386.           method: 'post',
387.           integration: 'HTTP',
388.           request: {
389.             uri: 'https://example.com',
390.             method: 'put',
391.           },
392.         },
393.       },
394.     ];
395.     return awsCompileApigEvents.compileMethods().then(() => {
396.       expect(
397.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
398.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
399.       ).to.equal('HTTP');
400.       expect(
401.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
402.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
403.       ).to.equal('https://example.com');
404.       expect(
405.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
406.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
407.       ).to.equal('PUT');
408.     });
409.   });
410. 
411.   it('should support HTTP_PROXY integration type', () => {
412.     awsCompileApigEvents.validated.events = [
413.       {
414.         functionName: 'First',
415.         http: {
416.           path: 'users/create',
417.           method: 'post',
418.           integration: 'HTTP_PROXY',
419.           request: {
420.             uri: 'https://example.com',
421.             method: 'patch',
422.             parameters: {
423.               'method.request.querystring.foo': true,
424.               'method.request.querystring.bar': false,
425.               'method.request.path.foo': true,
426.               'method.request.path.bar': false,
427.               'method.request.header.foo': true,
428.               'method.request.header.bar': false,
429.             },
430.           },
431.         },
432.       },
433.     ];
434.     return awsCompileApigEvents.compileMethods().then(() => {
435.       expect(
436.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
437.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
438.       ).to.equal('HTTP_PROXY');
439.       expect(
440.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
441.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
442.       ).to.equal('https://example.com');
443.       expect(
444.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
445.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
446.       ).to.equal('PATCH');
447.       expect(
448.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
449.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
450.       ).to.deep.equal({
451.         'integration.request.querystring.foo': 'method.request.querystring.foo',
452.         'integration.request.querystring.bar': 'method.request.querystring.bar',
453.         'integration.request.path.foo': 'method.request.path.foo',
454.         'integration.request.path.bar': 'method.request.path.bar',
455.         'integration.request.header.foo': 'method.request.header.foo',
456.         'integration.request.header.bar': 'method.request.header.bar',
457.       });
458.     });
459.   });
460. 
461.   it('should support MOCK integration type', () => {
462.     awsCompileApigEvents.validated.events = [
463.       {
464.         functionName: 'First',
465.         http: {
466.           path: 'users/create',
467.           method: 'post',
468.           integration: 'MOCK',
469.         },
470.       },
471.     ];
472.     return awsCompileApigEvents.compileMethods().then(() => {
473.       expect(
474.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
475.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
476.       ).to.equal('MOCK');
477.     });
478.   });
479. 
480.   it('should add request parameter when async config is used', () => {
481.     awsCompileApigEvents.validated.events = [
482.       {
483.         functionName: 'First',
484.         http: {
485.           path: 'users/create',
486.           method: 'post',
487.           async: true,
488.         },
489.       },
490.     ];
491.     return awsCompileApigEvents.compileMethods().then(() => {
492.       expect(
493.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
494.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
495.           'integration.request.header.X-Amz-Invocation-Type'
496.         ]
497.       ).to.equal("'Event'");
498.     });
499.   });
500. 
501.   it('should add request parameter when integration type is AWS_PROXY and async', () => {
502.     awsCompileApigEvents.validated.events = [
503.       {
504.         functionName: 'First',
505.         http: {
506.           path: 'users/create',
507.           method: 'post',
508.           integration: 'AWS_PROXY',
509.           async: true,
510.         },
511.       },
512.     ];
513.     return awsCompileApigEvents.compileMethods().then(() => {
514.       expect(
515.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
516.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
517.           'integration.request.header.X-Amz-Invocation-Type'
518.         ]
519.       ).to.equal("'Event'");
520.     });
521.   });
522. 
523.   it('should add request parameter mapped value when explicitly defined', () => {
524.     awsCompileApigEvents.validated.events = [
525.       {
526.         functionName: 'First',
527.         http: {
528.           path: 'users/create',
529.           method: 'post',
530.           integration: 'HTTP_PROXY',
531.           request: {
532.             uri: 'https://example.com',
533.             parameters: {
534.               'method.request.querystring.foo': {
535.                 required: true,
536.                 mappedValue: 'fooValue',
537.               },
538.               'method.request.querystring.bar': {
539.                 required: false,
540.                 mappedValue: 'barValue',
541.               },
542.               'method.request.path.foo': {
543.                 required: true,
544.                 mappedValue: 'fooValue',
545.               },
546.               'method.request.path.bar': {
547.                 required: false,
548.                 mappedValue: 'barValue',
549.               },
550.               'method.request.header.foo': {
551.                 required: true,
552.                 mappedValue: 'fooValue',
553.               },
554.               'method.request.header.bar': {
555.                 required: false,
556.                 mappedValue: 'barValue',
557.               },
558.             },
559.           },
560.         },
561.       },
562.     ];
563.     return awsCompileApigEvents.compileMethods().then(() => {
564.       expect(
565.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
566.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
567.       ).to.equal(true);
568.       expect(
569.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
570.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
571.       ).to.equal(false);
572.       expect(
573.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
574.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
575.           'method.request.querystring.foo'
576.         ]
577.       ).to.equal(true);
578.       expect(
579.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
580.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
581.           'method.request.querystring.bar'
582.         ]
583.       ).to.equal(false);
584.       expect(
585.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
586.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
587.       ).to.equal(true);
588.       expect(
589.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
590.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
591.       ).to.equal(false);
592.       expect(
593.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
594.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
595.       ).to.deep.equal({
596.         'integration.request.querystring.foo': 'fooValue',
597.         'integration.request.querystring.bar': 'barValue',
598.         'integration.request.path.foo': 'fooValue',
599.         'integration.request.path.bar': 'barValue',
600.         'integration.request.header.foo': 'fooValue',
601.         'integration.request.header.bar': 'barValue',
602.       });
603.     });
604.   });
605. 
606.   it('should set authorizer config for AWS_IAM', () => {
607.     awsCompileApigEvents.validated.events = [
608.       {
609.         functionName: 'First',
610.         http: {
611.           path: 'users/create',
612.           method: 'post',
613.           authorizer: {
614.             type: 'AWS_IAM',
615.           },
616.         },
617.       },
618.     ];
619.     return awsCompileApigEvents.compileMethods().then(() => {
620.       expect(
621.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
622.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
623.       ).to.equal('AWS_IAM');
624.     });
625.   });
626. 
627.   it('should set custom authorizer config with authorizerId', () => {
628.     awsCompileApigEvents.validated.events = [
629.       {
630.         functionName: 'First',
631.         http: {
632.           path: 'users/create',
633.           method: 'post',
634.           authorizer: {
635.             type: 'COGNITO_USER_POOLS',
636.             authorizerId: 'gy7lyj',
637.           },
638.         },
639.       },
640.     ];
641.     return awsCompileApigEvents.compileMethods().then(() => {
642.       expect(
643.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
644.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
645.       ).to.equal('COGNITO_USER_POOLS');
646.       expect(
647.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
648.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
649.       ).to.equal('gy7lyj');
650.     });
651.   });
652. 
653.   it('should set authorizer config if given as ARN string', () => {
654.     awsCompileApigEvents.validated.events = [
655.       {
656.         functionName: 'First',
657.         http: {
658.           authorizer: {
659.             name: 'Authorizer',
660.           },
661.           integration: 'AWS',
662.           path: 'users/create',
663.           method: 'post',
664.         },
665.       },
666.     ];
667.     return awsCompileApigEvents.compileMethods().then(() => {
668.       expect(
669.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
670.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
671.       ).to.equal('CUSTOM');
672. 
673.       expect(
674.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
675.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
676.       ).to.equal('AuthorizerApiGatewayAuthorizer');
677.     });
678.   });
679. 
680.   it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
681.     awsCompileApigEvents.validated.events = [
682.       {
683.         functionName: 'First',
684.         http: {
685.           authorizer: {
686.             name: 'authorizer',
687.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
688.             scopes: ['myapp/read', 'myapp/write'],
689.           },
690.           integration: 'AWS',
691.           path: 'users/create',
692.           method: 'post',
693.         },
694.       },
695.     ];
696. 
697.     return awsCompileApigEvents.compileMethods().then(() => {
698.       expect(
699.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
700.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
701.       ).to.equal('COGNITO_USER_POOLS');
702. 
703.       expect(
704.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
705.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
706.       ).to.contain('myapp/read');
707. 
708.       expect(
709.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
710.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
711.       ).to.equal('AuthorizerApiGatewayAuthorizer');
712. 
713.       expect(
714.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
715.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
716.           'application/json'
717.         ]
718.       ).to.not.match(/undefined/);
719.     });
720.   });
721. 
722.   it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
723.     awsCompileApigEvents.validated.events = [
724.       {
725.         functionName: 'First',
726.         http: {
727.           authorizer: {
728.             name: 'authorizer',
729.             type: 'COGNITO_USER_POOLS',
730.             authorizerId: { Ref: 'CognitoAuthorizer' },
731.             scopes: ['myapp/read', 'myapp/write'],
732.           },
733.           integration: 'AWS',
734.           path: 'users/create',
735.           method: 'post',
736.         },
737.       },
738.     ];
739. 
740.     return awsCompileApigEvents.compileMethods().then(() => {
741.       expect(
742.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
743.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
744.       ).to.equal('COGNITO_USER_POOLS');
745. 
746.       expect(
747.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
748.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
749.       ).to.contain('myapp/read');
750. 
751.       expect(
752.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
753.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
754.       ).to.equal('CognitoAuthorizer');
755. 
756.       expect(
757.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
758.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
759.           'application/json'
760.         ]
761.       ).to.not.match(/undefined/);
762.     });
763.   });
764. 
765.   it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
766.     awsCompileApigEvents.validated.events = [
767.       {
768.         functionName: 'First',
769.         http: {
770.           authorizer: {
771.             name: 'authorizer',
772.             type: 'COGNITO_USER_POOLS',
773.             arn: {
774.               'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
775.             },
776.             scopes: ['myapp/read', 'myapp/write'],
777.           },
778.           integration: 'AWS',
779.           path: 'users/create',
780.           method: 'post',
781.         },
782.       },
783.     ];
784. 
785.     return awsCompileApigEvents.compileMethods().then(() => {
786.       expect(
787.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
788.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
789.       ).to.equal('COGNITO_USER_POOLS');
790. 
791.       expect(
792.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
793.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
794.       ).to.contain('myapp/read');
795. 
796.       expect(
797.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
798.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
799.       ).to.equal('AuthorizerApiGatewayAuthorizer');
800. 
801.       expect(
802.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
803.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
804.           'application/json'
805.         ]
806.       ).to.not.match(/undefined/);
807.     });
808.   });
809. 
810.   it('should not scopes for a cognito user pool when given empty scopes array', () => {
811.     awsCompileApigEvents.validated.events = [
812.       {
813.         functionName: 'First',
814.         http: {
815.           authorizer: {
816.             name: 'authorizer',
817.             type: 'COGNITO_USER_POOLS',
818.             authorizerId: { Ref: 'CognitoAuthorizer' },
819.             scopes: [],
820.           },
821.           integration: 'AWS',
822.           path: 'users/create',
823.           method: 'post',
824.         },
825.       },
826.     ];
827. 
828.     return awsCompileApigEvents.compileMethods().then(() => {
829.       expect(
830.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
831.           .ApiGatewayMethodUsersCreatePost.Properties
832.       ).to.not.have.property('AuthorizationScopes');
833.     });
834.   });
835. 
836.   it('should set claims for a cognito user pool', () => {
837.     awsCompileApigEvents.validated.events = [
838.       {
839.         functionName: 'First',
840.         http: {
841.           authorizer: {
842.             name: 'authorizer',
843.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
844.             claims: ['email'],
845.           },
846.           integration: 'AWS',
847.           path: 'users/create',
848.           method: 'post',
849.         },
850.       },
851.     ];
852. 
853.     return awsCompileApigEvents.compileMethods().then(() => {
854.       const jsonRequestTemplatesString =
855.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
856.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
857.           'application/json'
858.         ];
859.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
860.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
861.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
862.       expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
863.     });
864.   });
865. 
866.   it('should set multiple claims for a cognito user pool', () => {
867.     awsCompileApigEvents.validated.events = [
868.       {
869.         functionName: 'First',
870.         http: {
871.           authorizer: {
872.             name: 'authorizer',
873.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
874.             claims: ['email', 'gender'],
875.           },
876.           integration: 'AWS',
877.           path: 'users/create',
878.           method: 'post',
879.         },
880.       },
881.     ];
882. 
883.     return awsCompileApigEvents.compileMethods().then(() => {
884.       const jsonRequestTemplatesString =
885.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
886.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
887.           'application/json'
888.         ];
889.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
890.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
891.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
892.       expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
893.       expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
894.     });
895.   });
896. 
897.   it('should properly set claims for custom properties inside the cognito user pool', () => {
898.     awsCompileApigEvents.validated.events = [
899.       {
900.         functionName: 'First',
901.         http: {
902.           authorizer: {
903.             name: 'authorizer',
904.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
905.             claims: ['email', 'custom:score'],
906.           },
907.           integration: 'AWS',
908.           path: 'users/create',
909.           method: 'post',
910.         },
911.       },
912.     ];
913. 
914.     return awsCompileApigEvents.compileMethods().then(() => {
915.       const jsonRequestTemplatesString =
916.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
917.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
918.           'application/json'
919.         ];
920.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
921.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
922.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
923.       expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
924.       expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
925.     });
926.   });
927. 
928.   it('should replace the extra claims in the template if there are none', () => {
929.     awsCompileApigEvents.validated.events = [
930.       {
931.         functionName: 'First',
932.         http: {
933.           authorizer: {
934.             name: 'authorizer',
935.             arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
936.           },
937.           integration: 'AWS',
938.           path: 'users/create',
939.           method: 'post',
940.         },
941.       },
942.     ];
943. 
944.     return awsCompileApigEvents.compileMethods().then(() => {
945.       expect(
946.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
947.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
948.           'application/json'
949.         ]
950.       ).to.not.match(/extraCognitoPoolClaims/);
951.     });
952.   });
953. 
954.   it('should not create method resources when http events are not given', () => {
955.     awsCompileApigEvents.validated.events = [];
956. 
957.     return awsCompileApigEvents.compileMethods().then(() => {
958.       expect(
959.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
960.       ).to.deep.equal({});
961.     });
962.   });
963. 
964.   it('should update the method logical ids array', () => {
965.     awsCompileApigEvents.validated.events = [
966.       {
967.         functionName: 'First',
968.         http: {
969.           path: 'users/create',
970.           method: 'post',
971.         },
972.       },
973.       {
974.         functionName: 'Second',
975.         http: {
976.           method: 'get',
977.           path: 'users/list',
978.         },
979.       },
980.     ];
981.     return awsCompileApigEvents.compileMethods().then(() => {
982.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
983.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
984.         'ApiGatewayMethodUsersCreatePost',
985.         'ApiGatewayMethodUsersListGet',
986.       ]);
987.     });
988.   });
989. 
990.   it('should set api key as required if private endpoint', () => {
991.     awsCompileApigEvents.validated.events = [
992.       {
993.         functionName: 'First',
994.         http: {
995.           path: 'users/create',
996.           method: 'post',
997.           private: true,
998.         },
999.       },
1000.     ];
1001.     return awsCompileApigEvents.compileMethods().then(() => {
1002.       expect(
1003.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1004.           .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
1005.       ).to.equal(true);
1006.     });
1007.   });
1008. 
1009.   it('should set api key as not required if private property is not specified', () => {
1010.     awsCompileApigEvents.validated.events = [
1011.       {
1012.         functionName: 'First',
1013.         http: {
1014.           path: 'users/create',
1015.           method: 'post',
1016.         },
1017.       },
1018.     ];
1019.     return awsCompileApigEvents.compileMethods().then(() => {
1020.       expect(
1021.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1022.           .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
1023.       ).to.equal(false);
1024.     });
1025.   });
1026. 
1027.   it('should set the correct lambdaUri', () => {
1028.     awsCompileApigEvents.validated.events = [
1029.       {
1030.         functionName: 'First',
1031.         http: {
1032.           path: 'users/create',
1033.           method: 'post',
1034.         },
1035.       },
1036.       {
1037.         functionName: 'Second',
1038.         http: {
1039.           method: 'get',
1040.           path: 'users/list',
1041.         },
1042.       },
1043.     ];
1044.     return awsCompileApigEvents.compileMethods().then(() => {
1045.       expect(
1046.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1047.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
1048.       ).to.deep.equal({
1049.         'Fn::Join': [
1050.           '',
1051.           [
1052.             'arn:',
1053.             { Ref: 'AWS::Partition' },
1054.             ':apigateway:',
1055.             { Ref: 'AWS::Region' },
1056.             ':lambda:path/2015-03-31/functions/',
1057.             { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
1058.             '/invocations',
1059.           ],
1060.         ],
1061.       });
1062.       expect(
1063.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1064.           .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
1065.       ).to.deep.equal({
1066.         'Fn::Join': [
1067.           '',
1068.           [
1069.             'arn:',
1070.             { Ref: 'AWS::Partition' },
1071.             ':apigateway:',
1072.             { Ref: 'AWS::Region' },
1073.             ':lambda:path/2015-03-31/functions/',
1074.             { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
1075.             '/invocations',
1076.           ],
1077.         ],
1078.       });
1079.     });
1080.   });
1081. 
1082.   it('Should point target alias if set', () => {
1083.     awsCompileApigEvents.validated.events = [
1084.       {
1085.         functionName: 'Provisioned',
1086.         http: {
1087.           method: 'get',
1088.           path: 'users/list',
1089.         },
1090.       },
1091.     ];
1092.     serverless.service.functions.Provisioned = {
1093.       targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
1094.     };
1095.     return awsCompileApigEvents.compileMethods().then(() => {
1096.       expect(
1097.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1098.           .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
1099.       ).to.deep.equal({
1100.         'Fn::Join': [
1101.           '',
1102.           [
1103.             'arn:',
1104.             { Ref: 'AWS::Partition' },
1105.             ':apigateway:',
1106.             { Ref: 'AWS::Region' },
1107.             ':lambda:path/2015-03-31/functions/',
1108.             { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
1109.             ':',
1110.             'provisioned',
1111.             '/invocations',
1112.           ],
1113.         ],
1114.       });
1115.     });
1116.   });
1117. 
1118.   it('should add CORS origins to method only when CORS is enabled', () => {
1119.     awsCompileApigEvents.validated.events = [
1120.       {
1121.         functionName: 'First',
1122.         http: {
1123.           path: 'users/create',
1124.           method: 'post',
1125.           integration: 'AWS',
1126.           cors: {
1127.             origin: 'http://example.com',
1128.           },
1129.           response: {
1130.             statusCodes: {
1131.               200: {
1132.                 pattern: '',
1133.               },
1134.             },
1135.           },
1136.         },
1137.       },
1138.       {
1139.         functionName: 'Second',
1140.         http: {
1141.           method: 'get',
1142.           path: 'users/list',
1143.           integration: 'AWS',
1144.           response: {
1145.             statusCodes: {
1146.               200: {
1147.                 pattern: '',
1148.               },
1149.             },
1150.           },
1151.         },
1152.       },
1153.       {
1154.         functionName: 'Third',
1155.         http: {
1156.           path: 'users/update',
1157.           method: 'PUT',
1158.           integration: 'AWS',
1159.           response: {
1160.             statusCodes: {
1161.               200: {
1162.                 pattern: '',
1163.               },
1164.             },
1165.           },
1166.           cors: {
1167.             origins: ['*'],
1168.           },
1169.         },
1170.       },
1171.     ];
1172.     return awsCompileApigEvents.compileMethods().then(() => {
1173.       expect(
1174.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1175.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
1176.           .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
1177.       ).to.equal("'http://example.com'");
1178. 
1179.       // CORS not enabled!
1180.       expect(
1181.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1182.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1183.           .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
1184.       ).to.not.equal("'*'");
1185. 
1186.       expect(
1187.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1188.           .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
1189.           .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
1190.       ).to.equal("'*'");
1191.     });
1192.   });
1193. 
1194.   it('should set CORS allowCredentials to method only when specified', () => {
1195.     awsCompileApigEvents.validated.events = [
1196.       {
1197.         functionName: 'First',
1198.         http: {
1199.           path: 'users/create',
1200.           method: 'post',
1201.           integration: 'AWS',
1202.           cors: {
1203.             origin: 'http://example.com',
1204.             allowCredentials: true,
1205.           },
1206.           response: {
1207.             statusCodes: {
1208.               200: {
1209.                 pattern: '',
1210.               },
1211.             },
1212.           },
1213.         },
1214.       },
1215.       {
1216.         functionName: 'Second',
1217.         http: {
1218.           method: 'get',
1219.           path: 'users/list',
1220.           integration: 'AWS',
1221.           cors: {
1222.             origin: 'http://example.com',
1223.           },
1224.           response: {
1225.             statusCodes: {
1226.               200: {
1227.                 pattern: '',
1228.               },
1229.             },
1230.           },
1231.         },
1232.       },
1233.     ];
1234.     return awsCompileApigEvents.compileMethods().then(() => {
1235.       expect(
1236.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1237.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
1238.           .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
1239.       ).to.equal('true');
1240. 
1241.       // allowCredentials not enabled
1242.       expect(
1243.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1244.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1245.           .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
1246.       ).to.not.equal('true');
1247.     });
1248.   });
1249. 
1250.   describe('when dealing with request configuration', () => {
1251.     it('should setup a default "application/json" template', () => {
1252.       awsCompileApigEvents.validated.events = [
1253.         {
1254.           functionName: 'Second',
1255.           http: {
1256.             method: 'get',
1257.             path: 'users/list',
1258.             integration: 'AWS',
1259.             response: {
1260.               statusCodes: {
1261.                 200: {
1262.                   pattern: '',
1263.                 },
1264.               },
1265.             },
1266.           },
1267.         },
1268.       ];
1269.       return awsCompileApigEvents.compileMethods().then(() => {
1270.         expect(
1271.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1272.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
1273.             'application/json'
1274.           ]
1275.         ).to.have.length.above(0);
1276.       });
1277.     });
1278. 
1279.     it('should setup a default "application/x-www-form-urlencoded" template', () => {
1280.       awsCompileApigEvents.validated.events = [
1281.         {
1282.           functionName: 'Second',
1283.           http: {
1284.             method: 'get',
1285.             path: 'users/list',
1286.             integration: 'AWS',
1287.             response: {
1288.               statusCodes: {
1289.                 200: {
1290.                   pattern: '',
1291.                 },
1292.               },
1293.             },
1294.           },
1295.         },
1296.       ];
1297.       return awsCompileApigEvents.compileMethods().then(() => {
1298.         expect(
1299.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1300.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
1301.             'application/x-www-form-urlencoded'
1302.           ]
1303.         ).to.have.length.above(0);
1304.       });
1305.     });
1306. 
1307.     it('should use defined pass-through behavior', () => {
1308.       awsCompileApigEvents.validated.events = [
1309.         {
1310.           functionName: 'First',
1311.           http: {
1312.             method: 'GET',
1313.             path: 'users/list',
1314.             integration: 'AWS',
1315.             request: {
1316.               passThrough: 'WHEN_NO_TEMPLATES',
1317.             },
1318.             response: {
1319.               statusCodes: {
1320.                 200: {
1321.                   pattern: '',
1322.                 },
1323.               },
1324.             },
1325.           },
1326.         },
1327.       ];
1328.       return awsCompileApigEvents.compileMethods().then(() => {
1329.         expect(
1330.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1331.             .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
1332.         ).to.equal('WHEN_NO_TEMPLATES');
1333.       });
1334.     });
1335. 
1336.     it('should use defined content-handling behavior (request)', () => {
1337.       awsCompileApigEvents.validated.events = [
1338.         {
1339.           functionName: 'First',
1340.           http: {
1341.             method: 'GET',
1342.             path: 'users/list',
1343.             integration: 'AWS',
1344.             request: {
1345.               contentHandling: 'CONVERT_TO_TEXT',
1346.             },
1347.             response: {
1348.               statusCodes: {
1349.                 200: {
1350.                   pattern: '',
1351.                 },
1352.               },
1353.             },
1354.           },
1355.         },
1356.       ];
1357.       return awsCompileApigEvents.compileMethods().then(() => {
1358.         expect(
1359.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1360.             .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
1361.         ).to.equal('CONVERT_TO_TEXT');
1362.       });
1363.     });
1364. 
1365.     it('should use defined response content-handling behavior for 2XX only (response)', () => {
1366.       awsCompileApigEvents.validated.events = [
1367.         {
1368.           functionName: 'First',
1369.           http: {
1370.             method: 'GET',
1371.             path: 'users/list',
1372.             integration: 'AWS',
1373.             response: {
1374.               contentHandling: 'CONVERT_TO_BINARY',
1375.               statusCodes: {
1376.                 200: {
1377.                   pattern: '',
1378.                 },
1379.                 400: {
1380.                   pattern: '400',
1381.                 },
1382.               },
1383.             },
1384.           },
1385.         },
1386.       ];
1387.       return awsCompileApigEvents.compileMethods().then(() => {
1388.         expect(
1389.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1390.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1391.             .ContentHandling
1392.         ).to.equal('CONVERT_TO_BINARY');
1393.         expect(
1394.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1395.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1396.             .ContentHandling
1397.         ).to.equal(undefined);
1398.       });
1399.     });
1400. 
1401.     it('should set custom request templates', () => {
1402.       awsCompileApigEvents.validated.events = [
1403.         {
1404.           functionName: 'First',
1405.           http: {
1406.             method: 'GET',
1407.             path: 'users/list',
1408.             integration: 'AWS',
1409.             request: {
1410.               template: {
1411.                 'template/1': '{ "stage" : "$context.stage" }',
1412.                 'template/2': '{ "httpMethod" : "$context.httpMethod" }',
1413.               },
1414.             },
1415.             response: {
1416.               statusCodes: {
1417.                 200: {
1418.                   pattern: '',
1419.                 },
1420.               },
1421.             },
1422.           },
1423.         },
1424.       ];
1425.       return awsCompileApigEvents.compileMethods().then(() => {
1426.         expect(
1427.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1428.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
1429.         ).to.equal('{ "stage" : "$context.stage" }');
1430. 
1431.         expect(
1432.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1433.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
1434.         ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
1435.       });
1436.     });
1437. 
1438.     it('should be possible to overwrite default request templates', () => {
1439.       awsCompileApigEvents.validated.events = [
1440.         {
1441.           functionName: 'First',
1442.           http: {
1443.             method: 'GET',
1444.             path: 'users/list',
1445.             integration: 'AWS',
1446.             request: {
1447.               template: {
1448.                 'application/json': 'overwritten-request-template-content',
1449.               },
1450.             },
1451.             response: {
1452.               statusCodes: {
1453.                 200: {
1454.                   pattern: '',
1455.                 },
1456.               },
1457.             },
1458.           },
1459.         },
1460.       ];
1461.       return awsCompileApigEvents.compileMethods().then(() => {
1462.         expect(
1463.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1464.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
1465.             'application/json'
1466.           ]
1467.         ).to.equal('overwritten-request-template-content');
1468.       });
1469.     });
1470.   });
1471. 
1472.   describe('when dealing with response configuration', () => {
1473.     it('should set the custom headers', () => {
1474.       awsCompileApigEvents.validated.events = [
1475.         {
1476.           functionName: 'First',
1477.           http: {
1478.             method: 'GET',
1479.             path: 'users/list',
1480.             integration: 'AWS',
1481.             response: {
1482.               statusCodes: {
1483.                 200: {
1484.                   pattern: '',
1485.                   headers: {
1486.                     'Content-Type': "'text/plain'",
1487.                     'My-Custom-Header': 'my/custom/header',
1488.                   },
1489.                 },
1490.               },
1491.             },
1492.           },
1493.         },
1494.       ];
1495.       return awsCompileApigEvents.compileMethods().then(() => {
1496.         expect(
1497.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1498.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1499.             .ResponseParameters['method.response.header.Content-Type']
1500.         ).to.equal("'text/plain'");
1501.         expect(
1502.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1503.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1504.             .ResponseParameters['method.response.header.My-Custom-Header']
1505.         ).to.equal('my/custom/header');
1506.       });
1507.     });
1508. 
1509.     it('should set the custom template', () => {
1510.       awsCompileApigEvents.validated.events = [
1511.         {
1512.           functionName: 'First',
1513.           http: {
1514.             method: 'GET',
1515.             path: 'users/list',
1516.             integration: 'AWS',
1517.             response: {
1518.               statusCodes: {
1519.                 200: {
1520.                   template: "$input.path('$.foo')",
1521.                   pattern: '',
1522.                 },
1523.               },
1524.             },
1525.           },
1526.         },
1527.       ];
1528.       return awsCompileApigEvents.compileMethods().then(() => {
1529.         expect(
1530.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1531.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1532.             .ResponseTemplates['application/json']
1533.         ).to.equal("$input.path('$.foo')");
1534.       });
1535.     });
1536.   });
1537. 
1538.   it('should add method responses for different status codes', () => {
1539.     awsCompileApigEvents.validated.events = [
1540.       {
1541.         functionName: 'First',
1542.         http: {
1543.           method: 'get',
1544.           path: 'users/list',
1545.           integration: 'AWS',
1546.           response: {
1547.             statusCodes: {
1548.               200: {
1549.                 pattern: '',
1550.               },
1551.               202: {
1552.                 pattern: 'foo',
1553.               },
1554.             },
1555.           },
1556.         },
1557.       },
1558.     ];
1559.     return awsCompileApigEvents.compileMethods().then(() => {
1560.       expect(
1561.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1562.           .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
1563.       ).to.equal('200');
1564.       expect(
1565.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1566.           .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
1567.       ).to.equal('202');
1568.     });
1569.   });
1570. 
1571.   it('should add integration responses for different status codes', () => {
1572.     awsCompileApigEvents.validated.events = [
1573.       {
1574.         functionName: 'First',
1575.         http: {
1576.           method: 'get',
1577.           path: 'users/list',
1578.           integration: 'AWS',
1579.           response: {
1580.             statusCodes: {
1581.               200: {
1582.                 pattern: '',
1583.               },
1584.               202: {
1585.                 pattern: 'foo',
1586.               },
1587.             },
1588.           },
1589.         },
1590.       },
1591.     ];
1592.     return awsCompileApigEvents.compileMethods().then(() => {
1593.       expect(
1594.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1595.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1596.       ).to.deep.equal({
1597.         StatusCode: '202',
1598.         SelectionPattern: 'foo',
1599.         ResponseParameters: {},
1600.         ResponseTemplates: {},
1601.         ContentHandling: undefined,
1602.       });
1603.       expect(
1604.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1605.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1606.       ).to.deep.equal({
1607.         StatusCode: '200',
1608.         SelectionPattern: '',
1609.         ResponseParameters: {},
1610.         ResponseTemplates: {},
1611.         ContentHandling: undefined,
1612.       });
1613.     });
1614.   });
1615. 
1616.   it('should add fall back headers and template to statusCodes', () => {
1617.     awsCompileApigEvents.validated.events = [
1618.       {
1619.         functionName: 'First',
1620.         http: {
1621.           method: 'GET',
1622.           path: 'users/list',
1623.           integration: 'AWS',
1624.           response: {
1625.             headers: {
1626.               'Content-Type': 'text/csv',
1627.             },
1628.             template: 'foo',
1629.             statusCodes: {
1630.               400: {
1631.                 pattern: '',
1632.               },
1633.             },
1634.           },
1635.         },
1636.       },
1637.     ];
1638.     return awsCompileApigEvents.compileMethods().then(() => {
1639.       expect(
1640.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1641.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1642.           .ResponseTemplates['application/json']
1643.       ).to.equal('foo');
1644.       expect(
1645.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1646.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1647.           .ResponseParameters['method.response.header.Content-Type']
1648.       ).to.equal('text/csv');
1649.     });
1650.   });
1651. 
1652.   it('should add custom response codes', () => {
1653.     awsCompileApigEvents.validated.events = [
1654.       {
1655.         functionName: 'First',
1656.         http: {
1657.           method: 'GET',
1658.           path: 'users/list',
1659.           integration: 'AWS',
1660.           response: {
1661.             statusCodes: {
1662.               200: {
1663.                 pattern: '',
1664.                 template: "$input.path('$.foo')",
1665.               },
1666.               404: {
1667.                 pattern: '.*"statusCode":404,.*',
1668.                 template: "$input.path('$.errorMessage')",
1669.                 headers: {
1670.                   'Content-Type': 'text/html',
1671.                 },
1672.               },
1673.             },
1674.           },
1675.         },
1676.       },
1677.     ];
1678.     return awsCompileApigEvents.compileMethods().then(() => {
1679.       expect(
1680.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1681.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1682.           .ResponseTemplates['application/json']
1683.       ).to.equal("$input.path('$.foo')");
1684.       expect(
1685.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1686.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1687.           .SelectionPattern
1688.       ).to.equal('');
1689.       expect(
1690.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1691.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1692.           .ResponseTemplates['application/json']
1693.       ).to.equal("$input.path('$.errorMessage')");
1694.       expect(
1695.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1696.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1697.           .SelectionPattern
1698.       ).to.equal('.*"statusCode":404,.*');
1699.       expect(
1700.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1701.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1702.           .ResponseParameters['method.response.header.Content-Type']
1703.       ).to.equal('text/html');
1704.     });
1705.   });
1706. 
1707.   it('should add multiple response templates for a custom response codes', () => {
1708.     awsCompileApigEvents.validated.events = [
1709.       {
1710.         functionName: 'First',
1711.         http: {
1712.           method: 'GET',
1713.           path: 'users/list',
1714.           integration: 'AWS',
1715.           response: {
1716.             statusCodes: {
1717.               200: {
1718.                 template: "$input.path('$.foo')",
1719.                 headers: {
1720.                   'Content-Type': 'text/csv',
1721.                 },
1722.               },
1723.               404: {
1724.                 pattern: '.*"statusCode":404,.*',
1725.                 template: {
1726.                   'application/json': "$input.path('$.errorMessage')",
1727.                   'application/xml': "$input.path('$.xml.errorMessage')",
1728.                 },
1729.                 headers: {
1730.                   'Content-Type': 'text/html',
1731.                 },
1732.               },
1733.             },
1734.           },
1735.         },
1736.       },
1737.     ];
1738.     return awsCompileApigEvents.compileMethods().then(() => {
1739.       expect(
1740.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1741.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1742.           .ResponseTemplates['application/json']
1743.       ).to.equal("$input.path('$.foo')");
1744.       expect(
1745.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1746.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1747.           .SelectionPattern
1748.       ).to.equal('');
1749.       expect(
1750.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1751.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1752.           .ResponseParameters['method.response.header.Content-Type']
1753.       ).to.equal('text/csv');
1754.       expect(
1755.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1756.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1757.           .ResponseTemplates['application/json']
1758.       ).to.equal("$input.path('$.errorMessage')");
1759.       expect(
1760.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1761.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1762.           .ResponseTemplates['application/xml']
1763.       ).to.equal("$input.path('$.xml.errorMessage')");
1764.       expect(
1765.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1766.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1767.           .SelectionPattern
1768.       ).to.equal('.*"statusCode":404,.*');
1769.       expect(
1770.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1771.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
1772.           .ResponseParameters['method.response.header.Content-Type']
1773.       ).to.equal('text/html');
1774.     });
1775.   });
1776. 
1777.   it('should use defined content-handling behavior', () => {
1778.     awsCompileApigEvents.validated.events = [
1779.       {
1780.         functionName: 'First',
1781.         http: {
1782.           method: 'get',
1783.           path: 'users/list',
1784.           integration: 'AWS',
1785.           response: {
1786.             contentHandling: 'CONVERT_TO_BINARY',
1787.             statusCodes: {
1788.               200: {
1789.                 pattern: '',
1790.               },
1791.             },
1792.           },
1793.         },
1794.       },
1795.     ];
1796.     return awsCompileApigEvents.compileMethods().then(() => {
1797.       expect(
1798.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1799.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
1800.           .ContentHandling
1801.       ).to.equal('CONVERT_TO_BINARY');
1802.     });
1803.   });
1804. 
1805.   it('should handle root resource methods', () => {
1806.     awsCompileApigEvents.validated.events = [
1807.       {
1808.         functionName: 'First',
1809.         http: {
1810.           path: '',
1811.           method: 'GET',
1812.         },
1813.       },
1814.     ];
1815.     return awsCompileApigEvents.compileMethods().then(() => {
1816.       expect(
1817.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1818.           .ApiGatewayMethodGet.Properties.ResourceId
1819.       ).to.deep.equal({
1820.         'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
1821.       });
1822.     });
1823.   });
1824. 
1825.   it('should include operation id as OperationName when it is set', () => {
1826.     awsCompileApigEvents.validated.events = [
1827.       {
1828.         functionName: 'First',
1829.         http: {
1830.           path: 'users/create',
1831.           method: 'post',
1832.           integration: 'AWS',
1833.           operationId: 'createUser',
1834.         },
1835.       },
1836.     ];
1837.     return awsCompileApigEvents.compileMethods().then(() => {
1838.       expect(
1839.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1840.           .ApiGatewayMethodUsersCreatePost.Properties.OperationName
1841.       ).to.equal('createUser');
1842.     });
1843.   });
1844. 
1845.   it('should not include operation id when it is not set', () => {
1846.     awsCompileApigEvents.validated.events = [
1847.       {
1848.         functionName: 'First',
1849.         http: {
1850.           path: 'users/create',
1851.           method: 'post',
1852.           integration: 'AWS',
1853.         },
1854.       },
1855.     ];
1856.     return awsCompileApigEvents.compileMethods().then(() => {
1857.       expect(
1858.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
1859.           .ApiGatewayMethodUsersCreatePost.Properties
1860.       ).to.not.have.key('OperationName');
1861.     });
1862.   });
1863. });


File: test/integration-all/api-gateway/tests.js
Line number range: 1 - 313
Content:
1. 'use strict';
2. 
3. const path = require('path');
4. const _ = require('lodash');
5. const { expect } = require('chai');
6. const log = require('log').get('serverless:test');
7. const awsRequest = require('@serverless/test/aws-request');
8. 
9. const { getTmpDirPath, readYamlFile, writeYamlFile } = require('../../utils/fs');
10. const { confirmCloudWatchLogs } = require('../../utils/misc');
11. const {
12.   createTestService,
13.   deployService,
14.   removeService,
15.   fetch,
16. } = require('../../utils/integration');
17. const { createRestApi, deleteRestApi, getResources } = require('../../utils/api-gateway');
18. 
19. describe('AWS - API Gateway Integration Test', function() {
20.   this.timeout(1000 * 60 * 10); // Involves time-taking deploys
21.   let serviceName;
22.   let endpoint;
23.   let stackName;
24.   let tmpDirPath;
25.   let serverlessFilePath;
26.   let restApiId;
27.   let restApiRootResourceId;
28.   let apiKey;
29.   let isDeployed = false;
30.   const stage = 'dev';
31. 
32.   const resolveEndpoint = async () => {
33.     const result = await awsRequest('CloudFormation', 'describeStacks', { StackName: stackName });
34.     const endpointOutput = result.Stacks[0].Outputs.find(
35.       output => output.OutputKey === 'ServiceEndpoint'
36.     ).OutputValue;
37.     endpoint = endpointOutput.match(/https:\/\/.+\.execute-api\..+\.amazonaws\.com.+/)[0];
38.   };
39. 
40.   before(async () => {
41.     tmpDirPath = getTmpDirPath();
42.     log.notice(`Temporary path: ${tmpDirPath}`);
43.     serverlessFilePath = path.join(tmpDirPath, 'serverless.yml');
44.     const serverlessConfig = await createTestService(tmpDirPath, {
45.       templateDir: path.join(__dirname, 'service'),
46.       serverlessConfigHook:
47.         // Ensure unique API key for each test (to avoid collision among concurrent CI runs)
48.         config => {
49.           apiKey = `${config.service}-api-key-1`;
50.           config.provider.apiKeys[0] = { name: apiKey, value: apiKey };
51.         },
52.     });
53.     serviceName = serverlessConfig.service;
54.     stackName = `${serviceName}-${stage}`;
55.     log.notice(`Deploying "${stackName}" service...`);
56.     await deployService(tmpDirPath);
57.     isDeployed = true;
58.     return resolveEndpoint();
59.   });
60. 
61.   after(async () => {
62.     if (!isDeployed) return;
63.     log.notice('Removing service...');
64.     await removeService(tmpDirPath);
65.   });
66. 
67.   describe('Minimal Setup', () => {
68.     const expectedMessage = 'Hello from API Gateway! - (minimal)';
69. 
70.     it('should expose an accessible GET HTTP endpoint', () => {
71.       const testEndpoint = `${endpoint}`;
72. 
73.       return fetch(testEndpoint, { method: 'GET' })
74.         .then(response => response.json())
75.         .then(json => expect(json.message).to.equal(expectedMessage));
76.     });
77. 
78.     it('should expose an accessible POST HTTP endpoint', () => {
79.       const testEndpoint = `${endpoint}/minimal-1`;
80. 
81.       return fetch(testEndpoint, { method: 'POST' })
82.         .then(response => response.json())
83.         .then(json => expect(json.message).to.equal(expectedMessage));
84.     });
85. 
86.     it('should expose an accessible PUT HTTP endpoint', () => {
87.       const testEndpoint = `${endpoint}/minimal-2`;
88. 
89.       return fetch(testEndpoint, { method: 'PUT' })
90.         .then(response => response.json())
91.         .then(json => expect(json.message).to.equal(expectedMessage));
92.     });
93. 
94.     it('should expose an accessible DELETE HTTP endpoint', () => {
95.       const testEndpoint = `${endpoint}/minimal-3`;
96. 
97.       return fetch(testEndpoint, { method: 'DELETE' })
98.         .then(response => response.json())
99.         .then(json => expect(json.message).to.equal(expectedMessage));
100.     });
101.   });
102. 
103.   describe('CORS', () => {
104.     it('should setup simple CORS support via cors: true config', () => {
105.       const testEndpoint = `${endpoint}/simple-cors`;
106. 
107.       return fetch(testEndpoint, { method: 'OPTIONS' }).then(response => {
108.         const headers = response.headers;
109.         const allowHeaders = [
110.           'Content-Type',
111.           'X-Amz-Date',
112.           'Authorization',
113.           'X-Api-Key',
114.           'X-Amz-Security-Token',
115.           'X-Amz-User-Agent',
116.         ].join(',');
117.         expect(headers.get('access-control-allow-headers')).to.equal(allowHeaders);
118.         expect(headers.get('access-control-allow-methods')).to.equal('OPTIONS,GET');
119.         expect(headers.get('access-control-allow-credentials')).to.equal(null);
120.         expect(headers.get('access-control-allow-origin')).to.equal('*');
121.       });
122.     });
123. 
124.     it('should setup CORS support with complex object config', () => {
125.       const testEndpoint = `${endpoint}/complex-cors`;
126. 
127.       return fetch(testEndpoint, { method: 'OPTIONS' }).then(response => {
128.         const headers = response.headers;
129.         const allowHeaders = [
130.           'Content-Type',
131.           'X-Amz-Date',
132.           'Authorization',
133.           'X-Api-Key',
134.           'X-Amz-Security-Token',
135.           'X-Amz-User-Agent',
136.         ].join(',');
137.         expect(headers.get('access-control-allow-headers')).to.equal(allowHeaders);
138.         expect(headers.get('access-control-allow-methods')).to.equal('OPTIONS,GET');
139.         expect(headers.get('access-control-allow-credentials')).to.equal('true');
140.         expect(headers.get('access-control-allow-origin')).to.equal('*');
141.       });
142.     });
143.   });
144. 
145.   describe('Custom Authorizers', () => {
146.     let testEndpoint;
147. 
148.     before(() => {
149.       testEndpoint = `${endpoint}/custom-auth`;
150.     });
151. 
152.     it('should reject requests without authorization', () => {
153.       return fetch(testEndpoint).then(response => {
154.         expect(response.status).to.equal(401);
155.       });
156.     });
157. 
158.     it('should reject requests with wrong authorization', () => {
159.       return fetch(testEndpoint, {
160.         headers: { Authorization: 'Bearer ShouldNotBeAuthorized' },
161.       }).then(response => {
162.         expect(response.status).to.equal(401);
163.       });
164.     });
165. 
166.     it('should authorize requests with correct authorization', () => {
167.       return fetch(testEndpoint, { headers: { Authorization: 'Bearer ShouldBeAuthorized' } })
168.         .then(response => response.json())
169.         .then(json => {
170.           expect(json.message).to.equal('Hello from API Gateway! - (customAuthorizers)');
171.           expect(json.event.requestContext.authorizer.principalId).to.equal('SomeRandomId');
172.           expect(json.event.headers.Authorization).to.equal('Bearer ShouldBeAuthorized');
173.         });
174.     });
175.   });
176. 
177.   describe('API Keys', () => {
178.     let testEndpoint;
179.     let startTime;
180. 
181.     before(() => {
182.       testEndpoint = `${endpoint}/api-keys`;
183.       startTime = Date.now();
184.     });
185. 
186.     it('should succeed if correct API key is given', async function self() {
187.       const response = await fetch(testEndpoint, { headers: { 'X-API-Key': apiKey } });
188.       const result = await response.json();
189.       // API Key may take a moment to propagate, retry
190.       if (response.status === 403 && startTime > Date.now() - 1000 * 60 * 3) {
191.         log.notice('API Key rejected, retry');
192.         return self();
193.       }
194.       expect(response.status).to.equal(200);
195.       expect(result.message).to.equal('Hello from API Gateway! - (apiKeys)');
196.       return null;
197.     });
198. 
199.     it('should reject a request with an invalid API Key', () => {
200.       return fetch(testEndpoint).then(response => {
201.         expect(response.status).to.equal(403);
202.       });
203.     });
204.   });
205. 
206.   describe('Using stage specific configuration', () => {
207.     before(async () => {
208.       const serverless = readYamlFile(serverlessFilePath);
209.       // enable Logs, Tags and Tracing
210.       _.merge(serverless.provider, {
211.         tags: {
212.           foo: 'bar',
213.           baz: 'qux',
214.         },
215.         tracing: {
216.           apiGateway: true,
217.         },
218.         logs: {
219.           restApi: true,
220.         },
221.       });
222.       writeYamlFile(serverlessFilePath, serverless);
223.       await deployService(tmpDirPath);
224.     });
225. 
226.     it('should update the stage without service interruptions', () => {
227.       // re-using the endpoint from the "minimal" test case
228.       const testEndpoint = `${endpoint}`;
229. 
230.       return confirmCloudWatchLogs(
231.         `/aws/api-gateway/${stackName}`,
232.         () =>
233.           fetch(`${testEndpoint}`, { method: 'GET' })
234.             .then(response => response.json())
235.             // Confirm that APIGW responds as expected
236.             .then(json => expect(json.message).to.equal('Hello from API Gateway! - (minimal)'))
237.         // Confirm that CloudWatch logs for APIGW are written
238.       ).then(events => expect(events.length > 0).to.equal(true));
239.     });
240.   });
241. 
242.   describe('Integration Lambda Timeout', () => {
243.     it('should result with 504 status code', () =>
244.       fetch(`${endpoint}/integration-lambda-timeout`).then(response =>
245.         expect(response.status).to.equal(504)
246.       ));
247.   });
248. 
249.   // NOTE: this test should  be at the very end because we're using an external REST API here
250.   describe('when using an existing REST API with stage specific configuration', () => {
251.     before(async () => {
252.       // create an external REST API
253.       const externalRestApiName = `${stage}-${serviceName}-ext-api`;
254.       await createRestApi(externalRestApiName)
255.         .then(restApiMeta => {
256.           restApiId = restApiMeta.id;
257.           return getResources(restApiId);
258.         })
259.         .then(resources => {
260.           restApiRootResourceId = resources[0].id;
261.           log.notice(
262.             'Created external rest API ' +
263.               `(id: ${restApiId}, root resource id: ${restApiRootResourceId})`
264.           );
265.         });
266. 
267.       const serverless = readYamlFile(serverlessFilePath);
268.       // enable Logs, Tags and Tracing
269.       _.merge(serverless.provider, {
270.         apiGateway: {
271.           restApiId,
272.           restApiRootResourceId,
273.         },
274.         tags: {
275.           foo: 'bar',
276.           baz: 'qux',
277.         },
278.         tracing: {
279.           apiGateway: true,
280.         },
281.         logs: {
282.           restApi: true,
283.         },
284.       });
285.       writeYamlFile(serverlessFilePath, serverless);
286.       log.notice('Redeploying service (with external Rest API ID)...');
287.       await deployService(tmpDirPath);
288.       return resolveEndpoint();
289.     });
290. 
291.     after(async () => {
292.       // NOTE: deleting the references to the old, external REST API
293.       const serverless = readYamlFile(serverlessFilePath);
294.       delete serverless.provider.apiGateway.restApiId;
295.       delete serverless.provider.apiGateway.restApiRootResourceId;
296.       writeYamlFile(serverlessFilePath, serverless);
297.       // NOTE: deploying once again to get the stack into the original state
298.       log.notice('Redeploying service (without external Rest API ID)...');
299.       await deployService(tmpDirPath);
300.       log.notice('Deleting external rest API...');
301.       return deleteRestApi(restApiId);
302.     });
303. 
304.     it('should update the stage without service interruptions', () => {
305.       // re-using the endpoint from the "minimal" test case
306.       const testEndpoint = `${endpoint}/minimal-1`;
307. 
308.       return fetch(testEndpoint, { method: 'POST' })
309.         .then(response => response.json())
310.         .then(json => expect(json.message).to.equal('Hello from API Gateway! - (minimal)'));
311.     });
312.   });
313. });


File: test/integration-all/shared/utils.js
Line number range: 1 - 22
Content:
1. 'use strict';
2. 
3. const logger = console;
4. 
5. function getMarkers(functionName) {
6.   return {
7.     start: `--- START ${functionName} ---`,
8.     end: `--- END ${functionName} ---`,
9.   };
10. }
11. 
12. function log(functionName, message) {
13.   const markers = getMarkers(functionName);
14.   logger.log(markers.start);
15.   logger.log(message);
16.   logger.log(markers.end);
17. }
18. 
19. module.exports = {
20.   getMarkers,
21.   log,
22. };


File: test/utils/api-gateway/index.js
Line number range: 1 - 55
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const awsRequest = require('@serverless/test/aws-request');
5. 
6. function createRestApi(name) {
7.   const params = {
8.     name,
9.   };
10. 
11.   return awsRequest('APIGateway', 'createRestApi', params);
12. }
13. 
14. function deleteRestApi(restApiId) {
15.   const params = {
16.     restApiId,
17.   };
18. 
19.   return awsRequest('APIGateway', 'deleteRestApi', params);
20. }
21. 
22. function getResources(restApiId) {
23.   const params = {
24.     restApiId,
25.   };
26. 
27.   return awsRequest('APIGateway', 'getResources', params).then(data => data.items);
28. }
29. 
30. function findRestApis(name) {
31.   const params = {
32.     limit: 500,
33.   };
34. 
35.   function recursiveFind(found, position) {
36.     if (position) params.position = position;
37.     return awsRequest('APIGateway', 'getRestApis', params).then(result => {
38.       const matches = result.items.filter(restApi => restApi.name.match(name));
39.       if (matches.length) {
40.         _.merge(found, matches);
41.       }
42.       if (result.position) return recursiveFind(found, result.position);
43.       return found;
44.     });
45.   }
46. 
47.   return recursiveFind([]);
48. }
49. 
50. module.exports = {
51.   createRestApi,
52.   deleteRestApi,
53.   getResources,
54.   findRestApis,
55. };

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:04:52,151 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The issue concerns default API Gateway request mapping templates, and the aggregated context already includes detailed unit tests for AWS API Gateway method compilation, including defaults for application/json and application/x-www-form-urlencoded, and related request configuration. Those tests are sufficient to extract 8 relevant cases with exact line numbers and include imports and setup. No additional files are necessary.' query='' extra_requirements='' purpose='Proceed to present 8 relevant existing tests with exact paths and line numbers that would likely be affected by changing default request mapping templates.'
2025-11-13 20:04:52,156 - thread-135845287823040.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.test.js', content='1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const sinon = require(\'sinon\');\n5. const AwsProvider = require(\'../../../../provider/awsProvider\');\n6. const AwsCompileApigEvents = require(\'./index\');\n7. const Serverless = require(\'../../../../../../Serverless\');\n8. const validate = require(\'../../../../lib/validate\');\n9. const getServiceState = require(\'../../../../lib/getServiceState\');\n10. const updateStage = require(\'./lib/hack/updateStage\');\n11. const disassociateUsagePlan = require(\'./lib/hack/disassociateUsagePlan\');\n12. \n13. describe(\'AwsCompileApigEvents\', () => {\n14.   let awsCompileApigEvents;\n15. \n16.   beforeEach(() => {\n17.     const serverless = new Serverless();\n18.     serverless.service.environment = {\n19.       vars: {},\n20.       stages: {\n21.         dev: {\n22.           vars: {},\n23.           regions: {\n24.             \'us-east-1\': {\n25.               vars: {},\n26.             },\n27.           },\n28.         },\n29.       },\n30.     };\n31.     const options = {\n32.       stage: \'dev\',\n33.       region: \'us-east-1\',\n34.     };\n35.     serverless.setProvider(\'aws\', new AwsProvider(serverless, options));\n36.     awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);\n37.   });\n38. \n39.   describe(\'#constructor()\', () => {\n40.     let compileRestApiStub;\n41.     let compileResourcesStub;\n42.     let compileMethodsStub;\n43.     let compileDeploymentStub;\n44.     let compileUsagePlanStub;\n45.     let compilePermissionsStub;\n46.     let compileStageStub;\n47.     let updateStageStub;\n48.     let disassociateUsagePlanStub;\n49. \n50.     beforeEach(() => {\n51.       compileRestApiStub = sinon.stub(awsCompileApigEvents, \'compileRestApi\').resolves();\n52.       compileResourcesStub = sinon.stub(awsCompileApigEvents, \'compileResources\').resolves();\n53.       compileMethodsStub = sinon.stub(awsCompileApigEvents, \'compileMethods\').resolves();\n54.       compileDeploymentStub = sinon.stub(awsCompileApigEvents, \'compileDeployment\').resolves();\n55.       compileUsagePlanStub = sinon.stub(awsCompileApigEvents, \'compileUsagePlan\').resolves();\n56.       compilePermissionsStub = sinon.stub(awsCompileApigEvents, \'compilePermissions\').resolves();\n57.       compileStageStub = sinon.stub(awsCompileApigEvents, \'compileStage\').resolves();\n58.       updateStageStub = sinon.stub(updateStage, \'updateStage\').resolves();\n59.       disassociateUsagePlanStub = sinon\n60.         .stub(disassociateUsagePlan, \'disassociateUsagePlan\')\n61.         .resolves();\n62.     });\n63. \n64.     afterEach(() => {\n65.       awsCompileApigEvents.compileRestApi.restore();\n66.       awsCompileApigEvents.compileResources.restore();\n67.       awsCompileApigEvents.compileMethods.restore();\n68.       awsCompileApigEvents.compileDeployment.restore();\n69.       awsCompileApigEvents.compileUsagePlan.restore();\n70.       awsCompileApigEvents.compilePermissions.restore();\n71.       awsCompileApigEvents.compileStage.restore();\n72.       updateStage.updateStage.restore();\n73.       disassociateUsagePlan.disassociateUsagePlan.restore();\n74.     });\n75. \n76.     it(\'should have hooks\', () => expect(awsCompileApigEvents.hooks).to.be.not.empty);\n77. \n78.     it(\'should set the provider variable to be an instanceof AwsProvider\', () =>\n79.       expect(awsCompileApigEvents.provider).to.be.instanceof(AwsProvider));\n80. \n81.     it(\'should setup an empty array to gather the method logical ids\', () =>\n82.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([]));\n83. \n84.     it(\'should run "package:compileEvents" promise chain in order\', () => {\n85.       const validateStub = sinon.stub(awsCompileApigEvents, \'validate\').returns({\n86.         events: [\n87.           {\n88.             functionName: \'first\',\n89.             http: {\n90.               path: \'users\',\n91.               method: \'POST\',\n92.             },\n93.           },\n94.         ],\n95.       });\n96. \n97.       return awsCompileApigEvents.hooks[\'package:compileEvents\']().then(() => {\n98.         expect(validateStub.calledOnce).to.be.equal(true);\n99.         expect(compileRestApiStub.calledAfter(validateStub)).to.be.equal(true);\n100.         expect(compileResourcesStub.calledAfter(compileRestApiStub)).to.be.equal(true);\n101.         expect(compileMethodsStub.calledAfter(compileResourcesStub)).to.be.equal(true);\n102.         expect(compileDeploymentStub.calledAfter(compileMethodsStub)).to.be.equal(true);\n103.         expect(compileUsagePlanStub.calledAfter(compileDeploymentStub)).to.be.equal(true);\n104.         expect(compilePermissionsStub.calledAfter(compileUsagePlanStub)).to.be.equal(true);\n105.         expect(compileStageStub.calledAfter(compilePermissionsStub)).to.be.equal(true);\n106. \n107.         awsCompileApigEvents.validate.restore();\n108.       });\n109.     });\n110. \n111.     describe(\'when running the "after:deploy:deploy" promise chain\', () => {\n112.       let getServiceStateStub;\n113. \n114.       beforeEach(() => {\n115.         getServiceStateStub = sinon.stub(getServiceState, \'getServiceState\');\n116.       });\n117. \n118.       afterEach(() => {\n119.         getServiceState.getServiceState.restore();\n120.       });\n121. \n122.       it(\'should run the promise chain in order\', () => {\n123.         getServiceStateStub.returns({\n124.           service: {\n125.             functions: {\n126.               first: {\n127.                 events: [\n128.                   {\n129.                     http: {\n130.                       path: \'users\',\n131.                       method: \'POST\',\n132.                     },\n133.                   },\n134.                 ],\n135.               },\n136.             },\n137.           },\n138.         });\n139. \n140.         return awsCompileApigEvents.hooks[\'after:deploy:deploy\']().then(() => {\n141.           expect(updateStageStub.calledOnce).to.equal(true);\n142.         });\n143.       });\n144. \n145.       it(\'should not skip the updateStage step when no http events are found\', () => {\n146.         getServiceStateStub.returns({\n147.           service: {\n148.             functions: {\n149.               first: {\n150.                 events: [],\n151.               },\n152.             },\n153.           },\n154.         });\n155. \n156.         return awsCompileApigEvents.hooks[\'after:deploy:deploy\']().then(() => {\n157.           expect(updateStageStub.calledOnce).to.equal(true);\n158.         });\n159.       });\n160.     });\n161. \n162.     it(\'should run "before:remove:remove" promise chain in order\', () => {\n163.       const validateStub = sinon.stub(validate, \'validate\').returns();\n164. \n165.       return awsCompileApigEvents.hooks[\'before:remove:remove\']().then(() => {\n166.         expect(validateStub.calledOnce).to.equal(true);\n167.         expect(disassociateUsagePlanStub.calledAfter(validateStub)).to.equal(true);\n168. \n169.         validate.validate.restore();\n170.       });\n171.     });\n172. \n173.     it(\'should resolve if no functions are given\', () => {\n174.       awsCompileApigEvents.serverless.service.functions = {};\n175. \n176.       return awsCompileApigEvents.hooks[\'package:compileEvents\']();\n177.     });\n178.   });\n179. });', start_line_number=1, end_line_number=179), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js', content='1. \'use strict\';\n2. \n3. const expect = require(\'chai\').expect;\n4. const AwsCompileApigEvents = require(\'../../index\');\n5. const Serverless = require(\'../../../../../../../../Serverless\');\n6. const AwsProvider = require(\'../../../../../../provider/awsProvider\');\n7. \n8. describe(\'#compileMethods()\', () => {\n9.   let serverless;\n10.   let awsCompileApigEvents;\n11. \n12.   beforeEach(() => {\n13.     const options = {\n14.       stage: \'dev\',\n15.       region: \'us-east-1\',\n16.     };\n17.     serverless = new Serverless();\n18.     serverless.setProvider(\'aws\', new AwsProvider(serverless, options));\n19.     serverless.service.service = \'first-service\';\n20.     serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };\n21.     serverless.service.environment = {\n22.       stages: {\n23.         dev: {\n24.           regions: {\n25.             \'us-east-1\': {\n26.               vars: {\n27.                 IamRoleLambdaExecution:\n28.                   \'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678\',\n29.               },\n30.             },\n31.           },\n32.         },\n33.       },\n34.     };\n35.     serverless.service.functions.First = {};\n36.     serverless.service.functions.Second = {};\n37.     serverless.service.functions.Third = {};\n38.     awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);\n39.     awsCompileApigEvents.validated = {};\n40.     awsCompileApigEvents.apiGatewayMethodLogicalIds = [];\n41.     awsCompileApigEvents.apiGatewayRestApiLogicalId = \'ApiGatewayRestApi\';\n42.     awsCompileApigEvents.apiGatewayResources = {\n43.       \'users/create\': {\n44.         name: \'UsersCreate\',\n45.         resourceLogicalId: \'ApiGatewayResourceUsersCreate\',\n46.       },\n47. \n48.       \'users/list\': {\n49.         name: \'UsersList\',\n50.         resourceLogicalId: \'ApiGatewayResourceUsersList\',\n51.       },\n52.       \'users/update\': {\n53.         name: \'UsersUpdate\',\n54.         resourceLogicalId: \'ApiGatewayResourceUsersUpdate\',\n55.       },\n56.       \'users/delete\': {\n57.         name: \'UsersDelete\',\n58.         resourceLogicalId: \'ApiGatewayResourceUsersDelete\',\n59.       },\n60.     };\n61.   });\n62. \n63.   it(\'should have request validators/models defined when they are set\', () => {\n64.     awsCompileApigEvents.validated.events = [\n65.       {\n66.         functionName: \'First\',\n67.         http: {\n68.           path: \'users/create\',\n69.           method: \'post\',\n70.           integration: \'AWS\',\n71.           request: { schema: { \'application/json\': { foo: \'bar\' } } },\n72.         },\n73.       },\n74.     ];\n75.     return awsCompileApigEvents.compileMethods().then(() => {\n76.       expect(\n77.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n78.           .ApiGatewayMethodUsersCreatePostValidator\n79.       ).to.deep.equal({\n80.         Type: \'AWS::ApiGateway::RequestValidator\',\n81.         Properties: {\n82.           RestApiId: { Ref: \'ApiGatewayRestApi\' },\n83.           ValidateRequestBody: true,\n84.           ValidateRequestParameters: true,\n85.         },\n86.       });\n87.       expect(\n88.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n89.           .ApiGatewayMethodUsersCreatePostApplicationJsonModel\n90.       ).to.deep.equal({\n91.         Type: \'AWS::ApiGateway::Model\',\n92.         Properties: {\n93.           RestApiId: { Ref: \'ApiGatewayRestApi\' },\n94.           ContentType: \'application/json\',\n95.           Schema: { foo: \'bar\' },\n96.         },\n97.       });\n98.       expect(\n99.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n100.           .ApiGatewayMethodUsersCreatePost.Properties.RequestModels\n101.       ).to.deep.equal({\n102.         \'application/json\': { Ref: \'ApiGatewayMethodUsersCreatePostApplicationJsonModel\' },\n103.       });\n104.       expect(\n105.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n106.           .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId\n107.       ).to.deep.equal({ Ref: \'ApiGatewayMethodUsersCreatePostValidator\' });\n108.     });\n109.   });\n110. \n111.   it(\'should support multiple request schemas\', () => {\n112.     awsCompileApigEvents.validated.events = [\n113.       {\n114.         functionName: \'First\',\n115.         http: {\n116.           path: \'users/create\',\n117.           method: \'post\',\n118.           integration: \'AWS\',\n119.           request: { schema: { \'application/json\': { foo: \'bar\' }, \'text/plain\': \'foo\' } },\n120.         },\n121.       },\n122.     ];\n123.     return awsCompileApigEvents.compileMethods().then(() => {\n124.       expect(\n125.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n126.           .ApiGatewayMethodUsersCreatePostValidator\n127.       ).to.deep.equal({\n128.         Type: \'AWS::ApiGateway::RequestValidator\',\n129.         Properties: {\n130.           RestApiId: { Ref: \'ApiGatewayRestApi\' },\n131.           ValidateRequestBody: true,\n132.           ValidateRequestParameters: true,\n133.         },\n134.       });\n135.       expect(\n136.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n137.           .ApiGatewayMethodUsersCreatePostApplicationJsonModel\n138.       ).to.deep.equal({\n139.         Type: \'AWS::ApiGateway::Model\',\n140.         Properties: {\n141.           RestApiId: { Ref: \'ApiGatewayRestApi\' },\n142.           ContentType: \'application/json\',\n143.           Schema: { foo: \'bar\' },\n144.         },\n145.       });\n146.       expect(\n147.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n148.           .ApiGatewayMethodUsersCreatePost.Properties.RequestModels\n149.       ).to.deep.equal({\n150.         \'application/json\': { Ref: \'ApiGatewayMethodUsersCreatePostApplicationJsonModel\' },\n151.         \'text/plain\': { Ref: \'ApiGatewayMethodUsersCreatePostTextPlainModel\' },\n152.       });\n153.       expect(\n154.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n155.           .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId\n156.       ).to.deep.equal({ Ref: \'ApiGatewayMethodUsersCreatePostValidator\' });\n157.     });\n158.   });\n159. \n160.   it(\'should have request parameters defined when they are set\', () => {\n161.     awsCompileApigEvents.validated.events = [\n162.       {\n163.         functionName: \'First\',\n164.         http: {\n165.           path: \'users/create\',\n166.           method: \'post\',\n167.           integration: \'AWS\',\n168.           request: {\n169.             parameters: {\n170.               \'method.request.querystring.foo\': true,\n171.               \'method.request.querystring.bar\': false,\n172.               \'method.request.header.foo\': true,\n173.               \'method.request.header.bar\': false,\n174.               \'method.request.path.foo\': true,\n175.               \'method.request.path.bar\': false,\n176.             },\n177.           },\n178.           response: {\n179.             statusCodes: {\n180.               200: {\n181.                 pattern: \'\',\n182.               },\n183.             },\n184.           },\n185.         },\n186.       },\n187.     ];\n188.     return awsCompileApigEvents.compileMethods().then(() => {\n189.       expect(\n190.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n191.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.header.foo\']\n192.       ).to.equal(true);\n193.       expect(\n194.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n195.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.header.bar\']\n196.       ).to.equal(false);\n197.       expect(\n198.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n199.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\n200.           \'method.request.querystring.foo\'\n201.         ]\n202.       ).to.equal(true);\n203.       expect(\n204.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n205.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\n206.           \'method.request.querystring.bar\'\n207.         ]\n208.       ).to.equal(false);\n209.       expect(\n210.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n211.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.path.foo\']\n212.       ).to.equal(true);\n213.       expect(\n214.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n215.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.path.bar\']\n216.       ).to.equal(false);\n217.     });\n218.   });\n219. \n220.   it(\'should not have integration RequestParameters when no request parameters are set\', () => {\n221.     awsCompileApigEvents.validated.events = [\n222.       {\n223.         functionName: \'First\',\n224.         http: {\n225.           path: \'users/create\',\n226.           method: \'post\',\n227.           integration: \'AWS\',\n228.         },\n229.       },\n230.     ];\n231.     return awsCompileApigEvents.compileMethods().then(() => {\n232.       expect(\n233.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n234.           .ApiGatewayMethodUsersCreatePost.Properties.Integration\n235.       ).to.not.have.key(\'RequestParameters\');\n236.     });\n237.   });\n238. \n239.   it(\'should create method resources when http events given\', () => {\n240.     awsCompileApigEvents.validated.events = [\n241.       {\n242.         functionName: \'First\',\n243.         http: {\n244.           path: \'users/create\',\n245.           method: \'post\',\n246.         },\n247.       },\n248.       {\n249.         functionName: \'Second\',\n250.         http: {\n251.           method: \'get\',\n252.           path: \'users/list\',\n253.         },\n254.       },\n255.     ];\n256.     return awsCompileApigEvents.compileMethods().then(() => {\n257.       expect(\n258.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n259.           .ApiGatewayMethodUsersCreatePost.Type\n260.       ).to.equal(\'AWS::ApiGateway::Method\');\n261.       expect(\n262.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n263.           .ApiGatewayMethodUsersListGet.Type\n264.       ).to.equal(\'AWS::ApiGateway::Method\');\n265.     });\n266.   });\n267. \n268.   it(\'should support AWS integration type\', () => {\n269.     awsCompileApigEvents.validated.events = [\n270.       {\n271.         functionName: \'First\',\n272.         http: {\n273.           path: \'users/create\',\n274.           method: \'post\',\n275.           integration: \'AWS\',\n276.           request: {\n277.             parameters: {\n278.               \'method.request.querystring.foo\': true,\n279.               \'method.request.querystring.bar\': false,\n280.               \'method.request.path.foo\': true,\n281.               \'method.request.path.bar\': false,\n282.               \'method.request.header.foo\': true,\n283.               \'method.request.header.bar\': false,\n284.             },\n285.           },\n286.         },\n287.       },\n288.     ];\n289.     return awsCompileApigEvents.compileMethods().then(() => {\n290.       expect(\n291.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n292.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type\n293.       ).to.equal(\'AWS\');\n294.       expect(\n295.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n296.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters\n297.       ).to.deep.equal({\n298.         \'integration.request.querystring.foo\': \'method.request.querystring.foo\',\n299.         \'integration.request.querystring.bar\': \'method.request.querystring.bar\',\n300.         \'integration.request.path.foo\': \'method.request.path.foo\',\n301.         \'integration.request.path.bar\': \'method.request.path.bar\',\n302.         \'integration.request.header.foo\': \'method.request.header.foo\',\n303.         \'integration.request.header.bar\': \'method.request.header.bar\',\n304.       });\n305.     });\n306.   });\n307. \n308.   it(\'should support AWS_PROXY integration type\', () => {\n309.     awsCompileApigEvents.validated.events = [\n310.       {\n311.         functionName: \'First\',\n312.         http: {\n313.           path: \'users/create\',\n314.           method: \'post\',\n315.           integration: \'AWS_PROXY\',\n316.         },\n317.       },\n318.     ];\n319.     return awsCompileApigEvents.compileMethods().then(() => {\n320.       expect(\n321.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n322.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type\n323.       ).to.equal(\'AWS_PROXY\');\n324.     });\n325.   });\n326. \n327.   it(\'should support HTTP integration type\', () => {\n328.     awsCompileApigEvents.validated.events = [\n329.       {\n330.         functionName: \'First\',\n331.         http: {\n332.           path: \'users/create\',\n333.           method: \'post\',\n334.           integration: \'HTTP\',\n335.           request: {\n336.             uri: \'https://example.com\',\n337.             parameters: {\n338.               \'method.request.querystring.foo\': true,\n339.               \'method.request.querystring.bar\': false,\n340.               \'method.request.path.foo\': true,\n341.               \'method.request.path.bar\': false,\n342.               \'method.request.header.foo\': true,\n343.               \'method.request.header.bar\': false,\n344.             },\n345.           },\n346.         },\n347.       },\n348.     ];\n349.     return awsCompileApigEvents.compileMethods().then(() => {\n350.       expect(\n351.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n352.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type\n353.       ).to.equal(\'HTTP\');\n354.       expect(\n355.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n356.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri\n357.       ).to.equal(\'https://example.com\');\n358.       expect(\n359.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n360.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod\n361.       ).to.equal(\'POST\');\n362.       expect(\n363.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n364.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates\n365.       ).to.equal(undefined);\n366.       expect(\n367.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n368.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters\n369.       ).to.deep.equal({\n370.         \'integration.request.querystring.foo\': \'method.request.querystring.foo\',\n371.         \'integration.request.querystring.bar\': \'method.request.querystring.bar\',\n372.         \'integration.request.path.foo\': \'method.request.path.foo\',\n373.         \'integration.request.path.bar\': \'method.request.path.bar\',\n374.         \'integration.request.header.foo\': \'method.request.header.foo\',\n375.         \'integration.request.header.bar\': \'method.request.header.bar\',\n376.       });\n377.     });\n378.   });\n379. \n380.   it(\'should support HTTP integration type with custom request options\', () => {\n381.     awsCompileApigEvents.validated.events = [\n382.       {\n383.         functionName: \'First\',\n384.         http: {\n385.           path: \'users/create\',\n386.           method: \'post\',\n387.           integration: \'HTTP\',\n388.           request: {\n389.             uri: \'https://example.com\',\n390.             method: \'put\',\n391.           },\n392.         },\n393.       },\n394.     ];\n395.     return awsCompileApigEvents.compileMethods().then(() => {\n396.       expect(\n397.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n398.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type\n399.       ).to.equal(\'HTTP\');\n400.       expect(\n401.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n402.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri\n403.       ).to.equal(\'https://example.com\');\n404.       expect(\n405.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n406.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod\n407.       ).to.equal(\'PUT\');\n408.     });\n409.   });\n410. \n411.   it(\'should support HTTP_PROXY integration type\', () => {\n412.     awsCompileApigEvents.validated.events = [\n413.       {\n414.         functionName: \'First\',\n415.         http: {\n416.           path: \'users/create\',\n417.           method: \'post\',\n418.           integration: \'HTTP_PROXY\',\n419.           request: {\n420.             uri: \'https://example.com\',\n421.             method: \'patch\',\n422.             parameters: {\n423.               \'method.request.querystring.foo\': true,\n424.               \'method.request.querystring.bar\': false,\n425.               \'method.request.path.foo\': true,\n426.               \'method.request.path.bar\': false,\n427.               \'method.request.header.foo\': true,\n428.               \'method.request.header.bar\': false,\n429.             },\n430.           },\n431.         },\n432.       },\n433.     ];\n434.     return awsCompileApigEvents.compileMethods().then(() => {\n435.       expect(\n436.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n437.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type\n438.       ).to.equal(\'HTTP_PROXY\');\n439.       expect(\n440.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n441.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri\n442.       ).to.equal(\'https://example.com\');\n443.       expect(\n444.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n445.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod\n446.       ).to.equal(\'PATCH\');\n447.       expect(\n448.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n449.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters\n450.       ).to.deep.equal({\n451.         \'integration.request.querystring.foo\': \'method.request.querystring.foo\',\n452.         \'integration.request.querystring.bar\': \'method.request.querystring.bar\',\n453.         \'integration.request.path.foo\': \'method.request.path.foo\',\n454.         \'integration.request.path.bar\': \'method.request.path.bar\',\n455.         \'integration.request.header.foo\': \'method.request.header.foo\',\n456.         \'integration.request.header.bar\': \'method.request.header.bar\',\n457.       });\n458.     });\n459.   });\n460. \n461.   it(\'should support MOCK integration type\', () => {\n462.     awsCompileApigEvents.validated.events = [\n463.       {\n464.         functionName: \'First\',\n465.         http: {\n466.           path: \'users/create\',\n467.           method: \'post\',\n468.           integration: \'MOCK\',\n469.         },\n470.       },\n471.     ];\n472.     return awsCompileApigEvents.compileMethods().then(() => {\n473.       expect(\n474.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n475.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type\n476.       ).to.equal(\'MOCK\');\n477.     });\n478.   });\n479. \n480.   it(\'should add request parameter when async config is used\', () => {\n481.     awsCompileApigEvents.validated.events = [\n482.       {\n483.         functionName: \'First\',\n484.         http: {\n485.           path: \'users/create\',\n486.           method: \'post\',\n487.           async: true,\n488.         },\n489.       },\n490.     ];\n491.     return awsCompileApigEvents.compileMethods().then(() => {\n492.       expect(\n493.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n494.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[\n495.           \'integration.request.header.X-Amz-Invocation-Type\'\n496.         ]\n497.       ).to.equal("\'Event\'");\n498.     });\n499.   });\n500. \n501.   it(\'should add request parameter when integration type is AWS_PROXY and async\', () => {\n502.     awsCompileApigEvents.validated.events = [\n503.       {\n504.         functionName: \'First\',\n505.         http: {\n506.           path: \'users/create\',\n507.           method: \'post\',\n508.           integration: \'AWS_PROXY\',\n509.           async: true,\n510.         },\n511.       },\n512.     ];\n513.     return awsCompileApigEvents.compileMethods().then(() => {\n514.       expect(\n515.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n516.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[\n517.           \'integration.request.header.X-Amz-Invocation-Type\'\n518.         ]\n519.       ).to.equal("\'Event\'");\n520.     });\n521.   });\n522. \n523.   it(\'should add request parameter mapped value when explicitly defined\', () => {\n524.     awsCompileApigEvents.validated.events = [\n525.       {\n526.         functionName: \'First\',\n527.         http: {\n528.           path: \'users/create\',\n529.           method: \'post\',\n530.           integration: \'HTTP_PROXY\',\n531.           request: {\n532.             uri: \'https://example.com\',\n533.             parameters: {\n534.               \'method.request.querystring.foo\': {\n535.                 required: true,\n536.                 mappedValue: \'fooValue\',\n537.               },\n538.               \'method.request.querystring.bar\': {\n539.                 required: false,\n540.                 mappedValue: \'barValue\',\n541.               },\n542.               \'method.request.path.foo\': {\n543.                 required: true,\n544.                 mappedValue: \'fooValue\',\n545.               },\n546.               \'method.request.path.bar\': {\n547.                 required: false,\n548.                 mappedValue: \'barValue\',\n549.               },\n550.               \'method.request.header.foo\': {\n551.                 required: true,\n552.                 mappedValue: \'fooValue\',\n553.               },\n554.               \'method.request.header.bar\': {\n555.                 required: false,\n556.                 mappedValue: \'barValue\',\n557.               },\n558.             },\n559.           },\n560.         },\n561.       },\n562.     ];\n563.     return awsCompileApigEvents.compileMethods().then(() => {\n564.       expect(\n565.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n566.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.header.foo\']\n567.       ).to.equal(true);\n568.       expect(\n569.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n570.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.header.bar\']\n571.       ).to.equal(false);\n572.       expect(\n573.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n574.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\n575.           \'method.request.querystring.foo\'\n576.         ]\n577.       ).to.equal(true);\n578.       expect(\n579.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n580.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\n581.           \'method.request.querystring.bar\'\n582.         ]\n583.       ).to.equal(false);\n584.       expect(\n585.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n586.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.path.foo\']\n587.       ).to.equal(true);\n588.       expect(\n589.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n590.           .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[\'method.request.path.bar\']\n591.       ).to.equal(false);\n592.       expect(\n593.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n594.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters\n595.       ).to.deep.equal({\n596.         \'integration.request.querystring.foo\': \'fooValue\',\n597.         \'integration.request.querystring.bar\': \'barValue\',\n598.         \'integration.request.path.foo\': \'fooValue\',\n599.         \'integration.request.path.bar\': \'barValue\',\n600.         \'integration.request.header.foo\': \'fooValue\',\n601.         \'integration.request.header.bar\': \'barValue\',\n602.       });\n603.     });\n604.   });\n605. \n606.   it(\'should set authorizer config for AWS_IAM\', () => {\n607.     awsCompileApigEvents.validated.events = [\n608.       {\n609.         functionName: \'First\',\n610.         http: {\n611.           path: \'users/create\',\n612.           method: \'post\',\n613.           authorizer: {\n614.             type: \'AWS_IAM\',\n615.           },\n616.         },\n617.       },\n618.     ];\n619.     return awsCompileApigEvents.compileMethods().then(() => {\n620.       expect(\n621.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n622.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType\n623.       ).to.equal(\'AWS_IAM\');\n624.     });\n625.   });\n626. \n627.   it(\'should set custom authorizer config with authorizerId\', () => {\n628.     awsCompileApigEvents.validated.events = [\n629.       {\n630.         functionName: \'First\',\n631.         http: {\n632.           path: \'users/create\',\n633.           method: \'post\',\n634.           authorizer: {\n635.             type: \'COGNITO_USER_POOLS\',\n636.             authorizerId: \'gy7lyj\',\n637.           },\n638.         },\n639.       },\n640.     ];\n641.     return awsCompileApigEvents.compileMethods().then(() => {\n642.       expect(\n643.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n644.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType\n645.       ).to.equal(\'COGNITO_USER_POOLS\');\n646.       expect(\n647.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n648.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId\n649.       ).to.equal(\'gy7lyj\');\n650.     });\n651.   });\n652. \n653.   it(\'should set authorizer config if given as ARN string\', () => {\n654.     awsCompileApigEvents.validated.events = [\n655.       {\n656.         functionName: \'First\',\n657.         http: {\n658.           authorizer: {\n659.             name: \'Authorizer\',\n660.           },\n661.           integration: \'AWS\',\n662.           path: \'users/create\',\n663.           method: \'post\',\n664.         },\n665.       },\n666.     ];\n667.     return awsCompileApigEvents.compileMethods().then(() => {\n668.       expect(\n669.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n670.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType\n671.       ).to.equal(\'CUSTOM\');\n672. \n673.       expect(\n674.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n675.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref\n676.       ).to.equal(\'AuthorizerApiGatewayAuthorizer\');\n677.     });\n678.   });\n679. \n680.   it(\'should set authorizer config for a cognito user pool when given authorizer arn\', () => {\n681.     awsCompileApigEvents.validated.events = [\n682.       {\n683.         functionName: \'First\',\n684.         http: {\n685.           authorizer: {\n686.             name: \'authorizer\',\n687.             arn: \'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ\',\n688.             scopes: [\'myapp/read\', \'myapp/write\'],\n689.           },\n690.           integration: \'AWS\',\n691.           path: \'users/create\',\n692.           method: \'post\',\n693.         },\n694.       },\n695.     ];\n696. \n697.     return awsCompileApigEvents.compileMethods().then(() => {\n698.       expect(\n699.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n700.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType\n701.       ).to.equal(\'COGNITO_USER_POOLS\');\n702. \n703.       expect(\n704.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n705.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes\n706.       ).to.contain(\'myapp/read\');\n707. \n708.       expect(\n709.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n710.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref\n711.       ).to.equal(\'AuthorizerApiGatewayAuthorizer\');\n712. \n713.       expect(\n714.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n715.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[\n716.           \'application/json\'\n717.         ]\n718.       ).to.not.match(/undefined/);\n719.     });\n720.   });\n721. \n722.   it(\'should set authorizer config for a cognito user pool when given authorizerId Ref\', () => {\n723.     awsCompileApigEvents.validated.events = [\n724.       {\n725.         functionName: \'First\',\n726.         http: {\n727.           authorizer: {\n728.             name: \'authorizer\',\n729.             type: \'COGNITO_USER_POOLS\',\n730.             authorizerId: { Ref: \'CognitoAuthorizer\' },\n731.             scopes: [\'myapp/read\', \'myapp/write\'],\n732.           },\n733.           integration: \'AWS\',\n734.           path: \'users/create\',\n735.           method: \'post\',\n736.         },\n737.       },\n738.     ];\n739. \n740.     return awsCompileApigEvents.compileMethods().then(() => {\n741.       expect(\n742.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n743.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType\n744.       ).to.equal(\'COGNITO_USER_POOLS\');\n745. \n746.       expect(\n747.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n748.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes\n749.       ).to.contain(\'myapp/read\');\n750. \n751.       expect(\n752.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n753.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref\n754.       ).to.equal(\'CognitoAuthorizer\');\n755. \n756.       expect(\n757.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n758.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[\n759.           \'application/json\'\n760.         ]\n761.       ).to.not.match(/undefined/);\n762.     });\n763.   });\n764. \n765.   it(\'should set authorizer config for a cognito user pool when given cognito arn object\', () => {\n766.     awsCompileApigEvents.validated.events = [\n767.       {\n768.         functionName: \'First\',\n769.         http: {\n770.           authorizer: {\n771.             name: \'authorizer\',\n772.             type: \'COGNITO_USER_POOLS\',\n773.             arn: {\n774.               \'Fn::GetAtt\': [\'CognitoUserPool\', \'Arn\'],\n775.             },\n776.             scopes: [\'myapp/read\', \'myapp/write\'],\n777.           },\n778.           integration: \'AWS\',\n779.           path: \'users/create\',\n780.           method: \'post\',\n781.         },\n782.       },\n783.     ];\n784. \n785.     return awsCompileApigEvents.compileMethods().then(() => {\n786.       expect(\n787.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n788.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType\n789.       ).to.equal(\'COGNITO_USER_POOLS\');\n790. \n791.       expect(\n792.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n793.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes\n794.       ).to.contain(\'myapp/read\');\n795. \n796.       expect(\n797.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n798.           .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref\n799.       ).to.equal(\'AuthorizerApiGatewayAuthorizer\');\n800. \n801.       expect(\n802.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n803.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[\n804.           \'application/json\'\n805.         ]\n806.       ).to.not.match(/undefined/);\n807.     });\n808.   });\n809. \n810.   it(\'should not scopes for a cognito user pool when given empty scopes array\', () => {\n811.     awsCompileApigEvents.validated.events = [\n812.       {\n813.         functionName: \'First\',\n814.         http: {\n815.           authorizer: {\n816.             name: \'authorizer\',\n817.             type: \'COGNITO_USER_POOLS\',\n818.             authorizerId: { Ref: \'CognitoAuthorizer\' },\n819.             scopes: [],\n820.           },\n821.           integration: \'AWS\',\n822.           path: \'users/create\',\n823.           method: \'post\',\n824.         },\n825.       },\n826.     ];\n827. \n828.     return awsCompileApigEvents.compileMethods().then(() => {\n829.       expect(\n830.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n831.           .ApiGatewayMethodUsersCreatePost.Properties\n832.       ).to.not.have.property(\'AuthorizationScopes\');\n833.     });\n834.   });\n835. \n836.   it(\'should set claims for a cognito user pool\', () => {\n837.     awsCompileApigEvents.validated.events = [\n838.       {\n839.         functionName: \'First\',\n840.         http: {\n841.           authorizer: {\n842.             name: \'authorizer\',\n843.             arn: \'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ\',\n844.             claims: [\'email\'],\n845.           },\n846.           integration: \'AWS\',\n847.           path: \'users/create\',\n848.           method: \'post\',\n849.         },\n850.       },\n851.     ];\n852. \n853.     return awsCompileApigEvents.compileMethods().then(() => {\n854.       const jsonRequestTemplatesString =\n855.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n856.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[\n857.           \'application/json\'\n858.         ];\n859.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\\s*:\\s*(\\{[^}]*\\})/;\n860.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];\n861.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);\n862.       expect(cognitoPoolClaims.email).to.equal(\'$context.authorizer.claims.email\');\n863.     });\n864.   });\n865. \n866.   it(\'should set multiple claims for a cognito user pool\', () => {\n867.     awsCompileApigEvents.validated.events = [\n868.       {\n869.         functionName: \'First\',\n870.         http: {\n871.           authorizer: {\n872.             name: \'authorizer\',\n873.             arn: \'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ\',\n874.             claims: [\'email\', \'gender\'],\n875.           },\n876.           integration: \'AWS\',\n877.           path: \'users/create\',\n878.           method: \'post\',\n879.         },\n880.       },\n881.     ];\n882. \n883.     return awsCompileApigEvents.compileMethods().then(() => {\n884.       const jsonRequestTemplatesString =\n885.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n886.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[\n887.           \'application/json\'\n888.         ];\n889.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\\s*:\\s*(\\{[^}]*\\})/;\n890.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];\n891.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);\n892.       expect(cognitoPoolClaims.email).to.equal(\'$context.authorizer.claims.email\');\n893.       expect(cognitoPoolClaims.gender).to.equal(\'$context.authorizer.claims.gender\');\n894.     });\n895.   });\n896. \n897.   it(\'should properly set claims for custom properties inside the cognito user pool\', () => {\n898.     awsCompileApigEvents.validated.events = [\n899.       {\n900.         functionName: \'First\',\n901.         http: {\n902.           authorizer: {\n903.             name: \'authorizer\',\n904.             arn: \'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ\',\n905.             claims: [\'email\', \'custom:score\'],\n906.           },\n907.           integration: \'AWS\',\n908.           path: \'users/create\',\n909.           method: \'post\',\n910.         },\n911.       },\n912.     ];\n913. \n914.     return awsCompileApigEvents.compileMethods().then(() => {\n915.       const jsonRequestTemplatesString =\n916.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n917.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[\n918.           \'application/json\'\n919.         ];\n920.       const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\\s*:\\s*(\\{[^}]*\\})/;\n921.       const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];\n922.       const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);\n923.       expect(cognitoPoolClaims.email).to.equal(\'$context.authorizer.claims.email\');\n924.       expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims[\'custom:score\']");\n925.     });\n926.   });\n927. \n928.   it(\'should replace the extra claims in the template if there are none\', () => {\n929.     awsCompileApigEvents.validated.events = [\n930.       {\n931.         functionName: \'First\',\n932.         http: {\n933.           authorizer: {\n934.             name: \'authorizer\',\n935.             arn: \'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ\',\n936.           },\n937.           integration: \'AWS\',\n938.           path: \'users/create\',\n939.           method: \'post\',\n940.         },\n941.       },\n942.     ];\n943. \n944.     return awsCompileApigEvents.compileMethods().then(() => {\n945.       expect(\n946.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n947.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[\n948.           \'application/json\'\n949.         ]\n950.       ).to.not.match(/extraCognitoPoolClaims/);\n951.     });\n952.   });\n953. \n954.   it(\'should not create method resources when http events are not given\', () => {\n955.     awsCompileApigEvents.validated.events = [];\n956. \n957.     return awsCompileApigEvents.compileMethods().then(() => {\n958.       expect(\n959.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n960.       ).to.deep.equal({});\n961.     });\n962.   });\n963. \n964.   it(\'should update the method logical ids array\', () => {\n965.     awsCompileApigEvents.validated.events = [\n966.       {\n967.         functionName: \'First\',\n968.         http: {\n969.           path: \'users/create\',\n970.           method: \'post\',\n971.         },\n972.       },\n973.       {\n974.         functionName: \'Second\',\n975.         http: {\n976.           method: \'get\',\n977.           path: \'users/list\',\n978.         },\n979.       },\n980.     ];\n981.     return awsCompileApigEvents.compileMethods().then(() => {\n982.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);\n983.       expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([\n984.         \'ApiGatewayMethodUsersCreatePost\',\n985.         \'ApiGatewayMethodUsersListGet\',\n986.       ]);\n987.     });\n988.   });\n989. \n990.   it(\'should set api key as required if private endpoint\', () => {\n991.     awsCompileApigEvents.validated.events = [\n992.       {\n993.         functionName: \'First\',\n994.         http: {\n995.           path: \'users/create\',\n996.           method: \'post\',\n997.           private: true,\n998.         },\n999.       },\n1000.     ];\n1001.     return awsCompileApigEvents.compileMethods().then(() => {\n1002.       expect(\n1003.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1004.           .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired\n1005.       ).to.equal(true);\n1006.     });\n1007.   });\n1008. \n1009.   it(\'should set api key as not required if private property is not specified\', () => {\n1010.     awsCompileApigEvents.validated.events = [\n1011.       {\n1012.         functionName: \'First\',\n1013.         http: {\n1014.           path: \'users/create\',\n1015.           method: \'post\',\n1016.         },\n1017.       },\n1018.     ];\n1019.     return awsCompileApigEvents.compileMethods().then(() => {\n1020.       expect(\n1021.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1022.           .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired\n1023.       ).to.equal(false);\n1024.     });\n1025.   });\n1026. \n1027.   it(\'should set the correct lambdaUri\', () => {\n1028.     awsCompileApigEvents.validated.events = [\n1029.       {\n1030.         functionName: \'First\',\n1031.         http: {\n1032.           path: \'users/create\',\n1033.           method: \'post\',\n1034.         },\n1035.       },\n1036.       {\n1037.         functionName: \'Second\',\n1038.         http: {\n1039.           method: \'get\',\n1040.           path: \'users/list\',\n1041.         },\n1042.       },\n1043.     ];\n1044.     return awsCompileApigEvents.compileMethods().then(() => {\n1045.       expect(\n1046.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1047.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri\n1048.       ).to.deep.equal({\n1049.         \'Fn::Join\': [\n1050.           \'\',\n1051.           [\n1052.             \'arn:\',\n1053.             { Ref: \'AWS::Partition\' },\n1054.             \':apigateway:\',\n1055.             { Ref: \'AWS::Region\' },\n1056.             \':lambda:path/2015-03-31/functions/\',\n1057.             { \'Fn::GetAtt\': [\'FirstLambdaFunction\', \'Arn\'] },\n1058.             \'/invocations\',\n1059.           ],\n1060.         ],\n1061.       });\n1062.       expect(\n1063.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1064.           .ApiGatewayMethodUsersListGet.Properties.Integration.Uri\n1065.       ).to.deep.equal({\n1066.         \'Fn::Join\': [\n1067.           \'\',\n1068.           [\n1069.             \'arn:\',\n1070.             { Ref: \'AWS::Partition\' },\n1071.             \':apigateway:\',\n1072.             { Ref: \'AWS::Region\' },\n1073.             \':lambda:path/2015-03-31/functions/\',\n1074.             { \'Fn::GetAtt\': [\'SecondLambdaFunction\', \'Arn\'] },\n1075.             \'/invocations\',\n1076.           ],\n1077.         ],\n1078.       });\n1079.     });\n1080.   });\n1081. \n1082.   it(\'Should point target alias if set\', () => {\n1083.     awsCompileApigEvents.validated.events = [\n1084.       {\n1085.         functionName: \'Provisioned\',\n1086.         http: {\n1087.           method: \'get\',\n1088.           path: \'users/list\',\n1089.         },\n1090.       },\n1091.     ];\n1092.     serverless.service.functions.Provisioned = {\n1093.       targetAlias: { name: \'provisioned\', logicalId: \'IrrelevantLogicalId\' },\n1094.     };\n1095.     return awsCompileApigEvents.compileMethods().then(() => {\n1096.       expect(\n1097.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1098.           .ApiGatewayMethodUsersListGet.Properties.Integration.Uri\n1099.       ).to.deep.equal({\n1100.         \'Fn::Join\': [\n1101.           \'\',\n1102.           [\n1103.             \'arn:\',\n1104.             { Ref: \'AWS::Partition\' },\n1105.             \':apigateway:\',\n1106.             { Ref: \'AWS::Region\' },\n1107.             \':lambda:path/2015-03-31/functions/\',\n1108.             { \'Fn::GetAtt\': [\'ProvisionedLambdaFunction\', \'Arn\'] },\n1109.             \':\',\n1110.             \'provisioned\',\n1111.             \'/invocations\',\n1112.           ],\n1113.         ],\n1114.       });\n1115.     });\n1116.   });\n1117. \n1118.   it(\'should add CORS origins to method only when CORS is enabled\', () => {\n1119.     awsCompileApigEvents.validated.events = [\n1120.       {\n1121.         functionName: \'First\',\n1122.         http: {\n1123.           path: \'users/create\',\n1124.           method: \'post\',\n1125.           integration: \'AWS\',\n1126.           cors: {\n1127.             origin: \'http://example.com\',\n1128.           },\n1129.           response: {\n1130.             statusCodes: {\n1131.               200: {\n1132.                 pattern: \'\',\n1133.               },\n1134.             },\n1135.           },\n1136.         },\n1137.       },\n1138.       {\n1139.         functionName: \'Second\',\n1140.         http: {\n1141.           method: \'get\',\n1142.           path: \'users/list\',\n1143.           integration: \'AWS\',\n1144.           response: {\n1145.             statusCodes: {\n1146.               200: {\n1147.                 pattern: \'\',\n1148.               },\n1149.             },\n1150.           },\n1151.         },\n1152.       },\n1153.       {\n1154.         functionName: \'Third\',\n1155.         http: {\n1156.           path: \'users/update\',\n1157.           method: \'PUT\',\n1158.           integration: \'AWS\',\n1159.           response: {\n1160.             statusCodes: {\n1161.               200: {\n1162.                 pattern: \'\',\n1163.               },\n1164.             },\n1165.           },\n1166.           cors: {\n1167.             origins: [\'*\'],\n1168.           },\n1169.         },\n1170.       },\n1171.     ];\n1172.     return awsCompileApigEvents.compileMethods().then(() => {\n1173.       expect(\n1174.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1175.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]\n1176.           .ResponseParameters[\'method.response.header.Access-Control-Allow-Origin\']\n1177.       ).to.equal("\'http://example.com\'");\n1178. \n1179.       // CORS not enabled!\n1180.       expect(\n1181.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1182.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1183.           .ResponseParameters[\'method.response.header.Access-Control-Allow-Origin\']\n1184.       ).to.not.equal("\'*\'");\n1185. \n1186.       expect(\n1187.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1188.           .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]\n1189.           .ResponseParameters[\'method.response.header.Access-Control-Allow-Origin\']\n1190.       ).to.equal("\'*\'");\n1191.     });\n1192.   });\n1193. \n1194.   it(\'should set CORS allowCredentials to method only when specified\', () => {\n1195.     awsCompileApigEvents.validated.events = [\n1196.       {\n1197.         functionName: \'First\',\n1198.         http: {\n1199.           path: \'users/create\',\n1200.           method: \'post\',\n1201.           integration: \'AWS\',\n1202.           cors: {\n1203.             origin: \'http://example.com\',\n1204.             allowCredentials: true,\n1205.           },\n1206.           response: {\n1207.             statusCodes: {\n1208.               200: {\n1209.                 pattern: \'\',\n1210.               },\n1211.             },\n1212.           },\n1213.         },\n1214.       },\n1215.       {\n1216.         functionName: \'Second\',\n1217.         http: {\n1218.           method: \'get\',\n1219.           path: \'users/list\',\n1220.           integration: \'AWS\',\n1221.           cors: {\n1222.             origin: \'http://example.com\',\n1223.           },\n1224.           response: {\n1225.             statusCodes: {\n1226.               200: {\n1227.                 pattern: \'\',\n1228.               },\n1229.             },\n1230.           },\n1231.         },\n1232.       },\n1233.     ];\n1234.     return awsCompileApigEvents.compileMethods().then(() => {\n1235.       expect(\n1236.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1237.           .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]\n1238.           .ResponseParameters[\'method.response.header.Access-Control-Allow-Credentials\']\n1239.       ).to.equal(\'true\');\n1240. \n1241.       // allowCredentials not enabled\n1242.       expect(\n1243.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1244.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1245.           .ResponseParameters[\'method.response.header.Access-Control-Allow-Credentials\']\n1246.       ).to.not.equal(\'true\');\n1247.     });\n1248.   });\n1249. \n1250.   describe(\'when dealing with request configuration\', () => {\n1251.     it(\'should setup a default "application/json" template\', () => {\n1252.       awsCompileApigEvents.validated.events = [\n1253.         {\n1254.           functionName: \'Second\',\n1255.           http: {\n1256.             method: \'get\',\n1257.             path: \'users/list\',\n1258.             integration: \'AWS\',\n1259.             response: {\n1260.               statusCodes: {\n1261.                 200: {\n1262.                   pattern: \'\',\n1263.                 },\n1264.               },\n1265.             },\n1266.           },\n1267.         },\n1268.       ];\n1269.       return awsCompileApigEvents.compileMethods().then(() => {\n1270.         expect(\n1271.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1272.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[\n1273.             \'application/json\'\n1274.           ]\n1275.         ).to.have.length.above(0);\n1276.       });\n1277.     });\n1278. \n1279.     it(\'should setup a default "application/x-www-form-urlencoded" template\', () => {\n1280.       awsCompileApigEvents.validated.events = [\n1281.         {\n1282.           functionName: \'Second\',\n1283.           http: {\n1284.             method: \'get\',\n1285.             path: \'users/list\',\n1286.             integration: \'AWS\',\n1287.             response: {\n1288.               statusCodes: {\n1289.                 200: {\n1290.                   pattern: \'\',\n1291.                 },\n1292.               },\n1293.             },\n1294.           },\n1295.         },\n1296.       ];\n1297.       return awsCompileApigEvents.compileMethods().then(() => {\n1298.         expect(\n1299.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1300.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[\n1301.             \'application/x-www-form-urlencoded\'\n1302.           ]\n1303.         ).to.have.length.above(0);\n1304.       });\n1305.     });\n1306. \n1307.     it(\'should use defined pass-through behavior\', () => {\n1308.       awsCompileApigEvents.validated.events = [\n1309.         {\n1310.           functionName: \'First\',\n1311.           http: {\n1312.             method: \'GET\',\n1313.             path: \'users/list\',\n1314.             integration: \'AWS\',\n1315.             request: {\n1316.               passThrough: \'WHEN_NO_TEMPLATES\',\n1317.             },\n1318.             response: {\n1319.               statusCodes: {\n1320.                 200: {\n1321.                   pattern: \'\',\n1322.                 },\n1323.               },\n1324.             },\n1325.           },\n1326.         },\n1327.       ];\n1328.       return awsCompileApigEvents.compileMethods().then(() => {\n1329.         expect(\n1330.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1331.             .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior\n1332.         ).to.equal(\'WHEN_NO_TEMPLATES\');\n1333.       });\n1334.     });\n1335. \n1336.     it(\'should use defined content-handling behavior (request)\', () => {\n1337.       awsCompileApigEvents.validated.events = [\n1338.         {\n1339.           functionName: \'First\',\n1340.           http: {\n1341.             method: \'GET\',\n1342.             path: \'users/list\',\n1343.             integration: \'AWS\',\n1344.             request: {\n1345.               contentHandling: \'CONVERT_TO_TEXT\',\n1346.             },\n1347.             response: {\n1348.               statusCodes: {\n1349.                 200: {\n1350.                   pattern: \'\',\n1351.                 },\n1352.               },\n1353.             },\n1354.           },\n1355.         },\n1356.       ];\n1357.       return awsCompileApigEvents.compileMethods().then(() => {\n1358.         expect(\n1359.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1360.             .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling\n1361.         ).to.equal(\'CONVERT_TO_TEXT\');\n1362.       });\n1363.     });\n1364. \n1365.     it(\'should use defined response content-handling behavior for 2XX only (response)\', () => {\n1366.       awsCompileApigEvents.validated.events = [\n1367.         {\n1368.           functionName: \'First\',\n1369.           http: {\n1370.             method: \'GET\',\n1371.             path: \'users/list\',\n1372.             integration: \'AWS\',\n1373.             response: {\n1374.               contentHandling: \'CONVERT_TO_BINARY\',\n1375.               statusCodes: {\n1376.                 200: {\n1377.                   pattern: \'\',\n1378.                 },\n1379.                 400: {\n1380.                   pattern: \'400\',\n1381.                 },\n1382.               },\n1383.             },\n1384.           },\n1385.         },\n1386.       ];\n1387.       return awsCompileApigEvents.compileMethods().then(() => {\n1388.         expect(\n1389.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1390.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1391.             .ContentHandling\n1392.         ).to.equal(\'CONVERT_TO_BINARY\');\n1393.         expect(\n1394.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1395.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1396.             .ContentHandling\n1397.         ).to.equal(undefined);\n1398.       });\n1399.     });\n1400. \n1401.     it(\'should set custom request templates\', () => {\n1402.       awsCompileApigEvents.validated.events = [\n1403.         {\n1404.           functionName: \'First\',\n1405.           http: {\n1406.             method: \'GET\',\n1407.             path: \'users/list\',\n1408.             integration: \'AWS\',\n1409.             request: {\n1410.               template: {\n1411.                 \'template/1\': \'{ "stage" : "$context.stage" }\',\n1412.                 \'template/2\': \'{ "httpMethod" : "$context.httpMethod" }\',\n1413.               },\n1414.             },\n1415.             response: {\n1416.               statusCodes: {\n1417.                 200: {\n1418.                   pattern: \'\',\n1419.                 },\n1420.               },\n1421.             },\n1422.           },\n1423.         },\n1424.       ];\n1425.       return awsCompileApigEvents.compileMethods().then(() => {\n1426.         expect(\n1427.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1428.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[\'template/1\']\n1429.         ).to.equal(\'{ "stage" : "$context.stage" }\');\n1430. \n1431.         expect(\n1432.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1433.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[\'template/2\']\n1434.         ).to.equal(\'{ "httpMethod" : "$context.httpMethod" }\');\n1435.       });\n1436.     });\n1437. \n1438.     it(\'should be possible to overwrite default request templates\', () => {\n1439.       awsCompileApigEvents.validated.events = [\n1440.         {\n1441.           functionName: \'First\',\n1442.           http: {\n1443.             method: \'GET\',\n1444.             path: \'users/list\',\n1445.             integration: \'AWS\',\n1446.             request: {\n1447.               template: {\n1448.                 \'application/json\': \'overwritten-request-template-content\',\n1449.               },\n1450.             },\n1451.             response: {\n1452.               statusCodes: {\n1453.                 200: {\n1454.                   pattern: \'\',\n1455.                 },\n1456.               },\n1457.             },\n1458.           },\n1459.         },\n1460.       ];\n1461.       return awsCompileApigEvents.compileMethods().then(() => {\n1462.         expect(\n1463.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1464.             .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[\n1465.             \'application/json\'\n1466.           ]\n1467.         ).to.equal(\'overwritten-request-template-content\');\n1468.       });\n1469.     });\n1470.   });\n1471. \n1472.   describe(\'when dealing with response configuration\', () => {\n1473.     it(\'should set the custom headers\', () => {\n1474.       awsCompileApigEvents.validated.events = [\n1475.         {\n1476.           functionName: \'First\',\n1477.           http: {\n1478.             method: \'GET\',\n1479.             path: \'users/list\',\n1480.             integration: \'AWS\',\n1481.             response: {\n1482.               statusCodes: {\n1483.                 200: {\n1484.                   pattern: \'\',\n1485.                   headers: {\n1486.                     \'Content-Type\': "\'text/plain\'",\n1487.                     \'My-Custom-Header\': \'my/custom/header\',\n1488.                   },\n1489.                 },\n1490.               },\n1491.             },\n1492.           },\n1493.         },\n1494.       ];\n1495.       return awsCompileApigEvents.compileMethods().then(() => {\n1496.         expect(\n1497.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1498.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1499.             .ResponseParameters[\'method.response.header.Content-Type\']\n1500.         ).to.equal("\'text/plain\'");\n1501.         expect(\n1502.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1503.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1504.             .ResponseParameters[\'method.response.header.My-Custom-Header\']\n1505.         ).to.equal(\'my/custom/header\');\n1506.       });\n1507.     });\n1508. \n1509.     it(\'should set the custom template\', () => {\n1510.       awsCompileApigEvents.validated.events = [\n1511.         {\n1512.           functionName: \'First\',\n1513.           http: {\n1514.             method: \'GET\',\n1515.             path: \'users/list\',\n1516.             integration: \'AWS\',\n1517.             response: {\n1518.               statusCodes: {\n1519.                 200: {\n1520.                   template: "$input.path(\'$.foo\')",\n1521.                   pattern: \'\',\n1522.                 },\n1523.               },\n1524.             },\n1525.           },\n1526.         },\n1527.       ];\n1528.       return awsCompileApigEvents.compileMethods().then(() => {\n1529.         expect(\n1530.           awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1531.             .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1532.             .ResponseTemplates[\'application/json\']\n1533.         ).to.equal("$input.path(\'$.foo\')");\n1534.       });\n1535.     });\n1536.   });\n1537. \n1538.   it(\'should add method responses for different status codes\', () => {\n1539.     awsCompileApigEvents.validated.events = [\n1540.       {\n1541.         functionName: \'First\',\n1542.         http: {\n1543.           method: \'get\',\n1544.           path: \'users/list\',\n1545.           integration: \'AWS\',\n1546.           response: {\n1547.             statusCodes: {\n1548.               200: {\n1549.                 pattern: \'\',\n1550.               },\n1551.               202: {\n1552.                 pattern: \'foo\',\n1553.               },\n1554.             },\n1555.           },\n1556.         },\n1557.       },\n1558.     ];\n1559.     return awsCompileApigEvents.compileMethods().then(() => {\n1560.       expect(\n1561.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1562.           .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode\n1563.       ).to.equal(\'200\');\n1564.       expect(\n1565.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1566.           .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode\n1567.       ).to.equal(\'202\');\n1568.     });\n1569.   });\n1570. \n1571.   it(\'should add integration responses for different status codes\', () => {\n1572.     awsCompileApigEvents.validated.events = [\n1573.       {\n1574.         functionName: \'First\',\n1575.         http: {\n1576.           method: \'get\',\n1577.           path: \'users/list\',\n1578.           integration: \'AWS\',\n1579.           response: {\n1580.             statusCodes: {\n1581.               200: {\n1582.                 pattern: \'\',\n1583.               },\n1584.               202: {\n1585.                 pattern: \'foo\',\n1586.               },\n1587.             },\n1588.           },\n1589.         },\n1590.       },\n1591.     ];\n1592.     return awsCompileApigEvents.compileMethods().then(() => {\n1593.       expect(\n1594.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1595.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1596.       ).to.deep.equal({\n1597.         StatusCode: \'202\',\n1598.         SelectionPattern: \'foo\',\n1599.         ResponseParameters: {},\n1600.         ResponseTemplates: {},\n1601.         ContentHandling: undefined,\n1602.       });\n1603.       expect(\n1604.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1605.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1606.       ).to.deep.equal({\n1607.         StatusCode: \'200\',\n1608.         SelectionPattern: \'\',\n1609.         ResponseParameters: {},\n1610.         ResponseTemplates: {},\n1611.         ContentHandling: undefined,\n1612.       });\n1613.     });\n1614.   });\n1615. \n1616.   it(\'should add fall back headers and template to statusCodes\', () => {\n1617.     awsCompileApigEvents.validated.events = [\n1618.       {\n1619.         functionName: \'First\',\n1620.         http: {\n1621.           method: \'GET\',\n1622.           path: \'users/list\',\n1623.           integration: \'AWS\',\n1624.           response: {\n1625.             headers: {\n1626.               \'Content-Type\': \'text/csv\',\n1627.             },\n1628.             template: \'foo\',\n1629.             statusCodes: {\n1630.               400: {\n1631.                 pattern: \'\',\n1632.               },\n1633.             },\n1634.           },\n1635.         },\n1636.       },\n1637.     ];\n1638.     return awsCompileApigEvents.compileMethods().then(() => {\n1639.       expect(\n1640.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1641.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1642.           .ResponseTemplates[\'application/json\']\n1643.       ).to.equal(\'foo\');\n1644.       expect(\n1645.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1646.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1647.           .ResponseParameters[\'method.response.header.Content-Type\']\n1648.       ).to.equal(\'text/csv\');\n1649.     });\n1650.   });\n1651. \n1652.   it(\'should add custom response codes\', () => {\n1653.     awsCompileApigEvents.validated.events = [\n1654.       {\n1655.         functionName: \'First\',\n1656.         http: {\n1657.           method: \'GET\',\n1658.           path: \'users/list\',\n1659.           integration: \'AWS\',\n1660.           response: {\n1661.             statusCodes: {\n1662.               200: {\n1663.                 pattern: \'\',\n1664.                 template: "$input.path(\'$.foo\')",\n1665.               },\n1666.               404: {\n1667.                 pattern: \'.*"statusCode":404,.*\',\n1668.                 template: "$input.path(\'$.errorMessage\')",\n1669.                 headers: {\n1670.                   \'Content-Type\': \'text/html\',\n1671.                 },\n1672.               },\n1673.             },\n1674.           },\n1675.         },\n1676.       },\n1677.     ];\n1678.     return awsCompileApigEvents.compileMethods().then(() => {\n1679.       expect(\n1680.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1681.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1682.           .ResponseTemplates[\'application/json\']\n1683.       ).to.equal("$input.path(\'$.foo\')");\n1684.       expect(\n1685.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1686.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1687.           .SelectionPattern\n1688.       ).to.equal(\'\');\n1689.       expect(\n1690.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1691.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1692.           .ResponseTemplates[\'application/json\']\n1693.       ).to.equal("$input.path(\'$.errorMessage\')");\n1694.       expect(\n1695.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1696.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1697.           .SelectionPattern\n1698.       ).to.equal(\'.*"statusCode":404,.*\');\n1699.       expect(\n1700.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1701.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1702.           .ResponseParameters[\'method.response.header.Content-Type\']\n1703.       ).to.equal(\'text/html\');\n1704.     });\n1705.   });\n1706. \n1707.   it(\'should add multiple response templates for a custom response codes\', () => {\n1708.     awsCompileApigEvents.validated.events = [\n1709.       {\n1710.         functionName: \'First\',\n1711.         http: {\n1712.           method: \'GET\',\n1713.           path: \'users/list\',\n1714.           integration: \'AWS\',\n1715.           response: {\n1716.             statusCodes: {\n1717.               200: {\n1718.                 template: "$input.path(\'$.foo\')",\n1719.                 headers: {\n1720.                   \'Content-Type\': \'text/csv\',\n1721.                 },\n1722.               },\n1723.               404: {\n1724.                 pattern: \'.*"statusCode":404,.*\',\n1725.                 template: {\n1726.                   \'application/json\': "$input.path(\'$.errorMessage\')",\n1727.                   \'application/xml\': "$input.path(\'$.xml.errorMessage\')",\n1728.                 },\n1729.                 headers: {\n1730.                   \'Content-Type\': \'text/html\',\n1731.                 },\n1732.               },\n1733.             },\n1734.           },\n1735.         },\n1736.       },\n1737.     ];\n1738.     return awsCompileApigEvents.compileMethods().then(() => {\n1739.       expect(\n1740.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1741.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1742.           .ResponseTemplates[\'application/json\']\n1743.       ).to.equal("$input.path(\'$.foo\')");\n1744.       expect(\n1745.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1746.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1747.           .SelectionPattern\n1748.       ).to.equal(\'\');\n1749.       expect(\n1750.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1751.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1752.           .ResponseParameters[\'method.response.header.Content-Type\']\n1753.       ).to.equal(\'text/csv\');\n1754.       expect(\n1755.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1756.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1757.           .ResponseTemplates[\'application/json\']\n1758.       ).to.equal("$input.path(\'$.errorMessage\')");\n1759.       expect(\n1760.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1761.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1762.           .ResponseTemplates[\'application/xml\']\n1763.       ).to.equal("$input.path(\'$.xml.errorMessage\')");\n1764.       expect(\n1765.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1766.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1767.           .SelectionPattern\n1768.       ).to.equal(\'.*"statusCode":404,.*\');\n1769.       expect(\n1770.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1771.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]\n1772.           .ResponseParameters[\'method.response.header.Content-Type\']\n1773.       ).to.equal(\'text/html\');\n1774.     });\n1775.   });\n1776. \n1777.   it(\'should use defined content-handling behavior\', () => {\n1778.     awsCompileApigEvents.validated.events = [\n1779.       {\n1780.         functionName: \'First\',\n1781.         http: {\n1782.           method: \'get\',\n1783.           path: \'users/list\',\n1784.           integration: \'AWS\',\n1785.           response: {\n1786.             contentHandling: \'CONVERT_TO_BINARY\',\n1787.             statusCodes: {\n1788.               200: {\n1789.                 pattern: \'\',\n1790.               },\n1791.             },\n1792.           },\n1793.         },\n1794.       },\n1795.     ];\n1796.     return awsCompileApigEvents.compileMethods().then(() => {\n1797.       expect(\n1798.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1799.           .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]\n1800.           .ContentHandling\n1801.       ).to.equal(\'CONVERT_TO_BINARY\');\n1802.     });\n1803.   });\n1804. \n1805.   it(\'should handle root resource methods\', () => {\n1806.     awsCompileApigEvents.validated.events = [\n1807.       {\n1808.         functionName: \'First\',\n1809.         http: {\n1810.           path: \'\',\n1811.           method: \'GET\',\n1812.         },\n1813.       },\n1814.     ];\n1815.     return awsCompileApigEvents.compileMethods().then(() => {\n1816.       expect(\n1817.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1818.           .ApiGatewayMethodGet.Properties.ResourceId\n1819.       ).to.deep.equal({\n1820.         \'Fn::GetAtt\': [\'ApiGatewayRestApi\', \'RootResourceId\'],\n1821.       });\n1822.     });\n1823.   });\n1824. \n1825.   it(\'should include operation id as OperationName when it is set\', () => {\n1826.     awsCompileApigEvents.validated.events = [\n1827.       {\n1828.         functionName: \'First\',\n1829.         http: {\n1830.           path: \'users/create\',\n1831.           method: \'post\',\n1832.           integration: \'AWS\',\n1833.           operationId: \'createUser\',\n1834.         },\n1835.       },\n1836.     ];\n1837.     return awsCompileApigEvents.compileMethods().then(() => {\n1838.       expect(\n1839.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1840.           .ApiGatewayMethodUsersCreatePost.Properties.OperationName\n1841.       ).to.equal(\'createUser\');\n1842.     });\n1843.   });\n1844. \n1845.   it(\'should not include operation id when it is not set\', () => {\n1846.     awsCompileApigEvents.validated.events = [\n1847.       {\n1848.         functionName: \'First\',\n1849.         http: {\n1850.           path: \'users/create\',\n1851.           method: \'post\',\n1852.           integration: \'AWS\',\n1853.         },\n1854.       },\n1855.     ];\n1856.     return awsCompileApigEvents.compileMethods().then(() => {\n1857.       expect(\n1858.         awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources\n1859.           .ApiGatewayMethodUsersCreatePost.Properties\n1860.       ).to.not.have.key(\'OperationName\');\n1861.     });\n1862.   });\n1863. });', start_line_number=1, end_line_number=1863), Context(relative_path='test/integration-all/api-gateway/tests.js', content='1. \'use strict\';\n2. \n3. const path = require(\'path\');\n4. const _ = require(\'lodash\');\n5. const { expect } = require(\'chai\');\n6. const log = require(\'log\').get(\'serverless:test\');\n7. const awsRequest = require(\'@serverless/test/aws-request\');\n8. \n9. const { getTmpDirPath, readYamlFile, writeYamlFile } = require(\'../../utils/fs\');\n10. const { confirmCloudWatchLogs } = require(\'../../utils/misc\');\n11. const {\n12.   createTestService,\n13.   deployService,\n14.   removeService,\n15.   fetch,\n16. } = require(\'../../utils/integration\');\n17. const { createRestApi, deleteRestApi, getResources } = require(\'../../utils/api-gateway\');\n18. \n19. describe(\'AWS - API Gateway Integration Test\', function() {\n20.   this.timeout(1000 * 60 * 10); // Involves time-taking deploys\n21.   let serviceName;\n22.   let endpoint;\n23.   let stackName;\n24.   let tmpDirPath;\n25.   let serverlessFilePath;\n26.   let restApiId;\n27.   let restApiRootResourceId;\n28.   let apiKey;\n29.   let isDeployed = false;\n30.   const stage = \'dev\';\n31. \n32.   const resolveEndpoint = async () => {\n33.     const result = await awsRequest(\'CloudFormation\', \'describeStacks\', { StackName: stackName });\n34.     const endpointOutput = result.Stacks[0].Outputs.find(\n35.       output => output.OutputKey === \'ServiceEndpoint\'\n36.     ).OutputValue;\n37.     endpoint = endpointOutput.match(/https:\\/\\/.+\\.execute-api\\..+\\.amazonaws\\.com.+/)[0];\n38.   };\n39. \n40.   before(async () => {\n41.     tmpDirPath = getTmpDirPath();\n42.     log.notice(`Temporary path: ${tmpDirPath}`);\n43.     serverlessFilePath = path.join(tmpDirPath, \'serverless.yml\');\n44.     const serverlessConfig = await createTestService(tmpDirPath, {\n45.       templateDir: path.join(__dirname, \'service\'),\n46.       serverlessConfigHook:\n47.         // Ensure unique API key for each test (to avoid collision among concurrent CI runs)\n48.         config => {\n49.           apiKey = `${config.service}-api-key-1`;\n50.           config.provider.apiKeys[0] = { name: apiKey, value: apiKey };\n51.         },\n52.     });\n53.     serviceName = serverlessConfig.service;\n54.     stackName = `${serviceName}-${stage}`;\n55.     log.notice(`Deploying "${stackName}" service...`);\n56.     await deployService(tmpDirPath);\n57.     isDeployed = true;\n58.     return resolveEndpoint();\n59.   });\n60. \n61.   after(async () => {\n62.     if (!isDeployed) return;\n63.     log.notice(\'Removing service...\');\n64.     await removeService(tmpDirPath);\n65.   });\n66. \n67.   describe(\'Minimal Setup\', () => {\n68.     const expectedMessage = \'Hello from API Gateway! - (minimal)\';\n69. \n70.     it(\'should expose an accessible GET HTTP endpoint\', () => {\n71.       const testEndpoint = `${endpoint}`;\n72. \n73.       return fetch(testEndpoint, { method: \'GET\' })\n74.         .then(response => response.json())\n75.         .then(json => expect(json.message).to.equal(expectedMessage));\n76.     });\n77. \n78.     it(\'should expose an accessible POST HTTP endpoint\', () => {\n79.       const testEndpoint = `${endpoint}/minimal-1`;\n80. \n81.       return fetch(testEndpoint, { method: \'POST\' })\n82.         .then(response => response.json())\n83.         .then(json => expect(json.message).to.equal(expectedMessage));\n84.     });\n85. \n86.     it(\'should expose an accessible PUT HTTP endpoint\', () => {\n87.       const testEndpoint = `${endpoint}/minimal-2`;\n88. \n89.       return fetch(testEndpoint, { method: \'PUT\' })\n90.         .then(response => response.json())\n91.         .then(json => expect(json.message).to.equal(expectedMessage));\n92.     });\n93. \n94.     it(\'should expose an accessible DELETE HTTP endpoint\', () => {\n95.       const testEndpoint = `${endpoint}/minimal-3`;\n96. \n97.       return fetch(testEndpoint, { method: \'DELETE\' })\n98.         .then(response => response.json())\n99.         .then(json => expect(json.message).to.equal(expectedMessage));\n100.     });\n101.   });\n102. \n103.   describe(\'CORS\', () => {\n104.     it(\'should setup simple CORS support via cors: true config\', () => {\n105.       const testEndpoint = `${endpoint}/simple-cors`;\n106. \n107.       return fetch(testEndpoint, { method: \'OPTIONS\' }).then(response => {\n108.         const headers = response.headers;\n109.         const allowHeaders = [\n110.           \'Content-Type\',\n111.           \'X-Amz-Date\',\n112.           \'Authorization\',\n113.           \'X-Api-Key\',\n114.           \'X-Amz-Security-Token\',\n115.           \'X-Amz-User-Agent\',\n116.         ].join(\',\');\n117.         expect(headers.get(\'access-control-allow-headers\')).to.equal(allowHeaders);\n118.         expect(headers.get(\'access-control-allow-methods\')).to.equal(\'OPTIONS,GET\');\n119.         expect(headers.get(\'access-control-allow-credentials\')).to.equal(null);\n120.         expect(headers.get(\'access-control-allow-origin\')).to.equal(\'*\');\n121.       });\n122.     });\n123. \n124.     it(\'should setup CORS support with complex object config\', () => {\n125.       const testEndpoint = `${endpoint}/complex-cors`;\n126. \n127.       return fetch(testEndpoint, { method: \'OPTIONS\' }).then(response => {\n128.         const headers = response.headers;\n129.         const allowHeaders = [\n130.           \'Content-Type\',\n131.           \'X-Amz-Date\',\n132.           \'Authorization\',\n133.           \'X-Api-Key\',\n134.           \'X-Amz-Security-Token\',\n135.           \'X-Amz-User-Agent\',\n136.         ].join(\',\');\n137.         expect(headers.get(\'access-control-allow-headers\')).to.equal(allowHeaders);\n138.         expect(headers.get(\'access-control-allow-methods\')).to.equal(\'OPTIONS,GET\');\n139.         expect(headers.get(\'access-control-allow-credentials\')).to.equal(\'true\');\n140.         expect(headers.get(\'access-control-allow-origin\')).to.equal(\'*\');\n141.       });\n142.     });\n143.   });\n144. \n145.   describe(\'Custom Authorizers\', () => {\n146.     let testEndpoint;\n147. \n148.     before(() => {\n149.       testEndpoint = `${endpoint}/custom-auth`;\n150.     });\n151. \n152.     it(\'should reject requests without authorization\', () => {\n153.       return fetch(testEndpoint).then(response => {\n154.         expect(response.status).to.equal(401);\n155.       });\n156.     });\n157. \n158.     it(\'should reject requests with wrong authorization\', () => {\n159.       return fetch(testEndpoint, {\n160.         headers: { Authorization: \'Bearer ShouldNotBeAuthorized\' },\n161.       }).then(response => {\n162.         expect(response.status).to.equal(401);\n163.       });\n164.     });\n165. \n166.     it(\'should authorize requests with correct authorization\', () => {\n167.       return fetch(testEndpoint, { headers: { Authorization: \'Bearer ShouldBeAuthorized\' } })\n168.         .then(response => response.json())\n169.         .then(json => {\n170.           expect(json.message).to.equal(\'Hello from API Gateway! - (customAuthorizers)\');\n171.           expect(json.event.requestContext.authorizer.principalId).to.equal(\'SomeRandomId\');\n172.           expect(json.event.headers.Authorization).to.equal(\'Bearer ShouldBeAuthorized\');\n173.         });\n174.     });\n175.   });\n176. \n177.   describe(\'API Keys\', () => {\n178.     let testEndpoint;\n179.     let startTime;\n180. \n181.     before(() => {\n182.       testEndpoint = `${endpoint}/api-keys`;\n183.       startTime = Date.now();\n184.     });\n185. \n186.     it(\'should succeed if correct API key is given\', async function self() {\n187.       const response = await fetch(testEndpoint, { headers: { \'X-API-Key\': apiKey } });\n188.       const result = await response.json();\n189.       // API Key may take a moment to propagate, retry\n190.       if (response.status === 403 && startTime > Date.now() - 1000 * 60 * 3) {\n191.         log.notice(\'API Key rejected, retry\');\n192.         return self();\n193.       }\n194.       expect(response.status).to.equal(200);\n195.       expect(result.message).to.equal(\'Hello from API Gateway! - (apiKeys)\');\n196.       return null;\n197.     });\n198. \n199.     it(\'should reject a request with an invalid API Key\', () => {\n200.       return fetch(testEndpoint).then(response => {\n201.         expect(response.status).to.equal(403);\n202.       });\n203.     });\n204.   });\n205. \n206.   describe(\'Using stage specific configuration\', () => {\n207.     before(async () => {\n208.       const serverless = readYamlFile(serverlessFilePath);\n209.       // enable Logs, Tags and Tracing\n210.       _.merge(serverless.provider, {\n211.         tags: {\n212.           foo: \'bar\',\n213.           baz: \'qux\',\n214.         },\n215.         tracing: {\n216.           apiGateway: true,\n217.         },\n218.         logs: {\n219.           restApi: true,\n220.         },\n221.       });\n222.       writeYamlFile(serverlessFilePath, serverless);\n223.       await deployService(tmpDirPath);\n224.     });\n225. \n226.     it(\'should update the stage without service interruptions\', () => {\n227.       // re-using the endpoint from the "minimal" test case\n228.       const testEndpoint = `${endpoint}`;\n229. \n230.       return confirmCloudWatchLogs(\n231.         `/aws/api-gateway/${stackName}`,\n232.         () =>\n233.           fetch(`${testEndpoint}`, { method: \'GET\' })\n234.             .then(response => response.json())\n235.             // Confirm that APIGW responds as expected\n236.             .then(json => expect(json.message).to.equal(\'Hello from API Gateway! - (minimal)\'))\n237.         // Confirm that CloudWatch logs for APIGW are written\n238.       ).then(events => expect(events.length > 0).to.equal(true));\n239.     });\n240.   });\n241. \n242.   describe(\'Integration Lambda Timeout\', () => {\n243.     it(\'should result with 504 status code\', () =>\n244.       fetch(`${endpoint}/integration-lambda-timeout`).then(response =>\n245.         expect(response.status).to.equal(504)\n246.       ));\n247.   });\n248. \n249.   // NOTE: this test should  be at the very end because we\'re using an external REST API here\n250.   describe(\'when using an existing REST API with stage specific configuration\', () => {\n251.     before(async () => {\n252.       // create an external REST API\n253.       const externalRestApiName = `${stage}-${serviceName}-ext-api`;\n254.       await createRestApi(externalRestApiName)\n255.         .then(restApiMeta => {\n256.           restApiId = restApiMeta.id;\n257.           return getResources(restApiId);\n258.         })\n259.         .then(resources => {\n260.           restApiRootResourceId = resources[0].id;\n261.           log.notice(\n262.             \'Created external rest API \' +\n263.               `(id: ${restApiId}, root resource id: ${restApiRootResourceId})`\n264.           );\n265.         });\n266. \n267.       const serverless = readYamlFile(serverlessFilePath);\n268.       // enable Logs, Tags and Tracing\n269.       _.merge(serverless.provider, {\n270.         apiGateway: {\n271.           restApiId,\n272.           restApiRootResourceId,\n273.         },\n274.         tags: {\n275.           foo: \'bar\',\n276.           baz: \'qux\',\n277.         },\n278.         tracing: {\n279.           apiGateway: true,\n280.         },\n281.         logs: {\n282.           restApi: true,\n283.         },\n284.       });\n285.       writeYamlFile(serverlessFilePath, serverless);\n286.       log.notice(\'Redeploying service (with external Rest API ID)...\');\n287.       await deployService(tmpDirPath);\n288.       return resolveEndpoint();\n289.     });\n290. \n291.     after(async () => {\n292.       // NOTE: deleting the references to the old, external REST API\n293.       const serverless = readYamlFile(serverlessFilePath);\n294.       delete serverless.provider.apiGateway.restApiId;\n295.       delete serverless.provider.apiGateway.restApiRootResourceId;\n296.       writeYamlFile(serverlessFilePath, serverless);\n297.       // NOTE: deploying once again to get the stack into the original state\n298.       log.notice(\'Redeploying service (without external Rest API ID)...\');\n299.       await deployService(tmpDirPath);\n300.       log.notice(\'Deleting external rest API...\');\n301.       return deleteRestApi(restApiId);\n302.     });\n303. \n304.     it(\'should update the stage without service interruptions\', () => {\n305.       // re-using the endpoint from the "minimal" test case\n306.       const testEndpoint = `${endpoint}/minimal-1`;\n307. \n308.       return fetch(testEndpoint, { method: \'POST\' })\n309.         .then(response => response.json())\n310.         .then(json => expect(json.message).to.equal(\'Hello from API Gateway! - (minimal)\'));\n311.     });\n312.   });\n313. });', start_line_number=1, end_line_number=313), Context(relative_path='test/integration-all/shared/utils.js', content="1. 'use strict';\n2. \n3. const logger = console;\n4. \n5. function getMarkers(functionName) {\n6.   return {\n7.     start: `--- START ${functionName} ---`,\n8.     end: `--- END ${functionName} ---`,\n9.   };\n10. }\n11. \n12. function log(functionName, message) {\n13.   const markers = getMarkers(functionName);\n14.   logger.log(markers.start);\n15.   logger.log(message);\n16.   logger.log(markers.end);\n17. }\n18. \n19. module.exports = {\n20.   getMarkers,\n21.   log,\n22. };", start_line_number=1, end_line_number=22), Context(relative_path='test/utils/api-gateway/index.js', content="1. 'use strict';\n2. \n3. const _ = require('lodash');\n4. const awsRequest = require('@serverless/test/aws-request');\n5. \n6. function createRestApi(name) {\n7.   const params = {\n8.     name,\n9.   };\n10. \n11.   return awsRequest('APIGateway', 'createRestApi', params);\n12. }\n13. \n14. function deleteRestApi(restApiId) {\n15.   const params = {\n16.     restApiId,\n17.   };\n18. \n19.   return awsRequest('APIGateway', 'deleteRestApi', params);\n20. }\n21. \n22. function getResources(restApiId) {\n23.   const params = {\n24.     restApiId,\n25.   };\n26. \n27.   return awsRequest('APIGateway', 'getResources', params).then(data => data.items);\n28. }\n29. \n30. function findRestApis(name) {\n31.   const params = {\n32.     limit: 500,\n33.   };\n34. \n35.   function recursiveFind(found, position) {\n36.     if (position) params.position = position;\n37.     return awsRequest('APIGateway', 'getRestApis', params).then(result => {\n38.       const matches = result.items.filter(restApi => restApi.name.match(name));\n39.       if (matches.length) {\n40.         _.merge(found, matches);\n41.       }\n42.       if (result.position) return recursiveFind(found, result.position);\n43.       return found;\n44.     });\n45.   }\n46. \n47.   return recursiveFind([]);\n48. }\n49. \n50. module.exports = {\n51.   createRestApi,\n52.   deleteRestApi,\n53.   getResources,\n54.   findRestApis,\n55. };", start_line_number=1, end_line_number=55)]
2025-11-13 20:05:22,879 - thread-135845287823040.prometheus.lang_graph.nodes.bug_get_regression_tests_selection_node - DEBUG - Model response: selected_tests=[RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: This test directly validates that a default application/json request mapping template is generated for AWS integrations, which is central to the issue about default request templates.\n2. Impact likelihood: Enabling removal/override of defaults must not unintentionally remove application/json defaults unless explicitly configured. This test ensures default behavior remains intact, making it likely to catch regressions.\n3. Not skipped: It is a unit test under the compile methods suite and runs in normal test executions.', test_identifier='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: The issue specifically references unwanted creation of the default application/x-www-form-urlencoded template. This test asserts that such a default exists today.\n2. Impact likelihood: Changes to allow removal of the default must not break legacy/default behavior when not opted out. This test will flag regressions if defaults are inadvertently removed.\n3. Not skipped: It’s a normal unit test executed during regular runs.', test_identifier='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: The issue requests a way to override/remove defaults. This test verifies that defaults can be overwritten via configuration, which is directly related to the intended change.\n2. Impact likelihood: Modifying how defaults are applied could break the overwrite mechanism. This test ensures the overwrite still works as expected.\n3. Not skipped: It is part of the standard unit test suite.', test_identifier='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: This test confirms that custom request templates are respected. When introducing removal/override of defaults, custom templates must continue to take precedence.\n2. Impact likelihood: Adjustments to default template logic could inadvertently alter or merge behavior for custom templates. This test would catch such regressions.\n3. Not skipped: It runs as part of the core unit tests.', test_identifier='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates'), RegressionTestStructuredOutPut(reasoning='1. Relevance to issue: The default request templates are typically applied to AWS integrations; for HTTP integrations, templates should remain undefined. This test asserts that no RequestTemplates are set for HTTP integration.\n2. Impact likelihood: Refactoring default template logic could accidentally introduce templates where they should not exist. This test will detect that regression.\n3. Not skipped: It’s a regular unit test executed in normal runs.', test_identifier='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type')]
2025-11-13 20:05:22,879 - thread-135845287823040.prometheus.lang_graph.nodes.bug_get_regression_tests_selection_node - DEBUG - 5 tests selected as regression tests
2025-11-13 20:05:22,881 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:05:22,881 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:05:27,936 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kXMzUkiCgC586pKhIz051PvH', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 282, 'prompt_tokens': 692, 'total_tokens': 974, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bbb59bef-93fe-48bb-b9b6-f42c23ecf8e0-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_kXMzUkiCgC586pKhIz051PvH', 'type': 'tool_call'}] usage_metadata={'input_tokens': 692, 'output_tokens': 282, 'total_tokens': 974, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:05:27,940 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:05:28,042 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:05:28,042 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1604
drwxr-xr-x   1 root root    4096 Aug 28 01:59 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 19:51 [01;34m..[0m
-rw-rw-r--   1 root root     273 Aug 28 01:59 .editorconfig
drwxrwxr-x   1 root root    4096 Aug 28 01:59 [01;34m.git[0m
drwxrwxr-x   4 root root    4096 Aug 28 01:59 [01;34m.github[0m
-rwxrwxr-x   1 root root      90 Aug 28 01:59 [01;32m.gitignore[0m
-rw-rw-r--   1 root root      28 Aug 28 01:59 .npmignore
-rw-rw-r--   1 root root      71 Aug 28 01:59 .prettierignore
-rw-rw-r--   1 root root  187937 Aug 28 01:59 CHANGELOG.md
-rw-rw-r--   1 root root    3292 Aug 28 01:59 CODE_OF_CONDUCT.md
-rw-rw-r--   1 root root    5668 Aug 28 01:59 CONTRIBUTING.md
-rw-rw-r--   1 root root     130 Aug 28 01:59 Dockerfile
-rw-rw-r--   1 root root    1086 Aug 28 01:59 LICENSE.txt
-rw-rw-r--   1 root root   13983 Aug 28 01:59 README.md
-rw-rw-r--   1 root root    7692 Aug 28 01:59 README_CN.md
-rw-rw-r--   1 root root    3191 Aug 28 01:59 RELEASE_PROCESS.md
-rw-rw-r--   1 root root    3896 Aug 28 01:59 VERSIONING.md
drwxrwxr-x   2 root root    4096 Aug 28 01:59 [01;34mbin[0m
-rw-rw-r--   1 root root    1313 Aug 28 01:59 commitlint.config.js
-rw-rw-r--   1 root root    3996 Aug 28 01:59 docker-compose.yml
drwxrwxr-x   5 root root    4096 Aug 28 01:59 [01;34mdocs[0m
drwxrwxr-x   5 root root    4096 Aug 28 01:59 [01;34mlib[0m
drwxr-xr-x 947 root root   36864 Aug 28 02:00 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1282306 Aug 28 01:59 package-lock.json
-rw-rw-r--   1 root root    6437 Aug 28 01:59 package.json
-rw-rw-r--   1 root root      86 Aug 28 01:59 prettier.config.js
drwxrwxr-x   3 root root    4096 Aug 28 01:59 [01;34mscripts[0m
drwxrwxr-x   8 root root    4096 Aug 28 01:59 [01;34mtest[0m
[?2004l
2025-11-13 20:05:30,741 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hqZSKyY4CZPkfhb5gHAhWvLW', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 239, 'prompt_tokens': 1567, 'total_tokens': 1806, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--df464538-e36c-4e53-b47e-6c84375467fa-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_hqZSKyY4CZPkfhb5gHAhWvLW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1567, 'output_tokens': 239, 'total_tokens': 1806, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:05:30,745 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:05:30,846 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:05:30,847 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/package/compile/event
ts/apiGateway/lib/method/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsCompileApigEvents = require('../../index');
const Serverless = require('../../../../../../../../Serverless');
const AwsProvider = require('../../../../../../provider/awsProvider');

describe('#compileMethods()', () => {
  let serverless;
  let awsCompileApigEvents;

  beforeEach(() => {
    const options = {
      stage: 'dev',
      region: 'us-east-1',
    };
    serverless = new Serverless();
    serverless.setProvider('aws', new AwsProvider(serverless, options));
    serverless.service.service = 'first-service';
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.service.environment = {
      stages: {
        dev: {
          regions: {
            'us-east-1': {
              vars: {
                IamRoleLambdaExecution:
                  'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
              },
            },
          },
        },
      },
    };
    serverless.service.functions.First = {};
    serverless.service.functions.Second = {};
    serverless.service.functions.Third = {};
    awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
    awsCompileApigEvents.validated = {};
    awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
    awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
    awsCompileApigEvents.apiGatewayResources = {
      'users/create': {
        name: 'UsersCreate',
        resourceLogicalId: 'ApiGatewayResourceUsersCreate',
      },

      'users/list': {
        name: 'UsersList',
        resourceLogicalId: 'ApiGatewayResourceUsersList',
      },
      'users/update': {
        name: 'UsersUpdate',
        resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
      },
      'users/delete': {
        name: 'UsersDelete',
        resourceLogicalId: 'ApiGatewayResourceUsersDelete',
      },
    };
  });

  it('should have request validators/models defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' } } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should support multiple request schemas', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
        'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should have request parameters defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
            },
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
[?2004l
2025-11-13 20:05:32,215 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9tgXZp1GgYE9Qvg2cRiQOkYS', 'function': {'arguments': '{"command":"sed -n \'200,500p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 3188, 'total_tokens': 3229, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4eb31f7c-3326-4db2-90e9-affd32e2a3d0-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,500p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_9tgXZp1GgYE9Qvg2cRiQOkYS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3188, 'output_tokens': 41, 'total_tokens': 3229, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:05:32,220 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,500p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:05:32,322 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:05:32,322 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,500p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
    });
  });

  it('should not have integration RequestParameters when no request parameters are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration
      ).to.not.have.key('RequestParameters');
    });
  });

  it('should create method resources when http events given', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Type
      ).to.equal('AWS::ApiGateway::Method');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Type
      ).to.equal('AWS::ApiGateway::Method');
    });
  });

  it('should support AWS integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support AWS_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS_PROXY');
    });
  });

  it('should support HTTP integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('POST');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
      ).to.equal(undefined);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support HTTP integration type with custom request options', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            method: 'put',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PUT');
    });
  });

  it('should support HTTP_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            method: 'patch',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP_PROXY');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PATCH');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support MOCK integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'MOCK',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('MOCK');
    });
  });

  it('should add request parameter when async config is used', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

[?2004l
2025-11-13 20:05:34,093 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_RF62qHqLJ5ygpXP9CW1ytaDE', 'function': {'arguments': '{"command":"sed -n \'500,1000p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 42, 'prompt_tokens': 5534, 'total_tokens': 5576, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--49504b71-6327-4930-9189-f084f8c782e1-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '500,1000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_RF62qHqLJ5ygpXP9CW1ytaDE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5534, 'output_tokens': 42, 'total_tokens': 5576, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:05:34,096 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '500,1000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:05:34,199 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:05:34,199 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '500,1000p' lib/plugins/aws/package/compile/ev
vents/apiGateway/lib/method/index.test.js
[?2004l

  it('should add request parameter when integration type is AWS_PROXY and async', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter mapped value when explicitly defined', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.querystring.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.path.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.path.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.header.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.header.bar': {
                required: false,
                mappedValue: 'barValue',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'fooValue',
        'integration.request.querystring.bar': 'barValue',
        'integration.request.path.foo': 'fooValue',
        'integration.request.path.bar': 'barValue',
        'integration.request.header.foo': 'fooValue',
        'integration.request.header.bar': 'barValue',
      });
    });
  });

  it('should set authorizer config for AWS_IAM', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'AWS_IAM',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('AWS_IAM');
    });
  });

  it('should set custom authorizer config with authorizerId', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'COGNITO_USER_POOLS',
            authorizerId: 'gy7lyj',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
      ).to.equal('gy7lyj');
    });
  });

  it('should set authorizer config if given as ARN string', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'Authorizer',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('CUSTOM');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('CognitoAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            arn: {
              'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
            },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should not scopes for a cognito user pool when given empty scopes array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: [],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.property('AuthorizationScopes');
    });
  });

  it('should set claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
    });
  });

  it('should set multiple claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'gender'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
    });
  });

  it('should properly set claims for custom properties inside the cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'custom:score'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
    });
  });

  it('should replace the extra claims in the template if there are none', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/extraCognitoPoolClaims/);
    });
  });

  it('should not create method resources when http events are not given', () => {
    awsCompileApigEvents.validated.events = [];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });

  it('should update the method logical ids array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
        'ApiGatewayMethodUsersCreatePost',
        'ApiGatewayMethodUsersListGet',
      ]);
    });
  });

  it('should set api key as required if private endpoint', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          private: true,
        },
      },
    ];
[?2004l
2025-11-13 20:05:35,618 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_zJjfk3pZJRHPa7vnZexJuWxt', 'function': {'arguments': '{"command":"sed -n \'1000,1500p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 9370, 'total_tokens': 9413, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1536}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5d5f018c-c871-4fc9-ab0d-c529d0c4110d-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1000,1500p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_zJjfk3pZJRHPa7vnZexJuWxt', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9370, 'output_tokens': 43, 'total_tokens': 9413, 'input_token_details': {'audio': 0, 'cache_read': 1536}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:05:35,621 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1000,1500p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:05:35,723 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:05:35,724 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1000,1500p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(true);
    });
  });

  it('should set api key as not required if private property is not specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(false);
    });
  });

  it('should set the correct lambdaUri', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
    });
  });

  it('Should point target alias if set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'Provisioned',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    serverless.service.functions.Provisioned = {
      targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
    };
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
            ':',
            'provisioned',
            '/invocations',
          ],
        ],
      });
    });
  });

  it('should add CORS origins to method only when CORS is enabled', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Third',
        http: {
          path: 'users/update',
          method: 'PUT',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
          cors: {
            origins: ['*'],
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'http://example.com'");

      // CORS not enabled!
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.not.equal("'*'");

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'*'");
    });
  });

  it('should set CORS allowCredentials to method only when specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
            allowCredentials: true,
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.equal('true');

      // allowCredentials not enabled
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.not.equal('true');
    });
  });

  describe('when dealing with request configuration', () => {
    it('should setup a default "application/json" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should setup a default "application/x-www-form-urlencoded" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/x-www-form-urlencoded'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should use defined pass-through behavior', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              passThrough: 'WHEN_NO_TEMPLATES',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
        ).to.equal('WHEN_NO_TEMPLATES');
      });
    });

    it('should use defined content-handling behavior (request)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              contentHandling: 'CONVERT_TO_TEXT',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
        ).to.equal('CONVERT_TO_TEXT');
      });
    });

    it('should use defined response content-handling behavior for 2XX only (response)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              contentHandling: 'CONVERT_TO_BINARY',
              statusCodes: {
                200: {
                  pattern: '',
                },
                400: {
                  pattern: '400',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ContentHandling
        ).to.equal('CONVERT_TO_BINARY');
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
            .ContentHandling
        ).to.equal(undefined);
      });
    });

    it('should set custom request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'template/1': '{ "stage" : "$context.stage" }',
                'template/2': '{ "httpMethod" : "$context.httpMethod" }',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
        ).to.equal('{ "stage" : "$context.stage" }');

        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
        ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
      });
    });

    it('should be possible to overwrite default request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'application/json': 'overwritten-request-template-content',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.equal('overwritten-request-template-content');
      });
    });
  });

  describe('when dealing with response configuration', () => {
    it('should set the custom headers', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                  headers: {
                    'Content-Type': "'text/plain'",
                    'My-Custom-Header': 'my/custom/header',
                  },
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.Content-Type']
        ).to.equal("'text/plain'");
[?2004l
2025-11-13 20:05:49,675 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_iAILzSaoTtlrbDqGsZAe4Jjg', 'function': {'arguments': '{"command":"sed -n \'1500,2000p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 12546, 'total_tokens': 12589, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ac2db0ce-e5b2-4294-a262-e5bdccb901a2-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1500,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_iAILzSaoTtlrbDqGsZAe4Jjg', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12546, 'output_tokens': 43, 'total_tokens': 12589, 'input_token_details': {'audio': 0, 'cache_read': 3200}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:05:49,679 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1500,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:05:49,781 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:05:49,782 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1500,2000p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
        ).to.equal("'text/plain'");
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.My-Custom-Header']
        ).to.equal('my/custom/header');
      });
    });

    it('should set the custom template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  template: "$input.path('$.foo')",
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseTemplates['application/json']
        ).to.equal("$input.path('$.foo')");
      });
    });
  });

  it('should add method responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
      ).to.equal('200');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
      ).to.equal('202');
    });
  });

  it('should add integration responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
      ).to.deep.equal({
        StatusCode: '202',
        SelectionPattern: 'foo',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
      ).to.deep.equal({
        StatusCode: '200',
        SelectionPattern: '',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
    });
  });

  it('should add fall back headers and template to statusCodes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            headers: {
              'Content-Type': 'text/csv',
            },
            template: 'foo',
            statusCodes: {
              400: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal('foo');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
    });
  });

  it('should add custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
                template: "$input.path('$.foo')",
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: "$input.path('$.errorMessage')",
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should add multiple response templates for a custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                template: "$input.path('$.foo')",
                headers: {
                  'Content-Type': 'text/csv',
                },
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: {
                  'application/json': "$input.path('$.errorMessage')",
                  'application/xml': "$input.path('$.xml.errorMessage')",
                },
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/xml']
      ).to.equal("$input.path('$.xml.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should use defined content-handling behavior', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            contentHandling: 'CONVERT_TO_BINARY',
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ContentHandling
      ).to.equal('CONVERT_TO_BINARY');
    });
  });

  it('should handle root resource methods', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: '',
          method: 'GET',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodGet.Properties.ResourceId
      ).to.deep.equal({
        'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
      });
    });
  });

  it('should include operation id as OperationName when it is set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          operationId: 'createUser',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.OperationName
      ).to.equal('createUser');
    });
  });

  it('should not include operation id when it is not set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.key('OperationName');
    });
  });
});
[?2004l
2025-11-13 20:05:52,914 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_grJzYtzkAzi7ZmPF9lt8gPF5', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 15170, 'total_tokens': 15260, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12544}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9231ae9c-8234-4d12-93be-31873935c157-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_grJzYtzkAzi7ZmPF9lt8gPF5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15170, 'output_tokens': 90, 'total_tokens': 15260, 'input_token_details': {'audio': 0, 'cache_read': 12544}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:05:52,918 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:05:53,020 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:05:53,020 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.80.0",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "author": "serverless.com",
  "repository": "serverless/serverless",
  "keywords": [
    "serverless",
    "lambda",
    "aws",
    "amazon",
    "azure",
    "google-cloud",
    "apache-open-whisk",
    "iot"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "dependencies": {
    "@serverless/cli": "^1.5.2",
    "@serverless/components": "^2.34.7",
    "@serverless/enterprise-plugin": "^3.8.1",
    "@serverless/inquirer": "^1.1.2",
    "@serverless/utils": "^1.2.0",
    "ajv": "^6.12.4",
    "ajv-keywords": "^3.5.2",
    "archiver": "^3.1.1",
    "aws-sdk": "^2.739.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.1",
    "d": "^1.0.1",
    "dayjs": "^1.8.34",
    "decompress": "^4.2.1",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^8.1.0",
    "get-stdin": "^6.0.0",
    "globby": "^9.2.0",
    "graceful-fs": "^4.2.4",
    "https-proxy-agent": "^5.0.0",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.2.0",
    "js-yaml": "^3.14.0",
    "json-cycle": "^1.3.0",
    "json-refs": "^3.0.15",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.20",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.4",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.1.0",
    "node-fetch": "^2.6.0",
    "object-hash": "^2.0.3",
    "p-limit": "^2.3.0",
    "promise-queue": "^2.2.5",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^6.3.0",
    "semver-regex": "^2.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "timers-ext": "^0.1.7",
    "type": "^2.1.0",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^3.4.0",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^18.1.3"
  },
  "devDependencies": {
    "@commitlint/cli": "^9.1.2",
    "@serverless/eslint-config": "^2.2.0",
    "@serverless/test": "^4.6.0",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "cos-nodejs-sdk-v5": "^2.6.2",
    "eslint": "^7.7.0",
    "eslint-plugin-import": "^2.22.0",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "husky": "^4.2.5",
    "jszip": "^3.5.0",
    "lint-staged": "^10.2.13",
    "log": "^6.0.0",
    "mocha": "^6.2.3",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^15.1.0",
    "pkg": "^4.4.9",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^8.1.1",
    "sinon-chai": "^3.5.0",
    "standard-version": "^8.0.2",
    "strip-ansi": "^5.2.0",
    "ws": "^7.3.1",
    "xml2js": "^0.4.23"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node/6",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/**"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "!/.github",
    "/lib/plugins/create/templates/**",
    "/lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./test/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      ".github",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "test/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    },
    "types": [
      {
        "type": "feat",
        "section": "Features"
      },
      {
        "type": "fix",
        "section": "Bug Fixes"
      },
      {
        "type": "perf",
        "section": "Performance Improvements"
      },
      {
        "type": "refactor",
        "section": "Maintanance Improvements"
      }
    ]
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.js": [
      "eslint"
    ],
    "*.{css,html,js,json,md,yaml,yml}": [
      "prettier -c"
    ]
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node test/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 test/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha test/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check test/integration-package/**/*.tests.js",
    "lint": "eslint .",
    "lint:updated": "pipe-git-updated --ext=js -- eslint",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload/index.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "engines": {
    "node": ">=6.0"
  },
  "license": "MIT"
}
[?2004l
2025-11-13 20:06:03,048 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ch4S04ikMMqa72Zl6kaTI3Uc', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should setup a default \\\\\\"application/json\\\\\\" template\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 828, 'prompt_tokens': 17449, 'total_tokens': 18277, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 15104}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--713f2dcd-1ddb-41a4-b927-bc1098b0ed54-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\"application/json\\" template"'}, 'id': 'call_ch4S04ikMMqa72Zl6kaTI3Uc', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17449, 'output_tokens': 828, 'total_tokens': 18277, 'input_token_details': {'audio': 0, 'cache_read': 15104}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 20:06:03,052 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \"application/json\" template"
2025-11-13 20:06:04,174 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:06:04,174 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/json\" template"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:272) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (28ms)[0m

[?2004l
2025-11-13 20:06:10,856 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_lbjjeLSW9ze8el3pQDgEUQ2T', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should setup a default \\\\\\"application/x-www-form-urlencoded\\\\\\" template\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 511, 'prompt_tokens': 17751, 'total_tokens': 18262, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5504}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f7f8fc54-5cc9-4b56-b8b9-3068e05a8942-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\"application/x-www-form-urlencoded\\" template"'}, 'id': 'call_lbjjeLSW9ze8el3pQDgEUQ2T', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17751, 'output_tokens': 511, 'total_tokens': 18262, 'input_token_details': {'audio': 0, 'cache_read': 5504}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:06:10,860 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \"application/x-www-form-urlencoded\" template"
2025-11-13 20:06:11,881 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:06:11,881 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/x-www-form-urlencoded\" template"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:279) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m

[?2004l
2025-11-13 20:06:14,042 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yGZfJQg3j1cnBNnBjvd5iUh2', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should be possible to overwrite default request templates\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 51, 'prompt_tokens': 18062, 'total_tokens': 18113, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ec601388-ae58-42d8-a817-2ae80b610331-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should be possible to overwrite default request templates"'}, 'id': 'call_yGZfJQg3j1cnBNnBjvd5iUh2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18062, 'output_tokens': 51, 'total_tokens': 18113, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:06:14,045 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should be possible to overwrite default request templates"
2025-11-13 20:06:15,056 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:06:15,056 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should be possible to ov
verwrite default request templates"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:286) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:06:17,682 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VTC2r1z78iqbp9FSZghY0cyD', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should set custom request templates\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 48, 'prompt_tokens': 18361, 'total_tokens': 18409, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b0d49067-2924-4859-a08e-f6128b9105eb-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should set custom request templates"'}, 'id': 'call_VTC2r1z78iqbp9FSZghY0cyD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18361, 'output_tokens': 48, 'total_tokens': 18409, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:06:17,686 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should set custom request templates"
2025-11-13 20:06:18,704 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:06:18,704 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should set custom reques
st templates"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:293) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

[?2004l
2025-11-13 20:06:21,302 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_d9QaztxVsd3SKRMDVlr61X33', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should support HTTP integration type\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 48, 'prompt_tokens': 18651, 'total_tokens': 18699, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a01b0a17-04a7-4683-a504-6a9fbf846c92-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type"'}, 'id': 'call_d9QaztxVsd3SKRMDVlr61X33', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18651, 'output_tokens': 48, 'total_tokens': 18699, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:06:21,305 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type"
2025-11-13 20:06:22,307 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:06:22,307 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP inte
egration type"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:300) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m
  [32m  ✓[0m[90m should support HTTP integration type with custom request options[0m


[92m [0m[32m 2 passing[0m[90m (24ms)[0m

[?2004l
2025-11-13 20:06:42,789 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\\n\\"application/json\\" template"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:272) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/json" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (28ms)\x1b[0m\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\\n\\"application/x-www-form-urlencoded\\" template"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:279) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/x-www-form-urlencoded" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (23ms)\x1b[0m\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should be possible to ov\nverwrite default request templates"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:286) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should be possible to overwrite default request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (22ms)\x1b[0m\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should set custom reques\nst templates"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:293) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should set custom request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (21ms)\x1b[0m\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP inte\negration type"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n(node:300) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n  \x1b[32m  ✓\x1b[0m\x1b[90m should support HTTP integration type\x1b[0m\n  \x1b[32m  ✓\x1b[0m\x1b[90m should support HTTP integration type with custom request options\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 2 passing\x1b[0m\x1b[90m (24ms)\x1b[0m\n\nTotal tests run: 6\nAll selected tests: Pass' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2951, 'prompt_tokens': 18957, 'total_tokens': 21908, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1792, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9344}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--6bfc7c28-f2d8-4d6e-b9d1-389da10182a1-0' usage_metadata={'input_tokens': 18957, 'output_tokens': 2951, 'total_tokens': 21908, 'input_token_details': {'audio': 0, 'cache_read': 9344}, 'output_token_details': {'audio': 0, 'reasoning': 1792}}
2025-11-13 20:06:42,792 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/json\" template"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:272) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (28ms)[0m

 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/x-www-form-urlencoded\" template"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:279) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m

 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should be possible to ov
verwrite default request templates"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:286) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should set custom reques
st templates"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:293) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP inte
egration type"

[0m[0m
[0m  #compileMethods()[0m
(node:300) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m
  [32m  ✓[0m[90m should support HTTP integration type with custom request options[0m


[92m [0m[32m 2 passing[0m[90m (24ms)[0m

Total tests run: 6
All selected tests: Pass
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:06:59,976 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type'] regression_test_fail_log='' total_tests_run=6
2025-11-13 20:06:59,978 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:06:59,978 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:06:59,979 - thread-135845287823040.prometheus.lang_graph.nodes.bug_get_regression_tests_subgraph_node - DEBUG - Selected 5 regression tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:06:59,980 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_context_message_node - DEBUG - Sending query to context provider:
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

2025-11-13 20:06:59,982 - thread-135845287823040.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Enter context retrieval subgraph
2025-11-13 20:06:59,985 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

--- END ORIGINAL QUERY ---



All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:07:19,166 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The feature request concerns default API Gateway request mapping templates. The file tree shows the relevant aws package/compile events directory but not its code contents. To understand and implement an override, we need to inspect the actual integration builder where defaults are set and the surrounding modules that parse event config and construct API Gateway methods, plus the related documentation to see current options and conventions. Without these implementation details, we cannot identify integration points or patterns.' query='Please provide the contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, plus any modules they import that handle request templates.' extra_requirements='If sending all files is too large, include at minimum the sections that define default request mapping templates, how http event request templates are read from config, and the docs/providers/aws/events/apigateway.md file.' purpose='These files will show where the default templates are created and how to integrate an option to disable or override them following existing architecture and conventions.'
2025-11-13 20:07:19,167 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, plus any modules they import that handle request templates.
2025-11-13 20:07:23,138 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 20:07:23,138 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 20:07:23,138 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 20:07:23,138 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 20:07:23,140 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 20:07:23,141 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 20:07:23,141 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, plus any modules they import that handle request templates.
Extra requirements: If sending all files is too large, include at minimum the sections that define default request mapping templates, how http event request templates are read from config, and the docs/providers/aws/events/apigateway.md file.
Purpose: These files will show where the default templates are created and how to integrate an option to disable or override them following existing architecture and conventions.
2025-11-13 20:07:27,693 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_LZOpyhFbwmNBkrOgifgz7Wlq', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 360, 'prompt_tokens': 2298, 'total_tokens': 2658, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7e4f6ae6-8701-4357-ab1a-48fe487e018b-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/index.js'}, 'id': 'call_LZOpyhFbwmNBkrOgifgz7Wlq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2298, 'output_tokens': 360, 'total_tokens': 2658, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:07:31,240 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_y12BV7qEY7fhkr6zUYuXPOj1', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 236, 'prompt_tokens': 3499, 'total_tokens': 3735, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6f9de19a-1a3f-4510-a238-c39f9b51b70a-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_y12BV7qEY7fhkr6zUYuXPOj1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3499, 'output_tokens': 236, 'total_tokens': 3735, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:07:34,115 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_GXg8RXRHZNxcdolFLVobbr4q', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 171, 'prompt_tokens': 6326, 'total_tokens': 6497, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 128, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fd0dbe0d-ca37-4bdc-b8a0-39484b00ef94-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js'}, 'id': 'call_GXg8RXRHZNxcdolFLVobbr4q', 'type': 'tool_call'}] usage_metadata={'input_tokens': 6326, 'output_tokens': 171, 'total_tokens': 6497, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 128}}
2025-11-13 20:07:35,518 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_tHFYlhtjD0vCO96dFGgWgNb1', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 30, 'prompt_tokens': 7882, 'total_tokens': 7912, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--28924788-24f2-4c83-beb5-b4fc695e9c00-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_tHFYlhtjD0vCO96dFGgWgNb1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7882, 'output_tokens': 30, 'total_tokens': 7912, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:07:37,874 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ut2OMUF3AVf3GMH0fLUnag19', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 7964, 'total_tokens': 7995, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--67e1be27-e471-4955-977b-5573fb57b84b-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_ut2OMUF3AVf3GMH0fLUnag19', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7964, 'output_tokens': 31, 'total_tokens': 7995, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:07:44,300 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kgEiBt1c5uL52MSb2UOs9r8q', 'function': {'arguments': '{"text":"Default Request Templates"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 669, 'prompt_tokens': 13896, 'total_tokens': 14565, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 7808}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a017588a-41a6-434f-91bb-e736b1035ac8-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'Default Request Templates'}, 'id': 'call_kgEiBt1c5uL52MSb2UOs9r8q', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13896, 'output_tokens': 669, 'total_tokens': 14565, 'input_token_details': {'audio': 0, 'cache_read': 7808}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:08:03,840 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='I fetched the full contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js. I also retrieved lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js since it’s imported and modifies request templates. Additionally, I opened docs/providers/aws/events/apigateway.md and extracted the “Request templates” section, including “Default Request Templates” and “Custom Request Templates.” This covers where default templates are defined, how http event request templates are read from config, and the related documentation.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1726, 'prompt_tokens': 18462, 'total_tokens': 20188, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1600, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--f86dc3a1-e4df-4165-9245-db5677500358-0' usage_metadata={'input_tokens': 18462, 'output_tokens': 1726, 'total_tokens': 20188, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1600}}
2025-11-13 20:08:03,843 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, plus any modules they import that handle request templates.
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If sending all files is too large, include at minimum the sections that define default request mapping templates, how http event request templates are read from config, and the docs/providers/aws/events/apigateway.md file.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
These files will show where the default templates are created and how to integrate an option to disable or override them following existing architecture and conventions.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: CHANGELOG.md
Line number range: 1603 - 1703
Content:
## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.32.0...v1.33.0)

# 1.32.0 (2018-09-17)

- [Update quick-start.md](https://github.com/serverless/serverless/pull/5290)
- [Backend state item generation and multi-region support](https://github.com/serverless/serverless/pull/5265)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.31.0...v1.32.0)

# 1.31.0 (2018-09-11)

- [Add support for Cloudflare Workers](https://github.com/serverless/serverless/pull/5258)
- [docs: Fix mismatch in AWS Metrics](https://github.com/serverless/serverless/pull/5276)
- [Add new template for AWS Alexa Typescript](https://github.com/serverless/serverless/pull/5266)
- [Remove `/tmp/node-dependencies*`](https://github.com/serverless/serverless/pull/5079)
- [Adds FilterPolicy to SNS event](https://github.com/serverless/serverless/pull/5229)
- [Update API Gateway Default Request Templates](https://github.com/serverless/serverless/pull/5222)
- [Update serverless.yml.md](https://github.com/serverless/serverless/pull/5236)
- [Fix for #3069 - Failing to handle schedule event body params](https://github.com/serverless/serverless/pull/5268)
- [Remove redundant link to same docs page](https://github.com/serverless/serverless/pull/5243)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.30.3...v1.31.0)

# 1.30.3 (2018-08-28)

- [Fix CORS race condition](https://github.com/serverless/serverless/pull/5256)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.30.2...v1.30.3)

# 1.30.2 (2018-08-28)

- [Fixed a bug when using DynamoDB events with Serverless Platform](https://github.com/serverless/serverless/pull/5237)
- [Fixed a bug when using deep variable references](https://github.com/serverless/serverless/pull/5224)
- [Fixed an issue with Makefile of the aws-go-dep template](https://github.com/serverless/serverless/pull/5227)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.30.1...v1.30.2)

# 1.30.1 (2018-08-16)

- [Fix CI deployment to Serverless Platform](https://github.com/serverless/serverless/issues/5182)
- [Fix a minor resources ID issue on Serverless Platform](https://github.com/serverless/serverless/pull/5208)
- [Update nodejs template to 8.10](https://github.com/serverless/serverless/pull/5088)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.30.0...v1.30.1)

# 1.30.0 (2018-08-09)

- [Added support for multiple access keys for multiple tenants](https://github.com/serverless/serverless/pull/5189)
- [Fixed a publishing bug when having more than 100 resources](https://github.com/serverless/serverless/pull/5189)
- [Add Windows support for spawning mvn](https://github.com/serverless/serverless/pull/5028)
- [Update spawn API with {shell=true}](https://github.com/serverless/serverless/pull/5192)
- [AWS Clojurescript Gradle Template](https://github.com/serverless/serverless/pull/5147)
- [Use latest dotnet runtime in AWS Lambda](https://github.com/serverless/serverless/pull/5107)
- [Ignore null errors to allow resolution instead of rejection on undefined SSM variables](https://github.com/serverless/serverless/pull/5119)
- [Fixed a bug when using deep variable references](https://github.com/serverless/serverless/pull/5156)
- [Add support for installing templates and boilerplates from GitLab](https://github.com/serverless/serverless/pull/5116)
- [Fixed that create command didn't use the service name given as -n option](https://github.com/serverless/serverless/pull/5082)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.29.2...v1.30.0)

# 1.29.2 (2018-07-29)

- [Fixed a bug when using APIG lambda integration with Serverless Dashboard](https://github.com/serverless/serverless/pull/5174)
- [Fixed a bug by transforming env var to string when setting num value](https://github.com/serverless/serverless/pull/5166)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.29.1...v1.29.2)

# 1.29.1 (2018-07-28)

- [Fixed a bug when using APIG root path with Serverless Dashboard](https://github.com/serverless/serverless/pull/5170)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.29.0...v1.29.1)

# 1.29.0 (2018-07-26)

- [Fixes issue with Node 10.7.0](https://github.com/serverless/serverless/issues/5133)
- [Serverless Dashboard Updates: Subscriptions, Resources, Deploys and Refresh Tokens](https://github.com/serverless/serverless/pull/5127)
- [Support `invoke local` of AWS Lambda Async Functions](https://github.com/serverless/serverless/pull/4912)
- [Improve aws-scala-sbt template](https://github.com/serverless/serverless/pull/5086)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.28.0...v1.29.0)


File: docs/providers/aws/events/apigateway.md
Line number range: 1 - 501
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - API Gateway
3. menuText: API Gateway
4. menuOrder: 1
5. description: Setting up AWS API Gateway Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/apigateway)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # API Gateway
16. 
17. - [API Gateway](#api-gateway)
18.   - [Lambda Proxy Integration](#lambda-proxy-integration)
19.     - [Simple HTTP Endpoint](#simple-http-endpoint)
20.     - [Example "LAMBDA-PROXY" event (default)](#example-lambda-proxy-event-default)
21.     - [HTTP Endpoint with Extended Options](#http-endpoint-with-extended-options)
22.     - [Enabling CORS](#enabling-cors)
23.     - [HTTP Endpoints with `AWS_IAM` Authorizers](#http-endpoints-with-aws_iam-authorizers)
24.     - [HTTP Endpoints with Custom Authorizers](#http-endpoints-with-custom-authorizers)
25.     - [HTTP Endpoints with `operationId`](#http-endpoints-with-operationId)
26.     - [Catching Exceptions In Your Lambda Function](#catching-exceptions-in-your-lambda-function)
27.     - [Setting API keys for your Rest API](#setting-api-keys-for-your-rest-api)
28.     - [Configuring endpoint types](#configuring-endpoint-types)
29.     - [Request Parameters](#request-parameters)
30.     - [Request Schema Validators](#request-schema-validators)
31.     - [Setting source of API key for metering requests](#setting-source-of-api-key-for-metering-requests)
32.   - [Lambda Integration](#lambda-integration)
33.     - [Example "LAMBDA" event (before customization)](#example-lambda-event-before-customization)
34.     - [Request templates](#request-templates)
35.       - [Default Request Templates](#default-request-templates)
36.       - [Custom Request Templates](#custom-request-templates)
37.       - [Pass Through Behavior](#pass-through-behavior)
38.     - [Responses](#responses)
39.       - [Custom Response Headers](#custom-response-headers)
40.       - [Custom Response Templates](#custom-response-templates)
41.     - [Status Codes](#status-codes)
42.       - [Available Status Codes](#available-status-codes)
43.       - [Using Status Codes](#using-status-codes)
44.       - [Custom Status Codes](#custom-status-codes)
45.   - [Setting an HTTP Proxy on API Gateway](#setting-an-http-proxy-on-api-gateway)
46.   - [Accessing private resources using VPC Link](#accessing-private-resources-using-vpc-link)
47.   - [Mock Integration](#mock-integration)
48.   - [Share API Gateway and API Resources](#share-api-gateway-and-api-resources)
49.     - [Easiest and CI/CD friendly example of using shared API Gateway and API Resources.](#easiest-and-cicd-friendly-example-of-using-shared-api-gateway-and-api-resources)
50.     - [Manually Configuring shared API Gateway](#manually-configuring-shared-api-gateway)
51.       - [Note while using authorizers with shared API Gateway](#note-while-using-authorizers-with-shared-api-gateway)
52.   - [Share Authorizer](#share-authorizer)
53.   - [Resource Policy](#resource-policy)
54.   - [Compression](#compression)
55.   - [Binary Media Types](#binary-media-types)
56.   - [Detailed CloudWatch Metrics](#detailed-cloudwatch-metrics)
57.   - [AWS X-Ray Tracing](#aws-x-ray-tracing)
58.   - [Tags / Stack Tags](#tags--stack-tags)
59.   - [Logs](#logs)
60. 
61. _Are you looking for tutorials on using API Gateway? Check out the following resources:_
62. 
63. > - [Add a custom domain for your API Gateway](https://serverless.com/blog/serverless-api-gateway-domain/)
64. > - [Deploy multiple micro-services under the same domain](https://serverless.com/blog/api-gateway-multiple-services/)
65. > - [Create a Node REST API with Express.js](https://serverless.com/blog/serverless-express-rest-api/)
66. > - [Make a Serverless GraphQL API](https://serverless.com/blog/make-serverless-graphql-api-using-lambda-dynamodb/)
67. 
68. To create HTTP endpoints as Event sources for your AWS Lambda Functions, use the Serverless Framework's easy AWS API Gateway Events syntax.
69. 
70. There are five ways you can configure your HTTP endpoints to integrate with your AWS Lambda Functions:
71. 
72. - `lambda-proxy` / `aws-proxy` / `aws_proxy` (Recommended)
73. - `lambda` / `aws`
74. - `http`
75. - `http-proxy` / `http_proxy`
76. - `mock`
77. 
78. **The Framework uses the `lambda-proxy` method (i.e., everything is passed into your Lambda) by default unless another method is supplied by the user**
79. 
80. The difference between these is `lambda-proxy` (alternative writing styles are `aws-proxy` and `aws_proxy` for compatibility with the standard AWS integration type naming) automatically passes the content of the HTTP request into your AWS Lambda function (headers, body, etc.) and allows you to configure your response (headers, status code, body) in the code of your AWS Lambda Function. Whereas, the `lambda` method makes you explicitly define headers, status codes, and more in the configuration of each API Gateway Endpoint (not in code). We highly recommend using the `lambda-proxy` method if it supports your use-case, since the `lambda` method is highly tedious.
81. 
82. Use `http` for integrating with an HTTP back end, `http-proxy` for integrating with the HTTP proxy integration or `mock` for testing without actually invoking the back end.
83. 
84. ## Lambda Proxy Integration
85. 
86. ### Simple HTTP Endpoint
87. 
88. This setup specifies that the `hello` function should be run when someone accesses the API gateway at `hello` via
89. a `GET` request.
90. 
91. Here's an example:
92. 
93. ```yml
94. # serverless.yml
95. 
96. functions:
97.   index:
98.     handler: handler.hello
99.     events:
100.       - http: GET hello
101. ```
102. 
103. ```javascript
104. // handler.js
105. 
106. 'use strict';
107. 
108. module.exports.hello = function(event, context, callback) {
109.   console.log(event); // Contains incoming request data (e.g., query params, headers and more)
110. 
111.   const response = {
112.     statusCode: 200,
113.     headers: {
114.       'x-custom-header': 'My Header Value',
115.     },
116.     body: JSON.stringify({ message: 'Hello World!' }),
117.   };
118. 
119.   callback(null, response);
120. };
121. ```
122. 
123. **Note:** When the body is a JSON-Document, you must parse it yourself:
124. 
125. ```
126. JSON.parse(event.body);
127. ```
128. 
129. ### Example "LAMBDA-PROXY" event (default)
130. 
131. ```json
132. {
133.   "resource": "/",
134.   "path": "/",
135.   "httpMethod": "POST",
136.   "headers": {
137.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
138.     "Accept-Encoding": "gzip, deflate, br",
139.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
140.     "cache-control": "max-age=0",
141.     "CloudFront-Forwarded-Proto": "https",
142.     "CloudFront-Is-Desktop-Viewer": "true",
143.     "CloudFront-Is-Mobile-Viewer": "false",
144.     "CloudFront-Is-SmartTV-Viewer": "false",
145.     "CloudFront-Is-Tablet-Viewer": "false",
146.     "CloudFront-Viewer-Country": "GB",
147.     "content-type": "application/x-www-form-urlencoded",
148.     "Host": "j3ap25j034.execute-api.eu-west-2.amazonaws.com",
149.     "origin": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com",
150.     "Referer": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com/dev/",
151.     "upgrade-insecure-requests": "1",
152.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
153.     "Via": "2.0 a3650115c5e21e2b5d133ce84464bea3.cloudfront.net (CloudFront)",
154.     "X-Amz-Cf-Id": "0nDeiXnReyHYCkv8cc150MWCFCLFPbJoTs1mexDuKe2WJwK5ANgv2A==",
155.     "X-Amzn-Trace-Id": "Root=1-597079de-75fec8453f6fd4812414a4cd",
156.     "X-Forwarded-For": "50.129.117.14, 50.112.234.94",
157.     "X-Forwarded-Port": "443",
158.     "X-Forwarded-Proto": "https"
159.   },
160.   "queryStringParameters": null,
161.   "pathParameters": null,
162.   "stageVariables": null,
163.   "requestContext": {
164.     "path": "/dev/",
165.     "accountId": "125002137610",
166.     "resourceId": "qdolsr1yhk",
167.     "stage": "dev",
168.     "requestId": "0f2431a2-6d2f-11e7-b799-5152aa497861",
169.     "identity": {
170.       "cognitoIdentityPoolId": null,
171.       "accountId": null,
172.       "cognitoIdentityId": null,
173.       "caller": null,
174.       "apiKey": "",
175.       "sourceIp": "50.129.117.14",
176.       "accessKey": null,
177.       "cognitoAuthenticationType": null,
178.       "cognitoAuthenticationProvider": null,
179.       "userArn": null,
180.       "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
181.       "user": null
182.     },
183.     "resourcePath": "/",
184.     "httpMethod": "POST",
185.     "apiId": "j3azlsj0c4"
186.   },
187.   "body": "postcode=LS17FR",
188.   "isBase64Encoded": false
189. }
190. ```
191. 
192. ### HTTP Endpoint with Extended Options
193. 
194. Here we've defined an POST endpoint for the path `posts/create`.
195. 
196. ```yml
197. # serverless.yml
198. 
199. functions:
200.   create:
201.     handler: posts.create
202.     events:
203.       - http:
204.           path: posts/create
205.           method: post
206. ```
207. 
208. ### Enabling CORS
209. 
210. To set CORS configurations for your HTTP endpoints, simply modify your event configurations as follows:
211. 
212. ```yml
213. # serverless.yml
214. 
215. functions:
216.   hello:
217.     handler: handler.hello
218.     events:
219.       - http:
220.           path: hello
221.           method: get
222.           cors: true
223. ```
224. 
225. Setting `cors` to `true` assumes a default configuration which is equivalent to:
226. 
227. ```yml
228. functions:
229.   hello:
230.     handler: handler.hello
231.     events:
232.       - http:
233.           path: hello
234.           method: get
235.           cors:
236.             origin: '*'
237.             headers:
238.               - Content-Type
239.               - X-Amz-Date
240.               - Authorization
241.               - X-Api-Key
242.               - X-Amz-Security-Token
243.               - X-Amz-User-Agent
244.             allowCredentials: false
245. ```
246. 
247. To allow multiple origins, you can use the following configuration and provide an array in the `origins` or use comma separated `origin` field:
248. 
249. ```yml
250. functions:
251.   hello:
252.     handler: handler.hello
253.     events:
254.       - http:
255.           path: hello
256.           method: get
257.           cors:
258.             origins:
259.               - http://example.com
260.               - http://example2.com
261.             headers:
262.               - Content-Type
263.               - X-Amz-Date
264.               - Authorization
265.               - X-Api-Key
266.               - X-Amz-Security-Token
267.               - X-Amz-User-Agent
268.             allowCredentials: false
269. ```
270. 
271. Wildcards are accepted. The following example will match all sub-domains of example.com over http:
272. 
273. ```yml
274. cors:
275.   origins:
276.     - http://*.example.com
277.     - http://example2.com
278. ```
279. 
280. Please note that since you can't send multiple values for [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), this configuration uses a response template to check if the request origin matches one of your provided `
281. origins` and overrides the header with the following code:
282. 
283. ```
284. #set($origin = $input.params("Origin")
285. #if($origin == "http://example.com" || $origin == "http://*.amazonaws.com") #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end
286. ```
287. 
288. Configuring the `cors` property sets [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), [Access-Control-Allow-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers), [Access-Control-Allow-Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods),[Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) headers in the CORS preflight response.
289. 
290. If you use the lambda integration, the Access-Control-Allow-Origin and Access-Control-Allow-Credentials will also be provided to the method and integration responses.
291. 
292. Please note that the [Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)-Header is omitted when not explicitly set to `true`.
293. 
294. To enable the `Access-Control-Max-Age` preflight response header, set the `maxAge` property in the `cors` object:
295. 
296. ```yml
297. functions:
298.   hello:
299.     handler: handler.hello
300.     events:
301.       - http:
302.           path: hello
303.           method: get
304.           cors:
305.             origin: '*'
306.             maxAge: 86400
307. ```
308. 
309. If you are using CloudFront or another CDN for your API Gateway, you may want to setup a `Cache-Control` header to allow for OPTIONS request to be cached to avoid the additional hop.
310. 
311. To enable the `Cache-Control` header on preflight response, set the `cacheControl` property in the `cors` object:
312. 
313. ```yml
314. functions:
315.   hello:
316.     handler: handler.hello
317.     events:
318.       - http:
319.           path: hello
320.           method: get
321.           cors:
322.             origin: '*'
323.             headers:
324.               - Content-Type
325.               - X-Amz-Date
326.               - Authorization
327.               - X-Api-Key
328.               - X-Amz-Security-Token
329.               - X-Amz-User-Agent
330.             allowCredentials: false
331.             cacheControl: 'max-age=600, s-maxage=600, proxy-revalidate' # Caches on browser and proxy for 10 minutes and doesnt allow proxy to serve out of date content
332. ```
333. 
334. CORS header accepts single value too
335. 
336. ```yml
337. functions:
338.   hello:
339.     handler: handler.hello
340.     events:
341.       - http:
342.           path: hello
343.           method: get
344.           cors:
345.             headers: '*'
346. ```
347. 
348. If you want to use CORS with the lambda-proxy integration, remember to include the `Access-Control-Allow-*` headers in your headers object, like this:
349. 
350. ```javascript
351. // handler.js
352. 
353. 'use strict';
354. 
355. module.exports.hello = function(event, context, callback) {
356.   const response = {
357.     statusCode: 200,
358.     headers: {
359.       'Access-Control-Allow-Origin': '*', // Required for CORS support to work
360.       'Access-Control-Allow-Credentials': true, // Required for cookies, authorization headers with HTTPS
361.     },
362.     body: JSON.stringify({ message: 'Hello World!' }),
363.   };
364. 
365.   callback(null, response);
366. };
367. ```
368. 
369. ### HTTP Endpoints with `AWS_IAM` Authorizers
370. 
371. If you want to require that the caller submit the IAM user's access keys in order to be authenticated to invoke your Lambda Function, set the authorizer to `AWS_IAM` as shown in the following example:
372. 
373. ```yml
374. functions:
375.   create:
376.     handler: posts.create
377.     events:
378.       - http:
379.           path: posts/create
380.           method: post
381.           authorizer: aws_iam
382. ```
383. 
384. Which is the short hand notation for:
385. 
386. ```yml
387. functions:
388.   create:
389.     handler: posts.create
390.     events:
391.       - http:
392.           path: posts/create
393.           method: post
394.           authorizer:
395.             type: aws_iam
396. ```
397. 
398. ### HTTP Endpoints with Custom Authorizers
399. 
400. Custom Authorizers allow you to run an AWS Lambda Function before your targeted AWS Lambda Function. This is useful for Microservice Architectures or when you simply want to do some Authorization before running your business logic.
401. 
402. You can enable Custom Authorizers for your HTTP endpoint by setting the Authorizer in your `http` event to another function
403. in the same service, as shown in the following example:
404. 
405. ```yml
406. functions:
407.   create:
408.     handler: posts.create
409.     events:
410.       - http:
411.           path: posts/create
412.           method: post
413.           authorizer: authorizerFunc
414.   authorizerFunc:
415.     handler: handler.authorizerFunc
416. ```
417. 
418. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
419. shown in the following example:
420. 
421. ```yml
422. functions:
423.   create:
424.     handler: posts.create
425.     events:
426.       - http:
427.           path: posts/create
428.           method: post
429.           authorizer:
430.             name: authorizerFunc
431.             resultTtlInSeconds: 0
432.             identitySource: method.request.header.Authorization
433.             identityValidationExpression: someRegex
434.             type: token
435.   authorizerFunc:
436.     handler: handler.authorizerFunc
437. ```
438. 
439. If the Authorizer function does not exist in your service but exists in AWS, you can provide the ARN of the Lambda
440. function instead of the function name, as shown in the following example:
441. 
442. ```yml
443. functions:
444.   create:
445.     handler: posts.create
446.     events:
447.       - http:
448.           path: posts/create
449.           method: post
450.           authorizer: xxx:xxx:Lambda-Name
451. ```
452. 
453. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
454. shown in the following example:
455. 
456. ```yml
457. functions:
458.   create:
459.     handler: posts.create
460.     events:
461.       - http:
462.           path: posts/create
463.           method: post
464.           authorizer:
465.             arn: xxx:xxx:Lambda-Name
466.             managedExternally: false
467.             resultTtlInSeconds: 0
468.             identitySource: method.request.header.Authorization
469.             identityValidationExpression: someRegex
470. ```
471. 
472. If permissions for the Authorizer function are managed externally (for example, if the Authorizer function exists
473. in a different AWS account), you can skip creating the permission for the function by setting `managedExternally: true`,
474. as shown in the following example:
475. 
476. ```yml
477. functions:
478.   create:
479.     handler: posts.create
480.     events:
481.       - http:
482.           path: posts/create
483.           method: post
484.           authorizer:
485.             arn: xxx:xxx:Lambda-Name
486.             managedExternally: true
487. ```
488. 
489. **IMPORTANT NOTE**: The permission allowing the authorizer function to be called by API Gateway must exist
490. before deploying the stack, otherwise deployment will fail.
491. 
492. You can also use the Request Type Authorizer by setting the `type` property. In this case, your `identitySource` could contain multiple entries for your policy cache. The default `type` is 'token'.
493. 
494. ```yml
495. functions:
496.   create:
497.     handler: posts.create
498.     events:
499.       - http:
500.           path: posts/create
501.           method: post


File: docs/providers/aws/events/apigateway.md
Line number range: 815 - 975
Content:
A sample schema contained in `create_request.json` might look something like this:

```json
{
  "definitions": {},
  "$schema": "http://json-schema.org/draft-04/schema#",
  "type": "object",
  "title": "The Root Schema",
  "required": ["username"],
  "properties": {
    "username": {
      "type": "string",
      "title": "The Foo Schema",
      "default": "",
      "pattern": "^[a-zA-Z0-9]+$"
    }
  }
}
```

**NOTE:** schema validators are only applied to content types you specify. Other content types are
not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.

### Setting source of API key for metering requests

API Gateway provide a feature for metering your API's requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request's X-API-Key header, set option like this:

```yml
service: my-service
provider:
  name: aws
  apiGateway:
    apiKeySourceType: HEADER
functions:
  hello:
    events:
      - http:
          path: hello
          method: get
```

Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.

```yml
service: my-service
provider:
  name: aws
  apiGateway:
    apiKeySourceType: AUTHORIZER
functions:
  hello:
    events:
      - http:
          path: hello
          method: get
```

## Lambda Integration

This method is more complicated and involves a lot more configuration of the `http` event syntax.

### Example "LAMBDA" event (before customization)

**Refer to this only if you're using the non-default `LAMBDA` integration method**

```json
{
  "body": {},
  "method": "GET",
  "principalId": "",
  "stage": "dev",
  "cognitoPoolClaims": {
    "sub": ""
  },
  "enhancedAuthContext": {},
  "headers": {
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
    "Accept-Encoding": "gzip, deflate, br",
    "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
    "CloudFront-Forwarded-Proto": "https",
    "CloudFront-Is-Desktop-Viewer": "true",
    "CloudFront-Is-Mobile-Viewer": "false",
    "CloudFront-Is-SmartTV-Viewer": "false",
    "CloudFront-Is-Tablet-Viewer": "false",
    "CloudFront-Viewer-Country": "GB",
    "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",
    "upgrade-insecure-requests": "1",
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
    "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",
    "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",
    "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",
    "X-Forwarded-For": "94.117.120.169, 116.132.62.73",
    "X-Forwarded-Port": "443",
    "X-Forwarded-Proto": "https"
  },
  "query": {},
  "path": {},
  "identity": {
    "cognitoIdentityPoolId": "",
    "accountId": "",
    "cognitoIdentityId": "",
    "caller": "",
    "apiKey": "",
    "sourceIp": "94.197.120.169",
    "accessKey": "",
    "cognitoAuthenticationType": "",
    "cognitoAuthenticationProvider": "",
    "userArn": "",
    "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
    "user": ""
  },
  "stageVariables": {},
  "requestPath": "/request/path"
}
```

### Request templates

#### Default Request Templates

Serverless ships with the following default request templates you can use out of the box:

1. `application/json`
2. `application/x-www-form-urlencoded`

Both templates give you access to the following properties you can access with the help of the `event` object:

- body
- method
- principalId
- stage
- headers
- queryStringParameters
- path
- identity
- stageVariables
- requestPath

#### Custom Request Templates

However you can define and use your own request templates as follows (you can even overwrite the default request templates
by defining a new request template for an existing content type):

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          request:
            template:
              text/xhtml: '{ "stage" : "$context.stage" }'
              application/json: '{ "httpMethod" : "$context.httpMethod" }'
```

**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.

**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.


File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 1 - 105
Content:
1. 'use strict';
2. 
3. /* eslint-disable global-require */
4. 
5. const BbPromise = require('bluebird');
6. 
7. const validate = require('./lib/validate');
8. const compileRestApi = require('./lib/restApi');
9. const compileApiKeys = require('./lib/apiKeys');
10. const compileUsagePlan = require('./lib/usagePlan');
11. const compileUsagePlanKeys = require('./lib/usagePlanKeys');
12. const compileResources = require('./lib/resources');
13. const compileCors = require('./lib/cors');
14. const compileMethods = require('./lib/method/index');
15. const compileAuthorizers = require('./lib/authorizers');
16. const compileDeployment = require('./lib/deployment');
17. const compilePermissions = require('./lib/permissions');
18. const compileStage = require('./lib/stage');
19. const getMethodAuthorization = require('./lib/method/authorization');
20. const getMethodIntegration = require('./lib/method/integration');
21. const getMethodResponses = require('./lib/method/responses');
22. 
23. class AwsCompileApigEvents {
24.   constructor(serverless, options) {
25.     this.serverless = serverless;
26.     this.options = options;
27.     this.provider = this.serverless.getProvider('aws');
28. 
29.     this.serverless.configSchemaHandler.defineFunctionEvent('aws', 'http', {
30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018
31.       anyOf: [{ type: 'string' }, { type: 'object' }],
32.     });
33. 
34.     // used for the generated method logical ids (GET, PATCH, PUT, DELETE, OPTIONS, ...)
35.     this.apiGatewayMethodLogicalIds = [];
36. 
37.     Object.assign(
38.       this,
39.       validate,
40.       compileRestApi,
41.       compileApiKeys,
42.       compileUsagePlan,
43.       compileUsagePlanKeys,
44.       compileResources,
45.       compileCors,
46.       compileMethods,
47.       compileAuthorizers,
48.       compileDeployment,
49.       compilePermissions,
50.       compileStage,
51.       getMethodAuthorization,
52.       getMethodIntegration,
53.       getMethodResponses
54.     );
55. 
56.     this.hooks = {
57.       'package:compileEvents': () => {
58.         this.validated = this.validate();
59. 
60.         if (this.validated.events.length === 0) {
61.           return BbPromise.resolve();
62.         }
63. 
64.         return BbPromise.bind(this)
65.           .then(this.compileRestApi)
66.           .then(this.compileResources)
67.           .then(this.compileCors)
68.           .then(this.compileMethods)
69.           .then(this.compileAuthorizers)
70.           .then(this.compileDeployment)
71.           .then(this.compileApiKeys)
72.           .then(this.compileUsagePlan)
73.           .then(this.compileUsagePlanKeys)
74.           .then(this.compilePermissions)
75.           .then(this.compileStage);
76.       },
77. 
78.       // TODO should be removed once AWS fixes the CloudFormation problems using a separate Stage
79.       'after:deploy:deploy': () => {
80.         const getServiceState = require('../../../../lib/getServiceState').getServiceState;
81. 
82.         const state = getServiceState.call(this);
83.         const updateStage = require('./lib/hack/updateStage').updateStage;
84. 
85.         this.state = state;
86.         return updateStage.call(this);
87.       },
88. 
89.       // TODO should be removed once AWS fixes the removal via CloudFormation
90.       'before:remove:remove': () => {
91.         // eslint-disable-next-line no-shadow
92.         const validate = require('../../../../lib/validate').validate;
93.         // eslint-disable-next-line max-len
94.         const disassociateUsagePlan = require('./lib/hack/disassociateUsagePlan')
95.           .disassociateUsagePlan;
96. 
97.         return BbPromise.bind(this)
98.           .then(validate)
99.           .then(disassociateUsagePlan);
100.       },
101.     };
102.   }
103. }
104. 
105. module.exports = AwsCompileApigEvents;


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js
Line number range: 1 - 139
Content:
1. 'use strict';
2. 
3. const BbPromise = require('bluebird');
4. const _ = require('lodash');
5. 
6. module.exports = {
7.   compileMethods() {
8.     this.permissionMapping = [];
9. 
10.     this.validated.events.forEach(event => {
11.       const resourceId = this.getResourceId(event.http.path);
12.       const resourceName = this.getResourceName(event.http.path);
13. 
14.       const requestParameters = {};
15.       if (event.http.request && event.http.request.parameters) {
16.         _.forEach(event.http.request.parameters, (value, key) => {
17.           requestParameters[key] = value.required === undefined ? value : value.required;
18.         });
19.       }
20. 
21.       const template = {
22.         Type: 'AWS::ApiGateway::Method',
23.         Properties: {
24.           HttpMethod: event.http.method.toUpperCase(),
25.           RequestParameters: requestParameters,
26.           ResourceId: resourceId,
27.           RestApiId: this.provider.getApiGatewayRestApiId(),
28.           OperationName: event.http.operationId,
29.         },
30.       };
31. 
32.       if (event.http.private) {
33.         template.Properties.ApiKeyRequired = true;
34.       } else {
35.         template.Properties.ApiKeyRequired = false;
36.       }
37. 
38.       const methodLogicalId = this.provider.naming.getMethodLogicalId(
39.         resourceName,
40.         event.http.method
41.       );
42.       const validatorLogicalId = this.provider.naming.getValidatorLogicalId(
43.         resourceName,
44.         event.http.method
45.       );
46.       const lambdaLogicalId = this.provider.naming.getLambdaLogicalId(event.functionName);
47.       const functionObject = this.serverless.service.functions[event.functionName];
48.       const lambdaAliasName = functionObject.targetAlias && functionObject.targetAlias.name;
49.       const lambdaAliasLogicalId =
50.         functionObject.targetAlias && functionObject.targetAlias.logicalId;
51. 
52.       const singlePermissionMapping = {
53.         resourceName,
54.         lambdaLogicalId,
55.         lambdaAliasName,
56.         lambdaAliasLogicalId,
57.         event,
58.       };
59.       this.permissionMapping.push(singlePermissionMapping);
60. 
61.       _.merge(
62.         template,
63.         this.getMethodAuthorization(event.http),
64.         this.getMethodIntegration(event.http, {
65.           lambdaLogicalId,
66.           lambdaAliasName,
67.         }),
68.         this.getMethodResponses(event.http)
69.       );
70. 
71.       let extraCognitoPoolClaims;
72.       if (event.http.authorizer) {
73.         const claims = event.http.authorizer.claims || [];
74.         extraCognitoPoolClaims = claims.map(claim => {
75.           if (typeof claim === 'string') {
76.             const colonIndex = claim.indexOf(':');
77.             if (colonIndex !== -1) {
78.               const subClaim = claim.substring(colonIndex + 1);
79.               return `"${subClaim}": "$context.authorizer.claims['${claim}']"`;
80.             }
81.           }
82.           return `"${claim}": "$context.authorizer.claims.${claim}"`;
83.         });
84.       }
85.       const requestTemplates = template.Properties.Integration.RequestTemplates;
86.       _.forEach(requestTemplates, (value, key) => {
87.         let claimsString = '';
88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {
89.           claimsString = extraCognitoPoolClaims.join(',').concat(',');
90.         }
91.         requestTemplates[key] = value.replace('extraCognitoPoolClaims', claimsString);
92.       });
93. 
94.       this.apiGatewayMethodLogicalIds.push(methodLogicalId);
95. 
96.       if (event.http.request && event.http.request.schema) {
97.         for (const requestSchema of _.entries(event.http.request.schema)) {
98.           const contentType = requestSchema[0];
99.           const schema = requestSchema[1];
100. 
101.           const modelLogicalId = this.provider.naming.getModelLogicalId(
102.             resourceName,
103.             event.http.method,
104.             contentType
105.           );
106. 
107.           template.Properties.RequestValidatorId = { Ref: validatorLogicalId };
108.           template.Properties.RequestModels = template.Properties.RequestModels || {};
109.           template.Properties.RequestModels[contentType] = { Ref: modelLogicalId };
110. 
111.           _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
112.             [modelLogicalId]: {
113.               Type: 'AWS::ApiGateway::Model',
114.               Properties: {
115.                 RestApiId: this.provider.getApiGatewayRestApiId(),
116.                 ContentType: contentType,
117.                 Schema: schema,
118.               },
119.             },
120.             [validatorLogicalId]: {
121.               Type: 'AWS::ApiGateway::RequestValidator',
122.               Properties: {
123.                 RestApiId: this.provider.getApiGatewayRestApiId(),
124.                 ValidateRequestBody: true,
125.                 ValidateRequestParameters: true,
126.               },
127.             },
128.           });
129.         }
130.       }
131. 
132.       _.merge(this.serverless.service.provider.compiledCloudFormationTemplate.Resources, {
133.         [methodLogicalId]: template,
134.       });
135.     });
136. 
137.     return BbPromise.resolve();
138.   },
139. };


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 1 - 261
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. const DEFAULT_COMMON_TEMPLATE = `
6.   #define( $loop )
7.     {
8.     #foreach($key in $map.keySet())
9.         #set( $k = $util.escapeJavaScript($key) )
10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\'", "'") )
11.         "$k":
12.           "$v"
13.           #if( $foreach.hasNext ) , #end
14.     #end
15.     }
16.   #end
17. 
18.   {
19.     "body": $body,
20.     "method": "$context.httpMethod",
21.     "principalId": "$context.authorizer.principalId",
22.     "stage": "$context.stage",
23. 
24.     "cognitoPoolClaims" : {
25.        extraCognitoPoolClaims
26.        "sub": "$context.authorizer.claims.sub"
27.     },
28. 
29.     #set( $map = $context.authorizer )
30.     "enhancedAuthContext": $loop,
31. 
32.     #set( $map = $input.params().header )
33.     "headers": $loop,
34. 
35.     #set( $map = $input.params().querystring )
36.     "query": $loop,
37. 
38.     #set( $map = $input.params().path )
39.     "path": $loop,
40. 
41.     #set( $map = $context.identity )
42.     "identity": $loop,
43. 
44.     #set( $map = $stageVariables )
45.     "stageVariables": $loop,
46. 
47.     "requestPath": "$context.resourcePath"
48.   }
49. `;
50. 
51. module.exports = {
52.   getMethodIntegration(http, { lambdaLogicalId, lambdaAliasName }) {
53.     const type = http.integration || 'AWS_PROXY';
54.     const integration = {
55.       IntegrationHttpMethod: 'POST',
56.       Type: type,
57.     };
58. 
59.     // Valid integrations are:
60.     // * `HTTP` for integrating with an HTTP back end,
61.     // * `AWS` for any AWS service endpoints,
62.     // * `MOCK` for testing without actually invoking the back end,
63.     // * `HTTP_PROXY` for integrating with the HTTP proxy integration, or
64.     // * `AWS_PROXY` for integrating with the Lambda proxy integration type (the default)
65.     if (type === 'AWS' || type === 'AWS_PROXY') {
66.       Object.assign(integration, {
67.         Uri: {
68.           'Fn::Join': [
69.             '',
70.             [
71.               'arn:',
72.               { Ref: 'AWS::Partition' },
73.               ':apigateway:',
74.               { Ref: 'AWS::Region' },
75.               ':lambda:path/2015-03-31/functions/',
76.               ...[],
77.               { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
78.               ...(lambdaAliasName ? [':', lambdaAliasName] : []),
79.               '/invocations',
80.             ],
81.           ],
82.         },
83.       });
84.     } else if (type === 'HTTP' || type === 'HTTP_PROXY') {
85.       const integrationHttpMethod = (http.request && http.request.method) || http.method;
86.       Object.assign(integration, {
87.         Uri: http.request && http.request.uri,
88.         IntegrationHttpMethod: integrationHttpMethod.toUpperCase(),
89.       });
90.       if (http.connectionType) {
91.         Object.assign(integration, {
92.           ConnectionType: http.connectionType,
93.           ConnectionId: http.connectionId,
94.         });
95.       }
96.     } else if (type === 'MOCK') {
97.       // nothing to do but kept here for reference
98.     }
99. 
100.     if (type === 'AWS' || type === 'HTTP' || type === 'MOCK') {
101.       Object.assign(integration, {
102.         PassthroughBehavior: http.request && http.request.passThrough,
103.         ContentHandling: http.request && http.request.contentHandling,
104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === 'AWS'),
105.         IntegrationResponses: this.getIntegrationResponses(http),
106.       });
107.     }
108.     if (
109.       ((type === 'AWS' || type === 'HTTP' || type === 'HTTP_PROXY') &&
110.         http.request &&
111.         http.request.parameters &&
112.         Object.keys(http.request.parameters).length) ||
113.       http.async
114.     ) {
115.       Object.assign(integration, {
116.         RequestParameters: this.getIntegrationRequestParameters(http),
117.       });
118.     }
119. 
120.     return {
121.       Properties: {
122.         Integration: integration,
123.       },
124.     };
125.   },
126. 
127.   getIntegrationResponses(http) {
128.     const integrationResponses = [];
129. 
130.     if (http.response) {
131.       const integrationResponseHeaders = [];
132. 
133.       if (http.cors) {
134.         let origin = http.cors.origin;
135. 
136.         // TODO remove once "origins" config is deprecated
137.         if (http.cors.origins && http.cors.origins.length) {
138.           origin = http.cors.origins.join(',');
139.         }
140. 
141.         _.merge(integrationResponseHeaders, {
142.           'Access-Control-Allow-Origin': `'${origin}'`,
143.         });
144. 
145.         // Only set Access-Control-Allow-Credentials when explicitly allowed (omit if false)
146.         if (http.cors.allowCredentials) {
147.           integrationResponseHeaders['Access-Control-Allow-Credentials'] = 'true';
148.         }
149.       }
150. 
151.       if (http.response.headers) {
152.         _.merge(integrationResponseHeaders, http.response.headers);
153.       }
154. 
155.       _.forEach(http.response.statusCodes, (config, statusCode) => {
156.         const responseParameters = _.mapKeys(
157.           integrationResponseHeaders,
158.           (value, header) => `method.response.header.${header}`
159.         );
160. 
161.         const integrationResponse = {
162.           StatusCode: statusCode,
163.           SelectionPattern: config.pattern || '',
164.           ResponseParameters: responseParameters,
165.           ResponseTemplates: {},
166.           ContentHandling: statusCode.startsWith('2') ? http.response.contentHandling : undefined,
167.         };
168. 
169.         if (config.headers) {
170.           _.merge(
171.             integrationResponse.ResponseParameters,
172.             _.mapKeys(config.headers, (value, header) => `method.response.header.${header}`)
173.           );
174.         }
175. 
176.         if (http.response.template) {
177.           _.merge(integrationResponse.ResponseTemplates, {
178.             'application/json': http.response.template,
179.           });
180.         }
181. 
182.         if (config.template) {
183.           const template =
184.             typeof config.template === 'string'
185.               ? { 'application/json': config.template }
186.               : config.template;
187. 
188.           _.merge(integrationResponse.ResponseTemplates, template);
189.         }
190. 
191.         integrationResponses.push(integrationResponse);
192.       });
193.     }
194. 
195.     return integrationResponses;
196.   },
197. 
198.   getIntegrationRequestTemplates(http, useDefaults) {
199.     // default request templates
200.     const integrationRequestTemplates = {};
201. 
202.     // Only set defaults for AWS (lambda) integration
203.     if (useDefaults) {
204.       Object.assign(integrationRequestTemplates, {
205.         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
206.         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
207.       });
208.     }
209. 
210.     // set custom request templates if provided
211.     if (http.request && typeof http.request.template === 'object') {
212.       Object.assign(integrationRequestTemplates, http.request.template);
213.     }
214. 
215.     return Object.keys(integrationRequestTemplates).length
216.       ? integrationRequestTemplates
217.       : undefined;
218.   },
219.   getIntegrationRequestParameters(http) {
220.     const parameters = {};
221.     if (http.request && http.request.parameters) {
222.       _.forEach(http.request.parameters, (value, key) => {
223.         parameters[`integration.${key.substring('method.'.length)}`] = value.mappedValue || key;
224.       });
225.     }
226. 
227.     if (http.async) {
228.       parameters['integration.request.header.X-Amz-Invocation-Type'] = "'Event'";
229.     }
230. 
231.     return parameters;
232.   },
233. 
234.   DEFAULT_JSON_REQUEST_TEMPLATE: `
235.     #set( $body = $input.json("$") )
236. 
237.     ${DEFAULT_COMMON_TEMPLATE}
238.   `,
239. 
240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `
241.     #define( $body )
242.       {
243.       #foreach( $token in $input.path('$').split('&') )
244.         #set( $keyVal = $token.split('=') )
245.         #set( $keyValSize = $keyVal.size() )
246.         #if( $keyValSize >= 1 )
247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )
248.           #if( $keyValSize >= 2 )
249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\'","'"))
250.           #else
251.             #set( $val = '' )
252.           #end
253.           "$key": "$val"#if($foreach.hasNext),#end
254.         #end
255.       #end
256.       }
257.     #end
258. 
259.     ${DEFAULT_COMMON_TEMPLATE}
260.   `,
261. };

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 20:08:33,494 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='Query asks for index.js contents and any imports handling request templates. These lines show that index.js wires in getMethodIntegration (which generates request templates) and compileMethods, making them available during packaging.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.js', start_line=14, end_line=22), ContextOutput(reasoning='Shows where imported modules are mixed into the class, confirming getMethodIntegration and compileMethods are used in the packaging workflow.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.js', start_line=37, end_line=54), ContextOutput(reasoning='Integration type determination and assignment of RequestTemplates comes from getIntegrationRequestTemplates; this is the pivotal spot where request templates are attached to the method integration.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=100, end_line=107), ContextOutput(reasoning='Defines how default request mapping templates are provided and how http event request templates from config are merged. This directly answers the query requirement about defaults and reading templates from config.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=198, end_line=218), ContextOutput(reasoning='Default JSON request template content; essential to understand how the defaults are constructed.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=234, end_line=239), ContextOutput(reasoning='Default form-urlencoded request template content; essential default mapping template.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=240, end_line=261), ContextOutput(reasoning='DEFAULT_COMMON_TEMPLATE used by the default request templates to build the event payload; critical for completeness of default templates.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=5, end_line=49), ContextOutput(reasoning='compileMethods merges getMethodIntegration results and then adjusts Integration.RequestTemplates to include extraCognitoPoolClaims; this module handles request templates after integration generation.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js', start_line=61, end_line=69), ContextOutput(reasoning='Shows the post-processing of RequestTemplates to inject extra Cognito claims, demonstrating additional handling of request templates beyond integration.js.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js', start_line=85, end_line=93), ContextOutput(reasoning='Documentation section explicitly covering Default Request Templates and Custom Request Templates for Lambda integration, satisfying the extra requirement to include docs explaining defaults and configuration.', relative_path='docs/providers/aws/events/apigateway.md', start_line=915, end_line=975)]
2025-11-13 20:08:33,497 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 10 contexts to memory for query: Please provide the contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, plus any modules they import that handle request templates.
2025-11-13 20:08:36,322 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 20:08:36,323 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 10 new contexts to 0 existing contexts
2025-11-13 20:08:36,324 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 10 total contexts (removed 0 duplicates)
2025-11-13 20:08:36,324 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, plus any modules they import that handle request templates.
Extra Requirements: If sending all files is too large, include at minimum the sections that define default request mapping templates, how http event request templates are read from config, and the docs/providers/aws/events/apigateway.md file.
Purpose: These files will show where the default templates are created and how to integrate an option to disable or override them following existing architecture and conventions.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/apigateway.md
Line number range: 915 - 975
Content:
915.     "cognitoIdentityId": "",
916.     "caller": "",
917.     "apiKey": "",
918.     "sourceIp": "94.197.120.169",
919.     "accessKey": "",
920.     "cognitoAuthenticationType": "",
921.     "cognitoAuthenticationProvider": "",
922.     "userArn": "",
923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
924.     "user": ""
925.   },
926.   "stageVariables": {},
927.   "requestPath": "/request/path"
928. }
929. ```
930. 
931. ### Request templates
932. 
933. #### Default Request Templates
934. 
935. Serverless ships with the following default request templates you can use out of the box:
936. 
937. 1. `application/json`
938. 2. `application/x-www-form-urlencoded`
939. 
940. Both templates give you access to the following properties you can access with the help of the `event` object:
941. 
942. - body
943. - method
944. - principalId
945. - stage
946. - headers
947. - queryStringParameters
948. - path
949. - identity
950. - stageVariables
951. - requestPath
952. 
953. #### Custom Request Templates
954. 
955. However you can define and use your own request templates as follows (you can even overwrite the default request templates
956. by defining a new request template for an existing content type):
957. 
958. ```yml
959. functions:
960.   create:
961.     handler: posts.create
962.     events:
963.       - http:
964.           method: get
965.           path: whatever
966.           integration: lambda
967.           request:
968.             template:
969.               text/xhtml: '{ "stage" : "$context.stage" }'
970.               application/json: '{ "httpMethod" : "$context.httpMethod" }'
971. ```
972. 
973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
974. 
975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.


File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 14 - 22
Content:
14. const compileMethods = require('./lib/method/index');
15. const compileAuthorizers = require('./lib/authorizers');
16. const compileDeployment = require('./lib/deployment');
17. const compilePermissions = require('./lib/permissions');
18. const compileStage = require('./lib/stage');
19. const getMethodAuthorization = require('./lib/method/authorization');
20. const getMethodIntegration = require('./lib/method/integration');
21. const getMethodResponses = require('./lib/method/responses');
22. 


File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 37 - 54
Content:
37.     Object.assign(
38.       this,
39.       validate,
40.       compileRestApi,
41.       compileApiKeys,
42.       compileUsagePlan,
43.       compileUsagePlanKeys,
44.       compileResources,
45.       compileCors,
46.       compileMethods,
47.       compileAuthorizers,
48.       compileDeployment,
49.       compilePermissions,
50.       compileStage,
51.       getMethodAuthorization,
52.       getMethodIntegration,
53.       getMethodResponses
54.     );


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js
Line number range: 61 - 69
Content:
61.       _.merge(
62.         template,
63.         this.getMethodAuthorization(event.http),
64.         this.getMethodIntegration(event.http, {
65.           lambdaLogicalId,
66.           lambdaAliasName,
67.         }),
68.         this.getMethodResponses(event.http)
69.       );


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js
Line number range: 85 - 93
Content:
85.       const requestTemplates = template.Properties.Integration.RequestTemplates;
86.       _.forEach(requestTemplates, (value, key) => {
87.         let claimsString = '';
88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {
89.           claimsString = extraCognitoPoolClaims.join(',').concat(',');
90.         }
91.         requestTemplates[key] = value.replace('extraCognitoPoolClaims', claimsString);
92.       });
93. 


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 5 - 49
Content:
5. const DEFAULT_COMMON_TEMPLATE = `
6.   #define( $loop )
7.     {
8.     #foreach($key in $map.keySet())
9.         #set( $k = $util.escapeJavaScript($key) )
10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\'", "'") )
11.         "$k":
12.           "$v"
13.           #if( $foreach.hasNext ) , #end
14.     #end
15.     }
16.   #end
17. 
18.   {
19.     "body": $body,
20.     "method": "$context.httpMethod",
21.     "principalId": "$context.authorizer.principalId",
22.     "stage": "$context.stage",
23. 
24.     "cognitoPoolClaims" : {
25.        extraCognitoPoolClaims
26.        "sub": "$context.authorizer.claims.sub"
27.     },
28. 
29.     #set( $map = $context.authorizer )
30.     "enhancedAuthContext": $loop,
31. 
32.     #set( $map = $input.params().header )
33.     "headers": $loop,
34. 
35.     #set( $map = $input.params().querystring )
36.     "query": $loop,
37. 
38.     #set( $map = $input.params().path )
39.     "path": $loop,
40. 
41.     #set( $map = $context.identity )
42.     "identity": $loop,
43. 
44.     #set( $map = $stageVariables )
45.     "stageVariables": $loop,
46. 
47.     "requestPath": "$context.resourcePath"
48.   }
49. `;


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 100 - 107
Content:
100.     if (type === 'AWS' || type === 'HTTP' || type === 'MOCK') {
101.       Object.assign(integration, {
102.         PassthroughBehavior: http.request && http.request.passThrough,
103.         ContentHandling: http.request && http.request.contentHandling,
104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === 'AWS'),
105.         IntegrationResponses: this.getIntegrationResponses(http),
106.       });
107.     }


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 198 - 218
Content:
198.   getIntegrationRequestTemplates(http, useDefaults) {
199.     // default request templates
200.     const integrationRequestTemplates = {};
201. 
202.     // Only set defaults for AWS (lambda) integration
203.     if (useDefaults) {
204.       Object.assign(integrationRequestTemplates, {
205.         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
206.         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
207.       });
208.     }
209. 
210.     // set custom request templates if provided
211.     if (http.request && typeof http.request.template === 'object') {
212.       Object.assign(integrationRequestTemplates, http.request.template);
213.     }
214. 
215.     return Object.keys(integrationRequestTemplates).length
216.       ? integrationRequestTemplates
217.       : undefined;
218.   },


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 234 - 239
Content:
234.   DEFAULT_JSON_REQUEST_TEMPLATE: `
235.     #set( $body = $input.json("$") )
236. 
237.     ${DEFAULT_COMMON_TEMPLATE}
238.   `,
239. 


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 240 - 261
Content:
240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `
241.     #define( $body )
242.       {
243.       #foreach( $token in $input.path('$').split('&') )
244.         #set( $keyVal = $token.split('=') )
245.         #set( $keyValSize = $keyVal.size() )
246.         #if( $keyValSize >= 1 )
247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )
248.           #if( $keyValSize >= 2 )
249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\'","'"))
250.           #else
251.             #set( $val = '' )
252.           #end
253.           "$key": "$val"#if($foreach.hasNext),#end
254.         #end
255.       #end
256.       }
257.     #end
258. 
259.     ${DEFAULT_COMMON_TEMPLATE}
260.   `,
261. };

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:09:07,142 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='We have the core integration code that creates default templates and merges custom ones, plus minimal docs about request templates. To implement an option to disable defaults cleanly, we need the configuration schema that defines the allowed properties for http events (especially the request object) to add a new flag and follow existing conventions, and the broader docs sections that describe request options (passThrough, contentHandling, template). Those are not yet visible.' query='Please provide the relevant sections of lib/configSchema.js that define the schema for AWS http API Gateway event request settings, and the portions of docs/providers/aws/events/apigateway.md that document the request options (passThrough, contentHandling, template).' extra_requirements='If sharing full files is too large, include at minimum the schema segment path for http event request.template and its allowed keys, and the doc subsections for Request Parameters, Content Handling, Passthrough Behavior, and Request Templates.' purpose='These will ensure any new option to disable default request templates aligns with the validated config schema and documented patterns.'
2025-11-13 20:09:07,143 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieving contexts from memory for query: Please provide the relevant sections of lib/configSchema.js that define the schema for AWS http API Gateway event request settings, and the portions of docs/providers/aws/events/apigateway.md that document the request options (passThrough, contentHandling, template).
2025-11-13 20:09:10,028 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - DEBUG - Retrieved contexts: []
2025-11-13 20:09:10,028 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 memories from memory
2025-11-13 20:09:10,028 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - Retrieved 0 contexts from memory
2025-11-13 20:09:10,029 - thread-135845287823040.prometheus.lang_graph.nodes.memory_retrieval_node - INFO - After deduplication and sorting: 0 contexts from memory
2025-11-13 20:09:10,030 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting context_provider_messages in state.
2025-11-13 20:09:10,031 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - INFO - Creating context provider message from refined query
2025-11-13 20:09:10,031 - thread-135845287823040.prometheus.lang_graph.nodes.add_context_refined_query_message_node - DEBUG - Query message: Essential query: Please provide the relevant sections of lib/configSchema.js that define the schema for AWS http API Gateway event request settings, and the portions of docs/providers/aws/events/apigateway.md that document the request options (passThrough, contentHandling, template).
Extra requirements: If sharing full files is too large, include at minimum the schema segment path for http event request.template and its allowed keys, and the doc subsections for Request Parameters, Content Handling, Passthrough Behavior, and Request Templates.
Purpose: These will ensure any new option to disable default request templates aligns with the validated config schema and documented patterns.
2025-11-13 20:09:23,379 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HS8AI7F6B8dJnAN1CYEJkKlW', 'function': {'arguments': '{"relative_path":"lib/configSchema.js","start_line":1,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1322, 'prompt_tokens': 2302, 'total_tokens': 3624, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1280, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--855f9e61-967a-4373-9475-cbea9c3772a7-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/configSchema.js', 'start_line': 1, 'end_line': 2000}, 'id': 'call_HS8AI7F6B8dJnAN1CYEJkKlW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 2302, 'output_tokens': 1322, 'total_tokens': 3624, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1280}}
2025-11-13 20:09:28,141 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_khNhcijPg7XnSKvcWi1L2cBM', 'function': {'arguments': '{"basename":"configSchema.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 222, 'prompt_tokens': 3655, 'total_tokens': 3877, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f2219337-6fdc-498d-a762-09d92eae94ac-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'configSchema.js'}, 'id': 'call_khNhcijPg7XnSKvcWi1L2cBM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3655, 'output_tokens': 222, 'total_tokens': 3877, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:09:31,953 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4a9h5PgOCbfS0Vb3MnmDumMh', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 292, 'prompt_tokens': 3726, 'total_tokens': 4018, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3ceb9b6d-bc74-483e-9410-ab73b6c37f9b-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_4a9h5PgOCbfS0Vb3MnmDumMh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3726, 'output_tokens': 292, 'total_tokens': 4018, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:09:33,556 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_BxQbIjw7zSfIip229j2oowbS', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'read_file_with_knowledge_graph_data'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 3808, 'total_tokens': 3839, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ccc84a3c-3b7a-44fb-99c3-6bac7bee66fa-0' tool_calls=[{'name': 'read_file_with_knowledge_graph_data', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_BxQbIjw7zSfIip229j2oowbS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3808, 'output_tokens': 31, 'total_tokens': 3839, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:09:47,537 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yykWZ6UGb4u7Ri0qMRwIiOlO', 'function': {'arguments': '{"basename":"apiGateway.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1374, 'prompt_tokens': 9740, 'total_tokens': 11114, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1344, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f25cc2ec-ce85-4255-9784-70dec66c7af7-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'apiGateway.js'}, 'id': 'call_yykWZ6UGb4u7Ri0qMRwIiOlO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9740, 'output_tokens': 1374, 'total_tokens': 11114, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 1344}}
2025-11-13 20:09:55,727 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_uFmzS3g459gIdrrqDQ5HiZh6', 'function': {'arguments': '{"text":"Request Parameters"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 732, 'prompt_tokens': 9790, 'total_tokens': 10522, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7a60d51d-d9cb-442b-8aaf-10761758e55f-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'Request Parameters'}, 'id': 'call_uFmzS3g459gIdrrqDQ5HiZh6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9790, 'output_tokens': 732, 'total_tokens': 10522, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 20:10:02,068 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hT49iuZh2pIwnr7XamjjOxbu', 'function': {'arguments': '{"text":"Request templates"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 668, 'prompt_tokens': 12477, 'total_tokens': 13145, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9728}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--262b9404-b165-4423-8e9f-f08a65fa0e60-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'Request templates'}, 'id': 'call_hT49iuZh2pIwnr7XamjjOxbu', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12477, 'output_tokens': 668, 'total_tokens': 13145, 'input_token_details': {'audio': 0, 'cache_read': 9728}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:10:04,246 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Xm6Xtuk52Fk6IpqeQKsiYCLJ', 'function': {'arguments': '{"text":"Pass Through Behavior"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 23, 'prompt_tokens': 15499, 'total_tokens': 15522, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f03c8359-b5a1-423f-b39c-66b85af6a767-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'Pass Through Behavior'}, 'id': 'call_Xm6Xtuk52Fk6IpqeQKsiYCLJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15499, 'output_tokens': 23, 'total_tokens': 15522, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:10:10,097 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kYF3t388z29l1E9cP3B04AkY', 'function': {'arguments': '{"text":"Content Handling"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 476, 'prompt_tokens': 18063, 'total_tokens': 18539, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3937f45c-990a-4180-9368-cfedbeaddf93-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'Content Handling'}, 'id': 'call_kYF3t388z29l1E9cP3B04AkY', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18063, 'output_tokens': 476, 'total_tokens': 18539, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:10:25,005 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XyWXOQ4hFuiPFAVdusJeN4r2', 'function': {'arguments': '{"text":"Content handling"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1436, 'prompt_tokens': 18110, 'total_tokens': 19546, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1408, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12416}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--792d941f-a43d-4613-b9f5-2c18b12c97d7-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'Content handling'}, 'id': 'call_XyWXOQ4hFuiPFAVdusJeN4r2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18110, 'output_tokens': 1436, 'total_tokens': 19546, 'input_token_details': {'audio': 0, 'cache_read': 12416}, 'output_token_details': {'audio': 0, 'reasoning': 1408}}
2025-11-13 20:10:32,986 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_vMJjNPa4lQtFoqLjVDrwYInt', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 487, 'prompt_tokens': 18157, 'total_tokens': 18644, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 15488}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--774be624-630d-42de-a5cd-488b89f5249b-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/index.js'}, 'id': 'call_vMJjNPa4lQtFoqLjVDrwYInt', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18157, 'output_tokens': 487, 'total_tokens': 18644, 'input_token_details': {'audio': 0, 'cache_read': 15488}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:10:34,881 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_1csd00u1UibydrQKXkQmrOzP', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/index.js","start_line":1,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 18243, 'total_tokens': 18286, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 2176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--977d6ae8-74c0-4998-8c16-7206136c7ba5-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/index.js', 'start_line': 1, 'end_line': 2000}, 'id': 'call_1csd00u1UibydrQKXkQmrOzP', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18243, 'output_tokens': 43, 'total_tokens': 18286, 'input_token_details': {'audio': 0, 'cache_read': 2176}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:10:40,102 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OPEDu5wPTmmJUwVbuuPHUkdY', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/index.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 353, 'prompt_tokens': 19453, 'total_tokens': 19806, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3712}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f6f63c4d-b150-4e31-b683-ed38e5089a7a-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/index.js'}, 'id': 'call_OPEDu5wPTmmJUwVbuuPHUkdY', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19453, 'output_tokens': 353, 'total_tokens': 19806, 'input_token_details': {'audio': 0, 'cache_read': 3712}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:10:43,819 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dIIXTyDXPXHVTXxiVJTQhSMF', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 233, 'prompt_tokens': 19506, 'total_tokens': 19739, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18176}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a56ddc30-5382-4bc9-8763-a0c6585fb154-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js'}, 'id': 'call_dIIXTyDXPXHVTXxiVJTQhSMF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19506, 'output_tokens': 233, 'total_tokens': 19739, 'input_token_details': {'audio': 0, 'cache_read': 18176}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:10:45,501 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_oalRffXOasUtC5mXK4AOQI4e', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":1,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 45, 'prompt_tokens': 19596, 'total_tokens': 19641, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--11ec9d24-388a-4f5e-879a-e8f039a944f6-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 1, 'end_line': 2000}, 'id': 'call_oalRffXOasUtC5mXK4AOQI4e', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19596, 'output_tokens': 45, 'total_tokens': 19641, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:10:56,111 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XLWqT2GnLvip5mWQWYFuGthW', 'function': {'arguments': '{"text":"contentHandling"}', 'name': 'find_text_node_with_text'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 988, 'prompt_tokens': 26445, 'total_tokens': 27433, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19328}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--93e30e90-aa2d-479f-88d1-2097c016d59d-0' tool_calls=[{'name': 'find_text_node_with_text', 'args': {'text': 'contentHandling'}, 'id': 'call_XLWqT2GnLvip5mWQWYFuGthW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26445, 'output_tokens': 988, 'total_tokens': 27433, 'input_token_details': {'audio': 0, 'cache_read': 19328}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 20:11:00,809 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hWK3tEm6sU1jm4Bgs8GC7pE0', 'function': {'arguments': '{"basename":"awsProvider.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 350, 'prompt_tokens': 31803, 'total_tokens': 32153, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19584}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b806be6e-1097-490f-a198-6f34b3bb9bfb-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'awsProvider.js'}, 'id': 'call_hWK3tEm6sU1jm4Bgs8GC7pE0', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31803, 'output_tokens': 350, 'total_tokens': 32153, 'input_token_details': {'audio': 0, 'cache_read': 19584}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:11:02,889 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dIP5d0OuYKcFiG6ToUFIN7S8', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/provider/awsProvider.js","start_line":1,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 31877, 'total_tokens': 31916, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19456}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c82a3e58-b588-441a-8a36-7e81b8d3a6d1-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/provider/awsProvider.js', 'start_line': 1, 'end_line': 2000}, 'id': 'call_dIP5d0OuYKcFiG6ToUFIN7S8', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31877, 'output_tokens': 39, 'total_tokens': 31916, 'input_token_details': {'audio': 0, 'cache_read': 19456}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:11:09,585 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3LWO2hwvI3OfjjYzg9eBAPSO', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'find_file_node_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 427, 'prompt_tokens': 40695, 'total_tokens': 41122, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9728}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6f09d015-b6b5-4cfd-9a6e-9d73354b47cd-0' tool_calls=[{'name': 'find_file_node_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_3LWO2hwvI3OfjjYzg9eBAPSO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 40695, 'output_tokens': 427, 'total_tokens': 41122, 'input_token_details': {'audio': 0, 'cache_read': 9728}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 20:11:12,019 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_hH8mMHMOPW8aTEpOnpWkog2Y', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","start_line":1,"end_line":2000}', 'name': 'read_code_with_relative_path'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 47, 'prompt_tokens': 40789, 'total_tokens': 40836, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 40576}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--49479a49-b5a0-40b5-83c8-bbf5424a405f-0' tool_calls=[{'name': 'read_code_with_relative_path', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'start_line': 1, 'end_line': 2000}, 'id': 'call_hH8mMHMOPW8aTEpOnpWkog2Y', 'type': 'tool_call'}] usage_metadata={'input_tokens': 40789, 'output_tokens': 47, 'total_tokens': 40836, 'input_token_details': {'audio': 0, 'cache_read': 40576}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:11:23,713 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PHeeZyEM7J8iuGQCuO6RYALx', 'function': {'arguments': '{"basename":"configSchema.js"}', 'name': 'find_file_node_with_basename'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 990, 'prompt_tokens': 43625, 'total_tokens': 44615, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 26368}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b2813a23-fb15-4dc5-a142-cb280fe14cb6-0' tool_calls=[{'name': 'find_file_node_with_basename', 'args': {'basename': 'configSchema.js'}, 'id': 'call_PHeeZyEM7J8iuGQCuO6RYALx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 43625, 'output_tokens': 990, 'total_tokens': 44615, 'input_token_details': {'audio': 0, 'cache_read': 26368}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 20:11:51,021 - thread-135845287823040.prometheus.lang_graph.nodes.context_provider_node - DEBUG - content='- I located lib/configSchema.js and confirmed it doesn’t define detailed AWS http event schema; the provider plugin extends it, and in lib/plugins/aws/package/compile/events/apiGateway/index.js the http event schema is currently just anyOf [string|object]. \n- I pulled the validation and integration logic that effectively define/validate request options: validate.js (request.template must be an object; passThrough allowed values: NEVER, WHEN_NO_MATCH, WHEN_NO_TEMPLATES) and method/integration.js (uses request.contentHandling, passThrough, and builds RequestTemplates including defaults and custom mappings). \n- I retrieved the relevant documentation sections from docs/providers/aws/events/apigateway.md: Request Parameters, Request Templates (Default and Custom), Pass Through Behavior, and the Content Handling section (with examples). \n- For clarity, the schema segment path for templates is functions.<functionName>.events[].http.request.template, where allowed keys are content-type strings (e.g., application/json, text/xhtml) mapping to VTL template strings (or ${file(...)} references).' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2145, 'prompt_tokens': 43696, 'total_tokens': 45841, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1920, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--0dfcc87a-8579-4028-be58-1bb31d381d86-0' usage_metadata={'input_tokens': 43696, 'output_tokens': 2145, 'total_tokens': 45841, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1920}}
2025-11-13 20:11:51,028 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - This is the query you need to answer:

--- BEGIN QUERY ---
Please provide the relevant sections of lib/configSchema.js that define the schema for AWS http API Gateway event request settings, and the portions of docs/providers/aws/events/apigateway.md that document the request options (passThrough, contentHandling, template).
--- END QUERY ---

--- BEGIN EXTRA REQUIREMENTS ---
If sharing full files is too large, include at minimum the schema segment path for http event request.template and its allowed keys, and the doc subsections for Request Parameters, Content Handling, Passthrough Behavior, and Request Templates.
--- END EXTRA REQUIREMENTS ---

--- BEGIN PURPOSE ---
These will ensure any new option to disable default request templates aligns with the validated config schema and documented patterns.
--- END PURPOSE ---

The context or file content that you have seen so far (Some of the context may be IRRELEVANT to the query!!!):

--- BEGIN CONTEXT ---
File: CHANGELOG.md
Line number range: 258 - 281
Content:
## [1.72.0](https://github.com/serverless/serverless/compare/v1.71.3...v1.72.0) (2020-06-02)

### Features

- **AWS API Gateway:**
  - Simplify referencing local CognitoUserPool ([#7799](https://github.com/serverless/serverless/issues/7799)) ([2e4377e](https://github.com/serverless/serverless/commit/2e4377ecf038401456c3fca29feeab624846a300)) ([Alex DeBrie](https://github.com/alexdebrie))
  - Support `customerId` in API keys ([#7786](https://github.com/serverless/serverless/issues/7786)) ([c6894b5](https://github.com/serverless/serverless/commit/c6894b5129c14a43fce0017187cf69aa1bdc9185)) ([Greg Campion](https://github.com/gcampionpae))
  - Support toggling CloudWatch metrics ([#7754](https://github.com/serverless/serverless/issues/7754)) ([87d40aa](https://github.com/serverless/serverless/commit/87d40aa8a7fea136a9c05d6e3c350b0d24a58183)) ([Satoru Kikuchi](https://github.com/s-kikuchi))
- **AWS HTTP API:** Support externally configured JWT authorizers ([#7789](https://github.com/serverless/serverless/issues/7789)) ([4074739](https://github.com/serverless/serverless/commit/4074739476e22631b0e06a9d23a2e21d8f29c21e)) ([Michał Mrozek](https://github.com/Michsior14))
- **CLI:**
  - Deprecations logger ([#7741](https://github.com/serverless/serverless/issues/7741)) ([6f32f23](https://github.com/serverless/serverless/commit/6f32f236d8c44464b34e8c666e4ecbb3abe287d4)) ([Ahmad Mahmoud Mohammad](https://github.com/AhmedFat7y) & [Mariusz Nowak](https://github.com/medikoo))
  - Deprecate `bin/serverless` binary ([#7759](https://github.com/serverless/serverless/issues/7759)) ([a60d2c7](https://github.com/serverless/serverless/commit/a60d2c7dd8648a17c9ca09c363d3ab88b797a11c)) ([Mariusz Nowak](https://github.com/medikoo))
- **Templates:** Azure C# template ([#7738](https://github.com/serverless/serverless/issues/7738)) ([9611137](https://github.com/serverless/serverless/commit/96111379823fc1fc68835b9bcdb4f0f585ff554e)) ([Tanner Barlow](https://github.com/tbarlow12))
- **Variables:** Support non-function exports in js files ([#7540](https://github.com/serverless/serverless/issues/7540)) ([89ba272](https://github.com/serverless/serverless/commit/89ba272a63a153df0655c85a5d5a2487580c73a1)) ([Steven Rapp](https://github.com/srapp))
- Support `serverless.ts` (TypeScript type) as configuration input ([#7755](https://github.com/serverless/serverless/issues/7755)) ([4db8b63](https://github.com/serverless/serverless/commit/4db8b630a285d40b117d7043f024cb3e036951b4)) ([Bryan Hunter](https://github.com/bryan-hunter))

### Bug Fixes

- **AWS API Gateway:**
  - Fix API key names resolution ([#7804](https://github.com/serverless/serverless/issues/7804)) ([f9f6a3b](https://github.com/serverless/serverless/commit/f9f6a3b560f70b81ce0ab6f802e05596bd700916)) ([Mariusz Nowak](https://github.com/medikoo))
  - Apply contentHandling only to successful responses ([#7757](https://github.com/serverless/serverless/issues/7757)) ([aa48f0a](https://github.com/serverless/serverless/commit/aa48f0a0766fc07e6e3ca4bb7ba4b6ad3427cc03)) ([Thomas Aribart](https://github.com/ThomasAribart))
- Downgrade `uuid` to v3 ([#7778](https://github.com/serverless/serverless/issues/7778)) ([e9be1c8](https://github.com/serverless/serverless/commit/e9be1c8c6f3b6f105f0e6d9f4383e7cbe16e62ff)) ([Mariusz Nowak](https://github.com/medikoo))

### Maintanance Improvements


File: CHANGELOG.md
Line number range: 647 - 704
Content:
### Bug Fixes

- Ensure not to autocomplete hidden commands ([3f7f532](https://github.com/serverless/serverless/commit/3f7f532b88c9bdcc25a2b53a93e11484131c28ab))
- Fix AWS partition reference in APIGW CloudWatch role setup ([fc74c28](https://github.com/serverless/serverless/commit/fc74c287f68deb20266d011d9376d13117c11161)), closes [#7100](https://github.com/serverless/serverless/issues/7100)
- Fix credentials validation in EC2 environment ([#6977](https://github.com/serverless/serverless/issues/6977)) ([f8ee027](https://github.com/serverless/serverless/commit/f8ee0279037ba35b4c32f5872fcff4e741898db1))
- Prevent uncaught exception in case of `open` util issue ([f29d169](https://github.com/serverless/serverless/commit/f29d1697dd89a418ca4aacac23b64b928e68f643))
- Recognize falsy values as CLI options defaults ([#7071](https://github.com/serverless/serverless/issues/7071)) ([7e0e903](https://github.com/serverless/serverless/commit/7e0e903c798cc6c5370a74048202cd0480e2be3d))

### [1.59.3](https://github.com/serverless/serverless/compare/v1.59.2...v1.59.3) (2019-12-09)

### Bug Fixes

- Do not set optional ParallelizationFactor when not explicitly set ([e74d1a0](https://github.com/serverless/serverless/commit/e74d1a0a6486fba1ca09c5eb54b36fcf552d60f4)), closes [#7049](https://github.com/serverless/serverless/issues/7049)
- Fix provisioned concurrency support ([be0ebb7](https://github.com/serverless/serverless/commit/be0ebb76e7d3860587a986c9da48209870e7990d)), closes [#7059](https://github.com/serverless/serverless/issues/7059)

### [1.59.2](https://github.com/serverless/serverless/compare/v1.59.1...v1.59.2) (2019-12-06)

### Bug Fixes

- Ensure to not create cognito pools marked as 'existing' ([fe546c5](https://github.com/serverless/serverless/commit/fe546c50d35b88b24556257182aacd9e24f07d1b))

### [1.59.1](https://github.com/serverless/serverless/compare/v1.59.0...v1.59.1) (2019-12-05)

### Bug Fixes

- Fix mishandling of cachedCredentials in invokeLocal ([699e78d](https://github.com/serverless/serverless/commit/699e78d251b7cbb3e6553c6d8554c2bf568be1fb)), closes [#7050](https://github.com/serverless/serverless/issues/7050), regression introduced with [#7044](https://github.com/serverless/serverless/issues/7044)

# 1.59.0 (2019-12-04)

- [Fix spelling and typos in docs, code variables and code comments](https://github.com/serverless/serverless/pull/6986)
- [Code cleanup and refactoring](https://github.com/serverless/serverless/pull/6990)
- [Add support for contentHandling - Fixes gh-6949](https://github.com/serverless/serverless/pull/6987)
- [Fix deployment bucket SSE documentation](https://github.com/serverless/serverless/pull/7000)
- [Make authorizer type check from #6150 case insensitive](https://github.com/serverless/serverless/pull/7001)
- [Govcloud custom resource fix](https://github.com/serverless/serverless/pull/6996)
- [Lint and style patches](https://github.com/serverless/serverless/pull/7004)
- [Fix/cors omit access control allow credentials on false](https://github.com/serverless/serverless/pull/6999)
- [Fix: remove `$context.status` from websocket access log format](https://github.com/serverless/serverless/pull/7014)
- [Clarifying Azure setup](https://github.com/serverless/serverless/pull/7015)
- [Expose ParallelizationFactor prop for Kinesis Streams](https://github.com/serverless/serverless/pull/7024)
- [Replace moment with dayjs](https://github.com/serverless/serverless/pull/7025)
- [Update AWS SQS event docs regarding FIFO queue trigger for Lambda](https://github.com/serverless/serverless/pull/7029)
- [Awsprovider - adding support for SDK sub-classes.](https://github.com/serverless/serverless/pull/7031)
- [Provide backoff for retryable aws requests and the option to adjust the cf status check interval via an environment variable](https://github.com/serverless/serverless/pull/6981)
- [Add page for best practices on CI/CD](https://github.com/serverless/serverless/pull/6988)
- [Optimize custom resources generation](https://github.com/serverless/serverless/pull/7032)
- [Update API GW stage settings only when explicitly set](https://github.com/serverless/serverless/pull/7033)
- [Do not apply APIGW wide settings on externally referenced APIGW](https://github.com/serverless/serverless/pull/7034)
- [Enable Content Trust checking when pulling lambci/lambda images](https://github.com/serverless/serverless/pull/6992)
- [Fix resolution of user configured APIGW](https://github.com/serverless/serverless/pull/7039)
- [Add option to change log level for websocket logs](https://github.com/serverless/serverless/pull/7035)
- [Support lambda provisioned concurrency](https://github.com/serverless/serverless/pull/7043)
- [Fix AWS creds handling](https://github.com/serverless/serverless/pull/7044)
- [Fix lambda provisioned concurrency setup](https://github.com/serverless/serverless/pull/7045)

## Meta

- [Comparison since last release](https://github.com/serverless/serverless/compare/v1.58.0...v1.59.0)


File: docs/providers/aws/events/apigateway.md
Line number range: 1 - 501
Content:
1. <!--
2. title: Serverless Framework - AWS Lambda Events - API Gateway
3. menuText: API Gateway
4. menuOrder: 1
5. description: Setting up AWS API Gateway Events with AWS Lambda via the Serverless Framework
6. layout: Doc
7. -->
8. 
9. <!-- DOCS-SITE-LINK:START automatically generated  -->
10. 
11. ### [Read this on the main serverless docs site](https://www.serverless.com/framework/docs/providers/aws/events/apigateway)
12. 
13. <!-- DOCS-SITE-LINK:END -->
14. 
15. # API Gateway
16. 
17. - [API Gateway](#api-gateway)
18.   - [Lambda Proxy Integration](#lambda-proxy-integration)
19.     - [Simple HTTP Endpoint](#simple-http-endpoint)
20.     - [Example "LAMBDA-PROXY" event (default)](#example-lambda-proxy-event-default)
21.     - [HTTP Endpoint with Extended Options](#http-endpoint-with-extended-options)
22.     - [Enabling CORS](#enabling-cors)
23.     - [HTTP Endpoints with `AWS_IAM` Authorizers](#http-endpoints-with-aws_iam-authorizers)
24.     - [HTTP Endpoints with Custom Authorizers](#http-endpoints-with-custom-authorizers)
25.     - [HTTP Endpoints with `operationId`](#http-endpoints-with-operationId)
26.     - [Catching Exceptions In Your Lambda Function](#catching-exceptions-in-your-lambda-function)
27.     - [Setting API keys for your Rest API](#setting-api-keys-for-your-rest-api)
28.     - [Configuring endpoint types](#configuring-endpoint-types)
29.     - [Request Parameters](#request-parameters)
30.     - [Request Schema Validators](#request-schema-validators)
31.     - [Setting source of API key for metering requests](#setting-source-of-api-key-for-metering-requests)
32.   - [Lambda Integration](#lambda-integration)
33.     - [Example "LAMBDA" event (before customization)](#example-lambda-event-before-customization)
34.     - [Request templates](#request-templates)
35.       - [Default Request Templates](#default-request-templates)
36.       - [Custom Request Templates](#custom-request-templates)
37.       - [Pass Through Behavior](#pass-through-behavior)
38.     - [Responses](#responses)
39.       - [Custom Response Headers](#custom-response-headers)
40.       - [Custom Response Templates](#custom-response-templates)
41.     - [Status Codes](#status-codes)
42.       - [Available Status Codes](#available-status-codes)
43.       - [Using Status Codes](#using-status-codes)
44.       - [Custom Status Codes](#custom-status-codes)
45.   - [Setting an HTTP Proxy on API Gateway](#setting-an-http-proxy-on-api-gateway)
46.   - [Accessing private resources using VPC Link](#accessing-private-resources-using-vpc-link)
47.   - [Mock Integration](#mock-integration)
48.   - [Share API Gateway and API Resources](#share-api-gateway-and-api-resources)
49.     - [Easiest and CI/CD friendly example of using shared API Gateway and API Resources.](#easiest-and-cicd-friendly-example-of-using-shared-api-gateway-and-api-resources)
50.     - [Manually Configuring shared API Gateway](#manually-configuring-shared-api-gateway)
51.       - [Note while using authorizers with shared API Gateway](#note-while-using-authorizers-with-shared-api-gateway)
52.   - [Share Authorizer](#share-authorizer)
53.   - [Resource Policy](#resource-policy)
54.   - [Compression](#compression)
55.   - [Binary Media Types](#binary-media-types)
56.   - [Detailed CloudWatch Metrics](#detailed-cloudwatch-metrics)
57.   - [AWS X-Ray Tracing](#aws-x-ray-tracing)
58.   - [Tags / Stack Tags](#tags--stack-tags)
59.   - [Logs](#logs)
60. 
61. _Are you looking for tutorials on using API Gateway? Check out the following resources:_
62. 
63. > - [Add a custom domain for your API Gateway](https://serverless.com/blog/serverless-api-gateway-domain/)
64. > - [Deploy multiple micro-services under the same domain](https://serverless.com/blog/api-gateway-multiple-services/)
65. > - [Create a Node REST API with Express.js](https://serverless.com/blog/serverless-express-rest-api/)
66. > - [Make a Serverless GraphQL API](https://serverless.com/blog/make-serverless-graphql-api-using-lambda-dynamodb/)
67. 
68. To create HTTP endpoints as Event sources for your AWS Lambda Functions, use the Serverless Framework's easy AWS API Gateway Events syntax.
69. 
70. There are five ways you can configure your HTTP endpoints to integrate with your AWS Lambda Functions:
71. 
72. - `lambda-proxy` / `aws-proxy` / `aws_proxy` (Recommended)
73. - `lambda` / `aws`
74. - `http`
75. - `http-proxy` / `http_proxy`
76. - `mock`
77. 
78. **The Framework uses the `lambda-proxy` method (i.e., everything is passed into your Lambda) by default unless another method is supplied by the user**
79. 
80. The difference between these is `lambda-proxy` (alternative writing styles are `aws-proxy` and `aws_proxy` for compatibility with the standard AWS integration type naming) automatically passes the content of the HTTP request into your AWS Lambda function (headers, body, etc.) and allows you to configure your response (headers, status code, body) in the code of your AWS Lambda Function. Whereas, the `lambda` method makes you explicitly define headers, status codes, and more in the configuration of each API Gateway Endpoint (not in code). We highly recommend using the `lambda-proxy` method if it supports your use-case, since the `lambda` method is highly tedious.
81. 
82. Use `http` for integrating with an HTTP back end, `http-proxy` for integrating with the HTTP proxy integration or `mock` for testing without actually invoking the back end.
83. 
84. ## Lambda Proxy Integration
85. 
86. ### Simple HTTP Endpoint
87. 
88. This setup specifies that the `hello` function should be run when someone accesses the API gateway at `hello` via
89. a `GET` request.
90. 
91. Here's an example:
92. 
93. ```yml
94. # serverless.yml
95. 
96. functions:
97.   index:
98.     handler: handler.hello
99.     events:
100.       - http: GET hello
101. ```
102. 
103. ```javascript
104. // handler.js
105. 
106. 'use strict';
107. 
108. module.exports.hello = function(event, context, callback) {
109.   console.log(event); // Contains incoming request data (e.g., query params, headers and more)
110. 
111.   const response = {
112.     statusCode: 200,
113.     headers: {
114.       'x-custom-header': 'My Header Value',
115.     },
116.     body: JSON.stringify({ message: 'Hello World!' }),
117.   };
118. 
119.   callback(null, response);
120. };
121. ```
122. 
123. **Note:** When the body is a JSON-Document, you must parse it yourself:
124. 
125. ```
126. JSON.parse(event.body);
127. ```
128. 
129. ### Example "LAMBDA-PROXY" event (default)
130. 
131. ```json
132. {
133.   "resource": "/",
134.   "path": "/",
135.   "httpMethod": "POST",
136.   "headers": {
137.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
138.     "Accept-Encoding": "gzip, deflate, br",
139.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
140.     "cache-control": "max-age=0",
141.     "CloudFront-Forwarded-Proto": "https",
142.     "CloudFront-Is-Desktop-Viewer": "true",
143.     "CloudFront-Is-Mobile-Viewer": "false",
144.     "CloudFront-Is-SmartTV-Viewer": "false",
145.     "CloudFront-Is-Tablet-Viewer": "false",
146.     "CloudFront-Viewer-Country": "GB",
147.     "content-type": "application/x-www-form-urlencoded",
148.     "Host": "j3ap25j034.execute-api.eu-west-2.amazonaws.com",
149.     "origin": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com",
150.     "Referer": "https://j3ap25j034.execute-api.eu-west-2.amazonaws.com/dev/",
151.     "upgrade-insecure-requests": "1",
152.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
153.     "Via": "2.0 a3650115c5e21e2b5d133ce84464bea3.cloudfront.net (CloudFront)",
154.     "X-Amz-Cf-Id": "0nDeiXnReyHYCkv8cc150MWCFCLFPbJoTs1mexDuKe2WJwK5ANgv2A==",
155.     "X-Amzn-Trace-Id": "Root=1-597079de-75fec8453f6fd4812414a4cd",
156.     "X-Forwarded-For": "50.129.117.14, 50.112.234.94",
157.     "X-Forwarded-Port": "443",
158.     "X-Forwarded-Proto": "https"
159.   },
160.   "queryStringParameters": null,
161.   "pathParameters": null,
162.   "stageVariables": null,
163.   "requestContext": {
164.     "path": "/dev/",
165.     "accountId": "125002137610",
166.     "resourceId": "qdolsr1yhk",
167.     "stage": "dev",
168.     "requestId": "0f2431a2-6d2f-11e7-b799-5152aa497861",
169.     "identity": {
170.       "cognitoIdentityPoolId": null,
171.       "accountId": null,
172.       "cognitoIdentityId": null,
173.       "caller": null,
174.       "apiKey": "",
175.       "sourceIp": "50.129.117.14",
176.       "accessKey": null,
177.       "cognitoAuthenticationType": null,
178.       "cognitoAuthenticationProvider": null,
179.       "userArn": null,
180.       "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
181.       "user": null
182.     },
183.     "resourcePath": "/",
184.     "httpMethod": "POST",
185.     "apiId": "j3azlsj0c4"
186.   },
187.   "body": "postcode=LS17FR",
188.   "isBase64Encoded": false
189. }
190. ```
191. 
192. ### HTTP Endpoint with Extended Options
193. 
194. Here we've defined an POST endpoint for the path `posts/create`.
195. 
196. ```yml
197. # serverless.yml
198. 
199. functions:
200.   create:
201.     handler: posts.create
202.     events:
203.       - http:
204.           path: posts/create
205.           method: post
206. ```
207. 
208. ### Enabling CORS
209. 
210. To set CORS configurations for your HTTP endpoints, simply modify your event configurations as follows:
211. 
212. ```yml
213. # serverless.yml
214. 
215. functions:
216.   hello:
217.     handler: handler.hello
218.     events:
219.       - http:
220.           path: hello
221.           method: get
222.           cors: true
223. ```
224. 
225. Setting `cors` to `true` assumes a default configuration which is equivalent to:
226. 
227. ```yml
228. functions:
229.   hello:
230.     handler: handler.hello
231.     events:
232.       - http:
233.           path: hello
234.           method: get
235.           cors:
236.             origin: '*'
237.             headers:
238.               - Content-Type
239.               - X-Amz-Date
240.               - Authorization
241.               - X-Api-Key
242.               - X-Amz-Security-Token
243.               - X-Amz-User-Agent
244.             allowCredentials: false
245. ```
246. 
247. To allow multiple origins, you can use the following configuration and provide an array in the `origins` or use comma separated `origin` field:
248. 
249. ```yml
250. functions:
251.   hello:
252.     handler: handler.hello
253.     events:
254.       - http:
255.           path: hello
256.           method: get
257.           cors:
258.             origins:
259.               - http://example.com
260.               - http://example2.com
261.             headers:
262.               - Content-Type
263.               - X-Amz-Date
264.               - Authorization
265.               - X-Api-Key
266.               - X-Amz-Security-Token
267.               - X-Amz-User-Agent
268.             allowCredentials: false
269. ```
270. 
271. Wildcards are accepted. The following example will match all sub-domains of example.com over http:
272. 
273. ```yml
274. cors:
275.   origins:
276.     - http://*.example.com
277.     - http://example2.com
278. ```
279. 
280. Please note that since you can't send multiple values for [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), this configuration uses a response template to check if the request origin matches one of your provided `
281. origins` and overrides the header with the following code:
282. 
283. ```
284. #set($origin = $input.params("Origin")
285. #if($origin == "http://example.com" || $origin == "http://*.amazonaws.com") #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin) #end
286. ```
287. 
288. Configuring the `cors` property sets [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin), [Access-Control-Allow-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers), [Access-Control-Allow-Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods),[Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) headers in the CORS preflight response.
289. 
290. If you use the lambda integration, the Access-Control-Allow-Origin and Access-Control-Allow-Credentials will also be provided to the method and integration responses.
291. 
292. Please note that the [Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)-Header is omitted when not explicitly set to `true`.
293. 
294. To enable the `Access-Control-Max-Age` preflight response header, set the `maxAge` property in the `cors` object:
295. 
296. ```yml
297. functions:
298.   hello:
299.     handler: handler.hello
300.     events:
301.       - http:
302.           path: hello
303.           method: get
304.           cors:
305.             origin: '*'
306.             maxAge: 86400
307. ```
308. 
309. If you are using CloudFront or another CDN for your API Gateway, you may want to setup a `Cache-Control` header to allow for OPTIONS request to be cached to avoid the additional hop.
310. 
311. To enable the `Cache-Control` header on preflight response, set the `cacheControl` property in the `cors` object:
312. 
313. ```yml
314. functions:
315.   hello:
316.     handler: handler.hello
317.     events:
318.       - http:
319.           path: hello
320.           method: get
321.           cors:
322.             origin: '*'
323.             headers:
324.               - Content-Type
325.               - X-Amz-Date
326.               - Authorization
327.               - X-Api-Key
328.               - X-Amz-Security-Token
329.               - X-Amz-User-Agent
330.             allowCredentials: false
331.             cacheControl: 'max-age=600, s-maxage=600, proxy-revalidate' # Caches on browser and proxy for 10 minutes and doesnt allow proxy to serve out of date content
332. ```
333. 
334. CORS header accepts single value too
335. 
336. ```yml
337. functions:
338.   hello:
339.     handler: handler.hello
340.     events:
341.       - http:
342.           path: hello
343.           method: get
344.           cors:
345.             headers: '*'
346. ```
347. 
348. If you want to use CORS with the lambda-proxy integration, remember to include the `Access-Control-Allow-*` headers in your headers object, like this:
349. 
350. ```javascript
351. // handler.js
352. 
353. 'use strict';
354. 
355. module.exports.hello = function(event, context, callback) {
356.   const response = {
357.     statusCode: 200,
358.     headers: {
359.       'Access-Control-Allow-Origin': '*', // Required for CORS support to work
360.       'Access-Control-Allow-Credentials': true, // Required for cookies, authorization headers with HTTPS
361.     },
362.     body: JSON.stringify({ message: 'Hello World!' }),
363.   };
364. 
365.   callback(null, response);
366. };
367. ```
368. 
369. ### HTTP Endpoints with `AWS_IAM` Authorizers
370. 
371. If you want to require that the caller submit the IAM user's access keys in order to be authenticated to invoke your Lambda Function, set the authorizer to `AWS_IAM` as shown in the following example:
372. 
373. ```yml
374. functions:
375.   create:
376.     handler: posts.create
377.     events:
378.       - http:
379.           path: posts/create
380.           method: post
381.           authorizer: aws_iam
382. ```
383. 
384. Which is the short hand notation for:
385. 
386. ```yml
387. functions:
388.   create:
389.     handler: posts.create
390.     events:
391.       - http:
392.           path: posts/create
393.           method: post
394.           authorizer:
395.             type: aws_iam
396. ```
397. 
398. ### HTTP Endpoints with Custom Authorizers
399. 
400. Custom Authorizers allow you to run an AWS Lambda Function before your targeted AWS Lambda Function. This is useful for Microservice Architectures or when you simply want to do some Authorization before running your business logic.
401. 
402. You can enable Custom Authorizers for your HTTP endpoint by setting the Authorizer in your `http` event to another function
403. in the same service, as shown in the following example:
404. 
405. ```yml
406. functions:
407.   create:
408.     handler: posts.create
409.     events:
410.       - http:
411.           path: posts/create
412.           method: post
413.           authorizer: authorizerFunc
414.   authorizerFunc:
415.     handler: handler.authorizerFunc
416. ```
417. 
418. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
419. shown in the following example:
420. 
421. ```yml
422. functions:
423.   create:
424.     handler: posts.create
425.     events:
426.       - http:
427.           path: posts/create
428.           method: post
429.           authorizer:
430.             name: authorizerFunc
431.             resultTtlInSeconds: 0
432.             identitySource: method.request.header.Authorization
433.             identityValidationExpression: someRegex
434.             type: token
435.   authorizerFunc:
436.     handler: handler.authorizerFunc
437. ```
438. 
439. If the Authorizer function does not exist in your service but exists in AWS, you can provide the ARN of the Lambda
440. function instead of the function name, as shown in the following example:
441. 
442. ```yml
443. functions:
444.   create:
445.     handler: posts.create
446.     events:
447.       - http:
448.           path: posts/create
449.           method: post
450.           authorizer: xxx:xxx:Lambda-Name
451. ```
452. 
453. Or, if you want to configure the Authorizer with more options, you can turn the `authorizer` property into an object as
454. shown in the following example:
455. 
456. ```yml
457. functions:
458.   create:
459.     handler: posts.create
460.     events:
461.       - http:
462.           path: posts/create
463.           method: post
464.           authorizer:
465.             arn: xxx:xxx:Lambda-Name
466.             managedExternally: false
467.             resultTtlInSeconds: 0
468.             identitySource: method.request.header.Authorization
469.             identityValidationExpression: someRegex
470. ```
471. 
472. If permissions for the Authorizer function are managed externally (for example, if the Authorizer function exists
473. in a different AWS account), you can skip creating the permission for the function by setting `managedExternally: true`,
474. as shown in the following example:
475. 
476. ```yml
477. functions:
478.   create:
479.     handler: posts.create
480.     events:
481.       - http:
482.           path: posts/create
483.           method: post
484.           authorizer:
485.             arn: xxx:xxx:Lambda-Name
486.             managedExternally: true
487. ```
488. 
489. **IMPORTANT NOTE**: The permission allowing the authorizer function to be called by API Gateway must exist
490. before deploying the stack, otherwise deployment will fail.
491. 
492. You can also use the Request Type Authorizer by setting the `type` property. In this case, your `identitySource` could contain multiple entries for your policy cache. The default `type` is 'token'.
493. 
494. ```yml
495. functions:
496.   create:
497.     handler: posts.create
498.     events:
499.       - http:
500.           path: posts/create
501.           method: post


File: docs/providers/aws/events/apigateway.md
Line number range: 656 - 833
Content:
Clients connecting to this Rest API will then need to set any of these API keys values in the `x-api-key` header of their request. This is only necessary for functions where the `private` property is set to true.

You can also setup multiple usage plans for your API. In this case you need to map your usage plans to your api keys. Here's an example how this might look like:

```yml
service: my-service
provider:
  name: aws
  apiKeys:
    - free:
        - myFreeKey
        - ${opt:stage}-myFreeKey
    - paid:
        - myPaidKey
        - ${opt:stage}-myPaidKey
  usagePlan:
    - free:
        quota:
          limit: 5000
          offset: 2
          period: MONTH
        throttle:
          burstLimit: 200
          rateLimit: 100
    - paid:
        quota:
          limit: 50000
          offset: 1
          period: MONTH
        throttle:
          burstLimit: 2000
          rateLimit: 1000
functions:
  hello:
    events:
      - http:
          path: user/create
          method: get
          private: true
```

### Configuring endpoint types

API Gateway [supports regional endpoints](https://aws.amazon.com/about-aws/whats-new/2017/11/amazon-api-gateway-supports-regional-api-endpoints/) for associating your API Gateway REST APIs with a particular region. This can reduce latency if your requests originate from the same region as your REST API and can be helpful in building multi-region applications.

By default, the Serverless Framework deploys your REST API using the EDGE endpoint configuration. If you would like to use the REGIONAL or PRIVATE configuration, set the `endpointType` parameter in your `provider` block.

Here's an example configuration for setting the endpoint configuration for your service Rest API:

```yml
service: my-service
provider:
  name: aws
  endpointType: REGIONAL
functions:
  hello:
    events:
      - http:
          path: user/create
          method: get
```

API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:

```
https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com
```

Here's an example configuration:

```yml
service: my-service
provider:
  name: aws
  endpointType: PRIVATE
  vpcEndpointIds:
    - vpce-123
    - vpce-456
```

### Request Parameters

To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            parameters:
              querystrings:
                url: true
              headers:
                foo: false
              paths:
                bar: false
```

In order for path variables to work, API Gateway also needs them in the method path itself, like so:

```yml
functions:
  create:
    handler: posts.post_detail
    events:
      - http:
          path: posts/{id}
          method: get
          request:
            parameters:
              paths:
                id: true
```

To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.

```yml
functions:
  create:
    handler: posts.post_detail
    events:
      - http:
          path: posts/{id}
          method: get
          request:
            parameters:
              paths:
                id: true
              headers:
                custom-header:
                  required: true
                  mappedValue: context.requestId
```

For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)

### Request Schema Validators

To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)
for your content type. Since JSON Schema is represented in JSON, it's easier to include it from a
file.

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            schema:
              application/json: ${file(create_request.json)}
```

A sample schema contained in `create_request.json` might look something like this:

```json
{
  "definitions": {},
  "$schema": "http://json-schema.org/draft-04/schema#",
  "type": "object",
  "title": "The Root Schema",
  "required": ["username"],
  "properties": {
    "username": {
      "type": "string",
      "title": "The Foo Schema",
      "default": "",
      "pattern": "^[a-zA-Z0-9]+$"
    }
  }
}
```


File: docs/providers/aws/events/apigateway.md
Line number range: 815 - 975
Content:
A sample schema contained in `create_request.json` might look something like this:

```json
{
  "definitions": {},
  "$schema": "http://json-schema.org/draft-04/schema#",
  "type": "object",
  "title": "The Root Schema",
  "required": ["username"],
  "properties": {
    "username": {
      "type": "string",
      "title": "The Foo Schema",
      "default": "",
      "pattern": "^[a-zA-Z0-9]+$"
    }
  }
}
```

**NOTE:** schema validators are only applied to content types you specify. Other content types are
not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.

### Setting source of API key for metering requests

API Gateway provide a feature for metering your API's requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request's X-API-Key header, set option like this:

```yml
service: my-service
provider:
  name: aws
  apiGateway:
    apiKeySourceType: HEADER
functions:
  hello:
    events:
      - http:
          path: hello
          method: get
```

Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.

```yml
service: my-service
provider:
  name: aws
  apiGateway:
    apiKeySourceType: AUTHORIZER
functions:
  hello:
    events:
      - http:
          path: hello
          method: get
```

## Lambda Integration

This method is more complicated and involves a lot more configuration of the `http` event syntax.

### Example "LAMBDA" event (before customization)

**Refer to this only if you're using the non-default `LAMBDA` integration method**

```json
{
  "body": {},
  "method": "GET",
  "principalId": "",
  "stage": "dev",
  "cognitoPoolClaims": {
    "sub": ""
  },
  "enhancedAuthContext": {},
  "headers": {
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
    "Accept-Encoding": "gzip, deflate, br",
    "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
    "CloudFront-Forwarded-Proto": "https",
    "CloudFront-Is-Desktop-Viewer": "true",
    "CloudFront-Is-Mobile-Viewer": "false",
    "CloudFront-Is-SmartTV-Viewer": "false",
    "CloudFront-Is-Tablet-Viewer": "false",
    "CloudFront-Viewer-Country": "GB",
    "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",
    "upgrade-insecure-requests": "1",
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
    "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",
    "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",
    "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",
    "X-Forwarded-For": "94.117.120.169, 116.132.62.73",
    "X-Forwarded-Port": "443",
    "X-Forwarded-Proto": "https"
  },
  "query": {},
  "path": {},
  "identity": {
    "cognitoIdentityPoolId": "",
    "accountId": "",
    "cognitoIdentityId": "",
    "caller": "",
    "apiKey": "",
    "sourceIp": "94.197.120.169",
    "accessKey": "",
    "cognitoAuthenticationType": "",
    "cognitoAuthenticationProvider": "",
    "userArn": "",
    "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
    "user": ""
  },
  "stageVariables": {},
  "requestPath": "/request/path"
}
```

### Request templates

#### Default Request Templates

Serverless ships with the following default request templates you can use out of the box:

1. `application/json`
2. `application/x-www-form-urlencoded`

Both templates give you access to the following properties you can access with the help of the `event` object:

- body
- method
- principalId
- stage
- headers
- queryStringParameters
- path
- identity
- stageVariables
- requestPath

#### Custom Request Templates

However you can define and use your own request templates as follows (you can even overwrite the default request templates
by defining a new request template for an existing content type):

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          request:
            template:
              text/xhtml: '{ "stage" : "$context.stage" }'
              application/json: '{ "httpMethod" : "$context.httpMethod" }'
```

**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.

**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.


File: docs/providers/aws/events/apigateway.md
Line number range: 973 - 1081
Content:
**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.

**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.

If you want to map querystrings to the event object, you can use the `$input.params('hub.challenge')` syntax from API Gateway, as follows:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          request:
            template:
              application/json: '{ "foo" : "$input.params(''bar'')" }'
```

**Note:** Notice when using single-quoted strings, any single quote `'` inside its contents must be doubled (`''`) to escape it.
You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.
If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).

#### Pass Through Behavior

[API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.

You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          request:
            passThrough: NEVER
```

There are 3 available options:

| Value             | Passed Through When                          | Rejected When                                                          |
| ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |
| NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |
| WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |
| WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |

See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.

**Notes:**

- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
- API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)

### Responses

Serverless lets you setup custom headers and a response template for your `http` event.

#### Custom Response Headers

Here's an example which shows you how you can setup a custom response header:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          response:
            headers:
              Content-Type: integration.response.header.Content-Type
              Cache-Control: "'max-age=120'"
```

**Note:** You're able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)
for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header
as `"'max-age=120'"` means API Gateway will receive the value as `'max-age=120'` (enclosed with single quotes).

#### Custom Response Templates

Sometimes you'll want to define a custom response template API Gateway should use to transform your lambdas output.
Here's an example which will transform the return value of your lambda so that the browser renders it as HTML:

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          method: get
          path: whatever
          integration: lambda
          response:
            headers:
              Content-Type: "'text/html'"
            template: $input.path('$')
```

**Note:** The template is defined as plain text here. However you can also reference an external file with the help of
the `${file(templatefile)}` syntax.

### Status Codes


File: docs/providers/aws/events/apigateway.md
Line number range: 1484 - 1638
Content:
```yml
service: service-c

provider:
  apiGateway:
    restApiId:
      'Fn::ImportValue': apiGateway-restApiId
    restApiRootResourceId:
      'Fn::ImportValue': apiGateway-rootResourceId

functions:
  deleteUser:
    events:
      - http:
        path: /users/{userId}
        authorizer:
          arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
```

```yml
service: service-d

provider:
  apiGateway:
    restApiId:
      'Fn::ImportValue': apiGateway-restApiId
    restApiRootResourceId:
      'Fn::ImportValue': apiGateway-rootResourceId

functions:
  deleteProject:
    events:
      - http:
        path: /project/{projectId}
        authorizer:
          arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
```

we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).

A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.

## Share Authorizer

Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.

```yml
functions:
  createUser:
     ...
    events:
      - http:
          path: /users
          ...
          authorizer:
            # Provide both type and authorizerId
            type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
            authorizerId:
              Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID
            scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS
              - myapp/myscope

  deleteUser:
     ...
    events:
      - http:
          path: /users/{userId}
          ...
          # Provide both type and authorizerId
          type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
          authorizerId:
            Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID

resources:
  Resources:
    ApiGatewayAuthorizer:
      Type: AWS::ApiGateway::Authorizer
      Properties:
        AuthorizerResultTtlInSeconds: 300
        IdentitySource: method.request.header.Authorization
        Name: Cognito
        RestApiId:
          Ref: YourApiGatewayName
        Type: COGNITO_USER_POOLS
        ProviderARNs:
          - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef

```

## Resource Policy

Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.

```yml
provider:
  name: aws
  runtime: nodejs12.x

  resourcePolicy:
    - Effect: Allow
      Principal: '*'
      Action: execute-api:Invoke
      Resource:
        - execute-api:/*/*/*
      Condition:
        IpAddress:
          aws:SourceIp:
            - '123.123.123.123'
```

## Compression

API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).

```yml
provider:
  name: aws
  apiGateway:
    minimumCompressionSize: 1024
```

## Binary Media Types

API Gateway makes it possible to return binary media such as images or files as responses.

Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:

```yml
provider:
  apiGateway:
    binaryMediaTypes:
      - '*/*'
```

In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.

To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).

```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            contentHandling: CONVERT_TO_TEXT
          response:
            contentHandling: CONVERT_TO_TEXT
```

## Detailed CloudWatch Metrics

Use the following configuration to enable detailed CloudWatch Metrics:


File: docs/providers/aws/events/apigateway.md
Line number range: 1622 - 1774
Content:
```yml
functions:
  create:
    handler: posts.create
    events:
      - http:
          path: posts/create
          method: post
          request:
            contentHandling: CONVERT_TO_TEXT
          response:
            contentHandling: CONVERT_TO_TEXT
```

## Detailed CloudWatch Metrics

Use the following configuration to enable detailed CloudWatch Metrics:

```yml
provider:
  apiGateway:
    metrics: true
```

## AWS X-Ray Tracing

API Gateway supports a form of out of the box distributed tracing via [AWS X-Ray](https://aws.amazon.com/xray/) though enabling [active tracing](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-xray.html). To enable this feature for your serverless application's API Gateway add the following to your `serverless.yml`

```yml
# serverless.yml

provider:
  name: aws
  tracing:
    apiGateway: true
```

## Tags / Stack Tags

API Gateway stages will be tagged with the `tags` and `stackTags` values defined at the `provider` level:

```yml
# serverless.yml

provider:
  name: aws
  stackTags:
    stackTagKey: stackTagValue
  tags:
    tagKey: tagValue
```

## Logs

Use the following configuration to enable API Gateway logs:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi: true
```

The log streams will be generated in a dedicated log group which follows the naming schema `/aws/api-gateway/{service}-{stage}`.

To be able to write logs, API Gateway [needs a CloudWatch role configured](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html). This setting is per region, shared by all the APIs. There are three approaches for handling it:

- Let Serverless create and assign an IAM role for you (default behavior). Note that since this is a shared setting, this role is not removed when you remove the deployment.
- Let Serverless assign an existing IAM role that you created before the deployment, if not already assigned:

  ```yml
  # serverless.yml
  provider:
    logs:
      restApi:
        role: arn:aws:iam::123456:role
  ```

- Do not let Serverless manage the CloudWatch role configuration. In this case, you would create and assign the IAM role yourself, e.g. in a separate "account setup" deployment:

  ```yml
  provider:
    logs:
      restApi:
        roleManagedExternally: true # disables automatic role creation/checks done by Serverless
  ```

**Note:** Serverless configures the API Gateway CloudWatch role setting using a custom resource lambda function. If you're using `cfnRole` to specify a limited-access IAM role for your serverless deployment, the custom resource lambda will assume this role during execution.

By default, API Gateway access logs will use the following format:

```
'requestId: $context.requestId, ip: $context.identity.sourceIp, caller: $context.identity.caller, user: $context.identity.user, requestTime: $context.requestTime, httpMethod: $context.httpMethod, resourcePath: $context.resourcePath, status: $context.status, protocol: $context.protocol, responseLength: $context.responseLength'
```

You can specify your own [format for API Gateway Access Logs](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-logging.html#apigateway-cloudwatch-log-formats) by including your preferred string in the `format` property:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      format: '{ "requestId":"$context.requestId",   "ip": "$context.identity.sourceIp" }'
```

The default API Gateway log level will be INFO. You can change this to error with the following:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      level: ERROR
```

Valid values are INFO, ERROR.

If you want to disable access logging completly you can do with the following:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      accessLogging: true
```

By default, the full requests and responses data will be logged. If you want to disable like so:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    restApi:
      fullExecutionData: false
```

Websockets have the same configuration options as the the REST API. Example:

```yml
# serverless.yml
provider:
  name: aws
  logs:
    websoocket:
      level: INFO
      fullExecutionData: false
```


File: lib/configSchema.js
Line number range: 1 - 2000
Content:
1. 'use strict';
2. 
3. const functionNamePattern = '^[a-zA-Z0-9-_]+$';
4. 
5. const schema = {
6.   type: 'object',
7.   properties: {
8.     service: {
9.       type: 'object',
10.       properties: {
11.         name: { pattern: '^[a-zA-Z][0-9a-zA-Z-]+$' },
12.         awsKmsKeyArn: { pattern: '^arn:(aws[a-zA-Z-]*)?:kms:[a-z0-9-]+-\\d+:\\d{12}:[^\\s]+$' },
13.       },
14.       additionalProperties: false,
15.     },
16.     frameworkVersion: { type: 'string' },
17.     disabledDeprecations: {
18.       anyOf: [
19.         { const: '*' },
20.         { $ref: '#/definitions/errorCode' },
21.         {
22.           type: 'array',
23.           items: { $ref: '#/definitions/errorCode' },
24.         },
25.       ],
26.     },
27. 
28.     custom: {
29.       type: 'object',
30.       properties: {},
31.       required: [],
32.       additionalProperties: true, // user is free to add properties that he or she wants
33.     },
34.     plugins: { type: 'array', items: { type: 'string' } },
35. 
36.     functions: {
37.       type: 'object',
38.       patternProperties: {
39.         [functionNamePattern]: {
40.           type: 'object',
41.           properties: {
42.             name: { type: 'string' }, // name property is added by service class
43.             events: {
44.               type: 'array',
45.               items: {
46.                 /*
47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start
48.                  * with one dummy item as workaround to ensure it validates against
49.                  * any undefined function events.
50.                  */
51.                 anyOf: [
52.                   {
53.                     type: 'object',
54.                     properties: { __schemaWorkaround__: { const: null } },
55.                     required: ['__schemaWorkaround__'],
56.                     additionalProperties: false,
57.                   },
58.                 ],
59.               },
60.             },
61.           },
62. 
63.           /*
64.            * Schema for function properties is extended by a provider plugin.
65.            * For example, in the context of AWS provider props like
66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.
67.            * should be extended by awsProvider plugin.
68.            */
69.           additionalProperties: false,
70.         },
71.       },
72.       additionalProperties: false,
73.     },
74. 
75.     /*
76.      * Provider specific properties are extended in respected provider plugins.
77.      */
78.     provider: {
79.       type: 'object',
80.       properties: {},
81.       required: ['name'],
82.       additionalProperties: false,
83.     },
84. 
85.     package: {
86.       type: 'object',
87.       properties: {
88.         individually: { type: 'boolean' },
89.         path: { type: 'string' },
90.         artifact: { type: 'string' },
91.         exclude: { type: 'array', items: { type: 'string' } },
92.         include: { type: 'array', items: { type: 'string' } },
93.         excludeDevDependencies: { type: 'boolean' },
94.       },
95.       additionalProperties: false,
96.     },
97. 
98.     // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8015
99.     layers: { type: 'object' },
100. 
101.     /*
102.      * Modes for config validation:
103.      *  - error: the error is thrown
104.      *  - warn: logs error to console without throwing an error
105.      *  - off: disables validation at all
106.      *
107.      *  The default is `warn`, and will be set to `error` in v2
108.      */
109.     configValidationMode: { enum: ['error', 'warn', 'off'] },
110.   },
111.   additionalProperties: false,
112.   required: ['provider', 'service'],
113.   definitions: {
114.     errorCode: {
115.       type: 'string',
116.       pattern: '^[A-Z0-9_]+$',
117.     },
118.   },
119. };
120. 
121. module.exports = schema;


File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 1 - 2000
Content:
1. 'use strict';
2. 
3. /* eslint-disable global-require */
4. 
5. const BbPromise = require('bluebird');
6. 
7. const validate = require('./lib/validate');
8. const compileRestApi = require('./lib/restApi');
9. const compileApiKeys = require('./lib/apiKeys');
10. const compileUsagePlan = require('./lib/usagePlan');
11. const compileUsagePlanKeys = require('./lib/usagePlanKeys');
12. const compileResources = require('./lib/resources');
13. const compileCors = require('./lib/cors');
14. const compileMethods = require('./lib/method/index');
15. const compileAuthorizers = require('./lib/authorizers');
16. const compileDeployment = require('./lib/deployment');
17. const compilePermissions = require('./lib/permissions');
18. const compileStage = require('./lib/stage');
19. const getMethodAuthorization = require('./lib/method/authorization');
20. const getMethodIntegration = require('./lib/method/integration');
21. const getMethodResponses = require('./lib/method/responses');
22. 
23. class AwsCompileApigEvents {
24.   constructor(serverless, options) {
25.     this.serverless = serverless;
26.     this.options = options;
27.     this.provider = this.serverless.getProvider('aws');
28. 
29.     this.serverless.configSchemaHandler.defineFunctionEvent('aws', 'http', {
30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018
31.       anyOf: [{ type: 'string' }, { type: 'object' }],
32.     });
33. 
34.     // used for the generated method logical ids (GET, PATCH, PUT, DELETE, OPTIONS, ...)
35.     this.apiGatewayMethodLogicalIds = [];
36. 
37.     Object.assign(
38.       this,
39.       validate,
40.       compileRestApi,
41.       compileApiKeys,
42.       compileUsagePlan,
43.       compileUsagePlanKeys,
44.       compileResources,
45.       compileCors,
46.       compileMethods,
47.       compileAuthorizers,
48.       compileDeployment,
49.       compilePermissions,
50.       compileStage,
51.       getMethodAuthorization,
52.       getMethodIntegration,
53.       getMethodResponses
54.     );
55. 
56.     this.hooks = {
57.       'package:compileEvents': () => {
58.         this.validated = this.validate();
59. 
60.         if (this.validated.events.length === 0) {
61.           return BbPromise.resolve();
62.         }
63. 
64.         return BbPromise.bind(this)
65.           .then(this.compileRestApi)
66.           .then(this.compileResources)
67.           .then(this.compileCors)
68.           .then(this.compileMethods)
69.           .then(this.compileAuthorizers)
70.           .then(this.compileDeployment)
71.           .then(this.compileApiKeys)
72.           .then(this.compileUsagePlan)
73.           .then(this.compileUsagePlanKeys)
74.           .then(this.compilePermissions)
75.           .then(this.compileStage);
76.       },
77. 
78.       // TODO should be removed once AWS fixes the CloudFormation problems using a separate Stage
79.       'after:deploy:deploy': () => {
80.         const getServiceState = require('../../../../lib/getServiceState').getServiceState;
81. 
82.         const state = getServiceState.call(this);
83.         const updateStage = require('./lib/hack/updateStage').updateStage;
84. 
85.         this.state = state;
86.         return updateStage.call(this);
87.       },
88. 
89.       // TODO should be removed once AWS fixes the removal via CloudFormation
90.       'before:remove:remove': () => {
91.         // eslint-disable-next-line no-shadow
92.         const validate = require('../../../../lib/validate').validate;
93.         // eslint-disable-next-line max-len
94.         const disassociateUsagePlan = require('./lib/hack/disassociateUsagePlan')
95.           .disassociateUsagePlan;
96. 
97.         return BbPromise.bind(this)
98.           .then(validate)
99.           .then(disassociateUsagePlan);
100.       },
101.     };
102.   }
103. }
104. 
105. module.exports = AwsCompileApigEvents;


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 1 - 2000
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. 
5. const DEFAULT_COMMON_TEMPLATE = `
6.   #define( $loop )
7.     {
8.     #foreach($key in $map.keySet())
9.         #set( $k = $util.escapeJavaScript($key) )
10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\'", "'") )
11.         "$k":
12.           "$v"
13.           #if( $foreach.hasNext ) , #end
14.     #end
15.     }
16.   #end
17. 
18.   {
19.     "body": $body,
20.     "method": "$context.httpMethod",
21.     "principalId": "$context.authorizer.principalId",
22.     "stage": "$context.stage",
23. 
24.     "cognitoPoolClaims" : {
25.        extraCognitoPoolClaims
26.        "sub": "$context.authorizer.claims.sub"
27.     },
28. 
29.     #set( $map = $context.authorizer )
30.     "enhancedAuthContext": $loop,
31. 
32.     #set( $map = $input.params().header )
33.     "headers": $loop,
34. 
35.     #set( $map = $input.params().querystring )
36.     "query": $loop,
37. 
38.     #set( $map = $input.params().path )
39.     "path": $loop,
40. 
41.     #set( $map = $context.identity )
42.     "identity": $loop,
43. 
44.     #set( $map = $stageVariables )
45.     "stageVariables": $loop,
46. 
47.     "requestPath": "$context.resourcePath"
48.   }
49. `;
50. 
51. module.exports = {
52.   getMethodIntegration(http, { lambdaLogicalId, lambdaAliasName }) {
53.     const type = http.integration || 'AWS_PROXY';
54.     const integration = {
55.       IntegrationHttpMethod: 'POST',
56.       Type: type,
57.     };
58. 
59.     // Valid integrations are:
60.     // * `HTTP` for integrating with an HTTP back end,
61.     // * `AWS` for any AWS service endpoints,
62.     // * `MOCK` for testing without actually invoking the back end,
63.     // * `HTTP_PROXY` for integrating with the HTTP proxy integration, or
64.     // * `AWS_PROXY` for integrating with the Lambda proxy integration type (the default)
65.     if (type === 'AWS' || type === 'AWS_PROXY') {
66.       Object.assign(integration, {
67.         Uri: {
68.           'Fn::Join': [
69.             '',
70.             [
71.               'arn:',
72.               { Ref: 'AWS::Partition' },
73.               ':apigateway:',
74.               { Ref: 'AWS::Region' },
75.               ':lambda:path/2015-03-31/functions/',
76.               ...[],
77.               { 'Fn::GetAtt': [lambdaLogicalId, 'Arn'] },
78.               ...(lambdaAliasName ? [':', lambdaAliasName] : []),
79.               '/invocations',
80.             ],
81.           ],
82.         },
83.       });
84.     } else if (type === 'HTTP' || type === 'HTTP_PROXY') {
85.       const integrationHttpMethod = (http.request && http.request.method) || http.method;
86.       Object.assign(integration, {
87.         Uri: http.request && http.request.uri,
88.         IntegrationHttpMethod: integrationHttpMethod.toUpperCase(),
89.       });
90.       if (http.connectionType) {
91.         Object.assign(integration, {
92.           ConnectionType: http.connectionType,
93.           ConnectionId: http.connectionId,
94.         });
95.       }
96.     } else if (type === 'MOCK') {
97.       // nothing to do but kept here for reference
98.     }
99. 
100.     if (type === 'AWS' || type === 'HTTP' || type === 'MOCK') {
101.       Object.assign(integration, {
102.         PassthroughBehavior: http.request && http.request.passThrough,
103.         ContentHandling: http.request && http.request.contentHandling,
104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === 'AWS'),
105.         IntegrationResponses: this.getIntegrationResponses(http),
106.       });
107.     }
108.     if (
109.       ((type === 'AWS' || type === 'HTTP' || type === 'HTTP_PROXY') &&
110.         http.request &&
111.         http.request.parameters &&
112.         Object.keys(http.request.parameters).length) ||
113.       http.async
114.     ) {
115.       Object.assign(integration, {
116.         RequestParameters: this.getIntegrationRequestParameters(http),
117.       });
118.     }
119. 
120.     return {
121.       Properties: {
122.         Integration: integration,
123.       },
124.     };
125.   },
126. 
127.   getIntegrationResponses(http) {
128.     const integrationResponses = [];
129. 
130.     if (http.response) {
131.       const integrationResponseHeaders = [];
132. 
133.       if (http.cors) {
134.         let origin = http.cors.origin;
135. 
136.         // TODO remove once "origins" config is deprecated
137.         if (http.cors.origins && http.cors.origins.length) {
138.           origin = http.cors.origins.join(',');
139.         }
140. 
141.         _.merge(integrationResponseHeaders, {
142.           'Access-Control-Allow-Origin': `'${origin}'`,
143.         });
144. 
145.         // Only set Access-Control-Allow-Credentials when explicitly allowed (omit if false)
146.         if (http.cors.allowCredentials) {
147.           integrationResponseHeaders['Access-Control-Allow-Credentials'] = 'true';
148.         }
149.       }
150. 
151.       if (http.response.headers) {
152.         _.merge(integrationResponseHeaders, http.response.headers);
153.       }
154. 
155.       _.forEach(http.response.statusCodes, (config, statusCode) => {
156.         const responseParameters = _.mapKeys(
157.           integrationResponseHeaders,
158.           (value, header) => `method.response.header.${header}`
159.         );
160. 
161.         const integrationResponse = {
162.           StatusCode: statusCode,
163.           SelectionPattern: config.pattern || '',
164.           ResponseParameters: responseParameters,
165.           ResponseTemplates: {},
166.           ContentHandling: statusCode.startsWith('2') ? http.response.contentHandling : undefined,
167.         };
168. 
169.         if (config.headers) {
170.           _.merge(
171.             integrationResponse.ResponseParameters,
172.             _.mapKeys(config.headers, (value, header) => `method.response.header.${header}`)
173.           );
174.         }
175. 
176.         if (http.response.template) {
177.           _.merge(integrationResponse.ResponseTemplates, {
178.             'application/json': http.response.template,
179.           });
180.         }
181. 
182.         if (config.template) {
183.           const template =
184.             typeof config.template === 'string'
185.               ? { 'application/json': config.template }
186.               : config.template;
187. 
188.           _.merge(integrationResponse.ResponseTemplates, template);
189.         }
190. 
191.         integrationResponses.push(integrationResponse);
192.       });
193.     }
194. 
195.     return integrationResponses;
196.   },
197. 
198.   getIntegrationRequestTemplates(http, useDefaults) {
199.     // default request templates
200.     const integrationRequestTemplates = {};
201. 
202.     // Only set defaults for AWS (lambda) integration
203.     if (useDefaults) {
204.       Object.assign(integrationRequestTemplates, {
205.         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
206.         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
207.       });
208.     }
209. 
210.     // set custom request templates if provided
211.     if (http.request && typeof http.request.template === 'object') {
212.       Object.assign(integrationRequestTemplates, http.request.template);
213.     }
214. 
215.     return Object.keys(integrationRequestTemplates).length
216.       ? integrationRequestTemplates
217.       : undefined;
218.   },
219.   getIntegrationRequestParameters(http) {
220.     const parameters = {};
221.     if (http.request && http.request.parameters) {
222.       _.forEach(http.request.parameters, (value, key) => {
223.         parameters[`integration.${key.substring('method.'.length)}`] = value.mappedValue || key;
224.       });
225.     }
226. 
227.     if (http.async) {
228.       parameters['integration.request.header.X-Amz-Invocation-Type'] = "'Event'";
229.     }
230. 
231.     return parameters;
232.   },
233. 
234.   DEFAULT_JSON_REQUEST_TEMPLATE: `
235.     #set( $body = $input.json("$") )
236. 
237.     ${DEFAULT_COMMON_TEMPLATE}
238.   `,
239. 
240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `
241.     #define( $body )
242.       {
243.       #foreach( $token in $input.path('$').split('&') )
244.         #set( $keyVal = $token.split('=') )
245.         #set( $keyValSize = $keyVal.size() )
246.         #if( $keyValSize >= 1 )
247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )
248.           #if( $keyValSize >= 2 )
249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\'","'"))
250.           #else
251.             #set( $val = '' )
252.           #end
253.           "$key": "$val"#if($foreach.hasNext),#end
254.         #end
255.       #end
256.       }
257.     #end
258. 
259.     ${DEFAULT_COMMON_TEMPLATE}
260.   `,
261. };


File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
Line number range: 1 - 2000
Content:
1. 'use strict';
2. 
3. const _ = require('lodash');
4. const awsArnRegExs = require('../../../../../utils/arnRegularExpressions');
5. const resolveLambdaTarget = require('../../../../../utils/resolveLambdaTarget');
6. 
7. const NOT_FOUND = -1;
8. const DEFAULT_STATUS_CODES = {
9.   200: {
10.     pattern: '',
11.   },
12.   400: {
13.     pattern: '[\\s\\S]*\\[400\\][\\s\\S]*',
14.   },
15.   401: {
16.     pattern: '[\\s\\S]*\\[401\\][\\s\\S]*',
17.   },
18.   403: {
19.     pattern: '[\\s\\S]*\\[403\\][\\s\\S]*',
20.   },
21.   404: {
22.     pattern: '[\\s\\S]*\\[404\\][\\s\\S]*',
23.   },
24.   422: {
25.     pattern: '[\\s\\S]*\\[422\\][\\s\\S]*',
26.   },
27.   500: {
28.     pattern: '[\\s\\S]*(Process\\s?exited\\s?before\\s?completing\\s?request|\\[500\\])[\\s\\S]*',
29.   },
30.   502: {
31.     pattern: '[\\s\\S]*\\[502\\][\\s\\S]*',
32.   },
33.   504: {
34.     pattern: '([\\s\\S]*\\[504\\][\\s\\S]*)|(.*Task timed out after \\d+\\.\\d+ seconds$)',
35.   },
36. };
37. 
38. module.exports = {
39.   validate() {
40.     const events = [];
41.     const corsPreflight = {};
42. 
43.     _.forEach(this.serverless.service.functions, (functionObject, functionName) => {
44.       (functionObject.events || []).forEach(event => {
45.         if (event.http) {
46.           const http = this.getHttp(event, functionName);
47. 
48.           http.path = this.getHttpPath(http, functionName);
49.           http.method = this.getHttpMethod(http, functionName);
50. 
51.           if (http.authorizer) {
52.             http.authorizer = this.getAuthorizer(http, functionName);
53.           }
54. 
55.           if (http.cors) {
56.             http.cors = this.getCors(http);
57. 
58.             const cors = corsPreflight[http.path] || {};
59. 
60.             cors.headers = _.union(http.cors.headers, cors.headers);
61.             cors.methods = _.union(http.cors.methods, cors.methods);
62.             cors.origins = _.union(http.cors.origins, cors.origins);
63.             cors.origin = http.cors.origin || '*';
64.             cors.allowCredentials = cors.allowCredentials || http.cors.allowCredentials;
65. 
66.             // when merging, last one defined wins
67.             if (http.cors.maxAge) {
68.               cors.maxAge = http.cors.maxAge;
69.             }
70. 
71.             if (http.cors.cacheControl) {
72.               cors.cacheControl = http.cors.cacheControl;
73.             }
74. 
75.             corsPreflight[http.path] = cors;
76.           }
77. 
78.           http.integration = this.getIntegration(http, functionName);
79. 
80.           if (http.integration === 'HTTP' || http.integration === 'HTTP_PROXY') {
81.             if (!http.request || !http.request.uri) {
82.               const errorMessage = [
83.                 `You need to set the request uri when using the ${http.integration} integration.`,
84.               ];
85.               throw new this.serverless.classes.Error(errorMessage);
86.             }
87. 
88.             http.connectionType = this.getConnectionType(http, functionName);
89. 
90.             if (http.connectionType && http.connectionType === 'VPC_LINK' && !http.connectionId) {
91.               const errorMessage = [
92.                 `You need to set connectionId when using ${http.connectionType} connectionType.`,
93.               ];
94.               throw new this.serverless.classes.Error(errorMessage);
95.             }
96.           }
97. 
98.           if (http.integration === 'AWS' || http.integration === 'HTTP') {
99.             http.request = this.getRequest(http);
100.             http.request.passThrough = this.getRequestPassThrough(http);
101.             http.response = this.getResponse(http);
102.             if (http.integration === 'AWS' && !Object.keys(http.response).length) {
103.               http.response = {
104.                 statusCodes: DEFAULT_STATUS_CODES,
105.               };
106.             }
107.           } else if (http.integration === 'AWS_PROXY' || http.integration === 'HTTP_PROXY') {
108.             // show a warning when request / response config is used with AWS_PROXY (LAMBDA-PROXY)
109.             if (http.request) {
110.               const keys = Object.keys(http.request);
111.               const allowedKeys =
112.                 http.integration === 'AWS_PROXY'
113.                   ? ['parameters', 'schema']
114.                   : ['parameters', 'uri', 'schema'];
115. 
116.               if (_.difference(keys, allowedKeys).length) {
117.                 const requestWarningMessage = [
118.                   `Warning! You're using the ${http.integration} in combination with a request`,
119.                   ` configuration in your function "${functionName}". Only the `,
120.                   allowedKeys.map(value => `request.${value}`).join(', '),
121.                   ` configs are available in conjunction with ${http.integration}.`,
122.                   ' Serverless will remove this configuration automatically',
123.                   ' before deployment.',
124.                 ].join('');
125.                 this.serverless.cli.log(requestWarningMessage);
126.                 for (const key of keys) {
127.                   if (!allowedKeys.includes(key)) {
128.                     delete http.request[key];
129.                   }
130.                 }
131.               }
132.               if (Object.keys(http.request).length === 0) {
133.                 // No keys left, delete the request object
134.                 delete http.request;
135.               } else {
136.                 http.request = this.getRequest(http);
137.               }
138.             }
139.             if (http.response) {
140.               const warningMessage = [
141.                 `Warning! You're using the ${http.integration} in combination with response`,
142.                 ` configuration in your function "${functionName}".`,
143.                 ' Serverless will remove this configuration automatically before deployment.',
144.               ].join('');
145.               this.serverless.cli.log(warningMessage);
146. 
147.               delete http.response;
148.             }
149.           }
150. 
151.           const provider = this.serverless.getProvider('aws');
152.           const stage = provider.getStage();
153.           const validAPIGatewayStageNamePattern = /^[-_a-zA-Z0-9]+$/;
154.           if (!validAPIGatewayStageNamePattern.test(stage)) {
155.             throw new this.serverless.classes.Error(
156.               [
157.                 `Invalid stage name ${stage}:`,
158.                 'it should contains only [-_a-zA-Z0-9] for AWS provider if http event are present',
159.                 'according to API Gateway limitation.',
160.               ].join(' ')
161.             );
162.           }
163. 
164.           events.push({
165.             functionName,
166.             http,
167.           });
168.         }
169.       });
170.     });
171. 
172.     return {
173.       events,
174.       corsPreflight,
175.     };
176.   },
177. 
178.   getHttp(event, functionName) {
179.     if (typeof event.http === 'object') {
180.       return event.http;
181.     } else if (typeof event.http === 'string') {
182.       return {
183.         method: event.http.split(' ')[0],
184.         path: event.http.split(' ')[1],
185.       };
186.     }
187.     const errorMessage = [
188.       `Invalid http event in function "${functionName}"`,
189.       ' in serverless.yml.',
190.       ' If you define an http event, make sure you pass a valid value for it,',
191.       ' either as string syntax, or object syntax.',
192.       ' Please check the docs for more options.',
193.     ].join('');
194.     throw new this.serverless.classes.Error(errorMessage);
195.   },
196. 
197.   getHttpPath(http, functionName) {
198.     if (http && typeof http.path === 'string') {
199.       return http.path.replace(/^\//, '').replace(/\/$/, '');
200.     }
201.     const errorMessage = [
202.       `Missing or invalid "path" property in function "${functionName}"`,
203.       ' for http event in serverless.yml.',
204.       ' If you define an http event, make sure you pass a valid value for it,',
205.       ' either as string syntax, or object syntax.',
206.       ' Please check the indentation of your config values if you use the object syntax.',
207.       ' Please check the docs for more options.',
208.     ].join('');
209.     throw new this.serverless.classes.Error(errorMessage);
210.   },
211. 
212.   getHttpMethod(http, functionName) {
213.     if (typeof http.method === 'string') {
214.       const method = http.method.toLowerCase();
215. 
216.       const allowedMethods = ['get', 'post', 'put', 'patch', 'options', 'head', 'delete', 'any'];
217.       if (allowedMethods.indexOf(method) === -1) {
218.         const errorMessage = [
219.           `Invalid APIG method "${http.method}" in function "${functionName}".`,
220.           ` AWS supported methods are: ${allowedMethods.join(', ')}.`,
221.         ].join('');
222.         throw new this.serverless.classes.Error(errorMessage);
223.       }
224.       return method;
225.     }
226.     const errorMessage = [
227.       `Missing or invalid "method" property in function "${functionName}"`,
228.       ' for http event in serverless.yml.',
229.       ' If you define an http event, make sure you pass a valid value for it,',
230.       ' either as string syntax, or object syntax.',
231.       ' Please check the docs for more options.',
232.     ].join('');
233.     throw new this.serverless.classes.Error(errorMessage);
234.   },
235. 
236.   getAuthorizer(http, functionName) {
237.     const authorizer = http.authorizer;
238. 
239.     let type;
240.     let name;
241.     let arn;
242.     let managedExternally;
243.     let identitySource;
244.     let resultTtlInSeconds;
245.     let identityValidationExpression;
246.     let claims;
247.     let authorizerId;
248.     let scopes;
249.     let authorizerFunctionName;
250.     let logicalId;
251. 
252.     if (typeof authorizer === 'string') {
253.       if (authorizer.toUpperCase() === 'AWS_IAM') {
254.         type = 'AWS_IAM';
255.       } else if (authorizer.indexOf(':') === -1) {
256.         authorizerFunctionName = name = authorizer;
257.       } else {
258.         arn = authorizer;
259.         name = this.provider.naming.extractAuthorizerNameFromArn(arn);
260.       }
261.     } else if (typeof authorizer === 'object') {
262.       if (authorizer.type && authorizer.authorizerId) {
263.         type = authorizer.type;
264.         authorizerId = authorizer.authorizerId;
265.       } else if (authorizer.type && authorizer.type.toUpperCase() === 'AWS_IAM') {
266.         type = 'AWS_IAM';
267.       } else if (authorizer.arn) {
268.         arn = authorizer.arn;
269.         if (typeof authorizer.name === 'string') {
270.           name = authorizer.name;
271.         } else if (
272.           authorizer.type &&
273.           authorizer.type.toUpperCase() === 'COGNITO_USER_POOLS' &&
274.           _.isObject(authorizer.arn)
275.         ) {
276.           throw new this.serverless.classes.Error(
277.             'Please provide an authorizer name for authorizers of type COGNITO_USER_POOLS'
278.           );
279.         } else {
280.           name = this.provider.naming.extractAuthorizerNameFromArn(arn);
281.         }
282.       } else if (authorizer.name) {
283.         authorizerFunctionName = name = authorizer.name;
284.       } else {
285.         throw new this.serverless.classes.Error('Please provide either an authorizer name or ARN');
286.       }
287. 
288.       if (!type) {
289.         type = authorizer.type;
290.       }
291. 
292.       resultTtlInSeconds = Number.parseInt(authorizer.resultTtlInSeconds, 10);
293.       resultTtlInSeconds = Number.isNaN(resultTtlInSeconds) ? 300 : resultTtlInSeconds;
294.       claims = authorizer.claims || [];
295.       scopes = authorizer.scopes;
296. 
297.       identitySource = authorizer.identitySource;
298.       identityValidationExpression = authorizer.identityValidationExpression;
299. 
300.       if (typeof authorizer.managedExternally === 'undefined') {
301.         managedExternally = false;
302.       } else if (typeof authorizer.managedExternally === 'boolean') {
303.         managedExternally = authorizer.managedExternally;
304.       } else {
305.         const errorMessage = [
306.           `managedExternally property in authorizer for function ${functionName} is not boolean.`,
307.           ' Please check the docs for more info.',
308.         ].join('');
309.         throw new this.serverless.classes.Error(errorMessage);
310.       }
311.     } else {
312.       const errorMessage = [
313.         `authorizer property in function ${functionName} is not an object nor a string.`,
314.         ' The correct format is: authorizer: functionName',
315.         ' OR an object containing a name property.',
316.         ' Please check the docs for more info.',
317.       ].join('');
318.       throw new this.serverless.classes.Error(errorMessage);
319.     }
320. 
321.     if (authorizerFunctionName) {
322.       const authorizerFunctionObj = this.serverless.service.getFunction(authorizerFunctionName);
323.       arn = resolveLambdaTarget(authorizerFunctionName, authorizerFunctionObj);
324.       if (authorizerFunctionObj.targetAlias) {
325.         logicalId = authorizerFunctionObj.targetAlias.logicalId;
326.       }
327.     }
328. 
329.     if (typeof managedExternally === 'undefined') {
330.       managedExternally = false;
331.     }
332. 
333.     if (typeof identitySource === 'undefined') {
334.       identitySource = 'method.request.header.Authorization';
335.     }
336. 
337.     const integration = this.getIntegration(http);
338.     if (
339.       integration === 'AWS_PROXY' &&
340.       typeof arn === 'string' &&
341.       awsArnRegExs.cognitoIdpArnExpr.test(arn) &&
342.       claims &&
343.       claims.length > 0
344.     ) {
345.       const errorMessage = [
346.         'Cognito claims can only be filtered when using the lambda integration type',
347.       ];
348.       throw new this.serverless.classes.Error(errorMessage);
349.     }
350. 
351.     return {
352.       type,
353.       name,
354.       arn,
355.       managedExternally,
356.       authorizerId,
357.       logicalId,
358.       resultTtlInSeconds,
359.       identitySource,
360.       identityValidationExpression,
361.       claims,
362.       scopes,
363.     };
364.   },
365. 
366.   getCors(http) {
367.     const headers = [
368.       'Content-Type',
369.       'X-Amz-Date',
370.       'Authorization',
371.       'X-Api-Key',
372.       'X-Amz-Security-Token',
373.       'X-Amz-User-Agent',
374.     ];
375. 
376.     let cors = {
377.       origins: ['*'],
378.       origin: '*',
379.       methods: ['OPTIONS'],
380.       headers,
381.       allowCredentials: false,
382.     };
383. 
384.     if (typeof http.cors === 'object') {
385.       cors = http.cors;
386.       cors.methods = cors.methods || [];
387.       cors.allowCredentials = Boolean(cors.allowCredentials);
388. 
389.       if (cors.origins && cors.origin) {
390.         const errorMessage = [
391.           'You can only use "origin" or "origins",',
392.           ' but not both at the same time to configure CORS.',
393.           ' Please check the docs for more info.',
394.         ].join('');
395.         throw new this.serverless.classes.Error(errorMessage);
396.       }
397. 
398.       const corsHeaders = cors.headers;
399.       if (corsHeaders) {
400.         if (typeof corsHeaders === 'string') {
401.           cors.headers = [corsHeaders];
402.         } else if (!Array.isArray(corsHeaders)) {
403.           const errorMessage = [
404.             'CORS header values must be provided as an array or a single string value.',
405.             ' Please check the docs for more info.',
406.           ].join('');
407.           throw new this.serverless.classes.Error(errorMessage);
408.         }
409.       } else {
410.         cors.headers = headers;
411.       }
412. 
413.       if (cors.methods.indexOf('OPTIONS') === NOT_FOUND) {
414.         cors.methods.push('OPTIONS');
415.       }
416. 
417.       if (cors.methods.indexOf(http.method.toUpperCase()) === NOT_FOUND) {
418.         cors.methods.push(http.method.toUpperCase());
419.       }
420.       if (cors.maxAge) {
421.         if (cors.maxAge < 1) {
422.           const errorMessage = 'maxAge should be an integer over 0';
423.           throw new this.serverless.classes.Error(errorMessage);
424.         }
425.       }
426.     } else {
427.       cors.methods.push(http.method.toUpperCase());
428.     }
429.     return cors;
430.   },
431. 
432.   getIntegration(http, functionName) {
433.     if (http.integration) {
434.       // normalize the integration for further processing
435.       const normalizedIntegration = http.integration.toUpperCase().replace('-', '_');
436.       const allowedIntegrations = [
437.         'LAMBDA_PROXY',
438.         'LAMBDA',
439.         'AWS',
440.         'AWS_PROXY',
441.         'HTTP',
442.         'HTTP_PROXY',
443.         'MOCK',
444.       ];
445.       // check if the user has entered a non-valid integration
446.       if (allowedIntegrations.indexOf(normalizedIntegration) === NOT_FOUND) {
447.         const errorMessage = [
448.           `Invalid APIG integration "${http.integration}"`,
449.           ` in function "${functionName}".`,
450.           ' Supported integrations are:',
451.           ' lambda, lambda-proxy, aws, aws-proxy, http, http-proxy, mock.',
452.         ].join('');
453.         throw new this.serverless.classes.Error(errorMessage);
454.       }
455.       if (normalizedIntegration === 'LAMBDA') {
456.         return 'AWS';
457.       } else if (normalizedIntegration === 'LAMBDA_PROXY') {
458.         return 'AWS_PROXY';
459.       }
460.       return normalizedIntegration;
461.     }
462. 
463.     if (http.async) {
464.       return 'AWS';
465.     }
466. 
467.     return 'AWS_PROXY';
468.   },
469. 
470.   getConnectionType(http, functionName) {
471.     if (http.connectionType) {
472.       // normalize the connection type for further processing
473.       const normalizedConnectionType = http.connectionType.toUpperCase().replace('-', '_');
474.       const allowedConnectionTypes = ['VPC_LINK'];
475.       // check if the user has entered a non-valid connection type
476.       if (allowedConnectionTypes.indexOf(normalizedConnectionType) === NOT_FOUND) {
477.         const errorMessage = [
478.           `Invalid APIG connectionType "${http.connectionType}"`,
479.           ` in function "${functionName}".`,
480.           ' Supported connectionTyps are:',
481.           ' vpc-link.',
482.         ].join('');
483.         throw new this.serverless.classes.Error(errorMessage);
484.       }
485.       return normalizedConnectionType;
486.     }
487. 
488.     return null;
489.   },
490. 
491.   getRequest(http) {
492.     if (http.request) {
493.       const request = http.request;
494. 
495.       if (typeof http.request !== 'object') {
496.         const errorMessage = [
497.           'Request config must be provided as an object.',
498.           ' Please check the docs for more info.',
499.         ].join('');
500.         throw new this.serverless.classes.Error(errorMessage);
501.       }
502.       if (http.request.template && typeof http.request.template !== 'object') {
503.         const errorMessage = [
504.           'Template config must be provided as an object.',
505.           ' Please check the docs for more info.',
506.         ].join('');
507.         throw new this.serverless.classes.Error(errorMessage);
508.       }
509. 
510.       if (request.parameters) {
511.         request.parameters = this.getRequestParameters(request);
512.       }
513. 
514.       return request;
515.     }
516. 
517.     return {};
518.   },
519. 
520.   getRequestParameters(httpRequest) {
521.     const parameters = {};
522.     // only these locations are currently supported
523.     const locations = ['querystrings', 'paths', 'headers'];
524.     locations.forEach(location => {
525.       // strip the plural s
526.       const singular = location.substring(0, location.length - 1);
527.       _.forEach(httpRequest.parameters[location], (value, key) => {
528.         parameters[`method.request.${singular}.${key}`] = value;
529.       });
530.     });
531.     return parameters;
532.   },
533. 
534.   getRequestPassThrough(http) {
535.     const requestPassThroughBehaviors = ['NEVER', 'WHEN_NO_MATCH', 'WHEN_NO_TEMPLATES'];
536. 
537.     if (http.request.passThrough) {
538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {
539.         const errorMessage = [
540.           'Request passThrough "',
541.           http.request.passThrough,
542.           '" is not one of ',
543.           requestPassThroughBehaviors.join(', '),
544.         ].join('');
545.         throw new this.serverless.classes.Error(errorMessage);
546.       }
547. 
548.       return http.request.passThrough;
549.     }
550. 
551.     // Validate() sets the passThrough default to NEVER. This is inappropriate
552.     // for HTTP and MOCK integrations, where there is no default request template defined.
553.     const type = http.integration || 'AWS_PROXY';
554.     if (type === 'AWS') {
555.       return requestPassThroughBehaviors[0];
556.     } else if (type === 'HTTP' || type === 'MOCK') {
557.       return undefined;
558.     }
559. 
560.     return 'WHEN_NO_MATCH';
561.   },
562. 
563.   getResponse(http) {
564.     if (http.response) {
565.       const response = http.response;
566. 
567.       if (typeof response !== 'object') {
568.         const errorMessage = [
569.           'Response config must be provided as an object.',
570.           ' Please check the docs for more info.',
571.         ].join('');
572.         throw new this.serverless.classes.Error(errorMessage);
573.       }
574.       if (response.headers && typeof response.headers !== 'object') {
575.         const errorMessage = [
576.           'Response headers must be provided as an object.',
577.           ' Please check the docs for more info.',
578.         ].join('');
579.         throw new this.serverless.classes.Error(errorMessage);
580.       }
581. 
582.       if (response.statusCodes) {
583.         response.statusCodes = Object.assign({}, response.statusCodes);
584. 
585.         if (!_.values(response.statusCodes).some(code => code.pattern === '')) {
586.           response.statusCodes['200'] = DEFAULT_STATUS_CODES['200'];
587.         }
588.       } else {
589.         response.statusCodes = DEFAULT_STATUS_CODES;
590.       }
591. 
592.       return response;
593.     }
594. 
595.     return {};
596.   },
597. 
598.   getLambdaName(arn) {
599.     const splitArn = arn.split(':');
600.     const splitLambdaName = splitArn[splitArn.length - 1].split('-');
601.     return splitLambdaName[splitLambdaName.length - 1];
602.   },
603. };


File: lib/plugins/aws/provider/awsProvider.js
Line number range: 1 - 2000
Content:
1. 'use strict';
2. 
3. const AWS = require('aws-sdk');
4. const BbPromise = require('bluebird');
5. const HttpsProxyAgent = require('https-proxy-agent');
6. const url = require('url');
7. const chalk = require('chalk');
8. const _ = require('lodash');
9. const naming = require('../lib/naming.js');
10. const https = require('https');
11. const fs = require('fs');
12. const objectHash = require('object-hash');
13. const PromiseQueue = require('promise-queue');
14. const getS3EndpointForRegion = require('../utils/getS3EndpointForRegion');
15. const readline = require('readline');
16. 
17. const isLambdaArn = RegExp.prototype.test.bind(/^arn:[^:]+:lambda:/);
18. 
19. const constants = {
20.   providerName: 'aws',
21. };
22. 
23. PromiseQueue.configure(BbPromise.Promise);
24. 
25. const MAX_RETRIES = (() => {
26.   const userValue = Number(process.env.SLS_AWS_REQUEST_MAX_RETRIES);
27.   return userValue >= 0 ? userValue : 4;
28. })();
29. 
30. const impl = {
31.   /**
32.    * Determine whether the given credentials are valid.  It turned out that detecting invalid
33.    * credentials was more difficult than detecting the positive cases we know about.  Hooray for
34.    * whak-a-mole!
35.    * @param credentials The credentials to test for validity
36.    * @return {boolean} Whether the given credentials were valid
37.    */
38.   validCredentials: credentials => {
39.     let result = false;
40.     if (credentials) {
41.       if (
42.         // valid credentials loaded
43.         (credentials.accessKeyId &&
44.           credentials.accessKeyId !== 'undefined' &&
45.           credentials.secretAccessKey &&
46.           credentials.secretAccessKey !== 'undefined') ||
47.         // a role to assume has been successfully loaded, the associated STS request has been
48.         // sent, and the temporary credentials will be asynchronously delivered.
49.         credentials.roleArn
50.       ) {
51.         result = true;
52.       }
53.     }
54.     return result;
55.   },
56.   /**
57.    * Add credentials, if present, to the given results
58.    * @param results The results to add the given credentials to if they are valid
59.    * @param credentials The credentials to validate and add to the results if valid
60.    */
61.   addCredentials: (results, credentials) => {
62.     if (impl.validCredentials(credentials)) {
63.       results.credentials = credentials; // eslint-disable-line no-param-reassign
64.     }
65.   },
66.   /**
67.    * Add credentials, if present, from the environment
68.    * @param results The results to add environment credentials to
69.    * @param prefix The environment variable prefix to use in extracting credentials
70.    */
71.   addEnvironmentCredentials: (results, prefix) => {
72.     if (prefix) {
73.       const environmentCredentials = new AWS.EnvironmentCredentials(prefix);
74.       impl.addCredentials(results, environmentCredentials);
75.     }
76.   },
77.   /**
78.    * Add credentials from a profile, if the profile and credentials for it exists
79.    * @param results The results to add profile credentials to
80.    * @param profile The profile to load credentials from
81.    */
82.   addProfileCredentials: (results, profile) => {
83.     if (profile) {
84.       const params = { profile };
85.       if (process.env.AWS_SHARED_CREDENTIALS_FILE) {
86.         params.filename = process.env.AWS_SHARED_CREDENTIALS_FILE;
87.       }
88. 
89.       // Setup a MFA callback for asking the code from the user.
90.       params.tokenCodeFn = (mfaSerial, callback) => {
91.         const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
92.         rl.question(`Enter MFA code for ${mfaSerial}: `, answer => {
93.           rl.close();
94.           callback(null, answer);
95.         });
96.       };
97. 
98.       const profileCredentials = new AWS.SharedIniFileCredentials(params);
99.       if (
100.         !(
101.           profileCredentials.accessKeyId ||
102.           profileCredentials.sessionToken ||
103.           profileCredentials.roleArn
104.         )
105.       ) {
106.         throw new Error(`Profile ${profile} does not exist`);
107.       }
108. 
109.       impl.addCredentials(results, profileCredentials);
110.     }
111.   },
112.   /**
113.    * Add credentials, if present, from a profile that is specified within the environment
114.    * @param results The prefix of the profile's declaration in the environment
115.    * @param prefix The prefix for the environment variable
116.    */
117.   addEnvironmentProfile: (results, prefix) => {
118.     if (prefix) {
119.       const profile = process.env[`${prefix}_PROFILE`];
120.       impl.addProfileCredentials(results, profile);
121.     }
122.   },
123. };
124. 
125. class AwsProvider {
126.   static getProviderName() {
127.     return constants.providerName;
128.   }
129. 
130.   constructor(serverless, options) {
131.     this.naming = { provider: this };
132.     this.options = options;
133.     this.provider = this; // only load plugin in an AWS service context
134.     this.serverless = serverless;
135.     this.sdk = AWS;
136.     this.serverless.setProvider(constants.providerName, this);
137.     if (this.serverless.service.provider.name === 'aws') {
138.       this.serverless.service.provider.region = this.getRegion();
139.       require('../../../utils/awsSdkPatch');
140. 
141.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8016
142.       serverless.configSchemaHandler.defineProvider('aws', {
143.         definitions: {
144.           awsArn: {
145.             type: 'string',
146.             pattern: '^arn:',
147.           },
148.           awsCfImport: {
149.             type: 'object',
150.             properties: {
151.               'Fn::ImportValue': { type: 'string' },
152.             },
153.             additionalProperties: false,
154.             required: ['Fn::ImportValue'],
155.           },
156.         },
157.         provider: {
158.           properties: {
159.             httpApi: {
160.               type: 'object',
161.               properties: {
162.                 authorizers: {
163.                   type: 'object',
164.                   additionalProperties: {
165.                     type: 'object',
166.                     properties: {
167.                       name: { type: 'string' },
168.                       identitySource: { type: 'string' },
169.                       issuerUrl: { type: 'string' },
170.                       audience: {
171.                         oneOf: [{ type: 'string' }, { type: 'array', items: { type: 'string' } }],
172.                       },
173.                     },
174.                     required: ['identitySource', 'issuerUrl', 'audience'],
175.                     additionalProperties: false,
176.                   },
177.                 },
178.                 cors: {
179.                   oneOf: [
180.                     { type: 'boolean' },
181.                     {
182.                       type: 'object',
183.                       properties: {
184.                         allowedOrigins: {
185.                           oneOf: [{ type: 'string' }, { type: 'array', items: { type: 'string' } }],
186.                         },
187.                         allowedHeaders: {
188.                           oneOf: [{ type: 'string' }, { type: 'array', items: { type: 'string' } }],
189.                         },
190.                         allowedMethods: {
191.                           oneOf: [{ type: 'string' }, { type: 'array', items: { type: 'string' } }],
192.                         },
193.                         allowCredentials: { type: 'boolean' },
194.                         exposedResponseHeaders: {
195.                           oneOf: [{ type: 'string' }, { type: 'array', items: { type: 'string' } }],
196.                         },
197.                         maxAge: { type: 'integer', minimum: 0 },
198.                       },
199.                       additionalProperties: false,
200.                     },
201.                   ],
202.                 },
203.                 id: { oneOf: [{ type: 'string' }, { $ref: '#/definitions/awsCfImport' }] },
204.                 name: { type: 'string' },
205.                 payload: { type: 'string' },
206.                 timeout: { type: 'number', minimum: 0.05, maximum: 30 },
207.               },
208.               additionalProperties: false,
209.             },
210.             logs: {
211.               type: 'object',
212.               properties: {
213.                 httpApi: {
214.                   oneOf: [
215.                     { type: 'boolean' },
216.                     {
217.                       type: 'object',
218.                       properties: {
219.                         format: { type: 'string' },
220.                       },
221.                       additionalProperties: false,
222.                     },
223.                   ],
224.                 },
225.               },
226.             },
227.             resourcePolicy: {
228.               type: 'array',
229.               items: {
230.                 type: 'object',
231.               },
232.             },
233.           },
234.         },
235.         function: {
236.           // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8017
237.           properties: {
238.             handler: { type: 'string' },
239.             fileSystemConfig: {
240.               type: 'object',
241.               properties: {
242.                 localMountPath: { type: 'string', pattern: '^/mnt/[a-zA-Z0-9-_.]+$' },
243.                 arn: {
244.                   type: 'string',
245.                   pattern:
246.                     '^arn:aws[a-zA-Z-]*:elasticfilesystem:[a-z]{2}((-gov)|(-iso(b?)))?-[a-z]+-[1-9]{1}:[0-9]{12}:access-point/fsap-[a-f0-9]{17}$',
247.                 },
248.               },
249.               additionalProperties: false,
250.               required: ['localMountPath', 'arn'],
251.             },
252.           },
253.         },
254.         // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8014
255.         resources: { type: 'object' },
256.       });
257.     }
258.     this.requestCache = {};
259.     this.requestQueue = new PromiseQueue(2, Infinity);
260.     // Store credentials in this variable to avoid creating them several times (messes up MFA).
261.     this.cachedCredentials = null;
262. 
263.     Object.assign(this.naming, naming);
264. 
265.     // Activate AWS SDK logging
266.     if (process.env.SLS_DEBUG) {
267.       AWS.config.logger = this.serverless.cli;
268.     }
269. 
270.     // Use HTTPS Proxy (Optional)
271.     const proxy =
272.       process.env.proxy ||
273.       process.env.HTTP_PROXY ||
274.       process.env.http_proxy ||
275.       process.env.HTTPS_PROXY ||
276.       process.env.https_proxy;
277. 
278.     const proxyOptions = {};
279.     if (proxy) {
280.       Object.assign(proxyOptions, url.parse(proxy));
281.     }
282. 
283.     const ca = process.env.ca || process.env.HTTPS_CA || process.env.https_ca;
284. 
285.     let caCerts = [];
286. 
287.     if (ca) {
288.       // Can be a single certificate or multiple, comma separated.
289.       const caArr = ca.split(',');
290.       // Replace the newline -- https://stackoverflow.com/questions/30400341
291.       caCerts = caCerts.concat(caArr.map(cert => cert.replace(/\\n/g, '\n')));
292.     }
293. 
294.     const cafile = process.env.cafile || process.env.HTTPS_CAFILE || process.env.https_cafile;
295. 
296.     if (cafile) {
297.       // Can be a single certificate file path or multiple paths, comma separated.
298.       const caPathArr = cafile.split(',');
299.       caCerts = caCerts.concat(caPathArr.map(cafilePath => fs.readFileSync(cafilePath.trim())));
300.     }
301. 
302.     if (caCerts.length > 0) {
303.       Object.assign(proxyOptions, {
304.         rejectUnauthorized: true,
305.         ca: caCerts,
306.       });
307.     }
308. 
309.     // Passes also certifications
310.     if (proxy) {
311.       AWS.config.httpOptions.agent = new HttpsProxyAgent(proxyOptions);
312.     } else if (proxyOptions.ca) {
313.       // Update the agent -- http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-registering-certs.html
314.       AWS.config.httpOptions.agent = new https.Agent(proxyOptions);
315.     }
316. 
317.     // Configure the AWS Client timeout (Optional).  The default is 120000 (2 minutes)
318.     const timeout = process.env.AWS_CLIENT_TIMEOUT || process.env.aws_client_timeout;
319.     if (timeout) {
320.       AWS.config.httpOptions.timeout = parseInt(timeout, 10);
321.     }
322. 
323.     // Support deploymentBucket configuration as an object
324.     const provider = this.serverless.service.provider;
325.     if (provider && provider.deploymentBucket) {
326.       if (_.isObject(provider.deploymentBucket)) {
327.         // store the object in a new variable so that it can be reused later on
328.         provider.deploymentBucketObject = provider.deploymentBucket;
329.         if (provider.deploymentBucket.name) {
330.           // (re)set the value of the deploymentBucket property to the name (which is a string)
331.           provider.deploymentBucket = provider.deploymentBucket.name;
332.         } else {
333.           provider.deploymentBucket = null;
334.         }
335.       }
336.     }
337.   }
338. 
339.   /**
340.    * Execute an AWS request by calling the AWS SDK
341.    * @param {string} service - Service name
342.    * @param {string} method - Method name
343.    * @param {Object} params - Parameters
344.    * @param {Object} [options] - Options to modify the request behavior
345.    * @prop [options.useCache] - Utilize cache to retrieve results
346.    * @prop [options.region] - Specify when to request to different region
347.    */
348.   request(service, method, params, options) {
349.     const that = this;
350.     const credentials = Object.assign({}, that.getCredentials());
351.     credentials.region = this.getRegion();
352.     // Make sure options is an object (honors wrong calls of request)
353.     const requestOptions = _.isObject(options) ? options : {};
354.     const shouldCache = _.get(requestOptions, 'useCache', false);
355.     const paramsWithRegion = _.merge({}, params, {
356.       region: _.get(options, 'region'),
357.     });
358.     const paramsHash = objectHash.sha1(paramsWithRegion);
359.     const BASE_BACKOFF = 5000;
360.     const persistentRequest = f =>
361.       new BbPromise((resolve, reject) => {
362.         const doCall = numTry => {
363.           f()
364.             // We're resembling if/else logic, therefore single `then` instead of `then`/`catch` pair
365.             .then(resolve, e => {
366.               const { providerError } = e;
367.               if (
368.                 numTry < MAX_RETRIES &&
369.                 providerError &&
370.                 ((providerError.retryable &&
371.                   providerError.statusCode !== 403 &&
372.                   providerError.code !== 'CredentialsError') ||
373.                   providerError.statusCode === 429)
374.               ) {
375.                 const nextTryNum = numTry + 1;
376.                 const jitter = Math.random() * 3000 - 1000;
377.                 // backoff is between 4 and 7 seconds
378.                 const backOff = BASE_BACKOFF + jitter;
379. 
380.                 that.serverless.cli.log(
381.                   [
382.                     `Recoverable error occurred (${e.message}), sleeping for ~${Math.round(
383.                       backOff / 1000
384.                     )} seconds.`,
385.                     `Try ${nextTryNum} of ${MAX_RETRIES}`,
386.                   ].join(' ')
387.                 );
388.                 setTimeout(doCall, backOff, nextTryNum);
389.               } else {
390.                 reject(e);
391.               }
392.             });
393.         };
394.         return doCall(0);
395.       });
396. 
397.     // Emit a warning for misuses of the old signature including stage and region
398.     // TODO: Determine calling module and log that
399.     if (process.env.SLS_DEBUG && options != null && !_.isObject(options)) {
400.       this.serverless.cli.log('WARNING: Inappropriate call of provider.request()');
401.     }
402. 
403.     // Support S3 Transfer Acceleration
404.     if (this.canUseS3TransferAcceleration(service, method)) {
405.       this.enableS3TransferAcceleration(credentials);
406.     }
407. 
408.     if (shouldCache) {
409.       const cachedRequest = _.get(this.requestCache, `${service}.${method}.${paramsHash}`);
410.       if (cachedRequest) {
411.         return BbPromise.resolve(cachedRequest);
412.       }
413.     }
414. 
415.     const request = this.requestQueue.add(() =>
416.       persistentRequest(() => {
417.         if (options && options.region) {
418.           credentials.region = options.region;
419.         }
420.         const Service = _.get(that.sdk, service);
421.         const awsService = new Service(credentials);
422.         const req = awsService[method](params);
423. 
424.         // TODO: Add listeners, put Debug statements here...
425.         // req.on('send', function (r) {console.log(r)});
426. 
427.         const promise = req.promise
428.           ? req.promise()
429.           : BbPromise.fromCallback(cb => {
430.               req.send(cb);
431.             });
432.         return promise.catch(err => {
433.           let message = err.message != null ? err.message : err.code;
434.           if (message.startsWith('Missing credentials in config')) {
435.             // Credentials error
436.             // If failed at last resort (EC2 Metadata check) expose a meaningful error
437.             // with link to AWS documentation
438.             // Otherwise, it's likely that user relied on some AWS creds, which appeared not correct
439.             // therefore expose an AWS message directly
440.             let bottomError = err;
441.             while (bottomError.originalError && !bottomError.message.startsWith('EC2 Metadata')) {
442.               bottomError = bottomError.originalError;
443.             }
444. 
445.             const errorMessage = bottomError.message.startsWith('EC2 Metadata')
446.               ? [
447.                   'AWS provider credentials not found.',
448.                   ' Learn how to set up AWS provider credentials',
449.                   ` in our docs here: <${chalk.green('http://slss.io/aws-creds-setup')}>.`,
450.                 ].join('')
451.               : bottomError.message;
452.             message = errorMessage;
453.             // We do not want to trigger the retry mechanism for credential errors
454.             return BbPromise.reject(
455.               Object.assign(new this.serverless.classes.Error(errorMessage), {
456.                 providerError: Object.assign({}, err, { retryable: false }),
457.               })
458.             );
459.           }
460. 
461.           return BbPromise.reject(
462.             Object.assign(new this.serverless.classes.Error(message), {
463.               providerError: err,
464.             })
465.           );
466.         });
467.       }).then(data => {
468.         const result = BbPromise.resolve(data);
469.         if (shouldCache) {
470.           _.set(this.requestCache, `${service}.${method}.${paramsHash}`, result);
471.         }
472.         return result;
473.       })
474.     );
475. 
476.     if (shouldCache) {
477.       _.set(this.requestCache, `${service}.${method}.${paramsHash}`, request);
478.     }
479. 
480.     return request;
481.   }
482. 
483.   /**
484.    * Fetch credentials directly or using a profile from serverless yml configuration or from the
485.    * well known environment variables
486.    * @returns {{region: *}}
487.    */
488.   getCredentials() {
489.     if (this.cachedCredentials) {
490.       // We have already created the credentials object once, so return it.
491.       return this.cachedCredentials;
492.     }
493.     const result = {};
494.     const stageUpper = this.getStage() ? this.getStage().toUpperCase() : null;
495. 
496.     // add specified credentials, overriding with more specific declarations
497.     try {
498.       impl.addProfileCredentials(result, 'default');
499.     } catch (err) {
500.       if (err.message !== 'Profile default does not exist') {
501.         throw err;
502.       }
503.     }
504.     impl.addCredentials(result, this.serverless.service.provider.credentials); // config creds
505.     if (this.serverless.service.provider.profile && !this.options['aws-profile']) {
506.       // config profile
507.       impl.addProfileCredentials(result, this.serverless.service.provider.profile);
508.     }
509.     impl.addEnvironmentCredentials(result, 'AWS'); // creds for all stages
510.     impl.addEnvironmentProfile(result, 'AWS');
511.     impl.addEnvironmentCredentials(result, `AWS_${stageUpper}`); // stage specific creds
512.     impl.addEnvironmentProfile(result, `AWS_${stageUpper}`);
513.     if (this.options['aws-profile']) {
514.       impl.addProfileCredentials(result, this.options['aws-profile']); // CLI option profile
515.     }
516. 
517.     const deploymentBucketObject = this.serverless.service.provider.deploymentBucketObject;
518.     if (
519.       deploymentBucketObject &&
520.       deploymentBucketObject.serverSideEncryption &&
521.       deploymentBucketObject.serverSideEncryption === 'aws:kms'
522.     ) {
523.       result.signatureVersion = 'v4';
524.     }
525. 
526.     // Store the credentials to avoid creating them again (messes up MFA).
527.     this.cachedCredentials = result;
528.     return result;
529.   }
530. 
531.   canUseS3TransferAcceleration(service, method) {
532.     // TODO enable more S3 APIs?
533.     return (
534.       service === 'S3' &&
535.       ['upload', 'putObject'].indexOf(method) !== -1 &&
536.       this.isS3TransferAccelerationEnabled()
537.     );
538.   }
539. 
540.   // This function will be used to block the addition of transfer acceleration options
541.   // to the cloudformation template for regions where acceleration is not supported (ie, govcloud)
542.   isS3TransferAccelerationSupported() {
543.     // Only enable s3 transfer acceleration for standard regions (non govcloud/china)
544.     // since those regions do not yet support it
545.     const endpoint = getS3EndpointForRegion(this.getRegion());
546.     return endpoint === 's3.amazonaws.com';
547.   }
548. 
549.   isS3TransferAccelerationEnabled() {
550.     return !!this.options['aws-s3-accelerate'];
551.   }
552. 
553.   isS3TransferAccelerationDisabled() {
554.     return this.options['aws-s3-accelerate'] === false;
555.   }
556. 
557.   disableTransferAccelerationForCurrentDeploy() {
558.     delete this.options['aws-s3-accelerate'];
559.   }
560. 
561.   enableS3TransferAcceleration(credentials) {
562.     this.serverless.cli.log('Using S3 Transfer Acceleration Endpoint...');
563.     credentials.useAccelerateEndpoint = true; // eslint-disable-line no-param-reassign
564.   }
565. 
566.   getValues(source, paths) {
567.     return paths.map(path => ({
568.       path,
569.       value: _.get(source, path.join('.')),
570.     }));
571.   }
572.   firstValue(values) {
573.     return values.reduce((result, current) => {
574.       return result.value ? result : current;
575.     }, {});
576.   }
577. 
578.   getRegionSourceValue() {
579.     const values = this.getValues(this, [
580.       ['options', 'region'],
581.       ['serverless', 'config', 'region'],
582.       ['serverless', 'service', 'provider', 'region'],
583.     ]);
584.     return this.firstValue(values);
585.   }
586.   getRegion() {
587.     const defaultRegion = 'us-east-1';
588.     const regionSourceValue = this.getRegionSourceValue();
589.     return regionSourceValue.value || defaultRegion;
590.   }
591. 
592.   getRuntimeSourceValue() {
593.     const values = this.getValues(this, [['serverless', 'service', 'provider', 'runtime']]);
594.     return this.firstValue(values);
595.   }
596.   getRuntime(runtime) {
597.     const defaultRuntime = 'nodejs12.x';
598.     const runtimeSourceValue = this.getRuntimeSourceValue();
599.     return runtime || runtimeSourceValue.value || defaultRuntime;
600.   }
601. 
602.   getProfileSourceValue() {
603.     const values = this.getValues(this, [
604.       ['options', 'aws-profile'],
605.       ['options', 'profile'],
606.       ['serverless', 'config', 'profile'],
607.       ['serverless', 'service', 'provider', 'profile'],
608.     ]);
609.     const firstVal = this.firstValue(values);
610.     return firstVal ? firstVal.value : null;
611.   }
612.   getProfile() {
613.     return this.getProfileSourceValue();
614.   }
615. 
616.   getServerlessDeploymentBucketName() {
617.     if (this.serverless.service.provider.deploymentBucket) {
618.       return BbPromise.resolve(this.serverless.service.provider.deploymentBucket);
619.     }
620.     return this.request('CloudFormation', 'describeStackResource', {
621.       StackName: this.naming.getStackName(),
622.       LogicalResourceId: this.naming.getDeploymentBucketLogicalId(),
623.     }).then(result => result.StackResourceDetail.PhysicalResourceId);
624.   }
625. 
626.   getDeploymentPrefix() {
627.     const provider = this.serverless.service.provider;
628.     if (provider.deploymentPrefix === null || provider.deploymentPrefix === undefined) {
629.       return 'serverless';
630.     }
631.     return `${provider.deploymentPrefix}`;
632.   }
633. 
634.   resolveFunctionArn(functionAddress) {
635.     if (isLambdaArn(functionAddress)) return functionAddress;
636.     const functionData = this.serverless.service.getFunction(functionAddress);
637.     if (functionData) {
638.       const logicalId = this.naming.getLambdaLogicalId(functionAddress);
639.       const alias = functionData.targetAlias;
640.       const arnGetter = { 'Fn::GetAtt': [logicalId, 'Arn'] };
641.       if (!alias) return arnGetter;
642.       return { 'Fn::Join': [':', [arnGetter, alias.name]] };
643.     }
644.     throw new Error(`Unrecognized function address ${functionAddress}`);
645.   }
646. 
647.   getAlbTargetGroupPrefix() {
648.     const provider = this.serverless.service.provider;
649.     if (!provider.alb || !provider.alb.targetGroupPrefix) {
650.       return '';
651.     }
652. 
653.     if (provider.alb.targetGroupPrefix.length > 16) {
654.       const errorMessage = `Length of alb.targetGroupPrefix should be at most 16 but is ${provider.alb.targetGroupPrefix.length}`;
655.       throw new this.serverless.classes.Error(errorMessage);
656.     }
657. 
658.     return provider.alb.targetGroupPrefix;
659.   }
660. 
661.   getLogRetentionInDays() {
662.     if (!this.serverless.service.provider.logRetentionInDays) {
663.       return null;
664.     }
665.     const rawRetentionInDays = this.serverless.service.provider.logRetentionInDays;
666.     const retentionInDays = parseInt(rawRetentionInDays, 10);
667.     if (retentionInDays > 0) {
668.       return retentionInDays;
669.     }
670. 
671.     const errorMessage = `logRetentionInDays should be an integer over 0 but ${rawRetentionInDays}`;
672.     throw new this.serverless.classes.Error(errorMessage);
673.   }
674. 
675.   getStageSourceValue() {
676.     const values = this.getValues(this, [
677.       ['options', 'stage'],
678.       ['serverless', 'config', 'stage'],
679.       ['serverless', 'service', 'provider', 'stage'],
680.     ]);
681.     return this.firstValue(values);
682.   }
683.   getStage() {
684.     const defaultStage = 'dev';
685.     const stageSourceValue = this.getStageSourceValue();
686.     return stageSourceValue.value || defaultStage;
687.   }
688. 
689.   getAccountId() {
690.     return this.getAccountInfo().then(result => result.accountId);
691.   }
692. 
693.   getAccountInfo() {
694.     return this.request('STS', 'getCallerIdentity', {}).then(result => {
695.       const arn = result.Arn;
696.       const accountId = result.Account;
697.       const partition = arn.split(':')[1]; // ex: arn:aws:iam:acctId:user/xyz
698.       return {
699.         accountId,
700.         partition,
701.         arn: result.Arn,
702.         userId: result.UserId,
703.       };
704.     });
705.   }
706. 
707.   /**
708.    * Get API Gateway Rest API ID from serverless config
709.    */
710.   getApiGatewayRestApiId() {
711.     if (
712.       this.serverless.service.provider.apiGateway &&
713.       this.serverless.service.provider.apiGateway.restApiId
714.     ) {
715.       return this.serverless.service.provider.apiGateway.restApiId;
716.     }
717. 
718.     return { Ref: this.naming.getRestApiLogicalId() };
719.   }
720. 
721.   getApiGatewayDescription() {
722.     if (
723.       this.serverless.service.provider.apiGateway &&
724.       this.serverless.service.provider.apiGateway.description
725.     ) {
726.       return this.serverless.service.provider.apiGateway.description;
727.     }
728.     return undefined;
729.   }
730. 
731.   /**
732.    * Get Rest API Root Resource ID from serverless config
733.    */
734.   getApiGatewayRestApiRootResourceId() {
735.     if (
736.       this.serverless.service.provider.apiGateway &&
737.       this.serverless.service.provider.apiGateway.restApiRootResourceId
738.     ) {
739.       return this.serverless.service.provider.apiGateway.restApiRootResourceId;
740.     }
741.     return { 'Fn::GetAtt': [this.naming.getRestApiLogicalId(), 'RootResourceId'] };
742.   }
743. 
744.   /**
745.    * Get Rest API Predefined Resources from serverless config
746.    */
747.   getApiGatewayPredefinedResources() {
748.     if (
749.       !this.serverless.service.provider.apiGateway ||
750.       !this.serverless.service.provider.apiGateway.restApiResources
751.     ) {
752.       return [];
753.     }
754. 
755.     if (Array.isArray(this.serverless.service.provider.apiGateway.restApiResources)) {
756.       return this.serverless.service.provider.apiGateway.restApiResources;
757.     }
758. 
759.     if (typeof this.serverless.service.provider.apiGateway.restApiResources !== 'object') {
760.       throw new Error('REST API resource must be an array of object');
761.     }
762. 
763.     return Object.keys(this.serverless.service.provider.apiGateway.restApiResources).map(key => ({
764.       path: key,
765.       resourceId: this.serverless.service.provider.apiGateway.restApiResources[key],
766.     }));
767.   }
768. 
769.   /**
770.    * Get API Gateway websocket API ID from serverless config
771.    */
772.   getApiGatewayWebsocketApiId() {
773.     if (
774.       this.serverless.service.provider.apiGateway &&
775.       this.serverless.service.provider.apiGateway.websocketApiId
776.     ) {
777.       return this.serverless.service.provider.apiGateway.websocketApiId;
778.     }
779. 
780.     return { Ref: this.naming.getWebsocketsApiLogicalId() };
781.   }
782. 
783.   getStackResources(next, resourcesParam) {
784.     let resources = resourcesParam;
785.     const params = {
786.       StackName: this.naming.getStackName(),
787.     };
788.     if (!resources) resources = [];
789.     if (next) params.NextToken = next;
790. 
791.     return this.request('CloudFormation', 'listStackResources', params).then(res => {
792.       const allResources = resources.concat(res.StackResourceSummaries);
793.       if (!res.NextToken) {
794.         return allResources;
795.       }
796.       return this.getStackResources(res.NextToken, allResources);
797.     });
798.   }
799. }
800. 
801. module.exports = AwsProvider;

--- END CONTEXT ---

REMEMBER: Your task is to summarize the relevant contexts to the given query and return it in the specified format!

2025-11-13 20:12:53,742 - thread-135845287823040.prometheus.lang_graph.nodes.context_extraction_node - DEBUG - Model response: context=[ContextOutput(reasoning='Shows that the core config schema does not directly define function event details and that function properties (including events like aws http) are extended by provider plugins. This establishes why http event request.* schema is not present here.', relative_path='lib/configSchema.js', start_line=36, end_line=73), ContextOutput(reasoning="Defines the Serverless config schema for the AWS 'http' function event at a high level (string or object). Indicates there is no detailed JSON schema for request.* keys here, aligning with validation being handled in plugin code.", relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.js', start_line=29, end_line=33), ContextOutput(reasoning='Integration assembly shows where request options are wired: maps request.passThrough to PassthroughBehavior, request.contentHandling to ContentHandling, and uses RequestTemplates computed from request.template. This directly implements the request settings behavior.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=100, end_line=107), ContextOutput(reasoning='Defines how integration request templates are constructed: sets defaults for AWS (lambda) integration and merges in user-provided http.request.template object. This shows the schema path (http.event.request.template) and that allowed keys are content types with template strings.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', start_line=198, end_line=217), ContextOutput(reasoning='Validates that http.request is an object and that http.request.template must be an object. This enforces the expected shape of the schema segment for request.template.', relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', start_line=491, end_line=508), ContextOutput(reasoning="Implements request parameters mapping by converting request.parameters.{querystrings,headers,paths} into method.request.* keys. This corresponds to the 'Request Parameters' docs section.", relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', start_line=520, end_line=532), ContextOutput(reasoning="Validates allowed values for request.passThrough (NEVER, WHEN_NO_MATCH, WHEN_NO_TEMPLATES) and sets defaults based on integration type. This aligns with 'Passthrough Behavior' documentation and shows accepted enum and defaults.", relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', start_line=534, end_line=561), ContextOutput(reasoning='Documentation section describing Request Parameters, including how to configure required/optional parameters, path variables, and mappedValue. Essential to understand request.parameters.', relative_path='docs/providers/aws/events/apigateway.md', start_line=706, end_line=833), ContextOutput(reasoning="Documentation for Request Templates (Default and Custom) under Lambda integration, including examples of defining request.template with content types. This directly documents the 'template' request option.", relative_path='docs/providers/aws/events/apigateway.md', start_line=815, end_line=975), ContextOutput(reasoning='Documentation for Pass Through Behavior with explanation and example of setting request.passThrough and the available options.', relative_path='docs/providers/aws/events/apigateway.md', start_line=973, end_line=1081), ContextOutput(reasoning="Documentation that explains contentHandling on request and response with example. This directly documents the 'contentHandling' request option.", relative_path='docs/providers/aws/events/apigateway.md', start_line=1484, end_line=1638)]
2025-11-13 20:12:53,750 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Storing 11 contexts to memory for query: Please provide the relevant sections of lib/configSchema.js that define the schema for AWS http API Gateway event request settings, and the portions of docs/providers/aws/events/apigateway.md that document the request options (passThrough, contentHandling, template).
2025-11-13 20:12:54,917 - thread-135845287823040.prometheus.lang_graph.nodes.memory_storage_node - INFO - Successfully stored contexts to memory
2025-11-13 20:12:54,918 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - Adding 11 new contexts to 10 existing contexts
2025-11-13 20:12:54,919 - thread-135845287823040.prometheus.lang_graph.nodes.add_result_context_node - INFO - After deduplication: 18 total contexts (removed 3 duplicates)
2025-11-13 20:12:54,921 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - This is the codebase structure:
--- BEGIN FILE TREE ---
serverless
├── .github
|   ├── ISSUE_TEMPLATE
|   |   ├── bug_report.md
|   |   ├── config.yml
|   |   └── feature_request.md
|   ├── PULL_REQUEST_TEMPLATE.md
|   ├── prepare-canary.js
|   └── workflows
|       ├── integrate.yml
|       ├── publish.yml
|       └── validate.yml
├── CHANGELOG.md
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE.txt
├── README.md
├── README_CN.md
├── RELEASE_PROCESS.md
├── VERSIONING.md
├── bin
|   └── serverless.js
├── commitlint.config.js
├── docker-compose.yml
├── docs
|   ├── README.md
|   ├── anatomy.md
|   ├── cn
|   |   ├── README.md
|   |   ├── getting-started.md
|   |   └── providers
|   |       ├── README.md
|   |       └── tencent
|   |           ├── README.md
|   |           └── components
|   ├── dashboard
|   |   ├── README.md
|   |   ├── access-roles.md
|   |   ├── cicd
|   |   |   ├── README.md
|   |   |   ├── best-practices.md
|   |   |   ├── branch-deployments.md
|   |   |   ├── custom-scripts.md
|   |   |   ├── faq.md
|   |   |   ├── mono-repo.md
|   |   |   ├── notifications.md
|   |   |   ├── preview-deployments.md
|   |   |   ├── private-packages.md
|   |   |   ├── running-in-your-own-cicd.md
|   |   |   ├── running-tests.md
|   |   |   └── troubleshooting.md
|   |   ├── monitoring
|   |   |   ├── README.md
|   |   |   ├── alerts.md
|   |   |   ├── metrics.md
|   |   |   └── notifications.md
|   |   ├── output-variables.md
|   |   ├── parameters.md
|   |   ├── profiles.md
|   |   ├── safeguards.md
|   |   ├── sdk
|   |   |   ├── README.md
|   |   |   ├── nodejs.md
|   |   |   └── python.md
|   |   └── testing.md
|   ├── deprecations.md
|   ├── getting-started.md
|   └── providers
|       ├── README.md
|       ├── aliyun
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── oss.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── aws
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── metrics.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   ├── rollback-function.md
|       |   |   ├── rollback.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── alb.md
|       |   |   ├── alexa-skill.md
|       |   |   ├── alexa-smart-home.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudfront.md
|       |   |   ├── cloudwatch-event.md
|       |   |   ├── cloudwatch-log.md
|       |   |   ├── cognito-user-pool.md
|       |   |   ├── event-bridge.md
|       |   |   ├── http-api.md
|       |   |   ├── iot.md
|       |   |   ├── s3.md
|       |   |   ├── schedule.md
|       |   |   ├── sns.md
|       |   |   ├── sqs.md
|       |   |   ├── streams.md
|       |   |   └── websocket.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── iam.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── layers.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── resources.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── azure
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy-list.md
|       |   |   ├── deploy.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── rollback.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── blobstorage.md
|       |   |   ├── cosmosdb.md
|       |   |   ├── eventhubs.md
|       |   |   ├── http.md
|       |   |   ├── other.md
|       |   |   ├── queuestorage.md
|       |   |   ├── servicebus.md
|       |   |   └── timer.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── function-apps.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── cloudflare
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── invoke.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── fn
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   └── http.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       └── workflow.md
|       ├── google
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── package.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── event.md
|       |   |   └── http.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── knative
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── aws-sqs.md
|       |   |   ├── cron.md
|       |   |   ├── custom.md
|       |   |   ├── gcp-pub-sub.md
|       |   |   └── kafka.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       ├── variables.md
|       |       └── workflow.md
|       ├── kubeless
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── create.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   └── remove.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   ├── pubsub.md
|       |   |   └── scheduler.md
|       |   └── guide
|       |       ├── README.md
|       |       ├── debugging.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── quick-start.md
|       |       ├── services.md
|       |       └── workflow.md
|       ├── openwhisk
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── install.md
|       |   |   ├── invoke-local.md
|       |   |   ├── invoke.md
|       |   |   ├── login.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── print.md
|       |   |   ├── remove.md
|       |   |   └── slstats.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── apigateway.md
|       |   |   ├── cloudant.md
|       |   |   ├── messagehub.md
|       |   |   ├── schedule.md
|       |   |   └── triggers.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   └── hello-world
|       |   └── guide
|       |       ├── README.md
|       |       ├── credentials.md
|       |       ├── deploying.md
|       |       ├── events.md
|       |       ├── functions.md
|       |       ├── installation.md
|       |       ├── intro.md
|       |       ├── packaging.md
|       |       ├── plugins.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       ├── services.md
|       |       ├── testing.md
|       |       ├── variables.md
|       |       ├── web-actions.md
|       |       └── workflow.md
|       ├── spotinst
|       |   ├── README.md
|       |   ├── cli-reference
|       |   |   ├── README.md
|       |   |   ├── config-credentials.md
|       |   |   ├── create.md
|       |   |   ├── deploy-function.md
|       |   |   ├── deploy.md
|       |   |   ├── info.md
|       |   |   ├── invoke.md
|       |   |   ├── logs.md
|       |   |   ├── plugin-install.md
|       |   |   ├── plugin-list.md
|       |   |   ├── plugin-search.md
|       |   |   ├── plugin-uninstall.md
|       |   |   ├── remove.md
|       |   |   └── stage.md
|       |   ├── events
|       |   |   ├── README.md
|       |   |   ├── http.md
|       |   |   └── schedule.md
|       |   ├── examples
|       |   |   ├── README.md
|       |   |   ├── java8
|       |   |   ├── node
|       |   |   ├── python
|       |   |   └── ruby
|       |   └── guide
|       |       ├── IAM-roles.md
|       |       ├── README.md
|       |       ├── active-versions.md
|       |       ├── cors.md
|       |       ├── create-token.md
|       |       ├── credentials.md
|       |       ├── endpoints.md
|       |       ├── intro.md
|       |       ├── quick-start.md
|       |       ├── serverless.yml.md
|       |       └── variables.md
|       └── tencent
|           ├── README.md
|           ├── cli-reference
|           |   ├── README.md
|           |   ├── create.md
|           |   ├── deploy-function.md
|           |   ├── deploy-list.md
|           |   ├── deploy.md
|           |   ├── info.md
|           |   ├── install.md
|           |   ├── invoke.md
|           |   ├── logs.md
|           |   ├── metrics.md
|           |   ├── remove.md
|           |   └── rollback.md
|           ├── events
|           |   ├── CMQ.md
|           |   ├── COS.md
|           |   ├── README.md
|           |   ├── apigateway.md
|           |   ├── cloud-kafka.md
|           |   └── timer.md
|           └── guide
|               ├── README.md
|               ├── credentials.md
|               ├── deploying.md
|               ├── events.md
|               ├── functions.md
|               ├── installation.md
|               ├── intro.md
|               ├── packaging.md
|               ├── plugins.md
|               ├── quick-start.md
|               ├── services.md
|               ├── variables.md
|               └── workflow.md
├── lib
|   ├── Serverless.js
|   ├── Serverless.test.js
|   ├── classes
|   |   ├── CLI.js
|   |   ├── CLI.test.js
|   |   ├── Config.js
|   |   ├── Config.test.js
|   |   ├── ConfigSchemaHandler
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── normalizeAjvErrors.js
|   |   |   ├── normalizeAjvErrors.test.js
|   |   |   ├── resolveDataPathSize.js
|   |   |   └── resolveDataPathSize.test.js
|   |   ├── Error.js
|   |   ├── Error.test.js
|   |   ├── PluginManager.js
|   |   ├── PluginManager.test.js
|   |   ├── PromiseTracker.js
|   |   ├── PromiseTracker.test.js
|   |   ├── Service.js
|   |   ├── Service.test.js
|   |   ├── Utils.js
|   |   ├── Utils.test.js
|   |   ├── Variables.js
|   |   ├── Variables.test.js
|   |   ├── YamlParser.js
|   |   └── YamlParser.test.js
|   ├── configSchema.js
|   ├── configSchema.test.js
|   ├── plugins
|   |   ├── aws
|   |   |   ├── common
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── configCredentials
|   |   |   |   ├── awsConfigCredentials.js
|   |   |   |   └── awsConfigCredentials.test.js
|   |   |   ├── customResources
|   |   |   |   ├── .eslintrc.js
|   |   |   |   ├── generateZip.js
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   ├── resources
|   |   |   |   └── test
|   |   |   ├── deploy
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── deployFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── deployList
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── info
|   |   |   |   ├── display.js
|   |   |   |   ├── display.test.js
|   |   |   |   ├── getApiKeyValues.js
|   |   |   |   ├── getApiKeyValues.test.js
|   |   |   |   ├── getResourceCount.js
|   |   |   |   ├── getResourceCount.test.js
|   |   |   |   ├── getStackInfo.js
|   |   |   |   ├── getStackInfo.test.js
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invoke
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── invokeLocal
|   |   |   |   ├── fixture
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── runtimeWrappers
|   |   |   ├── lib
|   |   |   |   ├── cloudformationSchema.js
|   |   |   |   ├── cloudformationSchema.test.js
|   |   |   |   ├── getServiceState.js
|   |   |   |   ├── getServiceState.test.js
|   |   |   |   ├── monitorStack.js
|   |   |   |   ├── monitorStack.test.js
|   |   |   |   ├── naming.js
|   |   |   |   ├── naming.test.js
|   |   |   |   ├── normalizeFiles.js
|   |   |   |   ├── normalizeFiles.test.js
|   |   |   |   ├── setBucketName.js
|   |   |   |   ├── setBucketName.test.js
|   |   |   |   ├── updateStack.js
|   |   |   |   ├── updateStack.test.js
|   |   |   |   ├── validate.js
|   |   |   |   ├── validate.test.js
|   |   |   |   ├── validateS3BucketName.js
|   |   |   |   └── validateS3BucketName.test.js
|   |   |   ├── logs
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── metrics
|   |   |   |   ├── awsMetrics.js
|   |   |   |   └── awsMetrics.test.js
|   |   |   ├── package
|   |   |   |   ├── compile
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── provider
|   |   |   |   ├── awsProvider.js
|   |   |   |   └── awsProvider.test.js
|   |   |   ├── remove
|   |   |   |   ├── index.js
|   |   |   |   ├── index.test.js
|   |   |   |   └── lib
|   |   |   ├── rollback
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   ├── rollbackFunction
|   |   |   |   ├── index.js
|   |   |   |   └── index.test.js
|   |   |   └── utils
|   |   |       ├── arnRegularExpressions.js
|   |   |       ├── credentials.js
|   |   |       ├── credentials.test.js
|   |   |       ├── findAndGroupDeployments.js
|   |   |       ├── findAndGroupDeployments.test.js
|   |   |       ├── findReferences.js
|   |   |       ├── findReferences.test.js
|   |   |       ├── formatLambdaLogEvent.js
|   |   |       ├── formatLambdaLogEvent.test.js
|   |   |       ├── getLambdaLayerArtifactPath.js
|   |   |       ├── getS3EndpointForRegion.js
|   |   |       ├── getS3EndpointForRegion.test.js
|   |   |       ├── getS3ObjectsFromStacks.js
|   |   |       ├── getS3ObjectsFromStacks.test.js
|   |   |       ├── resolveCfImportValue.js
|   |   |       ├── resolveCfImportValue.test.js
|   |   |       ├── resolveLambdaTarget.js
|   |   |       └── resolveLambdaTarget.test.js
|   |   ├── config
|   |   |   ├── config.js
|   |   |   └── config.test.js
|   |   ├── create
|   |   |   ├── create.js
|   |   |   ├── create.test.js
|   |   |   └── templates
|   |   |       ├── aliyun-nodejs
|   |   |       ├── aws-alexa-typescript
|   |   |       ├── aws-clojure-gradle
|   |   |       ├── aws-clojurescript-gradle
|   |   |       ├── aws-csharp
|   |   |       ├── aws-fsharp
|   |   |       ├── aws-go
|   |   |       ├── aws-go-dep
|   |   |       ├── aws-go-mod
|   |   |       ├── aws-groovy-gradle
|   |   |       ├── aws-java-gradle
|   |   |       ├── aws-java-maven
|   |   |       ├── aws-kotlin-jvm-gradle
|   |   |       ├── aws-kotlin-jvm-gradle-kts
|   |   |       ├── aws-kotlin-jvm-maven
|   |   |       ├── aws-kotlin-nodejs-gradle
|   |   |       ├── aws-nodejs
|   |   |       ├── aws-nodejs-ecma-script
|   |   |       ├── aws-nodejs-typescript
|   |   |       ├── aws-provided
|   |   |       ├── aws-python
|   |   |       ├── aws-python3
|   |   |       ├── aws-ruby
|   |   |       ├── aws-scala-sbt
|   |   |       ├── azure-csharp
|   |   |       ├── azure-nodejs
|   |   |       ├── azure-nodejs-typescript
|   |   |       ├── azure-python
|   |   |       ├── cloudflare-workers
|   |   |       ├── cloudflare-workers-enterprise
|   |   |       ├── cloudflare-workers-rust
|   |   |       ├── fn-go
|   |   |       ├── fn-nodejs
|   |   |       ├── google-go
|   |   |       ├── google-nodejs
|   |   |       ├── google-python
|   |   |       ├── hello-world
|   |   |       ├── knative-docker
|   |   |       ├── kubeless-nodejs
|   |   |       ├── kubeless-python
|   |   |       ├── openwhisk-java-maven
|   |   |       ├── openwhisk-nodejs
|   |   |       ├── openwhisk-php
|   |   |       ├── openwhisk-python
|   |   |       ├── openwhisk-ruby
|   |   |       ├── openwhisk-swift
|   |   |       ├── plugin
|   |   |       ├── spotinst-java8
|   |   |       ├── spotinst-nodejs
|   |   |       ├── spotinst-python
|   |   |       ├── spotinst-ruby
|   |   |       ├── tencent-go
|   |   |       ├── tencent-nodejs
|   |   |       ├── tencent-php
|   |   |       ├── tencent-python
|   |   |       └── twilio-nodejs
|   |   ├── deploy
|   |   |   ├── deploy.js
|   |   |   └── deploy.test.js
|   |   ├── index.js
|   |   ├── info
|   |   |   ├── info.js
|   |   |   └── info.test.js
|   |   ├── install
|   |   |   ├── install.js
|   |   |   └── install.test.js
|   |   ├── interactiveCli
|   |   |   ├── index.js
|   |   |   ├── index.test.js
|   |   |   ├── initializeService.js
|   |   |   ├── initializeService.test.js
|   |   |   ├── setupAws.js
|   |   |   ├── setupAws.test.js
|   |   |   ├── tabCompletion.js
|   |   |   ├── tabCompletion.test.js
|   |   |   ├── test
|   |   |   |   └── fixtures
|   |   |   └── utils.js
|   |   ├── invoke
|   |   |   ├── invoke.js
|   |   |   └── invoke.test.js
|   |   ├── logs
|   |   |   └── logs.js
|   |   ├── metrics
|   |   |   ├── metrics.js
|   |   |   └── metrics.test.js
|   |   ├── package
|   |   |   ├── lib
|   |   |   |   ├── packageService.js
|   |   |   |   ├── packageService.test.js
|   |   |   |   ├── zipService.js
|   |   |   |   └── zipService.test.js
|   |   |   ├── package.js
|   |   |   └── package.test.js
|   |   ├── plugin
|   |   |   ├── install
|   |   |   |   ├── install.js
|   |   |   |   └── install.test.js
|   |   |   ├── lib
|   |   |   |   ├── utils.js
|   |   |   |   └── utils.test.js
|   |   |   ├── list
|   |   |   |   ├── list.js
|   |   |   |   └── list.test.js
|   |   |   ├── plugin.js
|   |   |   ├── plugin.test.js
|   |   |   ├── search
|   |   |   |   ├── search.js
|   |   |   |   └── search.test.js
|   |   |   └── uninstall
|   |   |       ├── uninstall.js
|   |   |       └── uninstall.test.js
|   |   ├── print
|   |   |   ├── print.js
|   |   |   └── print.test.js
|   |   ├── remove
|   |   |   ├── remove.js
|   |   |   └── remove.test.js
|   |   ├── rollback
|   |   |   ├── index.js
|   |   |   └── index.test.js
|   |   ├── slstats
|   |   |   ├── slstats.js
|   |   |   └── slstats.test.js
|   |   └── standalone
|   |       └── index.js
|   └── utils
|       ├── analytics
|       |   ├── areDisabled.js
|       |   ├── cache-path.js
|       |   ├── generatePayload.js
|       |   ├── generatePayload.test.js
|       |   ├── index.js
|       |   └── index.test.js
|       ├── autocomplete.js
|       ├── awsSdkPatch.js
|       ├── createFromTemplate.js
|       ├── createFromTemplate.test.js
|       ├── downloadTemplateFromRepo.js
|       ├── downloadTemplateFromRepo.test.js
|       ├── fs
|       |   ├── copyDirContentsSync.js
|       |   ├── copyDirContentsSync.test.js
|       |   ├── createZipFile.js
|       |   ├── createZipFile.test.js
|       |   ├── dirExists.js
|       |   ├── dirExistsSync.js
|       |   ├── fileExists.js
|       |   ├── fileExists.test.js
|       |   ├── fileExistsSync.js
|       |   ├── fileExistsSync.test.js
|       |   ├── getTmpDirPath.js
|       |   ├── getTmpDirPath.test.js
|       |   ├── parse.js
|       |   ├── parse.test.js
|       |   ├── readFile.js
|       |   ├── readFile.test.js
|       |   ├── readFileIfExists.js
|       |   ├── readFileIfExists.test.js
|       |   ├── readFileSync.js
|       |   ├── readFileSync.test.js
|       |   ├── removeFile.js
|       |   ├── removeFileSync.js
|       |   ├── walkDirSync.js
|       |   ├── walkDirSync.test.js
|       |   ├── writeFile.js
|       |   ├── writeFile.test.js
|       |   ├── writeFileSync.js
|       |   └── writeFileSync.test.js
|       ├── getCacheFile.js
|       ├── getCacheFilePath.js
|       ├── getCommandSuggestion.js
|       ├── getCommandSuggestion.test.js
|       ├── getEnsureArtifact.js
|       ├── getEnsureArtifact.test.js
|       ├── getFrameworkId.js
|       ├── getServerlessConfigFile.js
|       ├── getServerlessConfigFile.test.js
|       ├── getServerlessDir.js
|       ├── getTrackingConfigFileName.js
|       ├── isStandaloneExecutable.js
|       ├── log
|       |   ├── consoleLog.js
|       |   ├── fileLog.js
|       |   ├── log.js
|       |   ├── muteConsoleLog.js
|       |   └── serverlessLog.js
|       ├── logDeprecation.js
|       ├── logDeprecation.test.js
|       ├── npm-command-deferred.js
|       ├── open.js
|       ├── openBrowser.js
|       ├── processBackendNotificationRequest.js
|       ├── renameService.js
|       ├── renameService.test.js
|       ├── resolveCliInput.js
|       ├── resolveCliInput.test.js
|       ├── standalone-patch.js
|       ├── tabCompletion
|       |   ├── isSupported.js
|       |   ├── isSupported.test.js
|       |   ├── promptDisabledConfigPropertyName.js
|       |   └── tabtabOptions.js
|       ├── yamlAstParser.js
|       └── yamlAstParser.test.js
├── prettier.config.js
├── scripts
|   ├── pkg
|   |   ├── build.js
|   |   ├── choco-package-template
|   |   |   └── tools
|   |   |       ├── LICENSE.txt
|   |   |       └── VERIFICATION.txt
|   |   ├── config.js
|   |   ├── generate-choco-package.js
|   |   ├── install.sh
|   |   └── upload
|   |       ├── china.js
|   |       ├── index.js
|   |       └── world.js
|   ├── postinstall.js
|   └── serverless.js
└── test
    ├── .eslintrc.js
    ├── README.md
    ├── fixtures
    |   ├── apiGateway
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── aws
    |   |   └── serverless.yml
    |   ├── configInvalid
    |   |   └── serverless.yml
    |   ├── configSchemaExtensions
    |   |   ├── serverless.yml
    |   |   └── test-plugin.js
    |   ├── configSyntaxError
    |   |   └── serverless.yml
    |   ├── configTypeJs
    |   |   └── serverless.js
    |   ├── configTypeJsDeferred
    |   |   └── serverless.js
    |   ├── configTypeJson
    |   ├── configTypeNonObject
    |   ├── configTypeYaml
    |   |   └── serverless.yaml
    |   ├── configTypeYml
    |   |   └── serverless.yml
    |   ├── configTypeYmlAndJson
    |   |   └── serverless.yml
    |   ├── customProvider
    |   |   ├── customProvider.js
    |   |   └── serverless.yml
    |   ├── function
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionCloudFront
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── functionDestinations
    |   |   ├── serverless.yml
    |   |   ├── target.js
    |   |   └── trigger.js
    |   ├── httpApi
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiCatchAll
    |   |   ├── index.js
    |   |   └── serverless.yml
    |   ├── httpApiExport
    |   |   └── serverless.yml
    |   ├── index.js
    |   ├── packageArtifact
    |   |   └── serverless.yml
    |   └── serverlessTs
    |       └── serverless.ts
    ├── integration-all
    |   ├── api-gateway
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   ├── helper.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── cognito-user-pool
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── event-bridge
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── file-system-config
    |   |   ├── cloudformation.yml
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── function-destinations
    |   |   └── tests.js
    |   ├── http-api
    |   |   └── tests.js
    |   ├── iot
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── s3
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── schedule
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── shared
    |   |   └── utils.js
    |   ├── sns
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── sqs
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   ├── stream
    |   |   ├── service
    |   |   |   ├── core.js
    |   |   |   └── serverless.yml
    |   |   └── tests.js
    |   └── websocket
    |       ├── service
    |       |   ├── core.js
    |       |   └── serverless.yml
    |       └── tests.js
    ├── integration-basic
    |   └── tests.js
    ├── integration-package
    |   ├── cloudformation.tests.js
    |   ├── fixtures
    |   |   ├── artifact
    |   |   |   ├── handler.js
    |   |   |   └── serverless.yml
    |   |   ├── individually
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   ├── individually-function
    |   |   |   ├── handler.js
    |   |   |   ├── handler2.js
    |   |   |   └── serverless.yml
    |   |   └── regular
    |   |       ├── handler.js
    |   |       └── serverless.yml
    |   └── lambda-files.tests.js
    ├── mocha-reporter.js
    ├── serverless-binary.js
    ├── templates
    └── utils
        ├── api-gateway
        |   └── index.js
        ├── aws-cleanup.js
        ├── child-process.js
        ├── cloudformation
        |   └── index.js
        ├── cloudwatch
        |   └── index.js
        ├── cognito
        |   └── index.js
        ├── dynamodb
        |   └── index.js
        ├── eventBridge
        |   └── index.js
        ├── fs
        |   └── index.js
        ├── integration.js
        ├── iot
        |   └── index.js
        ├── kinesis
        |   └── index.js
        ├── misc
        |   └── index.js
        ├── plugins
        |   └── index.js
        ├── run-serverless.js
        ├── s3
        |   └── index.js
        ├── sns
        |   └── index.js
        ├── sqs
        |   └── index.js
        └── websocket
            └── index.js
--- END FILE TREE ---
    
This is the original user query:
--- BEGIN ORIGINAL QUERY ---
Issue title:
Allow for the removal of default request mapping templates

Issue description: 
Currently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:

"consumes": [
          "application/json",
          "application/x-www-form-urlencoded"
        ],

IMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great


Issue comments:


Find all relevant source code context and documentation needed to understand and implement this feature request.
Focus on production code (ignore test files) and follow these steps:
1. Identify similar existing features or components that this new feature should integrate with
2. Find relevant class definitions, interfaces, and API patterns used in the codebase
3. Locate related modules and services that the new feature will interact with
4. Include architectural patterns and code conventions used in similar implementations

Skip any test files

--- END ORIGINAL QUERY ---

These are the previously asked refined queries:
--- BEGIN PREVIOUS QUERY ---
Previous refined query 1:
Essential Query: Please provide the contents of lib/plugins/aws/package/compile/events/apiGateway/index.js and lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, plus any modules they import that handle request templates.
Extra Requirements: If sending all files is too large, include at minimum the sections that define default request mapping templates, how http event request templates are read from config, and the docs/providers/aws/events/apigateway.md file.
Purpose: These files will show where the default templates are created and how to integrate an option to disable or override them following existing architecture and conventions.

Previous refined query 2:
Essential Query: Please provide the relevant sections of lib/configSchema.js that define the schema for AWS http API Gateway event request settings, and the portions of docs/providers/aws/events/apigateway.md that document the request options (passThrough, contentHandling, template).
Extra Requirements: If sharing full files is too large, include at minimum the schema segment path for http event request.template and its allowed keys, and the doc subsections for Request Parameters, Content Handling, Passthrough Behavior, and Request Templates.
Purpose: These will ensure any new option to disable default request templates aligns with the validated config schema and documented patterns.
--- END PREVIOUS QUERY ---

All aggregated context for the queries:
--- BEGIN AGGREGATED CONTEXT ---
File: docs/providers/aws/events/apigateway.md
Line number range: 706 - 833
Content:
706. service: my-service
707. provider:
708.   name: aws
709.   endpointType: REGIONAL
710. functions:
711.   hello:
712.     events:
713.       - http:
714.           path: user/create
715.           method: get
716. ```
717. 
718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:
719. 
720. ```
721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com
722. ```
723. 
724. Here's an example configuration:
725. 
726. ```yml
727. service: my-service
728. provider:
729.   name: aws
730.   endpointType: PRIVATE
731.   vpcEndpointIds:
732.     - vpce-123
733.     - vpce-456
734. ```
735. 
736. ### Request Parameters
737. 
738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.
739. 
740. ```yml
741. functions:
742.   create:
743.     handler: posts.create
744.     events:
745.       - http:
746.           path: posts/create
747.           method: post
748.           request:
749.             parameters:
750.               querystrings:
751.                 url: true
752.               headers:
753.                 foo: false
754.               paths:
755.                 bar: false
756. ```
757. 
758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:
759. 
760. ```yml
761. functions:
762.   create:
763.     handler: posts.post_detail
764.     events:
765.       - http:
766.           path: posts/{id}
767.           method: get
768.           request:
769.             parameters:
770.               paths:
771.                 id: true
772. ```
773. 
774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.
775. 
776. ```yml
777. functions:
778.   create:
779.     handler: posts.post_detail
780.     events:
781.       - http:
782.           path: posts/{id}
783.           method: get
784.           request:
785.             parameters:
786.               paths:
787.                 id: true
788.               headers:
789.                 custom-header:
790.                   required: true
791.                   mappedValue: context.requestId
792. ```
793. 
794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)
795. 
796. ### Request Schema Validators
797. 
798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)
799. for your content type. Since JSON Schema is represented in JSON, it's easier to include it from a
800. file.
801. 
802. ```yml
803. functions:
804.   create:
805.     handler: posts.create
806.     events:
807.       - http:
808.           path: posts/create
809.           method: post
810.           request:
811.             schema:
812.               application/json: ${file(create_request.json)}
813. ```
814. 
815. A sample schema contained in `create_request.json` might look something like this:
816. 
817. ```json
818. {
819.   "definitions": {},
820.   "$schema": "http://json-schema.org/draft-04/schema#",
821.   "type": "object",
822.   "title": "The Root Schema",
823.   "required": ["username"],
824.   "properties": {
825.     "username": {
826.       "type": "string",
827.       "title": "The Foo Schema",
828.       "default": "",
829.       "pattern": "^[a-zA-Z0-9]+$"
830.     }
831.   }
832. }
833. ```


File: docs/providers/aws/events/apigateway.md
Line number range: 815 - 975
Content:
815. A sample schema contained in `create_request.json` might look something like this:
816. 
817. ```json
818. {
819.   "definitions": {},
820.   "$schema": "http://json-schema.org/draft-04/schema#",
821.   "type": "object",
822.   "title": "The Root Schema",
823.   "required": ["username"],
824.   "properties": {
825.     "username": {
826.       "type": "string",
827.       "title": "The Foo Schema",
828.       "default": "",
829.       "pattern": "^[a-zA-Z0-9]+$"
830.     }
831.   }
832. }
833. ```
834. 
835. **NOTE:** schema validators are only applied to content types you specify. Other content types are
836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.
837. 
838. ### Setting source of API key for metering requests
839. 
840. API Gateway provide a feature for metering your API's requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request's X-API-Key header, set option like this:
841. 
842. ```yml
843. service: my-service
844. provider:
845.   name: aws
846.   apiGateway:
847.     apiKeySourceType: HEADER
848. functions:
849.   hello:
850.     events:
851.       - http:
852.           path: hello
853.           method: get
854. ```
855. 
856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.
857. 
858. ```yml
859. service: my-service
860. provider:
861.   name: aws
862.   apiGateway:
863.     apiKeySourceType: AUTHORIZER
864. functions:
865.   hello:
866.     events:
867.       - http:
868.           path: hello
869.           method: get
870. ```
871. 
872. ## Lambda Integration
873. 
874. This method is more complicated and involves a lot more configuration of the `http` event syntax.
875. 
876. ### Example "LAMBDA" event (before customization)
877. 
878. **Refer to this only if you're using the non-default `LAMBDA` integration method**
879. 
880. ```json
881. {
882.   "body": {},
883.   "method": "GET",
884.   "principalId": "",
885.   "stage": "dev",
886.   "cognitoPoolClaims": {
887.     "sub": ""
888.   },
889.   "enhancedAuthContext": {},
890.   "headers": {
891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
892.     "Accept-Encoding": "gzip, deflate, br",
893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",
894.     "CloudFront-Forwarded-Proto": "https",
895.     "CloudFront-Is-Desktop-Viewer": "true",
896.     "CloudFront-Is-Mobile-Viewer": "false",
897.     "CloudFront-Is-SmartTV-Viewer": "false",
898.     "CloudFront-Is-Tablet-Viewer": "false",
899.     "CloudFront-Viewer-Country": "GB",
900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",
901.     "upgrade-insecure-requests": "1",
902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",
904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",
905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",
906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",
907.     "X-Forwarded-Port": "443",
908.     "X-Forwarded-Proto": "https"
909.   },
910.   "query": {},
911.   "path": {},
912.   "identity": {
913.     "cognitoIdentityPoolId": "",
914.     "accountId": "",
915.     "cognitoIdentityId": "",
916.     "caller": "",
917.     "apiKey": "",
918.     "sourceIp": "94.197.120.169",
919.     "accessKey": "",
920.     "cognitoAuthenticationType": "",
921.     "cognitoAuthenticationProvider": "",
922.     "userArn": "",
923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",
924.     "user": ""
925.   },
926.   "stageVariables": {},
927.   "requestPath": "/request/path"
928. }
929. ```
930. 
931. ### Request templates
932. 
933. #### Default Request Templates
934. 
935. Serverless ships with the following default request templates you can use out of the box:
936. 
937. 1. `application/json`
938. 2. `application/x-www-form-urlencoded`
939. 
940. Both templates give you access to the following properties you can access with the help of the `event` object:
941. 
942. - body
943. - method
944. - principalId
945. - stage
946. - headers
947. - queryStringParameters
948. - path
949. - identity
950. - stageVariables
951. - requestPath
952. 
953. #### Custom Request Templates
954. 
955. However you can define and use your own request templates as follows (you can even overwrite the default request templates
956. by defining a new request template for an existing content type):
957. 
958. ```yml
959. functions:
960.   create:
961.     handler: posts.create
962.     events:
963.       - http:
964.           method: get
965.           path: whatever
966.           integration: lambda
967.           request:
968.             template:
969.               text/xhtml: '{ "stage" : "$context.stage" }'
970.               application/json: '{ "httpMethod" : "$context.httpMethod" }'
971. ```
972. 
973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
974. 
975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.


File: docs/providers/aws/events/apigateway.md
Line number range: 973 - 1081
Content:
973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
974. 
975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
976. 
977. If you want to map querystrings to the event object, you can use the `$input.params('hub.challenge')` syntax from API Gateway, as follows:
978. 
979. ```yml
980. functions:
981.   create:
982.     handler: posts.create
983.     events:
984.       - http:
985.           method: get
986.           path: whatever
987.           integration: lambda
988.           request:
989.             template:
990.               application/json: '{ "foo" : "$input.params(''bar'')" }'
991. ```
992. 
993. **Note:** Notice when using single-quoted strings, any single quote `'` inside its contents must be doubled (`''`) to escape it.
994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.
995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).
996. 
997. #### Pass Through Behavior
998. 
999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.
1000. 
1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):
1002. 
1003. ```yml
1004. functions:
1005.   create:
1006.     handler: posts.create
1007.     events:
1008.       - http:
1009.           method: get
1010.           path: whatever
1011.           integration: lambda
1012.           request:
1013.             passThrough: NEVER
1014. ```
1015. 
1016. There are 3 available options:
1017. 
1018. | Value             | Passed Through When                          | Rejected When                                                          |
1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |
1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |
1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |
1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |
1023. 
1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.
1025. 
1026. **Notes:**
1027. 
1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)
1030. 
1031. ### Responses
1032. 
1033. Serverless lets you setup custom headers and a response template for your `http` event.
1034. 
1035. #### Custom Response Headers
1036. 
1037. Here's an example which shows you how you can setup a custom response header:
1038. 
1039. ```yml
1040. functions:
1041.   create:
1042.     handler: posts.create
1043.     events:
1044.       - http:
1045.           method: get
1046.           path: whatever
1047.           integration: lambda
1048.           response:
1049.             headers:
1050.               Content-Type: integration.response.header.Content-Type
1051.               Cache-Control: "'max-age=120'"
1052. ```
1053. 
1054. **Note:** You're able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)
1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header
1056. as `"'max-age=120'"` means API Gateway will receive the value as `'max-age=120'` (enclosed with single quotes).
1057. 
1058. #### Custom Response Templates
1059. 
1060. Sometimes you'll want to define a custom response template API Gateway should use to transform your lambdas output.
1061. Here's an example which will transform the return value of your lambda so that the browser renders it as HTML:
1062. 
1063. ```yml
1064. functions:
1065.   create:
1066.     handler: posts.create
1067.     events:
1068.       - http:
1069.           method: get
1070.           path: whatever
1071.           integration: lambda
1072.           response:
1073.             headers:
1074.               Content-Type: "'text/html'"
1075.             template: $input.path('$')
1076. ```
1077. 
1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of
1079. the `${file(templatefile)}` syntax.
1080. 
1081. ### Status Codes


File: docs/providers/aws/events/apigateway.md
Line number range: 1484 - 1638
Content:
1484. ```yml
1485. service: service-c
1486. 
1487. provider:
1488.   apiGateway:
1489.     restApiId:
1490.       'Fn::ImportValue': apiGateway-restApiId
1491.     restApiRootResourceId:
1492.       'Fn::ImportValue': apiGateway-rootResourceId
1493. 
1494. functions:
1495.   deleteUser:
1496.     events:
1497.       - http:
1498.         path: /users/{userId}
1499.         authorizer:
1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
1501. ```
1502. 
1503. ```yml
1504. service: service-d
1505. 
1506. provider:
1507.   apiGateway:
1508.     restApiId:
1509.       'Fn::ImportValue': apiGateway-restApiId
1510.     restApiRootResourceId:
1511.       'Fn::ImportValue': apiGateway-rootResourceId
1512. 
1513. functions:
1514.   deleteProject:
1515.     events:
1516.       - http:
1517.         path: /project/{projectId}
1518.         authorizer:
1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn
1520. ```
1521. 
1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).
1523. 
1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.
1525. 
1526. ## Share Authorizer
1527. 
1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.
1529. 
1530. ```yml
1531. functions:
1532.   createUser:
1533.      ...
1534.     events:
1535.       - http:
1536.           path: /users
1537.           ...
1538.           authorizer:
1539.             # Provide both type and authorizerId
1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
1541.             authorizerId:
1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID
1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS
1544.               - myapp/myscope
1545. 
1546.   deleteUser:
1547.      ...
1548.     events:
1549.       - http:
1550.           path: /users/{userId}
1551.           ...
1552.           # Provide both type and authorizerId
1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation
1554.           authorizerId:
1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID
1556. 
1557. resources:
1558.   Resources:
1559.     ApiGatewayAuthorizer:
1560.       Type: AWS::ApiGateway::Authorizer
1561.       Properties:
1562.         AuthorizerResultTtlInSeconds: 300
1563.         IdentitySource: method.request.header.Authorization
1564.         Name: Cognito
1565.         RestApiId:
1566.           Ref: YourApiGatewayName
1567.         Type: COGNITO_USER_POOLS
1568.         ProviderARNs:
1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef
1570. 
1571. ```
1572. 
1573. ## Resource Policy
1574. 
1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.
1576. 
1577. ```yml
1578. provider:
1579.   name: aws
1580.   runtime: nodejs12.x
1581. 
1582.   resourcePolicy:
1583.     - Effect: Allow
1584.       Principal: '*'
1585.       Action: execute-api:Invoke
1586.       Resource:
1587.         - execute-api:/*/*/*
1588.       Condition:
1589.         IpAddress:
1590.           aws:SourceIp:
1591.             - '123.123.123.123'
1592. ```
1593. 
1594. ## Compression
1595. 
1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).
1597. 
1598. ```yml
1599. provider:
1600.   name: aws
1601.   apiGateway:
1602.     minimumCompressionSize: 1024
1603. ```
1604. 
1605. ## Binary Media Types
1606. 
1607. API Gateway makes it possible to return binary media such as images or files as responses.
1608. 
1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:
1610. 
1611. ```yml
1612. provider:
1613.   apiGateway:
1614.     binaryMediaTypes:
1615.       - '*/*'
1616. ```
1617. 
1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.
1619. 
1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).
1621. 
1622. ```yml
1623. functions:
1624.   create:
1625.     handler: posts.create
1626.     events:
1627.       - http:
1628.           path: posts/create
1629.           method: post
1630.           request:
1631.             contentHandling: CONVERT_TO_TEXT
1632.           response:
1633.             contentHandling: CONVERT_TO_TEXT
1634. ```
1635. 
1636. ## Detailed CloudWatch Metrics
1637. 
1638. Use the following configuration to enable detailed CloudWatch Metrics:


File: lib/configSchema.js
Line number range: 36 - 73
Content:
36.     functions: {
37.       type: 'object',
38.       patternProperties: {
39.         [functionNamePattern]: {
40.           type: 'object',
41.           properties: {
42.             name: { type: 'string' }, // name property is added by service class
43.             events: {
44.               type: 'array',
45.               items: {
46.                 /*
47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start
48.                  * with one dummy item as workaround to ensure it validates against
49.                  * any undefined function events.
50.                  */
51.                 anyOf: [
52.                   {
53.                     type: 'object',
54.                     properties: { __schemaWorkaround__: { const: null } },
55.                     required: ['__schemaWorkaround__'],
56.                     additionalProperties: false,
57.                   },
58.                 ],
59.               },
60.             },
61.           },
62. 
63.           /*
64.            * Schema for function properties is extended by a provider plugin.
65.            * For example, in the context of AWS provider props like
66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.
67.            * should be extended by awsProvider plugin.
68.            */
69.           additionalProperties: false,
70.         },
71.       },
72.       additionalProperties: false,
73.     },


File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 14 - 22
Content:
14. const compileMethods = require('./lib/method/index');
15. const compileAuthorizers = require('./lib/authorizers');
16. const compileDeployment = require('./lib/deployment');
17. const compilePermissions = require('./lib/permissions');
18. const compileStage = require('./lib/stage');
19. const getMethodAuthorization = require('./lib/method/authorization');
20. const getMethodIntegration = require('./lib/method/integration');
21. const getMethodResponses = require('./lib/method/responses');
22. 


File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 29 - 33
Content:
29.     this.serverless.configSchemaHandler.defineFunctionEvent('aws', 'http', {
30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018
31.       anyOf: [{ type: 'string' }, { type: 'object' }],
32.     });
33. 


File: lib/plugins/aws/package/compile/events/apiGateway/index.js
Line number range: 37 - 54
Content:
37.     Object.assign(
38.       this,
39.       validate,
40.       compileRestApi,
41.       compileApiKeys,
42.       compileUsagePlan,
43.       compileUsagePlanKeys,
44.       compileResources,
45.       compileCors,
46.       compileMethods,
47.       compileAuthorizers,
48.       compileDeployment,
49.       compilePermissions,
50.       compileStage,
51.       getMethodAuthorization,
52.       getMethodIntegration,
53.       getMethodResponses
54.     );


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js
Line number range: 61 - 69
Content:
61.       _.merge(
62.         template,
63.         this.getMethodAuthorization(event.http),
64.         this.getMethodIntegration(event.http, {
65.           lambdaLogicalId,
66.           lambdaAliasName,
67.         }),
68.         this.getMethodResponses(event.http)
69.       );


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js
Line number range: 85 - 93
Content:
85.       const requestTemplates = template.Properties.Integration.RequestTemplates;
86.       _.forEach(requestTemplates, (value, key) => {
87.         let claimsString = '';
88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {
89.           claimsString = extraCognitoPoolClaims.join(',').concat(',');
90.         }
91.         requestTemplates[key] = value.replace('extraCognitoPoolClaims', claimsString);
92.       });
93. 


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 5 - 49
Content:
5. const DEFAULT_COMMON_TEMPLATE = `
6.   #define( $loop )
7.     {
8.     #foreach($key in $map.keySet())
9.         #set( $k = $util.escapeJavaScript($key) )
10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\'", "'") )
11.         "$k":
12.           "$v"
13.           #if( $foreach.hasNext ) , #end
14.     #end
15.     }
16.   #end
17. 
18.   {
19.     "body": $body,
20.     "method": "$context.httpMethod",
21.     "principalId": "$context.authorizer.principalId",
22.     "stage": "$context.stage",
23. 
24.     "cognitoPoolClaims" : {
25.        extraCognitoPoolClaims
26.        "sub": "$context.authorizer.claims.sub"
27.     },
28. 
29.     #set( $map = $context.authorizer )
30.     "enhancedAuthContext": $loop,
31. 
32.     #set( $map = $input.params().header )
33.     "headers": $loop,
34. 
35.     #set( $map = $input.params().querystring )
36.     "query": $loop,
37. 
38.     #set( $map = $input.params().path )
39.     "path": $loop,
40. 
41.     #set( $map = $context.identity )
42.     "identity": $loop,
43. 
44.     #set( $map = $stageVariables )
45.     "stageVariables": $loop,
46. 
47.     "requestPath": "$context.resourcePath"
48.   }
49. `;


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 100 - 107
Content:
100.     if (type === 'AWS' || type === 'HTTP' || type === 'MOCK') {
101.       Object.assign(integration, {
102.         PassthroughBehavior: http.request && http.request.passThrough,
103.         ContentHandling: http.request && http.request.contentHandling,
104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === 'AWS'),
105.         IntegrationResponses: this.getIntegrationResponses(http),
106.       });
107.     }


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 198 - 218
Content:
198.   getIntegrationRequestTemplates(http, useDefaults) {
199.     // default request templates
200.     const integrationRequestTemplates = {};
201. 
202.     // Only set defaults for AWS (lambda) integration
203.     if (useDefaults) {
204.       Object.assign(integrationRequestTemplates, {
205.         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
206.         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
207.       });
208.     }
209. 
210.     // set custom request templates if provided
211.     if (http.request && typeof http.request.template === 'object') {
212.       Object.assign(integrationRequestTemplates, http.request.template);
213.     }
214. 
215.     return Object.keys(integrationRequestTemplates).length
216.       ? integrationRequestTemplates
217.       : undefined;
218.   },


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 234 - 239
Content:
234.   DEFAULT_JSON_REQUEST_TEMPLATE: `
235.     #set( $body = $input.json("$") )
236. 
237.     ${DEFAULT_COMMON_TEMPLATE}
238.   `,
239. 


File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
Line number range: 240 - 261
Content:
240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `
241.     #define( $body )
242.       {
243.       #foreach( $token in $input.path('$').split('&') )
244.         #set( $keyVal = $token.split('=') )
245.         #set( $keyValSize = $keyVal.size() )
246.         #if( $keyValSize >= 1 )
247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )
248.           #if( $keyValSize >= 2 )
249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\'","'"))
250.           #else
251.             #set( $val = '' )
252.           #end
253.           "$key": "$val"#if($foreach.hasNext),#end
254.         #end
255.       #end
256.       }
257.     #end
258. 
259.     ${DEFAULT_COMMON_TEMPLATE}
260.   `,
261. };


File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
Line number range: 491 - 508
Content:
491.   getRequest(http) {
492.     if (http.request) {
493.       const request = http.request;
494. 
495.       if (typeof http.request !== 'object') {
496.         const errorMessage = [
497.           'Request config must be provided as an object.',
498.           ' Please check the docs for more info.',
499.         ].join('');
500.         throw new this.serverless.classes.Error(errorMessage);
501.       }
502.       if (http.request.template && typeof http.request.template !== 'object') {
503.         const errorMessage = [
504.           'Template config must be provided as an object.',
505.           ' Please check the docs for more info.',
506.         ].join('');
507.         throw new this.serverless.classes.Error(errorMessage);
508.       }


File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
Line number range: 520 - 532
Content:
520.   getRequestParameters(httpRequest) {
521.     const parameters = {};
522.     // only these locations are currently supported
523.     const locations = ['querystrings', 'paths', 'headers'];
524.     locations.forEach(location => {
525.       // strip the plural s
526.       const singular = location.substring(0, location.length - 1);
527.       _.forEach(httpRequest.parameters[location], (value, key) => {
528.         parameters[`method.request.${singular}.${key}`] = value;
529.       });
530.     });
531.     return parameters;
532.   },


File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
Line number range: 534 - 561
Content:
534.   getRequestPassThrough(http) {
535.     const requestPassThroughBehaviors = ['NEVER', 'WHEN_NO_MATCH', 'WHEN_NO_TEMPLATES'];
536. 
537.     if (http.request.passThrough) {
538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {
539.         const errorMessage = [
540.           'Request passThrough "',
541.           http.request.passThrough,
542.           '" is not one of ',
543.           requestPassThroughBehaviors.join(', '),
544.         ].join('');
545.         throw new this.serverless.classes.Error(errorMessage);
546.       }
547. 
548.       return http.request.passThrough;
549.     }
550. 
551.     // Validate() sets the passThrough default to NEVER. This is inappropriate
552.     // for HTTP and MOCK integrations, where there is no default request template defined.
553.     const type = http.integration || 'AWS_PROXY';
554.     if (type === 'AWS') {
555.       return requestPassThroughBehaviors[0];
556.     } else if (type === 'HTTP' || type === 'MOCK') {
557.       return undefined;
558.     }
559. 
560.     return 'WHEN_NO_MATCH';
561.   },

--- END AGGREGATED CONTEXT ---

Analyze if the current context is sufficient to complete the user query by considering:
1. Do you understand the full scope and requirements of the user query?
2. Do you have access to all relevant code that needs to be examined or modified?
3. Are all critical dependencies and their interfaces visible?
4. Is there enough context about the system architecture and design patterns?
5. Do you have access to relevant documentation or tests if needed?

Only request additional context if essential information is missing. Ensure you're not requesting:
- Information already provided in previous queries
- Nice-to-have but non-essential details
- Implementation details that aren't relevant to the current task

If additional context is needed:
- Be specific about what you're looking for
- Consider both code and documentation that might be relevant

IMPORTANT:
- Try to avoid asking for the SAME or very similar information as previous queries, because these queries have already been asked and satisfied.

2025-11-13 20:13:22,661 - thread-135845287823040.prometheus.lang_graph.nodes.context_refine_node - DEBUG - reasoning='The aggregated context includes the exact production code that creates default API Gateway request mapping templates (getIntegrationRequestTemplates in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js) and the default templates themselves. It also shows where RequestTemplates are attached to the Integration object, and related request options (passThrough and contentHandling) and their validation in lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js. The docs segment for API Gateway events covers Default Request Templates, Custom Request Templates, and Pass Through Behavior. Together, these provide sufficient architectural patterns and interfaces to design and implement an option to disable/remove default templates without needing additional files.' query='' extra_requirements='' purpose='We have all key code paths and docs to identify integration points and propose a change to allow opting out of default request templates.'
2025-11-13 20:13:22,664 - thread-135845287823040.prometheus.lang_graph.nodes.context_retrieval_subgraph_node - INFO - Context retrieved: [Context(relative_path='docs/providers/aws/events/apigateway.md', content='706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```', start_line_number=706, end_line_number=833), Context(relative_path='docs/providers/aws/events/apigateway.md', content='815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.', start_line_number=815, end_line_number=975), Context(relative_path='docs/providers/aws/events/apigateway.md', content='973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes', start_line_number=973, end_line_number=1081), Context(relative_path='docs/providers/aws/events/apigateway.md', content="1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       'Fn::ImportValue': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       'Fn::ImportValue': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       'Fn::ImportValue': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       'Fn::ImportValue': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: '*'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - '123.123.123.123'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - '*/*'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:", start_line_number=1484, end_line_number=1638), Context(relative_path='lib/configSchema.js', content="36.     functions: {\n37.       type: 'object',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: 'object',\n41.           properties: {\n42.             name: { type: 'string' }, // name property is added by service class\n43.             events: {\n44.               type: 'array',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: 'object',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: ['__schemaWorkaround__'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },", start_line_number=36, end_line_number=73), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.js', content="14. const compileMethods = require('./lib/method/index');\n15. const compileAuthorizers = require('./lib/authorizers');\n16. const compileDeployment = require('./lib/deployment');\n17. const compilePermissions = require('./lib/permissions');\n18. const compileStage = require('./lib/stage');\n19. const getMethodAuthorization = require('./lib/method/authorization');\n20. const getMethodIntegration = require('./lib/method/integration');\n21. const getMethodResponses = require('./lib/method/responses');\n22. ", start_line_number=14, end_line_number=22), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.js', content="29.     this.serverless.configSchemaHandler.defineFunctionEvent('aws', 'http', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: 'string' }, { type: 'object' }],\n32.     });\n33. ", start_line_number=29, end_line_number=33), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/index.js', content='37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );', start_line_number=37, end_line_number=54), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js', content='61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );', start_line_number=61, end_line_number=69), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js', content="85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = '';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(',').concat(',');\n90.         }\n91.         requestTemplates[key] = value.replace('extraCognitoPoolClaims', claimsString);\n92.       });\n93. ", start_line_number=85, end_line_number=93), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', content='5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;', start_line_number=5, end_line_number=49), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', content="100.     if (type === 'AWS' || type === 'HTTP' || type === 'MOCK') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === 'AWS'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }", start_line_number=100, end_line_number=107), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', content="198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === 'object') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },", start_line_number=198, end_line_number=218), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', content='234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. ', start_line_number=234, end_line_number=239), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', content='240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };', start_line_number=240, end_line_number=261), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', content="491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== 'object') {\n496.         const errorMessage = [\n497.           'Request config must be provided as an object.',\n498.           ' Please check the docs for more info.',\n499.         ].join('');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== 'object') {\n503.         const errorMessage = [\n504.           'Template config must be provided as an object.',\n505.           ' Please check the docs for more info.',\n506.         ].join('');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }", start_line_number=491, end_line_number=508), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', content="520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = ['querystrings', 'paths', 'headers'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },", start_line_number=520, end_line_number=532), Context(relative_path='lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', content='534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },', start_line_number=534, end_line_number=561)]
2025-11-13 20:13:22,667 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n' additional_kwargs={} response_metadata={}
2025-11-13 20:14:10,154 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content="Feature Understanding:\n- The request asks for a way to prevent Serverless from automatically creating default API Gateway request mapping templates for two content types: application/json and application/x-www-form-urlencoded, in the AWS Lambda (non-proxy) integration. Currently both defaults are always added for AWS integration, even if the application only supports JSON. This results in API Gateway-generated Swagger/OpenAPI documentation advertising that the API consumes both content types.\n- Desired functionality:\n  - Provide configuration to disable adding all default request templates, or selectively exclude certain default content types (e.g., remove application/x-www-form-urlencoded while keeping application/json).\n  - Ensure that the produced CloudFormation for AWS::ApiGateway::Method Integration.RequestTemplates reflects only the content types intended by the user.\n  - Maintain backward compatibility: existing stacks should continue to get both defaults unless explicitly disabled or excluded.\n- Ambiguities/edge cases to clarify and handle:\n  - Scope: This applies only to the non-proxy Lambda integration (type AWS). For AWS_PROXY no request templates are used, so no change there.\n  - Interaction with passThrough behavior: If defaults are disabled, what should be the default PassthroughBehavior for AWS integration? Current logic defaults to NEVER for AWS. We should keep existing defaults unless the user overrides passThrough explicitly.\n  - If a user sets both “disable all defaults” and “exclude specific content types,” define precedence (recommend that disable all defaults takes precedence; the exclude list is ignored when defaults are disabled).\n  - Validation for exclude list values: Either allow any string or restrict to known defaults. It’s safer to allow any valid content type string, but document that the list only affects default templates the framework would otherwise add.\n\nArchitecture Analysis:\n- Integration points:\n  - Default request templates are injected in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js within getIntegrationRequestTemplates(http, useDefaults), which currently unconditionally adds default templates for application/json and application/x-www-form-urlencoded when type === 'AWS'.\n  - Validation of http.request payload happens in lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js. This is the right place to validate any new config options (e.g., disable defaults, exclude content types).\n  - Documentation for API Gateway request templates is in docs/providers/aws/events/apigateway.md under “Request templates” and “Default Request Templates”. It needs updates to describe new configuration.\n- Files to modify:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js (to change how defaults are built and optionally filtered/disabled)\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js (to validate new request options)\n  - docs/providers/aws/events/apigateway.md (to document new configuration with examples and caveats)\n- Optional:\n  - lib/plugins/aws/package/compile/events/apiGateway/index.js: The schema is currently very loose (anyOf: string | object). If you plan to extend the JSON schema for function events, consider documenting the new options in validation only, since the provider does not yet enforce detailed schemas.\n\nImplementation Plan:\n1. Modify default template building logic\n   - File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n   - Function: getIntegrationRequestTemplates(http, useDefaults)\n   - Changes:\n     - Add support for an opt-out of defaults via a new boolean flag on http.request, e.g., http.request.disableDefaultTemplates (name can be disableDefaultTemplates for clarity).\n       - If http.request.disableDefaultTemplates is true, do not add any default templates (skip Object.assign of application/json and application/x-www-form-urlencoded).\n     - Add support for selectively excluding default content types via a new array on http.request, e.g., http.request.excludeDefaultContentTypes.\n       - If useDefaults and http.request.excludeDefaultContentTypes is provided, remove any matching default keys from the default set before merging custom templates. For example, if ['application/x-www-form-urlencoded'] is provided, only 'application/json' remains in the default set.\n     - Preserve existing behavior when neither option is set: both defaults are added for AWS integration.\n     - Continue to merge user-defined templates from http.request.template as currently implemented, allowing overrides for any content type.\n     - Return undefined when no templates are present (current behavior), which may influence how API Gateway treats pass-through if the user sets passThrough accordingly.\n\n2. Validate new configuration options\n   - File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n   - Function: getRequest(http)\n   - Changes:\n     - Add validation for http.request.disableDefaultTemplates:\n       - If present, it must be a boolean. If not, throw a descriptive validation error.\n     - Add validation for http.request.excludeDefaultContentTypes:\n       - If present, it must be an array of strings. If not, throw a descriptive validation error.\n     - Define precedence in validation or at least document it:\n       - If disableDefaultTemplates is true, excludeDefaultContentTypes is redundant and will be ignored for logic; do not error, but optionally warn or simply ignore.\n     - No changes required to getRequestPassThrough unless you want to alter defaults. For backward compatibility, leave getRequestPassThrough unchanged so passThrough remains NEVER for AWS unless explicitly set by the user, even if defaults are disabled.\n\n3. Documentation updates\n   - File: docs/providers/aws/events/apigateway.md\n   - Sections to modify:\n     - “Request templates” / “Default Request Templates” (lines ~933-975):\n       - Add a short subsection explaining:\n         - Defaults added for Lambda (AWS) integration: application/json and application/x-www-form-urlencoded.\n         - New config to disable defaults entirely with request.disableDefaultTemplates: true.\n         - New config to exclude specific default content types with request.excludeDefaultContentTypes: [...], e.g., ['application/x-www-form-urlencoded'].\n         - An example YAML showing how to only include application/json (either by disabling all defaults and defining a JSON template, or excluding form-urlencoded while keeping default json).\n       - Note the impact on API Gateway-generated Swagger/OpenAPI: Only content types with mapping templates will appear under “consumes” for non-proxy integrations.\n     - “Custom Request Templates”:\n       - Mention that you can now also suppress defaults and rely solely on your custom mapping templates.\n     - “Pass Through Behavior”:\n       - Add a note clarifying that if you disable all templates and do not define any, with AWS integration default passThrough (NEVER), requests without matching templates will be rejected with 415 unless you explicitly set passThrough to WHEN_NO_TEMPLATES or WHEN_NO_MATCH.\n\n4. Optional schema adjustments\n   - File: lib/plugins/aws/package/compile/events/apiGateway/index.js\n   - The schema definition is currently basic; if you plan to extend it:\n     - Update defineFunctionEvent('aws', 'http', ...) to allow http.event objects with nested request.disableDefaultTemplates (boolean) and request.excludeDefaultContentTypes (array of strings).\n     - This is optional given the TODO to complete schema; rely on validate.js for enforcement in the interim.\n\nConsiderations:\n- Impacts on existing functionality:\n  - Default behavior remains unchanged. Only users who opt-in via new configuration will see fewer or no default templates.\n  - For users who disable defaults and don’t provide custom templates, the AWS integration default passThrough (NEVER) means unsupported content types will be rejected with 415. This is consistent with current defaults and should be documented.\n- Backward compatibility:\n  - Fully preserved. No breaking change in defaults or behavior unless a user sets the new properties.\n- Dependencies or prerequisites:\n  - None external. Changes are confined to the AWS provider’s API Gateway method integration building and validation.\n  - Unit tests should be added alongside these changes (in the provider’s test suite if available) to verify:\n    - When disableDefaultTemplates is true, no defaults are added.\n    - When excludeDefaultContentTypes includes application/x-www-form-urlencoded, only application/json default remains.\n    - When custom templates are provided, they still override defaults.\n    - The produced RequestTemplates matches the intended configuration in all cases.\n\nWorkaround suggestions until the feature is implemented:\n- If feasible for your application, switch to Lambda proxy integration (integration: lambda or the framework’s default AWS_PROXY). Lambda proxy doesn’t use mapping templates and typically results in API Gateway docs reflecting only JSON by default.\n- Alternatively, continue to define only application/json under request.template and set passThrough to NEVER to ensure other content types are rejected. This won’t remove application/x-www-form-urlencoded from “consumes” with current defaults, but it will prevent those requests from being processed. The proposed feature above resolves the “consumes” advertising issue by allowing template removal." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5141, 'prompt_tokens': 9771, 'total_tokens': 14912, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3328, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--540a6c66-3687-4b86-b95e-390ac6e8aa12-0' usage_metadata={'input_tokens': 9771, 'output_tokens': 5141, 'total_tokens': 14912, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3328}}
2025-11-13 20:14:10,160 - thread-135845287823040.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nFeature Understanding:\n- The request asks for a way to prevent Serverless from automatically creating default API Gateway request mapping templates for two content types: application/json and application/x-www-form-urlencoded, in the AWS Lambda (non-proxy) integration. Currently both defaults are always added for AWS integration, even if the application only supports JSON. This results in API Gateway-generated Swagger/OpenAPI documentation advertising that the API consumes both content types.\n- Desired functionality:\n  - Provide configuration to disable adding all default request templates, or selectively exclude certain default content types (e.g., remove application/x-www-form-urlencoded while keeping application/json).\n  - Ensure that the produced CloudFormation for AWS::ApiGateway::Method Integration.RequestTemplates reflects only the content types intended by the user.\n  - Maintain backward compatibility: existing stacks should continue to get both defaults unless explicitly disabled or excluded.\n- Ambiguities/edge cases to clarify and handle:\n  - Scope: This applies only to the non-proxy Lambda integration (type AWS). For AWS_PROXY no request templates are used, so no change there.\n  - Interaction with passThrough behavior: If defaults are disabled, what should be the default PassthroughBehavior for AWS integration? Current logic defaults to NEVER for AWS. We should keep existing defaults unless the user overrides passThrough explicitly.\n  - If a user sets both “disable all defaults” and “exclude specific content types,” define precedence (recommend that disable all defaults takes precedence; the exclude list is ignored when defaults are disabled).\n  - Validation for exclude list values: Either allow any string or restrict to known defaults. It’s safer to allow any valid content type string, but document that the list only affects default templates the framework would otherwise add.\n\nArchitecture Analysis:\n- Integration points:\n  - Default request templates are injected in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js within getIntegrationRequestTemplates(http, useDefaults), which currently unconditionally adds default templates for application/json and application/x-www-form-urlencoded when type === \'AWS\'.\n  - Validation of http.request payload happens in lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js. This is the right place to validate any new config options (e.g., disable defaults, exclude content types).\n  - Documentation for API Gateway request templates is in docs/providers/aws/events/apigateway.md under “Request templates” and “Default Request Templates”. It needs updates to describe new configuration.\n- Files to modify:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js (to change how defaults are built and optionally filtered/disabled)\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js (to validate new request options)\n  - docs/providers/aws/events/apigateway.md (to document new configuration with examples and caveats)\n- Optional:\n  - lib/plugins/aws/package/compile/events/apiGateway/index.js: The schema is currently very loose (anyOf: string | object). If you plan to extend the JSON schema for function events, consider documenting the new options in validation only, since the provider does not yet enforce detailed schemas.\n\nImplementation Plan:\n1. Modify default template building logic\n   - File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n   - Function: getIntegrationRequestTemplates(http, useDefaults)\n   - Changes:\n     - Add support for an opt-out of defaults via a new boolean flag on http.request, e.g., http.request.disableDefaultTemplates (name can be disableDefaultTemplates for clarity).\n       - If http.request.disableDefaultTemplates is true, do not add any default templates (skip Object.assign of application/json and application/x-www-form-urlencoded).\n     - Add support for selectively excluding default content types via a new array on http.request, e.g., http.request.excludeDefaultContentTypes.\n       - If useDefaults and http.request.excludeDefaultContentTypes is provided, remove any matching default keys from the default set before merging custom templates. For example, if [\'application/x-www-form-urlencoded\'] is provided, only \'application/json\' remains in the default set.\n     - Preserve existing behavior when neither option is set: both defaults are added for AWS integration.\n     - Continue to merge user-defined templates from http.request.template as currently implemented, allowing overrides for any content type.\n     - Return undefined when no templates are present (current behavior), which may influence how API Gateway treats pass-through if the user sets passThrough accordingly.\n\n2. Validate new configuration options\n   - File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n   - Function: getRequest(http)\n   - Changes:\n     - Add validation for http.request.disableDefaultTemplates:\n       - If present, it must be a boolean. If not, throw a descriptive validation error.\n     - Add validation for http.request.excludeDefaultContentTypes:\n       - If present, it must be an array of strings. If not, throw a descriptive validation error.\n     - Define precedence in validation or at least document it:\n       - If disableDefaultTemplates is true, excludeDefaultContentTypes is redundant and will be ignored for logic; do not error, but optionally warn or simply ignore.\n     - No changes required to getRequestPassThrough unless you want to alter defaults. For backward compatibility, leave getRequestPassThrough unchanged so passThrough remains NEVER for AWS unless explicitly set by the user, even if defaults are disabled.\n\n3. Documentation updates\n   - File: docs/providers/aws/events/apigateway.md\n   - Sections to modify:\n     - “Request templates” / “Default Request Templates” (lines ~933-975):\n       - Add a short subsection explaining:\n         - Defaults added for Lambda (AWS) integration: application/json and application/x-www-form-urlencoded.\n         - New config to disable defaults entirely with request.disableDefaultTemplates: true.\n         - New config to exclude specific default content types with request.excludeDefaultContentTypes: [...], e.g., [\'application/x-www-form-urlencoded\'].\n         - An example YAML showing how to only include application/json (either by disabling all defaults and defining a JSON template, or excluding form-urlencoded while keeping default json).\n       - Note the impact on API Gateway-generated Swagger/OpenAPI: Only content types with mapping templates will appear under “consumes” for non-proxy integrations.\n     - “Custom Request Templates”:\n       - Mention that you can now also suppress defaults and rely solely on your custom mapping templates.\n     - “Pass Through Behavior”:\n       - Add a note clarifying that if you disable all templates and do not define any, with AWS integration default passThrough (NEVER), requests without matching templates will be rejected with 415 unless you explicitly set passThrough to WHEN_NO_TEMPLATES or WHEN_NO_MATCH.\n\n4. Optional schema adjustments\n   - File: lib/plugins/aws/package/compile/events/apiGateway/index.js\n   - The schema definition is currently basic; if you plan to extend it:\n     - Update defineFunctionEvent(\'aws\', \'http\', ...) to allow http.event objects with nested request.disableDefaultTemplates (boolean) and request.excludeDefaultContentTypes (array of strings).\n     - This is optional given the TODO to complete schema; rely on validate.js for enforcement in the interim.\n\nConsiderations:\n- Impacts on existing functionality:\n  - Default behavior remains unchanged. Only users who opt-in via new configuration will see fewer or no default templates.\n  - For users who disable defaults and don’t provide custom templates, the AWS integration default passThrough (NEVER) means unsupported content types will be rejected with 415. This is consistent with current defaults and should be documented.\n- Backward compatibility:\n  - Fully preserved. No breaking change in defaults or behavior unless a user sets the new properties.\n- Dependencies or prerequisites:\n  - None external. Changes are confined to the AWS provider’s API Gateway method integration building and validation.\n  - Unit tests should be added alongside these changes (in the provider’s test suite if available) to verify:\n    - When disableDefaultTemplates is true, no defaults are added.\n    - When excludeDefaultContentTypes includes application/x-www-form-urlencoded, only application/json default remains.\n    - When custom templates are provided, they still override defaults.\n    - The produced RequestTemplates matches the intended configuration in all cases.\n\nWorkaround suggestions until the feature is implemented:\n- If feasible for your application, switch to Lambda proxy integration (integration: lambda or the framework’s default AWS_PROXY). Lambda proxy doesn’t use mapping templates and typically results in API Gateway docs reflecting only JSON by default.\n- Alternatively, continue to define only application/json under request.template and set passThrough to NEVER to ensure other content types are rejected. This won’t remove application/x-www-form-urlencoded from “consumes” with current defaults, but it will prevent those requests from being processed. The proposed feature above resolves the “consumes” advertising issue by allowing template removal.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 20:14:14,796 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_eRZvdDQD7pXrXxE5Ma9KGYkF', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 231, 'prompt_tokens': 11979, 'total_tokens': 12210, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--02adfd8d-6161-41d8-b568-134e9715f162-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_eRZvdDQD7pXrXxE5Ma9KGYkF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11979, 'output_tokens': 231, 'total_tokens': 12210, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:14:22,656 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_l9VUymq4UQ7QBtUl9rjsq1QL', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 805, 'prompt_tokens': 14348, 'total_tokens': 15153, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 768, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--529b7f4d-48d7-4a60-a72e-f152af9af53a-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js'}, 'id': 'call_l9VUymq4UQ7QBtUl9rjsq1QL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14348, 'output_tokens': 805, 'total_tokens': 15153, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 768}}
2025-11-13 20:14:24,238 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_O9997EPw3gePdVZZ9QxfbGVO', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 19212, 'total_tokens': 19243, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14336}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8352b64a-bd60-4605-a160-376b6c1d81c2-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js'}, 'id': 'call_O9997EPw3gePdVZZ9QxfbGVO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19212, 'output_tokens': 31, 'total_tokens': 19243, 'input_token_details': {'audio': 0, 'cache_read': 14336}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:14:26,435 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_8157Kq7zpqP5KAR4ZUlhP2Jf', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":491,"end_line":700}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 24076, 'total_tokens': 24120, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6fea2933-5cc2-464b-b238-eb541af37a69-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 491, 'end_line': 700}, 'id': 'call_8157Kq7zpqP5KAR4ZUlhP2Jf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24076, 'output_tokens': 44, 'total_tokens': 24120, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:14:37,745 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_IFaI59qAkjlevzbMp31EEsto', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":975}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1133, 'prompt_tokens': 25132, 'total_tokens': 26265, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1088, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1b548704-87a9-4312-98ce-264fb1d40290-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 975}, 'id': 'call_IFaI59qAkjlevzbMp31EEsto', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25132, 'output_tokens': 1133, 'total_tokens': 26265, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1088}}
2025-11-13 20:14:39,576 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PdxhSv20lndGXt0fQFpNFGhM', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":973,"end_line":1035}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 25530, 'total_tokens': 25570, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24064}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4c29ba81-7624-4341-85b9-754c3c65b416-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 973, 'end_line': 1035}, 'id': 'call_PdxhSv20lndGXt0fQFpNFGhM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25530, 'output_tokens': 40, 'total_tokens': 25570, 'input_token_details': {'audio': 0, 'cache_read': 24064}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:17,613 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_f4IrCWxhi2tF1p34JhwAsfG9', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","old_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      Object.assign(integrationRequestTemplates, {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      });\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },","new_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      let defaultTemplates = {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      };\\n\\n      // Allow disabling all default templates\\n      if (http.request && http.request.disableDefaultTemplates) {\\n        defaultTemplates = {};\\n      } else if (\\n        http.request &&\\n        Array.isArray(http.request.excludeDefaultContentTypes)\\n      ) {\\n        http.request.excludeDefaultContentTypes.forEach(type => {\\n          delete defaultTemplates[type];\\n        });\\n      }\\n\\n      Object.assign(integrationRequestTemplates, defaultTemplates);\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 4310, 'prompt_tokens': 26445, 'total_tokens': 30755, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3840, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--217f0c80-0bbe-4604-b5c1-2d7d028426d2-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'old_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      Object.assign(integrationRequestTemplates, {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      });\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },", 'new_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      let defaultTemplates = {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      };\n\n      // Allow disabling all default templates\n      if (http.request && http.request.disableDefaultTemplates) {\n        defaultTemplates = {};\n      } else if (\n        http.request &&\n        Array.isArray(http.request.excludeDefaultContentTypes)\n      ) {\n        http.request.excludeDefaultContentTypes.forEach(type => {\n          delete defaultTemplates[type];\n        });\n      }\n\n      Object.assign(integrationRequestTemplates, defaultTemplates);\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },"}, 'id': 'call_f4IrCWxhi2tF1p34JhwAsfG9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26445, 'output_tokens': 4310, 'total_tokens': 30755, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3840}}
2025-11-13 20:15:22,914 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_0t71QrtFIv4wRI4lQYPsuFj7', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","old_content":"      if (typeof http.request !== \'object\') {\\n        const errorMessage = [\\n          \'Request config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n\\n      if (request.parameters) {\\n        request.parameters = this.getRequestParameters(request);\\n      }\\n\\n      return request;","new_content":"      if (typeof http.request !== \'object\') {\\n        const errorMessage = [\\n          \'Request config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (\\n        typeof http.request.disableDefaultTemplates !== \'undefined\' &&\\n        typeof http.request.disableDefaultTemplates !== \'boolean\'\\n      ) {\\n        const errorMessage = [\\n          \'disableDefaultTemplates must be provided as a boolean.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (\\n        typeof http.request.excludeDefaultContentTypes !== \'undefined\' &&\\n        !Array.isArray(http.request.excludeDefaultContentTypes)\\n      ) {\\n        const errorMessage = [\\n          \'excludeDefaultContentTypes must be provided as an array of strings.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (Array.isArray(http.request.excludeDefaultContentTypes)) {\\n        const invalid = http.request.excludeDefaultContentTypes.some(\\n          t => typeof t !== \'string\'\\n        );\\n        if (invalid) {\\n          const errorMessage = [\\n            \'excludeDefaultContentTypes must be provided as an array of strings.\',\\n            \' Please check the docs for more info.\',\\n          ].join(\'\');\\n          throw new this.serverless.classes.Error(errorMessage);\\n        }\\n      }\\n\\n      if (request.parameters) {\\n        request.parameters = this.getRequestParameters(request);\\n      }\\n\\n      return request;"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 669, 'prompt_tokens': 26937, 'total_tokens': 27606, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dfc3c052-efdd-485e-8566-738ef15ddc61-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'old_content': "      if (typeof http.request !== 'object') {\n        const errorMessage = [\n          'Request config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (http.request.template && typeof http.request.template !== 'object') {\n        const errorMessage = [\n          'Template config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n\n      if (request.parameters) {\n        request.parameters = this.getRequestParameters(request);\n      }\n\n      return request;", 'new_content': "      if (typeof http.request !== 'object') {\n        const errorMessage = [\n          'Request config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (http.request.template && typeof http.request.template !== 'object') {\n        const errorMessage = [\n          'Template config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (\n        typeof http.request.disableDefaultTemplates !== 'undefined' &&\n        typeof http.request.disableDefaultTemplates !== 'boolean'\n      ) {\n        const errorMessage = [\n          'disableDefaultTemplates must be provided as a boolean.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (\n        typeof http.request.excludeDefaultContentTypes !== 'undefined' &&\n        !Array.isArray(http.request.excludeDefaultContentTypes)\n      ) {\n        const errorMessage = [\n          'excludeDefaultContentTypes must be provided as an array of strings.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (Array.isArray(http.request.excludeDefaultContentTypes)) {\n        const invalid = http.request.excludeDefaultContentTypes.some(\n          t => typeof t !== 'string'\n        );\n        if (invalid) {\n          const errorMessage = [\n            'excludeDefaultContentTypes must be provided as an array of strings.',\n            ' Please check the docs for more info.',\n          ].join('');\n          throw new this.serverless.classes.Error(errorMessage);\n        }\n      }\n\n      if (request.parameters) {\n        request.parameters = this.getRequestParameters(request);\n      }\n\n      return request;"}, 'id': 'call_0t71QrtFIv4wRI4lQYPsuFj7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26937, 'output_tokens': 669, 'total_tokens': 27606, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:24,573 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_S5C0PhRUaHnFVy0HJlpQI8jz', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":1000}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 27632, 'total_tokens': 27672, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 25088}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--034a33fe-fef3-46f6-8ec6-ad13e3d53648-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 1000}, 'id': 'call_S5C0PhRUaHnFVy0HJlpQI8jz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27632, 'output_tokens': 40, 'total_tokens': 27672, 'input_token_details': {'audio': 0, 'cache_read': 25088}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:30,625 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nYfAwcImz1Oo7uybZq3i6MiO', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box:\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n\\n- body\\n- method\\n- principalId\\n- stage\\n- headers\\n- queryStringParameters\\n- path\\n- identity\\n- stageVariables\\n- requestPath\\n\\n#### Custom Request Templates\\n\\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n\\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\\n","new_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box for Lambda (AWS) integration:\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n\\n- body\\n- method\\n- principalId\\n- stage\\n- headers\\n- queryStringParameters\\n- path\\n- identity\\n- stageVariables\\n- requestPath\\n\\nYou can control these defaults:\\n\\n- Disable all default templates:\\n  set `request.disableDefaultTemplates: true` to prevent Serverless from adding any default request mapping templates.\\n- Exclude specific default content types:\\n  set `request.excludeDefaultContentTypes` to a list of content types to remove from the defaults. For example, to remove `application/x-www-form-urlencoded` while keeping `application/json`.\\n\\nExamples:\\n\\n```yml\\nfunctions:\\n  onlyJson:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: post\\n          path: posts/create\\n          integration: lambda\\n          request:\\n            excludeDefaultContentTypes:\\n              - application/x-www-form-urlencoded\\n\\n  noDefaultsCustomOnly:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: post\\n          path: posts/create\\n          integration: lambda\\n          request:\\n            disableDefaultTemplates: true\\n            template:\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n\\n#### Custom Request Templates\\n\\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n\\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 805, 'prompt_tokens': 28453, 'total_tokens': 29258, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27520}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--46b0e8b9-1aa3-4368-9ee0-acc42f4402a0-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box:\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n\n- body\n- method\n- principalId\n- stage\n- headers\n- queryStringParameters\n- path\n- identity\n- stageVariables\n- requestPath\n\n#### Custom Request Templates\n\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n', 'new_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box for Lambda (AWS) integration:\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n\n- body\n- method\n- principalId\n- stage\n- headers\n- queryStringParameters\n- path\n- identity\n- stageVariables\n- requestPath\n\nYou can control these defaults:\n\n- Disable all default templates:\n  set `request.disableDefaultTemplates: true` to prevent Serverless from adding any default request mapping templates.\n- Exclude specific default content types:\n  set `request.excludeDefaultContentTypes` to a list of content types to remove from the defaults. For example, to remove `application/x-www-form-urlencoded` while keeping `application/json`.\n\nExamples:\n\n```yml\nfunctions:\n  onlyJson:\n    handler: posts.create\n    events:\n      - http:\n          method: post\n          path: posts/create\n          integration: lambda\n          request:\n            excludeDefaultContentTypes:\n              - application/x-www-form-urlencoded\n\n  noDefaultsCustomOnly:\n    handler: posts.create\n    events:\n      - http:\n          method: post\n          path: posts/create\n          integration: lambda\n          request:\n            disableDefaultTemplates: true\n            template:\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n\n#### Custom Request Templates\n\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n'}, 'id': 'call_nYfAwcImz1Oo7uybZq3i6MiO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28453, 'output_tokens': 805, 'total_tokens': 29258, 'input_token_details': {'audio': 0, 'cache_read': 27520}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:40,719 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_mHV9Si7VG6Iy46tk8dgSaaB7', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\\n\\nIf you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              application/json: \'{ \\"foo\\" : \\"$input.params(\'\'bar\'\')\\" }\'\\n```\\n\\n**Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\\nYou can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\\nIf you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\\n\\n#### Pass Through Behavior\\n\\n[API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\\n\\nYou can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            passThrough: NEVER\\n```\\n\\nThere are 3 available options:\\n\\n| Value             | Passed Through When                          | Rejected When                                                          |\\n| ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\\n| NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\\n| WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\\n| WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\\n\\nSee the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\\n\\n**Notes:**\\n\\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\\n- API Gateway docs refer to \\"WHEN_NO_TEMPLATE\\" (singular), but this will fail during creation as the actual value should be \\"WHEN_NO_TEMPLATES\\" (plural)\\n","new_content":"**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\\n\\nIf you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              application/json: \'{ \\"foo\\" : \\"$input.params(\'\'bar\'\')\\" }\'\\n```\\n\\n**Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\\nYou can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\\nIf you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\\n\\n#### Pass Through Behavior\\n\\n[API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\\n\\nYou can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            passThrough: NEVER\\n```\\n\\nThere are 3 available options:\\n\\n| Value             | Passed Through When                          | Rejected When                                                          |\\n| ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\\n| NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\\n| WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\\n| WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\\n\\nSee the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\\n\\n**Notes:**\\n\\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\\n- API Gateway docs refer to \\"WHEN_NO_TEMPLATE\\" (singular), but this will fail during creation as the actual value should be \\"WHEN_NO_TEMPLATES\\" (plural)\\n- When you disable all default templates and do not define any custom templates for AWS (Lambda) integration, the default passThrough behavior (NEVER) will cause API Gateway to reject requests with 415 unless you explicitly change `request.passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH`.\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1461, 'prompt_tokens': 29279, 'total_tokens': 30740, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--65394e40-d40f-4bba-8c5b-c738ab640617-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\nIf you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n```\n\n**Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\nYou can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\nIf you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n\n#### Pass Through Behavior\n\n[API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n\nYou can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            passThrough: NEVER\n```\n\nThere are 3 available options:\n\n| Value             | Passed Through When                          | Rejected When                                                          |\n| ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n| NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n| WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n| WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n\nSee the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n\n**Notes:**\n\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n- API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n', 'new_content': '**Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\nIf you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n```\n\n**Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\nYou can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\nIf you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n\n#### Pass Through Behavior\n\n[API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n\nYou can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            passThrough: NEVER\n```\n\nThere are 3 available options:\n\n| Value             | Passed Through When                          | Rejected When                                                          |\n| ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n| NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n| WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n| WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n\nSee the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n\n**Notes:**\n\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n- API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n- When you disable all default templates and do not define any custom templates for AWS (Lambda) integration, the default passThrough behavior (NEVER) will cause API Gateway to reject requests with 415 unless you explicitly change `request.passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH`.\n'}, 'id': 'call_mHV9Si7VG6Iy46tk8dgSaaB7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29279, 'output_tokens': 1461, 'total_tokens': 30740, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:42,956 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Ysfwigk2k76xtJR5PgC0Iz7i', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 30761, 'total_tokens': 30794, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c8e6df28-7c80-4bc4-a863-0cacd4938f60-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_Ysfwigk2k76xtJR5PgC0Iz7i', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30761, 'output_tokens': 33, 'total_tokens': 30794, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:45,152 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_DIylJEe9LxtSSbhoo6QjtzuF', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":491,"end_line":560}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 33239, 'total_tokens': 33283, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 25472}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d528b0ec-3ecb-4b27-8b05-8be38caabf8c-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 491, 'end_line': 560}, 'id': 'call_DIylJEe9LxtSSbhoo6QjtzuF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33239, 'output_tokens': 44, 'total_tokens': 33283, 'input_token_details': {'audio': 0, 'cache_read': 25472}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:47,505 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_HPjzQjEiEHoSaGSNJ9hCvvVf', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":560,"end_line":700}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 33932, 'total_tokens': 33976, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 26368}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--73be7414-1c2e-4508-acd4-5a45b2465c3d-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 560, 'end_line': 700}, 'id': 'call_HPjzQjEiEHoSaGSNJ9hCvvVf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 33932, 'output_tokens': 44, 'total_tokens': 33976, 'input_token_details': {'audio': 0, 'cache_read': 26368}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:53,367 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content="I will implement the feature allowing removal of default request mapping templates and document it.\n\nSummary of changes:\n- Updated API Gateway integration logic to support two new request options:\n  - request.disableDefaultTemplates (boolean): when true, no default templates are added for AWS (Lambda) integration.\n  - request.excludeDefaultContentTypes (array of strings): selectively removes specified default content types (e.g., application/x-www-form-urlencoded) while keeping others.\n- Added validation for these new options to ensure correct types and provide clear errors.\n- Updated documentation to explain defaults and new configuration options with examples, and clarified pass-through behavior implications.\n\nFiles modified:\n- lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - Enhanced getIntegrationRequestTemplates to honor request.disableDefaultTemplates and request.excludeDefaultContentTypes when useDefaults is true (AWS integration).\n- lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n  - Added validation checks for request.disableDefaultTemplates (boolean) and request.excludeDefaultContentTypes (array of strings).\n- docs/providers/aws/events/apigateway.md\n  - Expanded “Default Request Templates” section to describe new options and provide YAML examples.\n  - Added a note under “Pass Through Behavior” about rejecting with 415 when defaults are disabled and no custom templates are defined unless passThrough is adjusted.\n\nBehavior:\n- Backward compatibility remains: if you don’t set these new options, both default templates (application/json and application/x-www-form-urlencoded) are still added for AWS integration.\n- To only include JSON, set:\n  - request.excludeDefaultContentTypes: ['application/x-www-form-urlencoded']\n- To remove all defaults and rely on custom templates, set:\n  - request.disableDefaultTemplates: true\n  - request.template: { ... }\n\nLet me know if you want the JSON schema looseness addressed for these new options as well." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 385, 'prompt_tokens': 34662, 'total_tokens': 35047, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--cb0148e2-7705-407d-8a68-e49196cd64fb-0' usage_metadata={'input_tokens': 34662, 'output_tokens': 385, 'total_tokens': 35047, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:15:53,468 - thread-135845287823040.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..9b4f67eb3 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -932,7 +932,7 @@ This method is more complicated and involves a lot more configuration of the `ht
 
 #### Default Request Templates
 
-Serverless ships with the following default request templates you can use out of the box:
+Serverless ships with the following default request templates you can use out of the box for Lambda (AWS) integration:
 
 1. `application/json`
 2. `application/x-www-form-urlencoded`
@@ -950,6 +950,41 @@ Both templates give you access to the following properties you can access with t
 - stageVariables
 - requestPath
 
+You can control these defaults:
+
+- Disable all default templates:
+  set `request.disableDefaultTemplates: true` to prevent Serverless from adding any default request mapping templates.
+- Exclude specific default content types:
+  set `request.excludeDefaultContentTypes` to a list of content types to remove from the defaults. For example, to remove `application/x-www-form-urlencoded` while keeping `application/json`.
+
+Examples:
+
+```yml
+functions:
+  onlyJson:
+    handler: posts.create
+    events:
+      - http:
+          method: post
+          path: posts/create
+          integration: lambda
+          request:
+            excludeDefaultContentTypes:
+              - application/x-www-form-urlencoded
+
+  noDefaultsCustomOnly:
+    handler: posts.create
+    events:
+      - http:
+          method: post
+          path: posts/create
+          integration: lambda
+          request:
+            disableDefaultTemplates: true
+            template:
+              application/json: '{ "httpMethod" : "$context.httpMethod" }'
+```
+
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
@@ -1027,6 +1062,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates
 
 - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
 - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)
+- When you disable all default templates and do not define any custom templates for AWS (Lambda) integration, the default passThrough behavior (NEVER) will cause API Gateway to reject requests with 415 unless you explicitly change `request.passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH`.
 
 ### Responses
 
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..6370cbb4f 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -201,10 +201,24 @@ module.exports = {
 
     // Only set defaults for AWS (lambda) integration
     if (useDefaults) {
-      Object.assign(integrationRequestTemplates, {
+      let defaultTemplates = {
         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
-      });
+      };
+
+      // Allow disabling all default templates
+      if (http.request && http.request.disableDefaultTemplates) {
+        defaultTemplates = {};
+      } else if (
+        http.request &&
+        Array.isArray(http.request.excludeDefaultContentTypes)
+      ) {
+        http.request.excludeDefaultContentTypes.forEach(type => {
+          delete defaultTemplates[type];
+        });
+      }
+
+      Object.assign(integrationRequestTemplates, defaultTemplates);
     }
 
     // set custom request templates if provided
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..c00fa243b 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,38 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      if (
+        typeof http.request.disableDefaultTemplates !== 'undefined' &&
+        typeof http.request.disableDefaultTemplates !== 'boolean'
+      ) {
+        const errorMessage = [
+          'disableDefaultTemplates must be provided as a boolean.',
+          ' Please check the docs for more info.',
+        ].join('');
+        throw new this.serverless.classes.Error(errorMessage);
+      }
+      if (
+        typeof http.request.excludeDefaultContentTypes !== 'undefined' &&
+        !Array.isArray(http.request.excludeDefaultContentTypes)
+      ) {
+        const errorMessage = [
+          'excludeDefaultContentTypes must be provided as an array of strings.',
+          ' Please check the docs for more info.',
+        ].join('');
+        throw new this.serverless.classes.Error(errorMessage);
+      }
+      if (Array.isArray(http.request.excludeDefaultContentTypes)) {
+        const invalid = http.request.excludeDefaultContentTypes.some(
+          t => typeof t !== 'string'
+        );
+        if (invalid) {
+          const errorMessage = [
+            'excludeDefaultContentTypes must be provided as an array of strings.',
+            ' Please check the docs for more info.',
+          ].join('');
+          throw new this.serverless.classes.Error(errorMessage);
+        }
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:15:53,470 - thread-135845287823040.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 20:15:53,499 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 20:15:53,501 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 20:15:53,504 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n' additional_kwargs={} response_metadata={}
2025-11-13 20:16:46,229 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content="Below is a high-level analysis and implementation plan to address the feature request: “Allow for the removal of default request mapping templates.”\n\n1) Feature Understanding\n\n- Desired functionality: Enable users to prevent creation of default request mapping templates added by Serverless for AWS API Gateway “AWS” (Lambda) integration, specifically allowing removal of the application/x-www-form-urlencoded default while optionally retaining application/json. This ensures the API does not advertise unsupported content types (e.g., in Swagger “consumes”) and aligns with applications that accept only JSON.\n\n- Current behavior: For “AWS” integration types, Serverless always adds two default request templates: application/json and application/x-www-form-urlencoded. Even when custom templates are provided via http.request.template, defaults are still merged in (see getIntegrationRequestTemplates), so form-url-encoded is always present unless you switch integration type.\n\n- Requirements:\n  - Allow users to configure which (if any) default content-type request templates are automatically added for a method.\n  - Provide a way to disable all defaults or include only specific ones, without forcing users to completely re-define JSON templates if they still want them.\n  - Maintain backward compatibility: if no new configuration is provided, the current default behavior should persist.\n\n- Ambiguities/Edge cases:\n  - Integration types other than “AWS” (e.g., AWS_PROXY, HTTP, MOCK) do not use defaults today. The new setting should be ignored for those or behave consistently without breaking existing behavior.\n  - If defaults are disabled and the user provides no custom templates, what happens? With “AWS” integration, passThrough defaults to NEVER, so requests without matching templates will be rejected with 415. This is likely acceptable, but should be documented.\n  - Validation: Accept only known default content types for filtering (application/json and application/x-www-form-urlencoded) and fail early on invalid values.\n\n2) Architecture Analysis\n\n- Integration points:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n    - getIntegrationRequestTemplates(http, useDefaults): This is where default templates are added and custom templates are merged.\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n    - getRequest(http): Validates the shape of http.request. Extend it to validate any new configuration for default templates.\n    - getRequestPassThrough(http): Consider documenting its interplay; logic likely can remain unchanged.\n\n- Documentation:\n  - docs/providers/aws/events/apigateway.md\n    - Update sections around “Default Request Templates”, “Custom Request Templates”, and “Pass Through Behavior” to document the new configuration that controls default template creation and examples.\n\n- Optional schema hooks:\n  - lib/configSchema.js and lib/plugins/aws/package/compile/events/apiGateway/index.js\n    - The function event schema is currently minimal and noted as a TODO. While the core validation resides in validate.js, optionally extend the schema to reflect the new config keys for better tooling/validation.\n\n3) Implementation Plan\n\nChange 1: Add configurable control over default request templates at the function event level\n\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function(s): getIntegrationRequestTemplates(http, useDefaults)\n- What to implement:\n  - Introduce a new property in the http event request config to control defaults:\n    - http.request.defaultContentTypes: array of strings defining which default templates to include. Valid values: 'application/json', 'application/x-www-form-urlencoded'.\n    - If http.request.defaultContentTypes is not provided, retain current behavior (include both defaults for “AWS” integration).\n    - If provided as an empty array, do not include any defaults.\n    - If provided as ['application/json'], include only the JSON default; omit form-url-encoded.\n  - Logic outline:\n    - Determine whether to apply defaults based on useDefaults and http.request.defaultContentTypes:\n      - If type is “AWS” (useDefaults === true):\n        - If http.request.defaultContentTypes is undefined: include both defaults (backward compatibility).\n        - If http.request.defaultContentTypes is an array: include only those specified defaults.\n      - Then merge any custom templates from http.request.template on top of the chosen defaults.\n    - Return undefined if, after this process, no templates are present, preserving current semantics.\n- Why:\n  - This gives fine-grained control to remove form-url-encoded while keeping the JSON default (common case for JSON-only APIs).\n\nChange 2: Validate and normalize the new configuration\n\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n- Function(s):\n  - getRequest(http)\n- What to implement:\n  - Extend validation to handle http.request.defaultContentTypes:\n    - Ensure http.request.defaultContentTypes is an array when present.\n    - Each entry must be a string and one of the allowed default content types.\n    - Throw a descriptive error on invalid values or invalid types.\n  - Optionally add a small helper to normalize the array (remove duplicates).\n- Why:\n  - Prevents misconfiguration and enforces supported values.\n\nChange 3: Documentation updates\n\n- File: docs/providers/aws/events/apigateway.md\n- Sections to modify:\n  - “Default Request Templates” and “Custom Request Templates”\n  - “Pass Through Behavior” notes\n- What to implement:\n  - Document the new request.defaultContentTypes property with examples:\n    - Example keeping only JSON default:\n      - http.request.defaultContentTypes: [ 'application/json' ]\n    - Example disabling all defaults (user must provide their own http.request.template if they want any request mapping):\n      - http.request.defaultContentTypes: []\n    - Example combining with custom templates:\n      - Keep JSON default and add a custom text/xml template via http.request.template.\n  - Clarify interplay with passThrough:\n    - For “AWS” integration, if request.defaultContentTypes is [] and no custom templates provided, passThrough defaults to NEVER, so API Gateway rejects requests with 415.\n    - If users want to accept other content types without transformation, they must set an appropriate passThrough behavior and provide templates accordingly.\n  - Note that defaults are applied only for “AWS” integration; other integrations are unaffected.\n  - Explain that removing application/x-www-form-urlencoded from defaults will also prevent API Gateway Swagger export from advertising it in “consumes”, addressing the reported issue.\n\nOptional Change 4: Provider-level defaults (global setting)\n\n- Files:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - docs/providers/aws/events/apigateway.md\n- What to implement (optional):\n  - Allow setting provider.apiGateway.defaultContentTypes at the provider level to set a global default for all http events.\n  - Event-level http.request.defaultContentTypes should override the provider-level setting when present.\n  - In getIntegrationRequestTemplates, read this.serverless.service.provider.apiGateway.defaultContentTypes if the event-level setting is absent.\n- Why:\n  - Provides convenience for services that consistently want to exclude form-url-encoded across all endpoints.\n\nOptional Change 5: Schema declarations (if desired)\n\n- Files:\n  - lib/plugins/aws/package/compile/events/apiGateway/index.js\n  - lib/configSchema.js (or wherever provider schema is extended for AWS)\n- What to implement:\n  - Enhance the schema for the http event to include request.defaultContentTypes (array of strings).\n  - Enhance provider schema to include apiGateway.defaultContentTypes (array of strings).\n- Why:\n  - Improves early validation and IDE/tooling support. Not strictly required due to existing custom validation in validate.js.\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Default behavior remains unchanged for users who do not set the new configuration.\n  - For “AWS” integration, users can now tailor the default request template set; removing form-url-encoded will eliminate unwanted content types from API Gateway configuration and Swagger “consumes”.\n  - No change for “AWS_PROXY”, “HTTP”, “MOCK” integrations (defaults were not added anyway).\n\n- Backward compatibility:\n  - Fully preserved: if http.request.defaultContentTypes is not specified, current defaults continue to be added.\n  - The new property is opt-in and does not affect existing configurations.\n\n- Dependencies/Prerequisites:\n  - None external. This is contained within the Serverless AWS API Gateway packaging plugin.\n  - Ensure any unit tests around getIntegrationRequestTemplates are updated to cover new behavior.\n  - Confirm Swagger generation behavior through API Gateway export aligns with removal of the form-url-encoded template, as expected.\n\nThis change provides a simple, explicit way to remove the default application/x-www-form-urlencoded mapping template while keeping application/json, meeting the original request without disrupting existing users." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5003, 'prompt_tokens': 9771, 'total_tokens': 14774, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3200, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--030047bf-6137-4ff3-8abd-4157e40bed2d-0' usage_metadata={'input_tokens': 9771, 'output_tokens': 5003, 'total_tokens': 14774, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3200}}
2025-11-13 20:16:46,233 - thread-135845287823040.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nBelow is a high-level analysis and implementation plan to address the feature request: “Allow for the removal of default request mapping templates.”\n\n1) Feature Understanding\n\n- Desired functionality: Enable users to prevent creation of default request mapping templates added by Serverless for AWS API Gateway “AWS” (Lambda) integration, specifically allowing removal of the application/x-www-form-urlencoded default while optionally retaining application/json. This ensures the API does not advertise unsupported content types (e.g., in Swagger “consumes”) and aligns with applications that accept only JSON.\n\n- Current behavior: For “AWS” integration types, Serverless always adds two default request templates: application/json and application/x-www-form-urlencoded. Even when custom templates are provided via http.request.template, defaults are still merged in (see getIntegrationRequestTemplates), so form-url-encoded is always present unless you switch integration type.\n\n- Requirements:\n  - Allow users to configure which (if any) default content-type request templates are automatically added for a method.\n  - Provide a way to disable all defaults or include only specific ones, without forcing users to completely re-define JSON templates if they still want them.\n  - Maintain backward compatibility: if no new configuration is provided, the current default behavior should persist.\n\n- Ambiguities/Edge cases:\n  - Integration types other than “AWS” (e.g., AWS_PROXY, HTTP, MOCK) do not use defaults today. The new setting should be ignored for those or behave consistently without breaking existing behavior.\n  - If defaults are disabled and the user provides no custom templates, what happens? With “AWS” integration, passThrough defaults to NEVER, so requests without matching templates will be rejected with 415. This is likely acceptable, but should be documented.\n  - Validation: Accept only known default content types for filtering (application/json and application/x-www-form-urlencoded) and fail early on invalid values.\n\n2) Architecture Analysis\n\n- Integration points:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n    - getIntegrationRequestTemplates(http, useDefaults): This is where default templates are added and custom templates are merged.\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n    - getRequest(http): Validates the shape of http.request. Extend it to validate any new configuration for default templates.\n    - getRequestPassThrough(http): Consider documenting its interplay; logic likely can remain unchanged.\n\n- Documentation:\n  - docs/providers/aws/events/apigateway.md\n    - Update sections around “Default Request Templates”, “Custom Request Templates”, and “Pass Through Behavior” to document the new configuration that controls default template creation and examples.\n\n- Optional schema hooks:\n  - lib/configSchema.js and lib/plugins/aws/package/compile/events/apiGateway/index.js\n    - The function event schema is currently minimal and noted as a TODO. While the core validation resides in validate.js, optionally extend the schema to reflect the new config keys for better tooling/validation.\n\n3) Implementation Plan\n\nChange 1: Add configurable control over default request templates at the function event level\n\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function(s): getIntegrationRequestTemplates(http, useDefaults)\n- What to implement:\n  - Introduce a new property in the http event request config to control defaults:\n    - http.request.defaultContentTypes: array of strings defining which default templates to include. Valid values: \'application/json\', \'application/x-www-form-urlencoded\'.\n    - If http.request.defaultContentTypes is not provided, retain current behavior (include both defaults for “AWS” integration).\n    - If provided as an empty array, do not include any defaults.\n    - If provided as [\'application/json\'], include only the JSON default; omit form-url-encoded.\n  - Logic outline:\n    - Determine whether to apply defaults based on useDefaults and http.request.defaultContentTypes:\n      - If type is “AWS” (useDefaults === true):\n        - If http.request.defaultContentTypes is undefined: include both defaults (backward compatibility).\n        - If http.request.defaultContentTypes is an array: include only those specified defaults.\n      - Then merge any custom templates from http.request.template on top of the chosen defaults.\n    - Return undefined if, after this process, no templates are present, preserving current semantics.\n- Why:\n  - This gives fine-grained control to remove form-url-encoded while keeping the JSON default (common case for JSON-only APIs).\n\nChange 2: Validate and normalize the new configuration\n\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n- Function(s):\n  - getRequest(http)\n- What to implement:\n  - Extend validation to handle http.request.defaultContentTypes:\n    - Ensure http.request.defaultContentTypes is an array when present.\n    - Each entry must be a string and one of the allowed default content types.\n    - Throw a descriptive error on invalid values or invalid types.\n  - Optionally add a small helper to normalize the array (remove duplicates).\n- Why:\n  - Prevents misconfiguration and enforces supported values.\n\nChange 3: Documentation updates\n\n- File: docs/providers/aws/events/apigateway.md\n- Sections to modify:\n  - “Default Request Templates” and “Custom Request Templates”\n  - “Pass Through Behavior” notes\n- What to implement:\n  - Document the new request.defaultContentTypes property with examples:\n    - Example keeping only JSON default:\n      - http.request.defaultContentTypes: [ \'application/json\' ]\n    - Example disabling all defaults (user must provide their own http.request.template if they want any request mapping):\n      - http.request.defaultContentTypes: []\n    - Example combining with custom templates:\n      - Keep JSON default and add a custom text/xml template via http.request.template.\n  - Clarify interplay with passThrough:\n    - For “AWS” integration, if request.defaultContentTypes is [] and no custom templates provided, passThrough defaults to NEVER, so API Gateway rejects requests with 415.\n    - If users want to accept other content types without transformation, they must set an appropriate passThrough behavior and provide templates accordingly.\n  - Note that defaults are applied only for “AWS” integration; other integrations are unaffected.\n  - Explain that removing application/x-www-form-urlencoded from defaults will also prevent API Gateway Swagger export from advertising it in “consumes”, addressing the reported issue.\n\nOptional Change 4: Provider-level defaults (global setting)\n\n- Files:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - docs/providers/aws/events/apigateway.md\n- What to implement (optional):\n  - Allow setting provider.apiGateway.defaultContentTypes at the provider level to set a global default for all http events.\n  - Event-level http.request.defaultContentTypes should override the provider-level setting when present.\n  - In getIntegrationRequestTemplates, read this.serverless.service.provider.apiGateway.defaultContentTypes if the event-level setting is absent.\n- Why:\n  - Provides convenience for services that consistently want to exclude form-url-encoded across all endpoints.\n\nOptional Change 5: Schema declarations (if desired)\n\n- Files:\n  - lib/plugins/aws/package/compile/events/apiGateway/index.js\n  - lib/configSchema.js (or wherever provider schema is extended for AWS)\n- What to implement:\n  - Enhance the schema for the http event to include request.defaultContentTypes (array of strings).\n  - Enhance provider schema to include apiGateway.defaultContentTypes (array of strings).\n- Why:\n  - Improves early validation and IDE/tooling support. Not strictly required due to existing custom validation in validate.js.\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Default behavior remains unchanged for users who do not set the new configuration.\n  - For “AWS” integration, users can now tailor the default request template set; removing form-url-encoded will eliminate unwanted content types from API Gateway configuration and Swagger “consumes”.\n  - No change for “AWS_PROXY”, “HTTP”, “MOCK” integrations (defaults were not added anyway).\n\n- Backward compatibility:\n  - Fully preserved: if http.request.defaultContentTypes is not specified, current defaults continue to be added.\n  - The new property is opt-in and does not affect existing configurations.\n\n- Dependencies/Prerequisites:\n  - None external. This is contained within the Serverless AWS API Gateway packaging plugin.\n  - Ensure any unit tests around getIntegrationRequestTemplates are updated to cover new behavior.\n  - Confirm Swagger generation behavior through API Gateway export aligns with removal of the form-url-encoded template, as expected.\n\nThis change provides a simple, explicit way to remove the default application/x-www-form-urlencoded mapping template while keeping application/json, meeting the original request without disrupting existing users.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 20:16:50,028 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_uJUH8crLBP6NPMIXxtGrompq', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 295, 'prompt_tokens': 11968, 'total_tokens': 12263, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4040ccaf-da2f-4123-9ae7-ac0b9557b4e2-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_uJUH8crLBP6NPMIXxtGrompq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11968, 'output_tokens': 295, 'total_tokens': 12263, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:16:54,063 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3eUZaUrdS0L65x3I0j7zRx48', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 293, 'prompt_tokens': 14337, 'total_tokens': 14630, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f2338e35-347b-4f7d-bb3f-43e0d667eba9-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js'}, 'id': 'call_3eUZaUrdS0L65x3I0j7zRx48', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14337, 'output_tokens': 293, 'total_tokens': 14630, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:16:55,629 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_oc5iacjdYJFFiP17AEc47HtD', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 19201, 'total_tokens': 19227, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 11904}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f6e5dfaa-ba02-4a1a-89be-ddbcdcd2da87-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_oc5iacjdYJFFiP17AEc47HtD', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19201, 'output_tokens': 26, 'total_tokens': 19227, 'input_token_details': {'audio': 0, 'cache_read': 11904}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:17:03,684 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_zMfeYyD6EuZp216bxScM95RO', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":491,"end_line":620}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 754, 'prompt_tokens': 24597, 'total_tokens': 25351, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 704, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c8fa5fa9-a4e1-4ab5-9c8f-c3cc259d2260-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 491, 'end_line': 620}, 'id': 'call_zMfeYyD6EuZp216bxScM95RO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24597, 'output_tokens': 754, 'total_tokens': 25351, 'input_token_details': {'audio': 0, 'cache_read': 19200}, 'output_token_details': {'audio': 0, 'reasoning': 704}}
2025-11-13 20:17:13,950 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NylWnH9Gv7FrboAOTBt1RBSF', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":975}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1005, 'prompt_tokens': 25653, 'total_tokens': 26658, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24576}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--304ddd66-923d-4921-a779-941dff7ff626-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 975}, 'id': 'call_NylWnH9Gv7FrboAOTBt1RBSF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 25653, 'output_tokens': 1005, 'total_tokens': 26658, 'input_token_details': {'audio': 0, 'cache_read': 24576}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 20:17:46,659 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_P7mx1Euz7esEdpZnY0zw6gR2', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","old_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      Object.assign(integrationRequestTemplates, {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      });\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },","new_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      const defaultsConfig =\\n        http.request && Array.isArray(http.request.defaultContentTypes)\\n          ? http.request.defaultContentTypes\\n          : null;\\n      if (defaultsConfig === null) {\\n        Object.assign(integrationRequestTemplates, {\\n          \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n          \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n        });\\n      } else {\\n        if (defaultsConfig.includes(\'application/json\')) {\\n          integrationRequestTemplates[\'application/json\'] = this.DEFAULT_JSON_REQUEST_TEMPLATE;\\n        }\\n        if (defaultsConfig.includes(\'application/x-www-form-urlencoded\')) {\\n          integrationRequestTemplates[\'application/x-www-form-urlencoded\'] =\\n            this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE;\\n        }\\n      }\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3509, 'prompt_tokens': 26051, 'total_tokens': 29560, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3008, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f1aad85e-8c73-4c3e-bfa7-a293fa89b578-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'old_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      Object.assign(integrationRequestTemplates, {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      });\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },", 'new_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      const defaultsConfig =\n        http.request && Array.isArray(http.request.defaultContentTypes)\n          ? http.request.defaultContentTypes\n          : null;\n      if (defaultsConfig === null) {\n        Object.assign(integrationRequestTemplates, {\n          'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n          'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n        });\n      } else {\n        if (defaultsConfig.includes('application/json')) {\n          integrationRequestTemplates['application/json'] = this.DEFAULT_JSON_REQUEST_TEMPLATE;\n        }\n        if (defaultsConfig.includes('application/x-www-form-urlencoded')) {\n          integrationRequestTemplates['application/x-www-form-urlencoded'] =\n            this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE;\n        }\n      }\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },"}, 'id': 'call_P7mx1Euz7esEdpZnY0zw6gR2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26051, 'output_tokens': 3509, 'total_tokens': 29560, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 3008}}
2025-11-13 20:17:48,859 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gJcofxWj3d3VwlSAEPwQkhGg', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","start_line":190,"end_line":220}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 46, 'prompt_tokens': 26574, 'total_tokens': 26620, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14208}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4c1cf02c-5d51-470d-8789-7c775dded707-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'start_line': 190, 'end_line': 220}, 'id': 'call_gJcofxWj3d3VwlSAEPwQkhGg', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26574, 'output_tokens': 46, 'total_tokens': 26620, 'input_token_details': {'audio': 0, 'cache_read': 14208}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:17:51,766 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_iqSqw3d77gvlX3dorvPnGjaR', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","start_line":220,"end_line":262}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 46, 'prompt_tokens': 26907, 'total_tokens': 26953, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f08593ee-8bc6-448b-a7fb-f04270fe6c8a-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'start_line': 220, 'end_line': 262}, 'id': 'call_iqSqw3d77gvlX3dorvPnGjaR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26907, 'output_tokens': 46, 'total_tokens': 26953, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:17:54,511 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Ob92iOodydt8QDWHNONTcUIp', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":491,"end_line":520}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 27350, 'total_tokens': 27394, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c066d8ff-d609-4784-9592-b81e6bc0ec3b-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 491, 'end_line': 520}, 'id': 'call_Ob92iOodydt8QDWHNONTcUIp', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27350, 'output_tokens': 44, 'total_tokens': 27394, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:17:59,341 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_57byjcxUJFUyOFBhV4aITmg5', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","old_content":"      if (typeof http.request !== \'object\') {\\n        const errorMessage = [\\n          \'Request config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n\\n      if (request.parameters) {\\n        request.parameters = this.getRequestParameters(request);\\n      }\\n\\n      return request;","new_content":"      if (typeof http.request !== \'object\') {\\n        const errorMessage = [\\n          \'Request config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (http.request.defaultContentTypes) {\\n        if (!Array.isArray(http.request.defaultContentTypes)) {\\n          const errorMessage = [\\n            \'defaultContentTypes config must be provided as an array of strings.\',\\n            \' Please check the docs for more info.\',\\n          ].join(\'\');\\n          throw new this.serverless.classes.Error(errorMessage);\\n        }\\n        const allowedDefaults = [\\n          \'application/json\',\\n          \'application/x-www-form-urlencoded\',\\n        ];\\n        for (const ct of http.request.defaultContentTypes) {\\n          if (typeof ct !== \'string\' || allowedDefaults.indexOf(ct) === -1) {\\n            const errorMessage = [\\n              \'defaultContentTypes entries must be one of: \',\\n              allowedDefaults.join(\', \'),\\n              \'.\',\\n            ].join(\'\');\\n            throw new this.serverless.classes.Error(errorMessage);\\n          }\\n        }\\n        // remove duplicates if any\\n        http.request.defaultContentTypes = Array.from(new Set(http.request.defaultContentTypes));\\n      }\\n\\n      if (request.parameters) {\\n        request.parameters = this.getRequestParameters(request);\\n      }\\n\\n      return request;"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 611, 'prompt_tokens': 27635, 'total_tokens': 28246, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ee876391-4cec-4296-b705-76b05d9596cf-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'old_content': "      if (typeof http.request !== 'object') {\n        const errorMessage = [\n          'Request config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (http.request.template && typeof http.request.template !== 'object') {\n        const errorMessage = [\n          'Template config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n\n      if (request.parameters) {\n        request.parameters = this.getRequestParameters(request);\n      }\n\n      return request;", 'new_content': "      if (typeof http.request !== 'object') {\n        const errorMessage = [\n          'Request config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (http.request.template && typeof http.request.template !== 'object') {\n        const errorMessage = [\n          'Template config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (http.request.defaultContentTypes) {\n        if (!Array.isArray(http.request.defaultContentTypes)) {\n          const errorMessage = [\n            'defaultContentTypes config must be provided as an array of strings.',\n            ' Please check the docs for more info.',\n          ].join('');\n          throw new this.serverless.classes.Error(errorMessage);\n        }\n        const allowedDefaults = [\n          'application/json',\n          'application/x-www-form-urlencoded',\n        ];\n        for (const ct of http.request.defaultContentTypes) {\n          if (typeof ct !== 'string' || allowedDefaults.indexOf(ct) === -1) {\n            const errorMessage = [\n              'defaultContentTypes entries must be one of: ',\n              allowedDefaults.join(', '),\n              '.',\n            ].join('');\n            throw new this.serverless.classes.Error(errorMessage);\n          }\n        }\n        // remove duplicates if any\n        http.request.defaultContentTypes = Array.from(new Set(http.request.defaultContentTypes));\n      }\n\n      if (request.parameters) {\n        request.parameters = this.getRequestParameters(request);\n      }\n\n      return request;"}, 'id': 'call_57byjcxUJFUyOFBhV4aITmg5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27635, 'output_tokens': 611, 'total_tokens': 28246, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:01,224 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_40lcXOBvVQZ2KR0SsG6LiFCi', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":1015}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 28272, 'total_tokens': 28312, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 28160}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f16413a4-f059-40b8-8ca0-e6544552b752-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 1015}, 'id': 'call_40lcXOBvVQZ2KR0SsG6LiFCi', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28272, 'output_tokens': 40, 'total_tokens': 28312, 'input_token_details': {'audio': 0, 'cache_read': 28160}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:05,861 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_vgpTpa2bts4cSEmCZTqC54Sq', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box:\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n\\n- body\\n- method\\n- principalId\\n- stage\\n- headers\\n- queryStringParameters\\n- path\\n- identity\\n- stageVariables\\n- requestPath","new_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box (for the `lambda`/`AWS` integration):\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nYou can control which of these defaults are applied per endpoint with the `request.defaultContentTypes` setting:\\n\\n- Omit `request.defaultContentTypes` to keep the current defaults (both will be added)\\n- Set `request.defaultContentTypes: [application/json]` to include only the JSON default\\n- Set `request.defaultContentTypes: []` to disable all defaults (you may want to define your own templates via `request.template`)\\n\\nExample:\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: post\\n          path: posts/create\\n          integration: lambda\\n          request:\\n            defaultContentTypes:\\n              - application/json\\n            template:\\n              text/xml: \'{ \\"foo\\": \\"bar\\" }\'\\n```\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n\\n- body\\n- method\\n- principalId\\n- stage\\n- headers\\n- queryStringParameters\\n- path\\n- identity\\n- stageVariables\\n- requestPath"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 426, 'prompt_tokens': 29210, 'total_tokens': 29636, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--af47bda2-0598-4f35-a60b-2c5583f0a79a-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box:\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n\n- body\n- method\n- principalId\n- stage\n- headers\n- queryStringParameters\n- path\n- identity\n- stageVariables\n- requestPath', 'new_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box (for the `lambda`/`AWS` integration):\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nYou can control which of these defaults are applied per endpoint with the `request.defaultContentTypes` setting:\n\n- Omit `request.defaultContentTypes` to keep the current defaults (both will be added)\n- Set `request.defaultContentTypes: [application/json]` to include only the JSON default\n- Set `request.defaultContentTypes: []` to disable all defaults (you may want to define your own templates via `request.template`)\n\nExample:\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: post\n          path: posts/create\n          integration: lambda\n          request:\n            defaultContentTypes:\n              - application/json\n            template:\n              text/xml: \'{ "foo": "bar" }\'\n```\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n\n- body\n- method\n- principalId\n- stage\n- headers\n- queryStringParameters\n- path\n- identity\n- stageVariables\n- requestPath'}, 'id': 'call_vgpTpa2bts4cSEmCZTqC54Sq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29210, 'output_tokens': 426, 'total_tokens': 29636, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:09,163 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_o1xMHMoERbP22cMdsN3V7ajA', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"#### Custom Request Templates\\n\\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```","new_content":"#### Custom Request Templates\\n\\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type). If you prefer not to include any defaults, set `request.defaultContentTypes: []`.\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            defaultContentTypes: []\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 314, 'prompt_tokens': 29657, 'total_tokens': 29971, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 25600}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--52415e79-a24b-4c59-8f89-3b802f8c0b14-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '#### Custom Request Templates\n\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```', 'new_content': '#### Custom Request Templates\n\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type). If you prefer not to include any defaults, set `request.defaultContentTypes: []`.\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            defaultContentTypes: []\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```'}, 'id': 'call_o1xMHMoERbP22cMdsN3V7ajA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29657, 'output_tokens': 314, 'total_tokens': 29971, 'input_token_details': {'audio': 0, 'cache_read': 25600}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:11,994 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7W8acXImeeB778tcYl2UC02Z', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):","new_content":"You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the `lambda`/`AWS` integration). Note: If you disable all default request templates via `request.defaultContentTypes: []` and do not provide any custom templates, requests with unmatched Content-Type will be rejected with `415 - Unsupported Media Type` when passThrough is `NEVER`."}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 141, 'prompt_tokens': 29992, 'total_tokens': 30133, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--882adaa6-1e8c-4382-a569-e8b214722ddf-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': 'You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):', 'new_content': 'You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the `lambda`/`AWS` integration). Note: If you disable all default request templates via `request.defaultContentTypes: []` and do not provide any custom templates, requests with unmatched Content-Type will be rejected with `415 - Unsupported Media Type` when passThrough is `NEVER`.'}, 'id': 'call_7W8acXImeeB778tcYl2UC02Z', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29992, 'output_tokens': 141, 'total_tokens': 30133, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:14,657 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_V2TNJ5SAs79z8VUkh6MyjKAf', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":915,"end_line":1015}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 30154, 'total_tokens': 30194, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e6280903-25ec-4262-bfad-8281fca0ac93-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 915, 'end_line': 1015}, 'id': 'call_V2TNJ5SAs79z8VUkh6MyjKAf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30154, 'output_tokens': 40, 'total_tokens': 30194, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:18,807 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pcgEpvlfPr6dDQV5YtkYnqDF', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":997,"end_line":1034}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 31164, 'total_tokens': 31204, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f1aa7dc5-f892-4703-8a9e-4eabc887601d-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 997, 'end_line': 1034}, 'id': 'call_pcgEpvlfPr6dDQV5YtkYnqDF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31164, 'output_tokens': 40, 'total_tokens': 31204, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:20,534 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_lMz2HWpq8uLNQGvHecWxKsMQ', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":1028,"end_line":1045}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 31839, 'total_tokens': 31880, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30080}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3486bd2d-cc7b-421b-9f85-8db58863c68a-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 1028, 'end_line': 1045}, 'id': 'call_lMz2HWpq8uLNQGvHecWxKsMQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 31839, 'output_tokens': 41, 'total_tokens': 31880, 'input_token_details': {'audio': 0, 'cache_read': 30080}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:24,179 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I updated the code to allow removal of default request mapping templates and documented the new configuration.\n\nSummary of changes:\n- Added support for http.request.defaultContentTypes in AWS (lambda) integration templates:\n  - In getIntegrationRequestTemplates, defaults are now controlled by http.request.defaultContentTypes.\n  - Behavior:\n    - If defaultContentTypes is not set: both application/json and application/x-www-form-urlencoded defaults are included (backwards compatible).\n    - If set to an array: only specified defaults are included. An empty array disables all defaults.\n  - Custom templates in http.request.template are still merged on top of defaults.\n\n- Added validation for the new setting:\n  - In validate.getRequest, defaultContentTypes must be an array of strings and each entry must be one of:\n    - application/json\n    - application/x-www-form-urlencoded\n  - Duplicates are removed during validation.\n\n- Updated documentation in docs/providers/aws/events/apigateway.md:\n  - Enhanced “Default Request Templates” to describe request.defaultContentTypes with examples.\n  - Updated “Custom Request Templates” to show disabling defaults via defaultContentTypes: [].\n  - Clarified “Pass Through Behavior” note about disabling defaults and its interaction with passThrough (for lambda/AWS integration).\n\nYou can now configure endpoints to only include application/json defaults or disable defaults entirely, preventing unwanted content types like application/x-www-form-urlencoded from being advertised or created.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 292, 'prompt_tokens': 32024, 'total_tokens': 32316, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 30080}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--54717465-6f76-4da7-9d76-97d177f2c328-0' usage_metadata={'input_tokens': 32024, 'output_tokens': 292, 'total_tokens': 32316, 'input_token_details': {'audio': 0, 'cache_read': 30080}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:18:24,225 - thread-135845287823040.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..9e6c7c5a4 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -932,11 +932,35 @@ This method is more complicated and involves a lot more configuration of the `ht
 
 #### Default Request Templates
 
-Serverless ships with the following default request templates you can use out of the box:
+Serverless ships with the following default request templates you can use out of the box (for the `lambda`/`AWS` integration):
 
 1. `application/json`
 2. `application/x-www-form-urlencoded`
 
+You can control which of these defaults are applied per endpoint with the `request.defaultContentTypes` setting:
+
+- Omit `request.defaultContentTypes` to keep the current defaults (both will be added)
+- Set `request.defaultContentTypes: [application/json]` to include only the JSON default
+- Set `request.defaultContentTypes: []` to disable all defaults (you may want to define your own templates via `request.template`)
+
+Example:
+
+```yml
+functions:
+  create:
+    handler: posts.create
+    events:
+      - http:
+          method: post
+          path: posts/create
+          integration: lambda
+          request:
+            defaultContentTypes:
+              - application/json
+            template:
+              text/xml: '{ "foo": "bar" }'
+```
+
 Both templates give you access to the following properties you can access with the help of the `event` object:
 
 - body
@@ -953,7 +977,7 @@ Both templates give you access to the following properties you can access with t
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
-by defining a new request template for an existing content type):
+by defining a new request template for an existing content type). If you prefer not to include any defaults, set `request.defaultContentTypes: []`.
 
 ```yml
 functions:
@@ -965,6 +989,7 @@ functions:
           path: whatever
           integration: lambda
           request:
+            defaultContentTypes: []
             template:
               text/xhtml: '{ "stage" : "$context.stage" }'
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
@@ -998,7 +1023,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s
 
 [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.
 
-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):
+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the `lambda`/`AWS` integration). Note: If you disable all default request templates via `request.defaultContentTypes: []` and do not provide any custom templates, requests with unmatched Content-Type will be rejected with `415 - Unsupported Media Type` when passThrough is `NEVER`.
 
 ```yml
 functions:
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..38fd4ea7c 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -201,10 +201,24 @@ module.exports = {
 
     // Only set defaults for AWS (lambda) integration
     if (useDefaults) {
-      Object.assign(integrationRequestTemplates, {
-        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
-        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
-      });
+      const defaultsConfig =
+        http.request && Array.isArray(http.request.defaultContentTypes)
+          ? http.request.defaultContentTypes
+          : null;
+      if (defaultsConfig === null) {
+        Object.assign(integrationRequestTemplates, {
+          'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
+          'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
+        });
+      } else {
+        if (defaultsConfig.includes('application/json')) {
+          integrationRequestTemplates['application/json'] = this.DEFAULT_JSON_REQUEST_TEMPLATE;
+        }
+        if (defaultsConfig.includes('application/x-www-form-urlencoded')) {
+          integrationRequestTemplates['application/x-www-form-urlencoded'] =
+            this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE;
+        }
+      }
     }
 
     // set custom request templates if provided
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..e6008e2ef 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,31 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      if (http.request.defaultContentTypes) {
+        if (!Array.isArray(http.request.defaultContentTypes)) {
+          const errorMessage = [
+            'defaultContentTypes config must be provided as an array of strings.',
+            ' Please check the docs for more info.',
+          ].join('');
+          throw new this.serverless.classes.Error(errorMessage);
+        }
+        const allowedDefaults = [
+          'application/json',
+          'application/x-www-form-urlencoded',
+        ];
+        for (const ct of http.request.defaultContentTypes) {
+          if (typeof ct !== 'string' || allowedDefaults.indexOf(ct) === -1) {
+            const errorMessage = [
+              'defaultContentTypes entries must be one of: ',
+              allowedDefaults.join(', '),
+              '.',
+            ].join('');
+            throw new this.serverless.classes.Error(errorMessage);
+          }
+        }
+        // remove duplicates if any
+        http.request.defaultContentTypes = Array.from(new Set(http.request.defaultContentTypes));
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:18:24,227 - thread-135845287823040.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 20:18:24,255 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 20:18:24,256 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 20:18:24,258 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n' additional_kwargs={} response_metadata={}
2025-11-13 20:19:31,243 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content="Below is a high-level analysis and implementation plan to add the ability to remove default request mapping templates in the Serverless Framework AWS API Gateway integration.\n\n1) Feature Understanding\n\n- Current behavior:\n  - For AWS (lambda) integration (non-proxy), Serverless automatically adds two default request mapping templates: application/json and application/x-www-form-urlencoded.\n  - This is implemented in getIntegrationRequestTemplates in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js.\n  - Because application/x-www-form-urlencoded is always added by default, API Gateway’s generated Swagger/OpenAPI “consumes” list includes both content types, even if the application only supports JSON.\n\n- Desired functionality:\n  - Provide a straightforward way for users to disable/remove one or both default request templates, particularly application/x-www-form-urlencoded.\n  - Ensure the method can advertise only supported content types, and that unwanted content types are not created in API Gateway.\n\n- Requirements and expectations:\n  - Maintain current defaults unless the user explicitly opts out (opt-in change).\n  - Removal should be possible per function/method and ideally configurable at the provider/service level.\n  - Ensure behavior with passThrough and content handling remains coherent. If all templates are removed, passThrough must allow or reject as configured.\n\n- Ambiguities and edge cases:\n  - If a user removes all default templates and does not define any custom templates, how should the method behave? With AWS integration, the default passThrough is typically NEVER, which will reject requests lacking matching templates. We must document this and advise users to set request.passThrough to WHEN_NO_TEMPLATES or WHEN_NO_MATCH if they intentionally define no templates.\n  - Only AWS integration uses default templates. AWS_PROXY (lambda-proxy) and HTTP/MOCK integrations are unaffected by defaults; make sure the new behavior does not inadvertently change those.\n  - Swagger/OpenAPI “consumes” derives from mapping templates in API Gateway; removing a template should remove the corresponding content type from “consumes.”\n\n\n2) Architecture Analysis\n\n- Integration points:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js:\n    - getIntegrationRequestTemplates(http, useDefaults): currently unconditionally adds defaults when useDefaults is true (AWS integration). This is the key place to enable skipping/removal of defaults.\n    - DEFAULT_JSON_REQUEST_TEMPLATE and DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: constants for default templates.\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js:\n    - getRequest(http): validates the shape of http.request and http.request.template. Add validation for any new config to disable defaults and ensure no non-string values leak into CloudFormation.\n    - getRequestPassThrough(http): controls pass-through defaults. Ensure documentation explicitly explains the interaction when templates are disabled.\n  - lib/plugins/aws/package/compile/events/apiGateway/index.js:\n    - This wires the method compilation. No direct change needed unless reading a new provider-level config.\n\n- Documentation integration:\n  - docs/providers/aws/events/apigateway.md:\n    - Sections on Default Request Templates and Custom Request Templates should be extended to show how to disable default templates, and note passThrough behavior if no templates are defined.\n\n\n3) Implementation Plan\n\nChange 1: Allow per-method disabling of default templates via http.request.template\n\n- File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function to change: getIntegrationRequestTemplates(http, useDefaults)\n- Logical changes:\n  - Keep the existing behavior of adding defaults when useDefaults is true.\n  - When http.request.template is present:\n    - Merge custom templates as today.\n    - Introduce a sentinel value to signal removal of defaults for specific content types. For example, if a user sets http.request.template['application/x-www-form-urlencoded'] = false, remove this key from the integrationRequestTemplates map instead of adding/overwriting it.\n    - Ensure only string-valued templates remain in integrationRequestTemplates before returning. Filter out keys where the value is not a string (i.e., if it is false or null), so CloudFormation does not receive invalid types.\n- Rationale:\n  - This makes removal semantics consistent with the existing place users configure templates.\n  - It’s minimally invasive and backward compatible: defaults remain unless the user explicitly sets the content type to false.\n\nChange 2: (Optional, recommended) Allow provider-level configuration to control default templates globally\n\n- File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function to change: getIntegrationRequestTemplates(http, useDefaults)\n- Logical changes:\n  - Before constructing defaults, check for provider-level defaults at serverless.service.provider.apiGateway.defaultRequestTemplates.\n  - If present:\n    - Initialize defaults from this object instead of the hardcoded two templates.\n    - Support boolean false values to disable a default content type globally (e.g., 'application/x-www-form-urlencoded': false).\n  - Otherwise, fall back to hardcoded defaults.\n- Rationale:\n  - Many users want to enforce a single content type across the entire service. A provider-level option reduces duplication.\n  - Still allow per-method overrides using http.request.template.\n\nChange 3: Validate and sanitize request.template values\n\n- File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n- Function to change: getRequest(http)\n- Logical changes:\n  - When http.request.template exists, ensure it is an object (already done).\n  - Add a sanitize/validation step to ensure that any non-string template values are either allowed as “disable” sentinel (boolean false) or rejected. Prefer allowing false and document it.\n  - No need to throw errors for false values; the integration builder will remove those keys before emitting CloudFormation. However, log or surface a helpful error if values are neither strings nor false, to prevent accidental invalid config.\n- Rationale:\n  - Prevent invalid CloudFormation templates and provide a clear contract for disabling defaults.\n\nChange 4: Update docs to describe disabling default templates and passThrough implications\n\n- File to modify: docs/providers/aws/events/apigateway.md\n- Sections to update:\n  - “Default Request Templates”: explicitly say defaults exist only for AWS integration and list both content types as today.\n  - “Custom Request Templates”: add a note and example showing how to disable a default content type by setting it to false under request.template, e.g.:\n    - request:\n      template:\n        application/json: '{ ... }'\n        application/x-www-form-urlencoded: false\n  - “Pass Through Behavior”: add a note explaining that if you remove all templates, you must set passThrough to WHEN_NO_TEMPLATES or WHEN_NO_MATCH if you want API Gateway to pass the payload through without transformation, otherwise it will reject with 415.\n- Rationale:\n  - Users need clear guidance on how to disable defaults and how passThrough interacts with missing templates.\n\n\n4) Considerations\n\n- Impacts on existing functionality:\n  - Default behavior remains unchanged. Only users who explicitly set a content type template to false or configure provider-level defaults will see a change.\n  - Methods that rely on form-urlencoded defaults will continue to function unless users disable them.\n  - Swagger/OpenAPI “consumes” will reflect only the content types for which templates exist. Removing form-urlencoded will stop advertising it.\n\n- Backward compatibility:\n  - Fully backward compatible by design; no change unless users opt in.\n  - Ensure the plugin never outputs non-string values to CloudFormation. Filter out disabled keys before returning the RequestTemplates object.\n\n- Dependencies and prerequisites:\n  - No external dependencies. Changes are localized to API Gateway method integration and validation logic.\n  - If provider-level config is introduced (apiGateway.defaultRequestTemplates), consider extending the provider schema if one exists for apiGateway block. If deep schema validation isn’t currently defined, internal validation in validate.js is sufficient.\n  - Add unit tests for getIntegrationRequestTemplates covering:\n    - Default behavior (both templates present).\n    - Per-method removal via request.template['application/x-www-form-urlencoded'] = false.\n    - Provider-level default removal (if implemented).\n    - Behavior when removing all defaults and passThrough unset/set.\n\n- Workarounds until feature is available:\n  - Use AWS_PROXY (lambda-proxy) integration, which doesn’t create default mapping templates and therefore won’t advertise form-urlencoded. This changes the event shape, so it may require handler adjustments.\n  - As a less ideal workaround, keep AWS integration and set request.passThrough to NEVER and ignore form-urlencoded in your handler; Swagger “consumes” will still include form-urlencoded until defaults can be disabled.\n\nThis plan provides a clear, opt-in mechanism to remove unwanted default request mapping templates, honors existing architectural patterns, and documents critical behaviors (especially passThrough) to avoid unintended rejections." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 7000, 'prompt_tokens': 9771, 'total_tokens': 16771, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 5184, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--d93b29e7-192c-4b4e-b04f-b7f91902dc5c-0' usage_metadata={'input_tokens': 9771, 'output_tokens': 7000, 'total_tokens': 16771, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 5184}}
2025-11-13 20:19:31,249 - thread-135845287823040.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nBelow is a high-level analysis and implementation plan to add the ability to remove default request mapping templates in the Serverless Framework AWS API Gateway integration.\n\n1) Feature Understanding\n\n- Current behavior:\n  - For AWS (lambda) integration (non-proxy), Serverless automatically adds two default request mapping templates: application/json and application/x-www-form-urlencoded.\n  - This is implemented in getIntegrationRequestTemplates in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js.\n  - Because application/x-www-form-urlencoded is always added by default, API Gateway’s generated Swagger/OpenAPI “consumes” list includes both content types, even if the application only supports JSON.\n\n- Desired functionality:\n  - Provide a straightforward way for users to disable/remove one or both default request templates, particularly application/x-www-form-urlencoded.\n  - Ensure the method can advertise only supported content types, and that unwanted content types are not created in API Gateway.\n\n- Requirements and expectations:\n  - Maintain current defaults unless the user explicitly opts out (opt-in change).\n  - Removal should be possible per function/method and ideally configurable at the provider/service level.\n  - Ensure behavior with passThrough and content handling remains coherent. If all templates are removed, passThrough must allow or reject as configured.\n\n- Ambiguities and edge cases:\n  - If a user removes all default templates and does not define any custom templates, how should the method behave? With AWS integration, the default passThrough is typically NEVER, which will reject requests lacking matching templates. We must document this and advise users to set request.passThrough to WHEN_NO_TEMPLATES or WHEN_NO_MATCH if they intentionally define no templates.\n  - Only AWS integration uses default templates. AWS_PROXY (lambda-proxy) and HTTP/MOCK integrations are unaffected by defaults; make sure the new behavior does not inadvertently change those.\n  - Swagger/OpenAPI “consumes” derives from mapping templates in API Gateway; removing a template should remove the corresponding content type from “consumes.”\n\n\n2) Architecture Analysis\n\n- Integration points:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js:\n    - getIntegrationRequestTemplates(http, useDefaults): currently unconditionally adds defaults when useDefaults is true (AWS integration). This is the key place to enable skipping/removal of defaults.\n    - DEFAULT_JSON_REQUEST_TEMPLATE and DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: constants for default templates.\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js:\n    - getRequest(http): validates the shape of http.request and http.request.template. Add validation for any new config to disable defaults and ensure no non-string values leak into CloudFormation.\n    - getRequestPassThrough(http): controls pass-through defaults. Ensure documentation explicitly explains the interaction when templates are disabled.\n  - lib/plugins/aws/package/compile/events/apiGateway/index.js:\n    - This wires the method compilation. No direct change needed unless reading a new provider-level config.\n\n- Documentation integration:\n  - docs/providers/aws/events/apigateway.md:\n    - Sections on Default Request Templates and Custom Request Templates should be extended to show how to disable default templates, and note passThrough behavior if no templates are defined.\n\n\n3) Implementation Plan\n\nChange 1: Allow per-method disabling of default templates via http.request.template\n\n- File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function to change: getIntegrationRequestTemplates(http, useDefaults)\n- Logical changes:\n  - Keep the existing behavior of adding defaults when useDefaults is true.\n  - When http.request.template is present:\n    - Merge custom templates as today.\n    - Introduce a sentinel value to signal removal of defaults for specific content types. For example, if a user sets http.request.template[\'application/x-www-form-urlencoded\'] = false, remove this key from the integrationRequestTemplates map instead of adding/overwriting it.\n    - Ensure only string-valued templates remain in integrationRequestTemplates before returning. Filter out keys where the value is not a string (i.e., if it is false or null), so CloudFormation does not receive invalid types.\n- Rationale:\n  - This makes removal semantics consistent with the existing place users configure templates.\n  - It’s minimally invasive and backward compatible: defaults remain unless the user explicitly sets the content type to false.\n\nChange 2: (Optional, recommended) Allow provider-level configuration to control default templates globally\n\n- File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function to change: getIntegrationRequestTemplates(http, useDefaults)\n- Logical changes:\n  - Before constructing defaults, check for provider-level defaults at serverless.service.provider.apiGateway.defaultRequestTemplates.\n  - If present:\n    - Initialize defaults from this object instead of the hardcoded two templates.\n    - Support boolean false values to disable a default content type globally (e.g., \'application/x-www-form-urlencoded\': false).\n  - Otherwise, fall back to hardcoded defaults.\n- Rationale:\n  - Many users want to enforce a single content type across the entire service. A provider-level option reduces duplication.\n  - Still allow per-method overrides using http.request.template.\n\nChange 3: Validate and sanitize request.template values\n\n- File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n- Function to change: getRequest(http)\n- Logical changes:\n  - When http.request.template exists, ensure it is an object (already done).\n  - Add a sanitize/validation step to ensure that any non-string template values are either allowed as “disable” sentinel (boolean false) or rejected. Prefer allowing false and document it.\n  - No need to throw errors for false values; the integration builder will remove those keys before emitting CloudFormation. However, log or surface a helpful error if values are neither strings nor false, to prevent accidental invalid config.\n- Rationale:\n  - Prevent invalid CloudFormation templates and provide a clear contract for disabling defaults.\n\nChange 4: Update docs to describe disabling default templates and passThrough implications\n\n- File to modify: docs/providers/aws/events/apigateway.md\n- Sections to update:\n  - “Default Request Templates”: explicitly say defaults exist only for AWS integration and list both content types as today.\n  - “Custom Request Templates”: add a note and example showing how to disable a default content type by setting it to false under request.template, e.g.:\n    - request:\n      template:\n        application/json: \'{ ... }\'\n        application/x-www-form-urlencoded: false\n  - “Pass Through Behavior”: add a note explaining that if you remove all templates, you must set passThrough to WHEN_NO_TEMPLATES or WHEN_NO_MATCH if you want API Gateway to pass the payload through without transformation, otherwise it will reject with 415.\n- Rationale:\n  - Users need clear guidance on how to disable defaults and how passThrough interacts with missing templates.\n\n\n4) Considerations\n\n- Impacts on existing functionality:\n  - Default behavior remains unchanged. Only users who explicitly set a content type template to false or configure provider-level defaults will see a change.\n  - Methods that rely on form-urlencoded defaults will continue to function unless users disable them.\n  - Swagger/OpenAPI “consumes” will reflect only the content types for which templates exist. Removing form-urlencoded will stop advertising it.\n\n- Backward compatibility:\n  - Fully backward compatible by design; no change unless users opt in.\n  - Ensure the plugin never outputs non-string values to CloudFormation. Filter out disabled keys before returning the RequestTemplates object.\n\n- Dependencies and prerequisites:\n  - No external dependencies. Changes are localized to API Gateway method integration and validation logic.\n  - If provider-level config is introduced (apiGateway.defaultRequestTemplates), consider extending the provider schema if one exists for apiGateway block. If deep schema validation isn’t currently defined, internal validation in validate.js is sufficient.\n  - Add unit tests for getIntegrationRequestTemplates covering:\n    - Default behavior (both templates present).\n    - Per-method removal via request.template[\'application/x-www-form-urlencoded\'] = false.\n    - Provider-level default removal (if implemented).\n    - Behavior when removing all defaults and passThrough unset/set.\n\n- Workarounds until feature is available:\n  - Use AWS_PROXY (lambda-proxy) integration, which doesn’t create default mapping templates and therefore won’t advertise form-urlencoded. This changes the event shape, so it may require handler adjustments.\n  - As a less ideal workaround, keep AWS integration and set request.passThrough to NEVER and ignore form-urlencoded in your handler; Swagger “consumes” will still include form-urlencoded until defaults can be disabled.\n\nThis plan provides a clear, opt-in mechanism to remove unwanted default request mapping templates, honors existing architectural patterns, and documents critical behaviors (especially passThrough) to avoid unintended rejections.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 20:19:47,564 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ld3az8wLSjHrj4Mmd712tbBK', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1511, 'prompt_tokens': 11982, 'total_tokens': 13493, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1ce9acf1-167e-4b74-9a3e-9a17b2836ef2-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_ld3az8wLSjHrj4Mmd712tbBK', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11982, 'output_tokens': 1511, 'total_tokens': 13493, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-13 20:20:10,568 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_p8veUq01DGKwFFWwCxnpB5Zw', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2213, 'prompt_tokens': 14351, 'total_tokens': 16564, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2176, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b98234cf-16cd-4ecb-8a87-59f39313b0a3-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js'}, 'id': 'call_p8veUq01DGKwFFWwCxnpB5Zw', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14351, 'output_tokens': 2213, 'total_tokens': 16564, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 2176}}
2025-11-13 20:20:12,378 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7iigFq3DIiAc9yn63PCVlsdh', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 19215, 'total_tokens': 19241, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e5840aaa-25ee-4824-92ef-9457b62bcfe1-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_7iigFq3DIiAc9yn63PCVlsdh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19215, 'output_tokens': 26, 'total_tokens': 19241, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:20:35,420 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Ojz9POOcJQ820qVsg6GsyWoh', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":950,"end_line":982}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2221, 'prompt_tokens': 24611, 'total_tokens': 26832, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2176, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0d6ff9a3-38ab-4822-a224-eb624047819d-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 950, 'end_line': 982}, 'id': 'call_Ojz9POOcJQ820qVsg6GsyWoh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24611, 'output_tokens': 2221, 'total_tokens': 26832, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 2176}}
2025-11-13 20:21:00,878 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_f98Q2c9gJsi3AJzvqHap16IZ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":491,"end_line":620}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2738, 'prompt_tokens': 24999, 'total_tokens': 27737, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2688, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3ace6c85-678b-498a-91a2-50f3ebc7f9a9-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 491, 'end_line': 620}, 'id': 'call_f98Q2c9gJsi3AJzvqHap16IZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24999, 'output_tokens': 2738, 'total_tokens': 27737, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 2688}}
2025-11-13 20:21:19,935 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7skVRyKPe1UwiyTaLp2ZIZft', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":943}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2093, 'prompt_tokens': 26055, 'total_tokens': 28148, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2048, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24576}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4de42466-3a1a-4669-87be-d9373996ef3b-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 943}, 'id': 'call_7skVRyKPe1UwiyTaLp2ZIZft', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26055, 'output_tokens': 2093, 'total_tokens': 28148, 'input_token_details': {'audio': 0, 'cache_read': 24576}, 'output_token_details': {'audio': 0, 'reasoning': 2048}}
2025-11-13 20:21:58,053 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_sicVoAJQTWnLEQACVYBVXjzf', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","old_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      Object.assign(integrationRequestTemplates, {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      });\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },","new_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      // Allow provider-level override of default request templates\\n      const providerDefaults =\\n        this.serverless &&\\n        this.serverless.service &&\\n        this.serverless.service.provider &&\\n        this.serverless.service.provider.apiGateway &&\\n        typeof this.serverless.service.provider.apiGateway.defaultRequestTemplates === \'object\'\\n          ? this.serverless.service.provider.apiGateway.defaultRequestTemplates\\n          : null;\\n\\n      const defaultTemplates =\\n        providerDefaults ||\\n        {\\n          \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n          \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n        };\\n\\n      Object.assign(integrationRequestTemplates, defaultTemplates);\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    // Remove any templates explicitly disabled (value set to false)\\n    // and ensure only string-valued templates are passed to CloudFormation\\n    Object.keys(integrationRequestTemplates).forEach(contentType => {\\n      const template = integrationRequestTemplates[contentType];\\n      if (template === false || typeof template !== \'string\') {\\n        delete integrationRequestTemplates[contentType];\\n      }\\n    });\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 4861, 'prompt_tokens': 26203, 'total_tokens': 31064, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 4288, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 24960}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--905a6f49-aa90-4630-8c6d-05a7f0c88728-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'old_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      Object.assign(integrationRequestTemplates, {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      });\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },", 'new_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      // Allow provider-level override of default request templates\n      const providerDefaults =\n        this.serverless &&\n        this.serverless.service &&\n        this.serverless.service.provider &&\n        this.serverless.service.provider.apiGateway &&\n        typeof this.serverless.service.provider.apiGateway.defaultRequestTemplates === 'object'\n          ? this.serverless.service.provider.apiGateway.defaultRequestTemplates\n          : null;\n\n      const defaultTemplates =\n        providerDefaults ||\n        {\n          'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n          'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n        };\n\n      Object.assign(integrationRequestTemplates, defaultTemplates);\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    // Remove any templates explicitly disabled (value set to false)\n    // and ensure only string-valued templates are passed to CloudFormation\n    Object.keys(integrationRequestTemplates).forEach(contentType => {\n      const template = integrationRequestTemplates[contentType];\n      if (template === false || typeof template !== 'string') {\n        delete integrationRequestTemplates[contentType];\n      }\n    });\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },"}, 'id': 'call_sicVoAJQTWnLEQACVYBVXjzf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26203, 'output_tokens': 4861, 'total_tokens': 31064, 'input_token_details': {'audio': 0, 'cache_read': 24960}, 'output_token_details': {'audio': 0, 'reasoning': 4288}}
2025-11-13 20:22:00,071 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_H4EPDVsotiZujyXJ3KyLskJz', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","start_line":190,"end_line":220}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 46, 'prompt_tokens': 26798, 'total_tokens': 26844, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6bedd44e-b330-45f5-b00c-5fa745a52ea3-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'start_line': 190, 'end_line': 220}, 'id': 'call_H4EPDVsotiZujyXJ3KyLskJz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 26798, 'output_tokens': 46, 'total_tokens': 26844, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:02,616 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_w8ULP6tafmD5SHMqK8pWbdM3', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","start_line":220,"end_line":262}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 46, 'prompt_tokens': 27102, 'total_tokens': 27148, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fc1e109f-aa06-4d11-a9c6-25990878ab62-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'start_line': 220, 'end_line': 262}, 'id': 'call_w8ULP6tafmD5SHMqK8pWbdM3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27102, 'output_tokens': 46, 'total_tokens': 27148, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:06,752 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_p4yNkSqwMQbOE8XXTs0YmUxk', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","old_content":"      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n","new_content":"      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      // Validate template values: allow strings and boolean false (to disable defaults)\\n      if (http.request.template && typeof http.request.template === \'object\') {\\n        Object.keys(http.request.template).forEach(ct => {\\n          const tpl = http.request.template[ct];\\n          if (tpl !== false && typeof tpl !== \'string\') {\\n            const errorMessage = [\\n              \'Invalid template value for content type \\"\',\\n              ct,\\n              \'\\". Expected a string or false to disable.\',\\n            ].join(\'\');\\n            throw new this.serverless.classes.Error(errorMessage);\\n          }\\n        });\\n      }\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 324, 'prompt_tokens': 27533, 'total_tokens': 27857, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--adfc1fb5-7a6e-4955-be88-6ff411893da8-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'old_content': "      if (http.request.template && typeof http.request.template !== 'object') {\n        const errorMessage = [\n          'Template config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n", 'new_content': '      if (http.request.template && typeof http.request.template !== \'object\') {\n        const errorMessage = [\n          \'Template config must be provided as an object.\',\n          \' Please check the docs for more info.\',\n        ].join(\'\');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      // Validate template values: allow strings and boolean false (to disable defaults)\n      if (http.request.template && typeof http.request.template === \'object\') {\n        Object.keys(http.request.template).forEach(ct => {\n          const tpl = http.request.template[ct];\n          if (tpl !== false && typeof tpl !== \'string\') {\n            const errorMessage = [\n              \'Invalid template value for content type "\',\n              ct,\n              \'". Expected a string or false to disable.\',\n            ].join(\'\');\n            throw new this.serverless.classes.Error(errorMessage);\n          }\n        });\n      }\n'}, 'id': 'call_p4yNkSqwMQbOE8XXTs0YmUxk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27533, 'output_tokens': 324, 'total_tokens': 27857, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:09,343 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pEICy7LaCMEtw4xEiXqo7YCE', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":488,"end_line":516}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 27883, 'total_tokens': 27927, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 11904}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--99b89284-6a9c-4a73-9e5d-67f806a40edb-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 488, 'end_line': 516}, 'id': 'call_pEICy7LaCMEtw4xEiXqo7YCE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 27883, 'output_tokens': 44, 'total_tokens': 27927, 'input_token_details': {'audio': 0, 'cache_read': 11904}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:11,020 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_XzzMGa2QbgHbMRu1DTwAkkrV', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":516,"end_line":540}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 28222, 'total_tokens': 28266, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 25984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fd3eec4c-813e-45e9-99fc-297c013997e9-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 516, 'end_line': 540}, 'id': 'call_XzzMGa2QbgHbMRu1DTwAkkrV', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28222, 'output_tokens': 44, 'total_tokens': 28266, 'input_token_details': {'audio': 0, 'cache_read': 25984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:12,990 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_i1zdvZaYxw6MoounhVYHutOM', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":975}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 39, 'prompt_tokens': 28444, 'total_tokens': 28483, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7db34f90-93ad-467b-82ca-d43d5387c98f-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 975}, 'id': 'call_i1zdvZaYxw6MoounhVYHutOM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28444, 'output_tokens': 39, 'total_tokens': 28483, 'input_token_details': {'audio': 0, 'cache_read': 19200}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:16,236 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PUf3Hn63BD1Q9guDl4e7nr1m', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box:\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n\\n- body\\n- method\\n- principalId\\n- stage\\n- headers\\n- queryStringParameters\\n- path\\n- identity\\n- stageVariables\\n- requestPath","new_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box (for the non-proxy `lambda`/`AWS` integration):\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nYou can disable one or both default templates by setting the content type to `false` in your `request.template` configuration or globally under `provider.apiGateway.defaultRequestTemplates`.\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n\\n- body\\n- method\\n- principalId\\n- stage\\n- headers\\n- queryStringParameters\\n- path\\n- identity\\n- stageVariables\\n- requestPath"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 289, 'prompt_tokens': 28842, 'total_tokens': 29131, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 27136}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3b0d92fc-2453-4d2b-8d70-fbebbf0dffcc-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box:\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n\n- body\n- method\n- principalId\n- stage\n- headers\n- queryStringParameters\n- path\n- identity\n- stageVariables\n- requestPath', 'new_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box (for the non-proxy `lambda`/`AWS` integration):\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nYou can disable one or both default templates by setting the content type to `false` in your `request.template` configuration or globally under `provider.apiGateway.defaultRequestTemplates`.\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n\n- body\n- method\n- principalId\n- stage\n- headers\n- queryStringParameters\n- path\n- identity\n- stageVariables\n- requestPath'}, 'id': 'call_PUf3Hn63BD1Q9guDl4e7nr1m', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28842, 'output_tokens': 289, 'total_tokens': 29131, 'input_token_details': {'audio': 0, 'cache_read': 27136}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:21,424 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5rdFcdiqqFNpOEIewXkpXyBr', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"However you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n\\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\\n","new_content":"However you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n\\nTo remove a default content type, set it to `false`:\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              application/x-www-form-urlencoded: false\\n```\\n\\nYou can also control defaults globally:\\n\\n```yml\\nprovider:\\n  apiGateway:\\n    defaultRequestTemplates:\\n      application/json: ${file(template_json.vtl)}\\n      application/x-www-form-urlencoded: false\\n```\\n\\nIf you remove all templates, remember to adjust pass-through behavior as needed (see below).\\n\\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 501, 'prompt_tokens': 29152, 'total_tokens': 29653, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1280}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8b761a6f-ac41-4e6b-b760-497a94574a5f-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': 'However you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n', 'new_content': 'However you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n\nTo remove a default content type, set it to `false`:\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              application/x-www-form-urlencoded: false\n```\n\nYou can also control defaults globally:\n\n```yml\nprovider:\n  apiGateway:\n    defaultRequestTemplates:\n      application/json: ${file(template_json.vtl)}\n      application/x-www-form-urlencoded: false\n```\n\nIf you remove all templates, remember to adjust pass-through behavior as needed (see below).\n\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n'}, 'id': 'call_5rdFcdiqqFNpOEIewXkpXyBr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29152, 'output_tokens': 501, 'total_tokens': 29653, 'input_token_details': {'audio': 0, 'cache_read': 1280}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:23,468 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_x3UpqruQkEZAlmtPxAAHc9RU', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":997,"end_line":1032}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 29674, 'total_tokens': 29714, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14336}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c9598d01-d6a2-4580-abbf-79e0d8b2b038-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 997, 'end_line': 1032}, 'id': 'call_x3UpqruQkEZAlmtPxAAHc9RU', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29674, 'output_tokens': 40, 'total_tokens': 29714, 'input_token_details': {'audio': 0, 'cache_read': 14336}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:26,015 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_8buvGEYGMciTdnVsFZVV2yV2', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):","new_content":"You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the non-proxy `lambda`/`AWS` integration when defaults are present). If you disable all templates, consider setting `passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH` depending on your desired behavior."}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 129, 'prompt_tokens': 30300, 'total_tokens': 30429, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 26112}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4c1475bb-33d1-434a-9c7c-57526d464f4f-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': 'You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):', 'new_content': 'You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the non-proxy `lambda`/`AWS` integration when defaults are present). If you disable all templates, consider setting `passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH` depending on your desired behavior.'}, 'id': 'call_8buvGEYGMciTdnVsFZVV2yV2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 30300, 'output_tokens': 129, 'total_tokens': 30429, 'input_token_details': {'audio': 0, 'cache_read': 26112}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:30,425 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I will implement the requested feature to allow removal of default request mapping templates. Here is what I changed:\n\n- Added support for disabling default templates per-function via http.request.template by allowing values set to false for specific content types.\n- Added provider-level configuration under provider.apiGateway.defaultRequestTemplates to control global defaults (including disabling by setting to false).\n- Ensured only string-valued templates are emitted to CloudFormation and removed any keys set to false.\n- Added validation to accept string or false values for request templates; other types will produce a clear error.\n- Updated documentation to explain how to disable default templates and how pass-through behavior interacts when templates are removed.\n\nSummary of edits:\n- lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - Enhanced getIntegrationRequestTemplates to:\n    - Respect provider.apiGateway.defaultRequestTemplates for defaults.\n    - Allow disabling defaults using false values (both globally and per-function).\n    - Filter out non-string values before returning RequestTemplates.\n- lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n  - Extended getRequest to validate template values: only strings or boolean false allowed.\n- docs/providers/aws/events/apigateway.md\n  - Clarified Default Request Templates applicability to non-proxy lambda/AWS integration.\n  - Added examples showing how to disable application/x-www-form-urlencoded via request.template and provider-level defaultRequestTemplates.\n  - Added guidance on passThrough behavior when all templates are removed.\n\nThese changes make it possible to remove unwanted default templates (e.g., application/x-www-form-urlencoded) so your API Gateway will no longer advertise unsupported content types.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 333, 'prompt_tokens': 30450, 'total_tokens': 30783, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--f001a08c-f6de-425b-8c23-5481bef97703-0' usage_metadata={'input_tokens': 30450, 'output_tokens': 333, 'total_tokens': 30783, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:22:30,471 - thread-135845287823040.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..a0e2182b9 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -932,11 +932,13 @@ This method is more complicated and involves a lot more configuration of the `ht
 
 #### Default Request Templates
 
-Serverless ships with the following default request templates you can use out of the box:
+Serverless ships with the following default request templates you can use out of the box (for the non-proxy `lambda`/`AWS` integration):
 
 1. `application/json`
 2. `application/x-www-form-urlencoded`
 
+You can disable one or both default templates by setting the content type to `false` in your `request.template` configuration or globally under `provider.apiGateway.defaultRequestTemplates`.
+
 Both templates give you access to the following properties you can access with the help of the `event` object:
 
 - body
@@ -970,6 +972,34 @@ functions:
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
 ```
 
+To remove a default content type, set it to `false`:
+
+```yml
+functions:
+  create:
+    handler: posts.create
+    events:
+      - http:
+          method: get
+          path: whatever
+          integration: lambda
+          request:
+            template:
+              application/x-www-form-urlencoded: false
+```
+
+You can also control defaults globally:
+
+```yml
+provider:
+  apiGateway:
+    defaultRequestTemplates:
+      application/json: ${file(template_json.vtl)}
+      application/x-www-form-urlencoded: false
+```
+
+If you remove all templates, remember to adjust pass-through behavior as needed (see below).
+
 **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
 
 **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
@@ -998,7 +1028,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s
 
 [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.
 
-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):
+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the non-proxy `lambda`/`AWS` integration when defaults are present). If you disable all templates, consider setting `passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH` depending on your desired behavior.
 
 ```yml
 functions:
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..0553ab74e 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -201,10 +201,24 @@ module.exports = {
 
     // Only set defaults for AWS (lambda) integration
     if (useDefaults) {
-      Object.assign(integrationRequestTemplates, {
-        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
-        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
-      });
+      // Allow provider-level override of default request templates
+      const providerDefaults =
+        this.serverless &&
+        this.serverless.service &&
+        this.serverless.service.provider &&
+        this.serverless.service.provider.apiGateway &&
+        typeof this.serverless.service.provider.apiGateway.defaultRequestTemplates === 'object'
+          ? this.serverless.service.provider.apiGateway.defaultRequestTemplates
+          : null;
+
+      const defaultTemplates =
+        providerDefaults ||
+        {
+          'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
+          'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
+        };
+
+      Object.assign(integrationRequestTemplates, defaultTemplates);
     }
 
     // set custom request templates if provided
@@ -212,6 +226,15 @@ module.exports = {
       Object.assign(integrationRequestTemplates, http.request.template);
     }
 
+    // Remove any templates explicitly disabled (value set to false)
+    // and ensure only string-valued templates are passed to CloudFormation
+    Object.keys(integrationRequestTemplates).forEach(contentType => {
+      const template = integrationRequestTemplates[contentType];
+      if (template === false || typeof template !== 'string') {
+        delete integrationRequestTemplates[contentType];
+      }
+    });
+
     return Object.keys(integrationRequestTemplates).length
       ? integrationRequestTemplates
       : undefined;
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..2bdb24092 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,20 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      // Validate template values: allow strings and boolean false (to disable defaults)
+      if (http.request.template && typeof http.request.template === 'object') {
+        Object.keys(http.request.template).forEach(ct => {
+          const tpl = http.request.template[ct];
+          if (tpl !== false && typeof tpl !== 'string') {
+            const errorMessage = [
+              'Invalid template value for content type "',
+              ct,
+              '". Expected a string or false to disable.',
+            ].join('');
+            throw new this.serverless.classes.Error(errorMessage);
+          }
+        });
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:22:30,472 - thread-135845287823040.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 20:22:30,502 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 20:22:30,503 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 20:22:30,506 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n' additional_kwargs={} response_metadata={}
2025-11-13 20:24:17,214 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content="Below is a high-level analysis and implementation plan to add a feature that allows removal of default API Gateway request mapping templates in the Serverless Framework (AWS provider).\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Today, for Lambda (AWS) integration, Serverless auto-adds two default request mapping templates: application/json and application/x-www-form-urlencoded.\n  - Users need a way to opt out of specific defaults (e.g., remove application/x-www-form-urlencoded) or opt out of all defaults, so the generated API Gateway “consumes” does not incorrectly advertise unsupported content types.\n\n- Requirements inferred:\n  - Allow users to remove specific default templates (e.g., only application/x-www-form-urlencoded) without having to fully redefine others.\n  - Allow users to remove all defaults if desired and provide their own templates only.\n  - Maintain backward compatibility by default.\n  - Ensure the generated API configuration behaves correctly with PassThrough behaviors.\n\n- Ambiguities/edge cases:\n  - What happens if all templates are removed? With AWS integration and default passThrough of NEVER, requests with unmatched content-type will return 415. That is acceptable but should be documented and users should be able to configure passThrough if they want different behavior.\n  - Behavior for HTTP or MOCK integrations is unaffected (no defaults are set there today).\n  - Value used to signal “removal” must be clear and safe in YAML (proposed: null or false to indicate removal of an individual content-type template).\n\n2) Architecture Analysis\n\n- Existing integration points:\n  - Default request templates are assembled in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js in getIntegrationRequestTemplates(http, useDefaults).\n  - Request config validation is in lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js (getRequest, getRequestPassThrough).\n  - API Gateway docs for request templates are in docs/providers/aws/events/apigateway.md under “Default Request Templates” and “Custom Request Templates”.\n\n- Proposed integration design:\n  - Extend getIntegrationRequestTemplates to support:\n    - A new request-level boolean option (e.g., useDefaultTemplates) to disable default templates altogether when false.\n    - Per-content-type removal semantics where a template value of null or false instructs the packager to omit that content type from RequestTemplates (rather than defining an invalid value).\n  - Add corresponding validation for the new boolean field useDefaultTemplates to avoid misconfiguration.\n  - Update documentation to explain:\n    - Defaults are enabled by default for Lambda integration.\n    - How to remove one default content type (e.g., application/x-www-form-urlencoded).\n    - How to disable all defaults and supply only explicit templates.\n    - PassThrough implications when removing templates.\n\n- Architectural conventions:\n  - Keep option names and location consistent with existing “request” block (e.g., request.template, request.passThrough, request.contentHandling).\n  - Do not break existing behavior unless a user opts in to new config.\n\n3) Implementation Plan\n\nChange 1: Support opt-out of defaults and per-type removal in request templates\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function to modify: getIntegrationRequestTemplates(http, useDefaults)\n- Changes to implement:\n  - Add support for a new boolean request.useDefaultTemplates (default true). If false, skip pre-populating defaults even when useDefaults is true (AWS integration).\n  - Preserve current behavior by default: If request.useDefaultTemplates is undefined or true, keep adding the default 'application/json' and 'application/x-www-form-urlencoded' mappings for AWS integration.\n  - After assembling the initial templates (defaults and/or custom), inspect http.request.template entries:\n    - If a key’s value is null or false, remove that content type from the final integrationRequestTemplates (do not add it).\n    - If a key’s value is a string, add/override as today.\n  - Ensure that if, after removals, integrationRequestTemplates is empty, the function returns undefined (as it does today), so that the Integration.RequestTemplates property is omitted from the method.\n\nChange 2: Validate new option\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n- Function to modify: getRequest(http)\n- Changes to implement:\n  - If http.request.useDefaultTemplates is present, validate it is a boolean. If not, throw an error consistent with existing validation patterns.\n  - No change required for template values; values may be strings (mapping template content), and will also accept null/false for removal. Existing code does not strictly type-check individual values, which is acceptable and backward compatible.\n\nChange 3: Documentation updates\n- File: docs/providers/aws/events/apigateway.md\n- Sections to update:\n  - Under “Lambda Integration → Default Request Templates”:\n    - Clarify that the framework adds two defaults for Lambda integration: application/json and application/x-www-form-urlencoded.\n    - Note that defaults can be controlled via request.useDefaultTemplates and per-content-type removal.\n  - Under “Custom Request Templates”:\n    - Add examples showing:\n      - Removing a single default template by setting it to null/false under request.template (e.g., application/x-www-form-urlencoded: null).\n      - Disabling all defaults by setting request.useDefaultTemplates: false and providing only desired templates in request.template.\n  - Under “Pass Through Behavior”:\n    - Add a note that if defaults are disabled and no templates are defined, with AWS integration and default passThrough of NEVER, API Gateway will reject unmatched content types with 415. Users can set request.passThrough to WHEN_NO_MATCH or WHEN_NO_TEMPLATES if desired.\n\nOptional Change 4: HTTP event schema (deferred)\n- File: lib/plugins/aws/package/compile/events/apiGateway/index.js or a schema extension location\n- Today, the schema is not fully defined (TODO noted). If/when schema is expanded, include request.useDefaultTemplates: boolean. For now, rely on validate.js checks to enforce types.\n\n4) Considerations\n\n- Potential impacts:\n  - Default behavior remains unchanged unless users explicitly configure request.useDefaultTemplates: false or specify null/false for specific content-type templates.\n  - With per-content-type removal, the resulting API Gateway “consumes” will reflect only the remaining content types, fixing the Swagger/OpenAPI advertisement issue.\n  - If users disable all defaults and do not provide templates, the request will be rejected for non-matching content types under the default passThrough NEVER for AWS integrations; this is expected and should be documented.\n\n- Backward compatibility:\n  - By default, useDefaultTemplates effectively defaults to true, preserving current behavior.\n  - Allowing null/false as a removal mechanism is not breaking; previously such values would have caused deployment-time errors because API Gateway expects string values. Now they will be consumed by the compiler and omitted, making some previously invalid configurations valid.\n\n- Dependencies/prerequisites:\n  - None beyond the Serverless Framework code changes described.\n  - No changes needed for non-AWS integrations or for AWS_PROXY integrations (mapping templates aren’t used there).\n\n- Workarounds before this feature:\n  - Use Lambda proxy integration (AWS_PROXY) which does not create mapping templates, if compatible with the application.\n  - Provide a custom CloudFormation override to adjust RequestTemplates post-generation (complex and not recommended).\n  - With the new feature, these workarounds will no longer be necessary.\n\nSummary:\n- Add a new boolean option request.useDefaultTemplates to opt out of default mapping templates for Lambda integration.\n- Add per-content-type removal semantics by treating null/false values in request.template as a signal to remove that content type’s template from the final Integration.RequestTemplates.\n- Update validation to accept and type-check the new option.\n- Update documentation with examples and pass-through behavior notes." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5134, 'prompt_tokens': 9771, 'total_tokens': 14905, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3520, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--8c3e6913-a889-4826-a475-dd8b6139e434-0' usage_metadata={'input_tokens': 9771, 'output_tokens': 5134, 'total_tokens': 14905, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3520}}
2025-11-13 20:24:17,219 - thread-135845287823040.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nBelow is a high-level analysis and implementation plan to add a feature that allows removal of default API Gateway request mapping templates in the Serverless Framework (AWS provider).\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Today, for Lambda (AWS) integration, Serverless auto-adds two default request mapping templates: application/json and application/x-www-form-urlencoded.\n  - Users need a way to opt out of specific defaults (e.g., remove application/x-www-form-urlencoded) or opt out of all defaults, so the generated API Gateway “consumes” does not incorrectly advertise unsupported content types.\n\n- Requirements inferred:\n  - Allow users to remove specific default templates (e.g., only application/x-www-form-urlencoded) without having to fully redefine others.\n  - Allow users to remove all defaults if desired and provide their own templates only.\n  - Maintain backward compatibility by default.\n  - Ensure the generated API configuration behaves correctly with PassThrough behaviors.\n\n- Ambiguities/edge cases:\n  - What happens if all templates are removed? With AWS integration and default passThrough of NEVER, requests with unmatched content-type will return 415. That is acceptable but should be documented and users should be able to configure passThrough if they want different behavior.\n  - Behavior for HTTP or MOCK integrations is unaffected (no defaults are set there today).\n  - Value used to signal “removal” must be clear and safe in YAML (proposed: null or false to indicate removal of an individual content-type template).\n\n2) Architecture Analysis\n\n- Existing integration points:\n  - Default request templates are assembled in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js in getIntegrationRequestTemplates(http, useDefaults).\n  - Request config validation is in lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js (getRequest, getRequestPassThrough).\n  - API Gateway docs for request templates are in docs/providers/aws/events/apigateway.md under “Default Request Templates” and “Custom Request Templates”.\n\n- Proposed integration design:\n  - Extend getIntegrationRequestTemplates to support:\n    - A new request-level boolean option (e.g., useDefaultTemplates) to disable default templates altogether when false.\n    - Per-content-type removal semantics where a template value of null or false instructs the packager to omit that content type from RequestTemplates (rather than defining an invalid value).\n  - Add corresponding validation for the new boolean field useDefaultTemplates to avoid misconfiguration.\n  - Update documentation to explain:\n    - Defaults are enabled by default for Lambda integration.\n    - How to remove one default content type (e.g., application/x-www-form-urlencoded).\n    - How to disable all defaults and supply only explicit templates.\n    - PassThrough implications when removing templates.\n\n- Architectural conventions:\n  - Keep option names and location consistent with existing “request” block (e.g., request.template, request.passThrough, request.contentHandling).\n  - Do not break existing behavior unless a user opts in to new config.\n\n3) Implementation Plan\n\nChange 1: Support opt-out of defaults and per-type removal in request templates\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n- Function to modify: getIntegrationRequestTemplates(http, useDefaults)\n- Changes to implement:\n  - Add support for a new boolean request.useDefaultTemplates (default true). If false, skip pre-populating defaults even when useDefaults is true (AWS integration).\n  - Preserve current behavior by default: If request.useDefaultTemplates is undefined or true, keep adding the default \'application/json\' and \'application/x-www-form-urlencoded\' mappings for AWS integration.\n  - After assembling the initial templates (defaults and/or custom), inspect http.request.template entries:\n    - If a key’s value is null or false, remove that content type from the final integrationRequestTemplates (do not add it).\n    - If a key’s value is a string, add/override as today.\n  - Ensure that if, after removals, integrationRequestTemplates is empty, the function returns undefined (as it does today), so that the Integration.RequestTemplates property is omitted from the method.\n\nChange 2: Validate new option\n- File: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n- Function to modify: getRequest(http)\n- Changes to implement:\n  - If http.request.useDefaultTemplates is present, validate it is a boolean. If not, throw an error consistent with existing validation patterns.\n  - No change required for template values; values may be strings (mapping template content), and will also accept null/false for removal. Existing code does not strictly type-check individual values, which is acceptable and backward compatible.\n\nChange 3: Documentation updates\n- File: docs/providers/aws/events/apigateway.md\n- Sections to update:\n  - Under “Lambda Integration → Default Request Templates”:\n    - Clarify that the framework adds two defaults for Lambda integration: application/json and application/x-www-form-urlencoded.\n    - Note that defaults can be controlled via request.useDefaultTemplates and per-content-type removal.\n  - Under “Custom Request Templates”:\n    - Add examples showing:\n      - Removing a single default template by setting it to null/false under request.template (e.g., application/x-www-form-urlencoded: null).\n      - Disabling all defaults by setting request.useDefaultTemplates: false and providing only desired templates in request.template.\n  - Under “Pass Through Behavior”:\n    - Add a note that if defaults are disabled and no templates are defined, with AWS integration and default passThrough of NEVER, API Gateway will reject unmatched content types with 415. Users can set request.passThrough to WHEN_NO_MATCH or WHEN_NO_TEMPLATES if desired.\n\nOptional Change 4: HTTP event schema (deferred)\n- File: lib/plugins/aws/package/compile/events/apiGateway/index.js or a schema extension location\n- Today, the schema is not fully defined (TODO noted). If/when schema is expanded, include request.useDefaultTemplates: boolean. For now, rely on validate.js checks to enforce types.\n\n4) Considerations\n\n- Potential impacts:\n  - Default behavior remains unchanged unless users explicitly configure request.useDefaultTemplates: false or specify null/false for specific content-type templates.\n  - With per-content-type removal, the resulting API Gateway “consumes” will reflect only the remaining content types, fixing the Swagger/OpenAPI advertisement issue.\n  - If users disable all defaults and do not provide templates, the request will be rejected for non-matching content types under the default passThrough NEVER for AWS integrations; this is expected and should be documented.\n\n- Backward compatibility:\n  - By default, useDefaultTemplates effectively defaults to true, preserving current behavior.\n  - Allowing null/false as a removal mechanism is not breaking; previously such values would have caused deployment-time errors because API Gateway expects string values. Now they will be consumed by the compiler and omitted, making some previously invalid configurations valid.\n\n- Dependencies/prerequisites:\n  - None beyond the Serverless Framework code changes described.\n  - No changes needed for non-AWS integrations or for AWS_PROXY integrations (mapping templates aren’t used there).\n\n- Workarounds before this feature:\n  - Use Lambda proxy integration (AWS_PROXY) which does not create mapping templates, if compatible with the application.\n  - Provide a custom CloudFormation override to adjust RequestTemplates post-generation (complex and not recommended).\n  - With the new feature, these workarounds will no longer be necessary.\n\nSummary:\n- Add a new boolean option request.useDefaultTemplates to opt out of default mapping templates for Lambda integration.\n- Add per-content-type removal semantics by treating null/false values in request.template as a signal to remove that content type’s template from the final Integration.RequestTemplates.\n- Update validation to accept and type-check the new option.\n- Update documentation with examples and pass-through behavior notes.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 20:24:27,902 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_1IQgBl6o2oLqfSHtPMETIbV6', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1127, 'prompt_tokens': 11780, 'total_tokens': 12907, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1088, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8005bf8d-694a-40a8-8f94-20d9922f4de4-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_1IQgBl6o2oLqfSHtPMETIbV6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11780, 'output_tokens': 1127, 'total_tokens': 12907, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 1088}}
2025-11-13 20:24:33,374 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_cA97S9QrdV10M2qa2vwftiZ2', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":975}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 301, 'prompt_tokens': 14149, 'total_tokens': 14450, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--aac501a7-1dfd-4a6a-ab36-2f3d59fa9d2e-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 975}, 'id': 'call_cA97S9QrdV10M2qa2vwftiZ2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14149, 'output_tokens': 301, 'total_tokens': 14450, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:24:35,365 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_a2Ud5H7xB3Tvmg8dDc1K8mi4', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 14547, 'total_tokens': 14578, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14080}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f5f6057f-299f-4dce-a090-06594fa797de-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js'}, 'id': 'call_a2Ud5H7xB3Tvmg8dDc1K8mi4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14547, 'output_tokens': 31, 'total_tokens': 14578, 'input_token_details': {'audio': 0, 'cache_read': 14080}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:24:37,207 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_507td9ohJuJmVhauexoFnQcd', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":491,"end_line":570}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 19411, 'total_tokens': 19455, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 14464}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3d74116f-f6e6-449d-bd9a-1c4bc2ef351d-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 491, 'end_line': 570}, 'id': 'call_507td9ohJuJmVhauexoFnQcd', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19411, 'output_tokens': 44, 'total_tokens': 19455, 'input_token_details': {'audio': 0, 'cache_read': 14464}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:25:10,829 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5z0z1tJzDIeRHqcHJpMVXyAJ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","old_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      Object.assign(integrationRequestTemplates, {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      });\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },","new_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Determine whether default templates should be used (only for AWS (lambda) integration)\\n    const useDefaultsAfterConfig =\\n      useDefaults && !(http.request && http.request.useDefaultTemplates === false);\\n\\n    if (useDefaultsAfterConfig) {\\n      Object.assign(integrationRequestTemplates, {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      });\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      _.forEach(http.request.template, (value, key) => {\\n        if (value === null || value === false) {\\n          // Explicitly remove this content type from the final templates\\n          if (Object.prototype.hasOwnProperty.call(integrationRequestTemplates, key)) {\\n            delete integrationRequestTemplates[key];\\n          }\\n        } else {\\n          integrationRequestTemplates[key] = value;\\n        }\\n      });\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3307, 'prompt_tokens': 20176, 'total_tokens': 23483, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2816, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19328}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--630fc3b8-40c6-4771-a05c-e4c3621e5c51-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'old_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      Object.assign(integrationRequestTemplates, {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      });\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },", 'new_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Determine whether default templates should be used (only for AWS (lambda) integration)\n    const useDefaultsAfterConfig =\n      useDefaults && !(http.request && http.request.useDefaultTemplates === false);\n\n    if (useDefaultsAfterConfig) {\n      Object.assign(integrationRequestTemplates, {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      });\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      _.forEach(http.request.template, (value, key) => {\n        if (value === null || value === false) {\n          // Explicitly remove this content type from the final templates\n          if (Object.prototype.hasOwnProperty.call(integrationRequestTemplates, key)) {\n            delete integrationRequestTemplates[key];\n          }\n        } else {\n          integrationRequestTemplates[key] = value;\n        }\n      });\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },"}, 'id': 'call_5z0z1tJzDIeRHqcHJpMVXyAJ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 20176, 'output_tokens': 3307, 'total_tokens': 23483, 'input_token_details': {'audio': 0, 'cache_read': 19328}, 'output_token_details': {'audio': 0, 'reasoning': 2816}}
2025-11-13 20:25:12,193 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_19tkHbGdg3hUlwahVGlQ1RaQ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 20689, 'total_tokens': 20722, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--595edd8d-cb82-4568-8869-edb5423243f7-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_19tkHbGdg3hUlwahVGlQ1RaQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 20689, 'output_tokens': 33, 'total_tokens': 20722, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:25:15,994 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_FTRkpSEnBTOhlY9xiqiJmWn1', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","old_content":"  getRequest(http) {\\n    if (http.request) {\\n      const request = http.request;\\n\\n      if (typeof http.request !== \'object\') {\\n        const errorMessage = [\\n          \'Request config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n\\n      if (request.parameters) {\\n        request.parameters = this.getRequestParameters(request);\\n      }\\n\\n      return request;\\n    }\\n\\n    return {};\\n  },","new_content":"  getRequest(http) {\\n    if (http.request) {\\n      const request = http.request;\\n\\n      if (typeof http.request !== \'object\') {\\n        const errorMessage = [\\n          \'Request config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (http.request.template && typeof http.request.template !== \'object\') {\\n        const errorMessage = [\\n          \'Template config must be provided as an object.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n      if (\\n        typeof http.request.useDefaultTemplates !== \'undefined\' &&\\n        typeof http.request.useDefaultTemplates !== \'boolean\'\\n      ) {\\n        const errorMessage = [\\n          \'useDefaultTemplates config must be provided as a boolean.\',\\n          \' Please check the docs for more info.\',\\n        ].join(\'\');\\n        throw new this.serverless.classes.Error(errorMessage);\\n      }\\n\\n      if (request.parameters) {\\n        request.parameters = this.getRequestParameters(request);\\n      }\\n\\n      return request;\\n    }\\n\\n    return {};\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 537, 'prompt_tokens': 23185, 'total_tokens': 23722, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e19615ad-5afb-414c-9ee0-bd1d49b5afdc-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'old_content': "  getRequest(http) {\n    if (http.request) {\n      const request = http.request;\n\n      if (typeof http.request !== 'object') {\n        const errorMessage = [\n          'Request config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (http.request.template && typeof http.request.template !== 'object') {\n        const errorMessage = [\n          'Template config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n\n      if (request.parameters) {\n        request.parameters = this.getRequestParameters(request);\n      }\n\n      return request;\n    }\n\n    return {};\n  },", 'new_content': "  getRequest(http) {\n    if (http.request) {\n      const request = http.request;\n\n      if (typeof http.request !== 'object') {\n        const errorMessage = [\n          'Request config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (http.request.template && typeof http.request.template !== 'object') {\n        const errorMessage = [\n          'Template config must be provided as an object.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n      if (\n        typeof http.request.useDefaultTemplates !== 'undefined' &&\n        typeof http.request.useDefaultTemplates !== 'boolean'\n      ) {\n        const errorMessage = [\n          'useDefaultTemplates config must be provided as a boolean.',\n          ' Please check the docs for more info.',\n        ].join('');\n        throw new this.serverless.classes.Error(errorMessage);\n      }\n\n      if (request.parameters) {\n        request.parameters = this.getRequestParameters(request);\n      }\n\n      return request;\n    }\n\n    return {};\n  },"}, 'id': 'call_FTRkpSEnBTOhlY9xiqiJmWn1', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23185, 'output_tokens': 537, 'total_tokens': 23722, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:25:19,338 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_H92WTETVwJRUiaw5Bx35CsOG', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 31, 'prompt_tokens': 23748, 'total_tokens': 23779, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0ba18fa3-b121-4174-9d7d-793453e22129-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js'}, 'id': 'call_H92WTETVwJRUiaw5Bx35CsOG', 'type': 'tool_call'}] usage_metadata={'input_tokens': 23748, 'output_tokens': 31, 'total_tokens': 23779, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:25:21,135 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_aKDOXVPNGv73xXJKrnR4uWOb', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js","start_line":491,"end_line":540}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 28612, 'total_tokens': 28656, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 20608}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--64537cbc-7c95-4bf4-9c78-6653be06c04a-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js', 'start_line': 491, 'end_line': 540}, 'id': 'call_aKDOXVPNGv73xXJKrnR4uWOb', 'type': 'tool_call'}] usage_metadata={'input_tokens': 28612, 'output_tokens': 44, 'total_tokens': 28656, 'input_token_details': {'audio': 0, 'cache_read': 20608}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:25:24,009 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_AAHCIJnqlSF2WHlqBRbf8ozL', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 29111, 'total_tokens': 29137, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 23680}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9dff0b8b-d0e7-40a7-8231-95299a4ee7b4-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_AAHCIJnqlSF2WHlqBRbf8ozL', 'type': 'tool_call'}] usage_metadata={'input_tokens': 29111, 'output_tokens': 26, 'total_tokens': 29137, 'input_token_details': {'audio': 0, 'cache_read': 23680}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:25:32,053 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_QlxU9D4qgA4Xyb3z7YvEkroV', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":933,"end_line":942}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 557, 'prompt_tokens': 34507, 'total_tokens': 35064, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--415be6ed-ac52-4573-aeb1-fb3f22375295-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 933, 'end_line': 942}, 'id': 'call_QlxU9D4qgA4Xyb3z7YvEkroV', 'type': 'tool_call'}] usage_metadata={'input_tokens': 34507, 'output_tokens': 557, 'total_tokens': 35064, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:25:48,699 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yOnBP8bMLJzX9QCScgWFffN2', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":958,"end_line":972}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1837, 'prompt_tokens': 34642, 'total_tokens': 36479, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1792, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d4ca5c26-cf38-4b59-abb2-9d7e17ddedff-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 958, 'end_line': 972}, 'id': 'call_yOnBP8bMLJzX9QCScgWFffN2', 'type': 'tool_call'}] usage_metadata={'input_tokens': 34642, 'output_tokens': 1837, 'total_tokens': 36479, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 1792}}
2025-11-13 20:26:15,940 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NCkhzOSfWt3EVDrXjSXfb2Io', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":1024,"end_line":1034}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2991, 'prompt_tokens': 34798, 'total_tokens': 37789, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2944, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1280c243-bc23-4801-876e-9f7236ba5e68-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 1024, 'end_line': 1034}, 'id': 'call_NCkhzOSfWt3EVDrXjSXfb2Io', 'type': 'tool_call'}] usage_metadata={'input_tokens': 34798, 'output_tokens': 2991, 'total_tokens': 37789, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 2944}}
2025-11-13 20:26:41,781 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NrZExxMbFQAZsutEuDkfOPTh', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box:\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n","new_content":"#### Default Request Templates\\n\\nServerless ships with the following default request templates you can use out of the box:\\n\\n1. `application/json`\\n2. `application/x-www-form-urlencoded`\\n\\nBy default, these templates are added only for the Lambda (AWS) integration. You can control defaults as follows:\\n- Disable all defaults for a given endpoint by setting `request.useDefaultTemplates: false`\\n- Remove a specific default by setting its content type under `request.template` to `null` or `false` (e.g., `application/x-www-form-urlencoded: null`)\\n\\nBoth templates give you access to the following properties you can access with the help of the `event` object:\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2622, 'prompt_tokens': 35008, 'total_tokens': 37630, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2368, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 34432}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ff113b90-82eb-4ddb-abf7-a4bf0100fbec-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box:\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n', 'new_content': '#### Default Request Templates\n\nServerless ships with the following default request templates you can use out of the box:\n\n1. `application/json`\n2. `application/x-www-form-urlencoded`\n\nBy default, these templates are added only for the Lambda (AWS) integration. You can control defaults as follows:\n- Disable all defaults for a given endpoint by setting `request.useDefaultTemplates: false`\n- Remove a specific default by setting its content type under `request.template` to `null` or `false` (e.g., `application/x-www-form-urlencoded: null`)\n\nBoth templates give you access to the following properties you can access with the help of the `event` object:\n'}, 'id': 'call_NrZExxMbFQAZsutEuDkfOPTh', 'type': 'tool_call'}] usage_metadata={'input_tokens': 35008, 'output_tokens': 2622, 'total_tokens': 37630, 'input_token_details': {'audio': 0, 'cache_read': 34432}, 'output_token_details': {'audio': 0, 'reasoning': 2368}}
2025-11-13 20:26:46,783 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_m5IektROexQQ5gKBsgYr5Pt7', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"However you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n","new_content":"However you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type). You can also remove defaults:\\n\\n- Remove a single default template:\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              application/x-www-form-urlencoded: null # removes this default\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n\\n- Disable all default templates and provide only explicit templates:\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            useDefaultTemplates: false\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n```\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 380, 'prompt_tokens': 35277, 'total_tokens': 35657, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 20096}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--46069e9b-e5b4-45ec-a87a-2fef1bb06063-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': 'However you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n', 'new_content': 'However you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type). You can also remove defaults:\n\n- Remove a single default template:\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              application/x-www-form-urlencoded: null # removes this default\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n\n- Disable all default templates and provide only explicit templates:\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            useDefaultTemplates: false\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n```\n'}, 'id': 'call_m5IektROexQQ5gKBsgYr5Pt7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 35277, 'output_tokens': 380, 'total_tokens': 35657, 'input_token_details': {'audio': 0, 'cache_read': 20096}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:26:51,459 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4hhKg43ONNyolzPcDSnECONj', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"**Notes:**\\n\\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\\n- API Gateway docs refer to \\"WHEN_NO_TEMPLATE\\" (singular), but this will fail during creation as the actual value should be \\"WHEN_NO_TEMPLATES\\" (plural)\\n","new_content":"**Notes:**\\n\\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\\n- If you disable all default templates for Lambda integration and do not define any templates, the default `passThrough` for Lambda integration is `NEVER`, which will cause API Gateway to return `415 - Unsupported Media Type` for unmatched content types. You can change this behavior via `request.passThrough`.\\n- API Gateway docs refer to \\"WHEN_NO_TEMPLATE\\" (singular), but this will fail during creation as the actual value should be \\"WHEN_NO_TEMPLATES\\" (plural)\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 229, 'prompt_tokens': 35678, 'total_tokens': 35907, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 23680}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dde8dc2c-10fb-4894-aed6-e3e4cff8e757-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '**Notes:**\n\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n- API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n', 'new_content': '**Notes:**\n\n- A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n- If you disable all default templates for Lambda integration and do not define any templates, the default `passThrough` for Lambda integration is `NEVER`, which will cause API Gateway to return `415 - Unsupported Media Type` for unmatched content types. You can change this behavior via `request.passThrough`.\n- API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n'}, 'id': 'call_4hhKg43ONNyolzPcDSnECONj', 'type': 'tool_call'}] usage_metadata={'input_tokens': 35678, 'output_tokens': 229, 'total_tokens': 35907, 'input_token_details': {'audio': 0, 'cache_read': 23680}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:26:56,059 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_O7fxSS0XpJ1IXp9ljVWsXhUH', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":930,"end_line":976}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 301, 'prompt_tokens': 35928, 'total_tokens': 36229, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 34944}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bdb9aa1a-883c-4acc-9398-3eb382be26a8-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 930, 'end_line': 976}, 'id': 'call_O7fxSS0XpJ1IXp9ljVWsXhUH', 'type': 'tool_call'}] usage_metadata={'input_tokens': 35928, 'output_tokens': 301, 'total_tokens': 36229, 'input_token_details': {'audio': 0, 'cache_read': 34944}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:26:59,598 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NqSREG7MC3QFccq8XA0P0O4u', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":975,"end_line":1010}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 36367, 'total_tokens': 36407, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f0f7b695-bf28-4f3c-bafb-ad0567a5db36-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 975, 'end_line': 1010}, 'id': 'call_NqSREG7MC3QFccq8XA0P0O4u', 'type': 'tool_call'}] usage_metadata={'input_tokens': 36367, 'output_tokens': 40, 'total_tokens': 36407, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:27:01,758 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_jVss3fVl2BRJapxZAL04xQrx', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":997,"end_line":1034}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 36778, 'total_tokens': 36818, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 35584}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b8746761-e9a3-4aa2-9dcd-c5dcb8d81fa7-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 997, 'end_line': 1034}, 'id': 'call_jVss3fVl2BRJapxZAL04xQrx', 'type': 'tool_call'}] usage_metadata={'input_tokens': 36778, 'output_tokens': 40, 'total_tokens': 36818, 'input_token_details': {'audio': 0, 'cache_read': 35584}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:27:05,864 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I implemented the feature to allow removal of default API Gateway request mapping templates and updated validation and documentation accordingly.\n\nSummary of changes:\n- Added support for disabling default templates and per-content-type removal:\n  - In lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js:\n    - Updated getIntegrationRequestTemplates to:\n      - Respect a new boolean option request.useDefaultTemplates (defaults to true). When set to false, default templates are not added even for AWS integration.\n      - Allow per-content-type removal by treating null or false values in request.template as a directive to omit that content type (e.g., application/x-www-form-urlencoded: null).\n- Added validation for the new option:\n  - In lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js:\n    - getRequest now validates that request.useDefaultTemplates, when provided, is a boolean.\n- Updated documentation:\n  - In docs/providers/aws/events/apigateway.md:\n    - Clarified default request templates behavior for Lambda integration.\n    - Added instructions and examples for:\n      - Removing a single default by setting the content type to null.\n      - Disabling all defaults with request.useDefaultTemplates: false and defining explicit templates.\n    - Added a note in the Pass Through Behavior section about implications when disabling defaults (e.g., 415 Unsupported Media Type when passThrough is NEVER).\n\nThese edits allow users to remove unwanted default templates (like application/x-www-form-urlencoded) or disable all defaults, resolving the issue where unsupported content types are advertised in generated documentation.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 315, 'prompt_tokens': 37368, 'total_tokens': 37683, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 28544}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--4c3d64a5-2bf2-4c20-bee1-24be3c54a7f3-0' usage_metadata={'input_tokens': 37368, 'output_tokens': 315, 'total_tokens': 37683, 'input_token_details': {'audio': 0, 'cache_read': 28544}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:27:05,913 - thread-135845287823040.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..194b6dc51 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -937,6 +937,10 @@ Serverless ships with the following default request templates you can use out of
 1. `application/json`
 2. `application/x-www-form-urlencoded`
 
+By default, these templates are added only for the Lambda (AWS) integration. You can control defaults as follows:
+- Disable all defaults for a given endpoint by setting `request.useDefaultTemplates: false`
+- Remove a specific default by setting its content type under `request.template` to `null` or `false` (e.g., `application/x-www-form-urlencoded: null`)
+
 Both templates give you access to the following properties you can access with the help of the `event` object:
 
 - body
@@ -953,7 +957,9 @@ Both templates give you access to the following properties you can access with t
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
-by defining a new request template for an existing content type):
+by defining a new request template for an existing content type). You can also remove defaults:
+
+- Remove a single default template:
 
 ```yml
 functions:
@@ -966,10 +972,27 @@ functions:
           integration: lambda
           request:
             template:
-              text/xhtml: '{ "stage" : "$context.stage" }'
+              application/x-www-form-urlencoded: null # removes this default
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
 ```
 
+- Disable all default templates and provide only explicit templates:
+
+```yml
+functions:
+  create:
+    handler: posts.create
+    events:
+      - http:
+          method: get
+          path: whatever
+          integration: lambda
+          request:
+            useDefaultTemplates: false
+            template:
+              text/xhtml: '{ "stage" : "$context.stage" }'
+```
+
 **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
 
 **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
@@ -1026,6 +1049,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates
 **Notes:**
 
 - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
+- If you disable all default templates for Lambda integration and do not define any templates, the default `passThrough` for Lambda integration is `NEVER`, which will cause API Gateway to return `415 - Unsupported Media Type` for unmatched content types. You can change this behavior via `request.passThrough`.
 - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)
 
 ### Responses
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..e355368cb 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -199,8 +199,11 @@ module.exports = {
     // default request templates
     const integrationRequestTemplates = {};
 
-    // Only set defaults for AWS (lambda) integration
-    if (useDefaults) {
+    // Determine whether default templates should be used (only for AWS (lambda) integration)
+    const useDefaultsAfterConfig =
+      useDefaults && !(http.request && http.request.useDefaultTemplates === false);
+
+    if (useDefaultsAfterConfig) {
       Object.assign(integrationRequestTemplates, {
         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
@@ -209,7 +212,16 @@ module.exports = {
 
     // set custom request templates if provided
     if (http.request && typeof http.request.template === 'object') {
-      Object.assign(integrationRequestTemplates, http.request.template);
+      _.forEach(http.request.template, (value, key) => {
+        if (value === null || value === false) {
+          // Explicitly remove this content type from the final templates
+          if (Object.prototype.hasOwnProperty.call(integrationRequestTemplates, key)) {
+            delete integrationRequestTemplates[key];
+          }
+        } else {
+          integrationRequestTemplates[key] = value;
+        }
+      });
     }
 
     return Object.keys(integrationRequestTemplates).length
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..10b0ade05 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,16 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      if (
+        typeof http.request.useDefaultTemplates !== 'undefined' &&
+        typeof http.request.useDefaultTemplates !== 'boolean'
+      ) {
+        const errorMessage = [
+          'useDefaultTemplates config must be provided as a boolean.',
+          ' Please check the docs for more info.',
+        ].join('');
+        throw new this.serverless.classes.Error(errorMessage);
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:27:05,915 - thread-135845287823040.prometheus.lang_graph.nodes.git_reset_node - DEBUG - Resetting the git repository
2025-11-13 20:27:05,943 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting issue_feature_analyzer_messages in state.
2025-11-13 20:27:05,944 - thread-135845287823040.prometheus.lang_graph.nodes.reset_messages_node - DEBUG - Resetting edit_messages in state.
2025-11-13 20:27:05,947 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_message_node - DEBUG - Sending message to IssueFeatureAnalyzerNode:
content='I am going to share details about a feature request reported to a codebase and its related context.\nPlease analyze this feature request and provide a high-level description of what needs to be implemented:\n\n1. Feature Understanding:\n- Analyze the feature request title, description, and comments provided\n- Identify the desired functionality and requirements\n- Clarify any ambiguities or edge cases\n\n2. Architecture Analysis:\n- Identify which files, modules, or components need to be created or modified\n- Determine how this feature integrates with existing code\n- Consider architectural patterns and conventions from the codebase\n\n3. Implementation Plan:\nFor each needed change, describe in plain English:\n- Which file needs to be created or modified\n- Which classes, functions, or code blocks need to be added or changed\n- What needs to be implemented (e.g., "add new method to handle X", "create new service class for Y")\n- How this integrates with existing components\n\n4. Considerations:\n- Identify potential impacts on existing functionality\n- Consider backward compatibility\n- Note any dependencies or prerequisites\n\nDo NOT provide actual code snippets or diffs. Focus on describing what needs to be implemented.\n\nHere are the details for analysis:\n\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n\nFeature Context:\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n' additional_kwargs={} response_metadata={}
2025-11-13 20:27:38,189 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_O7WlrpNTWgKo2AQByXwIWsiA', 'function': {'arguments': '{"query":"serverless framework remove default request templates application/x-www-form-urlencoded mapping templates null request.template"}', 'name': 'web_search'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3048, 'prompt_tokens': 9771, 'total_tokens': 12819, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3008, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--29cd207f-62da-450c-b3cc-61b6f32d9f65-0' tool_calls=[{'name': 'web_search', 'args': {'query': 'serverless framework remove default request templates application/x-www-form-urlencoded mapping templates null request.template'}, 'id': 'call_O7WlrpNTWgKo2AQByXwIWsiA', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9771, 'output_tokens': 3048, 'total_tokens': 12819, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3008}}
2025-11-13 20:27:38,193 - thread-135845287823040.prometheus.tools.web_search - DEBUG - Query: serverless framework remove default request templates application/x-www-form-urlencoded mapping templates null request.template
2025-11-13 20:27:41,999 - thread-135845287823040.prometheus.tools.web_search - INFO - web_search format_response: Answer: To remove default request templates in Serverless Framework, set application/x-www-form-urlencoded mapping templates to null in the serverless.yml file. This removes the default template for form-urlencoded requests. Ensure no conflicts with other configurations.

Sources:
- Supported `null` properties are removed from ...: https://github.com/serverless/serverless/issues/10675
- `logs.restApi: true` fails to deploy · Issue #12637: https://github.com/serverless/serverless/issues/12637
- AWS API Gateway : Execution failed due to configuration ...: https://stackoverflow.com/questions/34120135/aws-api-gateway-execution-failed-due-to-configuration-error-no-match-for-outp
- API Gateway error "Unsupported Media Type" when trying ...: https://stackoverflow.com/questions/74585828/api-gateway-error-unsupported-media-type-when-trying-to-accept-application-x-w
- How to resolve local env vars in Serverless Framework V4?: https://stackoverflow.com/questions/78561289/how-to-resolve-local-env-vars-in-serverless-framework-v4

Detailed Results:

Title: Supported `null` properties are removed from ...
URL: https://github.com/serverless/serverless/issues/10675
Content: Should the strip function bypass resources that will be transformed? Or is there a better suggestion or workaround for this usage? Thanks.

Related PR: #10304  
Related issue: #10279

Example of a valid template, that hosts `null` values:

`null`

Proposed solution (added later by maintainers):

#### 1. Remove null value stripping from generated CF template

It's simple as removing this hook:

serverless/lib/plugins/aws/package/index.js

Lines 113 to 114
in
75ce58b [...] But CloudFormation template supports to include some transforms and macros that take those properties and transform to resources CFN allows. For example, `AWS::Serverless` is a transform CFN supports. The `ResultPath` specified in `Definition` property of `AWS::Serverless::StateMachine` resources accepts `null` value with certain purpose. Stripping them make the step functions not work as expected.

`AWS::Serverless`
`ResultPath`
`Definition`
`AWS::Serverless::StateMachine`
`null` [...] |  |  |
 --- |
|  | 'aws:package:finalize:stripNullPropsFromTemplateResources': () => |
|  | this.stripNullPropsFromTemplateResources(), |

#### 2. Remove `null` values from service configuration properties which are explicitly defined in the configuration schema

`null`

When service configuration is validated against JSON schema, we remove all `null` properties and then re-add it after validation (it's to mitigate ajv-validator/ajv#1287). This logic is placed here:

`null`

Title: `logs.restApi: true` fails to deploy · Issue #12637
URL: https://github.com/serverless/serverless/issues/12637
Content: path: /users/{userId}
integration: lambda
method: delete
request:
template:
application/x-www-form-urlencoded: null
application/json: |
{
"user_id": "$input.params().path.get('userId')",
${self:custom.authMapping}
}
passThrough: NEVER
response:
statusCodes:
200: okResponse
403: authError
404: notFoundError
500: unexpectedError
authorizer: auth
apiInfo:
handler: src/link/api.get_info
description: Returns relevant information about the app such as the base URL
events:
- http:
path: /info [...] cors:
origin: "${param:corsOrigin}"
request:
template:
application/x-www-form-urlencoded: null
application/json: |
{
${self:custom.authMapping}
}
response:
statusCodes:
204: okResponse
403: authError
500: unexpectedError
authorizer: auth
updateLink:
handler: src/link/api.update_link
description: Updates the link identified by its backhalf only if owned by the current user
events:
- http:
path: /links/{backhalf}
integration: lambda
method: patch
cors:
origin: "${param:corsOrigin}"
request: [...] statusCodes:
201: okResponse
400: userError
403: authError
500: unexpectedError
authorizer: auth
listLinks:
handler: src/link/api.list_links
description: Lists all the links owned by the current user
events:
- http:
path: /links
integration: lambda
method: get
cors:
origin: "${param:corsOrigin}"
request:
template:
application/x-www-form-urlencoded: null
application/json: |
{
${self:custom.authMapping}
}
response:
statusCodes:
200: okResponse
403: authError
500: unexpectedError
authorizer: auth

Title: AWS API Gateway : Execution failed due to configuration ...
URL: https://stackoverflow.com/questions/34120135/aws-api-gateway-execution-failed-due-to-configuration-error-no-match-for-outp
Content: ## 12 Answers 12

Reset to default

This answer is useful

27

Save this answer.

Show activity on this post.

I have same issue while uploading api using serverless framework. You can simply follow bellow steps which resolve my issue.

1- Navigate to aws api gateway   
2- find your api and click on method(Post, Get, Any, etc)  
3- click on method response  
4- Add method with 200 response.  
5- Save it & test

Share

CC BY-SA 4.0

Improve this answer [...] Commented
  Apr 5 at 0:28
 @ekydfejj Yes it was a quick fix but we need to use SAM/Cloud Formation code or maybe serverless configuration file with necessary code to resolve this error.

  – Mohmadhaidar devjiyani

  Commented
  Apr 14 at 11:06

Add a comment
 |

This answer is useful

17

Save this answer.

Show activity on this post.

I had the similar issue, got it resolved by adding the method response 200

Share

CC BY-SA 3.0

Improve this answer [...] This is a 'check-the-basics' type of answer. In my scenario, CORS and the bug mentioned above were not at issue. However, the error message given in the title is exactly what I saw and what led me to this thread.

Instead, (an an API Gateway newb) I had failed to redeploy the deployment. Once I did that, everything worked.

Title: API Gateway error "Unsupported Media Type" when trying ...
URL: https://stackoverflow.com/questions/74585828/api-gateway-error-unsupported-media-type-when-trying-to-accept-application-x-w
Content: I have also tried to add the following to the header of the test

```
"Content-Type": ["application/x-www-form-urlencoded"]
```

Many of the fixes I have tried involve changing the Integration Request mapping. None have worked. The one from the tutorial is: [...] 0")How to access twilio's request from the aws api gateway mapping template?

1")Twilio Client error: Twilio IP messaging with AWS Lambda / AWS API Gateway

2")Twilio API 415 un-supported media type error. Error - 11200

0")Unable to change Method Response header Content-Type to application/xml

5")Unable to send xml response with serverless framework

0")Amazon Api gateway integration with Twilio

0")AWS Cognito Integration with Twilio through API Gateway [...] I thought the following was very promising, but it also failed for me. 

I have also tried to change the lambda function. However I do not think it is the source. Its tests work.

Any help would be much appreciated.



, which will tell the API gateway to accept that body type.

Navigate to Api Gateway Console:

1.   Click on your API
2.   On the left select settings (under API menu)
3.   Scroll down and click Add Binary Media Type
4.   Type application/x-www-form-urlencoded Click save

Title: How to resolve local env vars in Serverless Framework V4?
URL: https://stackoverflow.com/questions/78561289/how-to-resolve-local-env-vars-in-serverless-framework-v4
Content: I've recently started a project using Serverless V4, but I'm not able to get the variables from my .env , I'm using serverless-offline as plugin, Node.js v21.7
2025-11-13 20:28:25,265 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_analyzer_node - DEBUG - content="Below is a high-level analysis and implementation plan to support removal of default API Gateway request mapping templates so that a function can advertise only supported content types (e.g., remove application/x-www-form-urlencoded while keeping application/json).\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Allow service authors to prevent Serverless Framework from automatically adding default API Gateway request mapping templates (currently both application/json and application/x-www-form-urlencoded are created for AWS/Lambda integration).\n  - This is needed to avoid advertising unsupported content types in API Gateway’s Swagger/OpenAPI export (e.g., avoid “consumes: application/x-www-form-urlencoded” when the API only supports JSON).\n  - The request highlights lack of a simple override/removal mechanism for defaults.\n\n- Requirements:\n  - Provide a configuration-level way to remove the default mapping template for specific content types, notably application/x-www-form-urlencoded.\n  - Ensure that when defaults are removed, the CloudFormation generated for API Gateway no longer contains RequestTemplates entries for removed content types.\n  - Preserve backward compatibility: endpoints should continue to have both default templates if no overrides are provided.\n\n- Ambiguities and edge cases:\n  - Removing all templates for AWS (non-proxy) integration can affect pass-through behavior (API Gateway may reject requests if passThrough is set to NEVER). We must ensure the docs clearly instruct users to configure passThrough appropriately (e.g., WHEN_NO_TEMPLATES) when removing all templates.\n  - Values provided for custom templates are strings; introducing “null” as an override must be handled carefully in the packaging step so that RequestTemplates do not include null entries (i.e., filtered out).\n  - Behavior for integration: AWS vs. AWS_PROXY vs. HTTP/MOCK: defaults are only applied to AWS integration. No change for AWS_PROXY, HTTP, MOCK (they don’t get defaults today).\n\n\n2) Architecture Analysis\n\n- Integration points:\n  - Default templates are added in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js by getIntegrationRequestTemplates(http, useDefaults).\n  - Request template merging happens in getIntegrationRequestTemplates: defaults are added first for AWS integration, then user-defined templates are merged on top.\n  - Validation logic for request configuration lives in lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js (getRequest, getRequestPassThrough, etc.).\n  - Method compilation merges integration output in lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js.\n\n- Files/modules to modify:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n    - Function: getIntegrationRequestTemplates(http, useDefaults)\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n    - Function: getRequest(http) (optional: enhance validation/warnings)\n    - Function: getRequestPassThrough(http) (no change required, but consider documentation guidance)\n  - docs/providers/aws/events/apigateway.md\n    - Sections describing Default Request Templates and Custom Request Templates\n    - Add a note and example showing how to remove a default template for a specific content type and implications for pass-through behavior.\n\n- Architectural conventions:\n  - Serverless uses object merging for request.templates; defaults are conditionally applied for AWS integration.\n  - Validation currently ensures types of request/template container but does not validate template value types in detail.\n\n\n3) Implementation Plan\n\n- Change 1: Support removal of default request templates by allowing “null” template values\n  - File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - Function to change: getIntegrationRequestTemplates(http, useDefaults)\n  - Logical change:\n    - After merging defaults and user-provided templates, iterate over integrationRequestTemplates and remove any entries whose value is null (and optionally false).\n    - This ensures that specifying application/x-www-form-urlencoded: null in serverless.yml results in that content type not being present in RequestTemplates in the generated CloudFormation.\n  - Integration with existing components:\n    - Defaults remain applied for AWS integration when no overrides are provided.\n    - Custom template definitions still overwrite defaults for given content types.\n    - Null entries are treated as explicit removals, providing a simple, per-endpoint opt-out.\n\n- Change 2: (Optional) Validation/warning when removing all templates under AWS integration\n  - File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n  - Function to change: getRequest(http)\n  - Logical change:\n    - Inspect http.request.template, and if all values are null or if user explicitly removes all templates and http.integration is 'AWS' while http.request.passThrough is not provided, emit a warning or throw a descriptive error suggesting setting passThrough to WHEN_NO_TEMPLATES (or WHEN_NO_MATCH depending on desired behavior).\n    - This is to prevent accidental 415 Unsupported Media Type due to the default pass-through behavior for AWS being NEVER.\n  - Integration with existing components:\n    - No change to getRequestPassThrough logic. The warning helps guide configuration to a valid state.\n    - Backward compatible: only triggers when a user removes all templates without passThrough.\n\n- Change 3: Documentation updates to advertise the removal mechanism and related pass-through behavior\n  - File to modify: docs/providers/aws/events/apigateway.md\n  - Sections to update:\n    - “Default Request Templates” and “Custom Request Templates”\n    - Add a subsection “Disabling Default Request Templates” that:\n      - Explains defaults (application/json and application/x-www-form-urlencoded) apply only to AWS integration.\n      - Shows configuration where request.template includes application/x-www-form-urlencoded with a null value to remove that content type.\n      - Notes that if all templates are removed, passThrough must be set (e.g., WHEN_NO_TEMPLATES) to avoid 415 errors under LAMBDA integration.\n    - Ensure content aligns with existing Pass Through Behavior section and explicitly mention the interaction.\n  - This ensures users can discover and correctly use the feature to avoid advertising unsupported content types in swagger export.\n\n- Change 4: Ensure RequestTemplates in CFN do not include null entries\n  - Covered by Change 1 (filtering step). No other files are impacted.\n\n- Tests (recommended):\n  - Add unit tests for getIntegrationRequestTemplates to verify:\n    - Default templates are present for AWS integration when no overrides are provided.\n    - Specifying application/x-www-form-urlencoded: null removes that template but keeps application/json.\n    - Specifying application/json: null removes JSON template and leaves form (if default not removed).\n    - When both are null, returned RequestTemplates is undefined or empty and does not include null entries.\n  - Verify end-to-end packaging does not emit null properties in CloudFormation for RequestTemplates.\n\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Default behavior remains unchanged for users not setting null overrides.\n  - Users can explicitly remove undesired content types per endpoint without affecting others.\n  - Swagger/OpenAPI “consumes” list, as inferred by API Gateway, will no longer include removed content types, addressing the reported issue.\n\n- Backward compatibility:\n  - Fully backward compatible; default templates remain unless a user sets a specific content type to null.\n  - No change to existing behavior of passThrough defaults; documentation clarifies necessary passThrough configuration when removing templates.\n\n- Dependencies/prerequisites:\n  - No new external dependencies.\n  - Ensure CloudFormation generation does not strip needed values or error on nulls; the filtering step removes null entries before emitting to CFN.\n  - Users relying on no mapping templates for AWS (non-proxy) integration should configure passThrough explicitly; document this requirement.\n\nSummary of concrete changes:\n\n- lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - Modify getIntegrationRequestTemplates to filter out keys whose values are null (and optionally false), after merging defaults and custom templates.\n\n- lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n  - Optionally enhance getRequest to detect “all templates removed with AWS integration” and emit a helper warning suggesting passThrough configuration.\n\n- docs/providers/aws/events/apigateway.md\n  - Update Default Request Templates and Custom Request Templates sections to include guidance on removing defaults via null and how to set passThrough accordingly." additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 4463, 'prompt_tokens': 11571, 'total_tokens': 16034, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2752, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9728}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--8cbca15e-eeb1-4de0-8f03-86981c9909e8-0' usage_metadata={'input_tokens': 11571, 'output_tokens': 4463, 'total_tokens': 16034, 'input_token_details': {'audio': 0, 'cache_read': 9728}, 'output_token_details': {'audio': 0, 'reasoning': 2752}}
2025-11-13 20:28:25,270 - thread-135845287823040.prometheus.lang_graph.nodes.edit_message_node - DEBUG - Sending message to EditNode:
content='--- BEGIN ISSUE INFO ---\nIssue title:\nAllow for the removal of default request mapping templates\n\nIssue description: \nCurrently [default request mapping templates are created ](https://github.com/serverless/serverless/blob/v1.58.0/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js#L189) both for application/json and application/x-www-form-urlencoded. There does not appear to be a simple method for overriding this default. In our application we only support the application/json content type however application/x-www-form-urlencoded is being automatically created even though it is not supported by our application. Even worse, when generating swagger documentation via the AWS API Gateway this forces us advertise that we consume both:\n\n"consumes": [\n          "application/json",\n          "application/x-www-form-urlencoded"\n        ],\n\nIMO, there really should be a way of overriding defaults in any application. If you can suggest any workaround to this it would be great\n\n\nIssue comments:\n\n--- END ISSUE INFO ---\n\nContext Found:\n--- BEGIN CONTEXT ---\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 706 - 833\nContent:\n706. service: my-service\n707. provider:\n708.   name: aws\n709.   endpointType: REGIONAL\n710. functions:\n711.   hello:\n712.     events:\n713.       - http:\n714.           path: user/create\n715.           method: get\n716. ```\n717. \n718. API Gateway also supports the association of VPC endpoints if you have an API Gateway REST API using the PRIVATE endpoint configuration. This feature simplifies the invocation of a private API through the generation of the following AWS Route 53 alias:\n719. \n720. ```\n721. https://<rest_api_id>-<vpc_endpoint_id>.execute-api.<aws_region>.amazonaws.com\n722. ```\n723. \n724. Here\'s an example configuration:\n725. \n726. ```yml\n727. service: my-service\n728. provider:\n729.   name: aws\n730.   endpointType: PRIVATE\n731.   vpcEndpointIds:\n732.     - vpce-123\n733.     - vpce-456\n734. ```\n735. \n736. ### Request Parameters\n737. \n738. To pass optional and required parameters to your functions, so you can use them in API Gateway tests and SDK generation, marking them as `true` will make them required, `false` will make them optional.\n739. \n740. ```yml\n741. functions:\n742.   create:\n743.     handler: posts.create\n744.     events:\n745.       - http:\n746.           path: posts/create\n747.           method: post\n748.           request:\n749.             parameters:\n750.               querystrings:\n751.                 url: true\n752.               headers:\n753.                 foo: false\n754.               paths:\n755.                 bar: false\n756. ```\n757. \n758. In order for path variables to work, API Gateway also needs them in the method path itself, like so:\n759. \n760. ```yml\n761. functions:\n762.   create:\n763.     handler: posts.post_detail\n764.     events:\n765.       - http:\n766.           path: posts/{id}\n767.           method: get\n768.           request:\n769.             parameters:\n770.               paths:\n771.                 id: true\n772. ```\n773. \n774. To map different values for request parameters, define the `required` and `mappedValue` properties of the request parameter.\n775. \n776. ```yml\n777. functions:\n778.   create:\n779.     handler: posts.post_detail\n780.     events:\n781.       - http:\n782.           path: posts/{id}\n783.           method: get\n784.           request:\n785.             parameters:\n786.               paths:\n787.                 id: true\n788.               headers:\n789.                 custom-header:\n790.                   required: true\n791.                   mappedValue: context.requestId\n792. ```\n793. \n794. For a list of acceptable values, see the [AWS Documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html)\n795. \n796. ### Request Schema Validators\n797. \n798. To use request schema validation with API gateway, add the [JSON Schema](https://json-schema.org/)\n799. for your content type. Since JSON Schema is represented in JSON, it\'s easier to include it from a\n800. file.\n801. \n802. ```yml\n803. functions:\n804.   create:\n805.     handler: posts.create\n806.     events:\n807.       - http:\n808.           path: posts/create\n809.           method: post\n810.           request:\n811.             schema:\n812.               application/json: ${file(create_request.json)}\n813. ```\n814. \n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 815 - 975\nContent:\n815. A sample schema contained in `create_request.json` might look something like this:\n816. \n817. ```json\n818. {\n819.   "definitions": {},\n820.   "$schema": "http://json-schema.org/draft-04/schema#",\n821.   "type": "object",\n822.   "title": "The Root Schema",\n823.   "required": ["username"],\n824.   "properties": {\n825.     "username": {\n826.       "type": "string",\n827.       "title": "The Foo Schema",\n828.       "default": "",\n829.       "pattern": "^[a-zA-Z0-9]+$"\n830.     }\n831.   }\n832. }\n833. ```\n834. \n835. **NOTE:** schema validators are only applied to content types you specify. Other content types are\n836. not blocked. Currently, API Gateway [supports](https://docs.aws.amazon.com/apigateway/latest/developerguide/models-mappings.html) JSON Schema draft-04.\n837. \n838. ### Setting source of API key for metering requests\n839. \n840. API Gateway provide a feature for metering your API\'s requests and you can choice [the source of key](https://docs.aws.amazon.com/apigateway/api-reference/resource/rest-api/#apiKeySource) which is used for metering. If you want to acquire that key from the request\'s X-API-Key header, set option like this:\n841. \n842. ```yml\n843. service: my-service\n844. provider:\n845.   name: aws\n846.   apiGateway:\n847.     apiKeySourceType: HEADER\n848. functions:\n849.   hello:\n850.     events:\n851.       - http:\n852.           path: hello\n853.           method: get\n854. ```\n855. \n856. Another option is AUTHORIZER. If you set this, API Gateway will acquire that key from UsageIdentifierKey which is provided by custom authorizer.\n857. \n858. ```yml\n859. service: my-service\n860. provider:\n861.   name: aws\n862.   apiGateway:\n863.     apiKeySourceType: AUTHORIZER\n864. functions:\n865.   hello:\n866.     events:\n867.       - http:\n868.           path: hello\n869.           method: get\n870. ```\n871. \n872. ## Lambda Integration\n873. \n874. This method is more complicated and involves a lot more configuration of the `http` event syntax.\n875. \n876. ### Example "LAMBDA" event (before customization)\n877. \n878. **Refer to this only if you\'re using the non-default `LAMBDA` integration method**\n879. \n880. ```json\n881. {\n882.   "body": {},\n883.   "method": "GET",\n884.   "principalId": "",\n885.   "stage": "dev",\n886.   "cognitoPoolClaims": {\n887.     "sub": ""\n888.   },\n889.   "enhancedAuthContext": {},\n890.   "headers": {\n891.     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",\n892.     "Accept-Encoding": "gzip, deflate, br",\n893.     "Accept-Language": "en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4",\n894.     "CloudFront-Forwarded-Proto": "https",\n895.     "CloudFront-Is-Desktop-Viewer": "true",\n896.     "CloudFront-Is-Mobile-Viewer": "false",\n897.     "CloudFront-Is-SmartTV-Viewer": "false",\n898.     "CloudFront-Is-Tablet-Viewer": "false",\n899.     "CloudFront-Viewer-Country": "GB",\n900.     "Host": "ec5ycylws8.execute-api.us-east-1.amazonaws.com",\n901.     "upgrade-insecure-requests": "1",\n902.     "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n903.     "Via": "2.0 f165ce34daf8c0da182681179e863c24.cloudfront.net (CloudFront)",\n904.     "X-Amz-Cf-Id": "l06CAg2QsrALeQcLAUSxGXbm8lgMoMIhR2AjKa4AiKuaVnnGsOFy5g==",\n905.     "X-Amzn-Trace-Id": "Root=1-5970ef20-3e249c0321b2eef14aa513ae",\n906.     "X-Forwarded-For": "94.117.120.169, 116.132.62.73",\n907.     "X-Forwarded-Port": "443",\n908.     "X-Forwarded-Proto": "https"\n909.   },\n910.   "query": {},\n911.   "path": {},\n912.   "identity": {\n913.     "cognitoIdentityPoolId": "",\n914.     "accountId": "",\n915.     "cognitoIdentityId": "",\n916.     "caller": "",\n917.     "apiKey": "",\n918.     "sourceIp": "94.197.120.169",\n919.     "accessKey": "",\n920.     "cognitoAuthenticationType": "",\n921.     "cognitoAuthenticationProvider": "",\n922.     "userArn": "",\n923.     "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36",\n924.     "user": ""\n925.   },\n926.   "stageVariables": {},\n927.   "requestPath": "/request/path"\n928. }\n929. ```\n930. \n931. ### Request templates\n932. \n933. #### Default Request Templates\n934. \n935. Serverless ships with the following default request templates you can use out of the box:\n936. \n937. 1. `application/json`\n938. 2. `application/x-www-form-urlencoded`\n939. \n940. Both templates give you access to the following properties you can access with the help of the `event` object:\n941. \n942. - body\n943. - method\n944. - principalId\n945. - stage\n946. - headers\n947. - queryStringParameters\n948. - path\n949. - identity\n950. - stageVariables\n951. - requestPath\n952. \n953. #### Custom Request Templates\n954. \n955. However you can define and use your own request templates as follows (you can even overwrite the default request templates\n956. by defining a new request template for an existing content type):\n957. \n958. ```yml\n959. functions:\n960.   create:\n961.     handler: posts.create\n962.     events:\n963.       - http:\n964.           method: get\n965.           path: whatever\n966.           integration: lambda\n967.           request:\n968.             template:\n969.               text/xhtml: \'{ "stage" : "$context.stage" }\'\n970.               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n971. ```\n972. \n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 973 - 1081\nContent:\n973. **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n974. \n975. **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n976. \n977. If you want to map querystrings to the event object, you can use the `$input.params(\'hub.challenge\')` syntax from API Gateway, as follows:\n978. \n979. ```yml\n980. functions:\n981.   create:\n982.     handler: posts.create\n983.     events:\n984.       - http:\n985.           method: get\n986.           path: whatever\n987.           integration: lambda\n988.           request:\n989.             template:\n990.               application/json: \'{ "foo" : "$input.params(\'\'bar\'\')" }\'\n991. ```\n992. \n993. **Note:** Notice when using single-quoted strings, any single quote `\'` inside its contents must be doubled (`\'\'`) to escape it.\n994. You can then access the query string `https://example.com/dev/whatever?bar=123` by `event.foo` in the lambda function.\n995. If you want to spread a string into multiple lines, you can use the `>` or `|` syntax, but the following strings have to be all indented with the same amount, [read more about `>` syntax](http://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines).\n996. \n997. #### Pass Through Behavior\n998. \n999. [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n1000. \n1001. You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n1002. \n1003. ```yml\n1004. functions:\n1005.   create:\n1006.     handler: posts.create\n1007.     events:\n1008.       - http:\n1009.           method: get\n1010.           path: whatever\n1011.           integration: lambda\n1012.           request:\n1013.             passThrough: NEVER\n1014. ```\n1015. \n1016. There are 3 available options:\n1017. \n1018. | Value             | Passed Through When                          | Rejected When                                                          |\n1019. | ----------------- | -------------------------------------------- | ---------------------------------------------------------------------- |\n1020. | NEVER             | Never                                        | No templates defined or Content-Type does not match a defined template |\n1021. | WHEN_NO_MATCH     | Content-Type does not match defined template | Never                                                                  |\n1022. | WHEN_NO_TEMPLATES | No templates were defined                    | One or more templates defined, but Content-Type does not match         |\n1023. \n1024. See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/integration-passthrough-behaviors.html) for detailed descriptions of these options.\n1025. \n1026. **Notes:**\n1027. \n1028. - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n1029. - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n1030. \n1031. ### Responses\n1032. \n1033. Serverless lets you setup custom headers and a response template for your `http` event.\n1034. \n1035. #### Custom Response Headers\n1036. \n1037. Here\'s an example which shows you how you can setup a custom response header:\n1038. \n1039. ```yml\n1040. functions:\n1041.   create:\n1042.     handler: posts.create\n1043.     events:\n1044.       - http:\n1045.           method: get\n1046.           path: whatever\n1047.           integration: lambda\n1048.           response:\n1049.             headers:\n1050.               Content-Type: integration.response.header.Content-Type\n1051.               Cache-Control: "\'max-age=120\'"\n1052. ```\n1053. \n1054. **Note:** You\'re able to use the [integration response variables](http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html#mapping-response-parameters)\n1055. for your header values. Headers are passed to API Gateway exactly like you define them. Passing the `Cache-Control` header\n1056. as `"\'max-age=120\'"` means API Gateway will receive the value as `\'max-age=120\'` (enclosed with single quotes).\n1057. \n1058. #### Custom Response Templates\n1059. \n1060. Sometimes you\'ll want to define a custom response template API Gateway should use to transform your lambdas output.\n1061. Here\'s an example which will transform the return value of your lambda so that the browser renders it as HTML:\n1062. \n1063. ```yml\n1064. functions:\n1065.   create:\n1066.     handler: posts.create\n1067.     events:\n1068.       - http:\n1069.           method: get\n1070.           path: whatever\n1071.           integration: lambda\n1072.           response:\n1073.             headers:\n1074.               Content-Type: "\'text/html\'"\n1075.             template: $input.path(\'$\')\n1076. ```\n1077. \n1078. **Note:** The template is defined as plain text here. However you can also reference an external file with the help of\n1079. the `${file(templatefile)}` syntax.\n1080. \n1081. ### Status Codes\n\n\nFile: docs/providers/aws/events/apigateway.md\nLine number range: 1484 - 1638\nContent:\n1484. ```yml\n1485. service: service-c\n1486. \n1487. provider:\n1488.   apiGateway:\n1489.     restApiId:\n1490.       \'Fn::ImportValue\': apiGateway-restApiId\n1491.     restApiRootResourceId:\n1492.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1493. \n1494. functions:\n1495.   deleteUser:\n1496.     events:\n1497.       - http:\n1498.         path: /users/{userId}\n1499.         authorizer:\n1500.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1501. ```\n1502. \n1503. ```yml\n1504. service: service-d\n1505. \n1506. provider:\n1507.   apiGateway:\n1508.     restApiId:\n1509.       \'Fn::ImportValue\': apiGateway-restApiId\n1510.     restApiRootResourceId:\n1511.       \'Fn::ImportValue\': apiGateway-rootResourceId\n1512. \n1513. functions:\n1514.   deleteProject:\n1515.     events:\n1516.       - http:\n1517.         path: /project/{projectId}\n1518.         authorizer:\n1519.           arn: xxxxxxxxxxxxxxxxx #cognito/custom authorizer arn\n1520. ```\n1521. \n1522. we encounter error from cloudformation as reported [here](https://github.com/serverless/serverless/issues/4711).\n1523. \n1524. A proper fix for this is work is using [Share Authorizer](#share-authorizer) or you can add a unique `name` attribute to `authorizer` in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development.\n1525. \n1526. ## Share Authorizer\n1527. \n1528. Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use `COGNITO_USER_POOLS` authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do.\n1529. \n1530. ```yml\n1531. functions:\n1532.   createUser:\n1533.      ...\n1534.     events:\n1535.       - http:\n1536.           path: /users\n1537.           ...\n1538.           authorizer:\n1539.             # Provide both type and authorizerId\n1540.             type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1541.             authorizerId:\n1542.               Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID\n1543.             scopes: # Optional - List of Oauth2 scopes when type is COGNITO_USER_POOLS\n1544.               - myapp/myscope\n1545. \n1546.   deleteUser:\n1547.      ...\n1548.     events:\n1549.       - http:\n1550.           path: /users/{userId}\n1551.           ...\n1552.           # Provide both type and authorizerId\n1553.           type: COGNITO_USER_POOLS # TOKEN or REQUEST or COGNITO_USER_POOLS, same as AWS Cloudformation documentation\n1554.           authorizerId:\n1555.             Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID\n1556. \n1557. resources:\n1558.   Resources:\n1559.     ApiGatewayAuthorizer:\n1560.       Type: AWS::ApiGateway::Authorizer\n1561.       Properties:\n1562.         AuthorizerResultTtlInSeconds: 300\n1563.         IdentitySource: method.request.header.Authorization\n1564.         Name: Cognito\n1565.         RestApiId:\n1566.           Ref: YourApiGatewayName\n1567.         Type: COGNITO_USER_POOLS\n1568.         ProviderARNs:\n1569.           - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool/abcdef\n1570. \n1571. ```\n1572. \n1573. ## Resource Policy\n1574. \n1575. Resource policies are policy documents that are used to control the invocation of the API. Find more use cases from the [Apigateway Resource Policies](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html) documentation.\n1576. \n1577. ```yml\n1578. provider:\n1579.   name: aws\n1580.   runtime: nodejs12.x\n1581. \n1582.   resourcePolicy:\n1583.     - Effect: Allow\n1584.       Principal: \'*\'\n1585.       Action: execute-api:Invoke\n1586.       Resource:\n1587.         - execute-api:/*/*/*\n1588.       Condition:\n1589.         IpAddress:\n1590.           aws:SourceIp:\n1591.             - \'123.123.123.123\'\n1592. ```\n1593. \n1594. ## Compression\n1595. \n1596. API Gateway allows for clients to receive [compressed payloads](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-gzip-compression-decompression.html), and supports various [content encodings](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-enable-compression.html#api-gateway-supported-content-encodings).\n1597. \n1598. ```yml\n1599. provider:\n1600.   name: aws\n1601.   apiGateway:\n1602.     minimumCompressionSize: 1024\n1603. ```\n1604. \n1605. ## Binary Media Types\n1606. \n1607. API Gateway makes it possible to return binary media such as images or files as responses.\n1608. \n1609. Configuring API Gateway to return binary media can be done via the `binaryMediaTypes` config:\n1610. \n1611. ```yml\n1612. provider:\n1613.   apiGateway:\n1614.     binaryMediaTypes:\n1615.       - \'*/*\'\n1616. ```\n1617. \n1618. In your Lambda function you need to ensure that the correct `content-type` header is set. Furthermore you might want to return the response body in base64 format.\n1619. \n1620. To convert the request or response payload, you can set the [contentHandling](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html) property (if set, the response contentHandling property will be passed to integration responses with 2XXs method response statuses).\n1621. \n1622. ```yml\n1623. functions:\n1624.   create:\n1625.     handler: posts.create\n1626.     events:\n1627.       - http:\n1628.           path: posts/create\n1629.           method: post\n1630.           request:\n1631.             contentHandling: CONVERT_TO_TEXT\n1632.           response:\n1633.             contentHandling: CONVERT_TO_TEXT\n1634. ```\n1635. \n1636. ## Detailed CloudWatch Metrics\n1637. \n1638. Use the following configuration to enable detailed CloudWatch Metrics:\n\n\nFile: lib/configSchema.js\nLine number range: 36 - 73\nContent:\n36.     functions: {\n37.       type: \'object\',\n38.       patternProperties: {\n39.         [functionNamePattern]: {\n40.           type: \'object\',\n41.           properties: {\n42.             name: { type: \'string\' }, // name property is added by service class\n43.             events: {\n44.               type: \'array\',\n45.               items: {\n46.                 /*\n47.                  * `anyOf` array by JSON schema spec cannot be empty, threfore we start\n48.                  * with one dummy item as workaround to ensure it validates against\n49.                  * any undefined function events.\n50.                  */\n51.                 anyOf: [\n52.                   {\n53.                     type: \'object\',\n54.                     properties: { __schemaWorkaround__: { const: null } },\n55.                     required: [\'__schemaWorkaround__\'],\n56.                     additionalProperties: false,\n57.                   },\n58.                 ],\n59.               },\n60.             },\n61.           },\n62. \n63.           /*\n64.            * Schema for function properties is extended by a provider plugin.\n65.            * For example, in the context of AWS provider props like\n66.            * provisionedConcurrency, memorySize, reservedConcurrency, etc.\n67.            * should be extended by awsProvider plugin.\n68.            */\n69.           additionalProperties: false,\n70.         },\n71.       },\n72.       additionalProperties: false,\n73.     },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 14 - 22\nContent:\n14. const compileMethods = require(\'./lib/method/index\');\n15. const compileAuthorizers = require(\'./lib/authorizers\');\n16. const compileDeployment = require(\'./lib/deployment\');\n17. const compilePermissions = require(\'./lib/permissions\');\n18. const compileStage = require(\'./lib/stage\');\n19. const getMethodAuthorization = require(\'./lib/method/authorization\');\n20. const getMethodIntegration = require(\'./lib/method/integration\');\n21. const getMethodResponses = require(\'./lib/method/responses\');\n22. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 29 - 33\nContent:\n29.     this.serverless.configSchemaHandler.defineFunctionEvent(\'aws\', \'http\', {\n30.       // TODO: Complete schema, see https://github.com/serverless/serverless/issues/8018\n31.       anyOf: [{ type: \'string\' }, { type: \'object\' }],\n32.     });\n33. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/index.js\nLine number range: 37 - 54\nContent:\n37.     Object.assign(\n38.       this,\n39.       validate,\n40.       compileRestApi,\n41.       compileApiKeys,\n42.       compileUsagePlan,\n43.       compileUsagePlanKeys,\n44.       compileResources,\n45.       compileCors,\n46.       compileMethods,\n47.       compileAuthorizers,\n48.       compileDeployment,\n49.       compilePermissions,\n50.       compileStage,\n51.       getMethodAuthorization,\n52.       getMethodIntegration,\n53.       getMethodResponses\n54.     );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 61 - 69\nContent:\n61.       _.merge(\n62.         template,\n63.         this.getMethodAuthorization(event.http),\n64.         this.getMethodIntegration(event.http, {\n65.           lambdaLogicalId,\n66.           lambdaAliasName,\n67.         }),\n68.         this.getMethodResponses(event.http)\n69.       );\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js\nLine number range: 85 - 93\nContent:\n85.       const requestTemplates = template.Properties.Integration.RequestTemplates;\n86.       _.forEach(requestTemplates, (value, key) => {\n87.         let claimsString = \'\';\n88.         if (extraCognitoPoolClaims && extraCognitoPoolClaims.length > 0) {\n89.           claimsString = extraCognitoPoolClaims.join(\',\').concat(\',\');\n90.         }\n91.         requestTemplates[key] = value.replace(\'extraCognitoPoolClaims\', claimsString);\n92.       });\n93. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 5 - 49\nContent:\n5. const DEFAULT_COMMON_TEMPLATE = `\n6.   #define( $loop )\n7.     {\n8.     #foreach($key in $map.keySet())\n9.         #set( $k = $util.escapeJavaScript($key) )\n10.         #set( $v = $util.escapeJavaScript($map.get($key)).replaceAll("\\\\\\\\\'", "\'") )\n11.         "$k":\n12.           "$v"\n13.           #if( $foreach.hasNext ) , #end\n14.     #end\n15.     }\n16.   #end\n17. \n18.   {\n19.     "body": $body,\n20.     "method": "$context.httpMethod",\n21.     "principalId": "$context.authorizer.principalId",\n22.     "stage": "$context.stage",\n23. \n24.     "cognitoPoolClaims" : {\n25.        extraCognitoPoolClaims\n26.        "sub": "$context.authorizer.claims.sub"\n27.     },\n28. \n29.     #set( $map = $context.authorizer )\n30.     "enhancedAuthContext": $loop,\n31. \n32.     #set( $map = $input.params().header )\n33.     "headers": $loop,\n34. \n35.     #set( $map = $input.params().querystring )\n36.     "query": $loop,\n37. \n38.     #set( $map = $input.params().path )\n39.     "path": $loop,\n40. \n41.     #set( $map = $context.identity )\n42.     "identity": $loop,\n43. \n44.     #set( $map = $stageVariables )\n45.     "stageVariables": $loop,\n46. \n47.     "requestPath": "$context.resourcePath"\n48.   }\n49. `;\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 100 - 107\nContent:\n100.     if (type === \'AWS\' || type === \'HTTP\' || type === \'MOCK\') {\n101.       Object.assign(integration, {\n102.         PassthroughBehavior: http.request && http.request.passThrough,\n103.         ContentHandling: http.request && http.request.contentHandling,\n104.         RequestTemplates: this.getIntegrationRequestTemplates(http, type === \'AWS\'),\n105.         IntegrationResponses: this.getIntegrationResponses(http),\n106.       });\n107.     }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 198 - 218\nContent:\n198.   getIntegrationRequestTemplates(http, useDefaults) {\n199.     // default request templates\n200.     const integrationRequestTemplates = {};\n201. \n202.     // Only set defaults for AWS (lambda) integration\n203.     if (useDefaults) {\n204.       Object.assign(integrationRequestTemplates, {\n205.         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n206.         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n207.       });\n208.     }\n209. \n210.     // set custom request templates if provided\n211.     if (http.request && typeof http.request.template === \'object\') {\n212.       Object.assign(integrationRequestTemplates, http.request.template);\n213.     }\n214. \n215.     return Object.keys(integrationRequestTemplates).length\n216.       ? integrationRequestTemplates\n217.       : undefined;\n218.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 234 - 239\nContent:\n234.   DEFAULT_JSON_REQUEST_TEMPLATE: `\n235.     #set( $body = $input.json("$") )\n236. \n237.     ${DEFAULT_COMMON_TEMPLATE}\n238.   `,\n239. \n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nLine number range: 240 - 261\nContent:\n240.   DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE: `\n241.     #define( $body )\n242.       {\n243.       #foreach( $token in $input.path(\'$\').split(\'&\') )\n244.         #set( $keyVal = $token.split(\'=\') )\n245.         #set( $keyValSize = $keyVal.size() )\n246.         #if( $keyValSize >= 1 )\n247.           #set( $key = $util.escapeJavaScript($util.urlDecode($keyVal[0])) )\n248.           #if( $keyValSize >= 2 )\n249.             #set($val = $util.escapeJavaScript($util.urlDecode($keyVal[1])).replaceAll("\\\\\\\\\'","\'"))\n250.           #else\n251.             #set( $val = \'\' )\n252.           #end\n253.           "$key": "$val"#if($foreach.hasNext),#end\n254.         #end\n255.       #end\n256.       }\n257.     #end\n258. \n259.     ${DEFAULT_COMMON_TEMPLATE}\n260.   `,\n261. };\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 491 - 508\nContent:\n491.   getRequest(http) {\n492.     if (http.request) {\n493.       const request = http.request;\n494. \n495.       if (typeof http.request !== \'object\') {\n496.         const errorMessage = [\n497.           \'Request config must be provided as an object.\',\n498.           \' Please check the docs for more info.\',\n499.         ].join(\'\');\n500.         throw new this.serverless.classes.Error(errorMessage);\n501.       }\n502.       if (http.request.template && typeof http.request.template !== \'object\') {\n503.         const errorMessage = [\n504.           \'Template config must be provided as an object.\',\n505.           \' Please check the docs for more info.\',\n506.         ].join(\'\');\n507.         throw new this.serverless.classes.Error(errorMessage);\n508.       }\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 520 - 532\nContent:\n520.   getRequestParameters(httpRequest) {\n521.     const parameters = {};\n522.     // only these locations are currently supported\n523.     const locations = [\'querystrings\', \'paths\', \'headers\'];\n524.     locations.forEach(location => {\n525.       // strip the plural s\n526.       const singular = location.substring(0, location.length - 1);\n527.       _.forEach(httpRequest.parameters[location], (value, key) => {\n528.         parameters[`method.request.${singular}.${key}`] = value;\n529.       });\n530.     });\n531.     return parameters;\n532.   },\n\n\nFile: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nLine number range: 534 - 561\nContent:\n534.   getRequestPassThrough(http) {\n535.     const requestPassThroughBehaviors = [\'NEVER\', \'WHEN_NO_MATCH\', \'WHEN_NO_TEMPLATES\'];\n536. \n537.     if (http.request.passThrough) {\n538.       if (requestPassThroughBehaviors.indexOf(http.request.passThrough) === -1) {\n539.         const errorMessage = [\n540.           \'Request passThrough "\',\n541.           http.request.passThrough,\n542.           \'" is not one of \',\n543.           requestPassThroughBehaviors.join(\', \'),\n544.         ].join(\'\');\n545.         throw new this.serverless.classes.Error(errorMessage);\n546.       }\n547. \n548.       return http.request.passThrough;\n549.     }\n550. \n551.     // Validate() sets the passThrough default to NEVER. This is inappropriate\n552.     // for HTTP and MOCK integrations, where there is no default request template defined.\n553.     const type = http.integration || \'AWS_PROXY\';\n554.     if (type === \'AWS\') {\n555.       return requestPassThroughBehaviors[0];\n556.     } else if (type === \'HTTP\' || type === \'MOCK\') {\n557.       return undefined;\n558.     }\n559. \n560.     return \'WHEN_NO_MATCH\';\n561.   },\n\n--- END CONTEXT ---\nThese context should be enough to help you make the necessary code edits. Do NOT explore for more context in the codebase!\n\nAnalyzer agent has analyzed the issue and provided instruction on the issue:\n--- BEGIN ANALYZER MESSAGE ---\nBelow is a high-level analysis and implementation plan to support removal of default API Gateway request mapping templates so that a function can advertise only supported content types (e.g., remove application/x-www-form-urlencoded while keeping application/json).\n\n1) Feature Understanding\n\n- Requested functionality:\n  - Allow service authors to prevent Serverless Framework from automatically adding default API Gateway request mapping templates (currently both application/json and application/x-www-form-urlencoded are created for AWS/Lambda integration).\n  - This is needed to avoid advertising unsupported content types in API Gateway’s Swagger/OpenAPI export (e.g., avoid “consumes: application/x-www-form-urlencoded” when the API only supports JSON).\n  - The request highlights lack of a simple override/removal mechanism for defaults.\n\n- Requirements:\n  - Provide a configuration-level way to remove the default mapping template for specific content types, notably application/x-www-form-urlencoded.\n  - Ensure that when defaults are removed, the CloudFormation generated for API Gateway no longer contains RequestTemplates entries for removed content types.\n  - Preserve backward compatibility: endpoints should continue to have both default templates if no overrides are provided.\n\n- Ambiguities and edge cases:\n  - Removing all templates for AWS (non-proxy) integration can affect pass-through behavior (API Gateway may reject requests if passThrough is set to NEVER). We must ensure the docs clearly instruct users to configure passThrough appropriately (e.g., WHEN_NO_TEMPLATES) when removing all templates.\n  - Values provided for custom templates are strings; introducing “null” as an override must be handled carefully in the packaging step so that RequestTemplates do not include null entries (i.e., filtered out).\n  - Behavior for integration: AWS vs. AWS_PROXY vs. HTTP/MOCK: defaults are only applied to AWS integration. No change for AWS_PROXY, HTTP, MOCK (they don’t get defaults today).\n\n\n2) Architecture Analysis\n\n- Integration points:\n  - Default templates are added in lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js by getIntegrationRequestTemplates(http, useDefaults).\n  - Request template merging happens in getIntegrationRequestTemplates: defaults are added first for AWS integration, then user-defined templates are merged on top.\n  - Validation logic for request configuration lives in lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js (getRequest, getRequestPassThrough, etc.).\n  - Method compilation merges integration output in lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.js.\n\n- Files/modules to modify:\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n    - Function: getIntegrationRequestTemplates(http, useDefaults)\n  - lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n    - Function: getRequest(http) (optional: enhance validation/warnings)\n    - Function: getRequestPassThrough(http) (no change required, but consider documentation guidance)\n  - docs/providers/aws/events/apigateway.md\n    - Sections describing Default Request Templates and Custom Request Templates\n    - Add a note and example showing how to remove a default template for a specific content type and implications for pass-through behavior.\n\n- Architectural conventions:\n  - Serverless uses object merging for request.templates; defaults are conditionally applied for AWS integration.\n  - Validation currently ensures types of request/template container but does not validate template value types in detail.\n\n\n3) Implementation Plan\n\n- Change 1: Support removal of default request templates by allowing “null” template values\n  - File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - Function to change: getIntegrationRequestTemplates(http, useDefaults)\n  - Logical change:\n    - After merging defaults and user-provided templates, iterate over integrationRequestTemplates and remove any entries whose value is null (and optionally false).\n    - This ensures that specifying application/x-www-form-urlencoded: null in serverless.yml results in that content type not being present in RequestTemplates in the generated CloudFormation.\n  - Integration with existing components:\n    - Defaults remain applied for AWS integration when no overrides are provided.\n    - Custom template definitions still overwrite defaults for given content types.\n    - Null entries are treated as explicit removals, providing a simple, per-endpoint opt-out.\n\n- Change 2: (Optional) Validation/warning when removing all templates under AWS integration\n  - File to modify: lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n  - Function to change: getRequest(http)\n  - Logical change:\n    - Inspect http.request.template, and if all values are null or if user explicitly removes all templates and http.integration is \'AWS\' while http.request.passThrough is not provided, emit a warning or throw a descriptive error suggesting setting passThrough to WHEN_NO_TEMPLATES (or WHEN_NO_MATCH depending on desired behavior).\n    - This is to prevent accidental 415 Unsupported Media Type due to the default pass-through behavior for AWS being NEVER.\n  - Integration with existing components:\n    - No change to getRequestPassThrough logic. The warning helps guide configuration to a valid state.\n    - Backward compatible: only triggers when a user removes all templates without passThrough.\n\n- Change 3: Documentation updates to advertise the removal mechanism and related pass-through behavior\n  - File to modify: docs/providers/aws/events/apigateway.md\n  - Sections to update:\n    - “Default Request Templates” and “Custom Request Templates”\n    - Add a subsection “Disabling Default Request Templates” that:\n      - Explains defaults (application/json and application/x-www-form-urlencoded) apply only to AWS integration.\n      - Shows configuration where request.template includes application/x-www-form-urlencoded with a null value to remove that content type.\n      - Notes that if all templates are removed, passThrough must be set (e.g., WHEN_NO_TEMPLATES) to avoid 415 errors under LAMBDA integration.\n    - Ensure content aligns with existing Pass Through Behavior section and explicitly mention the interaction.\n  - This ensures users can discover and correctly use the feature to avoid advertising unsupported content types in swagger export.\n\n- Change 4: Ensure RequestTemplates in CFN do not include null entries\n  - Covered by Change 1 (filtering step). No other files are impacted.\n\n- Tests (recommended):\n  - Add unit tests for getIntegrationRequestTemplates to verify:\n    - Default templates are present for AWS integration when no overrides are provided.\n    - Specifying application/x-www-form-urlencoded: null removes that template but keeps application/json.\n    - Specifying application/json: null removes JSON template and leaves form (if default not removed).\n    - When both are null, returned RequestTemplates is undefined or empty and does not include null entries.\n  - Verify end-to-end packaging does not emit null properties in CloudFormation for RequestTemplates.\n\n\n4) Considerations\n\n- Impact on existing functionality:\n  - Default behavior remains unchanged for users not setting null overrides.\n  - Users can explicitly remove undesired content types per endpoint without affecting others.\n  - Swagger/OpenAPI “consumes” list, as inferred by API Gateway, will no longer include removed content types, addressing the reported issue.\n\n- Backward compatibility:\n  - Fully backward compatible; default templates remain unless a user sets a specific content type to null.\n  - No change to existing behavior of passThrough defaults; documentation clarifies necessary passThrough configuration when removing templates.\n\n- Dependencies/prerequisites:\n  - No new external dependencies.\n  - Ensure CloudFormation generation does not strip needed values or error on nulls; the filtering step removes null entries before emitting to CFN.\n  - Users relying on no mapping templates for AWS (non-proxy) integration should configure passThrough explicitly; document this requirement.\n\nSummary of concrete changes:\n\n- lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n  - Modify getIntegrationRequestTemplates to filter out keys whose values are null (and optionally false), after merging defaults and custom templates.\n\n- lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n  - Optionally enhance getRequest to detect “all templates removed with AWS integration” and emit a helper warning suggesting passThrough configuration.\n\n- docs/providers/aws/events/apigateway.md\n  - Update Default Request Templates and Custom Request Templates sections to include guidance on removing defaults via null and how to set passThrough accordingly.\n--- END ANALYZER MESSAGE ---\n\nIMPORTANT INSTRUCTION:\n- The context provided above should be sufficient for you to make the required code edits. Do NOT explore for more context in the codebase!\n- Do NOT FIND, WRITE or RUN any tests, your change will be tested automatically by reproduction tests and regression tests later!!!\n- Never write any tests yourself!!! (Very important!)\n\nPlease implement these changes precisely, following the exact specifications from the analyzer.\n' additional_kwargs={} response_metadata={}
2025-11-13 20:28:36,634 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_iyxwSQORgfTF4hXyAJR4tnmR', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1063, 'prompt_tokens': 11876, 'total_tokens': 12939, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1024, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7a2b1567-f48e-44e5-8692-f783bfabee3d-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_iyxwSQORgfTF4hXyAJR4tnmR', 'type': 'tool_call'}] usage_metadata={'input_tokens': 11876, 'output_tokens': 1063, 'total_tokens': 12939, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 1024}}
2025-11-13 20:28:47,726 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gfMcav8vXTK7NjmTEDOUbZi3', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 928, 'prompt_tokens': 14245, 'total_tokens': 15173, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b0eeb0f6-6cf5-4fd9-a6a8-c42918d3089a-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md'}, 'id': 'call_gfMcav8vXTK7NjmTEDOUbZi3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 14245, 'output_tokens': 928, 'total_tokens': 15173, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 20:29:43,273 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_TzkwxPols7Oo9VB07J13Ib2n', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":931,"end_line":975}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 877, 'prompt_tokens': 19641, 'total_tokens': 20518, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 832, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a77d12e7-2ad8-4f3b-bb73-af95d5ed8c05-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 931, 'end_line': 975}, 'id': 'call_TzkwxPols7Oo9VB07J13Ib2n', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19641, 'output_tokens': 877, 'total_tokens': 20518, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 832}}
2025-11-13 20:29:45,286 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_vO3GADiOMw45yrWGXwGsNh4Z', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":973,"end_line":1081}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 20039, 'total_tokens': 20079, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1d6e1451-51f4-4709-bec3-5a922e1be0a0-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 973, 'end_line': 1081}, 'id': 'call_vO3GADiOMw45yrWGXwGsNh4Z', 'type': 'tool_call'}] usage_metadata={'input_tokens': 20039, 'output_tokens': 40, 'total_tokens': 20079, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:30:07,781 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pAYGvW1QOs8BxAlEgTIp1Ny4', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js","old_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      Object.assign(integrationRequestTemplates, {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      });\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    return Object.keys(integrationRequestTemplates).length\\n      ? integrationRequestTemplates\\n      : undefined;\\n  },","new_content":"  getIntegrationRequestTemplates(http, useDefaults) {\\n    // default request templates\\n    const integrationRequestTemplates = {};\\n\\n    // Only set defaults for AWS (lambda) integration\\n    if (useDefaults) {\\n      Object.assign(integrationRequestTemplates, {\\n        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\\n        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\\n      });\\n    }\\n\\n    // set custom request templates if provided\\n    if (http.request && typeof http.request.template === \'object\') {\\n      Object.assign(integrationRequestTemplates, http.request.template);\\n    }\\n\\n    // allow disabling of default templates by setting a template to null/false\\n    const cleanedTemplates = _.omitBy(\\n      integrationRequestTemplates,\\n      value => value == null || value === false\\n    );\\n\\n    return Object.keys(cleanedTemplates).length ? cleanedTemplates : undefined;\\n  },"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2592, 'prompt_tokens': 21420, 'total_tokens': 24012, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2176, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--61d18db4-a722-4f9a-9d4b-4ae5d350e3ca-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js', 'old_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      Object.assign(integrationRequestTemplates, {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      });\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    return Object.keys(integrationRequestTemplates).length\n      ? integrationRequestTemplates\n      : undefined;\n  },", 'new_content': "  getIntegrationRequestTemplates(http, useDefaults) {\n    // default request templates\n    const integrationRequestTemplates = {};\n\n    // Only set defaults for AWS (lambda) integration\n    if (useDefaults) {\n      Object.assign(integrationRequestTemplates, {\n        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n      });\n    }\n\n    // set custom request templates if provided\n    if (http.request && typeof http.request.template === 'object') {\n      Object.assign(integrationRequestTemplates, http.request.template);\n    }\n\n    // allow disabling of default templates by setting a template to null/false\n    const cleanedTemplates = _.omitBy(\n      integrationRequestTemplates,\n      value => value == null || value === false\n    );\n\n    return Object.keys(cleanedTemplates).length ? cleanedTemplates : undefined;\n  },"}, 'id': 'call_pAYGvW1QOs8BxAlEgTIp1Ny4', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21420, 'output_tokens': 2592, 'total_tokens': 24012, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 2176}}
2025-11-13 20:30:09,327 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_LsQka5qMBBpngwQTb3fbaxaZ', 'function': {'arguments': '{"relative_path":"lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js"}', 'name': 'read_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 33, 'prompt_tokens': 21858, 'total_tokens': 21891, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--380c4699-a228-407a-a254-106f14c9f058-0' tool_calls=[{'name': 'read_file', 'args': {'relative_path': 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js'}, 'id': 'call_LsQka5qMBBpngwQTb3fbaxaZ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 21858, 'output_tokens': 33, 'total_tokens': 21891, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:30:13,213 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_qR6aMEZFYo1BuHdVwUvzk8Hk', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","old_content":"#### Custom Request Templates\\n\\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type):\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n```\\n\\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\\n","new_content":"#### Custom Request Templates\\n\\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\\nby defining a new request template for an existing content type). You can also disable a default template for a specific content type by setting its value to `null`:\\n\\n```yml\\nfunctions:\\n  create:\\n    handler: posts.create\\n    events:\\n      - http:\\n          method: get\\n          path: whatever\\n          integration: lambda\\n          request:\\n            template:\\n              text/xhtml: \'{ \\"stage\\" : \\"$context.stage\\" }\'\\n              application/json: \'{ \\"httpMethod\\" : \\"$context.httpMethod\\" }\'\\n              application/x-www-form-urlencoded: null\\n```\\n\\nSetting a template value to `null` removes that content type from the generated API Gateway RequestTemplates, allowing you to avoid advertising unsupported media types (e.g., removing `application/x-www-form-urlencoded` when only JSON is supported). If you disable all templates for the `lambda` (AWS) integration, ensure you set `passThrough` appropriately (e.g., `WHEN_NO_TEMPLATES`) to avoid 415 Unsupported Media Type errors.\\n\\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\\n"}', 'name': 'edit_file'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 482, 'prompt_tokens': 24273, 'total_tokens': 24755, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a1983753-a03c-4eb6-9a80-4b5ac626799f-0' tool_calls=[{'name': 'edit_file', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'old_content': '#### Custom Request Templates\n\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type):\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n```\n\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n', 'new_content': '#### Custom Request Templates\n\nHowever you can define and use your own request templates as follows (you can even overwrite the default request templates\nby defining a new request template for an existing content type). You can also disable a default template for a specific content type by setting its value to `null`:\n\n```yml\nfunctions:\n  create:\n    handler: posts.create\n    events:\n      - http:\n          method: get\n          path: whatever\n          integration: lambda\n          request:\n            template:\n              text/xhtml: \'{ "stage" : "$context.stage" }\'\n              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n              application/x-www-form-urlencoded: null\n```\n\nSetting a template value to `null` removes that content type from the generated API Gateway RequestTemplates, allowing you to avoid advertising unsupported media types (e.g., removing `application/x-www-form-urlencoded` when only JSON is supported). If you disable all templates for the `lambda` (AWS) integration, ensure you set `passThrough` appropriately (e.g., `WHEN_NO_TEMPLATES`) to avoid 415 Unsupported Media Type errors.\n\n**Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n'}, 'id': 'call_qR6aMEZFYo1BuHdVwUvzk8Hk', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24273, 'output_tokens': 482, 'total_tokens': 24755, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:30:15,167 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_RsAiGo51on8lynhlVQj3Uygv', 'function': {'arguments': '{"relative_path":"docs/providers/aws/events/apigateway.md","start_line":953,"end_line":1001}', 'name': 'read_file_with_line_numbers'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 40, 'prompt_tokens': 24776, 'total_tokens': 24816, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 9984}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--65e604fb-cd2f-497f-bf38-7df5a123ba8d-0' tool_calls=[{'name': 'read_file_with_line_numbers', 'args': {'relative_path': 'docs/providers/aws/events/apigateway.md', 'start_line': 953, 'end_line': 1001}, 'id': 'call_RsAiGo51on8lynhlVQj3Uygv', 'type': 'tool_call'}] usage_metadata={'input_tokens': 24776, 'output_tokens': 40, 'total_tokens': 24816, 'input_token_details': {'audio': 0, 'cache_read': 9984}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:30:23,124 - thread-135845287823040.prometheus.lang_graph.nodes.edit_node - DEBUG - content='I implemented support for removing default API Gateway request mapping templates and updated the documentation to explain how to use it.\n\nCode changes:\n- In lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js, getIntegrationRequestTemplates now filters out templates explicitly set to null or false. This allows you to disable default templates per content type.\n  - Usage: in serverless.yml, set a template entry to null (or false) to remove it from RequestTemplates.\n\nDocumentation updates:\n- In docs/providers/aws/events/apigateway.md under “Custom Request Templates,” added an example and explanation showing how to disable a default template by setting it to null:\n  - Example:\n    - application/x-www-form-urlencoded: null\n  - Added a note that if you disable all templates for the lambda (AWS) integration, you should set passThrough appropriately (e.g., WHEN_NO_TEMPLATES) to avoid 415 Unsupported Media Type errors.\n\nHow to use:\n- To prevent application/x-www-form-urlencoded from being generated automatically while keeping application/json, add:\n  - request:\n    - template:\n      - application/x-www-form-urlencoded: null\n- If you remove all templates for a non-proxy AWS (lambda) integration, also configure:\n  - request:\n    - passThrough: WHEN_NO_TEMPLATES\n\nThis maintains backward compatibility: defaults are still created unless you explicitly null them out.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 612, 'prompt_tokens': 25497, 'total_tokens': 26109, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19968}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--1017aa8a-0202-4998-8ff6-02066c0267a8-0' usage_metadata={'input_tokens': 25497, 'output_tokens': 612, 'total_tokens': 26109, 'input_token_details': {'audio': 0, 'cache_read': 19968}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:30:23,169 - thread-135845287823040.prometheus.lang_graph.nodes.git_diff_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..98e7b7928 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -953,7 +953,7 @@ Both templates give you access to the following properties you can access with t
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
-by defining a new request template for an existing content type):
+by defining a new request template for an existing content type). You can also disable a default template for a specific content type by setting its value to `null`:
 
 ```yml
 functions:
@@ -968,8 +968,11 @@ functions:
             template:
               text/xhtml: '{ "stage" : "$context.stage" }'
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
+              application/x-www-form-urlencoded: null
 ```
 
+Setting a template value to `null` removes that content type from the generated API Gateway RequestTemplates, allowing you to avoid advertising unsupported media types (e.g., removing `application/x-www-form-urlencoded` when only JSON is supported). If you disable all templates for the `lambda` (AWS) integration, ensure you set `passThrough` appropriately (e.g., `WHEN_NO_TEMPLATES`) to avoid 415 Unsupported Media Type errors.
+
 **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
 
 **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..3e5871f6a 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -212,9 +212,13 @@ module.exports = {
       Object.assign(integrationRequestTemplates, http.request.template);
     }
 
-    return Object.keys(integrationRequestTemplates).length
-      ? integrationRequestTemplates
-      : undefined;
+    // allow disabling of default templates by setting a template to null/false
+    const cleanedTemplates = _.omitBy(
+      integrationRequestTemplates,
+      value => value == null || value === false
+    );
+
+    return Object.keys(cleanedTemplates).length ? cleanedTemplates : undefined;
   },
   getIntegrationRequestParameters(http) {
     const parameters = {};

2025-11-13 20:30:23,171 - thread-135845287823040.prometheus.lang_graph.nodes.patch_normalization_node - INFO - Starting to process 5 patches
2025-11-13 20:30:23,180 - thread-135845287823040.prometheus.lang_graph.nodes.patch_normalization_node - INFO - Deduplication complete: 5 -> 5 unique patches
2025-11-13 20:30:23,180 - thread-135845287823040.prometheus.lang_graph.nodes.patch_normalization_node - INFO - Patch processing complete, deduplicated to 5 unique patches
2025-11-13 20:30:23,182 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - INFO - Enter get_pass_regression_test_patch_subgraph_node
2025-11-13 20:30:23,182 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:30:23,185 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..9b4f67eb3 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -932,7 +932,7 @@ This method is more complicated and involves a lot more configuration of the `ht
 
 #### Default Request Templates
 
-Serverless ships with the following default request templates you can use out of the box:
+Serverless ships with the following default request templates you can use out of the box for Lambda (AWS) integration:
 
 1. `application/json`
 2. `application/x-www-form-urlencoded`
@@ -950,6 +950,41 @@ Both templates give you access to the following properties you can access with t
 - stageVariables
 - requestPath
 
+You can control these defaults:
+
+- Disable all default templates:
+  set `request.disableDefaultTemplates: true` to prevent Serverless from adding any default request mapping templates.
+- Exclude specific default content types:
+  set `request.excludeDefaultContentTypes` to a list of content types to remove from the defaults. For example, to remove `application/x-www-form-urlencoded` while keeping `application/json`.
+
+Examples:
+
+```yml
+functions:
+  onlyJson:
+    handler: posts.create
+    events:
+      - http:
+          method: post
+          path: posts/create
+          integration: lambda
+          request:
+            excludeDefaultContentTypes:
+              - application/x-www-form-urlencoded
+
+  noDefaultsCustomOnly:
+    handler: posts.create
+    events:
+      - http:
+          method: post
+          path: posts/create
+          integration: lambda
+          request:
+            disableDefaultTemplates: true
+            template:
+              application/json: '{ "httpMethod" : "$context.httpMethod" }'
+```
+
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
@@ -1027,6 +1062,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates
 
 - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
 - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)
+- When you disable all default templates and do not define any custom templates for AWS (Lambda) integration, the default passThrough behavior (NEVER) will cause API Gateway to reject requests with 415 unless you explicitly change `request.passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH`.
 
 ### Responses
 
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..6370cbb4f 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -201,10 +201,24 @@ module.exports = {
 
     // Only set defaults for AWS (lambda) integration
     if (useDefaults) {
-      Object.assign(integrationRequestTemplates, {
+      let defaultTemplates = {
         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
-      });
+      };
+
+      // Allow disabling all default templates
+      if (http.request && http.request.disableDefaultTemplates) {
+        defaultTemplates = {};
+      } else if (
+        http.request &&
+        Array.isArray(http.request.excludeDefaultContentTypes)
+      ) {
+        http.request.excludeDefaultContentTypes.forEach(type => {
+          delete defaultTemplates[type];
+        });
+      }
+
+      Object.assign(integrationRequestTemplates, defaultTemplates);
     }
 
     // set custom request templates if provided
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..c00fa243b 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,38 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      if (
+        typeof http.request.disableDefaultTemplates !== 'undefined' &&
+        typeof http.request.disableDefaultTemplates !== 'boolean'
+      ) {
+        const errorMessage = [
+          'disableDefaultTemplates must be provided as a boolean.',
+          ' Please check the docs for more info.',
+        ].join('');
+        throw new this.serverless.classes.Error(errorMessage);
+      }
+      if (
+        typeof http.request.excludeDefaultContentTypes !== 'undefined' &&
+        !Array.isArray(http.request.excludeDefaultContentTypes)
+      ) {
+        const errorMessage = [
+          'excludeDefaultContentTypes must be provided as an array of strings.',
+          ' Please check the docs for more info.',
+        ].join('');
+        throw new this.serverless.classes.Error(errorMessage);
+      }
+      if (Array.isArray(http.request.excludeDefaultContentTypes)) {
+        const invalid = http.request.excludeDefaultContentTypes.some(
+          t => typeof t !== 'string'
+        );
+        if (invalid) {
+          const errorMessage = [
+            'excludeDefaultContentTypes must be provided as an array of strings.',
+            ' Please check the docs for more info.',
+          ].join('');
+          throw new this.serverless.classes.Error(errorMessage);
+        }
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:30:23,216 - thread-135845287823040.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:30:23,252 - thread-135845287823040.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:30:23,252 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:30:23,507 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:30:23,507 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 56aa5aa15 feat(Standalone): Prevent accidental upgrades to a new major
[?2004l
2025-11-13 20:30:23,507 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:30:23,609 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:30:23,609 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:30:23,610 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:30:23,610 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory docs/providers/aws/events in the container
2025-11-13 20:30:23,611 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p docs/providers/aws/events
2025-11-13 20:30:23,712 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:30:23,712 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:30:23,712 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib in the container
2025-11-13 20:30:23,712 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib
2025-11-13 20:30:23,814 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:30:23,814 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib
[?2004l
[?2004l
2025-11-13 20:30:23,814 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib/method in the container
2025-11-13 20:30:23,814 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib/method
2025-11-13 20:30:23,916 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:30:23,916 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib/method
[?2004l
[?2004l
2025-11-13 20:30:23,917 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating docs/providers/aws/events/apigateway.md in the container
2025-11-13 20:30:23,918 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js in the container
2025-11-13 20:30:23,918 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js in the container
2025-11-13 20:30:23,928 - thread-135845287823040.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:30:23,930 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:30:23,930 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:30:28,590 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ODyvPQEfvRNfEyA30xwHjyW3', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 346, 'prompt_tokens': 692, 'total_tokens': 1038, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--97da223e-1da3-477c-a416-784434a992c3-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_ODyvPQEfvRNfEyA30xwHjyW3', 'type': 'tool_call'}] usage_metadata={'input_tokens': 692, 'output_tokens': 346, 'total_tokens': 1038, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:30:28,594 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:30:28,696 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:30:28,696 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1628
drwxr-xr-x   1 root root    4096 Nov 13 20:30 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:30 [01;34m..[0m
-rw-r--r--   1 root root     273 Nov 13 20:30 .editorconfig
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34m.git[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34m.github[0m
-rwxr-xr-x   1 root root      90 Nov 13 20:30 [01;32m.gitignore[0m
-rw-r--r--   1 root root      28 Nov 13 20:30 .npmignore
-rw-r--r--   1 root root      71 Nov 13 20:30 .prettierignore
-rw-r--r--   1 root root  187937 Nov 13 20:30 CHANGELOG.md
-rw-r--r--   1 root root    3292 Nov 13 20:30 CODE_OF_CONDUCT.md
-rw-r--r--   1 root root    5668 Nov 13 20:30 CONTRIBUTING.md
-rw-r--r--   1 root root     324 Nov 13 20:30 Dockerfile
-rw-r--r--   1 root root    1086 Nov 13 20:30 LICENSE.txt
-rw-r--r--   1 root root   13983 Nov 13 20:30 README.md
-rw-r--r--   1 root root    7692 Nov 13 20:30 README_CN.md
-rw-r--r--   1 root root    3191 Nov 13 20:30 RELEASE_PROCESS.md
-rw-r--r--   1 root root    3896 Nov 13 20:30 VERSIONING.md
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mbin[0m
-rw-r--r--   1 root root    1313 Nov 13 20:30 commitlint.config.js
-rw-r--r--   1 root root    3996 Nov 13 20:30 docker-compose.yml
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mdocs[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mlib[0m
drwxr-xr-x 947 root root   36864 Aug 28 02:00 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1282306 Aug 28 01:59 package-lock.json
-rw-r--r--   1 root root    6437 Nov 13 20:30 package.json
-rw-r--r--   1 root root      86 Nov 13 20:30 prettier.config.js
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mscripts[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mtest[0m
[?2004l
2025-11-13 20:32:00,673 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_v8NVnDgfkVUuLDAgpR5LKW3U', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 218, 'prompt_tokens': 1567, 'total_tokens': 1785, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 192, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--708f7ad5-fdf0-41e2-a8fa-45e67a0e1ec9-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_v8NVnDgfkVUuLDAgpR5LKW3U', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1567, 'output_tokens': 218, 'total_tokens': 1785, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 192}}
2025-11-13 20:32:00,676 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:32:00,778 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:00,778 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.80.0",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "author": "serverless.com",
  "repository": "serverless/serverless",
  "keywords": [
    "serverless",
    "lambda",
    "aws",
    "amazon",
    "azure",
    "google-cloud",
    "apache-open-whisk",
    "iot"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "dependencies": {
    "@serverless/cli": "^1.5.2",
    "@serverless/components": "^2.34.7",
    "@serverless/enterprise-plugin": "^3.8.1",
    "@serverless/inquirer": "^1.1.2",
    "@serverless/utils": "^1.2.0",
    "ajv": "^6.12.4",
    "ajv-keywords": "^3.5.2",
    "archiver": "^3.1.1",
    "aws-sdk": "^2.739.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.1",
    "d": "^1.0.1",
    "dayjs": "^1.8.34",
    "decompress": "^4.2.1",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^8.1.0",
    "get-stdin": "^6.0.0",
    "globby": "^9.2.0",
    "graceful-fs": "^4.2.4",
    "https-proxy-agent": "^5.0.0",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.2.0",
    "js-yaml": "^3.14.0",
    "json-cycle": "^1.3.0",
    "json-refs": "^3.0.15",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.20",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.4",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.1.0",
    "node-fetch": "^2.6.0",
    "object-hash": "^2.0.3",
    "p-limit": "^2.3.0",
    "promise-queue": "^2.2.5",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^6.3.0",
    "semver-regex": "^2.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "timers-ext": "^0.1.7",
    "type": "^2.1.0",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^3.4.0",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^18.1.3"
  },
  "devDependencies": {
    "@commitlint/cli": "^9.1.2",
    "@serverless/eslint-config": "^2.2.0",
    "@serverless/test": "^4.6.0",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "cos-nodejs-sdk-v5": "^2.6.2",
    "eslint": "^7.7.0",
    "eslint-plugin-import": "^2.22.0",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "husky": "^4.2.5",
    "jszip": "^3.5.0",
    "lint-staged": "^10.2.13",
    "log": "^6.0.0",
    "mocha": "^6.2.3",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^15.1.0",
    "pkg": "^4.4.9",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^8.1.1",
    "sinon-chai": "^3.5.0",
    "standard-version": "^8.0.2",
    "strip-ansi": "^5.2.0",
    "ws": "^7.3.1",
    "xml2js": "^0.4.23"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node/6",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/**"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "!/.github",
    "/lib/plugins/create/templates/**",
    "/lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./test/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      ".github",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "test/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    },
    "types": [
      {
        "type": "feat",
        "section": "Features"
      },
      {
        "type": "fix",
        "section": "Bug Fixes"
      },
      {
        "type": "perf",
        "section": "Performance Improvements"
      },
      {
        "type": "refactor",
        "section": "Maintanance Improvements"
      }
    ]
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.js": [
      "eslint"
    ],
    "*.{css,html,js,json,md,yaml,yml}": [
      "prettier -c"
    ]
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node test/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 test/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha test/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check test/integration-package/**/*.tests.js",
    "lint": "eslint .",
    "lint:updated": "pipe-git-updated --ext=js -- eslint",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload/index.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "engines": {
    "node": ">=6.0"
  },
  "license": "MIT"
}
[?2004l
2025-11-13 20:32:08,456 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Jmm0Tv9c7nvheBBO0xDMlmoP', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 495, 'prompt_tokens': 3846, 'total_tokens': 4341, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--41dc4229-9fa5-47f4-932d-750e051a3479-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_Jmm0Tv9c7nvheBBO0xDMlmoP', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3846, 'output_tokens': 495, 'total_tokens': 4341, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:32:08,460 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:32:08,561 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:08,562 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/package/compile/event
ts/apiGateway/lib/method/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsCompileApigEvents = require('../../index');
const Serverless = require('../../../../../../../../Serverless');
const AwsProvider = require('../../../../../../provider/awsProvider');

describe('#compileMethods()', () => {
  let serverless;
  let awsCompileApigEvents;

  beforeEach(() => {
    const options = {
      stage: 'dev',
      region: 'us-east-1',
    };
    serverless = new Serverless();
    serverless.setProvider('aws', new AwsProvider(serverless, options));
    serverless.service.service = 'first-service';
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.service.environment = {
      stages: {
        dev: {
          regions: {
            'us-east-1': {
              vars: {
                IamRoleLambdaExecution:
                  'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
              },
            },
          },
        },
      },
    };
    serverless.service.functions.First = {};
    serverless.service.functions.Second = {};
    serverless.service.functions.Third = {};
    awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
    awsCompileApigEvents.validated = {};
    awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
    awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
    awsCompileApigEvents.apiGatewayResources = {
      'users/create': {
        name: 'UsersCreate',
        resourceLogicalId: 'ApiGatewayResourceUsersCreate',
      },

      'users/list': {
        name: 'UsersList',
        resourceLogicalId: 'ApiGatewayResourceUsersList',
      },
      'users/update': {
        name: 'UsersUpdate',
        resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
      },
      'users/delete': {
        name: 'UsersDelete',
        resourceLogicalId: 'ApiGatewayResourceUsersDelete',
      },
    };
  });

  it('should have request validators/models defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' } } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should support multiple request schemas', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
        'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should have request parameters defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
            },
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
[?2004l
2025-11-13 20:32:09,626 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_DvyNbp30ufttAzXEtFOdAlc8', 'function': {'arguments': '{"command":"sed -n \'200,400p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 5467, 'total_tokens': 5508, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9a26917d-6a34-42c2-8342-6b8c921909c8-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_DvyNbp30ufttAzXEtFOdAlc8', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5467, 'output_tokens': 41, 'total_tokens': 5508, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:09,629 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:32:09,730 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:09,730 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,400p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
    });
  });

  it('should not have integration RequestParameters when no request parameters are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration
      ).to.not.have.key('RequestParameters');
    });
  });

  it('should create method resources when http events given', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Type
      ).to.equal('AWS::ApiGateway::Method');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Type
      ).to.equal('AWS::ApiGateway::Method');
    });
  });

  it('should support AWS integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support AWS_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS_PROXY');
    });
  });

  it('should support HTTP integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('POST');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
      ).to.equal(undefined);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support HTTP integration type with custom request options', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            method: 'put',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
[?2004l
2025-11-13 20:32:11,166 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_LBiCcuXz4ZKhEw0uS3kMP8w6', 'function': {'arguments': '{"command":"sed -n \'400,800p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 7053, 'total_tokens': 7094, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f8ce47c3-c1fc-45bf-b8a4-84d2d2aaa82d-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_LBiCcuXz4ZKhEw0uS3kMP8w6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7053, 'output_tokens': 41, 'total_tokens': 7094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:11,169 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:32:11,272 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:11,272 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '400,800p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PUT');
    });
  });

  it('should support HTTP_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            method: 'patch',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP_PROXY');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PATCH');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support MOCK integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'MOCK',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('MOCK');
    });
  });

  it('should add request parameter when async config is used', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter when integration type is AWS_PROXY and async', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter mapped value when explicitly defined', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.querystring.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.path.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.path.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.header.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.header.bar': {
                required: false,
                mappedValue: 'barValue',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'fooValue',
        'integration.request.querystring.bar': 'barValue',
        'integration.request.path.foo': 'fooValue',
        'integration.request.path.bar': 'barValue',
        'integration.request.header.foo': 'fooValue',
        'integration.request.header.bar': 'barValue',
      });
    });
  });

  it('should set authorizer config for AWS_IAM', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'AWS_IAM',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('AWS_IAM');
    });
  });

  it('should set custom authorizer config with authorizerId', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'COGNITO_USER_POOLS',
            authorizerId: 'gy7lyj',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
      ).to.equal('gy7lyj');
    });
  });

  it('should set authorizer config if given as ARN string', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'Authorizer',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('CUSTOM');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('CognitoAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            arn: {
              'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
            },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

[?2004l
2025-11-13 20:32:13,205 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9lW9V8o8FC4PQX8jd1kQsl6q', 'function': {'arguments': '{"command":"sed -n \'800,1200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 42, 'prompt_tokens': 10117, 'total_tokens': 10159, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d20be0e5-a756-4e7b-ad4f-f7e4f35938de-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_9lW9V8o8FC4PQX8jd1kQsl6q', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10117, 'output_tokens': 42, 'total_tokens': 10159, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:13,208 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:32:13,311 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:13,311 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '800,1200p' lib/plugins/aws/package/compile/ev
vents/apiGateway/lib/method/index.test.js
[?2004l

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should not scopes for a cognito user pool when given empty scopes array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: [],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.property('AuthorizationScopes');
    });
  });

  it('should set claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
    });
  });

  it('should set multiple claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'gender'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
    });
  });

  it('should properly set claims for custom properties inside the cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'custom:score'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
    });
  });

  it('should replace the extra claims in the template if there are none', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/extraCognitoPoolClaims/);
    });
  });

  it('should not create method resources when http events are not given', () => {
    awsCompileApigEvents.validated.events = [];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });

  it('should update the method logical ids array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
        'ApiGatewayMethodUsersCreatePost',
        'ApiGatewayMethodUsersListGet',
      ]);
    });
  });

  it('should set api key as required if private endpoint', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          private: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(true);
    });
  });

  it('should set api key as not required if private property is not specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(false);
    });
  });

  it('should set the correct lambdaUri', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
    });
  });

  it('Should point target alias if set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'Provisioned',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    serverless.service.functions.Provisioned = {
      targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
    };
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
            ':',
            'provisioned',
            '/invocations',
          ],
        ],
      });
    });
  });

  it('should add CORS origins to method only when CORS is enabled', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Third',
        http: {
          path: 'users/update',
          method: 'PUT',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
          cors: {
            origins: ['*'],
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'http://example.com'");

      // CORS not enabled!
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.not.equal("'*'");

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'*'");
    });
  });

  it('should set CORS allowCredentials to method only when specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
[?2004l
2025-11-13 20:32:15,055 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gdI6y8ZD1mVt4o0NOiE26ukB', 'function': {'arguments': '{"command":"sed -n \'1200,1600p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 13005, 'total_tokens': 13048, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10112}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--78793a7a-4fd9-4ca4-8e32-14bdb02ce2de-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_gdI6y8ZD1mVt4o0NOiE26ukB', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13005, 'output_tokens': 43, 'total_tokens': 13048, 'input_token_details': {'audio': 0, 'cache_read': 10112}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:15,058 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:32:15,161 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:15,161 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1200,1600p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
            allowCredentials: true,
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.equal('true');

      // allowCredentials not enabled
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.not.equal('true');
    });
  });

  describe('when dealing with request configuration', () => {
    it('should setup a default "application/json" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should setup a default "application/x-www-form-urlencoded" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/x-www-form-urlencoded'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should use defined pass-through behavior', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              passThrough: 'WHEN_NO_TEMPLATES',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
        ).to.equal('WHEN_NO_TEMPLATES');
      });
    });

    it('should use defined content-handling behavior (request)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              contentHandling: 'CONVERT_TO_TEXT',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
        ).to.equal('CONVERT_TO_TEXT');
      });
    });

    it('should use defined response content-handling behavior for 2XX only (response)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              contentHandling: 'CONVERT_TO_BINARY',
              statusCodes: {
                200: {
                  pattern: '',
                },
                400: {
                  pattern: '400',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ContentHandling
        ).to.equal('CONVERT_TO_BINARY');
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
            .ContentHandling
        ).to.equal(undefined);
      });
    });

    it('should set custom request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'template/1': '{ "stage" : "$context.stage" }',
                'template/2': '{ "httpMethod" : "$context.httpMethod" }',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
        ).to.equal('{ "stage" : "$context.stage" }');

        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
        ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
      });
    });

    it('should be possible to overwrite default request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'application/json': 'overwritten-request-template-content',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.equal('overwritten-request-template-content');
      });
    });
  });

  describe('when dealing with response configuration', () => {
    it('should set the custom headers', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                  headers: {
                    'Content-Type': "'text/plain'",
                    'My-Custom-Header': 'my/custom/header',
                  },
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.Content-Type']
        ).to.equal("'text/plain'");
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.My-Custom-Header']
        ).to.equal('my/custom/header');
      });
    });

    it('should set the custom template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  template: "$input.path('$.foo')",
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseTemplates['application/json']
        ).to.equal("$input.path('$.foo')");
      });
    });
  });

  it('should add method responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
      ).to.equal('200');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
      ).to.equal('202');
    });
  });

  it('should add integration responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
      ).to.deep.equal({
        StatusCode: '202',
        SelectionPattern: 'foo',
        ResponseParameters: {},
        ResponseTemplates: {},
[?2004l
2025-11-13 20:32:17,055 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_QpP6ky83inaxA8dzlvG9cogi', 'function': {'arguments': '{"command":"sed -n \'1600,2000p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 15549, 'total_tokens': 15592, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12928}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d58339df-f080-4b16-a4d4-13cfd4088633-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_QpP6ky83inaxA8dzlvG9cogi', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15549, 'output_tokens': 43, 'total_tokens': 15592, 'input_token_details': {'audio': 0, 'cache_read': 12928}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:17,058 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:32:17,160 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:17,160 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1600,2000p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
      ).to.deep.equal({
        StatusCode: '200',
        SelectionPattern: '',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
    });
  });

  it('should add fall back headers and template to statusCodes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            headers: {
              'Content-Type': 'text/csv',
            },
            template: 'foo',
            statusCodes: {
              400: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal('foo');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
    });
  });

  it('should add custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
                template: "$input.path('$.foo')",
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: "$input.path('$.errorMessage')",
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should add multiple response templates for a custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                template: "$input.path('$.foo')",
                headers: {
                  'Content-Type': 'text/csv',
                },
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: {
                  'application/json': "$input.path('$.errorMessage')",
                  'application/xml': "$input.path('$.xml.errorMessage')",
                },
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/xml']
      ).to.equal("$input.path('$.xml.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should use defined content-handling behavior', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            contentHandling: 'CONVERT_TO_BINARY',
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ContentHandling
      ).to.equal('CONVERT_TO_BINARY');
    });
  });

  it('should handle root resource methods', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: '',
          method: 'GET',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodGet.Properties.ResourceId
      ).to.deep.equal({
        'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
      });
    });
  });

  it('should include operation id as OperationName when it is set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          operationId: 'createUser',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.OperationName
      ).to.equal('createUser');
    });
  });

  it('should not include operation id when it is not set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.key('OperationName');
    });
  });
});
[?2004l
2025-11-13 20:32:25,200 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_RCUHnONwqpesXCsxqQt6P2uT', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should setup a default \\\\\\"application/json\\\\\\" template\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 696, 'prompt_tokens': 17545, 'total_tokens': 18241, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--b6d3e099-0883-4d55-8663-ba9fc03c5aa5-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\"application/json\\" template"'}, 'id': 'call_RCUHnONwqpesXCsxqQt6P2uT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17545, 'output_tokens': 696, 'total_tokens': 18241, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:32:25,203 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \"application/json\" template"
2025-11-13 20:32:26,658 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:26,658 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "should setup a default \"application/jso
on\" template"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:332) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m 
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m New [31mmajor[39m version of npm available! [31m8.19.4[39m -> [32m11.6.2[39m
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m Changelog: [36mhttps://github.com/npm/cli/releases/tag/v11.6.2[39m
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m Run [32mnpm install -g npm@11.6.2[39m to update!
[0m[37;40mnpm[0m [0m[36;40mnotice[0m[35m[0m 
[?2004l
2025-11-13 20:32:31,678 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_A26Gl0tQuKmpCG9Jk5SFANK7', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should setup a default \\\\\\"application/x-www-form-urlencoded\\\\\\" template\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 443, 'prompt_tokens': 18132, 'total_tokens': 18575, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 15488}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e99c74b7-7789-4ac6-b805-f32e9a998714-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\"application/x-www-form-urlencoded\\" template"'}, 'id': 'call_A26Gl0tQuKmpCG9Jk5SFANK7', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18132, 'output_tokens': 443, 'total_tokens': 18575, 'input_token_details': {'audio': 0, 'cache_read': 15488}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 20:32:31,682 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \"application/x-www-form-urlencoded\" template"
2025-11-13 20:32:33,119 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:33,119 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "should setup a default \"application/x-w
www-form-urlencoded\" template"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:351) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m

[?2004l
2025-11-13 20:32:34,340 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_diilVLo2IxSSYUlK2tysOLWE', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should be possible to overwrite default request templates\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 47, 'prompt_tokens': 18436, 'total_tokens': 18483, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17536}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--10bfa07d-dc8e-477d-ab83-89475409d165-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should be possible to overwrite default request templates"'}, 'id': 'call_diilVLo2IxSSYUlK2tysOLWE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18436, 'output_tokens': 47, 'total_tokens': 18483, 'input_token_details': {'audio': 0, 'cache_read': 17536}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:34,344 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should be possible to overwrite default request templates"
2025-11-13 20:32:35,770 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:35,770 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "should be possible to overwrite default 
 request templates"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:370) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:32:36,971 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_UVUf89Y4R2VL5yBw772Ywd5i', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should set custom request templates\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 18725, 'total_tokens': 18769, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18432}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cbf00fae-2729-43d8-8f68-040f99e62956-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should set custom request templates"'}, 'id': 'call_UVUf89Y4R2VL5yBw772Ywd5i', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18725, 'output_tokens': 44, 'total_tokens': 18769, 'input_token_details': {'audio': 0, 'cache_read': 18432}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:36,975 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should set custom request templates"
2025-11-13 20:32:38,394 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:38,394 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "should set custom request templates"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:389) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:32:39,876 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_w7Qu4g5DKGPQV3PEB3M45A1j', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should support HTTP integration type\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 44, 'prompt_tokens': 19004, 'total_tokens': 19048, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5504}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6b0b65d9-011b-4f34-8cf0-8e42e90f7a8d-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type"'}, 'id': 'call_w7Qu4g5DKGPQV3PEB3M45A1j', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19004, 'output_tokens': 44, 'total_tokens': 19048, 'input_token_details': {'audio': 0, 'cache_read': 5504}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:32:39,880 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type"
2025-11-13 20:32:41,306 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:41,306 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "should support HTTP integration type"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:408) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m
  [32m  ✓[0m[90m should support HTTP integration type with custom request options[0m


[92m [0m[32m 2 passing[0m[90m (19ms)[0m

[?2004l
2025-11-13 20:32:57,012 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ISXugVLH6tWdyvvV6vdXbdXN', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"^should support HTTP integration type$\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1268, 'prompt_tokens': 19298, 'total_tokens': 20566, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1216, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 7040}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--7839f517-70db-4770-88a7-c95d6aafba4b-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "^should support HTTP integration type$"'}, 'id': 'call_ISXugVLH6tWdyvvV6vdXbdXN', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19298, 'output_tokens': 1268, 'total_tokens': 20566, 'input_token_details': {'audio': 0, 'cache_read': 7040}, 'output_token_details': {'audio': 0, 'reasoning': 1216}}
2025-11-13 20:32:57,015 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "^should support HTTP integration type$"
2025-11-13 20:32:58,404 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:32:58,404 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "^should support HTTP integration type$" 
[AGateway/lib/method/index.test.js --grep "^should support HTTP integration type$[K"
[?2004l


[92m [0m[32m 0 passing[0m[90m (1ms)[0m

(node:427) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:33:16,591 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_6u6ZNUwnuOfUr3M3Wp5JBYi9', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should support HTTP integration type$\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1843, 'prompt_tokens': 19540, 'total_tokens': 21383, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1792, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18944}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a8a2e571-14d2-4966-8d18-2478cf196b34-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type$"'}, 'id': 'call_6u6ZNUwnuOfUr3M3Wp5JBYi9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19540, 'output_tokens': 1843, 'total_tokens': 21383, 'input_token_details': {'audio': 0, 'cache_read': 18944}, 'output_token_details': {'audio': 0, 'reasoning': 1792}}
2025-11-13 20:33:16,595 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type$"
2025-11-13 20:33:18,034 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:33:18,034 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "should support HTTP integration type$"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:446) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

[?2004l
2025-11-13 20:33:52,867 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_X6F2aSpetEk8pBvoM6h8ydvs', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should setup a default \\\\\\"application/json\\\\\\" template\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3064, 'prompt_tokens': 19806, 'total_tokens': 22870, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 3008, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--29a03828-2fbe-4ecb-b6b8-567132054d67-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\"application/json\\" template"'}, 'id': 'call_X6F2aSpetEk8pBvoM6h8ydvs', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19806, 'output_tokens': 3064, 'total_tokens': 22870, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 3008}}
2025-11-13 20:33:52,871 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \"application/json\" template"
2025-11-13 20:33:54,303 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:33:54,303 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep "should setup a default \"application/jso
on\" template"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:465) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:34:10,223 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='```\nResult:\nlib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template - Pass\nlib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template - Pass\nlib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates - Pass\nlib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates - Pass\nlib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type - Pass\n\nTotal tests run: 5\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1140, 'prompt_tokens': 20102, 'total_tokens': 21242, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 960, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--1c1ce7a7-ecb0-4ade-a2f5-9be516807e8d-0' usage_metadata={'input_tokens': 20102, 'output_tokens': 1140, 'total_tokens': 21242, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 960}}
2025-11-13 20:34:10,226 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
```
Result:
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template - Pass
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template - Pass
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates - Pass
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates - Pass
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type - Pass

Total tests run: 5
```
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:34:14,803 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type'] regression_test_fail_log='' total_tests_run=5
2025-11-13 20:34:14,805 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:34:14,805 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:34:14,806 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:34:14,806 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:34:14,806 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - True
2025-11-13 20:34:14,808 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..9e6c7c5a4 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -932,11 +932,35 @@ This method is more complicated and involves a lot more configuration of the `ht
 
 #### Default Request Templates
 
-Serverless ships with the following default request templates you can use out of the box:
+Serverless ships with the following default request templates you can use out of the box (for the `lambda`/`AWS` integration):
 
 1. `application/json`
 2. `application/x-www-form-urlencoded`
 
+You can control which of these defaults are applied per endpoint with the `request.defaultContentTypes` setting:
+
+- Omit `request.defaultContentTypes` to keep the current defaults (both will be added)
+- Set `request.defaultContentTypes: [application/json]` to include only the JSON default
+- Set `request.defaultContentTypes: []` to disable all defaults (you may want to define your own templates via `request.template`)
+
+Example:
+
+```yml
+functions:
+  create:
+    handler: posts.create
+    events:
+      - http:
+          method: post
+          path: posts/create
+          integration: lambda
+          request:
+            defaultContentTypes:
+              - application/json
+            template:
+              text/xml: '{ "foo": "bar" }'
+```
+
 Both templates give you access to the following properties you can access with the help of the `event` object:
 
 - body
@@ -953,7 +977,7 @@ Both templates give you access to the following properties you can access with t
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
-by defining a new request template for an existing content type):
+by defining a new request template for an existing content type). If you prefer not to include any defaults, set `request.defaultContentTypes: []`.
 
 ```yml
 functions:
@@ -965,6 +989,7 @@ functions:
           path: whatever
           integration: lambda
           request:
+            defaultContentTypes: []
             template:
               text/xhtml: '{ "stage" : "$context.stage" }'
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
@@ -998,7 +1023,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s
 
 [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.
 
-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):
+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the `lambda`/`AWS` integration). Note: If you disable all default request templates via `request.defaultContentTypes: []` and do not provide any custom templates, requests with unmatched Content-Type will be rejected with `415 - Unsupported Media Type` when passThrough is `NEVER`.
 
 ```yml
 functions:
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..38fd4ea7c 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -201,10 +201,24 @@ module.exports = {
 
     // Only set defaults for AWS (lambda) integration
     if (useDefaults) {
-      Object.assign(integrationRequestTemplates, {
-        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
-        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
-      });
+      const defaultsConfig =
+        http.request && Array.isArray(http.request.defaultContentTypes)
+          ? http.request.defaultContentTypes
+          : null;
+      if (defaultsConfig === null) {
+        Object.assign(integrationRequestTemplates, {
+          'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
+          'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
+        });
+      } else {
+        if (defaultsConfig.includes('application/json')) {
+          integrationRequestTemplates['application/json'] = this.DEFAULT_JSON_REQUEST_TEMPLATE;
+        }
+        if (defaultsConfig.includes('application/x-www-form-urlencoded')) {
+          integrationRequestTemplates['application/x-www-form-urlencoded'] =
+            this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE;
+        }
+      }
     }
 
     // set custom request templates if provided
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..e6008e2ef 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,31 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      if (http.request.defaultContentTypes) {
+        if (!Array.isArray(http.request.defaultContentTypes)) {
+          const errorMessage = [
+            'defaultContentTypes config must be provided as an array of strings.',
+            ' Please check the docs for more info.',
+          ].join('');
+          throw new this.serverless.classes.Error(errorMessage);
+        }
+        const allowedDefaults = [
+          'application/json',
+          'application/x-www-form-urlencoded',
+        ];
+        for (const ct of http.request.defaultContentTypes) {
+          if (typeof ct !== 'string' || allowedDefaults.indexOf(ct) === -1) {
+            const errorMessage = [
+              'defaultContentTypes entries must be one of: ',
+              allowedDefaults.join(', '),
+              '.',
+            ].join('');
+            throw new this.serverless.classes.Error(errorMessage);
+          }
+        }
+        // remove duplicates if any
+        http.request.defaultContentTypes = Array.from(new Set(http.request.defaultContentTypes));
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:34:14,846 - thread-135845287823040.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:34:14,883 - thread-135845287823040.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:34:14,883 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:34:15,028 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:15,029 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 56aa5aa15 feat(Standalone): Prevent accidental upgrades to a new major
[?2004l
2025-11-13 20:34:15,029 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:34:15,130 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:15,130 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:34:15,132 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:34:15,132 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory docs/providers/aws/events in the container
2025-11-13 20:34:15,132 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p docs/providers/aws/events
2025-11-13 20:34:15,234 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:15,234 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:34:15,234 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib in the container
2025-11-13 20:34:15,234 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib
2025-11-13 20:34:15,336 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:15,336 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib
[?2004l
[?2004l
2025-11-13 20:34:15,336 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib/method in the container
2025-11-13 20:34:15,336 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib/method
2025-11-13 20:34:15,438 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:15,438 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib/method
[?2004l
[?2004l
2025-11-13 20:34:15,438 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating docs/providers/aws/events/apigateway.md in the container
2025-11-13 20:34:15,440 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js in the container
2025-11-13 20:34:15,440 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js in the container
2025-11-13 20:34:15,449 - thread-135845287823040.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:34:15,450 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:34:15,450 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:34:17,552 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Xo16GpyzYtyBrctrxEQgD3to', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 692, 'total_tokens': 782, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--731aa3c6-e645-4321-9d68-1e47b3bc01ca-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_Xo16GpyzYtyBrctrxEQgD3to', 'type': 'tool_call'}] usage_metadata={'input_tokens': 692, 'output_tokens': 90, 'total_tokens': 782, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:34:17,555 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:34:17,657 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:17,657 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1628
drwxr-xr-x   1 root root    4096 Nov 13 20:30 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:34 [01;34m..[0m
-rw-r--r--   1 root root     273 Nov 13 20:30 .editorconfig
drwxrwxr-x   1 root root    4096 Nov 13 20:34 [01;34m.git[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34m.github[0m
-rwxr-xr-x   1 root root      90 Nov 13 20:30 [01;32m.gitignore[0m
-rw-r--r--   1 root root      28 Nov 13 20:30 .npmignore
-rw-r--r--   1 root root      71 Nov 13 20:30 .prettierignore
-rw-r--r--   1 root root  187937 Nov 13 20:30 CHANGELOG.md
-rw-r--r--   1 root root    3292 Nov 13 20:30 CODE_OF_CONDUCT.md
-rw-r--r--   1 root root    5668 Nov 13 20:30 CONTRIBUTING.md
-rw-r--r--   1 root root     324 Nov 13 20:30 Dockerfile
-rw-r--r--   1 root root    1086 Nov 13 20:30 LICENSE.txt
-rw-r--r--   1 root root   13983 Nov 13 20:30 README.md
-rw-r--r--   1 root root    7692 Nov 13 20:30 README_CN.md
-rw-r--r--   1 root root    3191 Nov 13 20:30 RELEASE_PROCESS.md
-rw-r--r--   1 root root    3896 Nov 13 20:30 VERSIONING.md
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mbin[0m
-rw-r--r--   1 root root    1313 Nov 13 20:30 commitlint.config.js
-rw-r--r--   1 root root    3996 Nov 13 20:30 docker-compose.yml
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mdocs[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mlib[0m
drwxr-xr-x 947 root root   36864 Aug 28 02:00 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1282306 Aug 28 01:59 package-lock.json
-rw-r--r--   1 root root    6437 Nov 13 20:30 package.json
-rw-r--r--   1 root root      86 Nov 13 20:30 prettier.config.js
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mscripts[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mtest[0m
[?2004l
2025-11-13 20:34:19,263 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_QkblDf0Ehw0TxXQE0FmSU2Qa', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 1567, 'total_tokens': 1657, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--28665da4-d9ae-43e7-884a-ba1a4bb19cdb-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_QkblDf0Ehw0TxXQE0FmSU2Qa', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1567, 'output_tokens': 90, 'total_tokens': 1657, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:34:19,266 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:34:19,367 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:19,368 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.80.0",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "author": "serverless.com",
  "repository": "serverless/serverless",
  "keywords": [
    "serverless",
    "lambda",
    "aws",
    "amazon",
    "azure",
    "google-cloud",
    "apache-open-whisk",
    "iot"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "dependencies": {
    "@serverless/cli": "^1.5.2",
    "@serverless/components": "^2.34.7",
    "@serverless/enterprise-plugin": "^3.8.1",
    "@serverless/inquirer": "^1.1.2",
    "@serverless/utils": "^1.2.0",
    "ajv": "^6.12.4",
    "ajv-keywords": "^3.5.2",
    "archiver": "^3.1.1",
    "aws-sdk": "^2.739.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.1",
    "d": "^1.0.1",
    "dayjs": "^1.8.34",
    "decompress": "^4.2.1",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^8.1.0",
    "get-stdin": "^6.0.0",
    "globby": "^9.2.0",
    "graceful-fs": "^4.2.4",
    "https-proxy-agent": "^5.0.0",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.2.0",
    "js-yaml": "^3.14.0",
    "json-cycle": "^1.3.0",
    "json-refs": "^3.0.15",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.20",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.4",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.1.0",
    "node-fetch": "^2.6.0",
    "object-hash": "^2.0.3",
    "p-limit": "^2.3.0",
    "promise-queue": "^2.2.5",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^6.3.0",
    "semver-regex": "^2.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "timers-ext": "^0.1.7",
    "type": "^2.1.0",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^3.4.0",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^18.1.3"
  },
  "devDependencies": {
    "@commitlint/cli": "^9.1.2",
    "@serverless/eslint-config": "^2.2.0",
    "@serverless/test": "^4.6.0",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "cos-nodejs-sdk-v5": "^2.6.2",
    "eslint": "^7.7.0",
    "eslint-plugin-import": "^2.22.0",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "husky": "^4.2.5",
    "jszip": "^3.5.0",
    "lint-staged": "^10.2.13",
    "log": "^6.0.0",
    "mocha": "^6.2.3",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^15.1.0",
    "pkg": "^4.4.9",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^8.1.1",
    "sinon-chai": "^3.5.0",
    "standard-version": "^8.0.2",
    "strip-ansi": "^5.2.0",
    "ws": "^7.3.1",
    "xml2js": "^0.4.23"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node/6",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/**"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "!/.github",
    "/lib/plugins/create/templates/**",
    "/lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./test/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      ".github",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "test/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    },
    "types": [
      {
        "type": "feat",
        "section": "Features"
      },
      {
        "type": "fix",
        "section": "Bug Fixes"
      },
      {
        "type": "perf",
        "section": "Performance Improvements"
      },
      {
        "type": "refactor",
        "section": "Maintanance Improvements"
      }
    ]
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.js": [
      "eslint"
    ],
    "*.{css,html,js,json,md,yaml,yml}": [
      "prettier -c"
    ]
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node test/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 test/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha test/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check test/integration-package/**/*.tests.js",
    "lint": "eslint .",
    "lint:updated": "pipe-git-updated --ext=js -- eslint",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload/index.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "engines": {
    "node": ">=6.0"
  },
  "license": "MIT"
}
[?2004l
2025-11-13 20:34:26,868 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_q8Xy99ffIEKIOPLKp0lTX8Ez', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 687, 'prompt_tokens': 3846, 'total_tokens': 4533, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 640, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1536}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c1d61943-33b1-44fd-bc00-99c1b9dc7da2-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_q8Xy99ffIEKIOPLKp0lTX8Ez', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3846, 'output_tokens': 687, 'total_tokens': 4533, 'input_token_details': {'audio': 0, 'cache_read': 1536}, 'output_token_details': {'audio': 0, 'reasoning': 640}}
2025-11-13 20:34:26,871 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:34:26,972 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:26,973 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/package/compile/event
ts/apiGateway/lib/method/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsCompileApigEvents = require('../../index');
const Serverless = require('../../../../../../../../Serverless');
const AwsProvider = require('../../../../../../provider/awsProvider');

describe('#compileMethods()', () => {
  let serverless;
  let awsCompileApigEvents;

  beforeEach(() => {
    const options = {
      stage: 'dev',
      region: 'us-east-1',
    };
    serverless = new Serverless();
    serverless.setProvider('aws', new AwsProvider(serverless, options));
    serverless.service.service = 'first-service';
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.service.environment = {
      stages: {
        dev: {
          regions: {
            'us-east-1': {
              vars: {
                IamRoleLambdaExecution:
                  'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
              },
            },
          },
        },
      },
    };
    serverless.service.functions.First = {};
    serverless.service.functions.Second = {};
    serverless.service.functions.Third = {};
    awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
    awsCompileApigEvents.validated = {};
    awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
    awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
    awsCompileApigEvents.apiGatewayResources = {
      'users/create': {
        name: 'UsersCreate',
        resourceLogicalId: 'ApiGatewayResourceUsersCreate',
      },

      'users/list': {
        name: 'UsersList',
        resourceLogicalId: 'ApiGatewayResourceUsersList',
      },
      'users/update': {
        name: 'UsersUpdate',
        resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
      },
      'users/delete': {
        name: 'UsersDelete',
        resourceLogicalId: 'ApiGatewayResourceUsersDelete',
      },
    };
  });

  it('should have request validators/models defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' } } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should support multiple request schemas', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
        'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should have request parameters defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
            },
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
[?2004l
2025-11-13 20:34:28,466 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Z9TMsy6uC9movGtHGdqwwVuP', 'function': {'arguments': '{"command":"sed -n \'200,400p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 5467, 'total_tokens': 5508, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c9ba72de-11be-4594-9282-ad1ef42c8e7c-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_Z9TMsy6uC9movGtHGdqwwVuP', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5467, 'output_tokens': 41, 'total_tokens': 5508, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:28,469 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:34:28,570 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:28,571 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,400p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
    });
  });

  it('should not have integration RequestParameters when no request parameters are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration
      ).to.not.have.key('RequestParameters');
    });
  });

  it('should create method resources when http events given', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Type
      ).to.equal('AWS::ApiGateway::Method');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Type
      ).to.equal('AWS::ApiGateway::Method');
    });
  });

  it('should support AWS integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support AWS_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS_PROXY');
    });
  });

  it('should support HTTP integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('POST');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
      ).to.equal(undefined);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support HTTP integration type with custom request options', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            method: 'put',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
[?2004l
2025-11-13 20:34:30,195 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_vVVQT5TGsVCi0P8asHumZd9r', 'function': {'arguments': '{"command":"sed -n \'400,800p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 7053, 'total_tokens': 7094, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--598fbf1d-49ac-4900-98cb-136ff8628c8d-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_vVVQT5TGsVCi0P8asHumZd9r', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7053, 'output_tokens': 41, 'total_tokens': 7094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:30,198 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:34:30,300 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:30,300 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '400,800p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PUT');
    });
  });

  it('should support HTTP_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            method: 'patch',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP_PROXY');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PATCH');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support MOCK integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'MOCK',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('MOCK');
    });
  });

  it('should add request parameter when async config is used', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter when integration type is AWS_PROXY and async', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter mapped value when explicitly defined', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.querystring.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.path.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.path.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.header.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.header.bar': {
                required: false,
                mappedValue: 'barValue',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'fooValue',
        'integration.request.querystring.bar': 'barValue',
        'integration.request.path.foo': 'fooValue',
        'integration.request.path.bar': 'barValue',
        'integration.request.header.foo': 'fooValue',
        'integration.request.header.bar': 'barValue',
      });
    });
  });

  it('should set authorizer config for AWS_IAM', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'AWS_IAM',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('AWS_IAM');
    });
  });

  it('should set custom authorizer config with authorizerId', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'COGNITO_USER_POOLS',
            authorizerId: 'gy7lyj',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
      ).to.equal('gy7lyj');
    });
  });

  it('should set authorizer config if given as ARN string', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'Authorizer',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('CUSTOM');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('CognitoAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            arn: {
              'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
            },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

[?2004l
2025-11-13 20:34:31,821 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VivR30CeMBcs4gJisGqVUDiT', 'function': {'arguments': '{"command":"sed -n \'800,1200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 42, 'prompt_tokens': 10117, 'total_tokens': 10159, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5c5eb4ab-ce12-472e-ae33-04459d45c7fe-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_VivR30CeMBcs4gJisGqVUDiT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10117, 'output_tokens': 42, 'total_tokens': 10159, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:31,824 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:34:31,926 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:31,926 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '800,1200p' lib/plugins/aws/package/compile/ev
vents/apiGateway/lib/method/index.test.js
[?2004l

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should not scopes for a cognito user pool when given empty scopes array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: [],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.property('AuthorizationScopes');
    });
  });

  it('should set claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
    });
  });

  it('should set multiple claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'gender'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
    });
  });

  it('should properly set claims for custom properties inside the cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'custom:score'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
    });
  });

  it('should replace the extra claims in the template if there are none', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/extraCognitoPoolClaims/);
    });
  });

  it('should not create method resources when http events are not given', () => {
    awsCompileApigEvents.validated.events = [];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });

  it('should update the method logical ids array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
        'ApiGatewayMethodUsersCreatePost',
        'ApiGatewayMethodUsersListGet',
      ]);
    });
  });

  it('should set api key as required if private endpoint', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          private: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(true);
    });
  });

  it('should set api key as not required if private property is not specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(false);
    });
  });

  it('should set the correct lambdaUri', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
    });
  });

  it('Should point target alias if set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'Provisioned',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    serverless.service.functions.Provisioned = {
      targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
    };
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
            ':',
            'provisioned',
            '/invocations',
          ],
        ],
      });
    });
  });

  it('should add CORS origins to method only when CORS is enabled', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Third',
        http: {
          path: 'users/update',
          method: 'PUT',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
          cors: {
            origins: ['*'],
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'http://example.com'");

      // CORS not enabled!
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.not.equal("'*'");

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'*'");
    });
  });

  it('should set CORS allowCredentials to method only when specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
[?2004l
2025-11-13 20:34:33,715 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_7XB4Q74j9YiCCbBdKk6tddn6', 'function': {'arguments': '{"command":"sed -n \'1200,1600p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 13005, 'total_tokens': 13048, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fa2bbff2-d1b5-41d6-b956-a77b7f7eefad-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_7XB4Q74j9YiCCbBdKk6tddn6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13005, 'output_tokens': 43, 'total_tokens': 13048, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:33,718 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:34:33,821 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:33,821 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1200,1600p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
            allowCredentials: true,
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.equal('true');

      // allowCredentials not enabled
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.not.equal('true');
    });
  });

  describe('when dealing with request configuration', () => {
    it('should setup a default "application/json" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should setup a default "application/x-www-form-urlencoded" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/x-www-form-urlencoded'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should use defined pass-through behavior', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              passThrough: 'WHEN_NO_TEMPLATES',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
        ).to.equal('WHEN_NO_TEMPLATES');
      });
    });

    it('should use defined content-handling behavior (request)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              contentHandling: 'CONVERT_TO_TEXT',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
        ).to.equal('CONVERT_TO_TEXT');
      });
    });

    it('should use defined response content-handling behavior for 2XX only (response)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              contentHandling: 'CONVERT_TO_BINARY',
              statusCodes: {
                200: {
                  pattern: '',
                },
                400: {
                  pattern: '400',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ContentHandling
        ).to.equal('CONVERT_TO_BINARY');
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
            .ContentHandling
        ).to.equal(undefined);
      });
    });

    it('should set custom request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'template/1': '{ "stage" : "$context.stage" }',
                'template/2': '{ "httpMethod" : "$context.httpMethod" }',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
        ).to.equal('{ "stage" : "$context.stage" }');

        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
        ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
      });
    });

    it('should be possible to overwrite default request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'application/json': 'overwritten-request-template-content',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.equal('overwritten-request-template-content');
      });
    });
  });

  describe('when dealing with response configuration', () => {
    it('should set the custom headers', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                  headers: {
                    'Content-Type': "'text/plain'",
                    'My-Custom-Header': 'my/custom/header',
                  },
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.Content-Type']
        ).to.equal("'text/plain'");
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.My-Custom-Header']
        ).to.equal('my/custom/header');
      });
    });

    it('should set the custom template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  template: "$input.path('$.foo')",
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseTemplates['application/json']
        ).to.equal("$input.path('$.foo')");
      });
    });
  });

  it('should add method responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
      ).to.equal('200');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
      ).to.equal('202');
    });
  });

  it('should add integration responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
      ).to.deep.equal({
        StatusCode: '202',
        SelectionPattern: 'foo',
        ResponseParameters: {},
        ResponseTemplates: {},
[?2004l
2025-11-13 20:34:35,418 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_9IQYLvVPPU78bRZx2tLIjFQQ', 'function': {'arguments': '{"command":"sed -n \'1600,2000p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 15549, 'total_tokens': 15592, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a83d63d4-7c90-45ca-95fe-740abd4ad645-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_9IQYLvVPPU78bRZx2tLIjFQQ', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15549, 'output_tokens': 43, 'total_tokens': 15592, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:34:35,421 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:34:35,523 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:35,523 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1600,2000p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
      ).to.deep.equal({
        StatusCode: '200',
        SelectionPattern: '',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
    });
  });

  it('should add fall back headers and template to statusCodes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            headers: {
              'Content-Type': 'text/csv',
            },
            template: 'foo',
            statusCodes: {
              400: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal('foo');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
    });
  });

  it('should add custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
                template: "$input.path('$.foo')",
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: "$input.path('$.errorMessage')",
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should add multiple response templates for a custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                template: "$input.path('$.foo')",
                headers: {
                  'Content-Type': 'text/csv',
                },
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: {
                  'application/json': "$input.path('$.errorMessage')",
                  'application/xml': "$input.path('$.xml.errorMessage')",
                },
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/xml']
      ).to.equal("$input.path('$.xml.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should use defined content-handling behavior', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            contentHandling: 'CONVERT_TO_BINARY',
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ContentHandling
      ).to.equal('CONVERT_TO_BINARY');
    });
  });

  it('should handle root resource methods', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: '',
          method: 'GET',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodGet.Properties.ResourceId
      ).to.deep.equal({
        'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
      });
    });
  });

  it('should include operation id as OperationName when it is set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          operationId: 'createUser',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.OperationName
      ).to.equal('createUser');
    });
  });

  it('should not include operation id when it is not set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.key('OperationName');
    });
  });
});
[?2004l
2025-11-13 20:34:52,189 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_AAEcQfYLkuiZZOaVrlAdWQRO', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha --grep \\"^when dealing with request configuration.*should setup a default \\\\\\"application/json\\\\\\" template$\\" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1220, 'prompt_tokens': 17545, 'total_tokens': 18765, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5b2cade9-809a-45f0-9dff-498ac42b1ddd-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha --grep "^when dealing with request configuration.*should setup a default \\"application/json\\" template$" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_AAEcQfYLkuiZZOaVrlAdWQRO', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17545, 'output_tokens': 1220, 'total_tokens': 18765, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-13 20:34:52,191 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha --grep "^when dealing with request configuration.*should setup a default \"application/json\" template$" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:34:53,255 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:34:53,255 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha --grep "^when dealing with 
 request configuration.*should setup a default \"application/json\" template$" li
ib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
[?2004l


[92m [0m[32m 0 passing[0m[90m (1ms)[0m

(node:485) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:35:00,724 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_u6x0JkKkPBKgkXd6isXblnhe', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha --grep \\"should setup a default \\\\\\"application/json\\\\\\" template\\" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 636, 'prompt_tokens': 17795, 'total_tokens': 18431, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17536}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ae178c43-a5be-45a0-8e8f-33f6cc92471f-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha --grep "should setup a default \\"application/json\\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_u6x0JkKkPBKgkXd6isXblnhe', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17795, 'output_tokens': 636, 'total_tokens': 18431, 'input_token_details': {'audio': 0, 'cache_read': 17536}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 20:35:00,727 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha --grep "should setup a default \"application/json\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:35:01,740 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:01,740 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha --grep "should setup a defa
ault \"application/json\" template" lib/plugins/aws/package/compile/events/apiGat
teway/lib/method/index.test.js
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:492) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:35:06,300 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_p651ORvvedQVwbFRP5V9tYNX', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha --grep \\"should setup a default \\\\\\"application/x-www-form-urlencoded\\\\\\" template\\" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 383, 'prompt_tokens': 18102, 'total_tokens': 18485, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c899aaaf-3a50-43e3-b00b-a42320907a76-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha --grep "should setup a default \\"application/x-www-form-urlencoded\\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_p651ORvvedQVwbFRP5V9tYNX', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18102, 'output_tokens': 383, 'total_tokens': 18485, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:35:06,304 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha --grep "should setup a default \"application/x-www-form-urlencoded\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:35:07,307 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:07,307 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha --grep "should setup a defa
ault \"application/x-www-form-urlencoded\" template" lib/plugins/aws/package/comp
pile/events/apiGateway/lib/method/index.test.js
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:499) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:35:09,361 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_ImLM6nQV98PSyOpWrnyrzhmK', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha --grep \\"should be possible to overwrite default request templates\\" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 51, 'prompt_tokens': 18416, 'total_tokens': 18467, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--9d92230d-ecc8-4532-bdb5-6e5ba078956d-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha --grep "should be possible to overwrite default request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_ImLM6nQV98PSyOpWrnyrzhmK', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18416, 'output_tokens': 51, 'total_tokens': 18467, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:35:09,365 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha --grep "should be possible to overwrite default request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:35:10,417 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:10,417 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha --grep "should be possible 
 to overwrite default request templates" lib/plugins/aws/package/compile/events/a
apiGateway/lib/method/index.test.js
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:506) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m

[?2004l
2025-11-13 20:35:11,913 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_pZmHuUuaHFgAjAX7KWs035Ky', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha --grep \\"should set custom request templates\\" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 48, 'prompt_tokens': 18714, 'total_tokens': 18762, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5504}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8d610cb1-076a-4d77-9ea4-630950c10119-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha --grep "should set custom request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_pZmHuUuaHFgAjAX7KWs035Ky', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18714, 'output_tokens': 48, 'total_tokens': 18762, 'input_token_details': {'audio': 0, 'cache_read': 5504}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:35:11,916 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha --grep "should set custom request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:35:12,916 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:12,916 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha --grep "should set custom r
request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/i
index.test.js
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:513) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

[?2004l
2025-11-13 20:35:14,238 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_4BS9EyDPF4sxfQlHdE4HO7We', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha --grep \\"should support HTTP integration type$\\" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 49, 'prompt_tokens': 19004, 'total_tokens': 19053, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18048}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6808ea0d-8ac4-4e67-b08d-b25a9b3d476e-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha --grep "should support HTTP integration type$" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js'}, 'id': 'call_4BS9EyDPF4sxfQlHdE4HO7We', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19004, 'output_tokens': 49, 'total_tokens': 19053, 'input_token_details': {'audio': 0, 'cache_read': 18048}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:35:14,242 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha --grep "should support HTTP integration type$" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:35:15,247 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:15,247 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha --grep "should support HTTP
P integration type$" lib/plugins/aws/package/compile/events/apiGateway/lib/method
d/index.test.js
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:520) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

[?2004l
2025-11-13 20:35:37,146 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n./node_modules/.bin/mocha --grep "should setup a default \\"application/json\\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:492) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/json" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (22ms)\x1b[0m\n\n\n./node_modules/.bin/mocha --grep "should setup a default \\"application/x-www-form-urlencoded\\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:499) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/x-www-form-urlencoded" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (22ms)\x1b[0m\n\n\n./node_modules/.bin/mocha --grep "should be possible to overwrite default request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:506) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should be possible to overwrite default request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (23ms)\x1b[0m\n\n\n./node_modules/.bin/mocha --grep "should set custom request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:513) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should set custom request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (21ms)\x1b[0m\n\n\n./node_modules/.bin/mocha --grep "should support HTTP integration type$" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n(node:520) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n  \x1b[32m  ✓\x1b[0m\x1b[90m should support HTTP integration type\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (21ms)\x1b[0m\n\n\nSummary: Total tests run: 5; Passed: 5; Failed: 0' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2591, 'prompt_tokens': 19281, 'total_tokens': 21872, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1472, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 7040}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--92153608-7a7b-483d-b694-27490cb10c40-0' usage_metadata={'input_tokens': 19281, 'output_tokens': 2591, 'total_tokens': 21872, 'input_token_details': {'audio': 0, 'cache_read': 7040}, 'output_token_details': {'audio': 0, 'reasoning': 1472}}
2025-11-13 20:35:37,150 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
./node_modules/.bin/mocha --grep "should setup a default \"application/json\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:492) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m


./node_modules/.bin/mocha --grep "should setup a default \"application/x-www-form-urlencoded\" template" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:499) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m


./node_modules/.bin/mocha --grep "should be possible to overwrite default request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:506) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m


./node_modules/.bin/mocha --grep "should set custom request templates" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:513) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m


./node_modules/.bin/mocha --grep "should support HTTP integration type$" lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js

[0m[0m
[0m  #compileMethods()[0m
(node:520) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m


Summary: Total tests run: 5; Passed: 5; Failed: 0
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:35:50,066 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type'] regression_test_fail_log='' total_tests_run=5
2025-11-13 20:35:50,068 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:35:50,068 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:35:50,069 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:35:50,069 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:35:50,069 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - True
2025-11-13 20:35:50,071 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..a0e2182b9 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -932,11 +932,13 @@ This method is more complicated and involves a lot more configuration of the `ht
 
 #### Default Request Templates
 
-Serverless ships with the following default request templates you can use out of the box:
+Serverless ships with the following default request templates you can use out of the box (for the non-proxy `lambda`/`AWS` integration):
 
 1. `application/json`
 2. `application/x-www-form-urlencoded`
 
+You can disable one or both default templates by setting the content type to `false` in your `request.template` configuration or globally under `provider.apiGateway.defaultRequestTemplates`.
+
 Both templates give you access to the following properties you can access with the help of the `event` object:
 
 - body
@@ -970,6 +972,34 @@ functions:
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
 ```
 
+To remove a default content type, set it to `false`:
+
+```yml
+functions:
+  create:
+    handler: posts.create
+    events:
+      - http:
+          method: get
+          path: whatever
+          integration: lambda
+          request:
+            template:
+              application/x-www-form-urlencoded: false
+```
+
+You can also control defaults globally:
+
+```yml
+provider:
+  apiGateway:
+    defaultRequestTemplates:
+      application/json: ${file(template_json.vtl)}
+      application/x-www-form-urlencoded: false
+```
+
+If you remove all templates, remember to adjust pass-through behavior as needed (see below).
+
 **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
 
 **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
@@ -998,7 +1028,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s
 
 [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.
 
-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):
+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the non-proxy `lambda`/`AWS` integration when defaults are present). If you disable all templates, consider setting `passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH` depending on your desired behavior.
 
 ```yml
 functions:
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..0553ab74e 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -201,10 +201,24 @@ module.exports = {
 
     // Only set defaults for AWS (lambda) integration
     if (useDefaults) {
-      Object.assign(integrationRequestTemplates, {
-        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
-        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
-      });
+      // Allow provider-level override of default request templates
+      const providerDefaults =
+        this.serverless &&
+        this.serverless.service &&
+        this.serverless.service.provider &&
+        this.serverless.service.provider.apiGateway &&
+        typeof this.serverless.service.provider.apiGateway.defaultRequestTemplates === 'object'
+          ? this.serverless.service.provider.apiGateway.defaultRequestTemplates
+          : null;
+
+      const defaultTemplates =
+        providerDefaults ||
+        {
+          'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
+          'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
+        };
+
+      Object.assign(integrationRequestTemplates, defaultTemplates);
     }
 
     // set custom request templates if provided
@@ -212,6 +226,15 @@ module.exports = {
       Object.assign(integrationRequestTemplates, http.request.template);
     }
 
+    // Remove any templates explicitly disabled (value set to false)
+    // and ensure only string-valued templates are passed to CloudFormation
+    Object.keys(integrationRequestTemplates).forEach(contentType => {
+      const template = integrationRequestTemplates[contentType];
+      if (template === false || typeof template !== 'string') {
+        delete integrationRequestTemplates[contentType];
+      }
+    });
+
     return Object.keys(integrationRequestTemplates).length
       ? integrationRequestTemplates
       : undefined;
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..2bdb24092 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,20 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      // Validate template values: allow strings and boolean false (to disable defaults)
+      if (http.request.template && typeof http.request.template === 'object') {
+        Object.keys(http.request.template).forEach(ct => {
+          const tpl = http.request.template[ct];
+          if (tpl !== false && typeof tpl !== 'string') {
+            const errorMessage = [
+              'Invalid template value for content type "',
+              ct,
+              '". Expected a string or false to disable.',
+            ].join('');
+            throw new this.serverless.classes.Error(errorMessage);
+          }
+        });
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:35:50,106 - thread-135845287823040.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:35:50,147 - thread-135845287823040.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:35:50,147 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:35:50,249 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:50,249 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 56aa5aa15 feat(Standalone): Prevent accidental upgrades to a new major
[?2004l
2025-11-13 20:35:50,249 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:35:50,351 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:50,351 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:35:50,352 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:35:50,352 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory docs/providers/aws/events in the container
2025-11-13 20:35:50,352 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p docs/providers/aws/events
2025-11-13 20:35:50,454 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:50,454 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:35:50,454 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib in the container
2025-11-13 20:35:50,454 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib
2025-11-13 20:35:50,556 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:50,556 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib
[?2004l
[?2004l
2025-11-13 20:35:50,556 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib/method in the container
2025-11-13 20:35:50,556 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib/method
2025-11-13 20:35:50,657 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:50,658 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib/method
[?2004l
[?2004l
2025-11-13 20:35:50,658 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating docs/providers/aws/events/apigateway.md in the container
2025-11-13 20:35:50,659 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js in the container
2025-11-13 20:35:50,660 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js in the container
2025-11-13 20:35:50,668 - thread-135845287823040.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:35:50,669 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:35:50,670 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:35:54,829 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Jh6sR7W7Q8LcyJVdm2Kx6u1U', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 282, 'prompt_tokens': 692, 'total_tokens': 974, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5dd834b5-6e8f-47d0-994a-63a45f5ca7d9-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_Jh6sR7W7Q8LcyJVdm2Kx6u1U', 'type': 'tool_call'}] usage_metadata={'input_tokens': 692, 'output_tokens': 282, 'total_tokens': 974, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:35:54,833 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:35:54,934 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:54,934 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1628
drwxr-xr-x   1 root root    4096 Nov 13 20:30 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:35 [01;34m..[0m
-rw-r--r--   1 root root     273 Nov 13 20:30 .editorconfig
drwxrwxr-x   1 root root    4096 Nov 13 20:35 [01;34m.git[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34m.github[0m
-rwxr-xr-x   1 root root      90 Nov 13 20:30 [01;32m.gitignore[0m
-rw-r--r--   1 root root      28 Nov 13 20:30 .npmignore
-rw-r--r--   1 root root      71 Nov 13 20:30 .prettierignore
-rw-r--r--   1 root root  187937 Nov 13 20:30 CHANGELOG.md
-rw-r--r--   1 root root    3292 Nov 13 20:30 CODE_OF_CONDUCT.md
-rw-r--r--   1 root root    5668 Nov 13 20:30 CONTRIBUTING.md
-rw-r--r--   1 root root     324 Nov 13 20:30 Dockerfile
-rw-r--r--   1 root root    1086 Nov 13 20:30 LICENSE.txt
-rw-r--r--   1 root root   13983 Nov 13 20:30 README.md
-rw-r--r--   1 root root    7692 Nov 13 20:30 README_CN.md
-rw-r--r--   1 root root    3191 Nov 13 20:30 RELEASE_PROCESS.md
-rw-r--r--   1 root root    3896 Nov 13 20:30 VERSIONING.md
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mbin[0m
-rw-r--r--   1 root root    1313 Nov 13 20:30 commitlint.config.js
-rw-r--r--   1 root root    3996 Nov 13 20:30 docker-compose.yml
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mdocs[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mlib[0m
drwxr-xr-x 947 root root   36864 Aug 28 02:00 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1282306 Aug 28 01:59 package-lock.json
-rw-r--r--   1 root root    6437 Nov 13 20:30 package.json
-rw-r--r--   1 root root      86 Nov 13 20:30 prettier.config.js
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mscripts[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mtest[0m
[?2004l
2025-11-13 20:35:56,360 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_AfR3qLWuaGLxKPm8QJcSaEQ9', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 1567, 'total_tokens': 1593, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--ad831bf5-2df3-4fa5-8c15-a71d0dcab668-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_AfR3qLWuaGLxKPm8QJcSaEQ9', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1567, 'output_tokens': 26, 'total_tokens': 1593, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:35:56,363 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:35:56,464 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:35:56,464 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.80.0",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "author": "serverless.com",
  "repository": "serverless/serverless",
  "keywords": [
    "serverless",
    "lambda",
    "aws",
    "amazon",
    "azure",
    "google-cloud",
    "apache-open-whisk",
    "iot"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "dependencies": {
    "@serverless/cli": "^1.5.2",
    "@serverless/components": "^2.34.7",
    "@serverless/enterprise-plugin": "^3.8.1",
    "@serverless/inquirer": "^1.1.2",
    "@serverless/utils": "^1.2.0",
    "ajv": "^6.12.4",
    "ajv-keywords": "^3.5.2",
    "archiver": "^3.1.1",
    "aws-sdk": "^2.739.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.1",
    "d": "^1.0.1",
    "dayjs": "^1.8.34",
    "decompress": "^4.2.1",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^8.1.0",
    "get-stdin": "^6.0.0",
    "globby": "^9.2.0",
    "graceful-fs": "^4.2.4",
    "https-proxy-agent": "^5.0.0",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.2.0",
    "js-yaml": "^3.14.0",
    "json-cycle": "^1.3.0",
    "json-refs": "^3.0.15",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.20",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.4",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.1.0",
    "node-fetch": "^2.6.0",
    "object-hash": "^2.0.3",
    "p-limit": "^2.3.0",
    "promise-queue": "^2.2.5",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^6.3.0",
    "semver-regex": "^2.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "timers-ext": "^0.1.7",
    "type": "^2.1.0",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^3.4.0",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^18.1.3"
  },
  "devDependencies": {
    "@commitlint/cli": "^9.1.2",
    "@serverless/eslint-config": "^2.2.0",
    "@serverless/test": "^4.6.0",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "cos-nodejs-sdk-v5": "^2.6.2",
    "eslint": "^7.7.0",
    "eslint-plugin-import": "^2.22.0",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "husky": "^4.2.5",
    "jszip": "^3.5.0",
    "lint-staged": "^10.2.13",
    "log": "^6.0.0",
    "mocha": "^6.2.3",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^15.1.0",
    "pkg": "^4.4.9",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^8.1.1",
    "sinon-chai": "^3.5.0",
    "standard-version": "^8.0.2",
    "strip-ansi": "^5.2.0",
    "ws": "^7.3.1",
    "xml2js": "^0.4.23"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node/6",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/**"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "!/.github",
    "/lib/plugins/create/templates/**",
    "/lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./test/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      ".github",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "test/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    },
    "types": [
      {
        "type": "feat",
        "section": "Features"
      },
      {
        "type": "fix",
        "section": "Bug Fixes"
      },
      {
        "type": "perf",
        "section": "Performance Improvements"
      },
      {
        "type": "refactor",
        "section": "Maintanance Improvements"
      }
    ]
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.js": [
      "eslint"
    ],
    "*.{css,html,js,json,md,yaml,yml}": [
      "prettier -c"
    ]
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node test/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 test/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha test/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check test/integration-package/**/*.tests.js",
    "lint": "eslint .",
    "lint:updated": "pipe-git-updated --ext=js -- eslint",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload/index.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "engines": {
    "node": ">=6.0"
  },
  "license": "MIT"
}
[?2004l
2025-11-13 20:36:00,256 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_5MHxajIG4ZgT2c3vdE424cWW', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 367, 'prompt_tokens': 3846, 'total_tokens': 4213, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 320, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--0b3f7b72-5ccd-41f9-9083-fd4abff89a8e-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_5MHxajIG4ZgT2c3vdE424cWW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3846, 'output_tokens': 367, 'total_tokens': 4213, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 320}}
2025-11-13 20:36:00,259 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:36:00,361 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:00,361 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/package/compile/event
ts/apiGateway/lib/method/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsCompileApigEvents = require('../../index');
const Serverless = require('../../../../../../../../Serverless');
const AwsProvider = require('../../../../../../provider/awsProvider');

describe('#compileMethods()', () => {
  let serverless;
  let awsCompileApigEvents;

  beforeEach(() => {
    const options = {
      stage: 'dev',
      region: 'us-east-1',
    };
    serverless = new Serverless();
    serverless.setProvider('aws', new AwsProvider(serverless, options));
    serverless.service.service = 'first-service';
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.service.environment = {
      stages: {
        dev: {
          regions: {
            'us-east-1': {
              vars: {
                IamRoleLambdaExecution:
                  'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
              },
            },
          },
        },
      },
    };
    serverless.service.functions.First = {};
    serverless.service.functions.Second = {};
    serverless.service.functions.Third = {};
    awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
    awsCompileApigEvents.validated = {};
    awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
    awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
    awsCompileApigEvents.apiGatewayResources = {
      'users/create': {
        name: 'UsersCreate',
        resourceLogicalId: 'ApiGatewayResourceUsersCreate',
      },

      'users/list': {
        name: 'UsersList',
        resourceLogicalId: 'ApiGatewayResourceUsersList',
      },
      'users/update': {
        name: 'UsersUpdate',
        resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
      },
      'users/delete': {
        name: 'UsersDelete',
        resourceLogicalId: 'ApiGatewayResourceUsersDelete',
      },
    };
  });

  it('should have request validators/models defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' } } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should support multiple request schemas', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
        'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should have request parameters defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
            },
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
[?2004l
2025-11-13 20:36:01,570 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_spXlgTG8J4Fsp7EMSBOlZcob', 'function': {'arguments': '{"command":"sed -n \'200,400p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 5467, 'total_tokens': 5508, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--c1d4dc0e-9a5c-471f-903b-4addcd26ffc5-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_spXlgTG8J4Fsp7EMSBOlZcob', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5467, 'output_tokens': 41, 'total_tokens': 5508, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:01,573 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:36:01,675 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:01,675 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,400p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
    });
  });

  it('should not have integration RequestParameters when no request parameters are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration
      ).to.not.have.key('RequestParameters');
    });
  });

  it('should create method resources when http events given', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Type
      ).to.equal('AWS::ApiGateway::Method');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Type
      ).to.equal('AWS::ApiGateway::Method');
    });
  });

  it('should support AWS integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support AWS_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS_PROXY');
    });
  });

  it('should support HTTP integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('POST');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
      ).to.equal(undefined);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support HTTP integration type with custom request options', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            method: 'put',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
[?2004l
2025-11-13 20:36:03,181 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PHObGbyc2HE5xM7KA6xJsmck', 'function': {'arguments': '{"command":"sed -n \'400,800p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 7053, 'total_tokens': 7094, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--4b9613c9-f132-41d5-9f2a-cabcac187680-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_PHObGbyc2HE5xM7KA6xJsmck', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7053, 'output_tokens': 41, 'total_tokens': 7094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:03,184 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:36:03,287 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:03,287 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '400,800p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PUT');
    });
  });

  it('should support HTTP_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            method: 'patch',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP_PROXY');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PATCH');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support MOCK integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'MOCK',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('MOCK');
    });
  });

  it('should add request parameter when async config is used', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter when integration type is AWS_PROXY and async', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter mapped value when explicitly defined', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.querystring.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.path.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.path.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.header.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.header.bar': {
                required: false,
                mappedValue: 'barValue',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'fooValue',
        'integration.request.querystring.bar': 'barValue',
        'integration.request.path.foo': 'fooValue',
        'integration.request.path.bar': 'barValue',
        'integration.request.header.foo': 'fooValue',
        'integration.request.header.bar': 'barValue',
      });
    });
  });

  it('should set authorizer config for AWS_IAM', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'AWS_IAM',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('AWS_IAM');
    });
  });

  it('should set custom authorizer config with authorizerId', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'COGNITO_USER_POOLS',
            authorizerId: 'gy7lyj',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
      ).to.equal('gy7lyj');
    });
  });

  it('should set authorizer config if given as ARN string', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'Authorizer',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('CUSTOM');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('CognitoAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            arn: {
              'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
            },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

[?2004l
2025-11-13 20:36:04,902 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_yA9h14N1hzNVUSh7IhSHgVlf', 'function': {'arguments': '{"command":"sed -n \'800,1200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 42, 'prompt_tokens': 10117, 'total_tokens': 10159, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fe1dc8a9-2d58-44f4-811d-a193d5b1b549-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_yA9h14N1hzNVUSh7IhSHgVlf', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10117, 'output_tokens': 42, 'total_tokens': 10159, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:04,906 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:36:05,008 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:05,008 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '800,1200p' lib/plugins/aws/package/compile/ev
vents/apiGateway/lib/method/index.test.js
[?2004l

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should not scopes for a cognito user pool when given empty scopes array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: [],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.property('AuthorizationScopes');
    });
  });

  it('should set claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
    });
  });

  it('should set multiple claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'gender'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
    });
  });

  it('should properly set claims for custom properties inside the cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'custom:score'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
    });
  });

  it('should replace the extra claims in the template if there are none', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/extraCognitoPoolClaims/);
    });
  });

  it('should not create method resources when http events are not given', () => {
    awsCompileApigEvents.validated.events = [];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });

  it('should update the method logical ids array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
        'ApiGatewayMethodUsersCreatePost',
        'ApiGatewayMethodUsersListGet',
      ]);
    });
  });

  it('should set api key as required if private endpoint', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          private: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(true);
    });
  });

  it('should set api key as not required if private property is not specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(false);
    });
  });

  it('should set the correct lambdaUri', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
    });
  });

  it('Should point target alias if set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'Provisioned',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    serverless.service.functions.Provisioned = {
      targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
    };
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
            ':',
            'provisioned',
            '/invocations',
          ],
        ],
      });
    });
  });

  it('should add CORS origins to method only when CORS is enabled', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Third',
        http: {
          path: 'users/update',
          method: 'PUT',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
          cors: {
            origins: ['*'],
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'http://example.com'");

      // CORS not enabled!
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.not.equal("'*'");

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'*'");
    });
  });

  it('should set CORS allowCredentials to method only when specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
[?2004l
2025-11-13 20:36:06,653 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_aSYSr0wJomw1PXgsjZP9n0f8', 'function': {'arguments': '{"command":"sed -n \'1200,1600p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 13005, 'total_tokens': 13048, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--46b8c27d-a197-4357-b376-1291ceb4b372-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_aSYSr0wJomw1PXgsjZP9n0f8', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13005, 'output_tokens': 43, 'total_tokens': 13048, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:06,657 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:36:06,759 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:06,759 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1200,1600p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
            allowCredentials: true,
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.equal('true');

      // allowCredentials not enabled
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.not.equal('true');
    });
  });

  describe('when dealing with request configuration', () => {
    it('should setup a default "application/json" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should setup a default "application/x-www-form-urlencoded" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/x-www-form-urlencoded'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should use defined pass-through behavior', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              passThrough: 'WHEN_NO_TEMPLATES',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
        ).to.equal('WHEN_NO_TEMPLATES');
      });
    });

    it('should use defined content-handling behavior (request)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              contentHandling: 'CONVERT_TO_TEXT',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
        ).to.equal('CONVERT_TO_TEXT');
      });
    });

    it('should use defined response content-handling behavior for 2XX only (response)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              contentHandling: 'CONVERT_TO_BINARY',
              statusCodes: {
                200: {
                  pattern: '',
                },
                400: {
                  pattern: '400',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ContentHandling
        ).to.equal('CONVERT_TO_BINARY');
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
            .ContentHandling
        ).to.equal(undefined);
      });
    });

    it('should set custom request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'template/1': '{ "stage" : "$context.stage" }',
                'template/2': '{ "httpMethod" : "$context.httpMethod" }',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
        ).to.equal('{ "stage" : "$context.stage" }');

        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
        ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
      });
    });

    it('should be possible to overwrite default request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'application/json': 'overwritten-request-template-content',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.equal('overwritten-request-template-content');
      });
    });
  });

  describe('when dealing with response configuration', () => {
    it('should set the custom headers', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                  headers: {
                    'Content-Type': "'text/plain'",
                    'My-Custom-Header': 'my/custom/header',
                  },
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.Content-Type']
        ).to.equal("'text/plain'");
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.My-Custom-Header']
        ).to.equal('my/custom/header');
      });
    });

    it('should set the custom template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  template: "$input.path('$.foo')",
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseTemplates['application/json']
        ).to.equal("$input.path('$.foo')");
      });
    });
  });

  it('should add method responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
      ).to.equal('200');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
      ).to.equal('202');
    });
  });

  it('should add integration responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
      ).to.deep.equal({
        StatusCode: '202',
        SelectionPattern: 'foo',
        ResponseParameters: {},
        ResponseTemplates: {},
[?2004l
2025-11-13 20:36:08,164 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_2SdRWLFvFJuPNqeYb96bZ25r', 'function': {'arguments': '{"command":"sed -n \'1600,2000p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 15549, 'total_tokens': 15592, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--220b750b-fccc-4b09-bda6-812a7265721b-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_2SdRWLFvFJuPNqeYb96bZ25r', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15549, 'output_tokens': 43, 'total_tokens': 15592, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:08,168 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:36:08,270 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:08,270 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1600,2000p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
      ).to.deep.equal({
        StatusCode: '200',
        SelectionPattern: '',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
    });
  });

  it('should add fall back headers and template to statusCodes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            headers: {
              'Content-Type': 'text/csv',
            },
            template: 'foo',
            statusCodes: {
              400: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal('foo');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
    });
  });

  it('should add custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
                template: "$input.path('$.foo')",
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: "$input.path('$.errorMessage')",
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should add multiple response templates for a custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                template: "$input.path('$.foo')",
                headers: {
                  'Content-Type': 'text/csv',
                },
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: {
                  'application/json': "$input.path('$.errorMessage')",
                  'application/xml': "$input.path('$.xml.errorMessage')",
                },
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/xml']
      ).to.equal("$input.path('$.xml.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should use defined content-handling behavior', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            contentHandling: 'CONVERT_TO_BINARY',
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ContentHandling
      ).to.equal('CONVERT_TO_BINARY');
    });
  });

  it('should handle root resource methods', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: '',
          method: 'GET',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodGet.Properties.ResourceId
      ).to.deep.equal({
        'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
      });
    });
  });

  it('should include operation id as OperationName when it is set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          operationId: 'createUser',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.OperationName
      ).to.equal('createUser');
    });
  });

  it('should not include operation id when it is not set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.key('OperationName');
    });
  });
});
[?2004l
2025-11-13 20:36:19,163 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_aqccrUmYT71UHJ2Dr4a4I8jb', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should setup a default \\\\\\"application/json\\\\\\" template\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 572, 'prompt_tokens': 17545, 'total_tokens': 18117, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8c0caa20-240a-44d7-86f3-aa697f42b7f0-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\"application/json\\" template"'}, 'id': 'call_aqccrUmYT71UHJ2Dr4a4I8jb', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17545, 'output_tokens': 572, 'total_tokens': 18117, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:36:19,166 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \"application/json\" template"
2025-11-13 20:36:20,183 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:20,183 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/json\" template"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:540) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:36:25,893 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_3uOdlgyepSufanP1XKnYxDwF', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should setup a default \\\\\\"application/x-www-form-urlencoded\\\\\\" template\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 575, 'prompt_tokens': 17847, 'total_tokens': 18422, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5c6e0f30-a721-4f27-a092-303df32c2376-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\"application/x-www-form-urlencoded\\" template"'}, 'id': 'call_3uOdlgyepSufanP1XKnYxDwF', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17847, 'output_tokens': 575, 'total_tokens': 18422, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:36:25,896 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \"application/x-www-form-urlencoded\" template"
2025-11-13 20:36:26,916 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:26,917 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/x-www-form-urlencoded\" template"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:547) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m

[?2004l
2025-11-13 20:36:28,253 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_OtX8lE9Pud0ErHInCAZig0ga', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should be possible to overwrite default request templates\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 51, 'prompt_tokens': 18158, 'total_tokens': 18209, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 15488}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--2c5940b7-645f-46f5-b0ce-e9a64773ddb1-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should be possible to overwrite default request templates"'}, 'id': 'call_OtX8lE9Pud0ErHInCAZig0ga', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18158, 'output_tokens': 51, 'total_tokens': 18209, 'input_token_details': {'audio': 0, 'cache_read': 15488}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:28,257 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should be possible to overwrite default request templates"
2025-11-13 20:36:29,316 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:29,316 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should be possible to ov
verwrite default request templates"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:554) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

[?2004l
2025-11-13 20:36:31,759 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_nTRmsUEYhJV56Brph8LbDvg6', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should set custom request templates\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 48, 'prompt_tokens': 18457, 'total_tokens': 18505, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1d81c72d-7ec9-4b57-a4d2-6080c3942cd6-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should set custom request templates"'}, 'id': 'call_nTRmsUEYhJV56Brph8LbDvg6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18457, 'output_tokens': 48, 'total_tokens': 18505, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:31,762 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should set custom request templates"
2025-11-13 20:36:32,790 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:32,790 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should set custom reques
st templates"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:561) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:36:34,687 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_REJBiAnBlA20pW7rAffdMYes', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should support HTTP integration type$\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 49, 'prompt_tokens': 18747, 'total_tokens': 18796, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18432}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e3e956c5-e830-4c04-9d3f-dca4bf291f59-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type$"'}, 'id': 'call_REJBiAnBlA20pW7rAffdMYes', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18747, 'output_tokens': 49, 'total_tokens': 18796, 'input_token_details': {'audio': 0, 'cache_read': 18432}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:36:34,691 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type$"
2025-11-13 20:36:35,693 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:36:35,694 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP inte
egration type$"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:568) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:36:52,110 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\\n\\"application/json\\" template"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:540) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/json" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (22ms)\x1b[0m\n\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \\\n\\"application/x-www-form-urlencoded\\" template"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:547) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/x-www-form-urlencoded" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (23ms)\x1b[0m\n\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should be possible to ov\nverwrite default request templates"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:554) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should be possible to overwrite default request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (21ms)\x1b[0m\n\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should set custom reques\nst templates"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:561) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should set custom request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (22ms)\x1b[0m\n\n\n ./node_modules/.bin/mocha lib/plugins/aws/package/com\nmpile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP inte\negration type$"\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n(node:568) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n  \x1b[32m  ✓\x1b[0m\x1b[90m should support HTTP integration type\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (22ms)\x1b[0m\n\nTotal tests run: 5\nAll passed' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 2215, 'prompt_tokens': 19025, 'total_tokens': 21240, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1088, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17792}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--72bfa6eb-14b1-4ce8-ba95-49e0dcccdf32-0' usage_metadata={'input_tokens': 19025, 'output_tokens': 2215, 'total_tokens': 21240, 'input_token_details': {'audio': 0, 'cache_read': 17792}, 'output_token_details': {'audio': 0, 'reasoning': 1088}}
2025-11-13 20:36:52,112 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/json\" template"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:540) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m


 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should setup a default \
\"application/x-www-form-urlencoded\" template"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:547) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m


 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should be possible to ov
verwrite default request templates"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:554) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m


 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should set custom reques
st templates"

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:561) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m


 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP inte
egration type$"

[0m[0m
[0m  #compileMethods()[0m
(node:568) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

Total tests run: 5
All passed
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:36:59,823 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type'] regression_test_fail_log='' total_tests_run=5
2025-11-13 20:36:59,825 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:36:59,825 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:36:59,826 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:36:59,826 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:36:59,826 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - True
2025-11-13 20:36:59,828 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..194b6dc51 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -937,6 +937,10 @@ Serverless ships with the following default request templates you can use out of
 1. `application/json`
 2. `application/x-www-form-urlencoded`
 
+By default, these templates are added only for the Lambda (AWS) integration. You can control defaults as follows:
+- Disable all defaults for a given endpoint by setting `request.useDefaultTemplates: false`
+- Remove a specific default by setting its content type under `request.template` to `null` or `false` (e.g., `application/x-www-form-urlencoded: null`)
+
 Both templates give you access to the following properties you can access with the help of the `event` object:
 
 - body
@@ -953,7 +957,9 @@ Both templates give you access to the following properties you can access with t
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
-by defining a new request template for an existing content type):
+by defining a new request template for an existing content type). You can also remove defaults:
+
+- Remove a single default template:
 
 ```yml
 functions:
@@ -966,10 +972,27 @@ functions:
           integration: lambda
           request:
             template:
-              text/xhtml: '{ "stage" : "$context.stage" }'
+              application/x-www-form-urlencoded: null # removes this default
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
 ```
 
+- Disable all default templates and provide only explicit templates:
+
+```yml
+functions:
+  create:
+    handler: posts.create
+    events:
+      - http:
+          method: get
+          path: whatever
+          integration: lambda
+          request:
+            useDefaultTemplates: false
+            template:
+              text/xhtml: '{ "stage" : "$context.stage" }'
+```
+
 **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
 
 **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
@@ -1026,6 +1049,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates
 **Notes:**
 
 - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)
+- If you disable all default templates for Lambda integration and do not define any templates, the default `passThrough` for Lambda integration is `NEVER`, which will cause API Gateway to return `415 - Unsupported Media Type` for unmatched content types. You can change this behavior via `request.passThrough`.
 - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)
 
 ### Responses
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..e355368cb 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -199,8 +199,11 @@ module.exports = {
     // default request templates
     const integrationRequestTemplates = {};
 
-    // Only set defaults for AWS (lambda) integration
-    if (useDefaults) {
+    // Determine whether default templates should be used (only for AWS (lambda) integration)
+    const useDefaultsAfterConfig =
+      useDefaults && !(http.request && http.request.useDefaultTemplates === false);
+
+    if (useDefaultsAfterConfig) {
       Object.assign(integrationRequestTemplates, {
         'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
         'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
@@ -209,7 +212,16 @@ module.exports = {
 
     // set custom request templates if provided
     if (http.request && typeof http.request.template === 'object') {
-      Object.assign(integrationRequestTemplates, http.request.template);
+      _.forEach(http.request.template, (value, key) => {
+        if (value === null || value === false) {
+          // Explicitly remove this content type from the final templates
+          if (Object.prototype.hasOwnProperty.call(integrationRequestTemplates, key)) {
+            delete integrationRequestTemplates[key];
+          }
+        } else {
+          integrationRequestTemplates[key] = value;
+        }
+      });
     }
 
     return Object.keys(integrationRequestTemplates).length
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..10b0ade05 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,16 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      if (
+        typeof http.request.useDefaultTemplates !== 'undefined' &&
+        typeof http.request.useDefaultTemplates !== 'boolean'
+      ) {
+        const errorMessage = [
+          'useDefaultTemplates config must be provided as a boolean.',
+          ' Please check the docs for more info.',
+        ].join('');
+        throw new this.serverless.classes.Error(errorMessage);
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:36:59,866 - thread-135845287823040.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:36:59,901 - thread-135845287823040.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:36:59,901 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:37:00,003 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:00,003 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 56aa5aa15 feat(Standalone): Prevent accidental upgrades to a new major
[?2004l
2025-11-13 20:37:00,003 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:37:00,105 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:00,105 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:37:00,106 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:37:00,106 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory docs/providers/aws/events in the container
2025-11-13 20:37:00,106 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p docs/providers/aws/events
2025-11-13 20:37:00,208 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:00,208 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:37:00,208 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib in the container
2025-11-13 20:37:00,208 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib
2025-11-13 20:37:00,310 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:00,310 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib
[?2004l
[?2004l
2025-11-13 20:37:00,310 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib/method in the container
2025-11-13 20:37:00,310 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib/method
2025-11-13 20:37:00,412 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:00,412 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib/method
[?2004l
[?2004l
2025-11-13 20:37:00,412 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating docs/providers/aws/events/apigateway.md in the container
2025-11-13 20:37:00,413 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js in the container
2025-11-13 20:37:00,414 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js in the container
2025-11-13 20:37:00,422 - thread-135845287823040.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:37:00,423 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:37:00,423 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:37:01,988 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_Li525s5qLnL81J5dPxFLFxFE', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 692, 'total_tokens': 782, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--f4516be3-c838-481c-abaa-b30e827a9c3d-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_Li525s5qLnL81J5dPxFLFxFE', 'type': 'tool_call'}] usage_metadata={'input_tokens': 692, 'output_tokens': 90, 'total_tokens': 782, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:37:01,991 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:37:02,093 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:02,093 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1628
drwxr-xr-x   1 root root    4096 Nov 13 20:30 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:37 [01;34m..[0m
-rw-r--r--   1 root root     273 Nov 13 20:30 .editorconfig
drwxrwxr-x   1 root root    4096 Nov 13 20:36 [01;34m.git[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34m.github[0m
-rwxr-xr-x   1 root root      90 Nov 13 20:30 [01;32m.gitignore[0m
-rw-r--r--   1 root root      28 Nov 13 20:30 .npmignore
-rw-r--r--   1 root root      71 Nov 13 20:30 .prettierignore
-rw-r--r--   1 root root  187937 Nov 13 20:30 CHANGELOG.md
-rw-r--r--   1 root root    3292 Nov 13 20:30 CODE_OF_CONDUCT.md
-rw-r--r--   1 root root    5668 Nov 13 20:30 CONTRIBUTING.md
-rw-r--r--   1 root root     324 Nov 13 20:30 Dockerfile
-rw-r--r--   1 root root    1086 Nov 13 20:30 LICENSE.txt
-rw-r--r--   1 root root   13983 Nov 13 20:30 README.md
-rw-r--r--   1 root root    7692 Nov 13 20:30 README_CN.md
-rw-r--r--   1 root root    3191 Nov 13 20:30 RELEASE_PROCESS.md
-rw-r--r--   1 root root    3896 Nov 13 20:30 VERSIONING.md
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mbin[0m
-rw-r--r--   1 root root    1313 Nov 13 20:30 commitlint.config.js
-rw-r--r--   1 root root    3996 Nov 13 20:30 docker-compose.yml
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mdocs[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mlib[0m
drwxr-xr-x 947 root root   36864 Aug 28 02:00 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1282306 Aug 28 01:59 package-lock.json
-rw-r--r--   1 root root    6437 Nov 13 20:30 package.json
-rw-r--r--   1 root root      86 Nov 13 20:30 prettier.config.js
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mscripts[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mtest[0m
[?2004l
2025-11-13 20:37:03,334 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_vC3e3Bx1AaGvuVC0Awc62exW', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 1567, 'total_tokens': 1593, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--647afcbe-a095-46db-b0b8-ff4951140503-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_vC3e3Bx1AaGvuVC0Awc62exW', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1567, 'output_tokens': 26, 'total_tokens': 1593, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:03,338 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:37:03,440 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:03,440 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.80.0",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "author": "serverless.com",
  "repository": "serverless/serverless",
  "keywords": [
    "serverless",
    "lambda",
    "aws",
    "amazon",
    "azure",
    "google-cloud",
    "apache-open-whisk",
    "iot"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "dependencies": {
    "@serverless/cli": "^1.5.2",
    "@serverless/components": "^2.34.7",
    "@serverless/enterprise-plugin": "^3.8.1",
    "@serverless/inquirer": "^1.1.2",
    "@serverless/utils": "^1.2.0",
    "ajv": "^6.12.4",
    "ajv-keywords": "^3.5.2",
    "archiver": "^3.1.1",
    "aws-sdk": "^2.739.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.1",
    "d": "^1.0.1",
    "dayjs": "^1.8.34",
    "decompress": "^4.2.1",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^8.1.0",
    "get-stdin": "^6.0.0",
    "globby": "^9.2.0",
    "graceful-fs": "^4.2.4",
    "https-proxy-agent": "^5.0.0",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.2.0",
    "js-yaml": "^3.14.0",
    "json-cycle": "^1.3.0",
    "json-refs": "^3.0.15",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.20",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.4",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.1.0",
    "node-fetch": "^2.6.0",
    "object-hash": "^2.0.3",
    "p-limit": "^2.3.0",
    "promise-queue": "^2.2.5",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^6.3.0",
    "semver-regex": "^2.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "timers-ext": "^0.1.7",
    "type": "^2.1.0",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^3.4.0",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^18.1.3"
  },
  "devDependencies": {
    "@commitlint/cli": "^9.1.2",
    "@serverless/eslint-config": "^2.2.0",
    "@serverless/test": "^4.6.0",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "cos-nodejs-sdk-v5": "^2.6.2",
    "eslint": "^7.7.0",
    "eslint-plugin-import": "^2.22.0",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "husky": "^4.2.5",
    "jszip": "^3.5.0",
    "lint-staged": "^10.2.13",
    "log": "^6.0.0",
    "mocha": "^6.2.3",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^15.1.0",
    "pkg": "^4.4.9",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^8.1.1",
    "sinon-chai": "^3.5.0",
    "standard-version": "^8.0.2",
    "strip-ansi": "^5.2.0",
    "ws": "^7.3.1",
    "xml2js": "^0.4.23"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node/6",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/**"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "!/.github",
    "/lib/plugins/create/templates/**",
    "/lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./test/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      ".github",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "test/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    },
    "types": [
      {
        "type": "feat",
        "section": "Features"
      },
      {
        "type": "fix",
        "section": "Bug Fixes"
      },
      {
        "type": "perf",
        "section": "Performance Improvements"
      },
      {
        "type": "refactor",
        "section": "Maintanance Improvements"
      }
    ]
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.js": [
      "eslint"
    ],
    "*.{css,html,js,json,md,yaml,yml}": [
      "prettier -c"
    ]
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node test/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 test/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha test/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check test/integration-package/**/*.tests.js",
    "lint": "eslint .",
    "lint:updated": "pipe-git-updated --ext=js -- eslint",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload/index.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "engines": {
    "node": ">=6.0"
  },
  "license": "MIT"
}
[?2004l
2025-11-13 20:37:09,506 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_qNA3PRSetyMIF3a3s0cVVtCU', 'function': {'arguments': '{"command":"sed -n \'1,220p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 559, 'prompt_tokens': 3846, 'total_tokens': 4405, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bc206949-0467-4559-a31d-e9e7302e39c8-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,220p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_qNA3PRSetyMIF3a3s0cVVtCU', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3846, 'output_tokens': 559, 'total_tokens': 4405, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:37:09,510 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,220p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:37:09,612 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:09,612 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,220p' lib/plugins/aws/package/compile/event
ts/apiGateway/lib/method/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsCompileApigEvents = require('../../index');
const Serverless = require('../../../../../../../../Serverless');
const AwsProvider = require('../../../../../../provider/awsProvider');

describe('#compileMethods()', () => {
  let serverless;
  let awsCompileApigEvents;

  beforeEach(() => {
    const options = {
      stage: 'dev',
      region: 'us-east-1',
    };
    serverless = new Serverless();
    serverless.setProvider('aws', new AwsProvider(serverless, options));
    serverless.service.service = 'first-service';
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.service.environment = {
      stages: {
        dev: {
          regions: {
            'us-east-1': {
              vars: {
                IamRoleLambdaExecution:
                  'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
              },
            },
          },
        },
      },
    };
    serverless.service.functions.First = {};
    serverless.service.functions.Second = {};
    serverless.service.functions.Third = {};
    awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
    awsCompileApigEvents.validated = {};
    awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
    awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
    awsCompileApigEvents.apiGatewayResources = {
      'users/create': {
        name: 'UsersCreate',
        resourceLogicalId: 'ApiGatewayResourceUsersCreate',
      },

      'users/list': {
        name: 'UsersList',
        resourceLogicalId: 'ApiGatewayResourceUsersList',
      },
      'users/update': {
        name: 'UsersUpdate',
        resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
      },
      'users/delete': {
        name: 'UsersDelete',
        resourceLogicalId: 'ApiGatewayResourceUsersDelete',
      },
    };
  });

  it('should have request validators/models defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' } } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should support multiple request schemas', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
        'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should have request parameters defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
            },
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
    });
  });

  it('should not have integration RequestParameters when no request parameters are set', () => {
[?2004l
2025-11-13 20:37:10,719 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_P4e8PTkxT3Fl5N2J7Oa3LauS', 'function': {'arguments': '{"command":"sed -n \'220,680p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 5632, 'total_tokens': 5673, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 1536}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--e4f604ee-4e36-4cff-9078-f340eccacd63-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '220,680p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_P4e8PTkxT3Fl5N2J7Oa3LauS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5632, 'output_tokens': 41, 'total_tokens': 5673, 'input_token_details': {'audio': 0, 'cache_read': 1536}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:10,723 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '220,680p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:37:10,826 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:10,826 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '220,680p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
  it('should not have integration RequestParameters when no request parameters are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration
      ).to.not.have.key('RequestParameters');
    });
  });

  it('should create method resources when http events given', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Type
      ).to.equal('AWS::ApiGateway::Method');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Type
      ).to.equal('AWS::ApiGateway::Method');
    });
  });

  it('should support AWS integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support AWS_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS_PROXY');
    });
  });

  it('should support HTTP integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('POST');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
      ).to.equal(undefined);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support HTTP integration type with custom request options', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            method: 'put',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PUT');
    });
  });

  it('should support HTTP_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            method: 'patch',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP_PROXY');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PATCH');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support MOCK integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'MOCK',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('MOCK');
    });
  });

  it('should add request parameter when async config is used', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter when integration type is AWS_PROXY and async', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter mapped value when explicitly defined', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.querystring.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.path.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.path.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.header.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.header.bar': {
                required: false,
                mappedValue: 'barValue',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'fooValue',
        'integration.request.querystring.bar': 'barValue',
        'integration.request.path.foo': 'fooValue',
        'integration.request.path.bar': 'barValue',
        'integration.request.header.foo': 'fooValue',
        'integration.request.header.bar': 'barValue',
      });
    });
  });

  it('should set authorizer config for AWS_IAM', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'AWS_IAM',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('AWS_IAM');
    });
  });

  it('should set custom authorizer config with authorizerId', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'COGNITO_USER_POOLS',
            authorizerId: 'gy7lyj',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
      ).to.equal('gy7lyj');
    });
  });

  it('should set authorizer config if given as ARN string', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'Authorizer',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('CUSTOM');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
[?2004l
2025-11-13 20:37:12,664 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_NMrc1arMEzAvl5bML3uyLIMT', 'function': {'arguments': '{"command":"sed -n \'680,1140p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 42, 'prompt_tokens': 9127, 'total_tokens': 9169, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3840}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--16371e45-fb82-47cd-80d9-854e380ae434-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '680,1140p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_NMrc1arMEzAvl5bML3uyLIMT', 'type': 'tool_call'}] usage_metadata={'input_tokens': 9127, 'output_tokens': 42, 'total_tokens': 9169, 'input_token_details': {'audio': 0, 'cache_read': 3840}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:12,668 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '680,1140p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:37:12,770 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:12,770 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '680,1140p' lib/plugins/aws/package/compile/ev
vents/apiGateway/lib/method/index.test.js
[?2004l
  it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('CognitoAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            arn: {
              'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
            },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should not scopes for a cognito user pool when given empty scopes array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: [],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.property('AuthorizationScopes');
    });
  });

  it('should set claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
    });
  });

  it('should set multiple claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'gender'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
    });
  });

  it('should properly set claims for custom properties inside the cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'custom:score'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
    });
  });

  it('should replace the extra claims in the template if there are none', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/extraCognitoPoolClaims/);
    });
  });

  it('should not create method resources when http events are not given', () => {
    awsCompileApigEvents.validated.events = [];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });

  it('should update the method logical ids array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
        'ApiGatewayMethodUsersCreatePost',
        'ApiGatewayMethodUsersListGet',
      ]);
    });
  });

  it('should set api key as required if private endpoint', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          private: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(true);
    });
  });

  it('should set api key as not required if private property is not specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(false);
    });
  });

  it('should set the correct lambdaUri', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
    });
  });

  it('Should point target alias if set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'Provisioned',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    serverless.service.functions.Provisioned = {
      targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
    };
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
            ':',
            'provisioned',
            '/invocations',
          ],
        ],
      });
    });
  });

  it('should add CORS origins to method only when CORS is enabled', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
[?2004l
2025-11-13 20:37:14,267 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kDy2sVQp4lsIcTRTkknRhXQp', 'function': {'arguments': '{"command":"sed -n \'1140,1670p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 12566, 'total_tokens': 12609, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--37577966-ae30-47f1-9d6d-6e065e829af3-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1140,1670p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_kDy2sVQp4lsIcTRTkknRhXQp', 'type': 'tool_call'}] usage_metadata={'input_tokens': 12566, 'output_tokens': 43, 'total_tokens': 12609, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:14,271 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1140,1670p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:37:14,374 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:14,374 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1140,1670p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Third',
        http: {
          path: 'users/update',
          method: 'PUT',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
          cors: {
            origins: ['*'],
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'http://example.com'");

      // CORS not enabled!
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.not.equal("'*'");

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'*'");
    });
  });

  it('should set CORS allowCredentials to method only when specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
            allowCredentials: true,
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.equal('true');

      // allowCredentials not enabled
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.not.equal('true');
    });
  });

  describe('when dealing with request configuration', () => {
    it('should setup a default "application/json" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should setup a default "application/x-www-form-urlencoded" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/x-www-form-urlencoded'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should use defined pass-through behavior', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              passThrough: 'WHEN_NO_TEMPLATES',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
        ).to.equal('WHEN_NO_TEMPLATES');
      });
    });

    it('should use defined content-handling behavior (request)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              contentHandling: 'CONVERT_TO_TEXT',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
        ).to.equal('CONVERT_TO_TEXT');
      });
    });

    it('should use defined response content-handling behavior for 2XX only (response)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              contentHandling: 'CONVERT_TO_BINARY',
              statusCodes: {
                200: {
                  pattern: '',
                },
                400: {
                  pattern: '400',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ContentHandling
        ).to.equal('CONVERT_TO_BINARY');
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
            .ContentHandling
        ).to.equal(undefined);
      });
    });

    it('should set custom request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'template/1': '{ "stage" : "$context.stage" }',
                'template/2': '{ "httpMethod" : "$context.httpMethod" }',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
        ).to.equal('{ "stage" : "$context.stage" }');

        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
        ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
      });
    });

    it('should be possible to overwrite default request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'application/json': 'overwritten-request-template-content',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.equal('overwritten-request-template-content');
      });
    });
  });

  describe('when dealing with response configuration', () => {
    it('should set the custom headers', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                  headers: {
                    'Content-Type': "'text/plain'",
                    'My-Custom-Header': 'my/custom/header',
                  },
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.Content-Type']
        ).to.equal("'text/plain'");
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.My-Custom-Header']
        ).to.equal('my/custom/header');
      });
    });

    it('should set the custom template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  template: "$input.path('$.foo')",
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseTemplates['application/json']
        ).to.equal("$input.path('$.foo')");
      });
    });
  });

  it('should add method responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
      ).to.equal('200');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
      ).to.equal('202');
    });
  });

  it('should add integration responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
      ).to.deep.equal({
        StatusCode: '202',
        SelectionPattern: 'foo',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
      ).to.deep.equal({
        StatusCode: '200',
        SelectionPattern: '',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
    });
  });

  it('should add fall back headers and template to statusCodes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            headers: {
              'Content-Type': 'text/csv',
            },
            template: 'foo',
            statusCodes: {
              400: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal('foo');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
    });
  });

  it('should add custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
                template: "$input.path('$.foo')",
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: "$input.path('$.errorMessage')",
                headers: {
                  'Content-Type': 'text/html',
[?2004l
2025-11-13 20:37:16,384 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_h3HYvsG5Ce0QxCmeOuDpaXSp', 'function': {'arguments': '{"command":"sed -n \'1670,2310p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 15939, 'total_tokens': 15982, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--a2ab3ac6-cb63-407a-8ccb-0d6cc2eccfeb-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1670,2310p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_h3HYvsG5Ce0QxCmeOuDpaXSp', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15939, 'output_tokens': 43, 'total_tokens': 15982, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:16,388 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1670,2310p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:37:16,489 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:16,490 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1670,2310p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should add multiple response templates for a custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                template: "$input.path('$.foo')",
                headers: {
                  'Content-Type': 'text/csv',
                },
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: {
                  'application/json': "$input.path('$.errorMessage')",
                  'application/xml': "$input.path('$.xml.errorMessage')",
                },
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/xml']
      ).to.equal("$input.path('$.xml.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should use defined content-handling behavior', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            contentHandling: 'CONVERT_TO_BINARY',
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ContentHandling
      ).to.equal('CONVERT_TO_BINARY');
    });
  });

  it('should handle root resource methods', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: '',
          method: 'GET',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodGet.Properties.ResourceId
      ).to.deep.equal({
        'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
      });
    });
  });

  it('should include operation id as OperationName when it is set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          operationId: 'createUser',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.OperationName
      ).to.equal('createUser');
    });
  });

  it('should not include operation id when it is not set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.key('OperationName');
    });
  });
});
[?2004l
2025-11-13 20:37:27,695 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_YMEFTawiwwWSTRU14YPBq7Vr', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'when dealing with request configuration should setup a default \\"application/json\\" template\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 955, 'prompt_tokens': 17486, 'total_tokens': 18441, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 896, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--703335fb-71ca-4875-aade-a88313ad2eda-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'when dealing with request configuration should setup a default "application/json" template\''}, 'id': 'call_YMEFTawiwwWSTRU14YPBq7Vr', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17486, 'output_tokens': 955, 'total_tokens': 18441, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 896}}
2025-11-13 20:37:27,699 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'when dealing with request configuration should setup a default "application/json" template'
2025-11-13 20:37:29,135 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:29,135 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should setup a default "application/json" template'
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:599) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m

[?2004l
2025-11-13 20:37:38,314 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_1AB97TVRqSAeUriJwq1RPIgM', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'when dealing with request configuration should setup a default \\"application/x-www-form-urlencoded\\" template\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 638, 'prompt_tokens': 17788, 'total_tokens': 18426, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 576, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12544}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5c9b51e1-9411-4477-b706-157f7bfd665a-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'when dealing with request configuration should setup a default "application/x-www-form-urlencoded" template\''}, 'id': 'call_1AB97TVRqSAeUriJwq1RPIgM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17788, 'output_tokens': 638, 'total_tokens': 18426, 'input_token_details': {'audio': 0, 'cache_read': 12544}, 'output_token_details': {'audio': 0, 'reasoning': 576}}
2025-11-13 20:37:38,318 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'when dealing with request configuration should setup a default "application/x-www-form-urlencoded" template'
2025-11-13 20:37:39,735 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:39,735 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should setup a default "application/x-www-form-urlencoded" template'
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:618) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m

[?2004l
2025-11-13 20:37:41,521 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kNsAIqhe4Y1E5s7Es5LIHMgP', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'when dealing with request configuration should be possible to overwrite default request templates\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 52, 'prompt_tokens': 18099, 'total_tokens': 18151, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--5ba84493-cce7-4c47-ab29-a33a46d23f8d-0' tool_calls=[{'name': 'run_command', 'args': {'command': "npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'when dealing with request configuration should be possible to overwrite default request templates'"}, 'id': 'call_kNsAIqhe4Y1E5s7Es5LIHMgP', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18099, 'output_tokens': 52, 'total_tokens': 18151, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:41,527 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'when dealing with request configuration should be possible to overwrite default request templates'
2025-11-13 20:37:42,966 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:42,966 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should be possible to overwrite default request templates'
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:637) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

[?2004l
2025-11-13 20:37:44,426 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dkzkiZ3ab42jLEe5MqgngWQH', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'when dealing with request configuration should set custom request templates\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 49, 'prompt_tokens': 18398, 'total_tokens': 18447, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 5632}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--cbf7ec7e-d5fc-40a9-9fe8-0d71b3eae13c-0' tool_calls=[{'name': 'run_command', 'args': {'command': "npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'when dealing with request configuration should set custom request templates'"}, 'id': 'call_dkzkiZ3ab42jLEe5MqgngWQH', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18398, 'output_tokens': 49, 'total_tokens': 18447, 'input_token_details': {'audio': 0, 'cache_read': 5632}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:44,430 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'when dealing with request configuration should set custom request templates'
2025-11-13 20:37:45,849 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:45,849 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should set custom request templates'
[?2004l

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:656) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m

[?2004l
2025-11-13 20:37:48,909 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_dE5i2J4l31RnQub91MLsBpKH', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'^should support HTTP integration type$\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 45, 'prompt_tokens': 18688, 'total_tokens': 18733, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--8140af36-99cf-473e-b792-5e4116f1e476-0' tool_calls=[{'name': 'run_command', 'args': {'command': "npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep '^should support HTTP integration type$'"}, 'id': 'call_dE5i2J4l31RnQub91MLsBpKH', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18688, 'output_tokens': 45, 'total_tokens': 18733, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:37:48,913 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep '^should support HTTP integration type$'
2025-11-13 20:37:50,302 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:50,302 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep '^should support HTTP integration type$' 
[AGateway/lib/method/index.test.js --grep '^should support HTTP integration type$[K'
[?2004l


[92m [0m[32m 0 passing[0m[90m (1ms)[0m

(node:675) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
[?2004l
2025-11-13 20:37:55,912 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kFcnBgDHBQmjl0oIIufVYGAM', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'should support HTTP integration type\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 434, 'prompt_tokens': 18929, 'total_tokens': 19363, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 384, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 17408}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--1acfd765-f201-4e71-856f-dd0dac41b6e5-0' tool_calls=[{'name': 'run_command', 'args': {'command': "npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'should support HTTP integration type'"}, 'id': 'call_kFcnBgDHBQmjl0oIIufVYGAM', 'type': 'tool_call'}] usage_metadata={'input_tokens': 18929, 'output_tokens': 434, 'total_tokens': 19363, 'input_token_details': {'audio': 0, 'cache_read': 17408}, 'output_token_details': {'audio': 0, 'reasoning': 384}}
2025-11-13 20:37:55,916 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep 'should support HTTP integration type'
2025-11-13 20:37:57,340 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:37:57,340 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'should support HTTP integration type'
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:694) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m
  [32m  ✓[0m[90m should support HTTP integration type with custom request options[0m


[92m [0m[32m 2 passing[0m[90m (25ms)[0m

[?2004l
2025-11-13 20:38:10,464 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_kNmAmdZxCp4SCkmO5RWBRsQz', 'function': {'arguments': '{"command":"npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \'#compileMethods\\\\(\\\\) should support HTTP integration type$\'"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1209, 'prompt_tokens': 19223, 'total_tokens': 20432, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 18816}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3ae3df4e-133b-40fe-98eb-5a3bbcd6e8e7-0' tool_calls=[{'name': 'run_command', 'args': {'command': "npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep '#compileMethods\\(\\) should support HTTP integration type$'"}, 'id': 'call_kNmAmdZxCp4SCkmO5RWBRsQz', 'type': 'tool_call'}] usage_metadata={'input_tokens': 19223, 'output_tokens': 1209, 'total_tokens': 20432, 'input_token_details': {'audio': 0, 'cache_read': 18816}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-13 20:38:10,467 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: npx mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep '#compileMethods\(\) should support HTTP integration type$'
2025-11-13 20:38:11,884 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:11,884 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep '#compileMethods\(\) should support HTTP 
 integration type$'
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:713) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

[?2004l
2025-11-13 20:38:43,249 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n npx mocha lib/plugins/aws/package/compile/events/apiG\nGateway/lib/method/index.test.js --grep \'when dealing with request configuration \n should setup a default "application/json" template\'\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:599) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/json" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (23ms)\x1b[0m\n\n\n npx mocha lib/plugins/aws/package/compile/events/apiG\nGateway/lib/method/index.test.js --grep \'when dealing with request configuration \n should setup a default "application/x-www-form-urlencoded" template\'\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:618) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should setup a default "application/x-www-form-urlencoded" template\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (23ms)\x1b[0m\n\n\n npx mocha lib/plugins/aws/package/compile/events/apiG\nGateway/lib/method/index.test.js --grep \'when dealing with request configuration \n should be possible to overwrite default request templates\'\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:637) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should be possible to overwrite default request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (21ms)\x1b[0m\n\n\n npx mocha lib/plugins/aws/package/compile/events/apiG\nGateway/lib/method/index.test.js --grep \'when dealing with request configuration \n should set custom request templates\'\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n\x1b[0m    when dealing with request configuration\x1b[0m\n(node:656) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n    \x1b[32m  ✓\x1b[0m\x1b[90m should set custom request templates\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (22ms)\x1b[0m\n\n\n npx mocha lib/plugins/aws/package/compile/events/apiG\nGateway/lib/method/index.test.js --grep \'#compileMethods\\(\\) should support HTTP \n integration type$\'\n\n\x1b[0m\x1b[0m\n\x1b[0m  #compileMethods()\x1b[0m\n(node:713) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n  \x1b[32m  ✓\x1b[0m\x1b[90m should support HTTP integration type\x1b[0m\n\n\n\x1b[92m \x1b[0m\x1b[32m 1 passing\x1b[0m\x1b[90m (21ms)\x1b[0m\n\nTotal tests run: 5\nPass: 5\nFail: 0' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 3308, 'prompt_tokens': 19501, 'total_tokens': 22809, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 2176, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 19200}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--ba61aa63-0315-487b-8bb2-afa6144b9164-0' usage_metadata={'input_tokens': 19501, 'output_tokens': 3308, 'total_tokens': 22809, 'input_token_details': {'audio': 0, 'cache_read': 19200}, 'output_token_details': {'audio': 0, 'reasoning': 2176}}
2025-11-13 20:38:43,252 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should setup a default "application/json" template'

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:599) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/json" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m


 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should setup a default "application/x-www-form-urlencoded" template'

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:618) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m


[92m [0m[32m 1 passing[0m[90m (23ms)[0m


 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should be possible to overwrite default request templates'

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:637) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m


 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep 'when dealing with request configuration 
 should set custom request templates'

[0m[0m
[0m  #compileMethods()[0m
[0m    when dealing with request configuration[0m
(node:656) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
    [32m  ✓[0m[90m should set custom request templates[0m


[92m [0m[32m 1 passing[0m[90m (22ms)[0m


 npx mocha lib/plugins/aws/package/compile/events/apiG
Gateway/lib/method/index.test.js --grep '#compileMethods\(\) should support HTTP 
 integration type$'

[0m[0m
[0m  #compileMethods()[0m
(node:713) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m


[92m [0m[32m 1 passing[0m[90m (21ms)[0m

Total tests run: 5
Pass: 5
Fail: 0
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:38:58,048 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type'] regression_test_fail_log='' total_tests_run=5
2025-11-13 20:38:58,050 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:38:58,050 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:38:58,051 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:38:58,052 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:38:58,052 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - True
2025-11-13 20:38:58,054 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_update_node - INFO - Applying patch: diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..98e7b7928 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -953,7 +953,7 @@ Both templates give you access to the following properties you can access with t
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
-by defining a new request template for an existing content type):
+by defining a new request template for an existing content type). You can also disable a default template for a specific content type by setting its value to `null`:
 
 ```yml
 functions:
@@ -968,8 +968,11 @@ functions:
             template:
               text/xhtml: '{ "stage" : "$context.stage" }'
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
+              application/x-www-form-urlencoded: null
 ```
 
+Setting a template value to `null` removes that content type from the generated API Gateway RequestTemplates, allowing you to avoid advertising unsupported media types (e.g., removing `application/x-www-form-urlencoded` when only JSON is supported). If you disable all templates for the `lambda` (AWS) integration, ensure you set `passThrough` appropriately (e.g., `WHEN_NO_TEMPLATES`) to avoid 415 Unsupported Media Type errors.
+
 **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.
 
 **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..3e5871f6a 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -212,9 +212,13 @@ module.exports = {
       Object.assign(integrationRequestTemplates, http.request.template);
     }
 
-    return Object.keys(integrationRequestTemplates).length
-      ? integrationRequestTemplates
-      : undefined;
+    // allow disabling of default templates by setting a template to null/false
+    const cleanedTemplates = _.omitBy(
+      integrationRequestTemplates,
+      value => value == null || value === false
+    );
+
+    return Object.keys(cleanedTemplates).length ? cleanedTemplates : undefined;
   },
   getIntegrationRequestParameters(http) {
     const parameters = {};

2025-11-13 20:38:58,092 - thread-135845287823040.prometheus.lang_graph.nodes.update_container_node - INFO - Copy over all updated files to the container
2025-11-13 20:38:58,132 - thread-135845287823040.prometheus.docker.base_container - INFO - Resetting git repository in the container
2025-11-13 20:38:58,132 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git reset --hard
2025-11-13 20:38:58,234 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:58,234 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
HEAD is now at 56aa5aa15 feat(Standalone): Prevent accidental upgrades to a new major
[?2004l
2025-11-13 20:38:58,234 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: git clean -fd
2025-11-13 20:38:58,336 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:58,336 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:38:58,337 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating files in the container after edits.
2025-11-13 20:38:58,337 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory docs/providers/aws/events in the container
2025-11-13 20:38:58,337 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p docs/providers/aws/events
2025-11-13 20:38:58,438 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:58,439 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
[?2004l
2025-11-13 20:38:58,439 - thread-135845287823040.prometheus.docker.base_container - INFO - Creating directory lib/plugins/aws/package/compile/events/apiGateway/lib/method in the container
2025-11-13 20:38:58,439 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: mkdir -p lib/plugins/aws/package/compile/events/apiGateway/lib/method
2025-11-13 20:38:58,540 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:38:58,540 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 mkdir -p lib/plugins/aws/package/compile/events/apiGa
ateway/lib/method
[?2004l
[?2004l
2025-11-13 20:38:58,541 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating docs/providers/aws/events/apigateway.md in the container
2025-11-13 20:38:58,542 - thread-135845287823040.prometheus.docker.base_container - INFO - Updating lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js in the container
2025-11-13 20:38:58,551 - thread-135845287823040.prometheus.docker.base_container - INFO - Files updated successfully
2025-11-13 20:38:58,552 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - Enter run_regression_tests_subgraph_node
2025-11-13 20:38:58,552 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - selected_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:39:00,951 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_PwGSe9aWXJqq4tYrtpqDSVy5', 'function': {'arguments': '{"command":"ls -la"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 692, 'total_tokens': 782, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 64, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--6d83731f-8549-4338-b866-ff301ae99428-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'ls -la'}, 'id': 'call_PwGSe9aWXJqq4tYrtpqDSVy5', 'type': 'tool_call'}] usage_metadata={'input_tokens': 692, 'output_tokens': 90, 'total_tokens': 782, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 64}}
2025-11-13 20:39:00,955 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ls -la
2025-11-13 20:39:01,057 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:01,057 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
total 1628
drwxr-xr-x   1 root root    4096 Nov 13 20:30 [0m[01;34m.[0m
drwxr-xr-x   1 root root    4096 Nov 13 20:38 [01;34m..[0m
-rw-r--r--   1 root root     273 Nov 13 20:30 .editorconfig
drwxrwxr-x   1 root root    4096 Nov 13 20:38 [01;34m.git[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34m.github[0m
-rwxr-xr-x   1 root root      90 Nov 13 20:30 [01;32m.gitignore[0m
-rw-r--r--   1 root root      28 Nov 13 20:30 .npmignore
-rw-r--r--   1 root root      71 Nov 13 20:30 .prettierignore
-rw-r--r--   1 root root  187937 Nov 13 20:30 CHANGELOG.md
-rw-r--r--   1 root root    3292 Nov 13 20:30 CODE_OF_CONDUCT.md
-rw-r--r--   1 root root    5668 Nov 13 20:30 CONTRIBUTING.md
-rw-r--r--   1 root root     324 Nov 13 20:30 Dockerfile
-rw-r--r--   1 root root    1086 Nov 13 20:30 LICENSE.txt
-rw-r--r--   1 root root   13983 Nov 13 20:30 README.md
-rw-r--r--   1 root root    7692 Nov 13 20:30 README_CN.md
-rw-r--r--   1 root root    3191 Nov 13 20:30 RELEASE_PROCESS.md
-rw-r--r--   1 root root    3896 Nov 13 20:30 VERSIONING.md
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mbin[0m
-rw-r--r--   1 root root    1313 Nov 13 20:30 commitlint.config.js
-rw-r--r--   1 root root    3996 Nov 13 20:30 docker-compose.yml
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mdocs[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mlib[0m
drwxr-xr-x 947 root root   36864 Aug 28 02:00 [01;34mnode_modules[0m
-rw-r--r--   1 root root 1282306 Aug 28 01:59 package-lock.json
-rw-r--r--   1 root root    6437 Nov 13 20:30 package.json
-rw-r--r--   1 root root      86 Nov 13 20:30 prettier.config.js
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mscripts[0m
drwxrwxr-x   1 root root    4096 Nov 13 20:30 [01;34mtest[0m
[?2004l
2025-11-13 20:39:06,420 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_gbHkc2jx84jGatumD5JcqhHS', 'function': {'arguments': '{"command":"cat package.json"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 282, 'prompt_tokens': 1567, 'total_tokens': 1849, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 256, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dd41612e-9cb0-423d-9281-4b3f78aa8f1c-0' tool_calls=[{'name': 'run_command', 'args': {'command': 'cat package.json'}, 'id': 'call_gbHkc2jx84jGatumD5JcqhHS', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1567, 'output_tokens': 282, 'total_tokens': 1849, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 256}}
2025-11-13 20:39:06,424 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: cat package.json
2025-11-13 20:39:06,525 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:06,525 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
[?2004l
{
  "name": "serverless",
  "version": "1.80.0",
  "description": "Serverless Framework - Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions & more",
  "preferGlobal": true,
  "homepage": "https://serverless.com/framework/docs/",
  "author": "serverless.com",
  "repository": "serverless/serverless",
  "keywords": [
    "serverless",
    "lambda",
    "aws",
    "amazon",
    "azure",
    "google-cloud",
    "apache-open-whisk",
    "iot"
  ],
  "main": "lib/Serverless.js",
  "bin": {
    "serverless": "./bin/serverless.js",
    "slss": "./bin/serverless.js",
    "sls": "./bin/serverless.js"
  },
  "dependencies": {
    "@serverless/cli": "^1.5.2",
    "@serverless/components": "^2.34.7",
    "@serverless/enterprise-plugin": "^3.8.1",
    "@serverless/inquirer": "^1.1.2",
    "@serverless/utils": "^1.2.0",
    "ajv": "^6.12.4",
    "ajv-keywords": "^3.5.2",
    "archiver": "^3.1.1",
    "aws-sdk": "^2.739.0",
    "bluebird": "^3.7.2",
    "boxen": "^3.2.0",
    "cachedir": "^2.3.0",
    "chalk": "^2.4.2",
    "child-process-ext": "^2.1.1",
    "d": "^1.0.1",
    "dayjs": "^1.8.34",
    "decompress": "^4.2.1",
    "download": "^7.1.0",
    "essentials": "^1.1.1",
    "fast-levenshtein": "^2.0.6",
    "filesize": "^3.6.1",
    "fs-extra": "^8.1.0",
    "get-stdin": "^6.0.0",
    "globby": "^9.2.0",
    "graceful-fs": "^4.2.4",
    "https-proxy-agent": "^5.0.0",
    "is-docker": "^1.1.0",
    "is-wsl": "^2.2.0",
    "js-yaml": "^3.14.0",
    "json-cycle": "^1.3.0",
    "json-refs": "^3.0.15",
    "jwt-decode": "^2.2.0",
    "lodash": "^4.17.20",
    "memoizee": "^0.4.14",
    "mkdirp": "^0.5.4",
    "nanomatch": "^1.2.13",
    "ncjsm": "^4.1.0",
    "node-fetch": "^2.6.0",
    "object-hash": "^2.0.3",
    "p-limit": "^2.3.0",
    "promise-queue": "^2.2.5",
    "rc": "^1.2.8",
    "replaceall": "^0.1.6",
    "semver": "^6.3.0",
    "semver-regex": "^2.0.0",
    "stream-promise": "^3.2.0",
    "tabtab": "^3.0.2",
    "timers-ext": "^0.1.7",
    "type": "^2.1.0",
    "untildify": "^3.0.3",
    "update-notifier": "^2.5.0",
    "uuid": "^3.4.0",
    "write-file-atomic": "^2.4.3",
    "yaml-ast-parser": "0.0.43",
    "yargs-parser": "^18.1.3"
  },
  "devDependencies": {
    "@commitlint/cli": "^9.1.2",
    "@serverless/eslint-config": "^2.2.0",
    "@serverless/test": "^4.6.0",
    "chai": "^4.2.0",
    "chai-as-promised": "^7.1.1",
    "cli-progress-footer": "^1.1.1",
    "cos-nodejs-sdk-v5": "^2.6.2",
    "eslint": "^7.7.0",
    "eslint-plugin-import": "^2.22.0",
    "git-list-updated": "^1.2.1",
    "github-release-from-cc-changelog": "^2.2.0",
    "husky": "^4.2.5",
    "jszip": "^3.5.0",
    "lint-staged": "^10.2.13",
    "log": "^6.0.0",
    "mocha": "^6.2.3",
    "mocha-lcov-reporter": "^1.3.0",
    "mock-require": "^3.0.3",
    "nyc": "^15.1.0",
    "pkg": "^4.4.9",
    "prettier": "^1.19.1",
    "process-utils": "^3.1.0",
    "proxyquire": "^2.1.3",
    "sinon": "^8.1.1",
    "sinon-chai": "^3.5.0",
    "standard-version": "^8.0.2",
    "strip-ansi": "^5.2.0",
    "ws": "^7.3.1",
    "xml2js": "^0.4.23"
  },
  "eslintConfig": {
    "extends": "@serverless/eslint-config/node/6",
    "root": true,
    "overrides": [
      {
        "files": [
          "scripts/pkg/**"
        ],
        "parserOptions": {
          "ecmaVersion": 2018
        }
      }
    ]
  },
  "eslintIgnore": [
    "!/.github",
    "/lib/plugins/create/templates/**",
    "/lib/plugins/aws/customResources/node_modules/**"
  ],
  "mocha": {
    "reporter": "./test/mocha-reporter",
    "require": [
      "@serverless/test/setup/log",
      "@serverless/test/setup/async-leaks-detector",
      "@serverless/test/setup/async-leaks-detector/bluebird-patch",
      "@serverless/test/setup/mock-homedir",
      "@serverless/test/setup/restore-cwd",
      "@serverless/test/setup/restore-env"
    ],
    "timeout": 15000
  },
  "nyc": {
    "all": true,
    "exclude": [
      "**/*.test.js",
      ".github",
      "bin/**",
      "coverage/**",
      "dist/**",
      "scripts/**",
      "test/**",
      "tmp/**",
      "prettier.config.js"
    ],
    "reporter": [
      "lcov",
      "html",
      "text-summary"
    ]
  },
  "standard-version": {
    "skip": {
      "commit": true,
      "tag": true
    },
    "types": [
      {
        "type": "feat",
        "section": "Features"
      },
      {
        "type": "fix",
        "section": "Bug Fixes"
      },
      {
        "type": "perf",
        "section": "Performance Improvements"
      },
      {
        "type": "refactor",
        "section": "Maintanance Improvements"
      }
    ]
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.js": [
      "eslint"
    ],
    "*.{css,html,js,json,md,yaml,yml}": [
      "prettier -c"
    ]
  },
  "scripts": {
    "commitlint": "commitlint -f HEAD@{15}",
    "coverage": "nyc npm test",
    "integration-test-cleanup": "node test/utils/aws-cleanup.js",
    "integration-test-run-all": "mocha-isolated --pass-through-aws-creds --skip-fs-cleanup-check --max-workers=20 test/integration-all/**/tests.js",
    "integration-test-run-basic": "mocha test/integration-basic/tests.js",
    "integration-test-run-package": "mocha-isolated --skip-fs-cleanup-check test/integration-package/**/*.tests.js",
    "lint": "eslint .",
    "lint:updated": "pipe-git-updated --ext=js -- eslint",
    "pkg:build": "node ./scripts/pkg/build.js",
    "pkg:generate-choco-package": "node ./scripts/pkg/generate-choco-package.js",
    "pkg:upload": "node ./scripts/pkg/upload/index.js",
    "postinstall": "node ./scripts/postinstall.js",
    "prepare-release": "standard-version && prettier --write CHANGELOG.md",
    "prettier-check": "prettier -c \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettier-check:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier -c",
    "prettify": "prettier --write \"**/*.{css,html,js,json,md,yaml,yml}\"",
    "prettify:updated": "pipe-git-updated --ext=css --ext=html --ext=js --ext=json --ext=md --ext=yaml --ext=yml -- prettier --write",
    "test": "mocha \"!(node_modules)/**/*.test.js\"",
    "test:ci": "npm run prettier-check:updated && npm run lint:updated && npm run test:isolated",
    "test:isolated": "mocha-isolated"
  },
  "engines": {
    "node": ">=6.0"
  },
  "license": "MIT"
}
[?2004l
2025-11-13 20:39:12,329 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_2QWBrrnWQEdaIl3piNedtWy6', 'function': {'arguments': '{"command":"sed -n \'1,200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 495, 'prompt_tokens': 3846, 'total_tokens': 4341, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 448, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--d2c9a084-1f39-44d8-8023-37172d76c484-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_2QWBrrnWQEdaIl3piNedtWy6', 'type': 'tool_call'}] usage_metadata={'input_tokens': 3846, 'output_tokens': 495, 'total_tokens': 4341, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 448}}
2025-11-13 20:39:12,333 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1,200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:39:12,435 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:12,435 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1,200p' lib/plugins/aws/package/compile/event
ts/apiGateway/lib/method/index.test.js
[?2004l
'use strict';

const expect = require('chai').expect;
const AwsCompileApigEvents = require('../../index');
const Serverless = require('../../../../../../../../Serverless');
const AwsProvider = require('../../../../../../provider/awsProvider');

describe('#compileMethods()', () => {
  let serverless;
  let awsCompileApigEvents;

  beforeEach(() => {
    const options = {
      stage: 'dev',
      region: 'us-east-1',
    };
    serverless = new Serverless();
    serverless.setProvider('aws', new AwsProvider(serverless, options));
    serverless.service.service = 'first-service';
    serverless.service.provider.compiledCloudFormationTemplate = { Resources: {} };
    serverless.service.environment = {
      stages: {
        dev: {
          regions: {
            'us-east-1': {
              vars: {
                IamRoleLambdaExecution:
                  'arn:aws:iam::12345678:role/service-dev-IamRoleLambdaExecution-FOO12345678',
              },
            },
          },
        },
      },
    };
    serverless.service.functions.First = {};
    serverless.service.functions.Second = {};
    serverless.service.functions.Third = {};
    awsCompileApigEvents = new AwsCompileApigEvents(serverless, options);
    awsCompileApigEvents.validated = {};
    awsCompileApigEvents.apiGatewayMethodLogicalIds = [];
    awsCompileApigEvents.apiGatewayRestApiLogicalId = 'ApiGatewayRestApi';
    awsCompileApigEvents.apiGatewayResources = {
      'users/create': {
        name: 'UsersCreate',
        resourceLogicalId: 'ApiGatewayResourceUsersCreate',
      },

      'users/list': {
        name: 'UsersList',
        resourceLogicalId: 'ApiGatewayResourceUsersList',
      },
      'users/update': {
        name: 'UsersUpdate',
        resourceLogicalId: 'ApiGatewayResourceUsersUpdate',
      },
      'users/delete': {
        name: 'UsersDelete',
        resourceLogicalId: 'ApiGatewayResourceUsersDelete',
      },
    };
  });

  it('should have request validators/models defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' } } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should support multiple request schemas', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: { schema: { 'application/json': { foo: 'bar' }, 'text/plain': 'foo' } },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostValidator
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::RequestValidator',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ValidateRequestBody: true,
          ValidateRequestParameters: true,
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePostApplicationJsonModel
      ).to.deep.equal({
        Type: 'AWS::ApiGateway::Model',
        Properties: {
          RestApiId: { Ref: 'ApiGatewayRestApi' },
          ContentType: 'application/json',
          Schema: { foo: 'bar' },
        },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestModels
      ).to.deep.equal({
        'application/json': { Ref: 'ApiGatewayMethodUsersCreatePostApplicationJsonModel' },
        'text/plain': { Ref: 'ApiGatewayMethodUsersCreatePostTextPlainModel' },
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestValidatorId
      ).to.deep.equal({ Ref: 'ApiGatewayMethodUsersCreatePostValidator' });
    });
  });

  it('should have request parameters defined when they are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
            },
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
[?2004l
2025-11-13 20:39:14,109 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_P1kph2zl3sYODuxN3Nz2m6Hw', 'function': {'arguments': '{"command":"sed -n \'200,400p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 5467, 'total_tokens': 5508, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--fcc533f7-227f-4aea-bd66-4c16203c00bd-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_P1kph2zl3sYODuxN3Nz2m6Hw', 'type': 'tool_call'}] usage_metadata={'input_tokens': 5467, 'output_tokens': 41, 'total_tokens': 5508, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:39:14,111 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '200,400p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:39:14,213 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:14,213 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '200,400p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
    });
  });

  it('should not have integration RequestParameters when no request parameters are set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration
      ).to.not.have.key('RequestParameters');
    });
  });

  it('should create method resources when http events given', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Type
      ).to.equal('AWS::ApiGateway::Method');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Type
      ).to.equal('AWS::ApiGateway::Method');
    });
  });

  it('should support AWS integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          request: {
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support AWS_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('AWS_PROXY');
    });
  });

  it('should support HTTP integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('POST');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates
      ).to.equal(undefined);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support HTTP integration type with custom request options', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP',
          request: {
            uri: 'https://example.com',
            method: 'put',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP');
      expect(
[?2004l
2025-11-13 20:39:15,309 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_deLdTZazQ38f1NBi4tVACCVa', 'function': {'arguments': '{"command":"sed -n \'400,800p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 41, 'prompt_tokens': 7053, 'total_tokens': 7094, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--25854c12-f846-4925-a0d5-aad5eaf4beff-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_deLdTZazQ38f1NBi4tVACCVa', 'type': 'tool_call'}] usage_metadata={'input_tokens': 7053, 'output_tokens': 41, 'total_tokens': 7094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:39:15,312 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '400,800p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:39:15,415 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:15,415 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '400,800p' lib/plugins/aws/package/compile/eve
ents/apiGateway/lib/method/index.test.js
[?2004l
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PUT');
    });
  });

  it('should support HTTP_PROXY integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            method: 'patch',
            parameters: {
              'method.request.querystring.foo': true,
              'method.request.querystring.bar': false,
              'method.request.path.foo': true,
              'method.request.path.bar': false,
              'method.request.header.foo': true,
              'method.request.header.bar': false,
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('HTTP_PROXY');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.equal('https://example.com');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationHttpMethod
      ).to.equal('PATCH');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'method.request.querystring.foo',
        'integration.request.querystring.bar': 'method.request.querystring.bar',
        'integration.request.path.foo': 'method.request.path.foo',
        'integration.request.path.bar': 'method.request.path.bar',
        'integration.request.header.foo': 'method.request.header.foo',
        'integration.request.header.bar': 'method.request.header.bar',
      });
    });
  });

  it('should support MOCK integration type', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'MOCK',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Type
      ).to.equal('MOCK');
    });
  });

  it('should add request parameter when async config is used', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter when integration type is AWS_PROXY and async', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS_PROXY',
          async: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters[
          'integration.request.header.X-Amz-Invocation-Type'
        ]
      ).to.equal("'Event'");
    });
  });

  it('should add request parameter mapped value when explicitly defined', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'HTTP_PROXY',
          request: {
            uri: 'https://example.com',
            parameters: {
              'method.request.querystring.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.querystring.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.path.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.path.bar': {
                required: false,
                mappedValue: 'barValue',
              },
              'method.request.header.foo': {
                required: true,
                mappedValue: 'fooValue',
              },
              'method.request.header.bar': {
                required: false,
                mappedValue: 'barValue',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.header.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.foo'
        ]
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters[
          'method.request.querystring.bar'
        ]
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.foo']
      ).to.equal(true);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.RequestParameters['method.request.path.bar']
      ).to.equal(false);
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestParameters
      ).to.deep.equal({
        'integration.request.querystring.foo': 'fooValue',
        'integration.request.querystring.bar': 'barValue',
        'integration.request.path.foo': 'fooValue',
        'integration.request.path.bar': 'barValue',
        'integration.request.header.foo': 'fooValue',
        'integration.request.header.bar': 'barValue',
      });
    });
  });

  it('should set authorizer config for AWS_IAM', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'AWS_IAM',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('AWS_IAM');
    });
  });

  it('should set custom authorizer config with authorizerId', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          authorizer: {
            type: 'COGNITO_USER_POOLS',
            authorizerId: 'gy7lyj',
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId
      ).to.equal('gy7lyj');
    });
  });

  it('should set authorizer config if given as ARN string', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'Authorizer',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('CUSTOM');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizer arn', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given authorizerId Ref', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('CognitoAuthorizer');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should set authorizer config for a cognito user pool when given cognito arn object', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            arn: {
              'Fn::GetAtt': ['CognitoUserPool', 'Arn'],
            },
            scopes: ['myapp/read', 'myapp/write'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationType
      ).to.equal('COGNITO_USER_POOLS');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizationScopes
      ).to.contain('myapp/read');

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.AuthorizerId.Ref
      ).to.equal('AuthorizerApiGatewayAuthorizer');

[?2004l
2025-11-13 20:39:17,198 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_I7nHnQa4vZYspoXcpQslqqfq', 'function': {'arguments': '{"command":"sed -n \'800,1200p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 42, 'prompt_tokens': 10117, 'total_tokens': 10159, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--95859f4c-4e85-4e18-a99f-e4d572c3cfaf-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_I7nHnQa4vZYspoXcpQslqqfq', 'type': 'tool_call'}] usage_metadata={'input_tokens': 10117, 'output_tokens': 42, 'total_tokens': 10159, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:39:17,201 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '800,1200p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:39:17,304 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:17,304 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '800,1200p' lib/plugins/aws/package/compile/ev
vents/apiGateway/lib/method/index.test.js
[?2004l

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/undefined/);
    });
  });

  it('should not scopes for a cognito user pool when given empty scopes array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            type: 'COGNITO_USER_POOLS',
            authorizerId: { Ref: 'CognitoAuthorizer' },
            scopes: [],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.property('AuthorizationScopes');
    });
  });

  it('should set claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
    });
  });

  it('should set multiple claims for a cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'gender'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.gender).to.equal('$context.authorizer.claims.gender');
    });
  });

  it('should properly set claims for custom properties inside the cognito user pool', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
            claims: ['email', 'custom:score'],
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      const jsonRequestTemplatesString =
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ];
      const cognitoPoolClaimsRegex = /"cognitoPoolClaims"\s*:\s*(\{[^}]*\})/;
      const cognitoPoolClaimsString = jsonRequestTemplatesString.match(cognitoPoolClaimsRegex)[1];
      const cognitoPoolClaims = JSON.parse(cognitoPoolClaimsString);
      expect(cognitoPoolClaims.email).to.equal('$context.authorizer.claims.email');
      expect(cognitoPoolClaims.score).to.equal("$context.authorizer.claims['custom:score']");
    });
  });

  it('should replace the extra claims in the template if there are none', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          authorizer: {
            name: 'authorizer',
            arn: 'arn:aws:cognito-idp:us-east-1:xxx:userpool/us-east-1_ZZZ',
          },
          integration: 'AWS',
          path: 'users/create',
          method: 'post',
        },
      },
    ];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.RequestTemplates[
          'application/json'
        ]
      ).to.not.match(/extraCognitoPoolClaims/);
    });
  });

  it('should not create method resources when http events are not given', () => {
    awsCompileApigEvents.validated.events = [];

    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
      ).to.deep.equal({});
    });
  });

  it('should update the method logical ids array', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds.length).to.equal(2);
      expect(awsCompileApigEvents.apiGatewayMethodLogicalIds).to.deep.equal([
        'ApiGatewayMethodUsersCreatePost',
        'ApiGatewayMethodUsersListGet',
      ]);
    });
  });

  it('should set api key as required if private endpoint', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          private: true,
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(true);
    });
  });

  it('should set api key as not required if private property is not specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.ApiKeyRequired
      ).to.equal(false);
    });
  });

  it('should set the correct lambdaUri', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['FirstLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['SecondLambdaFunction', 'Arn'] },
            '/invocations',
          ],
        ],
      });
    });
  });

  it('Should point target alias if set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'Provisioned',
        http: {
          method: 'get',
          path: 'users/list',
        },
      },
    ];
    serverless.service.functions.Provisioned = {
      targetAlias: { name: 'provisioned', logicalId: 'IrrelevantLogicalId' },
    };
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.Uri
      ).to.deep.equal({
        'Fn::Join': [
          '',
          [
            'arn:',
            { Ref: 'AWS::Partition' },
            ':apigateway:',
            { Ref: 'AWS::Region' },
            ':lambda:path/2015-03-31/functions/',
            { 'Fn::GetAtt': ['ProvisionedLambdaFunction', 'Arn'] },
            ':',
            'provisioned',
            '/invocations',
          ],
        ],
      });
    });
  });

  it('should add CORS origins to method only when CORS is enabled', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Third',
        http: {
          path: 'users/update',
          method: 'PUT',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
          cors: {
            origins: ['*'],
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'http://example.com'");

      // CORS not enabled!
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.not.equal("'*'");

      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersUpdatePut.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Origin']
      ).to.equal("'*'");
    });
  });

  it('should set CORS allowCredentials to method only when specified', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
[?2004l
2025-11-13 20:39:19,038 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_YpUFheSG46C3rXXRyGQMwhQi', 'function': {'arguments': '{"command":"sed -n \'1200,1600p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 13005, 'total_tokens': 13048, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 10112}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--69afee9f-9e19-45d9-87b5-25075ef41143-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_YpUFheSG46C3rXXRyGQMwhQi', 'type': 'tool_call'}] usage_metadata={'input_tokens': 13005, 'output_tokens': 43, 'total_tokens': 13048, 'input_token_details': {'audio': 0, 'cache_read': 10112}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:39:19,041 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1200,1600p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:39:19,143 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:19,143 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1200,1600p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
          method: 'post',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
            allowCredentials: true,
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
      {
        functionName: 'Second',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          cors: {
            origin: 'http://example.com',
          },
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.equal('true');

      // allowCredentials not enabled
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Access-Control-Allow-Credentials']
      ).to.not.equal('true');
    });
  });

  describe('when dealing with request configuration', () => {
    it('should setup a default "application/json" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should setup a default "application/x-www-form-urlencoded" template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'Second',
          http: {
            method: 'get',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/x-www-form-urlencoded'
          ]
        ).to.have.length.above(0);
      });
    });

    it('should use defined pass-through behavior', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              passThrough: 'WHEN_NO_TEMPLATES',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.PassthroughBehavior
        ).to.equal('WHEN_NO_TEMPLATES');
      });
    });

    it('should use defined content-handling behavior (request)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              contentHandling: 'CONVERT_TO_TEXT',
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.ContentHandling
        ).to.equal('CONVERT_TO_TEXT');
      });
    });

    it('should use defined response content-handling behavior for 2XX only (response)', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              contentHandling: 'CONVERT_TO_BINARY',
              statusCodes: {
                200: {
                  pattern: '',
                },
                400: {
                  pattern: '400',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ContentHandling
        ).to.equal('CONVERT_TO_BINARY');
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
            .ContentHandling
        ).to.equal(undefined);
      });
    });

    it('should set custom request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'template/1': '{ "stage" : "$context.stage" }',
                'template/2': '{ "httpMethod" : "$context.httpMethod" }',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/1']
        ).to.equal('{ "stage" : "$context.stage" }');

        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates['template/2']
        ).to.equal('{ "httpMethod" : "$context.httpMethod" }');
      });
    });

    it('should be possible to overwrite default request templates', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            request: {
              template: {
                'application/json': 'overwritten-request-template-content',
              },
            },
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.RequestTemplates[
            'application/json'
          ]
        ).to.equal('overwritten-request-template-content');
      });
    });
  });

  describe('when dealing with response configuration', () => {
    it('should set the custom headers', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  pattern: '',
                  headers: {
                    'Content-Type': "'text/plain'",
                    'My-Custom-Header': 'my/custom/header',
                  },
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.Content-Type']
        ).to.equal("'text/plain'");
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseParameters['method.response.header.My-Custom-Header']
        ).to.equal('my/custom/header');
      });
    });

    it('should set the custom template', () => {
      awsCompileApigEvents.validated.events = [
        {
          functionName: 'First',
          http: {
            method: 'GET',
            path: 'users/list',
            integration: 'AWS',
            response: {
              statusCodes: {
                200: {
                  template: "$input.path('$.foo')",
                  pattern: '',
                },
              },
            },
          },
        },
      ];
      return awsCompileApigEvents.compileMethods().then(() => {
        expect(
          awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
            .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
            .ResponseTemplates['application/json']
        ).to.equal("$input.path('$.foo')");
      });
    });
  });

  it('should add method responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[0].StatusCode
      ).to.equal('200');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.MethodResponses[1].StatusCode
      ).to.equal('202');
    });
  });

  it('should add integration responses for different status codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
              },
              202: {
                pattern: 'foo',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
      ).to.deep.equal({
        StatusCode: '202',
        SelectionPattern: 'foo',
        ResponseParameters: {},
        ResponseTemplates: {},
[?2004l
2025-11-13 20:39:20,724 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_laluaMAqFTxeW3Z2bzK9pkkC', 'function': {'arguments': '{"command":"sed -n \'1600,2000p\' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 43, 'prompt_tokens': 15549, 'total_tokens': 15592, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 3840}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--dbbd70d5-8c5b-4ac4-b130-fc2098c406bc-0' tool_calls=[{'name': 'run_command', 'args': {'command': "sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js"}, 'id': 'call_laluaMAqFTxeW3Z2bzK9pkkC', 'type': 'tool_call'}] usage_metadata={'input_tokens': 15549, 'output_tokens': 43, 'total_tokens': 15592, 'input_token_details': {'audio': 0, 'cache_read': 3840}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:39:20,728 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: sed -n '1600,2000p' lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js
2025-11-13 20:39:20,830 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:20,830 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 sed -n '1600,2000p' lib/plugins/aws/package/compile/e
events/apiGateway/lib/method/index.test.js
[?2004l
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
      ).to.deep.equal({
        StatusCode: '200',
        SelectionPattern: '',
        ResponseParameters: {},
        ResponseTemplates: {},
        ContentHandling: undefined,
      });
    });
  });

  it('should add fall back headers and template to statusCodes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            headers: {
              'Content-Type': 'text/csv',
            },
            template: 'foo',
            statusCodes: {
              400: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal('foo');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
    });
  });

  it('should add custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                pattern: '',
                template: "$input.path('$.foo')",
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: "$input.path('$.errorMessage')",
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should add multiple response templates for a custom response codes', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'GET',
          path: 'users/list',
          integration: 'AWS',
          response: {
            statusCodes: {
              200: {
                template: "$input.path('$.foo')",
                headers: {
                  'Content-Type': 'text/csv',
                },
              },
              404: {
                pattern: '.*"statusCode":404,.*',
                template: {
                  'application/json': "$input.path('$.errorMessage')",
                  'application/xml': "$input.path('$.xml.errorMessage')",
                },
                headers: {
                  'Content-Type': 'text/html',
                },
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.foo')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .SelectionPattern
      ).to.equal('');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/csv');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/json']
      ).to.equal("$input.path('$.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseTemplates['application/xml']
      ).to.equal("$input.path('$.xml.errorMessage')");
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .SelectionPattern
      ).to.equal('.*"statusCode":404,.*');
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[1]
          .ResponseParameters['method.response.header.Content-Type']
      ).to.equal('text/html');
    });
  });

  it('should use defined content-handling behavior', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          method: 'get',
          path: 'users/list',
          integration: 'AWS',
          response: {
            contentHandling: 'CONVERT_TO_BINARY',
            statusCodes: {
              200: {
                pattern: '',
              },
            },
          },
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersListGet.Properties.Integration.IntegrationResponses[0]
          .ContentHandling
      ).to.equal('CONVERT_TO_BINARY');
    });
  });

  it('should handle root resource methods', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: '',
          method: 'GET',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodGet.Properties.ResourceId
      ).to.deep.equal({
        'Fn::GetAtt': ['ApiGatewayRestApi', 'RootResourceId'],
      });
    });
  });

  it('should include operation id as OperationName when it is set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
          operationId: 'createUser',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties.OperationName
      ).to.equal('createUser');
    });
  });

  it('should not include operation id when it is not set', () => {
    awsCompileApigEvents.validated.events = [
      {
        functionName: 'First',
        http: {
          path: 'users/create',
          method: 'post',
          integration: 'AWS',
        },
      },
    ];
    return awsCompileApigEvents.compileMethods().then(() => {
      expect(
        awsCompileApigEvents.serverless.service.provider.compiledCloudFormationTemplate.Resources
          .ApiGatewayMethodUsersCreatePost.Properties
      ).to.not.have.key('OperationName');
    });
  });
});
[?2004l
2025-11-13 20:39:34,191 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='' additional_kwargs={'tool_calls': [{'id': 'call_VUqwzPyoVYigObjztyrr15jU', 'function': {'arguments': '{"command":"./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep \\"should support HTTP integration type|should setup a default \\\\\\"application/json\\\\\\" template|should setup a default \\\\\\"application/x-www-form-urlencoded\\\\\\" template|should be possible to overwrite default request templates|should set custom request templates\\""}', 'name': 'run_command'}, 'type': 'function'}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 1248, 'prompt_tokens': 17545, 'total_tokens': 18793, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 1152, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--3052ed34-64c0-491b-beea-572cae765410-0' tool_calls=[{'name': 'run_command', 'args': {'command': './node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type|should setup a default \\"application/json\\" template|should setup a default \\"application/x-www-form-urlencoded\\" template|should be possible to overwrite default request templates|should set custom request templates"'}, 'id': 'call_VUqwzPyoVYigObjztyrr15jU', 'type': 'tool_call'}] usage_metadata={'input_tokens': 17545, 'output_tokens': 1248, 'total_tokens': 18793, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 1152}}
2025-11-13 20:39:34,195 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Executing command: ./node_modules/.bin/mocha lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP integration type|should setup a default \"application/json\" template|should setup a default \"application/x-www-form-urlencoded\" template|should be possible to overwrite default request templates|should set custom request templates"
2025-11-13 20:39:35,222 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command exit code: 0
2025-11-13 20:39:35,222 - thread-135845287823040.prometheus.docker.base_container - DEBUG - Command output:
 ./node_modules/.bin/mocha lib/plugins/aws/package/com
mpile/events/apiGateway/lib/method/index.test.js --grep "should support HTTP inte
egration type|should setup a default \"application/json\" template|should setup a
a default \"application/x-www-form-urlencoded\" template|should be possible to ov
verwrite default request templates|should set custom request templates"
[?2004l

[0m[0m
[0m  #compileMethods()[0m
(node:732) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  [32m  ✓[0m[90m should support HTTP integration type[0m
  [32m  ✓[0m[90m should support HTTP integration type with custom request options[0m
[0m    when dealing with request configuration[0m
    [32m  ✓[0m[90m should setup a default "application/json" template[0m
    [32m  ✓[0m[90m should setup a default "application/x-www-form-urlencoded" template[0m
    [32m  ✓[0m[90m should set custom request templates[0m
    [32m  ✓[0m[90m should be possible to overwrite default request templates[0m


[92m [0m[32m 6 passing[0m[90m (35ms)[0m

[?2004l
2025-11-13 20:39:37,896 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_node - DEBUG - content='Result:\n6 tests run\nAll selected tests Passed\n\nExact output:\n#compileMethods()\n(node:732) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.\n SDK releases are limited to address critical bug fixes and security issues only.\n\nPlease migrate your code to use AWS SDK for JavaScript (v3).\nFor more information, check the blog post at https://a.co/cUPnyil\n(Use `node --trace-warnings ...` to show where the warning was created)\n  ✓ should support HTTP integration type\n  ✓ should support HTTP integration type with custom request options\n    when dealing with request configuration\n    ✓ should setup a default "application/json" template\n    ✓ should setup a default "application/x-www-form-urlencoded" template\n    ✓ should set custom request templates\n    ✓ should be possible to overwrite default request templates\n\n  6 passing (35ms)' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 189, 'prompt_tokens': 18069, 'total_tokens': 18258, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 12928}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--e74f318e-b166-4670-a16c-083b158ad8da-0' usage_metadata={'input_tokens': 18069, 'output_tokens': 189, 'total_tokens': 18258, 'input_token_details': {'audio': 0, 'cache_read': 12928}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-11-13 20:39:37,899 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - Human Message: 
We have run the selected regression tests on the codebase.
The following regression tests were selected to run:
--- BEGIN SELECTED REGRESSION TESTS ---
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates
lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type
--- END SELECTED REGRESSION TESTS ---

Run Regression Tests Logs:
--- BEGIN LOG ---
Result:
6 tests run
All selected tests Passed

Exact output:
#compileMethods()
(node:732) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
  ✓ should support HTTP integration type
  ✓ should support HTTP integration type with custom request options
    when dealing with request configuration
    ✓ should setup a default "application/json" template
    ✓ should setup a default "application/x-www-form-urlencoded" template
    ✓ should set custom request templates
    ✓ should be possible to overwrite default request templates

  6 passing (35ms)
--- END LOG ---

Please analyze the logs and determine which regression tests passed!. You should return the exact test identifier 
that we give to you.
Don't forget to return the total number of tests run!

2025-11-13 20:39:49,748 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_structure_node - DEBUG - passed_regression_tests=['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type'] regression_test_fail_log='' total_tests_run=6
2025-11-13 20:39:49,749 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - INFO - passed_regression_tests: ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:39:49,749 - thread-135845287823040.prometheus.lang_graph.nodes.run_regression_tests_subgraph_node - DEBUG - regression_test_fail_log: 
2025-11-13 20:39:49,750 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - All regression tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:39:49,750 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - Current passed tests ['lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/json" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should setup a default "application/x-www-form-urlencoded" template', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should be possible to overwrite default request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::when dealing with request configuration::should set custom request templates', 'lib/plugins/aws/package/compile/events/apiGateway/lib/method/index.test.js::should support HTTP integration type']
2025-11-13 20:39:49,750 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_check_result_node - DEBUG - True
2025-11-13 20:39:49,754 - thread-135845287823040.prometheus.lang_graph.nodes.get_pass_regression_test_patch_subgraph_node - DEBUG - tested_patch_result: [TestedPatchResult(patch='diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..9b4f67eb3 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -932,7 +932,7 @@ This method is more complicated and involves a lot more configuration of the `ht\n \n #### Default Request Templates\n \n-Serverless ships with the following default request templates you can use out of the box:\n+Serverless ships with the following default request templates you can use out of the box for Lambda (AWS) integration:\n \n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n@@ -950,6 +950,41 @@ Both templates give you access to the following properties you can access with t\n - stageVariables\n - requestPath\n \n+You can control these defaults:\n+\n+- Disable all default templates:\n+  set `request.disableDefaultTemplates: true` to prevent Serverless from adding any default request mapping templates.\n+- Exclude specific default content types:\n+  set `request.excludeDefaultContentTypes` to a list of content types to remove from the defaults. For example, to remove `application/x-www-form-urlencoded` while keeping `application/json`.\n+\n+Examples:\n+\n+```yml\n+functions:\n+  onlyJson:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: post\n+          path: posts/create\n+          integration: lambda\n+          request:\n+            excludeDefaultContentTypes:\n+              - application/x-www-form-urlencoded\n+\n+  noDefaultsCustomOnly:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: post\n+          path: posts/create\n+          integration: lambda\n+          request:\n+            disableDefaultTemplates: true\n+            template:\n+              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n+```\n+\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n@@ -1027,6 +1062,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates\n \n - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n+- When you disable all default templates and do not define any custom templates for AWS (Lambda) integration, the default passThrough behavior (NEVER) will cause API Gateway to reject requests with 415 unless you explicitly change `request.passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH`.\n \n ### Responses\n \ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..6370cbb4f 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -201,10 +201,24 @@ module.exports = {\n \n     // Only set defaults for AWS (lambda) integration\n     if (useDefaults) {\n-      Object.assign(integrationRequestTemplates, {\n+      let defaultTemplates = {\n         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n-      });\n+      };\n+\n+      // Allow disabling all default templates\n+      if (http.request && http.request.disableDefaultTemplates) {\n+        defaultTemplates = {};\n+      } else if (\n+        http.request &&\n+        Array.isArray(http.request.excludeDefaultContentTypes)\n+      ) {\n+        http.request.excludeDefaultContentTypes.forEach(type => {\n+          delete defaultTemplates[type];\n+        });\n+      }\n+\n+      Object.assign(integrationRequestTemplates, defaultTemplates);\n     }\n \n     // set custom request templates if provided\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..c00fa243b 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,38 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      if (\n+        typeof http.request.disableDefaultTemplates !== \'undefined\' &&\n+        typeof http.request.disableDefaultTemplates !== \'boolean\'\n+      ) {\n+        const errorMessage = [\n+          \'disableDefaultTemplates must be provided as a boolean.\',\n+          \' Please check the docs for more info.\',\n+        ].join(\'\');\n+        throw new this.serverless.classes.Error(errorMessage);\n+      }\n+      if (\n+        typeof http.request.excludeDefaultContentTypes !== \'undefined\' &&\n+        !Array.isArray(http.request.excludeDefaultContentTypes)\n+      ) {\n+        const errorMessage = [\n+          \'excludeDefaultContentTypes must be provided as an array of strings.\',\n+          \' Please check the docs for more info.\',\n+        ].join(\'\');\n+        throw new this.serverless.classes.Error(errorMessage);\n+      }\n+      if (Array.isArray(http.request.excludeDefaultContentTypes)) {\n+        const invalid = http.request.excludeDefaultContentTypes.some(\n+          t => typeof t !== \'string\'\n+        );\n+        if (invalid) {\n+          const errorMessage = [\n+            \'excludeDefaultContentTypes must be provided as an array of strings.\',\n+            \' Please check the docs for more info.\',\n+          ].join(\'\');\n+          throw new this.serverless.classes.Error(errorMessage);\n+        }\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', passed=True, regression_test_failure_log=''), TestedPatchResult(patch='diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..9e6c7c5a4 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -932,11 +932,35 @@ This method is more complicated and involves a lot more configuration of the `ht\n \n #### Default Request Templates\n \n-Serverless ships with the following default request templates you can use out of the box:\n+Serverless ships with the following default request templates you can use out of the box (for the `lambda`/`AWS` integration):\n \n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n \n+You can control which of these defaults are applied per endpoint with the `request.defaultContentTypes` setting:\n+\n+- Omit `request.defaultContentTypes` to keep the current defaults (both will be added)\n+- Set `request.defaultContentTypes: [application/json]` to include only the JSON default\n+- Set `request.defaultContentTypes: []` to disable all defaults (you may want to define your own templates via `request.template`)\n+\n+Example:\n+\n+```yml\n+functions:\n+  create:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: post\n+          path: posts/create\n+          integration: lambda\n+          request:\n+            defaultContentTypes:\n+              - application/json\n+            template:\n+              text/xml: \'{ "foo": "bar" }\'\n+```\n+\n Both templates give you access to the following properties you can access with the help of the `event` object:\n \n - body\n@@ -953,7 +977,7 @@ Both templates give you access to the following properties you can access with t\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n-by defining a new request template for an existing content type):\n+by defining a new request template for an existing content type). If you prefer not to include any defaults, set `request.defaultContentTypes: []`.\n \n ```yml\n functions:\n@@ -965,6 +989,7 @@ functions:\n           path: whatever\n           integration: lambda\n           request:\n+            defaultContentTypes: []\n             template:\n               text/xhtml: \'{ "stage" : "$context.stage" }\'\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n@@ -998,7 +1023,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s\n \n [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n \n-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the `lambda`/`AWS` integration). Note: If you disable all default request templates via `request.defaultContentTypes: []` and do not provide any custom templates, requests with unmatched Content-Type will be rejected with `415 - Unsupported Media Type` when passThrough is `NEVER`.\n \n ```yml\n functions:\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..38fd4ea7c 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -201,10 +201,24 @@ module.exports = {\n \n     // Only set defaults for AWS (lambda) integration\n     if (useDefaults) {\n-      Object.assign(integrationRequestTemplates, {\n-        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n-        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n-      });\n+      const defaultsConfig =\n+        http.request && Array.isArray(http.request.defaultContentTypes)\n+          ? http.request.defaultContentTypes\n+          : null;\n+      if (defaultsConfig === null) {\n+        Object.assign(integrationRequestTemplates, {\n+          \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n+          \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n+        });\n+      } else {\n+        if (defaultsConfig.includes(\'application/json\')) {\n+          integrationRequestTemplates[\'application/json\'] = this.DEFAULT_JSON_REQUEST_TEMPLATE;\n+        }\n+        if (defaultsConfig.includes(\'application/x-www-form-urlencoded\')) {\n+          integrationRequestTemplates[\'application/x-www-form-urlencoded\'] =\n+            this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE;\n+        }\n+      }\n     }\n \n     // set custom request templates if provided\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..e6008e2ef 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,31 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      if (http.request.defaultContentTypes) {\n+        if (!Array.isArray(http.request.defaultContentTypes)) {\n+          const errorMessage = [\n+            \'defaultContentTypes config must be provided as an array of strings.\',\n+            \' Please check the docs for more info.\',\n+          ].join(\'\');\n+          throw new this.serverless.classes.Error(errorMessage);\n+        }\n+        const allowedDefaults = [\n+          \'application/json\',\n+          \'application/x-www-form-urlencoded\',\n+        ];\n+        for (const ct of http.request.defaultContentTypes) {\n+          if (typeof ct !== \'string\' || allowedDefaults.indexOf(ct) === -1) {\n+            const errorMessage = [\n+              \'defaultContentTypes entries must be one of: \',\n+              allowedDefaults.join(\', \'),\n+              \'.\',\n+            ].join(\'\');\n+            throw new this.serverless.classes.Error(errorMessage);\n+          }\n+        }\n+        // remove duplicates if any\n+        http.request.defaultContentTypes = Array.from(new Set(http.request.defaultContentTypes));\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', passed=True, regression_test_failure_log=''), TestedPatchResult(patch='diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..a0e2182b9 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -932,11 +932,13 @@ This method is more complicated and involves a lot more configuration of the `ht\n \n #### Default Request Templates\n \n-Serverless ships with the following default request templates you can use out of the box:\n+Serverless ships with the following default request templates you can use out of the box (for the non-proxy `lambda`/`AWS` integration):\n \n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n \n+You can disable one or both default templates by setting the content type to `false` in your `request.template` configuration or globally under `provider.apiGateway.defaultRequestTemplates`.\n+\n Both templates give you access to the following properties you can access with the help of the `event` object:\n \n - body\n@@ -970,6 +972,34 @@ functions:\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n ```\n \n+To remove a default content type, set it to `false`:\n+\n+```yml\n+functions:\n+  create:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: get\n+          path: whatever\n+          integration: lambda\n+          request:\n+            template:\n+              application/x-www-form-urlencoded: false\n+```\n+\n+You can also control defaults globally:\n+\n+```yml\n+provider:\n+  apiGateway:\n+    defaultRequestTemplates:\n+      application/json: ${file(template_json.vtl)}\n+      application/x-www-form-urlencoded: false\n+```\n+\n+If you remove all templates, remember to adjust pass-through behavior as needed (see below).\n+\n **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n \n **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n@@ -998,7 +1028,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s\n \n [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n \n-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the non-proxy `lambda`/`AWS` integration when defaults are present). If you disable all templates, consider setting `passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH` depending on your desired behavior.\n \n ```yml\n functions:\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..0553ab74e 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -201,10 +201,24 @@ module.exports = {\n \n     // Only set defaults for AWS (lambda) integration\n     if (useDefaults) {\n-      Object.assign(integrationRequestTemplates, {\n-        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n-        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n-      });\n+      // Allow provider-level override of default request templates\n+      const providerDefaults =\n+        this.serverless &&\n+        this.serverless.service &&\n+        this.serverless.service.provider &&\n+        this.serverless.service.provider.apiGateway &&\n+        typeof this.serverless.service.provider.apiGateway.defaultRequestTemplates === \'object\'\n+          ? this.serverless.service.provider.apiGateway.defaultRequestTemplates\n+          : null;\n+\n+      const defaultTemplates =\n+        providerDefaults ||\n+        {\n+          \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n+          \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n+        };\n+\n+      Object.assign(integrationRequestTemplates, defaultTemplates);\n     }\n \n     // set custom request templates if provided\n@@ -212,6 +226,15 @@ module.exports = {\n       Object.assign(integrationRequestTemplates, http.request.template);\n     }\n \n+    // Remove any templates explicitly disabled (value set to false)\n+    // and ensure only string-valued templates are passed to CloudFormation\n+    Object.keys(integrationRequestTemplates).forEach(contentType => {\n+      const template = integrationRequestTemplates[contentType];\n+      if (template === false || typeof template !== \'string\') {\n+        delete integrationRequestTemplates[contentType];\n+      }\n+    });\n+\n     return Object.keys(integrationRequestTemplates).length\n       ? integrationRequestTemplates\n       : undefined;\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..2bdb24092 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,20 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      // Validate template values: allow strings and boolean false (to disable defaults)\n+      if (http.request.template && typeof http.request.template === \'object\') {\n+        Object.keys(http.request.template).forEach(ct => {\n+          const tpl = http.request.template[ct];\n+          if (tpl !== false && typeof tpl !== \'string\') {\n+            const errorMessage = [\n+              \'Invalid template value for content type "\',\n+              ct,\n+              \'". Expected a string or false to disable.\',\n+            ].join(\'\');\n+            throw new this.serverless.classes.Error(errorMessage);\n+          }\n+        });\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', passed=True, regression_test_failure_log=''), TestedPatchResult(patch='diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..194b6dc51 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -937,6 +937,10 @@ Serverless ships with the following default request templates you can use out of\n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n \n+By default, these templates are added only for the Lambda (AWS) integration. You can control defaults as follows:\n+- Disable all defaults for a given endpoint by setting `request.useDefaultTemplates: false`\n+- Remove a specific default by setting its content type under `request.template` to `null` or `false` (e.g., `application/x-www-form-urlencoded: null`)\n+\n Both templates give you access to the following properties you can access with the help of the `event` object:\n \n - body\n@@ -953,7 +957,9 @@ Both templates give you access to the following properties you can access with t\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n-by defining a new request template for an existing content type):\n+by defining a new request template for an existing content type). You can also remove defaults:\n+\n+- Remove a single default template:\n \n ```yml\n functions:\n@@ -966,10 +972,27 @@ functions:\n           integration: lambda\n           request:\n             template:\n-              text/xhtml: \'{ "stage" : "$context.stage" }\'\n+              application/x-www-form-urlencoded: null # removes this default\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n ```\n \n+- Disable all default templates and provide only explicit templates:\n+\n+```yml\n+functions:\n+  create:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: get\n+          path: whatever\n+          integration: lambda\n+          request:\n+            useDefaultTemplates: false\n+            template:\n+              text/xhtml: \'{ "stage" : "$context.stage" }\'\n+```\n+\n **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n \n **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n@@ -1026,6 +1049,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates\n **Notes:**\n \n - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n+- If you disable all default templates for Lambda integration and do not define any templates, the default `passThrough` for Lambda integration is `NEVER`, which will cause API Gateway to return `415 - Unsupported Media Type` for unmatched content types. You can change this behavior via `request.passThrough`.\n - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n \n ### Responses\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..e355368cb 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -199,8 +199,11 @@ module.exports = {\n     // default request templates\n     const integrationRequestTemplates = {};\n \n-    // Only set defaults for AWS (lambda) integration\n-    if (useDefaults) {\n+    // Determine whether default templates should be used (only for AWS (lambda) integration)\n+    const useDefaultsAfterConfig =\n+      useDefaults && !(http.request && http.request.useDefaultTemplates === false);\n+\n+    if (useDefaultsAfterConfig) {\n       Object.assign(integrationRequestTemplates, {\n         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n@@ -209,7 +212,16 @@ module.exports = {\n \n     // set custom request templates if provided\n     if (http.request && typeof http.request.template === \'object\') {\n-      Object.assign(integrationRequestTemplates, http.request.template);\n+      _.forEach(http.request.template, (value, key) => {\n+        if (value === null || value === false) {\n+          // Explicitly remove this content type from the final templates\n+          if (Object.prototype.hasOwnProperty.call(integrationRequestTemplates, key)) {\n+            delete integrationRequestTemplates[key];\n+          }\n+        } else {\n+          integrationRequestTemplates[key] = value;\n+        }\n+      });\n     }\n \n     return Object.keys(integrationRequestTemplates).length\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..10b0ade05 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,16 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      if (\n+        typeof http.request.useDefaultTemplates !== \'undefined\' &&\n+        typeof http.request.useDefaultTemplates !== \'boolean\'\n+      ) {\n+        const errorMessage = [\n+          \'useDefaultTemplates config must be provided as a boolean.\',\n+          \' Please check the docs for more info.\',\n+        ].join(\'\');\n+        throw new this.serverless.classes.Error(errorMessage);\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', passed=True, regression_test_failure_log=''), TestedPatchResult(patch='diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..98e7b7928 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -953,7 +953,7 @@ Both templates give you access to the following properties you can access with t\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n-by defining a new request template for an existing content type):\n+by defining a new request template for an existing content type). You can also disable a default template for a specific content type by setting its value to `null`:\n \n ```yml\n functions:\n@@ -968,8 +968,11 @@ functions:\n             template:\n               text/xhtml: \'{ "stage" : "$context.stage" }\'\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n+              application/x-www-form-urlencoded: null\n ```\n \n+Setting a template value to `null` removes that content type from the generated API Gateway RequestTemplates, allowing you to avoid advertising unsupported media types (e.g., removing `application/x-www-form-urlencoded` when only JSON is supported). If you disable all templates for the `lambda` (AWS) integration, ensure you set `passThrough` appropriately (e.g., `WHEN_NO_TEMPLATES`) to avoid 415 Unsupported Media Type errors.\n+\n **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n \n **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..3e5871f6a 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -212,9 +212,13 @@ module.exports = {\n       Object.assign(integrationRequestTemplates, http.request.template);\n     }\n \n-    return Object.keys(integrationRequestTemplates).length\n-      ? integrationRequestTemplates\n-      : undefined;\n+    // allow disabling of default templates by setting a template to null/false\n+    const cleanedTemplates = _.omitBy(\n+      integrationRequestTemplates,\n+      value => value == null || value === false\n+    );\n+\n+    return Object.keys(cleanedTemplates).length ? cleanedTemplates : undefined;\n   },\n   getIntegrationRequestParameters(http) {\n     const parameters = {};\n', passed=True, regression_test_failure_log='')]
2025-11-13 20:39:49,786 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - DEBUG - Total candidate patches: 5
2025-11-13 20:39:49,787 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - DEBUG - Candidate patches: ['diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..9b4f67eb3 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -932,7 +932,7 @@ This method is more complicated and involves a lot more configuration of the `ht\n \n #### Default Request Templates\n \n-Serverless ships with the following default request templates you can use out of the box:\n+Serverless ships with the following default request templates you can use out of the box for Lambda (AWS) integration:\n \n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n@@ -950,6 +950,41 @@ Both templates give you access to the following properties you can access with t\n - stageVariables\n - requestPath\n \n+You can control these defaults:\n+\n+- Disable all default templates:\n+  set `request.disableDefaultTemplates: true` to prevent Serverless from adding any default request mapping templates.\n+- Exclude specific default content types:\n+  set `request.excludeDefaultContentTypes` to a list of content types to remove from the defaults. For example, to remove `application/x-www-form-urlencoded` while keeping `application/json`.\n+\n+Examples:\n+\n+```yml\n+functions:\n+  onlyJson:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: post\n+          path: posts/create\n+          integration: lambda\n+          request:\n+            excludeDefaultContentTypes:\n+              - application/x-www-form-urlencoded\n+\n+  noDefaultsCustomOnly:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: post\n+          path: posts/create\n+          integration: lambda\n+          request:\n+            disableDefaultTemplates: true\n+            template:\n+              application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n+```\n+\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n@@ -1027,6 +1062,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates\n \n - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n+- When you disable all default templates and do not define any custom templates for AWS (Lambda) integration, the default passThrough behavior (NEVER) will cause API Gateway to reject requests with 415 unless you explicitly change `request.passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH`.\n \n ### Responses\n \ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..6370cbb4f 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -201,10 +201,24 @@ module.exports = {\n \n     // Only set defaults for AWS (lambda) integration\n     if (useDefaults) {\n-      Object.assign(integrationRequestTemplates, {\n+      let defaultTemplates = {\n         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n-      });\n+      };\n+\n+      // Allow disabling all default templates\n+      if (http.request && http.request.disableDefaultTemplates) {\n+        defaultTemplates = {};\n+      } else if (\n+        http.request &&\n+        Array.isArray(http.request.excludeDefaultContentTypes)\n+      ) {\n+        http.request.excludeDefaultContentTypes.forEach(type => {\n+          delete defaultTemplates[type];\n+        });\n+      }\n+\n+      Object.assign(integrationRequestTemplates, defaultTemplates);\n     }\n \n     // set custom request templates if provided\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..c00fa243b 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,38 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      if (\n+        typeof http.request.disableDefaultTemplates !== \'undefined\' &&\n+        typeof http.request.disableDefaultTemplates !== \'boolean\'\n+      ) {\n+        const errorMessage = [\n+          \'disableDefaultTemplates must be provided as a boolean.\',\n+          \' Please check the docs for more info.\',\n+        ].join(\'\');\n+        throw new this.serverless.classes.Error(errorMessage);\n+      }\n+      if (\n+        typeof http.request.excludeDefaultContentTypes !== \'undefined\' &&\n+        !Array.isArray(http.request.excludeDefaultContentTypes)\n+      ) {\n+        const errorMessage = [\n+          \'excludeDefaultContentTypes must be provided as an array of strings.\',\n+          \' Please check the docs for more info.\',\n+        ].join(\'\');\n+        throw new this.serverless.classes.Error(errorMessage);\n+      }\n+      if (Array.isArray(http.request.excludeDefaultContentTypes)) {\n+        const invalid = http.request.excludeDefaultContentTypes.some(\n+          t => typeof t !== \'string\'\n+        );\n+        if (invalid) {\n+          const errorMessage = [\n+            \'excludeDefaultContentTypes must be provided as an array of strings.\',\n+            \' Please check the docs for more info.\',\n+          ].join(\'\');\n+          throw new this.serverless.classes.Error(errorMessage);\n+        }\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', 'diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..9e6c7c5a4 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -932,11 +932,35 @@ This method is more complicated and involves a lot more configuration of the `ht\n \n #### Default Request Templates\n \n-Serverless ships with the following default request templates you can use out of the box:\n+Serverless ships with the following default request templates you can use out of the box (for the `lambda`/`AWS` integration):\n \n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n \n+You can control which of these defaults are applied per endpoint with the `request.defaultContentTypes` setting:\n+\n+- Omit `request.defaultContentTypes` to keep the current defaults (both will be added)\n+- Set `request.defaultContentTypes: [application/json]` to include only the JSON default\n+- Set `request.defaultContentTypes: []` to disable all defaults (you may want to define your own templates via `request.template`)\n+\n+Example:\n+\n+```yml\n+functions:\n+  create:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: post\n+          path: posts/create\n+          integration: lambda\n+          request:\n+            defaultContentTypes:\n+              - application/json\n+            template:\n+              text/xml: \'{ "foo": "bar" }\'\n+```\n+\n Both templates give you access to the following properties you can access with the help of the `event` object:\n \n - body\n@@ -953,7 +977,7 @@ Both templates give you access to the following properties you can access with t\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n-by defining a new request template for an existing content type):\n+by defining a new request template for an existing content type). If you prefer not to include any defaults, set `request.defaultContentTypes: []`.\n \n ```yml\n functions:\n@@ -965,6 +989,7 @@ functions:\n           path: whatever\n           integration: lambda\n           request:\n+            defaultContentTypes: []\n             template:\n               text/xhtml: \'{ "stage" : "$context.stage" }\'\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n@@ -998,7 +1023,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s\n \n [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n \n-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the `lambda`/`AWS` integration). Note: If you disable all default request templates via `request.defaultContentTypes: []` and do not provide any custom templates, requests with unmatched Content-Type will be rejected with `415 - Unsupported Media Type` when passThrough is `NEVER`.\n \n ```yml\n functions:\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..38fd4ea7c 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -201,10 +201,24 @@ module.exports = {\n \n     // Only set defaults for AWS (lambda) integration\n     if (useDefaults) {\n-      Object.assign(integrationRequestTemplates, {\n-        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n-        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n-      });\n+      const defaultsConfig =\n+        http.request && Array.isArray(http.request.defaultContentTypes)\n+          ? http.request.defaultContentTypes\n+          : null;\n+      if (defaultsConfig === null) {\n+        Object.assign(integrationRequestTemplates, {\n+          \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n+          \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n+        });\n+      } else {\n+        if (defaultsConfig.includes(\'application/json\')) {\n+          integrationRequestTemplates[\'application/json\'] = this.DEFAULT_JSON_REQUEST_TEMPLATE;\n+        }\n+        if (defaultsConfig.includes(\'application/x-www-form-urlencoded\')) {\n+          integrationRequestTemplates[\'application/x-www-form-urlencoded\'] =\n+            this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE;\n+        }\n+      }\n     }\n \n     // set custom request templates if provided\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..e6008e2ef 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,31 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      if (http.request.defaultContentTypes) {\n+        if (!Array.isArray(http.request.defaultContentTypes)) {\n+          const errorMessage = [\n+            \'defaultContentTypes config must be provided as an array of strings.\',\n+            \' Please check the docs for more info.\',\n+          ].join(\'\');\n+          throw new this.serverless.classes.Error(errorMessage);\n+        }\n+        const allowedDefaults = [\n+          \'application/json\',\n+          \'application/x-www-form-urlencoded\',\n+        ];\n+        for (const ct of http.request.defaultContentTypes) {\n+          if (typeof ct !== \'string\' || allowedDefaults.indexOf(ct) === -1) {\n+            const errorMessage = [\n+              \'defaultContentTypes entries must be one of: \',\n+              allowedDefaults.join(\', \'),\n+              \'.\',\n+            ].join(\'\');\n+            throw new this.serverless.classes.Error(errorMessage);\n+          }\n+        }\n+        // remove duplicates if any\n+        http.request.defaultContentTypes = Array.from(new Set(http.request.defaultContentTypes));\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', 'diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..a0e2182b9 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -932,11 +932,13 @@ This method is more complicated and involves a lot more configuration of the `ht\n \n #### Default Request Templates\n \n-Serverless ships with the following default request templates you can use out of the box:\n+Serverless ships with the following default request templates you can use out of the box (for the non-proxy `lambda`/`AWS` integration):\n \n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n \n+You can disable one or both default templates by setting the content type to `false` in your `request.template` configuration or globally under `provider.apiGateway.defaultRequestTemplates`.\n+\n Both templates give you access to the following properties you can access with the help of the `event` object:\n \n - body\n@@ -970,6 +972,34 @@ functions:\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n ```\n \n+To remove a default content type, set it to `false`:\n+\n+```yml\n+functions:\n+  create:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: get\n+          path: whatever\n+          integration: lambda\n+          request:\n+            template:\n+              application/x-www-form-urlencoded: false\n+```\n+\n+You can also control defaults globally:\n+\n+```yml\n+provider:\n+  apiGateway:\n+    defaultRequestTemplates:\n+      application/json: ${file(template_json.vtl)}\n+      application/x-www-form-urlencoded: false\n+```\n+\n+If you remove all templates, remember to adjust pass-through behavior as needed (see below).\n+\n **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n \n **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n@@ -998,7 +1028,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s\n \n [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.\n \n-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):\n+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the non-proxy `lambda`/`AWS` integration when defaults are present). If you disable all templates, consider setting `passThrough` to `WHEN_NO_TEMPLATES` or `WHEN_NO_MATCH` depending on your desired behavior.\n \n ```yml\n functions:\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..0553ab74e 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -201,10 +201,24 @@ module.exports = {\n \n     // Only set defaults for AWS (lambda) integration\n     if (useDefaults) {\n-      Object.assign(integrationRequestTemplates, {\n-        \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n-        \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n-      });\n+      // Allow provider-level override of default request templates\n+      const providerDefaults =\n+        this.serverless &&\n+        this.serverless.service &&\n+        this.serverless.service.provider &&\n+        this.serverless.service.provider.apiGateway &&\n+        typeof this.serverless.service.provider.apiGateway.defaultRequestTemplates === \'object\'\n+          ? this.serverless.service.provider.apiGateway.defaultRequestTemplates\n+          : null;\n+\n+      const defaultTemplates =\n+        providerDefaults ||\n+        {\n+          \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n+          \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n+        };\n+\n+      Object.assign(integrationRequestTemplates, defaultTemplates);\n     }\n \n     // set custom request templates if provided\n@@ -212,6 +226,15 @@ module.exports = {\n       Object.assign(integrationRequestTemplates, http.request.template);\n     }\n \n+    // Remove any templates explicitly disabled (value set to false)\n+    // and ensure only string-valued templates are passed to CloudFormation\n+    Object.keys(integrationRequestTemplates).forEach(contentType => {\n+      const template = integrationRequestTemplates[contentType];\n+      if (template === false || typeof template !== \'string\') {\n+        delete integrationRequestTemplates[contentType];\n+      }\n+    });\n+\n     return Object.keys(integrationRequestTemplates).length\n       ? integrationRequestTemplates\n       : undefined;\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..2bdb24092 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,20 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      // Validate template values: allow strings and boolean false (to disable defaults)\n+      if (http.request.template && typeof http.request.template === \'object\') {\n+        Object.keys(http.request.template).forEach(ct => {\n+          const tpl = http.request.template[ct];\n+          if (tpl !== false && typeof tpl !== \'string\') {\n+            const errorMessage = [\n+              \'Invalid template value for content type "\',\n+              ct,\n+              \'". Expected a string or false to disable.\',\n+            ].join(\'\');\n+            throw new this.serverless.classes.Error(errorMessage);\n+          }\n+        });\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', 'diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..194b6dc51 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -937,6 +937,10 @@ Serverless ships with the following default request templates you can use out of\n 1. `application/json`\n 2. `application/x-www-form-urlencoded`\n \n+By default, these templates are added only for the Lambda (AWS) integration. You can control defaults as follows:\n+- Disable all defaults for a given endpoint by setting `request.useDefaultTemplates: false`\n+- Remove a specific default by setting its content type under `request.template` to `null` or `false` (e.g., `application/x-www-form-urlencoded: null`)\n+\n Both templates give you access to the following properties you can access with the help of the `event` object:\n \n - body\n@@ -953,7 +957,9 @@ Both templates give you access to the following properties you can access with t\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n-by defining a new request template for an existing content type):\n+by defining a new request template for an existing content type). You can also remove defaults:\n+\n+- Remove a single default template:\n \n ```yml\n functions:\n@@ -966,10 +972,27 @@ functions:\n           integration: lambda\n           request:\n             template:\n-              text/xhtml: \'{ "stage" : "$context.stage" }\'\n+              application/x-www-form-urlencoded: null # removes this default\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n ```\n \n+- Disable all default templates and provide only explicit templates:\n+\n+```yml\n+functions:\n+  create:\n+    handler: posts.create\n+    events:\n+      - http:\n+          method: get\n+          path: whatever\n+          integration: lambda\n+          request:\n+            useDefaultTemplates: false\n+            template:\n+              text/xhtml: \'{ "stage" : "$context.stage" }\'\n+```\n+\n **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n \n **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\n@@ -1026,6 +1049,7 @@ See the [api gateway documentation](https://docs.aws.amazon.com/apigateway/lates\n **Notes:**\n \n - A missing/empty request Content-Type is considered to be the API Gateway default (`application/json`)\n+- If you disable all default templates for Lambda integration and do not define any templates, the default `passThrough` for Lambda integration is `NEVER`, which will cause API Gateway to return `415 - Unsupported Media Type` for unmatched content types. You can change this behavior via `request.passThrough`.\n - API Gateway docs refer to "WHEN_NO_TEMPLATE" (singular), but this will fail during creation as the actual value should be "WHEN_NO_TEMPLATES" (plural)\n \n ### Responses\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..e355368cb 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -199,8 +199,11 @@ module.exports = {\n     // default request templates\n     const integrationRequestTemplates = {};\n \n-    // Only set defaults for AWS (lambda) integration\n-    if (useDefaults) {\n+    // Determine whether default templates should be used (only for AWS (lambda) integration)\n+    const useDefaultsAfterConfig =\n+      useDefaults && !(http.request && http.request.useDefaultTemplates === false);\n+\n+    if (useDefaultsAfterConfig) {\n       Object.assign(integrationRequestTemplates, {\n         \'application/json\': this.DEFAULT_JSON_REQUEST_TEMPLATE,\n         \'application/x-www-form-urlencoded\': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,\n@@ -209,7 +212,16 @@ module.exports = {\n \n     // set custom request templates if provided\n     if (http.request && typeof http.request.template === \'object\') {\n-      Object.assign(integrationRequestTemplates, http.request.template);\n+      _.forEach(http.request.template, (value, key) => {\n+        if (value === null || value === false) {\n+          // Explicitly remove this content type from the final templates\n+          if (Object.prototype.hasOwnProperty.call(integrationRequestTemplates, key)) {\n+            delete integrationRequestTemplates[key];\n+          }\n+        } else {\n+          integrationRequestTemplates[key] = value;\n+        }\n+      });\n     }\n \n     return Object.keys(integrationRequestTemplates).length\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\nindex 027ec480b..10b0ade05 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js\n@@ -506,6 +506,16 @@ module.exports = {\n         ].join(\'\');\n         throw new this.serverless.classes.Error(errorMessage);\n       }\n+      if (\n+        typeof http.request.useDefaultTemplates !== \'undefined\' &&\n+        typeof http.request.useDefaultTemplates !== \'boolean\'\n+      ) {\n+        const errorMessage = [\n+          \'useDefaultTemplates config must be provided as a boolean.\',\n+          \' Please check the docs for more info.\',\n+        ].join(\'\');\n+        throw new this.serverless.classes.Error(errorMessage);\n+      }\n \n       if (request.parameters) {\n         request.parameters = this.getRequestParameters(request);\n', 'diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md\nindex 77c99fa11..98e7b7928 100644\n--- a/docs/providers/aws/events/apigateway.md\n+++ b/docs/providers/aws/events/apigateway.md\n@@ -953,7 +953,7 @@ Both templates give you access to the following properties you can access with t\n #### Custom Request Templates\n \n However you can define and use your own request templates as follows (you can even overwrite the default request templates\n-by defining a new request template for an existing content type):\n+by defining a new request template for an existing content type). You can also disable a default template for a specific content type by setting its value to `null`:\n \n ```yml\n functions:\n@@ -968,8 +968,11 @@ functions:\n             template:\n               text/xhtml: \'{ "stage" : "$context.stage" }\'\n               application/json: \'{ "httpMethod" : "$context.httpMethod" }\'\n+              application/x-www-form-urlencoded: null\n ```\n \n+Setting a template value to `null` removes that content type from the generated API Gateway RequestTemplates, allowing you to avoid advertising unsupported media types (e.g., removing `application/x-www-form-urlencoded` when only JSON is supported). If you disable all templates for the `lambda` (AWS) integration, ensure you set `passThrough` appropriately (e.g., `WHEN_NO_TEMPLATES`) to avoid 415 Unsupported Media Type errors.\n+\n **Note:** The templates are defined as plain text here. However you can also reference an external file with the help of the `${file(templatefile)}` syntax.\n \n **Note 2:** In .yml, strings containing `:`, `{`, `}`, `[`, `]`, `,`, `&`, `*`, `#`, `?`, `|`, `-`, `<`, `>`, `=`, `!`, `%`, `@`, `` ` `` must be quoted.\ndiff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\nindex 3be224959..3e5871f6a 100644\n--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js\n@@ -212,9 +212,13 @@ module.exports = {\n       Object.assign(integrationRequestTemplates, http.request.template);\n     }\n \n-    return Object.keys(integrationRequestTemplates).length\n-      ? integrationRequestTemplates\n-      : undefined;\n+    // allow disabling of default templates by setting a template to null/false\n+    const cleanedTemplates = _.omitBy(\n+      integrationRequestTemplates,\n+      value => value == null || value === false\n+    );\n+\n+    return Object.keys(cleanedTemplates).length ? cleanedTemplates : undefined;\n   },\n   getIntegrationRequestParameters(http) {\n     const parameters = {};\n']
2025-11-13 20:40:22,055 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 1/10 try:Selected patch index: 1, 
2025-11-13 20:40:56,094 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 2/10 try:Selected patch index: 1, 
2025-11-13 20:41:37,793 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 3/10 try:Selected patch index: 1, 
2025-11-13 20:42:20,741 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 4/10 try:Selected patch index: 1, 
2025-11-13 20:43:00,455 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 5/10 try:Selected patch index: 1, 
2025-11-13 20:44:04,805 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode response at 6/10 try:Selected patch index: 1, 
2025-11-13 20:44:04,806 - thread-135845287823040.prometheus.lang_graph.nodes.final_patch_selection_node - INFO - FinalPatchSelectionNode early stopping at turn 6 with result: [0, 6, 0, 0, 0], first place: 6, second place: 0, lead: 6, remaining votes: 4, selected patch index: 1
2025-11-13 20:44:12,609 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_responder_node - DEBUG - content='Thanks for raising this. We agree there should be a straightforward way to avoid unwanted default request mapping templates.\n\nWhat’s implemented:\n- A new per-endpoint setting: http.request.defaultContentTypes\n  - Omit the setting to keep the current defaults (application/json and application/x-www-form-urlencoded).\n  - Set it to [application/json] to include only the JSON default.\n  - Set it to [] to disable all defaults and rely solely on your custom templates (http.request.template).\n- Validation ensures the setting is an array containing only allowed values (application/json, application/x-www-form-urlencoded), and removes duplicates.\n- This applies to the lambda/AWS integration only.\n- Docs have been updated under providers/aws/events/apigateway.md with usage examples and notes about passThrough behavior (e.g., with defaults disabled and passThrough: NEVER, unmatched Content-Type requests return 415).\n\nFor your case (JSON-only), configure your endpoint like:\n- http.request.defaultContentTypes: [application/json]\n\nVerification:\n- All selected regression tests passed successfully.\n\nThis is an initial implementation and may need refinement. Please let us know how it works in your setup and if you run into any edge cases.' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 762, 'prompt_tokens': 1919, 'total_tokens': 2681, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 512, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-5-2025-08-07', 'system_fingerprint': None, 'finish_reason': 'stop', 'logprobs': None} id='run--3a9a4c0d-772c-418c-aa7f-5362fd012e04-0' usage_metadata={'input_tokens': 1919, 'output_tokens': 762, 'total_tokens': 2681, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 512}}
2025-11-13 20:44:12,640 - thread-135845287823040.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-13 20:44:12,640 - thread-135845287823040.prometheus.docker.base_container - INFO - Closing persistent shell...
2025-11-13 20:44:12,741 - thread-135845287823040.prometheus.docker.base_container - INFO - Cleaning up container and temporary files
2025-11-13 20:44:23,071 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_subgraph_node - INFO - Generated patch:
diff --git a/docs/providers/aws/events/apigateway.md b/docs/providers/aws/events/apigateway.md
index 77c99fa11..9e6c7c5a4 100644
--- a/docs/providers/aws/events/apigateway.md
+++ b/docs/providers/aws/events/apigateway.md
@@ -932,11 +932,35 @@ This method is more complicated and involves a lot more configuration of the `ht
 
 #### Default Request Templates
 
-Serverless ships with the following default request templates you can use out of the box:
+Serverless ships with the following default request templates you can use out of the box (for the `lambda`/`AWS` integration):
 
 1. `application/json`
 2. `application/x-www-form-urlencoded`
 
+You can control which of these defaults are applied per endpoint with the `request.defaultContentTypes` setting:
+
+- Omit `request.defaultContentTypes` to keep the current defaults (both will be added)
+- Set `request.defaultContentTypes: [application/json]` to include only the JSON default
+- Set `request.defaultContentTypes: []` to disable all defaults (you may want to define your own templates via `request.template`)
+
+Example:
+
+```yml
+functions:
+  create:
+    handler: posts.create
+    events:
+      - http:
+          method: post
+          path: posts/create
+          integration: lambda
+          request:
+            defaultContentTypes:
+              - application/json
+            template:
+              text/xml: '{ "foo": "bar" }'
+```
+
 Both templates give you access to the following properties you can access with the help of the `event` object:
 
 - body
@@ -953,7 +977,7 @@ Both templates give you access to the following properties you can access with t
 #### Custom Request Templates
 
 However you can define and use your own request templates as follows (you can even overwrite the default request templates
-by defining a new request template for an existing content type):
+by defining a new request template for an existing content type). If you prefer not to include any defaults, set `request.defaultContentTypes: []`.
 
 ```yml
 functions:
@@ -965,6 +989,7 @@ functions:
           path: whatever
           integration: lambda
           request:
+            defaultContentTypes: []
             template:
               text/xhtml: '{ "stage" : "$context.stage" }'
               application/json: '{ "httpMethod" : "$context.httpMethod" }'
@@ -998,7 +1023,7 @@ If you want to spread a string into multiple lines, you can use the `>` or `|` s
 
 [API Gateway](https://serverless.com/amazon-api-gateway/) provides multiple ways to handle requests where the Content-Type header does not match any of the specified mapping templates. When this happens, the request payload will either be passed through the integration request _without transformation_ or rejected with a `415 - Unsupported Media Type`, depending on the configuration.
 
-You can define this behaviour as follows (if not specified, a value of **NEVER** will be used):
+You can define this behaviour as follows (if not specified, a value of **NEVER** will be used for the `lambda`/`AWS` integration). Note: If you disable all default request templates via `request.defaultContentTypes: []` and do not provide any custom templates, requests with unmatched Content-Type will be rejected with `415 - Unsupported Media Type` when passThrough is `NEVER`.
 
 ```yml
 functions:
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
index 3be224959..38fd4ea7c 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/method/integration.js
@@ -201,10 +201,24 @@ module.exports = {
 
     // Only set defaults for AWS (lambda) integration
     if (useDefaults) {
-      Object.assign(integrationRequestTemplates, {
-        'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
-        'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
-      });
+      const defaultsConfig =
+        http.request && Array.isArray(http.request.defaultContentTypes)
+          ? http.request.defaultContentTypes
+          : null;
+      if (defaultsConfig === null) {
+        Object.assign(integrationRequestTemplates, {
+          'application/json': this.DEFAULT_JSON_REQUEST_TEMPLATE,
+          'application/x-www-form-urlencoded': this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE,
+        });
+      } else {
+        if (defaultsConfig.includes('application/json')) {
+          integrationRequestTemplates['application/json'] = this.DEFAULT_JSON_REQUEST_TEMPLATE;
+        }
+        if (defaultsConfig.includes('application/x-www-form-urlencoded')) {
+          integrationRequestTemplates['application/x-www-form-urlencoded'] =
+            this.DEFAULT_FORM_URL_ENCODED_REQUEST_TEMPLATE;
+        }
+      }
     }
 
     // set custom request templates if provided
diff --git a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
index 027ec480b..e6008e2ef 100644
--- a/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
+++ b/lib/plugins/aws/package/compile/events/apiGateway/lib/validate.js
@@ -506,6 +506,31 @@ module.exports = {
         ].join('');
         throw new this.serverless.classes.Error(errorMessage);
       }
+      if (http.request.defaultContentTypes) {
+        if (!Array.isArray(http.request.defaultContentTypes)) {
+          const errorMessage = [
+            'defaultContentTypes config must be provided as an array of strings.',
+            ' Please check the docs for more info.',
+          ].join('');
+          throw new this.serverless.classes.Error(errorMessage);
+        }
+        const allowedDefaults = [
+          'application/json',
+          'application/x-www-form-urlencoded',
+        ];
+        for (const ct of http.request.defaultContentTypes) {
+          if (typeof ct !== 'string' || allowedDefaults.indexOf(ct) === -1) {
+            const errorMessage = [
+              'defaultContentTypes entries must be one of: ',
+              allowedDefaults.join(', '),
+              '.',
+            ].join('');
+            throw new this.serverless.classes.Error(errorMessage);
+          }
+        }
+        // remove duplicates if any
+        http.request.defaultContentTypes = Array.from(new Set(http.request.defaultContentTypes));
+      }
 
       if (request.parameters) {
         request.parameters = this.getRequestParameters(request);

2025-11-13 20:44:23,071 - thread-135845287823040.prometheus.lang_graph.nodes.issue_feature_subgraph_node - INFO - Feature implementation completed
